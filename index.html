<!DOCTYPE html>
<html lang="vi">
<head>
<script src="https://unpkg.com/html5-qrcode"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--a600:#D4881A;
  --red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.11);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
  --nav-h:62px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--surface);color:var(--text);min-height:100vh;padding-bottom:calc(var(--nav-h)+8px)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}

/* HEADER */
header{background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:13px 16px 10px;text-align:center;position:sticky;top:0;z-index:300;box-shadow:0 2px 12px rgba(0,0,0,.22)}
header h1{font-size:1.3rem;font-weight:800}
header p{font-size:.7rem;opacity:.75;margin-top:1px}
.badge{background:var(--a400);color:#1A2E23;font-size:.58rem;font-weight:900;padding:2px 7px;border-radius:20px;margin-left:5px;vertical-align:middle}

/* API BAR */
#apiSetup{background:#FFFDE7;border-bottom:2px solid var(--a400);padding:8px 12px;display:flex;align-items:center;flex-wrap:wrap;gap:6px}
#apiSetup label{font-size:.74rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:120px;padding:7px 10px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.83rem}
#apiKeyInput:focus{outline:none;border-color:var(--a600)}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:7px 11px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.78rem;white-space:nowrap}
#apiStatus{font-size:.7rem;width:100%;margin-top:-2px}

/* MONTH BAR */
#monthBar{background:var(--card);border-bottom:2px solid var(--border);padding:7px 12px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;position:sticky;top:52px;z-index:290}
#monthBar label{font-size:.72rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:6px 9px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.81rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
.month-badge{font-size:.66rem;background:var(--p50);color:var(--p600);padding:3px 9px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto;white-space:nowrap}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);background:var(--card);border-top:2px solid var(--border);display:flex;z-index:400;box-shadow:0 -3px 16px rgba(0,0,0,.10)}
.bn-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:4px 2px;border-top:3px solid transparent;transition:.18s;color:var(--muted);font-family:var(--font)}
.bn-btn .ni{font-size:1.25rem;line-height:1}
.bn-btn .nl{font-size:.55rem;font-weight:800;white-space:nowrap}
.bn-btn.active{color:var(--p600);border-top-color:var(--p600);background:var(--p50)}
.bn-btn:hover:not(.active){background:var(--p50);color:var(--p600)}

/* PAGES */
.page{display:none;padding:11px;max-width:660px;margin:0 auto}
.page.active{display:block}

/* CARDS */
.card{background:var(--card);border-radius:var(--r-md);padding:14px;margin-bottom:11px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}
.card-title{font-size:.92rem;font-weight:800;color:var(--p700);margin-bottom:9px;display:flex;align-items:center;gap:6px}
.card-sub{font-size:.72rem;color:var(--muted);margin-top:-5px;margin-bottom:9px}

/* FIELDS */
.field{margin-bottom:9px}
.field label{font-size:.71rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:10px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.88rem;font-family:var(--font);background:#fff;color:var(--text);transition:.18s}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:380px){.row2{grid-template-columns:1fr}}

/* DROPDOWN */
.cat-wrap,.sug-wrap{position:relative}
.cat-dropdown,.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:500;max-height:170px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.cat-dropdown.open,.sug-dropdown.open{display:block}
.cat-opt,.sug-opt{padding:9px 12px;cursor:pointer;font-size:.85rem;border-bottom:1px solid var(--border);transition:.15s}
.cat-opt:last-child,.sug-opt:last-child{border-bottom:none}
.cat-opt:hover,.sug-opt:hover{background:var(--p50);color:var(--p600)}
.cat-opt.new-item{color:var(--p600);font-weight:800;font-style:italic}

/* BUTTONS */
.btn{width:100%;padding:12px;border:none;border-radius:var(--r-md);font-size:.87rem;font-weight:800;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:8px;font-family:var(--font)}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.22)}
.btn-primary:hover:not(:disabled){background:var(--p700);transform:translateY(-1px)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-danger{background:var(--red-bg);color:var(--red);border:2px solid #F5C6C0}
.btn-danger:hover:not(:disabled){background:var(--red);color:#fff}
.btn-sm{padding:6px 12px;font-size:.75rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* UPLOAD AREA */
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:18px 12px;text-align:center;cursor:pointer;transition:.2s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100)}
.upload-area .u-icon{font-size:2rem;margin-bottom:4px}
.upload-area strong{display:block;font-size:.84rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.7rem}
/* Image preview replaces upload area */
.img-preview-box{position:relative;margin-bottom:8px;display:none}
.img-preview-box img{width:100%;max-height:180px;object-fit:cover;border-radius:var(--r-sm);border:2px solid var(--p300);display:block}
.img-preview-box .img-change-btn{position:absolute;top:7px;right:7px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:20px;padding:4px 10px;font-size:.7rem;font-weight:800;cursor:pointer}
.img-preview-box .img-change-btn:hover{background:var(--p600)}

/* COPY BTN */
.copy-btn{display:none;align-items:center;gap:5px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:7px 13px;border-radius:var(--r-sm);font-size:.78rem;font-weight:800;cursor:pointer;margin-top:7px;transition:.2s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}

/* RESULT / LOADER */
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:12px;margin-top:8px;white-space:pre-wrap;font-size:.82rem;line-height:1.7;max-height:280px;overflow-y:auto;display:none}
.result-box.show{display:block}
.loader{display:none;text-align:center;padding:16px}
.loader.show{display:block}
.spinner{width:32px;height:32px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 7px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.8rem}

/* AUTOFILL NOTICE */
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:9px 12px;font-size:.78rem;color:var(--p700);margin-top:7px;display:none}
.autofill-notice.show{display:block}

/* SUB-TABS */
.sub-tabs{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap}
.sub-tab{padding:6px 13px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.75rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* MODAL SUB-TABS */
.modal-sub-tabs{display:flex;gap:5px;margin-bottom:10px}
.modal-sub-tab{flex:1;padding:7px;border:2px solid var(--border);background:#fff;border-radius:var(--r-sm);font-size:.75rem;font-weight:800;color:var(--muted);cursor:pointer;text-align:center;transition:.18s}
.modal-sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}

/* CHIPS */
.chip-group{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;min-height:6px}
.chip{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:4px 10px;border-radius:20px;font-size:.71rem;font-weight:800;cursor:pointer;transition:.18s}
.chip:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.chip.chi-c{border-color:#F5C6C0;color:var(--red)}
.chip.chi-c:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* SUMMARY STRIP */
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:11px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:10px 7px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.63rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.s-val{font-size:.9rem;font-weight:900}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:.79rem}
thead tr{background:var(--p600)}
th{padding:8px 9px;text-align:left;color:#fff;font-size:.7rem;font-weight:800;white-space:nowrap}
th:first-child{border-radius:var(--r-sm) 0 0 0}th:last-child{border-radius:0 var(--r-sm) 0 0}
td{padding:8px 9px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800}
.chi-v{color:var(--red);font-weight:800}
.del-btn{background:none;border:none;cursor:pointer;font-size:.85rem;padding:3px 5px;border-radius:6px;transition:.15s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;font-size:.65rem;font-weight:800;white-space:nowrap}
.tag-thu{background:#D4EDDA;color:var(--p700)}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-op{background:#FFF3CD;color:#856404}
.tag-plan{background:#E8D5FA;color:#5A189A}

/* CHECKBOX / BULK DELETE */
.bulk-bar{display:flex;align-items:center;gap:8px;margin-bottom:9px;flex-wrap:wrap}
.bulk-bar input[type=checkbox]{width:15px;height:15px;accent-color:var(--p600);cursor:pointer}
.bulk-bar label{font-size:.76rem;font-weight:800;color:var(--muted);cursor:pointer}
.cb-cell input[type=checkbox]{width:14px;height:14px;accent-color:var(--p600);cursor:pointer}

/* COMPARE BOX */
.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);padding:13px;margin-bottom:11px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.85rem;font-weight:800;color:var(--p700);margin-bottom:9px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:9px 5px;border:1px solid var(--border)}
.cmp-lbl{font-size:.62rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmp-cur{font-size:.82rem;font-weight:900;color:var(--p700)}
.cmp-prev{font-size:.68rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.68rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
@media(max-width:480px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:11px;border:1px solid var(--border)}
.ch-card h3{font-size:.75rem;font-weight:800;color:var(--p700);margin-bottom:7px;text-align:center}
.ch-wrap{position:relative;height:150px}
.ch-full{position:relative;height:170px}

/* PERIOD FILTER */
.period-tabs{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap}
.period-tab{padding:5px 12px;border:2px solid var(--border);background:#fff;border-radius:20px;font-size:.72rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s}
.period-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.period-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* HISTORY */
.history-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.history-filters input,.history-filters select{padding:7px 10px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.79rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:120px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.hist-row-clickable{cursor:pointer;transition:.15s}
.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);border:1px solid var(--p100);border-radius:6px;font-size:.62rem;padding:1px 5px;margin-left:3px;font-weight:800;cursor:pointer}

/* CHAT */
.chat-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;box-shadow:var(--shadow-md);border:1px solid var(--border)}
.chat-head{background:var(--p600);color:#fff;padding:11px 14px;display:flex;align-items:center;gap:9px}
.chat-av{width:32px;height:32px;border-radius:50%;background:var(--a400);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.chat-title{font-weight:800;font-size:.87rem}
.chat-status{font-size:.63rem;opacity:.74}
.chat-msgs{padding:11px;max-height:260px;overflow-y:auto;display:flex;flex-direction:column;gap:7px}
.msg{max-width:85%;padding:8px 11px;border-radius:14px;font-size:.81rem;line-height:1.55}
.msg.bot{background:var(--p50);border:1.5px solid var(--p100);align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:var(--p600);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{display:none;align-self:flex-start}.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:8px 12px;background:var(--p50);border:1.5px solid var(--p100);border-radius:14px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
.chat-foot{display:flex;gap:6px;padding:9px 11px;border-top:2px solid var(--border);background:var(--surface)}
.chat-inp{flex:1;padding:8px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-family:var(--font)}
.chat-inp:focus{outline:none;border-color:var(--p600)}
.chat-send{background:var(--p600);color:#fff;border:none;padding:8px 13px;border-radius:var(--r-sm);font-size:.9rem;cursor:pointer;transition:.18s}
.chat-send:hover{background:var(--p700)}

/* INVENTORY */
.inv-kho-row{display:flex;align-items:center;gap:7px;padding:7px 0;border-bottom:1px solid var(--border)}
.inv-kho-row:last-child{border-bottom:none}
.inv-kho-name{flex:1;font-size:.84rem;font-weight:700}
.inv-qty{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:2px 9px;border-radius:20px;font-size:.75rem;font-weight:800}
.inv-price{color:var(--muted);font-size:.73rem}

/* INVOICE TABLE */
.invoice-table-wrap{margin-top:9px;overflow-x:auto;display:none}
.invoice-table-wrap.show{display:block}
.inv-tbl{width:100%;border-collapse:collapse;font-size:.81rem}
.inv-tbl th{background:var(--p600);color:#fff;padding:8px 9px;text-align:left;font-size:.72rem;font-weight:800}
.inv-tbl td{padding:8px 9px;border-bottom:1px solid var(--border)}
.inv-tbl tr:last-child td{border-bottom:none}
.inv-tbl tr:nth-child(even) td{background:var(--p50)}

/* PLAN CARD */
.plan-item{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:9px}
.plan-body{flex:1}
.plan-name{font-size:.85rem;font-weight:800;color:var(--p700)}
.plan-meta{font-size:.71rem;color:var(--muted);margin-top:2px}
.plan-amount{font-size:.9rem;font-weight:900;color:var(--red)}
.plan-del{background:none;border:none;cursor:pointer;font-size:.85rem;color:var(--subtle);padding:3px 5px;border-radius:6px;transition:.15s}
.plan-del:hover{background:var(--red-bg);color:var(--red)}

/* CONFIRM DIALOG */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:center;justify-content:center;padding:16px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg);padding:18px;width:100%;max-width:320px;box-shadow:var(--shadow-md)}
.modal h3{font-size:.9rem;font-weight:800;color:var(--text);margin-bottom:6px}
.modal p{font-size:.8rem;color:var(--muted);margin-bottom:14px;line-height:1.55}
.modal-btns{display:flex;gap:8px}
.modal-btns button{flex:1;padding:10px;border-radius:var(--r-sm);font-weight:800;font-size:.83rem;cursor:pointer;border:none;transition:.18s}
.modal-cancel{background:var(--surface);color:var(--muted);border:2px solid var(--border)!important}
.modal-cancel:hover{background:var(--border)}
.modal-confirm{background:var(--red);color:#fff}
.modal-confirm:hover{background:#b03a2e}

/* QR */
.qr-fallback{text-align:center;padding:14px;color:var(--muted);font-size:.78rem}
#qr-inc-container{width:100%;min-height:150px;border-radius:var(--r-sm);border:2px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;margin-bottom:9px}

/* EMPTY */
.empty{text-align:center;color:var(--muted);padding:22px 10px;font-size:.82rem}
.empty .ei{font-size:2rem;margin-bottom:5px}
/* INFO BOX */
.info-box{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:9px 11px;font-size:.76rem;color:var(--muted);line-height:1.6;margin-top:9px}
.info-box strong{color:var(--p700)}
/* TOAST */
#toast{position:fixed;bottom:74px;left:50%;transform:translateX(-50%) translateY(90px);background:var(--p700);color:#fff;padding:9px 18px;border-radius:30px;font-size:.82rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md)}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.err{background:var(--red)}
/* SECTION LABEL */
.section-sep{font-size:.7rem;font-weight:800;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin:12px 0 7px;padding-left:2px}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Há»‡ thá»‘ng quáº£n lÃ½ kinh doanh theo thÃ¡ng</p>
</header>

<div id="apiSetup">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <p id="apiStatus"></p>
</div>

<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: Tá»”NG QUAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-home" class="page active">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="totalThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="totalProfit">0Ä‘</div></div>
  </div>
  <!-- Quick chart -->
  <div class="card">
    <div class="card-title">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y gáº§n nháº¥t</div>
    <div class="ch-full"><canvas id="homeLineChart"></canvas></div>
  </div>
  <!-- Recent transactions -->
  <div class="card">
    <div class="card-title">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div>
    <div id="homeRecentWrap"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: THU / CHI / KHO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-money" class="page">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="totalThu2">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi2">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="totalProfit2">0Ä‘</div></div>
  </div>

  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('inc',this)">ğŸ’° Thu / BÃ¡n hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('imp',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('op',this)">âš¡ Chi phÃ­ thÃªm</button>
    <button class="sub-tab" onclick="switchSub('inv',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="sub-tab" onclick="switchSub('plan',this)">ğŸ“‹ Káº¿ hoáº¡ch</button>
  </div>

  <!-- THU -->
  <div id="msub-inc">
    <!-- QuÃ©t hÃ³a Ä‘Æ¡n / QR -->
    <div class="card">
      <div class="card-title">ğŸ“· QuÃ©t hÃ³a Ä‘Æ¡n / QR â€” Thu &amp; BÃ¡n hÃ ng</div>
      <div class="modal-sub-tabs">
        <div class="modal-sub-tab active" onclick="incScanMode('img',this)">ğŸ“¸ áº¢nh hÃ³a Ä‘Æ¡n</div>
        <div class="modal-sub-tab" onclick="incScanMode('qr',this)">ğŸ“· QuÃ©t QR</div>
      </div>
      <div id="incScanImg">
        <!-- Upload area (hidden when image selected) -->
        <div class="upload-area" id="incUploadArea" onclick="document.getElementById('incInvoiceFile').click()">
          <div class="u-icon">ğŸ§¾</div><strong>Báº¥m Ä‘á»ƒ chá»n áº£nh hÃ³a Ä‘Æ¡n</strong><small>AI trÃ­ch xuáº¥t vÃ  tá»± Ä‘iá»n form</small>
        </div>
        <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
        <!-- Image preview box (replaces upload area) -->
        <div class="img-preview-box" id="incImgPreviewBox">
          <img id="incInvoicePreview"/>
          <button class="img-change-btn" onclick="changeIncImg()">âœï¸ Äá»•i áº£nh</button>
        </div>
        <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:8px">
          ğŸ¤– TrÃ­ch xuáº¥t &amp; tá»± Ä‘iá»n
        </button>
        <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
        <div class="invoice-table-wrap" id="incInvoiceTableWrap"></div>
        <div class="autofill-notice" id="incAutofillNotice">âœ… AI Ä‘Ã£ tá»± Ä‘iá»n vÃ o form bÃªn dÆ°á»›i â€” kiá»ƒm tra rá»“i báº¥m "ThÃªm khoáº£n thu"</div>
      </div>
      <div id="incScanQR" style="display:none">
        <div id="qr-inc-container"><div class="qr-fallback" id="qrIncFallback"><div style="font-size:1.7rem;margin-bottom:5px">ğŸ“·</div><p>Báº¥m nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ má»Ÿ camera QR</p></div></div>
        <button class="btn btn-secondary" onclick="startIncQR()" id="startIncQRBtn">ğŸ“· Má»Ÿ camera quÃ©t QR</button>
        <button class="btn btn-secondary" onclick="stopIncQR()" id="stopIncQRBtn" style="display:none">â¹ Dá»«ng camera</button>
      </div>
    </div>

    <!-- Form Thu -->
    <div class="card">
      <div class="card-title">â• ThÃªm khoáº£n thu</div>
      <div class="row2">
        <div class="field">
          <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
          <div class="cat-wrap">
            <input class="inp" id="incCatInput" placeholder="Chá»n loáº¡i hÃ ng..." autocomplete="off"
              oninput="onCatInput('inc')" onfocus="openDrop('incCatDrop','inc')" onblur="setTimeout(()=>closeDrop('incCatDrop'),200)"/>
            <div class="cat-dropdown" id="incCatDrop"></div>
          </div>
        </div>
        <div class="field">
          <label>ğŸ›’ TÃªn bÃ¡n hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="incSellName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o..." autocomplete="off"
              oninput="onSellInput()" onfocus="onSellInput()" onblur="setTimeout(closeSellSug,200)"/>
            <div class="sug-dropdown" id="sellSugDrop"></div>
          </div>
        </div>
      </div>
      <div class="chip-group" id="incChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="incDesc" placeholder="VD: BÃ¡n mÃ¬ tÃ´m láº» 20 gÃ³i"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="incAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="incDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addIncome()">â• ThÃªm khoáº£n thu</button>
    </div>

    <!-- Lá»‹ch sá»­ Thu -->
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ thu</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('inc','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('inc','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('inc','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('inc','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="incSelectAll" onchange="toggleSelectAll('inc',this.checked)">
        <label for="incSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('inc')" id="incBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('inc')">âš ï¸ XoÃ¡ táº¥t cáº£ thu</button>
      </div>
      <div id="incTableWrap"></div>
    </div>
  </div>

  <!-- NHáº¬P HÃ€NG -->
  <div id="msub-imp" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="upload-area" id="expUploadArea" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Báº¥m Ä‘á»ƒ chá»¥p / chá»n áº£nh hÃ³a Ä‘Æ¡n</strong><small>AI trÃ­ch xuáº¥t thÃ nh báº£ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <div class="img-preview-box" id="expImgPreviewBox">
        <img id="invoicePreview"/>
        <button class="img-change-btn" onclick="changeExpImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:8px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="invoiceTableWrap"></div>
      <div id="invActions" style="display:none;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceText()">ğŸ“‹ Text</button>
        <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Tá»± nháº­p Chi</button>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… AI Ä‘Ã£ tá»± Ä‘iá»n vÃ o form nháº­p hÃ ng bÃªn dÆ°á»›i</div>
    </div>

    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng thá»§ cÃ´ng</div>
      <div class="row2">
        <div class="field">
          <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
          <div class="cat-wrap">
            <input class="inp" id="impCatInput" placeholder="Chá»n loáº¡i hÃ ng..." autocomplete="off"
              oninput="onCatInput('imp')" onfocus="openDrop('impCatDrop','imp')" onblur="setTimeout(()=>closeDrop('impCatDrop'),200)"/>
            <div class="cat-dropdown" id="impCatDrop"></div>
          </div>
        </div>
        <div class="field">
          <label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onProdInput()" onfocus="onProdInput()" onblur="setTimeout(closeProdSug,200)"/>
            <div class="sug-dropdown" id="prodSugDrop"></div>
          </div>
        </div>
      </div>
      <div class="chip-group" id="impChips"></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° ThÃ nh tiá»n</label><input class="inp" type="text" id="impAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="date" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()">â• Nháº­p + cáº­p nháº­t kho</button>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ chi</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('exp','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('exp','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('exp','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('exp','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="expSelectAll" onchange="toggleSelectAll('exp',this.checked)">
        <label for="expSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('exp')" id="expBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('exp')">âš ï¸ XoÃ¡ táº¥t cáº£ chi</button>
      </div>
      <div id="expTableWrap"></div>
    </div>
  </div>

  <!-- CHI PHÃ THÃŠM -->
  <div id="msub-op" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ thÃªm</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, váº­n chuyá»ƒn â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field">
        <label>ğŸ“‚ Loáº¡i</label>
        <select class="inp" id="opType" onchange="renderOpChips()">
          <option value="">-- Chá»n --</option>
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="chip-group" id="opChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="opDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="opAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="opDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addOperational()">â• ThÃªm chi phÃ­ thÃªm</button>
    </div>
  </div>

  <!-- Tá»’N KHO -->
  <div id="msub-inv" style="display:none">
    <div class="card"><div class="card-title">ğŸ—„ï¸ Tá»“n kho</div><div id="inventoryList"></div></div>
  </div>

  <!-- Káº¾ HOáº CH -->
  <div id="msub-plan" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“‹ Káº¿ hoáº¡ch chi / nháº­p hÃ ng thÃ¡ng sau</div>
      <div class="card-sub">LÃªn káº¿ hoáº¡ch trÆ°á»›c â€” cÃ³ thá»ƒ chá»n Ã¡p dá»¥ng sang thÃ¡ng sau</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn káº¿ hoáº¡ch</label><input class="inp" type="text" id="planName" placeholder="VD: Nháº­p 50 thÃ¹ng bia, Tiá»n Ä‘iá»‡n..."/></div>
      <div class="row2">
        <div class="field">
          <label>ğŸ“‚ Loáº¡i</label>
          <select class="inp" id="planType">
            <option value="import">ğŸ“¦ Nháº­p hÃ ng</option>
            <option value="utility">ğŸ”Œ Äiá»‡n/NÆ°á»›c</option>
            <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
            <option value="rental">ğŸª Máº·t báº±ng</option>
            <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
            <option value="other">ğŸ“Œ KhÃ¡c</option>
          </select>
        </div>
        <div class="field"><label>ğŸ’µ Dá»± kiáº¿n</label><input class="inp" type="text" id="planAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field">
        <label>ğŸ“… Ãp dá»¥ng thÃ¡ng</label>
        <select class="inp" id="planMonth"></select>
      </div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="planNote" placeholder="Ghi chÃº thÃªm..."/></div>
      <button class="btn btn-primary" onclick="addPlan()">â• ThÃªm káº¿ hoáº¡ch</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“… Danh sÃ¡ch káº¿ hoáº¡ch</div>
      <div id="planList"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: QUáº¢NG BÃ (Facebook + TikTok)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-promo" class="page">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchPromoSub('fb',this)">ğŸ“£ BÃ i Ä‘Äƒng</button>
    <button class="sub-tab" onclick="switchPromoSub('tt',this)">ğŸ¬ TikTok</button>
  </div>

  <!-- FACEBOOK -->
  <div id="psub-fb">
    <div class="card">
      <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook tá»« áº£nh</div>
      <div class="upload-area" id="fbUploadArea" onclick="document.getElementById('fbImgInput').click()">
        <div class="u-icon">ğŸ–¼ï¸</div><strong>Báº¥m Ä‘á»ƒ chá»n áº£nh sáº£n pháº©m</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i ngay</small>
      </div>
      <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
      <div class="img-preview-box" id="fbImgPreviewBox">
        <img id="fbPreview"/>
        <button class="img-change-btn" onclick="changeFbImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <div id="fbDetected" style="display:none;margin-top:8px;padding:8px 11px;background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);font-size:.79rem;color:var(--p700);font-weight:700"></div>
    </div>
    <button class="btn btn-primary" onclick="generateFbPost()" id="fbPostBtn" disabled>ğŸ¤– AI viáº¿t bÃ i + Ä‘á»“ng bá»™</button>
    <div class="card" id="fbResultCard" style="display:none">
      <div class="card-title">âœï¸ BÃ i Ä‘Äƒng</div>
      <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t bÃ i...</p></div>
      <div class="result-box" id="fbPost"></div>
      <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>

  <!-- TIKTOK -->
  <div id="psub-tt" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
      <div class="field">
        <label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateScript()" id="scriptBtn">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n quay</button>
    <div class="card" id="videoResult" style="display:none">
      <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n cá»§a báº¡n</div>
      <div class="loader" id="videoLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="result-box" id="scriptBox"></div>
      <button class="copy-btn" id="copyScript" onclick="doCopy('scriptBox','copyScript')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: BÃO CÃO / SO SÃNH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-reports" class="page">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchReportSub('chart',this)">ğŸ“Š BÃ¡o cÃ¡o</button>
    <button class="sub-tab" onclick="switchReportSub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
  </div>

  <!-- BÃO CÃO -->
  <div id="rsub-chart">
    <div class="period-tabs">
      <button class="period-tab active" onclick="setChartPeriod('week',this)">7 ngÃ y</button>
      <button class="period-tab" onclick="setChartPeriod('month',this)">ThÃ¡ng</button>
      <button class="period-tab" onclick="setChartPeriod('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o â€” <span id="chartMonthLabel" style="font-weight:400;font-size:.79rem;color:var(--muted)"></span></div>
      <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u<br>ThÃªm thu/chi Ä‘á»ƒ xem bÃ¡o cÃ¡o</div>
      <div id="chartContent">
        <div class="charts-grid">
          <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
          <div class="ch-card"><h3>ğŸ“¦ Loáº¡i chi</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        </div>
        <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>

  <!-- SO SÃNH -->
  <div id="rsub-compare" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“ˆ So sÃ¡nh cÃ¡c thÃ¡ng</div>
      <div class="row2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-primary" onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="compare-box" id="compareBox"></div>
    </div>

    <!-- So sÃ¡nh táº¥t cáº£ thá»i gian -->
    <div class="card">
      <div class="card-title">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£ thá»i gian</div>
      <div id="allTimeCompare"></div>
      <button class="btn btn-secondary" style="margin-top:8px" onclick="buildAllTimeCompare()">ğŸ”„ Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: AI CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-ai" class="page">
  <div class="chat-box">
    <div class="chat-head">
      <div class="chat-av">ğŸŒ¿</div>
      <div><div class="chat-title">Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</div><div class="chat-status">â— Há»i gÃ¬ cÅ©ng Ä‘Æ°á»£c</div></div>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg bot">ğŸ‘‹ Xin chÃ o! MÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n vá»:<br>â€¢ ğŸ’° Äá»‹nh giÃ¡ &amp; lá»£i nhuáº­n<br>â€¢ ğŸ“¦ Quáº£n lÃ½ kho<br>â€¢ ğŸ“£ BÃ¡n hÃ ng online<br>â€¢ ğŸ“Š PhÃ¢n tÃ­ch thu chi</div>
      <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
    </div>
    <div class="chat-foot">
      <input class="chat-inp" id="chatInp" placeholder="Nháº­p cÃ¢u há»i..." onkeydown="if(event.key==='Enter')sendChat()"/>
      <button class="chat-send" onclick="sendChat()">â¤</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE: Lá»ŠCH Sá»¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-history" class="page">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu (all)</div><div class="s-val" id="histAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi (all)</div><div class="s-val" id="histAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»— (all)</div><div class="s-val" id="histAllProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­ giao dá»‹ch</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m mÃ´ táº£..." oninput="renderHistory()"/>
      <select id="histTypeFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="thu">ğŸ’° Thu</option>
        <option value="chi">ğŸ’¸ Chi</option>
      </select>
      <select id="histMonthFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ thÃ¡ng</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="exportAllCSV()">ğŸ“¥ Xuáº¥t CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="bn-btn active" onclick="switchPage('home',this)"><span class="ni">ğŸ </span><span class="nl">Tá»•ng quan</span></button>
  <button class="bn-btn" onclick="switchPage('money',this)"><span class="ni">ğŸ’°</span><span class="nl">Thu/Chi</span></button>
  <button class="bn-btn" onclick="switchPage('promo',this)"><span class="ni">ğŸ“£</span><span class="nl">Quáº£ng bÃ¡</span></button>
  <button class="bn-btn" onclick="switchPage('reports',this)"><span class="ni">ğŸ“Š</span><span class="nl">BÃ¡o cÃ¡o</span></button>
  <button class="bn-btn" onclick="switchPage('ai',this)"><span class="ni">ğŸ¤–</span><span class="nl">AI</span></button>
  <button class="bn-btn" onclick="switchPage('history',this)"><span class="ni">ğŸ“š</span><span class="nl">Lá»‹ch sá»­</span></button>
</nav>

<!-- CONFIRM MODAL -->
<div class="overlay" id="confirmOverlay">
  <div class="modal">
    <h3 id="confirmTitle">XÃ¡c nháº­n xoÃ¡</h3>
    <p id="confirmMsg">Báº¡n cháº¯c cháº¯n muá»‘n xoÃ¡?</p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeConfirm()">Huá»·</button>
      <button class="modal-confirm" id="confirmOkBtn">XoÃ¡</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent";
let API_KEY = localStorage.getItem('tt40_key') || '';
const TODAY = new Date().toISOString().slice(0,10);

/* state */
let fbBase64='', invoiceBase64='', incInvoiceBase64='';
let invoiceData=[], incInvoiceData=[];
let incQRScanner=null;
let toastTimer=null;
const chartInst={pie:null,bar:null,line:null,homeLine:null};
let incPeriod='all', expPeriod='all', chartPeriod='week';
let pendingConfirmFn=null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM DIALOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConfirm(title,msg,fn){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  document.getElementById('confirmOverlay').classList.add('show');
  pendingConfirmFn=fn;
  document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();fn();};
}
function closeConfirm(){
  document.getElementById('confirmOverlay').classList.remove('show');
  pendingConfirmFn=null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getCurKey=()=>new Date().toISOString().slice(0,7);
const getMonthKey=(y,m)=>`${y}-${String(m).padStart(2,'0')}`;
const monthLabel=k=>{const[y,m]=k.split('-');return `ThÃ¡ng ${parseInt(m)}/${y}`;};
const lsKey=k=>`data-${k}`;
function emptyMonth(){return{income:[],expense:[],inventory:{},categories:['MÃ¬ tÃ´m','Trá»©ng gÃ ','NÆ°á»›c máº¯m','Gáº¡o','Bia/NÆ°á»›c ngá»t','BÃ¡nh káº¹o','Thá»§ cÃ´ng','Rau cá»§'],products:[],plans:[]};}
function loadMD(key){try{const r=localStorage.getItem(lsKey(key));if(!r)return emptyMonth();const d=JSON.parse(r);if(!d.categories)d.categories=emptyMonth().categories;if(!d.products)d.products=[];if(!d.inventory)d.inventory={};if(!d.income)d.income=[];if(!d.expense)d.expense=[];if(!d.plans)d.plans=[];return d;}catch{return emptyMonth();}}
function saveMD(key,data){try{localStorage.setItem(lsKey(key),JSON.stringify(data));}catch(e){showToast('âŒ Lá»—i lÆ°u: '+e.message,true);}}
function getMonthOpts(){const k=new Set();for(let i=0;i<4;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);k.add(getMonthKey(d.getFullYear(),d.getMonth()+1));}for(const x of Object.keys(localStorage)){if(x.startsWith('data-20'))k.add(x.replace('data-',''));}return[...k].sort().reverse();}

let currentMonth=getCurKey();
let MD=loadMD(currentMonth);

function buildMonthSelect(){
  const cur=getCurKey(),opts=getMonthOpts();
  const sel=document.getElementById('monthSelect');
  if(!sel)return;
  sel.innerHTML=opts.map(k=>`<option value="${k}"${k===currentMonth?' selected':''}>${monthLabel(k)}${k===cur?' â­':''}</option>`).join('');
  const e=id=>document.getElementById(id);
  const set=(id,v)=>{const el=e(id);if(el)el.textContent=v;};
  set('monthBadge',currentMonth===cur?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':monthLabel(currentMonth));
  set('incMonthLabel',monthLabel(currentMonth));
  set('chartMonthLabel',monthLabel(currentMonth));
  // compare selects
  const ca=e('cmpA'),cb=e('cmpB');
  if(ca){ca.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');}
  if(cb){cb.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');if(opts.length>1&&cb)cb.value=opts[1];}
  // plan month select
  const pm=e('planMonth');
  if(pm){const future=[];for(let i=0;i<=3;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()+i);future.push(getMonthKey(d.getFullYear(),d.getMonth()+1));}pm.innerHTML=future.map(k=>`<option value="${k}"${k===currentMonth?' selected':''}>${monthLabel(k)}</option>`).join('');}
}
function switchMonth(key){currentMonth=key;MD=loadMD(key);buildMonthSelect();renderAll();hideCompare();
  if(document.getElementById('page-reports').classList.contains('active'))setTimeout(refreshCharts,80);
  if(document.getElementById('page-history').classList.contains('active'))renderHistory();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveApiKey(){const v=document.getElementById('apiKeyInput').value.trim();if(!v){showSt('âš ï¸ Nháº­p key!','#c62828');return;}API_KEY=v;localStorage.setItem('tt40_key',v);showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';}
function showSt(m,c){const e=document.getElementById('apiStatus');if(e){e.textContent=m;e.style.color=c;}}
if(API_KEY){document.getElementById('apiKeyInput').value=API_KEY;showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE / SUB-TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  const pg=document.getElementById('page-'+name);if(pg)pg.classList.add('active');if(btn)btn.classList.add('active');
  if(name==='reports')setTimeout(refreshCharts,80);
  if(name==='home'){renderSummary();renderHomeRecent();setTimeout(refreshHomeChart,80);}
  if(name==='history')renderHistory();
}
function switchSub(name,btn){
  ['inc','imp','op','inv','plan'].forEach(n=>{const el=document.getElementById('msub-'+n);if(el)el.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-money .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='inv')renderInventory();
  if(name==='plan')renderPlans();
}
function switchPromoSub(name,btn){
  ['fb','tt'].forEach(n=>{const el=document.getElementById('psub-'+n);if(el)el.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-promo .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}
function switchReportSub(name,btn){
  ['chart','compare'].forEach(n=>{const el=document.getElementById('rsub-'+n);if(el)el.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-reports .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='chart')setTimeout(refreshCharts,80);
  if(name==='compare')buildAllTimeCompare();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERIOD FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPeriod(type,p,btn){
  if(type==='inc')incPeriod=p;else expPeriod=p;
  const wrap=type==='inc'?document.querySelectorAll('#msub-inc .period-tab'):document.querySelectorAll('#msub-imp .period-tab');
  wrap.forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');
  if(type==='inc')renderIncTable();else renderExpTable();
}
function filterByPeriod(arr,period){
  if(period==='all')return arr;
  const now=new Date();
  return arr.filter(x=>{
    if(!x.date)return false;
    const d=new Date(x.date);
    if(period==='today')return x.date===TODAY;
    if(period==='week'){const w=new Date(now);w.setDate(now.getDate()-6);return d>=w;}
    if(period==='month')return x.date&&x.date.slice(0,7)===currentMonth;
    return true;
  });
}
function setChartPeriod(p,btn){
  chartPeriod=p;
  document.querySelectorAll('#rsub-chart .period-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  refreshCharts();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONEY INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleMoney(el){const d=el.value.replace(/\D/g,'');el.dataset.raw=d;el.value=d?parseInt(d,10).toLocaleString('vi-VN'):'';}
function blockNonDigit(e){const safe=['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];if(!safe.includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault();}
function getRaw(id){const el=document.getElementById(id);return el?parseInt(el.dataset.raw||'0',10)||0:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COPY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doCopy(boxId,btnId){
  const box=document.getElementById(boxId);if(!box)return;
  const text=box.textContent.trim();if(!text){showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return;}
  let ok=false;
  try{if(window.isSecureContext&&navigator.clipboard?.writeText){await navigator.clipboard.writeText(text);ok=true;}
  else{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px;opacity:0';document.body.appendChild(ta);ta.focus();ta.select();ok=document.execCommand('copy');document.body.removeChild(ta);}}catch{}
  if(ok){showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');if(btnId){const b=document.getElementById(btnId);if(b){const orig=b.innerHTML;b.innerHTML='âœ… ÄÃ£ sao chÃ©p!';b.classList.add('ok');b.disabled=true;setTimeout(()=>{b.innerHTML=orig;b.classList.remove('ok');b.disabled=false;},2000);}}}
  else showToast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);
}
async function copyRaw(text,msg){let ok=false;try{if(window.isSecureContext&&navigator.clipboard?.writeText){await navigator.clipboard.writeText(text);ok=true;}else{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px;opacity:0';document.body.appendChild(ta);ta.focus();ta.select();ok=document.execCommand('copy');document.body.removeChild(ta);}}catch{}showToast(ok?msg:'âŒ KhÃ´ng sao chÃ©p Ä‘Æ°á»£c',!ok);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY / PRODUCT DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getCats=()=>MD.categories||[];
function openDrop(dropId,prefix){const inp=document.getElementById(prefix+'CatInput');renderCatDD(dropId,prefix,inp?inp.value.toLowerCase():'');}
function closeDrop(dropId){const el=document.getElementById(dropId);if(el)el.classList.remove('open');}
function onCatInput(prefix){const inp=document.getElementById(prefix+'CatInput');if(!inp)return;renderCatDD(prefix+'CatDrop',prefix,inp.value.toLowerCase());const exact=getCats().find(c=>c.toLowerCase()===inp.value.toLowerCase());if(exact)renderChipsFor(prefix,exact);else{const chips=document.getElementById(prefix+'Chips');if(chips)chips.innerHTML='';}}
function renderCatDD(dropId,prefix,val){
  const drop=document.getElementById(dropId);if(!drop)return;drop.innerHTML='';
  const filtered=val?getCats().filter(c=>c.toLowerCase().includes(val)):getCats();
  filtered.forEach(c=>{const d=document.createElement('div');d.className='cat-opt';d.textContent=c;d.onmousedown=()=>{document.getElementById(prefix+'CatInput').value=c;closeDrop(dropId);renderChipsFor(prefix,c);};drop.appendChild(d);});
  if(val&&!getCats().some(c=>c.toLowerCase()===val)){const d=document.createElement('div');d.className='cat-opt new-item';d.textContent='â• ThÃªm "'+val+'"';d.onmousedown=()=>{const p=val.charAt(0).toUpperCase()+val.slice(1);if(!MD.categories.includes(p)){MD.categories.push(p);persist();}document.getElementById(prefix+'CatInput').value=p;closeDrop(dropId);renderChipsFor(prefix,p);showToast('âœ… ÄÃ£ thÃªm danh má»¥c "'+p+'"');};drop.appendChild(d);}
  drop.classList.toggle('open',drop.children.length>0);
}
function onProdInput(){const inp=document.getElementById('impName'),drop=document.getElementById('prodSugDrop');if(!inp||!drop)return;const val=inp.value.toLowerCase();const m=val?(MD.products||[]).filter(p=>p.toLowerCase().includes(val)):MD.products||[];drop.innerHTML='';if(!m.length){drop.classList.remove('open');return;}m.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.textContent=p;d.onmousedown=()=>{inp.value=p;drop.classList.remove('open');};drop.appendChild(d);});drop.classList.add('open');}
function closeProdSug(){const el=document.getElementById('prodSugDrop');if(el)el.classList.remove('open');}
function saveProduct(name){if(!name)return;if(!MD.products)MD.products=[];if(!MD.products.includes(name))MD.products.push(name);}
// Sell name suggestion (for income)
function onSellInput(){const inp=document.getElementById('incSellName'),drop=document.getElementById('sellSugDrop');if(!inp||!drop)return;const val=inp.value.toLowerCase();const products=[...new Set([...(MD.products||[]),...getCats()])];const m=val?products.filter(p=>p.toLowerCase().includes(val)):products;drop.innerHTML='';if(!m.length){drop.classList.remove('open');return;}m.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.textContent=p;d.onmousedown=()=>{inp.value=p;drop.classList.remove('open');};drop.appendChild(d);});drop.classList.add('open');}
function closeSellSug(){const el=document.getElementById('sellSugDrop');if(el)el.classList.remove('open');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SMAP={
  'MÃ¬ tÃ´m':{thu:['BÃ¡n láº» mÃ¬','Combo mÃ¬+trá»©ng','BÃ¡n sá»‰ thÃ¹ng'],chi:['Nháº­p mÃ¬ tÃ´m','PhÃ­ váº­n chuyá»ƒn']},
  'Trá»©ng gÃ ':{thu:['BÃ¡n trá»©ng láº»','BÃ¡n vá»‰ 10','BÃ¡n sá»‰'],chi:['Mua cÃ¡m','Hao há»¥t vá»¡']},
  'NÆ°á»›c máº¯m':{thu:['BÃ¡n chai láº»','Combo gia vá»‹'],chi:['Nháº­p nÆ°á»›c máº¯m','HÃ ng háº¿t háº¡n']},
  'Gáº¡o':{thu:['BÃ¡n gáº¡o láº» kg','BÃ¡n bao 25kg'],chi:['Nháº­p gáº¡o','PhÃ­ Ä‘Ã³ng gÃ³i']},
  'Bia/NÆ°á»›c ngá»t':{thu:['BÃ¡n bia láº»','KÃ©t bia'],chi:['Nháº­p bia','Äiá»‡n tá»§ láº¡nh']},
  'BÃ¡nh káº¹o':{thu:['BÃ¡n láº»','TÃºi quÃ  lá»… Táº¿t'],chi:['Nháº­p bÃ¡nh','Bao bÃ¬']},
  'Thá»§ cÃ´ng':{thu:['BÃ¡n táº¡i chá»£','ÄÆ¡n online'],chi:['NguyÃªn váº­t liá»‡u','CÃ´ng thá»£']},
  'Rau cá»§':{thu:['BÃ¡n láº»','Combo rau'],chi:['Nháº­p tá»« vÆ°á»n','Hao há»¥t Ãºa']}
};
const OP_SMAP={utility:['Tiá»n Ä‘iá»‡n','Tiá»n nÆ°á»›c','PhÃ­ internet'],transport:['Váº­n chuyá»ƒn nháº­p','Ship giao khÃ¡ch'],loss:['HÃ ng há»ng','Tráº£ hÃ ng lá»—i'],rental:['ThuÃª máº·t báº±ng','ThuÃª kho'],labor:['LÆ°Æ¡ng nhÃ¢n viÃªn','Tiá»n cÃ´ng'],other:['Chi phÃ­ phÃ¡t sinh','Tiáº¿p khÃ¡ch']};
function renderChipsFor(prefix,cat){
  const isInc=prefix==='inc';const el=document.getElementById(prefix+'Chips');if(!el)return;el.innerHTML='';
  const map=SMAP[cat];if(!map)return;
  (isInc?map.thu:map.chi).forEach(t=>{const c=document.createElement('button');c.className='chip'+(isInc?'':' chi-c');c.textContent=(isInc?'ğŸ’° ':'ğŸ’¸ ')+t;c.onclick=()=>{const d=document.getElementById(isInc?'incDesc':'impName');if(d)d.value=t;};el.appendChild(c);});
}
function renderOpChips(){const t=document.getElementById('opType').value,el=document.getElementById('opChips');if(!el)return;el.innerHTML='';(OP_SMAP[t]||[]).forEach(item=>{const c=document.createElement('button');c.className='chip chi-c';c.textContent='ğŸ’¸ '+item;c.onclick=()=>{const d=document.getElementById('opDesc');if(d)d.value=item;};el.appendChild(c);});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD / DELETE INCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addIncome(){
  const desc=(document.getElementById('incDesc')||{value:''}).value.trim();
  const amt=getRaw('incAmount'),date=(document.getElementById('incDate')||{value:''}).value;
  if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  const cat=(document.getElementById('incCatInput')||{value:''}).value;
  const sellName=(document.getElementById('incSellName')||{value:''}).value.trim();
  MD.income.push({id:Date.now(),desc,amount:amt,date,cat,sellName});
  if(sellName)saveProduct(sellName);
  persist();renderAll();
  clearFields('incDesc','incAmount','incSellName');
  showToast('âœ… ÄÃ£ thÃªm khoáº£n thu!');
}
function delIncome(id){
  showConfirm('XoÃ¡ khoáº£n thu','Báº¡n cháº¯c cháº¯n muá»‘n xoÃ¡ khoáº£n thu nÃ y? Thao tÃ¡c khÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{MD.income=MD.income.filter(x=>x.id!==id);persist();renderAll();showToast('âœ… ÄÃ£ xoÃ¡!');});
}
function bulkDelete(type){
  const selected=[];
  document.querySelectorAll(`.cb-${type}:checked`).forEach(cb=>selected.push(parseInt(cb.value)));
  if(!selected.length){showToast('âš ï¸ ChÆ°a chá»n giao dá»‹ch nÃ o!',true);return;}
  showConfirm(`XoÃ¡ ${selected.length} giao dá»‹ch`,`XoÃ¡ ${selected.length} giao dá»‹ch Ä‘Ã£ chá»n? Thao tÃ¡c khÃ´ng thá»ƒ hoÃ n tÃ¡c.`,()=>{
    if(type==='inc'){MD.income=MD.income.filter(x=>!selected.includes(x.id));}
    else{selected.forEach(id=>{const item=MD.expense.find(x=>x.id===id);if(item&&item.expenseType==='import'&&item.name&&MD.inventory[item.name])MD.inventory[item.name].qty=Math.max(0,MD.inventory[item.name].qty-(item.qty||1));});MD.expense=MD.expense.filter(x=>!selected.includes(x.id));}
    persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}
function confirmDeleteAll(type){
  const label=type==='inc'?'thu':'chi';
  showConfirm(`XoÃ¡ táº¥t cáº£ khoáº£n ${label}`,`XoÃ¡ TOÃ€N Bá»˜ khoáº£n ${label} thÃ¡ng ${monthLabel(currentMonth)}? Thao tÃ¡c nÃ y KHÃ”NG THá»‚ hoÃ n tÃ¡c!`,()=>{
    if(type==='inc'){MD.income=[];}else{MD.inventory={};MD.expense=[];}
    persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡ táº¥t cáº£!');
  });
}
function toggleSelectAll(type,checked){
  document.querySelectorAll(`.cb-${type}`).forEach(cb=>cb.checked=checked);
  updateBulkBtn(type);
}
function updateBulkBtn(type){
  const count=document.querySelectorAll(`.cb-${type}:checked`).length;
  const btn=document.getElementById(type+'BulkDelBtn');
  if(btn)btn.style.display=count>0?'inline-flex':'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD / DELETE EXPENSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addImport(){
  const name=(document.getElementById('impName')||{value:''}).value.trim();
  const qty=getRaw('impQty'),amt=getRaw('impAmount'),date=(document.getElementById('impDate')||{value:''}).value;
  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p thÃ nh tiá»n!',true);return;}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  const cat=(document.getElementById('impCatInput')||{value:''}).value;
  MD.expense.push({id:Date.now(),desc:'Nháº­p: '+name,amount:amt,date,expenseType:'import',name,qty,cat});
  if(!MD.inventory[name])MD.inventory[name]={qty:0,lastPrice:0};
  MD.inventory[name].qty+=(qty||1);
  MD.inventory[name].lastPrice=qty>0?Math.round(amt/qty):amt;
  saveProduct(name);persist();renderAll();renderInventory();
  clearFields('impName','impQty','impAmount');
  const n=document.getElementById('expAutofillNotice');if(n)n.classList.remove('show');
  showToast('âœ… Nháº­p hÃ ng + cáº­p nháº­t kho!');
}
function addOperational(){
  const desc=(document.getElementById('opDesc')||{value:''}).value.trim();
  const amt=getRaw('opAmount'),date=(document.getElementById('opDate')||{value:''}).value;
  if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  MD.expense.push({id:Date.now(),desc,amount:amt,date,expenseType:'operational',cat:document.getElementById('opType').value});
  persist();renderAll();clearFields('opDesc','opAmount');showToast('âœ… ÄÃ£ thÃªm chi phÃ­!');
}
function delExpense(id){
  showConfirm('XoÃ¡ khoáº£n chi','Báº¡n cháº¯c cháº¯n muá»‘n xoÃ¡ khoáº£n chi nÃ y? Thao tÃ¡c khÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{
    const item=MD.expense.find(x=>x.id===id);
    if(item&&item.expenseType==='import'&&item.name&&MD.inventory[item.name])MD.inventory[item.name].qty=Math.max(0,MD.inventory[item.name].qty-(item.qty||1));
    MD.expense=MD.expense.filter(x=>x.id!==id);persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}
function clearFields(...ids){ids.forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.dataset.raw='';}});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLANS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addPlan(){
  const name=(document.getElementById('planName')||{value:''}).value.trim();
  const amt=getRaw('planAmount'),month=(document.getElementById('planMonth')||{value:''}).value;
  const note=(document.getElementById('planNote')||{value:''}).value.trim();
  const type=(document.getElementById('planType')||{value:'other'}).value;
  if(!name){showToast('âš ï¸ Nháº­p tÃªn káº¿ hoáº¡ch!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p sá»‘ tiá»n dá»± kiáº¿n!',true);return;}
  // Save plan into the target month's data
  const targetMD=loadMD(month);
  if(!targetMD.plans)targetMD.plans=[];
  targetMD.plans.push({id:Date.now(),name,amount:amt,type,note,createdMonth:currentMonth});
  saveMD(month,targetMD);
  if(month===currentMonth){MD=targetMD;}
  persist();renderPlans();clearFields('planName','planAmount','planNote');
  showToast(`âœ… ÄÃ£ thÃªm káº¿ hoáº¡ch vÃ o ${monthLabel(month)}!`);
}
function delPlan(id){
  showConfirm('XoÃ¡ káº¿ hoáº¡ch','XoÃ¡ káº¿ hoáº¡ch nÃ y?',()=>{MD.plans=MD.plans.filter(x=>x.id!==id);persist();renderPlans();showToast('âœ… ÄÃ£ xoÃ¡!');});
}
function renderPlans(){
  const el=document.getElementById('planList');if(!el)return;
  const plans=MD.plans||[];
  if(!plans.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ káº¿ hoáº¡ch nÃ o</div>';return;}
  const typeLabel={import:'ğŸ“¦ Nháº­p hÃ ng',utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',rental:'ğŸª Máº·t báº±ng',labor:'ğŸ‘· NhÃ¢n cÃ´ng',other:'ğŸ“Œ KhÃ¡c'};
  el.innerHTML=plans.map(p=>`
    <div class="plan-item">
      <div class="plan-body">
        <div class="plan-name">${p.name}</div>
        <div class="plan-meta">${typeLabel[p.type]||p.type}${p.note?' Â· '+p.note:''}</div>
      </div>
      <div class="plan-amount">-${fmt(p.amount)}</div>
      <button class="plan-del" onclick="delPlan(${p.id})">ğŸ—‘ï¸</button>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmt=n=>(n||0).toLocaleString('vi-VN')+'Ä‘';
const fmtD=d=>{try{const[y,m,day]=d.split('-');return `${day}/${m}`;}catch{return d||'';}};
const sum=arr=>(arr||[]).reduce((s,x)=>s+(x.amount||0),0);
function persist(){saveMD(currentMonth,MD);buildMonthSelect();}
function renderAll(){renderSummary();renderIncTable();renderExpTable();}

function renderSummary(){
  const thu=sum(MD.income),chi=sum(MD.expense),p=thu-chi;
  const sets=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  sets('totalThu',fmt(thu));sets('totalChi',fmt(chi));sets('totalThu2',fmt(thu));sets('totalChi2',fmt(chi));
  ['totalProfit','totalProfit2'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=(p>=0?'+':'')+fmt(p);el.style.color=p>=0?'var(--p600)':'var(--red)';}});
}

function renderIncTable(){
  const w=document.getElementById('incTableWrap');if(!w)return;
  const filtered=filterByPeriod(MD.income,incPeriod);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ khoáº£n thu nÃ o</div>';return;}
  const rows=filtered.slice().reverse().map(t=>
    `<tr><td><input type="checkbox" class="cb-cell cb-inc" value="${t.id}" onchange="updateBulkBtn('inc')"></td>
     <td>${fmtD(t.date)}</td><td>${t.sellName?'<span class="tag tag-thu">'+t.sellName+'</span> ':''}<small>${t.desc}</small></td>
     <td class="thu-v">+${fmt(t.amount)}</td>
     <td><button class="del-btn" onclick="delIncome(${t.id})">ğŸ—‘ï¸</button></td></tr>`
  ).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderExpTable(){
  const w=document.getElementById('expTableWrap');if(!w)return;
  const filtered=filterByPeriod(MD.expense.filter(x=>x.expenseType==='import'),expPeriod);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’¸</div>ChÆ°a cÃ³ khoáº£n nháº­p hÃ ng nÃ o</div>';return;}
  const rows=filtered.slice().reverse().map(t=>
    `<tr><td><input type="checkbox" class="cb-cell cb-exp" value="${t.id}" onchange="updateBulkBtn('exp')"></td>
     <td>${fmtD(t.date)}</td><td>${t.desc}</td>
     <td><span class="tag tag-imp">ğŸ“¦</span></td>
     <td class="chi-v">-${fmt(t.amount)}</td>
     <td><button class="del-btn" onclick="delExpense(${t.id})">ğŸ—‘ï¸</button></td></tr>`
  ).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>MÃ´ táº£</th><th></th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderInventory(){
  const el=document.getElementById('inventoryList');if(!el)return;
  const keys=Object.keys(MD.inventory||{}).filter(k=>MD.inventory[k].qty>0);
  if(!keys.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng</div>';return;}
  el.innerHTML=keys.map(k=>`<div class="inv-kho-row"><div class="inv-kho-name">ğŸ·ï¸ ${k}</div><div class="inv-qty">${MD.inventory[k].qty} cÃ¡i</div><div class="inv-price">${fmt(MD.inventory[k].lastPrice)}/cÃ¡i</div></div>`).join('');
}

function renderHomeRecent(){
  const w=document.getElementById('homeRecentWrap');if(!w)return;
  const all=[...MD.income.map(x=>({...x,type:'thu'})),...MD.expense.map(x=>({...x,type:'chi'}))].sort((a,b)=>(b.date||'').localeCompare(a.date||'')||b.id-a.id).slice(0,8);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return;}
  const rows=all.map(x=>`<tr><td>${fmtD(x.date)}</td><td>${x.type==='thu'?'<span class="tag tag-thu">ğŸ’° Thu</span>':'<span class="tag tag-imp">ğŸ’¸ Chi</span>'}</td><td>${x.desc||''}</td><td class="${x.type==='thu'?'thu-v':'chi-v'}">${x.type==='thu'?'+':'-'}${fmt(x.amount)}</td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPARE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showCompare(){
  const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;
  if(!a||!b||a===b){showToast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return;}
  const da=loadMD(a),db=loadMD(b);
  const aThu=sum(da.income),aChi=sum(da.expense),aLai=aThu-aChi;
  const bThu=sum(db.income),bChi=sum(db.expense),bLai=bThu-bChi;
  const delta=(cur,prv)=>{const d=cur-prv,pct=prv>0?Math.round(d/prv*100):0;return `<div class="cmp-delta ${d>=0?'delta-up':'delta-down'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`;};
  document.getElementById('compareBox').innerHTML=`
    <h3>ğŸ“Š ${monthLabel(a)} vs ${monthLabel(b)}</h3>
    <div class="cmp-grid">
      <div class="cmp-item"><div class="cmp-lbl">ğŸ“ˆ Thu</div><div class="cmp-cur">${fmt(aThu)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bThu)}</div>${delta(aThu,bThu)}</div>
      <div class="cmp-item"><div class="cmp-lbl">ğŸ“‰ Chi</div><div class="cmp-cur">${fmt(aChi)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bChi)}</div>${delta(aChi,bChi)}</div>
      <div class="cmp-item"><div class="cmp-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="cmp-cur" style="color:${aLai>=0?'var(--p600)':'var(--red)'}">${(aLai>=0?'+':'')+fmt(aLai)}</div><div class="cmp-prev">${(bLai>=0?'+':'')+fmt(bLai)}</div>${delta(aLai,bLai)}</div>
    </div>`;
  document.getElementById('compareBox').classList.add('show');
}
function hideCompare(){const el=document.getElementById('compareBox');if(el){el.classList.remove('show');el.innerHTML='';}}

function buildAllTimeCompare(){
  const el=document.getElementById('allTimeCompare');if(!el)return;
  const opts=getMonthOpts();
  if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return;}
  const rows=opts.map(k=>{
    const d=loadMD(k),thu=sum(d.income),chi=sum(d.expense),lai=thu-chi;
    return `<tr><td>${monthLabel(k)}</td><td class="thu-v">+${fmt(thu)}</td><td class="chi-v">-${fmt(chi)}</td><td style="font-weight:800;color:${lai>=0?'var(--p600)':'var(--red)'}">${(lai>=0?'+':'')+fmt(lai)}</td></tr>`;
  }).join('');
  const allThu=opts.reduce((s,k)=>s+sum(loadMD(k).income),0);
  const allChi=opts.reduce((s,k)=>s+sum(loadMD(k).expense),0);
  const allLai=allThu-allChi;
  el.innerHTML=`<div class="tbl-wrap"><table>
    <thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead>
    <tbody>${rows}</tbody>
    <tfoot><tr style="background:var(--p700);color:#fff">
      <td style="font-weight:800;padding:8px 9px">Tá»•ng cá»™ng</td>
      <td style="padding:8px 9px;font-weight:900">+${fmt(allThu)}</td>
      <td style="padding:8px 9px;font-weight:900">-${fmt(allChi)}</td>
      <td style="padding:8px 9px;font-weight:900;color:${allLai>=0?'#A8E6C1':'#FFB3AA'}">${(allLai>=0?'+':'')+fmt(allLai)}</td>
    </tr></tfoot>
    </table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getAllTx(){
  const all=[];
  getMonthOpts().forEach(mk=>{
    const d=loadMD(mk);
    (d.income||[]).forEach(x=>all.push({...x,monthKey:mk,type:'thu'}));
    (d.expense||[]).forEach(x=>all.push({...x,monthKey:mk,type:'chi'}));
  });
  return all.sort((a,b)=>(b.date||'').localeCompare(a.date||'')||b.id-a.id);
}
function renderHistory(){
  const all=getAllTx();
  const search=(document.getElementById('histSearch')||{value:''}).value.toLowerCase();
  const typeF=(document.getElementById('histTypeFilter')||{value:''}).value;
  const monthF=(document.getElementById('histMonthFilter')||{value:''}).value;
  const allMonths=[...new Set(all.map(x=>x.monthKey))];
  const mSel=document.getElementById('histMonthFilter');
  if(mSel){const cur=mSel.value;mSel.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+allMonths.map(m=>`<option value="${m}"${m===cur?' selected':''}>${monthLabel(m)}</option>`).join('');}
  const filtered=all.filter(x=>{
    if(search&&!(x.desc||'').toLowerCase().includes(search))return false;
    if(typeF&&x.type!==typeF)return false;
    if(monthF&&x.monthKey!==monthF)return false;
    return true;
  });
  const allThu=filtered.filter(x=>x.type==='thu').reduce((s,x)=>s+x.amount,0);
  const allChi=filtered.filter(x=>x.type==='chi').reduce((s,x)=>s+x.amount,0);
  const allP=allThu-allChi;
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('histAllThu',fmt(allThu));set('histAllChi',fmt(allChi));
  const pe=document.getElementById('histAllProfit');
  if(pe){pe.textContent=(allP>=0?'+':'')+fmt(allP);pe.style.color=allP>=0?'var(--p600)':'var(--red)';}
  const w=document.getElementById('histTableWrap');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch nÃ o</div>';return;}
  const rows=filtered.map(x=>{
    const isT=x.type==='thu';
    const tag=isT?'<span class="tag tag-thu">ğŸ’° Thu</span>':`<span class="tag ${x.expenseType==='import'?'tag-imp':'tag-op'}">${x.expenseType==='import'?'ğŸ“¦ Nháº­p':'âš¡ Chi phÃ­'}</span>`;
    return `<tr class="hist-row-clickable" onclick="jumpToMonth('${x.monthKey}')">
      <td>${fmtD(x.date)}</td><td>${tag}</td><td>${x.cat||'â€”'}</td><td>${x.desc||''}</td>
      <td class="${isT?'thu-v':'chi-v'}">${isT?'+':'-'}${fmt(x.amount)}</td>
      <td><span class="jump-badge">${monthLabel(x.monthKey)}</span></td>
    </tr>`;
  }).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>NhÃ³m</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}
function jumpToMonth(key){currentMonth=key;MD=loadMD(key);buildMonthSelect();renderAll();switchPage('money',document.querySelectorAll('.bn-btn')[1]);showToast(`âœ… ÄÃ£ chuyá»ƒn sang ${monthLabel(key)}`);}
function exportAllCSV(){
  const all=getAllTx();if(!all.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const csv=['NgÃ y,Loáº¡i,NhÃ³m,MÃ´ táº£,Sá»‘ tiá»n,ThÃ¡ng',...all.map(x=>`"${x.date}","${x.type}","${x.cat||''}","${(x.desc||'').replace(/"/g,'""')}","${x.amount}","${x.monthKey}"`)].join('\n');
  copyRaw(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV toÃ n bá»™ lá»‹ch sá»­!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(parts){
  if(!API_KEY)throw new Error('ChÆ°a cÃ³ API Key â€” vui lÃ²ng nháº­p key á»Ÿ pháº§n Ä‘áº§u.');
  const res=await fetch(`${GEMINI_URL}?key=${API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}]})});
  if(!res.ok)throw new Error(`HTTP ${res.status}: ${res.statusText}`);
  const data=await res.json();
  if(data.error)throw new Error(data.error.message||JSON.stringify(data.error));
  const content=data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!content)throw new Error('Gemini khÃ´ng tráº£ vá» ná»™i dung. Thá»­ láº¡i sau.');
  return content;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN (EXPENSE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleInvoiceImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    invoiceBase64=ev.target.result.split(',')[1];
    const ua=document.getElementById('expUploadArea'),pb=document.getElementById('expImgPreviewBox'),img=document.getElementById('invoicePreview');
    if(ua)ua.style.display='none';if(pb)pb.style.display='block';if(img)img.src=ev.target.result;
    const btn=document.getElementById('scanBtn');if(btn)btn.disabled=false;
  };r.readAsDataURL(f);
}
function changeExpImg(){const ua=document.getElementById('expUploadArea'),pb=document.getElementById('expImgPreviewBox');if(ua)ua.style.display='block';if(pb)pb.style.display='none';invoiceBase64='';const btn=document.getElementById('scanBtn');if(btn)btn.disabled=true;document.getElementById('invoiceImg').value='';}

const INV_PROMPT=`Báº¡n lÃ  trá»£ lÃ½ quáº£n lÃ½ kho. TrÃ­ch xuáº¥t tá»« áº£nh hÃ³a Ä‘Æ¡n nÃ y.
Tráº£ vá» JSON há»£p lá»‡, khÃ´ng cÃ³ markdown, Ä‘Ãºng format:
{"rows":[{"ten":"tÃªn hÃ ng","soluong":"sá»‘ lÆ°á»£ng","dongia":"Ä‘Æ¡n giÃ¡","thanhtien":"thÃ nh tiá»n"}]}
Chá»‰ JSON, khÃ´ng text khÃ¡c.`;

async function scanInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanLoader'),wrap=document.getElementById('invoiceTableWrap'),acts=document.getElementById('invActions'),btn=document.getElementById('scanBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML='';}if(acts)acts.style.display='none';if(btn)btn.disabled=true;
  invoiceData=[];const n=document.getElementById('expAutofillNotice');if(n)n.classList.remove('show');
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:invoiceBase64}},{text:INV_PROMPT}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed&&parsed.rows&&parsed.rows.length){invoiceData=parsed.rows;renderInvoiceTable('invoiceTableWrap',parsed.rows);if(wrap)wrap.classList.add('show');if(acts)acts.style.display='flex';}
    else{if(wrap){wrap.innerHTML=`<div style="padding:11px;font-size:.82rem;white-space:pre-wrap">${raw}</div>`;wrap.classList.add('show');}}
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}
function renderInvoiceTable(wrapId,rows){const w=document.getElementById(wrapId);if(!w)return;const rh=rows.map(r=>`<tr><td>${r.ten||''}</td><td style="text-align:center">${r.soluong||''}</td><td style="text-align:right">${r.dongia||''}</td><td style="text-align:right;font-weight:800;color:var(--p700)">${r.thanhtien||''}</td></tr>`).join('');w.innerHTML=`<table class="inv-tbl"><thead><tr><th>TÃªn hÃ ng</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th></tr></thead><tbody>${rh}</tbody></table>`;}
function autoFillImport(){
  if(!invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const first=invoiceData[0];const name=document.getElementById('impName'),qty=document.getElementById('impQty'),amt=document.getElementById('impAmount');
  if(name)name.value=first.ten||'';
  if(qty){const q=(first.soluong||'').replace(/\D/g,'');qty.dataset.raw=q;qty.value=q?parseInt(q).toLocaleString('vi-VN'):'';}
  const rawA=(first.thanhtien||'').replace(/\D/g,'');if(amt&&rawA){amt.dataset.raw=rawA;amt.value=parseInt(rawA).toLocaleString('vi-VN');}
  const n=document.getElementById('expAutofillNotice');if(n)n.classList.add('show');
  showToast('âœ… ÄÃ£ Ä‘iá»n dÃ²ng Ä‘áº§u vÃ o form!');
}
function copyInvoiceCSV(){if(!invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}const csv=['TÃªn hÃ ng,Sá»‘ lÆ°á»£ng,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',...invoiceData.map(r=>`"${r.ten||''}","${r.soluong||''}","${r.dongia||''}","${r.thanhtien||''}"`)].join('\n');copyRaw(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');}
function copyInvoiceText(){const text=invoiceData.map(r=>`â€¢ ${r.ten} | SL: ${r.soluong} | ${r.thanhtien}`).join('\n');copyRaw(text,'ğŸ“‹ ÄÃ£ sao chÃ©p text!');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN (INCOME)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function incScanMode(mode,btn){
  document.querySelectorAll('.modal-sub-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');
  const imgEl=document.getElementById('incScanImg'),qrEl=document.getElementById('incScanQR');
  if(imgEl)imgEl.style.display=mode==='img'?'block':'none';if(qrEl)qrEl.style.display=mode==='qr'?'block':'none';
  if(mode==='qr'&&incQRScanner)stopIncQR();
}
function handleIncInvoice(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    incInvoiceBase64=ev.target.result.split(',')[1];
    const ua=document.getElementById('incUploadArea'),pb=document.getElementById('incImgPreviewBox'),img=document.getElementById('incInvoicePreview');
    if(ua)ua.style.display='none';if(pb)pb.style.display='block';if(img)img.src=ev.target.result;
    const btn=document.getElementById('scanIncBtn');if(btn)btn.disabled=false;
  };r.readAsDataURL(f);
}
function changeIncImg(){const ua=document.getElementById('incUploadArea'),pb=document.getElementById('incImgPreviewBox');if(ua)ua.style.display='block';if(pb)pb.style.display='none';incInvoiceBase64='';const btn=document.getElementById('scanIncBtn');if(btn)btn.disabled=true;document.getElementById('incInvoiceFile').value='';}

async function scanIncInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanIncLoader'),wrap=document.getElementById('incInvoiceTableWrap'),btn=document.getElementById('scanIncBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML='';}if(btn)btn.disabled=true;
  incInvoiceData=[];const notice=document.getElementById('incAutofillNotice');if(notice)notice.classList.remove('show');
  const prompt=`Báº¡n lÃ  trá»£ lÃ½ bÃ¡n hÃ ng. ÄÃ¢y lÃ  hÃ³a Ä‘Æ¡n bÃ¡n hÃ ng hoáº·c phiáº¿u thu.
TrÃ­ch xuáº¥t thÃ´ng tin bÃ¡n hÃ ng. Tráº£ vá» JSON há»£p lá»‡ khÃ´ng markdown:
{"items":[{"ten":"tÃªn máº·t hÃ ng","soluong":"sá»‘ lÆ°á»£ng","thanhtien":"thÃ nh tiá»n"}],"tongtien":"tá»•ng tiá»n cáº£ hÃ³a Ä‘Æ¡n","ngay":"ngÃ y ghi trÃªn hÃ³a Ä‘Æ¡n náº¿u cÃ³ (YYYY-MM-DD), náº¿u khÃ´ng cÃ³ Ä‘á»ƒ rá»—ng"}
Chá»‰ JSON.`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:incInvoiceBase64}},{text:prompt}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed){
      incInvoiceData=parsed.items||[];
      if(incInvoiceData.length)renderInvoiceTable('incInvoiceTableWrap',incInvoiceData.map(x=>({ten:x.ten,soluong:x.soluong,dongia:'',thanhtien:x.thanhtien})));
      if(wrap)wrap.classList.add('show');
      const totalRaw=(parsed.tongtien||'').replace(/\D/g,'');
      const descVal=incInvoiceData.length?incInvoiceData.map(x=>x.ten).join(', '):'';
      const descEl=document.getElementById('incDesc'),amtEl=document.getElementById('incAmount'),dateEl=document.getElementById('incDate');
      if(descEl&&descVal)descEl.value='BÃ¡n '+descVal;
      if(amtEl&&totalRaw){amtEl.dataset.raw=totalRaw;amtEl.value=parseInt(totalRaw).toLocaleString('vi-VN');}
      if(dateEl&&parsed.ngay&&/^\d{4}-\d{2}-\d{2}$/.test(parsed.ngay))dateEl.value=parsed.ngay;
      if(notice)notice.classList.add('show');showToast('âœ… AI Ä‘Ã£ Ä‘iá»n vÃ o form Thu!');
    }else{if(wrap){wrap.innerHTML=`<div style="padding:11px;font-size:.82rem;white-space:pre-wrap">${raw}</div>`;wrap.classList.add('show');}}
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR (INCOME)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startIncQR(){
  const container=document.getElementById('qr-inc-container'),startBtn=document.getElementById('startIncQRBtn'),stopBtn=document.getElementById('stopIncQRBtn');
  if(typeof Html5Qrcode==='undefined'){if(container)container.innerHTML=`<div class="qr-fallback">âš ï¸ ThÆ° viá»‡n QR chÆ°a load</div>`;return;}
  if(container)container.innerHTML='<div id="qr-inc-reader" style="width:100%"></div>';
  if(startBtn)startBtn.style.display='none';if(stopBtn)stopBtn.style.display='';
  try{
    incQRScanner=new Html5Qrcode('qr-inc-reader');
    incQRScanner.start({facingMode:'environment'},{fps:10,qrbox:200},qrText=>{
      let amount='',name='';try{const p=JSON.parse(qrText);amount=String(p.amount||p.sotien||'');name=p.name||p.ten||'';}catch{amount=qrText.replace(/\D/g,'');}
      const amtEl=document.getElementById('incAmount'),descEl=document.getElementById('incDesc');
      if(amtEl&&amount){amtEl.dataset.raw=amount;amtEl.value=parseInt(amount).toLocaleString('vi-VN');}
      if(descEl&&name)descEl.value=name;
      stopIncQR();showToast('âœ… QuÃ©t QR thÃ nh cÃ´ng!');
    },()=>{}).catch(err=>{if(container)container.innerHTML=`<div class="qr-fallback">âŒ KhÃ´ng má»Ÿ camera: ${err}</div>`;if(startBtn)startBtn.style.display='';if(stopBtn)stopBtn.style.display='none';});
  }catch(err){if(container)container.innerHTML=`<div class="qr-fallback">âŒ ${err}</div>`;}
}
function stopIncQR(){
  if(incQRScanner){incQRScanner.stop().catch(()=>{});incQRScanner=null;}
  const s=document.getElementById('startIncQRBtn'),st=document.getElementById('stopIncQRBtn');if(s)s.style.display='';if(st)st.style.display='none';
  const c=document.getElementById('qr-inc-container');if(c)c.innerHTML='<div class="qr-fallback"><div style="font-size:1.7rem;margin-bottom:5px">ğŸ“·</div><p>Báº¥m nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ má»Ÿ camera QR</p></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FACEBOOK POST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFbImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    fbBase64=ev.target.result.split(',')[1];
    const ua=document.getElementById('fbUploadArea'),pb=document.getElementById('fbImgPreviewBox'),img=document.getElementById('fbPreview');
    if(ua)ua.style.display='none';if(pb)pb.style.display='block';if(img)img.src=ev.target.result;
    const btn=document.getElementById('fbPostBtn');if(btn)btn.disabled=false;
  };r.readAsDataURL(f);
}
function changeFbImg(){const ua=document.getElementById('fbUploadArea'),pb=document.getElementById('fbImgPreviewBox');if(ua)ua.style.display='block';if(pb)pb.style.display='none';fbBase64='';const btn=document.getElementById('fbPostBtn');if(btn)btn.disabled=true;document.getElementById('fbImgInput').value='';}
async function generateFbPost(){
  if(!API_KEY||!fbBase64){showToast('âš ï¸ Cáº§n API Key vÃ  áº£nh!',true);return;}
  const card=document.getElementById('fbResultCard'),loader=document.getElementById('fbLoader'),box=document.getElementById('fbPost'),btn=document.getElementById('copyFb'),postBtn=document.getElementById('fbPostBtn');
  if(card)card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');if(postBtn)postBtn.disabled=true;
  const prompt=`PhÃ¢n tÃ­ch áº£nh sáº£n pháº©m. Tráº£ vá» JSON há»£p lá»‡ (khÃ´ng markdown):
{"productName":"tÃªn ngáº¯n","category":"MÃ¬ tÃ´m|Trá»©ng gÃ |NÆ°á»›c máº¯m|Gáº¡o|Bia/NÆ°á»›c ngá»t|BÃ¡nh káº¹o|Thá»§ cÃ´ng|Rau cá»§|KhÃ¡c","fbPost":"BÃ i Ä‘Äƒng Facebook hoÃ n chá»‰nh vá»›i emoji vÃ  hashtag","tiktokIdea":"Ã tÆ°á»Ÿng TikTok 1 cÃ¢u"}`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:fbBase64}},{text:prompt}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed){
      const ttEl=document.getElementById('ttProduct');if(ttEl)ttEl.value=parsed.productName||'';
      const det=document.getElementById('fbDetected');if(det){det.style.display='block';det.innerHTML=`âœ… <strong>${parsed.productName}</strong> Â· ${parsed.category}`;}
      if(box)box.textContent=parsed.fbPost||raw;
    }else{if(box)box.textContent=raw;}
    if(box)box.classList.add('show');if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(postBtn)postBtn.disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIKTOK SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generateScript(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const ttEl=document.getElementById('ttProduct'),product=ttEl?ttEl.value.trim():'';
  if(!product){showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return;}
  const roleMap={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},roleEl=document.getElementById('ttRole'),xung=roleMap[roleEl?roleEl.value:'ban']||'báº¡n',xungCap=xung.charAt(0).toUpperCase()+xung.slice(1);
  const card=document.getElementById('videoResult'),loader=document.getElementById('videoLoader'),box=document.getElementById('scriptBox'),btn=document.getElementById('copyScript'),sbtn=document.getElementById('scriptBtn');
  if(card)card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');if(sbtn)sbtn.disabled=true;
  const prompt=`Báº¡n lÃ  ngÆ°á»i chÃ¡u hiáº¿u tháº£o, hÆ°á»›ng dáº«n ${xung} quay TikTok bÃ¡n "${product}".
NgÃ´n ngá»¯ cá»±c Ä‘Æ¡n giáº£n, xÆ°ng hÃ´ "con/chÃ¡u" vÃ  "${xung}". ÄÃºng 3 bÆ°á»›c:
BÆ¯á»šC 1 â€” CHUáº¨N Bá»Š: CÃ¡ch Ä‘áº·t Ä‘iá»‡n thoáº¡i vÃ  Ä‘á»©ng á»Ÿ Ä‘Ã¢u.
BÆ¯á»šC 2 â€” HÃ€NH Äá»˜NG: 1 viá»‡c ${xung} lÃ m vá»›i sáº£n pháº©m.
BÆ¯á»šC 3 â€” Lá»œI NÃ“I: 2-3 cÃ¢u ngáº¯n ${xung} Ä‘á»c theo Ä‘Æ°á»£c.
Káº¿t thÃºc: "${xungCap} khÃ´ng cáº§n chá»‰nh sá»­a gÃ¬ cáº£ â€” cá»© quay xong Ä‘Äƒng luÃ´n ğŸ’š"`;
  try{
    const text=await callGemini([{text:prompt}]);
    if(loader)loader.classList.remove('show');if(box){box.textContent=text;box.classList.add('show');}if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(sbtn)sbtn.disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function destroyCharts(){Object.keys(chartInst).forEach(k=>{if(chartInst[k]){try{chartInst[k].destroy();}catch{}chartInst[k]=null;}});}

function getChartData(){
  if(chartPeriod==='week'){
    const days=[],thu=[],chi=[];
    for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(MD.income.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));chi.push(MD.expense.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));}
    return{days,thu,chi};
  }else if(chartPeriod==='month'){
    const daysInMonth=new Date(currentMonth.split('-')[0],currentMonth.split('-')[1],0).getDate();
    const days=[],thu=[],chi=[];
    for(let i=1;i<=daysInMonth;i++){const iso=`${currentMonth}-${String(i).padStart(2,'0')}`;days.push(String(i));thu.push(MD.income.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));chi.push(MD.expense.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));}
    return{days,thu,chi};
  }else{
    const opts=getMonthOpts().slice().reverse();
    const days=opts.map(k=>monthLabel(k).replace('ThÃ¡ng ','T'));
    const thu=opts.map(k=>sum(loadMD(k).income));
    const chi=opts.map(k=>sum(loadMD(k).expense));
    return{days,thu,chi};
  }
}

function refreshCharts(){
  destroyCharts();
  const thu=sum(MD.income),imp=MD.expense.filter(x=>x.expenseType==='import').reduce((s,x)=>s+x.amount,0),op=MD.expense.filter(x=>x.expenseType==='operational').reduce((s,x)=>s+x.amount,0);
  const hasData=thu>0||imp>0||op>0;
  const noData=document.getElementById('noChartData'),content=document.getElementById('chartContent');
  if(noData)noData.style.display=hasData?'none':'block';if(content)content.style.display=hasData?'block':'none';
  if(!hasData)return;
  const pie=document.getElementById('pieChart');
  if(pie)chartInst.pie=new Chart(pie,{type:'doughnut',data:{labels:['Thu','Nháº­p hÃ ng','Chi phÃ­ thÃªm'],datasets:[{data:[thu,imp,op],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:7}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},padding:6}}}}});
  const expItems=[...new Set(MD.expense.map(x=>x.desc))].slice(0,5),expVals=expItems.map(d=>MD.expense.filter(x=>x.desc===d).reduce((s,x)=>s+x.amount,0));
  const bar=document.getElementById('barChart');
  if(bar)chartInst.bar=new Chart(bar,{type:'bar',data:{labels:expItems.length?expItems:['ChÆ°a cÃ³'],datasets:[{label:'Ä‘',data:expItems.length?expVals:[0],backgroundColor:'rgba(27,107,58,.72)',borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
  const{days,thu:thuLine,chi:chiLine}=getChartData();
  const line=document.getElementById('lineChart');
  if(line)chartInst.line=new Chart(line,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thuLine,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chiLine,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'}},x:{grid:{display:false},ticks:{font:{size:9}}}}}});
}

function refreshHomeChart(){
  if(chartInst.homeLine){try{chartInst.homeLine.destroy();}catch{}chartInst.homeLine=null;}
  const days=[],thu=[],chi=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(MD.income.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));chi.push(MD.expense.filter(x=>x.date===iso).reduce((s,x)=>s+x.amount,0));}
  const c=document.getElementById('homeLineChart');if(!c)return;
  chartInst.homeLine=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'}},x:{grid:{display:false}}}}});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendChat(){
  const inp=document.getElementById('chatInp'),msg=inp?inp.value.trim():'';
  if(!msg)return;if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  if(inp)inp.value='';addMsg(msg,'user');
  const typing=document.getElementById('chatTyping');if(typing)typing.classList.add('show');scrollChat();
  try{
    const text=await callGemini([{text:`Báº¡n lÃ  Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, chuyÃªn tÆ° váº¥n há»™ kinh doanh nhá» táº¡i Viá»‡t Nam. Ngáº¯n gá»n, thá»±c táº¿, dÃ¹ng emoji.\n\nCÃ¢u há»i: ${msg}`}]);
    if(typing)typing.classList.remove('show');addMsg(text,'bot');
  }catch(err){if(typing)typing.classList.remove('show');addMsg('âŒ '+err.message,'bot');}
}
function addMsg(text,role){const msgs=document.getElementById('chatMsgs');if(!msgs)return;const div=document.createElement('div');div.className='msg '+role;div.textContent=text;msgs.insertBefore(div,document.getElementById('chatTyping'));scrollChat();}
function scrollChat(){const m=document.getElementById('chatMsgs');if(m)m.scrollTop=m.scrollHeight;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg,isErr=false){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className=isErr?'err':'';t.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2600);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
['incDate','impDate','opDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=TODAY;});
buildMonthSelect();renderAll();renderHomeRecent();
setTimeout(refreshHomeChart,100);
</script>
</body>
</html>

