<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;background:#F7FBF8;color:#1A2E23;overflow:hidden}
:root{
  --g:#1B6B3A;--g2:#145230;--g3:#0D3A22;--g4:#E8F5E9;--g5:#C8E9D5;
  --r:#D94F3D;--rb:#FDF0EE;--a:#F5A623;
  --bd:#DDE8E2;--card:#fff;--muted:#5A7A66;--subtle:#8FA89A;
  --sh:0 2px 8px rgba(0,0,0,.09);
}
#app{display:flex;flex-direction:column;height:100dvh;max-width:100vw;overflow:hidden}
#hdr{background:linear-gradient(135deg,var(--g3),var(--g));color:#fff;padding:8px 14px 6px;text-align:center;flex-shrink:0}
#hdr h1{font-size:1.05rem;font-weight:900}
#hdr p{font-size:.6rem;opacity:.75;margin-top:1px}
.badge{background:var(--a);color:#1A2E23;font-size:.5rem;font-weight:900;padding:2px 5px;border-radius:20px;margin-left:4px}
#monthBar{flex-shrink:0;background:var(--card);border-bottom:2px solid var(--bd);padding:5px 10px;display:flex;align-items:center;gap:7px;overflow:hidden}
#monthBar label{font-size:.68rem;font-weight:800;color:var(--muted);flex-shrink:0}
#monthSel{padding:4px 7px;border:2px solid var(--bd);border-radius:8px;font-size:.78rem;font-weight:700;color:var(--g);background:var(--g4);cursor:pointer;max-width:150px}
#monthBadge{font-size:.6rem;background:var(--g4);color:var(--g);padding:2px 8px;border-radius:20px;font-weight:800;border:1.5px solid var(--g5);margin-left:auto;white-space:nowrap;flex-shrink:0}
#main{flex:1;overflow:hidden;position:relative;min-height:0}
.pg{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.pg.on{display:block}
#pg-ai{display:none;position:absolute;inset:0;flex-direction:column;background:#0D1F16}
#pg-ai.on{display:flex}
.wrap{padding:10px;max-width:560px;margin:0 auto;padding-bottom:14px;overflow-x:hidden}
#nav{flex-shrink:0;display:flex;background:var(--card);border-top:2px solid var(--bd);box-shadow:0 -2px 12px rgba(0,0,0,.08)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:6px 2px;border-top:3px solid transparent;color:var(--muted);font-family:inherit;min-width:0;font-size:.45rem;font-weight:800}
.nb .ic{font-size:1.1rem;line-height:1}
.nb.on{color:var(--g);border-top-color:var(--g);background:var(--g4)}
.card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:10px;box-shadow:var(--sh);border:1px solid var(--bd);overflow:hidden}
.ctitle{font-size:.85rem;font-weight:800;color:var(--g2);margin-bottom:7px}
.csub{font-size:.67rem;color:var(--muted);margin-bottom:7px;line-height:1.5}
.strip3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.sc{background:var(--card);border-radius:10px;padding:8px 5px;text-align:center;border:1px solid var(--bd)}
.sc .sl{font-size:.56rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.sc .sv{font-size:.8rem;font-weight:900;word-break:break-all}
.sc.thu .sv{color:var(--g)}.sc.chi .sv{color:var(--r)}.sc.lai .sv{color:var(--g2)}
.todayCard{background:linear-gradient(135deg,var(--g3),var(--g));border-radius:14px;padding:10px 12px 8px;margin-bottom:8px;color:#fff}
.todayCard .tl{font-size:.58rem;opacity:.75;margin-bottom:5px}
.todayCard .strip3 .sc{background:rgba(255,255,255,.12);border:none}
.todayCard .strip3 .sc .sl{color:rgba(255,255,255,.7)}
.todayCard .strip3 .sc .sv{color:#fff}
.tabs{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.tab{padding:5px 11px;border:2px solid var(--bd);background:#fff;border-radius:30px;font-size:.69rem;font-weight:800;color:var(--muted);cursor:pointer;white-space:nowrap}
.tab.on{background:var(--g);color:#fff;border-color:var(--g)}
.field{margin-bottom:8px}
.field label{font-size:.66rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:8px 10px;border:2px solid var(--bd);border-radius:8px;font-size:.84rem;font-family:inherit;background:#fff;color:#1A2E23;transition:.15s}
.inp:focus{outline:none;border-color:var(--g);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.btn{width:100%;padding:10px;border:none;border-radius:12px;font-size:.83rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:7px;font-family:inherit;transition:.15s}
.btn-g{background:var(--g);color:#fff}.btn-g:hover{background:var(--g2)}
.btn-w{background:var(--g4);color:var(--g2);border:2px solid var(--g5)}.btn-w:hover{background:var(--g5)}
.btn-r{background:var(--rb);color:var(--r);border:2px solid #F5C6C0}
.btn-a{background:var(--a);color:#1A2E23}
.btn-sm{padding:5px 10px;font-size:.7rem;border-radius:8px;width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.4;cursor:not-allowed}
.sugwrap{position:relative}
.sugdrop{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--g5);border-top:none;border-radius:0 0 8px 8px;z-index:600;max-height:180px;overflow-y:auto;display:none;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.sugdrop.on{display:block}
.sugopt{padding:8px 11px;cursor:pointer;font-size:.82rem;border-bottom:1px solid var(--bd)}
.sugopt:last-child{border-bottom:none}.sugopt:hover{background:var(--g4)}
.sugopt .sm{font-size:.62rem;color:var(--muted);margin-top:1px}
.suggrp{padding:4px 11px 2px;font-size:.58rem;font-weight:900;color:var(--g);background:var(--g4);text-transform:uppercase;letter-spacing:.5px}
.tblwrap{overflow-x:auto;overflow-y:auto;border-radius:8px;border:1px solid var(--bd);max-height:280px}
table{width:100%;border-collapse:collapse;font-size:.75rem;min-width:280px}
thead tr{background:var(--g)}
th{padding:6px 7px;text-align:left;color:#fff;font-size:.64rem;font-weight:800;white-space:nowrap}
td{padding:6px 7px;border-bottom:1px solid var(--bd);vertical-align:middle;max-width:120px;word-break:break-word}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--g4)}
.tv{color:var(--g);font-weight:800;white-space:nowrap}
.rv{color:var(--r);font-weight:800;white-space:nowrap}
.delbtn{background:none;border:none;cursor:pointer;font-size:.8rem;padding:2px 3px;border-radius:5px;color:var(--subtle)}
.delbtn:hover{background:var(--rb);color:var(--r)}
.tag{display:inline-block;padding:2px 6px;border-radius:6px;font-size:.61rem;font-weight:800;white-space:nowrap}
.t-sell{background:#D4EDDA;color:var(--g2)}.t-cook{background:#E0E7FF;color:#3730A3}
.t-imp{background:#D1ECF1;color:#0C5460}.t-mat{background:#FFF3CD;color:#856404}
.t-op{background:#F3E8FF;color:#7C3AED}.t-adj{background:#FCE4EC;color:#880E4F}
.ptabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.ptab{padding:4px 10px;border:2px solid var(--bd);background:#fff;border-radius:20px;font-size:.67rem;font-weight:800;color:var(--muted);cursor:pointer}
.ptab.on{background:var(--g);color:#fff;border-color:var(--g)}
.bulkbar{display:flex;align-items:center;gap:6px;margin-bottom:7px;flex-wrap:wrap}
.bulkbar input{width:13px;height:13px;accent-color:var(--g);cursor:pointer}
.bulkbar label{font-size:.71rem;font-weight:800;color:var(--muted);cursor:pointer}
.cbcell input{width:13px;height:13px;accent-color:var(--g);cursor:pointer}
.infobox{background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:7px 10px;font-size:.75rem;color:var(--g2);margin-bottom:8px;display:none;word-break:break-word}
.totalbox{background:#E8F5E9;border:1.5px solid var(--g5);border-radius:8px;padding:6px 10px;font-size:.77rem;color:var(--g2);font-weight:800;margin-bottom:8px;display:none}
.warnbox{background:#FFF8E1;border:1.5px solid var(--a);border-radius:8px;padding:7px 10px;font-size:.72rem;color:#7A5200;margin-bottom:8px}
.invcard{border-radius:8px;padding:9px 11px;margin-bottom:5px;display:flex;align-items:flex-start;gap:8px;border:2px solid}
.ic-out{background:var(--rb);border-color:var(--r)}
.ic-low{background:#FFF8E1;border-color:var(--a)}
.ic-ok{background:var(--g4);border-color:var(--g5)}
.ic-slow{background:#EEF2FF;border-color:#7C83FD}
.invbody{flex:1;min-width:0}
.invname{font-size:.83rem;font-weight:800;word-break:break-word}
.invmeta{font-size:.65rem;color:var(--muted);margin-top:2px;line-height:1.4}
.invqty{font-size:.76rem;font-weight:900;white-space:nowrap;padding:3px 8px;border-radius:20px;flex-shrink:0;align-self:center}
.q-out{background:var(--rb);color:var(--r)}.q-low{background:#FFF3CD;color:#7A5200}.q-ok{background:var(--g4);color:var(--g)}
.invsec{margin-bottom:10px}
.invstitle{font-size:.74rem;font-weight:900;color:var(--g2);margin-bottom:5px}
.invnotice{background:var(--a);color:#1A2E23;border-radius:8px;padding:7px 11px;font-size:.71rem;font-weight:800;margin-bottom:8px}
.adjwarn{background:#FFF8E1;border:1.5px solid var(--a);border-radius:8px;padding:7px 10px;font-size:.72rem;color:#7A5200;margin-bottom:10px}
.chcard{background:var(--card);border-radius:10px;padding:9px;border:1px solid var(--bd);overflow:hidden}
.chcard h3{font-size:.69rem;font-weight:800;color:var(--g2);margin-bottom:5px;text-align:center}
.ch2g{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.chh{position:relative;height:130px}
.chbar{position:relative;height:200px}
.chfull{position:relative;height:150px}
.taxbox{border-radius:12px;padding:12px;margin-bottom:10px;border:3px solid}
.tx-safe{background:#E8F5E9;border-color:#4CAF50}
.tx-warn{background:#FFF8E1;border-color:var(--a)}
.tx-dng{background:var(--rb);border-color:var(--r)}
.txicon{font-size:1.5rem;text-align:center;display:block;margin-bottom:4px}
.txmsg{font-size:.95rem;font-weight:800;text-align:center;margin-bottom:5px;line-height:1.4}
.tx-safe .txmsg{color:#2E7D32}.tx-warn .txmsg{color:#7A5200}.tx-dng .txmsg{color:var(--r)}
.txdet{font-size:.76rem;color:var(--muted);line-height:1.7;background:rgba(255,255,255,.6);border-radius:8px;padding:7px 9px;margin-top:4px}
.txdet strong{color:#1A2E23}
.progwrap{background:var(--bd);border-radius:20px;overflow:hidden;height:18px;margin:8px 0}
.progbar{height:100%;border-radius:20px;transition:width .5s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.63rem;font-weight:900;color:#fff;min-width:20px}
.pb-safe{background:linear-gradient(90deg,var(--g),#27AE60)}.pb-warn{background:linear-gradient(90deg,var(--a),#E67E00)}.pb-dng{background:linear-gradient(90deg,var(--r),#B71C1C)}
.filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
.filters input,.filters select{padding:5px 8px;border:2px solid var(--bd);border-radius:8px;font-size:.74rem;background:#fff;font-family:inherit;min-width:0}
.filters input{flex:1;min-width:70px}
.filters input:focus,.filters select:focus{outline:none;border-color:var(--g)}
.cmpbox{background:var(--g4);border:2px solid var(--g5);border-radius:12px;padding:11px;margin-bottom:10px;display:none}
.cmpbox.on{display:block}
.cmpgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.cmpi{text-align:center;background:#fff;border-radius:8px;padding:7px 4px;border:1px solid var(--bd)}
.cmpl{font-size:.56rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmpc{font-size:.76rem;font-weight:900;color:var(--g2)}.cmpp{font-size:.63rem;color:var(--muted);margin-top:2px}
.cmpd{font-size:.63rem;font-weight:800;margin-top:2px}
.dup{color:var(--g)}.ddn{color:var(--r)}
.aitop{flex-shrink:0;background:#111F17;border-bottom:1px solid #1E3829;padding:8px 14px;display:flex;align-items:center;gap:8px}
.aiav{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--g),#27AE60);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.aitxt{flex:1;min-width:0;font-size:.71rem;color:#8FB89A;line-height:1.4}
.aitxt strong{color:#A8E6C1;font-size:.73rem}
.aidot{width:8px;height:8px;border-radius:50%;background:#27AE60;box-shadow:0 0 6px #27AE60;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.hodmenh{font-size:.52rem;color:#FFD54F;background:rgba(255,213,79,.15);border:1px solid rgba(255,213,79,.3);border-radius:10px;padding:2px 6px;white-space:nowrap}
.msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
.msg{max-width:90%;padding:9px 13px;border-radius:18px;font-size:.81rem;line-height:1.6;word-break:break-word;animation:fu .25s ease}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:#162A1F;border:1px solid #1E3829;color:#D4EDD9;align-self:flex-start;border-bottom-left-radius:4px;max-width:92%}
.msg.usr{background:linear-gradient(135deg,var(--g),#218C4A);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{align-self:flex-start;display:none}.typing.on{display:flex}
.dots{display:flex;gap:4px;padding:9px 14px;background:#162A1F;border:1px solid #1E3829;border-radius:18px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:#6ABF8A;animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.cpill{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.cpill button{padding:6px 14px;border-radius:20px;font-size:.74rem;font-weight:800;cursor:pointer;border:1.5px solid;font-family:inherit}
.py{background:var(--g);color:#fff;border-color:var(--g)}.pn{background:transparent;color:#E87A6A;border-color:#E87A6A}
.taxcard{background:linear-gradient(135deg,#FFF8E1,#FFFDE7);border:2px solid #F5A623;border-radius:14px;padding:14px;margin-top:8px;text-align:center}
.taxcard-title{font-size:.85rem;font-weight:900;color:#7A5200;margin-bottom:4px}
.taxcard-sub{font-size:.7rem;color:#7A5200;margin-bottom:8px}
.taxcard-amt{font-size:1.5rem;font-weight:900;color:#D94F3D;margin:8px 0;letter-spacing:.5px;word-break:break-all}
.taxcard-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
.taxcard-btns button,.taxcard-btns a{padding:9px 16px;border-radius:20px;font-weight:800;cursor:pointer;font-size:.78rem;font-family:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:4px;border:none}
.tcopy{background:#F5A623;color:#1A2E23}
.topen{background:#1B6B3A;color:#fff}
.offbadge{display:inline-block;background:rgba(245,166,35,.2);color:#F5A623;border:1px solid rgba(245,166,35,.4);border-radius:8px;padding:2px 6px;font-size:.6rem;font-weight:800;margin-bottom:4px}
.chips{flex-shrink:0;padding:5px 12px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;border-top:1px solid #1E3829;background:#111F17}
.chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:5px 11px;background:#162A1F;border:1px solid #1E3829;border-radius:20px;color:#8FB89A;font-size:.69rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:inherit}
.chip:hover{background:var(--g2);color:#fff}
.chatfoot{flex-shrink:0;padding:8px 10px 10px;background:#111F17;border-top:1px solid #1E3829;display:flex;gap:8px;align-items:flex-end}
.chatinp{flex:1;min-height:40px;max-height:100px;padding:9px 14px;background:#1A2E23;border:1.5px solid #1E3829;border-radius:22px;color:#E0F0E6;font-size:.84rem;font-family:inherit;resize:none;line-height:1.45;overflow-y:auto;outline:none}
.chatinp::placeholder{color:#3A5A48}.chatinp:focus{border-color:var(--g)}
.sndbtn{flex-shrink:0;width:40px;height:40px;background:linear-gradient(135deg,var(--g),#218C4A);border:none;border-radius:50%;color:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:flex-end;justify-content:center}
.ov.on{display:flex}
.modal{background:#fff;border-radius:20px 20px 0 0;padding:15px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
.modal h3{font-size:.88rem;font-weight:800;color:var(--g2);margin-bottom:8px}
.mbtns{display:flex;gap:7px;margin-top:10px}
.mbtns button{flex:1;padding:9px;border-radius:8px;font-weight:800;font-size:.79rem;cursor:pointer;border:none;font-family:inherit}
.mbtnc{background:#F5F5F5;color:var(--muted);border:2px solid var(--bd)!important}
.mbtnok{background:var(--r);color:#fff}
.mbtna{background:var(--a);color:#1A2E23}
#toast{position:fixed;bottom:66px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--g2);color:#fff;padding:9px 18px;border-radius:30px;font-size:.82rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1),opacity .28s;pointer-events:none;white-space:nowrap;opacity:0;max-width:90vw;text-align:center}
#toast.on{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--r)}#toast.ok{background:#27AE60}
.empty{text-align:center;color:var(--muted);padding:18px 10px;font-size:.77rem}
.empty .ei{font-size:1.6rem;margin-bottom:4px}
.cookitem{background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:7px}
.cookbody{flex:1;min-width:0}
.cookname{font-size:.81rem;font-weight:800;color:var(--g2)}
.cookmeta{font-size:.66rem;color:var(--muted);margin-top:1px}
.cookprice{font-size:.83rem;font-weight:900;color:var(--g);white-space:nowrap;flex-shrink:0}
.cookdel{background:none;border:none;cursor:pointer;font-size:.8rem;color:var(--subtle);padding:2px 3px;border-radius:5px;flex-shrink:0}
.cookdel:hover{background:var(--rb);color:var(--r)}
.convbox{background:#EEF2FF;border:2px solid #7C83FD;border-radius:8px;padding:9px 11px;margin-top:7px;font-size:.75rem;line-height:1.6;display:none}
.convbox.on{display:block}
.hrow{cursor:pointer}.hrow:hover td{background:var(--g5)!important}
.jbadge{display:inline-block;background:var(--g4);color:var(--g);border:1px solid var(--g5);border-radius:5px;font-size:.57rem;padding:1px 4px;font-weight:800}
@keyframes sp{to{transform:rotate(360deg)}}
@media(max-width:370px){.g2,.g3{grid-template-columns:1fr}.ch2g{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app">
<div id="hdr">
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Quáº£n lÃ½ kinh doanh thÃ´ng minh Â· Táº¡p hÃ³a / QuÃ¡n Äƒn</p>
</div>
<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSel" onchange="switchMonth(this.value)"></select>
  <span id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>
<div id="main">

<!-- HOME -->
<div id="pg-home" class="pg on">
<div class="wrap">
  <div class="todayCard">
    <div class="tl" id="todayLabel">ğŸ“… HÃ´m nay</div>
    <div class="strip3">
      <div class="sc"><div class="sl">ğŸ“ˆ Thu</div><div class="sv" id="h-tthu">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ“‰ Chi</div><div class="sv" id="h-tchi">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ’¼ LÃ£i</div><div class="sv" id="h-tlai">0Ä‘</div></div>
    </div>
  </div>
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ ThÃ¡ng thu</div><div class="sv" id="h-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ ThÃ¡ng chi</div><div class="sv" id="h-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sv" id="h-lai">0Ä‘</div><div class="sl">ğŸ’¼ ThÃ¡ng lÃ£i</div></div>
  </div>
  <div class="card">
    <div class="ctitle">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y</div>
    <div class="chfull"><canvas id="homeChart"></canvas></div>
  </div>
  <div class="card"><div class="ctitle">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div><div id="homeRecent"></div></div>
</div>
</div>

<!-- MONEY -->
<div id="pg-money" class="pg">
<div class="wrap">
  <div class="todayCard">
    <div class="tl">ğŸ“… HÃ´m nay</div>
    <div class="strip3">
      <div class="sc"><div class="sl">ğŸ“ˆ Thu</div><div class="sv" id="m-tthu">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ“‰ Chi</div><div class="sv" id="m-tchi">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ’¼ LÃ£i</div><div class="sv" id="m-tlai">0Ä‘</div></div>
    </div>
  </div>
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ ThÃ¡ng thu</div><div class="sv" id="m-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ ThÃ¡ng chi</div><div class="sv" id="m-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sl">ğŸ’¼ LÃ£i/Lá»—</div><div class="sv" id="m-lai">0Ä‘</div></div>
  </div>
  <div class="tabs">
    <button class="tab on" onclick="msub('ban',this)">ğŸ’° BÃ¡n hÃ ng</button>
    <button class="tab" onclick="msub('nhap',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="tab" onclick="msub('chiphi',this)">âš¡ Chi phÃ­</button>
    <button class="tab" onclick="msub('kho',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="tab" onclick="msub('chebien',this)">ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n</button>
  </div>

  <!-- BAN -->
  <div id="ms-ban">
    <div class="card">
      <div class="ctitle">âœï¸ Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="field"><label>ğŸ›’ Chá»n sáº£n pháº©m</label>
        <div class="sugwrap">
          <input class="inp" id="sName" placeholder="GÃµ tÃªn sáº£n pháº©m..." autocomplete="off"
            oninput="onSellSug(this.value)" onfocus="onSellSug(this.value)" onblur="setTimeout(closeSellSug,220)">
          <div class="sugdrop" id="sDrop"></div>
        </div>
      </div>
      <div class="infobox" id="sInfo"></div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" id="sDesc" placeholder="Ghi chÃº thÃªm..."></div>
      <div class="g2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" id="sQty" placeholder="0" oninput="handleM(this);calcTotal()" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ’µ ÄÆ¡n giÃ¡</label><input class="inp" id="sPrice" placeholder="0Ä‘" oninput="handleM(this);calcTotal()" onkeydown="noKey(event)"></div>
      </div>
      <div class="totalbox" id="sTotal"></div>
      <div class="field"><label>ğŸ“… NgÃ y bÃ¡n</label><input class="inp" type="datetime-local" id="sDate"></div>
      <button class="btn btn-g" onclick="addSale()">âœ… XÃ¡c nháº­n bÃ¡n</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n</div>
      <div class="ptabs">
        <button class="ptab on" onclick="setPer('ban','all',this)">Táº¥t cáº£</button>
        <button class="ptab" onclick="setPer('ban','today',this)">HÃ´m nay</button>
        <button class="ptab" onclick="setPer('ban','week',this)">7 ngÃ y</button>
        <button class="ptab" onclick="setPer('ban','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulkbar">
        <input type="checkbox" id="banAll" onchange="selAll('ban',this.checked)">
        <label for="banAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-r btn-sm" id="banBulk" onclick="bulkDel('ban')" style="display:none">ğŸ—‘ï¸ XoÃ¡ chá»n</button>
        <button class="btn btn-r btn-sm" style="margin-left:auto" onclick="cfmDelAll('ban')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="banTable"></div>
    </div>
  </div>

  <!-- NHAP -->
  <div id="ms-nhap" style="display:none">
    <div class="card">
      <div class="ctitle">âœï¸ Nháº­p hÃ ng vÃ o kho</div>
      <div class="g2">
        <div class="field"><label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sugwrap">
            <input class="inp" id="iName" placeholder="VD: MÃ¬ tÃ´m" autocomplete="off"
              oninput="onImpSug(this.value)" onfocus="onImpSug(this.value)" onblur="setTimeout(closeImpSug,220)">
            <div class="sugdrop" id="iDrop"></div>
          </div>
        </div>
        <div class="field"><label>ğŸ“‚ Loáº¡i</label>
          <select class="inp" id="iType" onchange="togImpMode()">
            <option value="hangban">ğŸ›’ HÃ ng bÃ¡n láº¡i (vÃ o kho)</option>
            <option value="nguyenlieu">ğŸ§‚ NguyÃªn liá»‡u (khÃ´ng vÃ o kho)</option>
          </select>
        </div>
      </div>
      <div id="iConvWrap">
        <div class="g3">
          <div class="field"><label>ğŸ“¦ ÄV nháº­p</label><input class="inp" id="iUIn" placeholder="thÃ¹ng, kg..."></div>
          <div class="field"><label>ğŸ·ï¸ ÄV bÃ¡n</label><input class="inp" id="iUOut" placeholder="gÃ³i, chai..."></div>
          <div class="field"><label>ğŸ”¢ Há»‡ sá»‘</label><input class="inp" id="iFac" placeholder="1" oninput="handleM(this);showConv()" onkeydown="noKey(event)"></div>
        </div>
        <div class="convbox" id="convPreview"></div>
      </div>
      <div class="g2">
        <div class="field"><label>ğŸ“¥ Sá»‘ lÆ°á»£ng nháº­p</label><input class="inp" id="iQty" placeholder="0" oninput="handleM(this);showConv()" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ’° Tá»•ng tiá»n lÃ´</label><input class="inp" id="iAmt" placeholder="0Ä‘" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="datetime-local" id="iDate"></div>
      <button class="btn btn-g" onclick="addImport()">â• Nháº­p hÃ ng</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ nháº­p</div>
      <div class="ptabs">
        <button class="ptab on" onclick="setPer('nhap','all',this)">Táº¥t cáº£</button>
        <button class="ptab" onclick="setPer('nhap','today',this)">HÃ´m nay</button>
        <button class="ptab" onclick="setPer('nhap','week',this)">7 ngÃ y</button>
        <button class="ptab" onclick="setPer('nhap','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulkbar">
        <input type="checkbox" id="nhapAll" onchange="selAll('nhap',this.checked)">
        <label for="nhapAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-r btn-sm" id="nhapBulk" onclick="bulkDel('nhap')" style="display:none">ğŸ—‘ï¸ XoÃ¡ chá»n</button>
        <button class="btn btn-r btn-sm" style="margin-left:auto" onclick="cfmDelAll('nhap')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="nhapTable"></div>
    </div>
  </div>

  <!-- CHIPHI -->
  <div id="ms-chiphi" style="display:none">
    <div class="card">
      <div class="ctitle">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="field"><label>ğŸ“‚ Loáº¡i</label>
        <select class="inp" id="cpType">
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" id="cpDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng 6"></div>
      <div class="g2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" id="cpAmt" placeholder="0Ä‘" oninput="handleM(this)" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="cpDate"></div>
      </div>
      <button class="btn btn-g" onclick="addCost()">â• ThÃªm chi phÃ­</button>
    </div>
    <div class="card"><div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ chi phÃ­</div><div id="cpTable"></div></div>
  </div>

  <!-- KHO -->
  <div id="ms-kho" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ—„ï¸ Tá»“n kho thÃ´ng minh</div>
      <div class="filters">
        <input type="text" id="invSearch" placeholder="ğŸ” TÃ¬m sáº£n pháº©m..." oninput="renderInv()">
        <select id="invStatus" onchange="renderInv()">
          <option value="">Táº¥t cáº£</option>
          <option value="out">ğŸ”´ Háº¿t</option>
          <option value="low">ğŸŸ¡ Sáº¯p háº¿t</option>
          <option value="ok">ğŸŸ¢ Äá»§</option>
        </select>
      </div>
      <div id="invView"></div>
      <div style="display:flex;gap:7px;margin-top:8px">
        <button class="btn btn-a" style="flex:1;margin:0" onclick="openAdj()">âš™ï¸ Äiá»u chá»‰nh / Hao há»¥t</button>
        <button class="btn btn-w" style="flex:1;margin:0" onclick="askAIInv()">ğŸ¤– Há»i AI</button>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ Ä‘iá»u chá»‰nh kho</div>
      <div class="csub">âš ï¸ KhÃ´ng táº¡o khoáº£n chi â€” chá»‰ trá»« tá»“n kho</div>
      <div id="adjHist"></div>
    </div>
  </div>

  <!-- CHEBIEN -->
  <div id="ms-chebien" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ‘¨â€ğŸ³ Sáº£n pháº©m cháº¿ biáº¿n</div>
      <div class="csub">Phá»Ÿ, cÆ¡m, nÆ°á»›c Ã©p... â€” chá»‰ ghi doanh thu, khÃ´ng trá»« kho</div>
      <div class="g2">
        <div class="field"><label>ğŸ“ TÃªn sáº£n pháº©m</label><input class="inp" id="cbName" placeholder="VD: Phá»Ÿ bÃ²"></div>
        <div class="field"><label>ğŸ’µ GiÃ¡ bÃ¡n</label><input class="inp" id="cbPrice" placeholder="0Ä‘ (tuá»³ chá»n)" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      </div>
      <button class="btn btn-g" onclick="addCook()">â• ThÃªm</button>
    </div>
    <div class="card"><div class="ctitle">ğŸ“‹ Danh sÃ¡ch</div><div id="cookList"></div></div>
  </div>
</div>
</div>

<!-- PROMO -->
<div id="pg-promo" class="pg">
<div class="wrap">
  <div class="card warnbox">ğŸ“£ áº¢nh & ná»™i dung á»Ÿ Ä‘Ã¢y chá»‰ dÃ¹ng cho marketing, khÃ´ng táº¡o giao dá»‹ch kho.</div>
  <div class="tabs">
    <button class="tab on" onclick="psub('fb',this)">ğŸ“£ Facebook</button>
    <button class="tab" onclick="psub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="ps-fb">
    <div class="card">
      <div class="ctitle">ğŸ“£ MÃ´ táº£ sáº£n pháº©m</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" id="fbProd" placeholder="VD: MÃ¬ háº£o háº£o, NÆ°á»›c suá»‘i..."></div>
      <div class="field"><label>ğŸ’¡ Äiá»ƒm ná»•i báº­t</label><input class="inp" id="fbHl" placeholder="VD: GiÃ¡ ráº», chÃ­nh hÃ£ng, má»›i vá»..."></div>
      <div class="field"><label>ğŸ’µ GiÃ¡ bÃ¡n (tuá»³ chá»n)</label><input class="inp" id="fbPrice" placeholder="0Ä‘" oninput="handleM(this)" onkeydown="noKey(event)"></div>
    </div>
    <button class="btn btn-g" onclick="genFb()">ğŸ¤– AI viáº¿t bÃ i Facebook</button>
    <div class="card" id="fbCard" style="display:none">
      <div class="ctitle">âœï¸ BÃ i Ä‘Äƒng</div>
      <div id="fbLoader" style="display:none;text-align:center;padding:10px"><div class="spin" style="width:22px;height:22px;border:3px solid var(--g5);border-top:3px solid var(--g);border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 4px"></div><p style="font-size:.72rem;color:var(--g)">AI Ä‘ang viáº¿t...</p></div>
      <div id="fbRes" style="background:var(--g4);border:2px solid var(--g5);border-radius:8px;padding:10px;white-space:pre-wrap;font-size:.77rem;line-height:1.7;max-height:250px;overflow-y:auto;display:none;word-break:break-word"></div>
      <button id="fbCopy" style="display:none;margin-top:6px;padding:6px 12px;background:var(--g4);color:var(--g2);border:2px solid var(--g5);border-radius:8px;font-size:.72rem;font-weight:800;cursor:pointer" onclick="doCopy('fbRes','fbCopy')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
  <div id="ps-tt" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" id="ttProd" placeholder="VD: Háº¡t bÃ­ rang muá»‘i"></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-g" onclick="genTT()">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n</button>
    <div class="card" id="ttCard" style="display:none">
      <div class="ctitle">ğŸï¸ HÆ°á»›ng dáº«n quay</div>
      <div id="ttLoader" style="display:none;text-align:center;padding:10px"><div class="spin" style="width:22px;height:22px;border:3px solid var(--g5);border-top:3px solid var(--g);border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 4px"></div><p style="font-size:.72rem;color:var(--g)">AI Ä‘ang soáº¡n...</p></div>
      <div id="ttRes" style="background:var(--g4);border:2px solid var(--g5);border-radius:8px;padding:10px;white-space:pre-wrap;font-size:.77rem;line-height:1.7;max-height:250px;overflow-y:auto;display:none;word-break:break-word"></div>
      <button id="ttCopy" style="display:none;margin-top:6px;padding:6px 12px;background:var(--g4);color:var(--g2);border:2px solid var(--g5);border-radius:8px;font-size:.72rem;font-weight:800;cursor:pointer" onclick="doCopy('ttRes','ttCopy')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- REPORTS -->
<div id="pg-reports" class="pg">
<div class="wrap">
  <div class="tabs">
    <button class="tab on" onclick="rsub('chart',this)">ğŸ“Š Biá»ƒu Ä‘á»“</button>
    <button class="tab" onclick="rsub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="tab" onclick="rsub('tax',this)">ğŸ§¾ Thuáº¿</button>
  </div>
  <div id="rs-chart">
    <div class="ptabs">
      <button class="ptab on" onclick="setChPer('week',this)">7 ngÃ y</button>
      <button class="ptab" onclick="setChPer('month',this)">ThÃ¡ng</button>
      <button class="ptab" onclick="setChPer('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“Š BÃ¡o cÃ¡o</div>
      <div id="chartEmpty" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="ch2g">
          <div class="chcard"><h3>ğŸ¥§ Thu / Chi</h3><div class="chh"><canvas id="pieC"></canvas></div></div>
          <div class="chcard"><h3>ğŸ“¦ Top nháº­p hÃ ng</h3><div class="chbar"><canvas id="barC"></canvas></div></div>
        </div>
        <div class="chcard"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="chfull"><canvas id="lineC"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-w" onclick="doCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rs-compare" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ“ˆ So sÃ¡nh thÃ¡ng</div>
      <div class="g2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-g" onclick="doCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="cmpbox" id="cmpBox"></div>
    </div>
    <div class="card"><div class="ctitle">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£</div><div id="allTime"></div><button class="btn btn-w" style="margin-top:7px" onclick="buildAllTime()">ğŸ”„ Cáº­p nháº­t</button></div>
  </div>
  <div id="rs-tax" style="display:none">
    <div class="card"><div class="ctitle">ğŸ“Š Tiáº¿n trÃ¬nh doanh thu nÄƒm</div><div id="taxProg"></div></div>
    <div id="taxBox"></div>
    <div class="card csub" style="font-size:.71rem;line-height:1.8">
      <strong>ğŸ“Œ Luáº­t thuáº¿ 2026:</strong><br>
      â€¢ DT â‰¤ 500 triá»‡u/nÄƒm â†’ Miá»…n thuáº¿ TNCN & GTGT<br>
      â€¢ DT &gt; 500tr â†’ GTGT 1% (bÃ¡n láº») / 3% (Äƒn uá»‘ng) + TNCN = (DT-500tr)Ã—0.5%<br>
      â€¢ Tá» khai: Máº«u 01/CNKD â€” <strong>Ã” [21]</strong> = Tá»•ng doanh thu<br>
      â€¢ <a href="https://canhan.gdt.gov.vn" target="_blank" style="color:var(--g);font-weight:800">ğŸŒ canhan.gdt.gov.vn</a>
    </div>
    <button class="btn btn-w" onclick="doTax()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
</div>
</div>

<!-- AI -->
<div id="pg-ai" class="pg">
  <div class="aitop">
    <div class="aiav">ğŸ¤–</div>
    <div class="aitxt"><strong>Trá»£ lÃ½ Há»™ Má»‡nh AI</strong><br><span id="aiSt">Äang táº£i...</span></div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0">
      <div style="display:flex;align-items:center;gap:4px"><div class="aidot"></div><span style="font-size:.57rem;color:#6ABF8A" id="aiStatus">Sáºµn sÃ ng</span></div>
      <span class="hodmenh">ğŸ›¡ï¸ Há»™ má»‡nh ON</span>
    </div>
  </div>
  <div class="msgs" id="msgs">
    <div class="msg bot">ğŸ‘‹ Xin chÃ o! MÃ¬nh lÃ  Trá»£ lÃ½ <strong>Há»™ Má»‡nh</strong> ğŸ’š<br>â€¢ Ghi <strong>bÃ¡n / nháº­p</strong> hÃ ng ngay qua chat<br>â€¢ Tra <strong>tá»“n kho</strong> vÃ  sá»‘ liá»‡u kinh doanh<br>â€¢ TÆ° váº¥n <strong>thuáº¿ 2026</strong> chuáº©n xÃ¡c<br>â€¢ HÆ°á»›ng dáº«n <strong>ná»™p thuáº¿ Ä‘iá»‡n tá»­</strong> tá»«ng bÆ°á»›c</div>
    <div class="typing" id="typing"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  </div>
  <div class="chips">
    <button class="chip" onclick="useChip(this)">ğŸ“¦ Kho cÃ²n gÃ¬?</button>
    <button class="chip" onclick="useChip(this)">ğŸ’° ThÃ¡ng nÃ y lÃ£i bao nhiÃªu?</button>
    <button class="chip" onclick="useChip(this)">ğŸ›’ BÃ¡n 5 gÃ³i mÃ¬ 15k</button>
    <button class="chip" onclick="useChip(this)">ğŸ“¥ Nháº­p 2 thÃ¹ng bia 300k</button>
    <button class="chip" onclick="useChip(this)">âš ï¸ HÃ ng sáº¯p háº¿t?</button>
    <button class="chip" onclick="useChip(this)">ğŸ§¾ TÃ´i cÃ³ pháº£i ná»™p thuáº¿ khÃ´ng?</button>
    <button class="chip" onclick="useChip(this)">ğŸ“‹ HÆ°á»›ng dáº«n ná»™p thuáº¿ Ä‘iá»‡n tá»­</button>
  </div>
  <div class="chatfoot">
    <textarea class="chatinp" id="chatInp" placeholder="Nháº¯n: BÃ¡n 5 gÃ³i mÃ¬... hoáº·c há»i vá» kinh doanh/thuáº¿..." rows="1"
      oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
    <button class="sndbtn" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- HISTORY -->
<div id="pg-history" class="pg">
<div class="wrap">
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ Tá»•ng thu</div><div class="sv" id="hall-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ Tá»•ng chi</div><div class="sv" id="hall-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sl">ğŸ’¼ LÃ£i/Lá»—</div><div class="sv" id="hall-lai">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="ctitle">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­</div>
    <div class="filters">
      <input type="text" id="hSearch" placeholder="ğŸ” TÃ¬m tÃªn..." oninput="renderHist()">
      <input type="date" id="hFrom" onchange="renderHist()">
      <input type="date" id="hTo" onchange="renderHist()">
    </div>
    <div class="filters">
      <select id="hType" onchange="renderHist()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="ban">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="nhap">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="chiphi">âš¡ Chi phÃ­</option>
        <option value="adj">âš™ï¸ Äiá»u chá»‰nh kho</option>
      </select>
      <select id="hMon" onchange="renderHist()"><option value="">Táº¥t cáº£ thÃ¡ng</option></select>
      <button class="btn btn-w btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTable"></div>
  </div>
</div>
</div>

</div><!-- end main -->

<div id="nav">
  <button class="nb on" onclick="goPage('home',this)"><span class="ic">ğŸ </span>Tá»•ng quan</button>
  <button class="nb" onclick="goPage('money',this)"><span class="ic">ğŸ’°</span>Thu/Chi</button>
  <button class="nb" onclick="goPage('promo',this)"><span class="ic">ğŸ“£</span>Quáº£ng bÃ¡</button>
  <button class="nb" onclick="goPage('reports',this)"><span class="ic">ğŸ“Š</span>BÃ¡o cÃ¡o</button>
  <button class="nb" onclick="goPage('ai',this)"><span class="ic">ğŸ¤–</span>AI</button>
  <button class="nb" onclick="goPage('history',this)"><span class="ic">ğŸ“š</span>Lá»‹ch sá»­</button>
</div>

<!-- OVERLAYS -->
<div class="ov" id="ovConfirm">
  <div class="modal">
    <h3 id="ovTitle">XÃ¡c nháº­n</h3>
    <p id="ovMsg" style="font-size:.79rem;color:var(--muted);line-height:1.5"></p>
    <div class="mbtns"><button class="mbtnc" onclick="closeOv('ovConfirm')">Huá»·</button><button class="mbtnok" id="ovOkBtn">XÃ¡c nháº­n</button></div>
  </div>
</div>
<div class="ov" id="ovStock">
  <div class="modal" style="border:3px solid var(--r)">
    <h3 style="color:var(--r)">âš ï¸ Tá»“n kho khÃ´ng Ä‘á»§!</h3>
    <div style="font-size:.93rem;font-weight:700;color:var(--r);line-height:1.5;padding:8px 0;text-align:center" id="ovStockMsg"></div>
    <div class="mbtns"><button class="mbtnc" onclick="closeOv('ovStock')">Huá»· bá»</button><button class="mbtna" onclick="forceStock()">Váº«n ghi nháº­n</button></div>
  </div>
</div>
<div class="ov" id="ovAdj">
  <div class="modal">
    <h3>âš™ï¸ Äiá»u chá»‰nh tá»“n kho / Hao há»¥t</h3>
    <div class="adjwarn">âš ï¸ Chá»‰ <strong>trá»« tá»“n kho</strong>, <strong>KHÃ”NG táº¡o khoáº£n chi</strong></div>
    <div class="field"><label>ğŸ“¦ Chá»n sáº£n pháº©m</label><select class="inp" id="adjProd"></select></div>
    <div class="g2">
      <div class="field"><label>ğŸ”¢ Sá»‘ lÆ°á»£ng giáº£m</label><input class="inp" id="adjQty" placeholder="0" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="adjDate"></div>
    </div>
    <div class="field"><label>ğŸ“‹ LÃ½ do</label>
      <select class="inp" id="adjReason">
        <option value="huhong">ğŸ”´ HÆ° há»ng</option>
        <option value="hethan">â° Háº¿t háº¡n</option>
        <option value="thathoat">ğŸ•µï¸ Tháº¥t thoÃ¡t</option>
        <option value="kiemke">ğŸ“‹ Kiá»ƒm kÃª sai</option>
        <option value="khac">ğŸ“Œ KhÃ¡c</option>
      </select>
    </div>
    <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" id="adjNote" placeholder="Tuá»³ chá»n..."></div>
    <div class="mbtns"><button class="mbtnc" onclick="closeOv('ovAdj')">Huá»·</button><button class="mbtna" onclick="confirmAdj()">âš™ï¸ XÃ¡c nháº­n</button></div>
  </div>
</div>
<div id="toast"></div>
</div>

<script>
'use strict';
const TAX_TH=500_000_000,LOW=5;
// KhÃ´ng cáº§n API key â€” AI cháº¡y hoÃ n toÃ n offline

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mGet(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{return null}}
function mSet(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){console.warn(e)}}
function mKeys(){try{return Object.keys(localStorage)}catch{return[]}}

let CUR=new Date().toISOString().slice(0,7);
function emptyFin(){return{sales:[],imports:[],costs:[],adjs:[]}}
function loadFin(mk){const d=mGet('fin-'+mk);return d?{sales:d.sales||[],imports:d.imports||[],costs:d.costs||[],adjs:d.adjs||[]}:emptyFin()}
function saveFin(mk,d){mSet('fin-'+mk,d)}
let FIN=loadFin(CUR);
function persist(){saveFin(CUR,FIN)}
function loadProds(){return mGet('prods')||[]}
function saveProds(a){mSet('prods',a)}
function upsertProd(p){const a=loadProds(),i=a.findIndex(x=>x.name===p.name&&(x.unitOut||'')===(p.unitOut||''));if(i>=0)Object.assign(a[i],p);else a.push(p);saveProds(a)}
function loadCooks(){return mGet('cooks')||[]}
function saveCooks(a){mSet('cooks',a)}
function allMKs(){const s=new Set([CUR]);mKeys().filter(k=>/^fin-\d{4}-\d{2}$/.test(k)).forEach(k=>s.add(k.replace('fin-','')));return[...s].sort()}

// â”€â”€ Inventory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function invKey(n,u){return n+':::'+(u||'')}
function computeInv(){
  const map={};
  allMKs().forEach(mk=>{
    const f=loadFin(mk);
    f.imports.forEach(imp=>{
      if(imp.kind!=='hangban')return;
      const uO=imp.unitOut||imp.unitIn||'',k=invKey(imp.name,uO);
      if(!map[k])map[k]={name:imp.name,unitIn:imp.unitIn||'',unitOut:uO,factor:imp.factor||1,stock:0,totalIn:0,totalSold:0,lastP:0,lastD:'',key:k};
      const add=imp.stockAdded||(imp.qtyIn*(imp.factor||1));
      map[k].stock+=add;map[k].totalIn+=add;
      if(imp.totalAmt>0&&add>0)map[k].lastP=Math.round(imp.totalAmt/add);
      if(!map[k].lastD||imp.date>map[k].lastD)map[k].lastD=imp.date;
      map[k].unitIn=imp.unitIn||map[k].unitIn;map[k].factor=imp.factor||map[k].factor;
    });
    f.sales.forEach(s=>{if(s.type!=='hangban')return;const k=invKey(s.name,s.unitOut||'');if(map[k]){map[k].stock=Math.max(0,map[k].stock-s.qty);map[k].totalSold+=s.qty}});
    (f.adjs||[]).forEach(a=>{const k=invKey(a.name,a.unitOut||'');if(map[k])map[k].stock=Math.max(0,map[k].stock-a.qty)});
  });
  return Object.values(map);
}
function getStock(name,unitOut){const inv=computeInv(),k=invKey(name,unitOut||'');const it=inv.find(x=>x.key===k);if(!it){const any=inv.find(x=>x.name===name);return any?{stock:any.stock,unitOut:any.unitOut}:{stock:0,unitOut:unitOut||''}}return{stock:it.stock,unitOut:it.unitOut}}

// â”€â”€ Aggregates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRev(mk){return loadFin(mk).sales.reduce((s,x)=>s+x.totalAmt,0)}
function getCost(mk){const f=loadFin(mk);return f.imports.reduce((s,x)=>s+x.totalAmt,0)+f.costs.reduce((s,x)=>s+x.amount,0)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function getThu(){const t=todayISO();return FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.totalAmt,0)}
function getChi(){const t=todayISO();return FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.totalAmt,0)+FIN.costs.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.amount,0)}
function yearRevenue(){const yr=new Date().getFullYear();return allMKs().filter(k=>k.startsWith(yr+'')).reduce((s,k)=>s+getRev(k),0)}

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt=n=>!n?'0Ä‘':n.toLocaleString('vi-VN')+'Ä‘';
function axFmt(v){if(!v)return'0';const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(1).replace('.0','')+'tá»·';if(a>=1e6)return(v/1e6).toFixed(1).replace('.0','')+'M';if(a>=1e3)return Math.round(v/1e3)+'K';return String(Math.round(v))}
const fmtDt=d=>{if(!d)return'';const s=d.includes('T')?d:d+'T00:00';const dt=new Date(s);if(isNaN(dt))return d.slice(0,10);const dd=String(dt.getDate()).padStart(2,'0'),mm=String(dt.getMonth()+1).padStart(2,'0'),hh=String(dt.getHours()).padStart(2,'0'),mn=String(dt.getMinutes()).padStart(2,'0');return dt.getHours()===0&&dt.getMinutes()===0?`${dd}/${mm}`:`${dd}/${mm} ${hh}:${mn}`};
function nowDT(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function mLabel(k){const[y,m]=k.split('-');return`ThÃ¡ng ${parseInt(m)}/${y}`}

// â”€â”€ Date fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshDates(){const now=nowDT();['sDate','iDate','cpDate','adjDate'].forEach(id=>{const el=document.getElementById(id);if(el&&!el._locked)el.value=now})}
setInterval(refreshDates,60000);

// â”€â”€ Form helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleM(el){const r=(el.value||'').replace(/\D/g,'');el.dataset.raw=r;el.value=r?parseInt(r).toLocaleString('vi-VN'):''}
function noKey(e){if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault()}
function getRaw(id){const el=document.getElementById(id);return el?parseInt((el.dataset.raw||'0').replace(/\D/g,'')||'0')||0:0}
function gv(id){const el=document.getElementById(id);return el?(el.value||'').trim():''}
function sv(id,v){const el=document.getElementById(id);if(el)el.value=v}
function setM(id,n){const el=document.getElementById(id);if(!el)return;el.dataset.raw=String(n);el.value=n?n.toLocaleString('vi-VN'):''}
function clrM(id){const el=document.getElementById(id);if(el){el.value='';el.dataset.raw=''}}

// â”€â”€ Month â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMonthOpts(){const s=new Set();for(let i=0;i<6;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);s.add(d.toISOString().slice(0,7))}allMKs().forEach(k=>s.add(k));return[...s].sort().reverse()}
function buildMonthSel(){
  const now=new Date().toISOString().slice(0,7),opts=getMonthOpts();
  const sel=document.getElementById('monthSel');if(sel)sel.innerHTML=opts.map(k=>`<option value="${k}"${k===CUR?' selected':''}>${mLabel(k)}${k===now?' â­':''}</option>`).join('');
  const mb=document.getElementById('monthBadge');if(mb)mb.textContent=CUR===now?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':mLabel(CUR);
  ['cmpA','cmpB'].forEach((id,i)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=opts.map(k=>`<option value="${k}">${mLabel(k)}</option>`).join('');if(i===1&&opts.length>1)el.value=opts[1]});
}
function switchMonth(k){CUR=k;FIN=loadFin(k);buildMonthSel();renderAll();if(document.getElementById('pg-history').classList.contains('on'))renderHist()}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goPage(name,btn){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');
  if(btn)btn.classList.add('on');
  refreshDates();
  if(name==='home'){renderAll();renderToday();renderHomeRecent();setTimeout(doHomeChart,80)}
  if(name==='reports')setTimeout(doCharts,80);
  if(name==='history')renderHist();
  if(name==='ai'){doAiSt();setTimeout(scrollMsgs,80)}
}
const MSUBS=['ban','nhap','chiphi','kho','chebien'];
function msub(name,btn){
  MSUBS.forEach(n=>{const el=document.getElementById('ms-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#pg-money .tab').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');refreshDates();
  if(name==='kho'){renderInv();renderAdjHist()}
  if(name==='chebien')renderCooks();
  if(name==='chiphi')renderCpTable();
}
function psub(name,btn){['fb','tt'].forEach(n=>{const el=document.getElementById('ps-'+n);if(el)el.style.display=n===name?'block':'none'});document.querySelectorAll('#pg-promo .tab').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on')}
function rsub(name,btn){['chart','compare','tax'].forEach(n=>{const el=document.getElementById('rs-'+n);if(el)el.style.display=n===name?'block':'none'});document.querySelectorAll('#pg-reports .tab').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');if(name==='chart')setTimeout(doCharts,80);if(name==='compare')buildAllTime();if(name==='tax')doTax()}

// â”€â”€ Toast & overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tt=null;
function toast(msg,err=false,ok=false){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className=err?'on err':ok?'on ok':'on';clearTimeout(_tt);_tt=setTimeout(()=>t.className='',3500)}
let _pendSale=null;
function showCfm(title,msg,fn){sv('ovTitle',title);document.getElementById('ovMsg').textContent=msg;document.getElementById('ovOkBtn').onclick=()=>{closeOv('ovConfirm');fn()};document.getElementById('ovConfirm').classList.add('on')}
function closeOv(id){document.getElementById(id).classList.remove('on')}
function showStockAlert(msg,fn){document.getElementById('ovStockMsg').innerHTML=msg;document.getElementById('ovStock').classList.add('on');_pendSale=fn}
function forceStock(){closeOv('ovStock');if(_pendSale)_pendSale();_pendSale=null}

// â”€â”€ Suggestions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _curType='hangban',_sellName='',_sellUnitOut='';
function onSellSug(val){
  const drop=document.getElementById('sDrop'),q=(val||'').toLowerCase();
  const inv=computeInv(),cooks=loadCooks();
  const hb=inv.filter(x=>!q||x.name.toLowerCase().includes(q));
  const cb=cooks.filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';
  if(!hb.length&&!cb.length){drop.classList.remove('on');return}
  if(hb.length){drop.appendChild(Object.assign(document.createElement('div'),{className:'suggrp',textContent:'ğŸ—„ï¸ HÃ ng trong kho'}));hb.slice(0,10).forEach(p=>{const d=document.createElement('div');d.className='sugopt';const dn=p.unitOut?`${p.name} (${p.unitOut})`:p.name;d.innerHTML=`<div>${dn}</div><div class="sm">Tá»“n: <strong>${p.stock} ${p.unitOut||''}</strong>${p.lastP?' Â· Nháº­p: '+fmt(p.lastP):''}</div>`;d.onmousedown=()=>{selSell(p.name,'hangban',p);drop.classList.remove('on')};drop.appendChild(d)})}
  if(cb.length){drop.appendChild(Object.assign(document.createElement('div'),{className:'suggrp',textContent:'ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n'}));cb.slice(0,8).forEach(c=>{const d=document.createElement('div');d.className='sugopt';d.innerHTML=`<div>${c.name}</div><div class="sm">Cháº¿ biáº¿n Â· ${c.price?fmt(c.price):'ChÆ°a Ä‘áº·t giÃ¡'}</div>`;d.onmousedown=()=>{selSell(c.name,'chebien',c);drop.classList.remove('on')};drop.appendChild(d)})}
  drop.classList.add('on');
}
function selSell(name,type,data){
  _sellName=name;_curType=type;_sellUnitOut=data.unitOut||'';
  const disp=data.unitOut?`${name} (${data.unitOut})`:name;sv('sName',disp);
  const b=document.getElementById('sInfo');if(!b)return;b.style.display='block';
  if(type==='hangban'){b.textContent=`ğŸ“¦ ${disp} â€” Tá»“n: ${data.stock} ${data.unitOut||''}${data.lastP?' Â· Nháº­p: '+fmt(data.lastP):''}`;if(data.lastP)setM('sPrice',data.lastP)}
  else{b.textContent=`ğŸ‘¨â€ğŸ³ ${name} â€” Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho`;if(data.price)setM('sPrice',data.price)}
}
function closeSellSug(){document.getElementById('sDrop').classList.remove('on')}
function clrSInfo(){const b=document.getElementById('sInfo');if(b)b.style.display='none';_curType='hangban';_sellName='';_sellUnitOut=''}
function calcTotal(){const b=document.getElementById('sTotal');if(!b)return;const q=getRaw('sQty'),p=getRaw('sPrice');if(q&&p){b.style.display='block';b.textContent=`ğŸ’° ThÃ nh tiá»n: ${fmt(q*p)}`}else b.style.display='none'}

function onImpSug(val){
  const drop=document.getElementById('iDrop'),q=(val||'').toLowerCase();
  const prods=loadProds().filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';if(!prods.length){drop.classList.remove('on');return}
  const seen=new Set();
  prods.slice(0,10).forEach(p=>{const lbl=p.unitOut?`${p.name} (${p.unitOut})`:p.name;if(seen.has(lbl))return;seen.add(lbl);const d=document.createElement('div');d.className='sugopt';d.innerHTML=`<div>${lbl}</div><div class="sm">${p.kind==='hangban'?'ğŸ›’ BÃ¡n láº¡i':'ğŸ§‚ NguyÃªn liá»‡u'}${p.unitIn?' Â· '+p.unitIn+(p.unitOut&&p.unitOut!==p.unitIn?'â†’'+p.unitOut:''):''}</div>`;d.onmousedown=()=>{sv('iName',p.name);drop.classList.remove('on');sv('iType',p.kind||'hangban');sv('iUIn',p.unitIn||'');sv('iUOut',p.unitOut||'');const fe=document.getElementById('iFac');if(fe){fe.value=p.factor||1;fe.dataset.raw=String(p.factor||1)}togImpMode();showConv()};drop.appendChild(d)});
  drop.classList.add('on');
}
function closeImpSug(){document.getElementById('iDrop').classList.remove('on')}
function togImpMode(){const t=gv('iType'),w=document.getElementById('iConvWrap');if(w)w.style.display=t==='nguyenlieu'?'none':'block'}
function showConv(){const b=document.getElementById('convPreview');if(!b)return;const q=getRaw('iQty'),f=getRaw('iFac')||1,uI=gv('iUIn')||'Ä‘v nháº­p',uO=gv('iUOut')||'Ä‘v bÃ¡n';if(q&&f){b.innerHTML=`ğŸ“¦ <strong>${q} ${uI}</strong> Ã— <strong>${f}</strong> = <strong>${q*f} ${uO}</strong> vÃ o kho`;b.classList.add('on')}else b.classList.remove('on')}

// â”€â”€ Periods â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let perBan='all',perNhap='all',perChart='week';
function setPer(tab,p,btn){if(tab==='ban')perBan=p;else perNhap=p;document.querySelectorAll(`#ms-${tab==='ban'?'ban':'nhap'} .ptab`).forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');if(tab==='ban')renderBanTable();else renderNhapTable()}
function setChPer(p,btn){perChart=p;document.querySelectorAll('#rs-chart .ptab').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');doCharts()}
function filterPer(arr,per){if(per==='all')return arr;const now=new Date(),tod=todayISO();return arr.filter(x=>{const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(per==='today')return d===tod;if(per==='week'){const dt=new Date(d+'T00:00'),w=new Date(now);w.setDate(now.getDate()-6);return dt>=w}if(per==='month')return d.slice(0,7)===CUR;return true})}

// â”€â”€ Bulk select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selAll(tab,checked){document.querySelectorAll(`.cb-${tab}`).forEach(cb=>cb.checked=checked);updBulk(tab)}
function updBulk(tab){const c=document.querySelectorAll(`.cb-${tab}:checked`).length,b=document.getElementById(tab+'Bulk');if(b)b.style.display=c?'inline-flex':'none'}
function bulkDel(tab){const ids=[];document.querySelectorAll(`.cb-${tab}:checked`).forEach(cb=>ids.push(+cb.value));if(!ids.length){toast('âš ï¸ ChÆ°a chá»n!',true);return}showCfm(`XoÃ¡ ${ids.length} dÃ²ng`,'KhÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{const s=new Set(ids);if(tab==='ban')FIN.sales=FIN.sales.filter(x=>!s.has(x.id));else FIN.imports=FIN.imports.filter(x=>!s.has(x.id));persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}
function cfmDelAll(tab){showCfm('XoÃ¡ táº¥t cáº£',`XoÃ¡ TOÃ€N Bá»˜ ${tab==='ban'?'bÃ¡n hÃ ng':'nháº­p hÃ ng'} thÃ¡ng ${mLabel(CUR)}?`,()=>{if(tab==='ban')FIN.sales=[];else FIN.imports=[];persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(){renderSummary();renderBanTable();renderNhapTable()}
function renderToday(){
  const thu=getThu(),chi=getChi(),lai=thu-chi;
  const d=new Date(),lbl=`ğŸ“… ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const el=document.getElementById('todayLabel');if(el)el.textContent=lbl;
  [['h-tthu',fmt(thu)],['h-tchi',fmt(chi)],['h-tlai',(lai>=0?'+':'')+fmt(lai)],['m-tthu',fmt(thu)],['m-tchi',fmt(chi)],['m-tlai',(lai>=0?'+':'')+fmt(lai)]].forEach(([id,v])=>{const e=document.getElementById(id);if(e)e.textContent=v});
}
function renderSummary(){
  const thu=getRev(CUR),chi=getCost(CUR),lai=thu-chi;
  [['h-thu',fmt(thu)],['h-chi',fmt(chi)],['h-lai',(lai>=0?'+':'')+fmt(lai),'color:'+(lai>=0?'var(--g)':'var(--r)')],['m-thu',fmt(thu)],['m-chi',fmt(chi)],['m-lai',(lai>=0?'+':'')+fmt(lai),'color:'+(lai>=0?'var(--g)':'var(--r)')]].forEach(([id,v,s])=>{const e=document.getElementById(id);if(!e)return;e.textContent=v;if(s)e.style.cssText=s});
}
function renderBanTable(){
  const w=document.getElementById('banTable');if(!w)return;
  const rows=filterPer(FIN.sales,perBan).sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ giao dá»‹ch bÃ¡n</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th></th><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>SL</th><th>Doanh thu</th><th></th></tr></thead><tbody>${rows.map(t=>`<tr><td class="cbcell"><input type="checkbox" class="cb-ban" value="${t.id}" onchange="updBulk('ban')"></td><td>${fmtDt(t.date)}</td><td><span class="tag ${t.type==='chebien'?'t-cook':'t-sell'}">${t.name}${t.unitOut?' ('+t.unitOut+')':''}</span></td><td>${t.qty}${t.unitOut?' '+t.unitOut:''}</td><td class="tv">+${fmt(t.totalAmt)}</td><td><button class="delbtn" onclick="delSale(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderNhapTable(){
  const w=document.getElementById('nhapTable');if(!w)return;
  const rows=filterPer(FIN.imports,perNhap).sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>ChÆ°a cÃ³ khoáº£n nháº­p</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th></th><th>NgÃ y</th><th>HÃ ng hÃ³a</th><th>SL</th><th>Chi</th><th></th></tr></thead><tbody>${rows.map(t=>`<tr><td class="cbcell"><input type="checkbox" class="cb-nhap" value="${t.id}" onchange="updBulk('nhap')"></td><td>${fmtDt(t.date)}</td><td><span class="tag ${t.kind==='nguyenlieu'?'t-mat':'t-imp'}">${t.name}</span></td><td>${t.qtyIn} ${t.unitIn||''}${t.kind==='hangban'&&t.unitOut&&t.unitOut!==t.unitIn?' â†’ '+t.stockAdded+' '+t.unitOut:''}</td><td class="rv">-${fmt(t.totalAmt)}</td><td><button class="delbtn" onclick="delImp(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderCpTable(){
  const w=document.getElementById('cpTable');if(!w)return;
  const rows=[...FIN.costs].sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">âš¡</div>ChÆ°a cÃ³ chi phÃ­</div>';return}
  const tm={utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',rental:'ğŸª Máº·t báº±ng',labor:'ğŸ‘· NhÃ¢n cÃ´ng',other:'ğŸ“Œ KhÃ¡c'};
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>MÃ´ táº£</th><th>Tiá»n</th><th></th></tr></thead><tbody>${rows.map(c=>`<tr><td>${fmtDt(c.date)}</td><td>${tm[c.type]||c.type}</td><td>${c.desc}</td><td class="rv">-${fmt(c.amount)}</td><td><button class="delbtn" onclick="delCp(${c.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderHomeRecent(){
  const w=document.getElementById('homeRecent');if(!w)return;
  const all=[...FIN.sales.map(x=>({...x,tt:'ban'})),...FIN.imports.map(x=>({...x,tt:'nhap'}))].sort((a,b)=>b.id-a.id).slice(0,8);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn</th><th>Tiá»n</th></tr></thead><tbody>${all.map(x=>`<tr><td>${fmtDt(x.date)}</td><td>${x.tt==='ban'?'<span class="tag t-sell">ğŸ’° BÃ¡n</span>':'<span class="tag t-imp">ğŸ“¦ Nháº­p</span>'}</td><td>${(x.name||'')+(x.unitOut&&x.tt==='ban'?' ('+x.unitOut+')':'')}</td><td class="${x.tt==='ban'?'tv':'rv'}">${x.tt==='ban'?'+':'-'}${fmt(x.totalAmt)}</td></tr>`).join('')}</tbody></table></div>`;
}

// â”€â”€ Inventory render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderInv(){
  const el=document.getElementById('invView');if(!el)return;
  const q=(gv('invSearch')||'').toLowerCase(),stf=gv('invStatus')||'';
  let inv=computeInv();if(q)inv=inv.filter(x=>x.name.toLowerCase().includes(q));
  if(!inv.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>KhÃ´ng tÃ¬m tháº¥y</div>';return}
  const now=new Date();
  const outI=inv.filter(x=>x.stock===0),lowI=inv.filter(x=>x.stock>0&&x.stock<LOW),okI=inv.filter(x=>x.stock>=LOW);
  const slowI=okI.filter(x=>{if(!x.lastD)return false;return Math.floor((now-new Date(x.lastD+'T00:00'))/86400000)>=30&&x.totalSold===0});
  const show=st=>!stf||stf===st;
  let html='';
  const urg=[...outI.map(x=>`<strong>${x.name}${x.unitOut?' ('+x.unitOut+')':''}</strong>(háº¿t)`),...lowI.map(x=>`<strong>${x.name}${x.unitOut?' ('+x.unitOut+')':''}</strong>(${x.stock})`)];
  if(urg.length&&!stf)html+=`<div class="invnotice">ğŸ”” Cáº§n nháº­p thÃªm: ${urg.join(' Â· ')}</div>`;
  if(show('out')&&outI.length){html+=`<div class="invsec"><div class="invstitle">ğŸ”´ ÄÃ£ háº¿t (${outI.length})</div>`;outI.forEach(x=>{html+=icrd(x,'out')});html+='</div>'}
  if(show('low')&&lowI.length){html+=`<div class="invsec"><div class="invstitle">ğŸŸ¡ Sáº¯p háº¿t (${lowI.length})</div>`;lowI.forEach(x=>{html+=icrd(x,'low')});html+='</div>'}
  if(show('slow')&&slowI.length){html+=`<div class="invsec"><div class="invstitle">ğŸ”µ BÃ¡n cháº­m (${slowI.length})</div>`;slowI.forEach(x=>{const days=Math.floor((now-new Date(x.lastD+'T00:00'))/86400000);html+=icrd(x,'slow',days)});html+='</div>'}
  const okF=okI.filter(x=>!slowI.find(s=>s.key===x.key));
  if(show('ok')&&okF.length){html+=`<div class="invsec"><div class="invstitle">ğŸŸ¢ Äá»§ hÃ ng (${okF.length})</div>`;okF.forEach(x=>{html+=icrd(x,'ok')});html+='</div>'}
  el.innerHTML=html||'<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng</div>';
}
function icrd(x,st,days){
  const ico={out:'ğŸ”´',low:'ğŸŸ¡',ok:'ğŸŸ¢',slow:'ğŸ”µ'},cs={out:'ic-out',low:'ic-low',ok:'ic-ok',slow:'ic-slow'},qs={out:'q-out',low:'q-low',ok:'q-ok'};
  const dn=x.unitOut?`${x.name} <span style="font-size:.68rem;color:var(--muted)">(${x.unitOut})</span>`:x.name;
  const meta=st==='slow'?`Nháº­p ${days} ngÃ y trÆ°á»›c Â· Tá»“n: ${x.stock} ${x.unitOut}`:(x.unitIn&&x.unitOut&&x.unitIn!==x.unitOut?`${x.unitIn}â†’${x.unitOut} (Ã—${x.factor})`:`ÄV: ${x.unitOut||x.unitIn||'â€”'}`);
  const ql=st==='out'?'Háº¿t hÃ ng':st==='slow'?`Tá»“n: ${x.stock}`:st==='low'?`âš ï¸ ${x.stock} ${x.unitOut}`:`âœ… ${x.stock} ${x.unitOut}`;
  return`<div class="invcard ${cs[st]}"><div style="font-size:1.1rem;flex-shrink:0">${ico[st]}</div><div class="invbody"><div class="invname">${dn}</div><div class="invmeta">${meta}</div></div><span class="invqty ${qs[st]||'q-ok'}">${ql}</span></div>`;
}

// â”€â”€ Adjustment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdj(){
  const inv=computeInv().filter(x=>x.stock>0);const sel=document.getElementById('adjProd');if(!sel)return;
  if(!inv.length){toast('âš ï¸ Kho trá»‘ng!',true);return}
  sel.innerHTML=inv.map(x=>`<option value="${x.key}">${x.name}${x.unitOut?' ('+x.unitOut+')':''} â€” Tá»“n: ${x.stock} ${x.unitOut}</option>`).join('');
  sv('adjDate',nowDT());clrM('adjQty');sv('adjNote','');document.getElementById('ovAdj').classList.add('on');
}
function confirmAdj(){
  const key=gv('adjProd'),qty=getRaw('adjQty'),reason=gv('adjReason'),note=gv('adjNote'),date=gv('adjDate');
  if(!key){toast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}if(!qty){toast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  const[name,unitOut]=(key+':::').split(':::');const{stock}=getStock(name,unitOut);
  if(stock<qty){toast(`âš ï¸ Kho chá»‰ cÃ²n ${stock}!`,true);return}
  const rmap={huhong:'HÆ° há»ng',hethan:'Háº¿t háº¡n',thathoat:'Tháº¥t thoÃ¡t',kiemke:'Kiá»ƒm kÃª sai',khac:'KhÃ¡c'};
  FIN.adjs.push({id:Date.now(),name,unitOut,qty,reason,reasonLabel:rmap[reason]||reason,note,date});
  persist();renderInv();renderAdjHist();closeOv('ovAdj');toast(`âœ… Giáº£m ${qty} ${unitOut} ${name}`,false,true);
}
function renderAdjHist(){
  const w=document.getElementById('adjHist');if(!w)return;
  const all=[];allMKs().forEach(mk=>{const f=loadFin(mk);(f.adjs||[]).forEach(a=>all.push({...a,mk}))});
  all.sort((a,b)=>b.id-a.id);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">âš™ï¸</div>ChÆ°a cÃ³ Ä‘iá»u chá»‰nh</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>Giáº£m</th><th>LÃ½ do</th></tr></thead><tbody>${all.map(a=>`<tr><td>${fmtDt(a.date)}</td><td>${a.name}${a.unitOut?' ('+a.unitOut+')':''}</td><td class="rv">-${a.qty}</td><td>${a.reasonLabel||a.reason}${a.note?' â€” '+a.note:''}</td></tr>`).join('')}</tbody></table></div>`;
}

// â”€â”€ Cook products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addCook(){const name=gv('cbName'),price=getRaw('cbPrice');if(!name){toast('âš ï¸ Nháº­p tÃªn!',true);return}const a=loadCooks();if(a.find(x=>x.name===name)){toast('âš ï¸ ÄÃ£ tá»“n táº¡i!',true);return}a.push({id:Date.now(),name,price});saveCooks(a);renderCooks();sv('cbName','');clrM('cbPrice');toast('âœ… ÄÃ£ thÃªm!')}
function delCook(id){showCfm('XoÃ¡ sáº£n pháº©m','XoÃ¡ sáº£n pháº©m nÃ y?',()=>{saveCooks(loadCooks().filter(x=>x.id!==id));renderCooks();toast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCooks(){const el=document.getElementById('cookList');if(!el)return;const a=loadCooks();if(!a.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ‘¨â€ğŸ³</div>ChÆ°a cÃ³ sáº£n pháº©m cháº¿ biáº¿n</div>';return}el.innerHTML=a.map(c=>`<div class="cookitem"><div class="cookbody"><div class="cookname">${c.name}</div><div class="cookmeta">Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho</div></div><div class="cookprice">${c.price?fmt(c.price):'â€”'}</div><button class="cookdel" onclick="delCook(${c.id})">ğŸ—‘ï¸</button></div>`).join('')}

// â”€â”€ Sales & imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSale(){
  const inputVal=gv('sName'),name=_sellName||inputVal.replace(/\s*\([^)]*\)$/,'').trim();
  const qty=getRaw('sQty'),price=getRaw('sPrice'),date=gv('sDate'),desc=gv('sDesc');
  if(!name){toast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}if(!qty){toast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}if(!price){toast('âš ï¸ Nháº­p Ä‘Æ¡n giÃ¡!',true);return}if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}
  const type=_curType||'hangban';
  if(type==='hangban'){const{stock,unitOut}=getStock(name,_sellUnitOut);if(stock<qty){showStockAlert(`<strong>${name}${_sellUnitOut?' ('+_sellUnitOut+')':''}</strong><br>Kho: <strong>${stock} ${unitOut}</strong><br>BÃ¡n: <strong>${qty} ${unitOut}</strong>`,()=>doSave(name,type,qty,price,date,desc));return}}
  doSave(name,type,qty,price,date,desc);
}
function doSave(name,type,qty,price,date,desc){
  const unitOut=_sellUnitOut||'';
  FIN.sales.push({id:Date.now(),name,type,qty,unitPrice:price,totalAmt:qty*price,date,desc:desc||'BÃ¡n '+name,unitOut});
  persist();renderAll();renderToday();
  sv('sName','');clrM('sQty');clrM('sPrice');sv('sDesc','');
  document.getElementById('sTotal').style.display='none';clrSInfo();
  toast(`âœ… BÃ¡n ${qty}${unitOut?' '+unitOut:''} ${name}!`,false,true);
}
function delSale(id){showCfm('XoÃ¡ giao dá»‹ch','XoÃ¡ giao dá»‹ch bÃ¡n nÃ y?',()=>{FIN.sales=FIN.sales.filter(x=>x.id!==id);persist();renderAll();renderToday();toast('âœ… ÄÃ£ xoÃ¡!')})}
function addImport(){
  const name=gv('iName'),kind=gv('iType')||'hangban',qtyIn=getRaw('iQty'),totalAmt=getRaw('iAmt'),date=gv('iDate'),unitIn=gv('iUIn')||'cÃ¡i';
  const unitOut=kind==='nguyenlieu'?unitIn:(gv('iUOut')||unitIn),factor=kind==='nguyenlieu'?1:(getRaw('iFac')||1);
  if(!name){toast('âš ï¸ Nháº­p tÃªn!',true);return}if(!qtyIn){toast('âš ï¸ Nháº­p SL!',true);return}if(!totalAmt){toast('âš ï¸ Nháº­p tiá»n!',true);return}if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}
  const stockAdded=kind==='hangban'?qtyIn*factor:0;
  FIN.imports.push({id:Date.now(),name,kind,qtyIn,unitIn,unitOut,factor,stockAdded,totalAmt,date,desc:`Nháº­p ${qtyIn} ${unitIn} ${name}`});
  persist();if(kind==='hangban')upsertProd({name,kind,unitIn,unitOut,factor,lastP:Math.round(totalAmt/(qtyIn*factor))});else upsertProd({name,kind:'nguyenlieu',unitIn,unitOut:unitIn,factor:1});
  renderAll();renderInv();renderToday();
  sv('iName','');clrM('iQty');clrM('iAmt');sv('iUIn','');sv('iUOut','');
  const fe=document.getElementById('iFac');if(fe){fe.value='';fe.dataset.raw=''}
  document.getElementById('convPreview').classList.remove('on');
  toast(kind==='hangban'?`âœ… Nháº­p ${qtyIn} ${unitIn} â†’ +${stockAdded} ${unitOut} kho!`:`âœ… Chi nguyÃªn liá»‡u ${fmt(totalAmt)}`);
}
function delImp(id){showCfm('XoÃ¡ khoáº£n nháº­p','Tá»“n kho sáº½ thay Ä‘á»•i.',()=>{FIN.imports=FIN.imports.filter(x=>x.id!==id);persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}
function addCost(){const desc=gv('cpDesc'),amount=getRaw('cpAmt'),date=gv('cpDate'),type=gv('cpType');if(!desc){toast('âš ï¸ Nháº­p mÃ´ táº£!',true);return}if(!amount){toast('âš ï¸ Nháº­p tiá»n!',true);return}if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}FIN.costs.push({id:Date.now(),desc,amount,type,date});persist();renderAll();renderCpTable();renderToday();clrM('cpAmt');sv('cpDesc','');toast('âœ… ÄÃ£ thÃªm!')}
function delCp(id){showCfm('XoÃ¡ chi phÃ­','XoÃ¡ khoáº£n chi nÃ y?',()=>{FIN.costs=FIN.costs.filter(x=>x.id!==id);persist();renderAll();renderCpTable();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL AI ENGINE â€” 100% offline, khÃ´ng cáº§n API key
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Chuyá»ƒn "15k","1tr","2.5tr","300000" â†’ sá»‘ nguyÃªn
function parseVNNum(s){
  if(!s)return 0;
  s=s.toString().toLowerCase().trim().replace(/\./g,'').replace(/,/g,'.');
  if(s.includes('tá»·')||s.includes('ty'))return Math.round(parseFloat(s)*1e9);
  if(s.includes('tr')||s.includes('triá»‡u'))return Math.round(parseFloat(s)*1e6);
  if(s.includes('k'))return Math.round(parseFloat(s)*1e3);
  return parseInt(s.replace(/\D/g,''))||0;
}

// TÃ¡ch sá»‘ + Ä‘Æ¡n vá»‹ ra khá»i chuá»—i kiá»ƒu "5 gÃ³i", "2 thÃ¹ng", "10"
function extractQtyUnit(s){
  const m=s.match(/^(\d+[\.,]?\d*)\s*([a-zÄ‘Ã Ã¡Ã¢Ã£Ã¨Ã©ÃªÃ¬Ã­Ã²Ã³Ã´ÃµÃ¹ÃºÃ½Äƒáº¯áº·áº³áºµáº¯á»á»Ÿá»¡á»›á»£á»§Å©á»¥Æ°á»«á»©á»±á»±áº·áº¹áº¿á»á»ƒá»…áº»áº½á»áº¿á»‡á»‰á»‹á»á»™á»“á»•á»—á»‘á»›á»á»Ÿá»¡á»£á»§á»©á»±á»¥á»«á»«á»­á»¯á»±áº©áº­áº§áº«áº©áº£áº¡áº·áº¹áº½Ã©á»á»ƒá»‡á»‰á»‹á»á»™á»‘á»“á»•á»—Æ¡á»›á»á»Ÿá»¡Æ°á»£ÃºÃ¹Ã»Ã¼á»©á»«á»­á»¯á»±Ã½]*)?/i);
  if(m)return{qty:parseFloat(m[1])||1,unit:(m[2]||'').trim()};
  return{qty:1,unit:''};
}

// Nháº­n diá»‡n Ã½ Ä‘á»‹nh tá»« tin nháº¯n
function parseIntent(msg){
  const m=msg.toLowerCase().trim();

  // â”€â”€ GHI BÃN HÃ€NG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Pattern: "bÃ¡n / ghi bÃ¡n / Ä‘Ã£ bÃ¡n" + sá»‘ lÆ°á»£ng + tÃªn sáº£n pháº©m + giÃ¡
  // VD: "bÃ¡n 5 gÃ³i mÃ¬ 15k", "ghi bÃ¡n 3 chai nÆ°á»›c 10000", "bÃ¡n mÃ¬ tÃ´m 5 gÃ³i 3k"
  const sellPat=[
    /(?:bÃ¡n|ghi bÃ¡n|Ä‘Ã£ bÃ¡n|vá»«a bÃ¡n|sell)\s+(\d+[\.,]?\d*)\s*([^\d]+?)\s+([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘)?)/i,
    /(?:bÃ¡n|ghi bÃ¡n|Ä‘Ã£ bÃ¡n|vá»«a bÃ¡n)\s+([^\d]+?)\s+(\d+[\.,]?\d*)\s*(?:cÃ¡i|gÃ³i|chai|lon|kg|há»™p|tÃºi|bá»‹ch|cÃ¢n|lÃ­t)?\s+([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘)?)/i,
    /(?:bÃ¡n|ghi bÃ¡n|Ä‘Ã£ bÃ¡n|vá»«a bÃ¡n)\s+(\d+[\.,]?\d*)\s*([\w\s]+?)\s+(?:giÃ¡\s*)?([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘)?)/i,
  ];
  for(const pat of sellPat){
    const r=msg.match(pat);
    if(r){
      let qty,name,priceStr;
      if(/^\d/.test(r[1])){qty=parseFloat(r[1]);name=(r[2]||'').trim();priceStr=r[3]}
      else{name=(r[1]||'').trim();qty=parseFloat(r[2])||1;priceStr=r[3]}
      const price=parseVNNum(priceStr);
      if(name&&price>0)return{intent:'sell',name,qty:Math.round(qty)||1,price};
    }
  }
  // Fallback sell: "bÃ¡n mÃ¬ gÃ³i 15k" (khÃ´ng cÃ³ sá»‘ lÆ°á»£ng â†’ máº·c Ä‘á»‹nh 1)
  const sell2=/(?:bÃ¡n|ghi bÃ¡n|Ä‘Ã£ bÃ¡n)\s+([\w\s]+?)\s+([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘))/i.exec(msg);
  if(sell2){const name=(sell2[1]||'').trim(),price=parseVNNum(sell2[2]);if(name&&price>0)return{intent:'sell',name,qty:1,price}}

  // â”€â”€ GHI NHáº¬P HÃ€NG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VD: "nháº­p 2 thÃ¹ng bia 300k", "nháº­p hÃ ng mÃ¬ tÃ´m 5 thÃ¹ng 500k"
  const impPat=/(?:nháº­p|nháº­p hÃ ng|mua vÃ o|nháº­p kho|Ä‘áº·t hÃ ng)\s+(\d+[\.,]?\d*)\s*([^\d]+?)\s+([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘)?)/i.exec(msg);
  if(impPat){
    const qty=parseFloat(impPat[1])||1,name=(impPat[2]||'').trim(),price=parseVNNum(impPat[3]);
    if(name&&price>0)return{intent:'import',name,qty:Math.round(qty)||1,totalAmt:price};
  }
  const imp2=/(?:nháº­p|nháº­p hÃ ng|mua vÃ o)\s+([\w\s]+?)\s+(\d+[\.,]?\d*)\s*(?:cÃ¡i|gÃ³i|chai|thÃ¹ng|kg|há»™p)?\s+([\d,\.]+\s*(?:k|tr|triá»‡u|Ä‘á»“ng|d|Ä‘)?)/i.exec(msg);
  if(imp2){const name=(imp2[1]||'').trim(),qty=parseFloat(imp2[2])||1,price=parseVNNum(imp2[3]);if(name&&price>0)return{intent:'import',name,qty:Math.round(qty)||1,totalAmt:price}}

  // â”€â”€ KHO / Tá»’N KHO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(kho|tá»“n kho|cÃ²n gÃ¬|háº¿t hÃ ng|sáº¯p háº¿t|cÃ²n bao nhiÃªu|kiá»ƒm kho|stock|inventory)/i.test(m))
    return{intent:'inventory'};

  // Há»i tá»“n kho má»™t máº·t hÃ ng cá»¥ thá»ƒ
  const stockQ=/(cÃ²n|tá»“n|stock)\s+(.+?)(?:\s+khÃ´ng|\s+ko|\?|$)/i.exec(msg);
  if(stockQ&&stockQ[2].length<30)return{intent:'stockItem',name:stockQ[2].trim()};

  // â”€â”€ DOANH THU / LÃƒI Lá»– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(doanh thu|lÃ£i|lá»£i nhuáº­n|thu nháº­p|bÃ¡n Ä‘Æ°á»£c|thÃ¡ng nÃ y|hÃ´m nay thu|hÃ´m nay lÃ£i|káº¿t quáº£|tá»•ng káº¿t|bÃ¡o cÃ¡o nhanh)/i.test(m))
    return{intent:'revenue'};

  // â”€â”€ THUáº¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(thuáº¿|ná»™p thuáº¿|tá» khai|gtgt|tncn|500 triá»‡u|canhan|Ã´ 21|o 21|khai thuáº¿|miá»…n thuáº¿)/i.test(m))
    return{intent:'tax'};

  // â”€â”€ HÆ¯á»šNG DáºªN Ná»˜P THUáº¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(hÆ°á»›ng dáº«n.*thuáº¿|cÃ¡ch ná»™p|ná»™p á»Ÿ Ä‘Ã¢u|ná»™p nhÆ° tháº¿ nÃ o|tá»«ng bÆ°á»›c.*thuáº¿|bÆ°á»›c.*thuáº¿)/i.test(m))
    return{intent:'taxGuide'};

  // â”€â”€ MARKETING / BÃN HÃ€NG ONLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(facebook|tiktok|zalo|Ä‘Äƒng bÃ i|post|viral|marketing|quáº£ng cÃ¡o|quáº£ng bÃ¡|content|ná»™i dung)/i.test(m))
    return{intent:'marketing'};

  // â”€â”€ Máº¸O KINH DOANH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(máº¹o|tip|cÃ¡ch|lÃ m sao|tháº¿ nÃ o|chiáº¿n lÆ°á»£c|tÄƒng doanh|bÃ¡n nhiá»u|giá»¯ khÃ¡ch|khÃ¡ch hÃ ng|cáº¡nh tranh|giÃ¡|Ä‘á»‹nh giÃ¡)/i.test(m))
    return{intent:'bizTip'};

  // â”€â”€ CHI PHÃ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(chi phÃ­|Ä‘iá»‡n|nÆ°á»›c|tiá»n thuÃª|nhÃ¢n cÃ´ng|váº­n chuyá»ƒn|phÃ­|expense)/i.test(m))
    return{intent:'costTip'};

  // â”€â”€ HÆ¯á»šNG DáºªN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/(hÆ°á»›ng dáº«n|cÃ¡ch dÃ¹ng|sá»­ dá»¥ng|app|á»©ng dá»¥ng|tÃ­nh nÄƒng|lÃ m gÃ¬|dÃ¹ng nhÆ° tháº¿)/i.test(m))
    return{intent:'appHelp'};

  // â”€â”€ CHÃ€O Há»I â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(/^(xin chÃ o|chÃ o|hello|hi|alo|hey|chÃ o mÃ¬nh|xin há»i)[\s!?.,]*$/i.test(m))
    return{intent:'greet'};

  return{intent:'unknown',msg};
}

// Sinh pháº£n há»“i tá»« intent
function localAIResponse(msg){
  const intent=parseIntent(msg);
  const yRev=yearRevenue(),thu=getRev(CUR),chi=getCost(CUR),lai=thu-chi;
  const yr=new Date().getFullYear(),rem=Math.max(0,TAX_TH-yRev);
  const isOver=yRev>TAX_TH;

  switch(intent.intent){

    case 'sell':{
      const{name,qty,price}=intent;
      const total=qty*price;
      const{stock}=getStock(name,'');
      const inv=computeInv().find(x=>x.name.toLowerCase()===name.toLowerCase());
      const realStock=inv?inv.stock:stock;
      const confirm=[{item:name,quantity:qty,price,type:'bÃ¡n'}];
      let txt=`ğŸ’° Ghi nháº­n bÃ¡n:\nğŸ“¦ ${qty} ${name} Ã— ${fmt(price)} = ${fmt(total)}`;
      if(inv&&realStock<qty)txt+=`\nâš ï¸ LÆ°u Ã½: kho chá»‰ cÃ²n ${realStock} ${inv.unitOut||''}`;
      else if(inv)txt+=`\nğŸ“Š Sau bÃ¡n cÃ²n: ${realStock-qty} ${inv.unitOut||''}`;
      return{text:txt,confirm};
    }

    case 'import':{
      const{name,qty,totalAmt}=intent;
      const confirm=[{item:name,quantity:qty,price:totalAmt,type:'nháº­p'}];
      return{text:`ğŸ“¦ Ghi nháº­n nháº­p hÃ ng:\nğŸ›’ ${qty} ${name} â€” Tá»•ng: ${fmt(totalAmt)}\nğŸ’¡ Sáº½ cáº­p nháº­t tá»“n kho sau khi xÃ¡c nháº­n!`,confirm};
    }

    case 'inventory':{
      const inv=computeInv();
      if(!inv.length)return{text:'ğŸ“¦ Kho Ä‘ang trá»‘ng.\nBáº¡n vÃ o Thu/Chi â†’ Nháº­p hÃ ng Ä‘á»ƒ thÃªm sáº£n pháº©m nhÃ©!'};
      const out=inv.filter(x=>x.stock===0),low=inv.filter(x=>x.stock>0&&x.stock<LOW),ok=inv.filter(x=>x.stock>=LOW);
      let txt='ğŸ“¦ TÃ¬nh hÃ¬nh kho hiá»‡n táº¡i:\n';
      if(out.length)txt+=`ğŸ”´ Háº¿t hÃ ng (${out.length}): ${out.map(x=>x.name).join(', ')}\n`;
      if(low.length)txt+=`ğŸŸ¡ Sáº¯p háº¿t (${low.length}): ${low.map(x=>x.name+' cÃ²n '+x.stock).join(', ')}\n`;
      if(ok.length)txt+=`ğŸŸ¢ Äá»§ hÃ ng (${ok.length}): ${ok.slice(0,5).map(x=>x.name+' ('+x.stock+')').join(', ')}${ok.length>5?' ...':''}`;
      if(out.length||low.length)txt+=`\n\nğŸ’¡ NÃªn nháº­p thÃªm cÃ¡c máº·t hÃ ng Ä‘ang háº¿t/sáº¯p háº¿t!`;
      return{text:txt.trim()};
    }

    case 'stockItem':{
      const inv=computeInv();
      const found=inv.filter(x=>x.name.toLowerCase().includes(intent.name.toLowerCase()));
      if(!found.length)return{text:`â“ MÃ¬nh khÃ´ng tÃ¬m tháº¥y "${intent.name}" trong kho.\nBáº¡n kiá»ƒm tra láº¡i tÃªn hoáº·c nháº­p hÃ ng nÃ y trÆ°á»›c nhÃ©!`};
      const txt=found.map(x=>`ğŸ“¦ ${x.name}${x.unitOut?' ('+x.unitOut+')':''}: cÃ²n ${x.stock}${x.unitOut?' '+x.unitOut:''} ${x.stock===0?'ğŸ”´ Háº¿t hÃ ng':x.stock<LOW?'ğŸŸ¡ Sáº¯p háº¿t':'ğŸŸ¢ Äá»§'}`).join('\n');
      return{text:txt};
    }

    case 'revenue':{
      const tod=todayISO(),todThu=FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===tod).reduce((s,x)=>s+x.totalAmt,0);
      const topProd=[...new Map(FIN.sales.map(x=>[x.name,(FIN.sales.filter(s=>s.name===x.name).reduce((a,b)=>a+b.totalAmt,0))])).entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
      let txt=`ğŸ“Š Káº¿t quáº£ kinh doanh:\n\nğŸ“… HÃ´m nay: ${fmt(todThu)}\n\nğŸ“† ThÃ¡ng ${CUR}:\nğŸ’° Doanh thu: ${fmt(thu)}\nğŸ“‰ Chi phÃ­: ${fmt(chi)}\nğŸ’¼ LÃ£i/Lá»—: ${(lai>=0?'â–² +':'â–¼ ')+fmt(lai)}\n\nğŸ—“ï¸ NÄƒm ${yr}: ${fmt(yRev)}`;
      if(topProd.length)txt+=`\n\nğŸ† BÃ¡n cháº¡y nháº¥t:\n${topProd.map((x,i)=>`${i+1}. ${x[0]}: ${fmt(x[1])}`).join('\n')}`;
      return{text:txt};
    }

    case 'tax':{
      if(isOver){
        const gT=Math.round(yRev*.01),tncn=Math.round((yRev-TAX_TH)*.005);
        return{text:`âš ï¸ Doanh thu nÄƒm ${yr} cá»§a báº¡n lÃ  ${fmt(yRev)}, Ä‘Ã£ vÆ°á»£t ngÆ°á»¡ng 500 triá»‡u!\n\nThuáº¿ pháº£i ná»™p:\nâ€¢ GTGT ~1%: ${fmt(gT)}\nâ€¢ TNCN: ${fmt(tncn)}\nâ€¢ Tá»•ng: ${fmt(gT+tncn)}\n\nBáº¡n nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ sao chÃ©p sá»‘ Ä‘iá»n vÃ o Ã” [21] nhÃ©!`,taxCard:true,yRev};
      }
      const mo=new Date().getMonth()+1,proj=mo?Math.round(yRev/mo*12):0;
      let txt=`âœ… Doanh thu nÄƒm ${yr}: ${fmt(yRev)}\nChÆ°a Ä‘áº¿n ngÆ°á»¡ng 500 triá»‡u â€” chÆ°a cáº§n ná»™p thuáº¿!\n\nCÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm: ${fmt(rem)}`;
      if(proj>TAX_TH*0.8)txt+=`\n\nğŸ”” LÆ°u Ã½: Dá»± bÃ¡o cáº£ nÄƒm ~${fmt(proj)}, sáº¯p Ä‘áº¿n ngÆ°á»¡ng rá»“i!`;
      return{text:txt,safeTaxCard:true,yRev};
    }

    case 'taxGuide':
      return{text:`ğŸ“‹ HÆ°á»›ng dáº«n ná»™p thuáº¿ Ä‘iá»‡n tá»­ (Máº«u 01/CNKD):\n\n1ï¸âƒ£ VÃ o canhan.gdt.gov.vn\n2ï¸âƒ£ ÄÄƒng nháº­p báº±ng MST hoáº·c tÃ i khoáº£n thuáº¿\n3ï¸âƒ£ Chá»n "Khai thuáº¿" â†’ "Thuáº¿ khoÃ¡n" â†’ Máº«u 01/CNKD\n4ï¸âƒ£ Äiá»n Ã” [21] = Tá»•ng doanh thu (${fmt(yRev)})\n5ï¸âƒ£ Há»‡ thá»‘ng tá»± tÃ­nh thuáº¿ â†’ Xem láº¡i â†’ Ná»™p\n6ï¸âƒ£ LÆ°u biÃªn lai Ä‘iá»‡n tá»­\n\nğŸ’¡ Thá»i háº¡n: Ná»™p trÆ°á»›c ngÃ y 15 thÃ¡ng Ä‘áº§u quÃ½ tiáº¿p theo.`};

    case 'marketing':
      return{text:`ğŸ“£ Máº¹o marketing hiá»‡u quáº£ cho tiá»ƒu thÆ°Æ¡ng:\n\nğŸ“± Facebook/Zalo:\nâ€¢ ÄÄƒng áº£nh sáº£n pháº©m + giÃ¡ má»—i sÃ¡ng 7-8h\nâ€¢ Quay video ngáº¯n 15-30 giÃ¢y, Ä‘á»ƒ máº·t hÃ ng chá»§ lá»±c\nâ€¢ DÃ¹ng má»¥c Quáº£ng bÃ¡ trong app Ä‘á»ƒ AI viáº¿t bÃ i!\n\nğŸ¬ TikTok:\nâ€¢ Quay lÃºc má»Ÿ hÃ ng, lÃºc Ä‘Ã´ng khÃ¡ch\nâ€¢ KhÃ´ng cáº§n quÃ¡ chá»‰nh chu â€” tá»± nhiÃªn, tháº­t lÃ  viral\n\nğŸ’¬ Zalo OA:\nâ€¢ Táº¡o nhÃ³m khÃ¡ch quen, bÃ¡o hÃ ng má»›i má»—i tuáº§n`};

    case 'bizTip':{
      const tips=[
        `ğŸ’¡ Máº¹o tÄƒng doanh thu:\n\nâ€¢ Xáº¿p hÃ ng bÃ¡n cháº¡y á»Ÿ vá»‹ trÃ­ dá»… tháº¥y, ngang táº§m máº¯t\nâ€¢ Táº¡o combo: "Mua 2 táº·ng 1" hoáº·c "Mua kÃ¨m giáº£m 10%"\nâ€¢ Theo dÃµi hÃ ng sáº¯p háº¿t â†’ nháº­p trÆ°á»›c khi khÃ¡ch cáº§n\nâ€¢ Giá» vÃ ng má»Ÿ cá»­a: 6-9h sÃ¡ng vÃ  4-7h chiá»u\nâ€¢ Nhá»› tÃªn khÃ¡ch quen â†’ táº¡o cáº£m giÃ¡c thÃ¢n thiáº¿t`,
        `ğŸ“ˆ Chiáº¿n lÆ°á»£c Ä‘á»‹nh giÃ¡ thÃ´ng minh:\n\nâ€¢ GiÃ¡ láº» tÃ¢m lÃ½: 19.000Ä‘ thay vÃ¬ 20.000Ä‘\nâ€¢ HÃ ng thiáº¿t yáº¿u (gáº¡o, mÃ¬): giá»¯ giÃ¡ cáº¡nh tranh\nâ€¢ HÃ ng Ä‘áº·c biá»‡t (nháº­p kháº©u, hiáº¿m): cÃ³ thá»ƒ lÃ£i cao hÆ¡n\nâ€¢ Giáº£m giÃ¡ hÃ ng sáº¯p háº¿t háº¡n Ä‘á»ƒ quay vá»‘n nhanh\nâ€¢ Khuyáº¿n mÃ£i cuá»‘i tuáº§n Ä‘á»ƒ kÃ©o khÃ¡ch`,
        `ğŸ›’ Quáº£n lÃ½ kho hiá»‡u quáº£:\n\nâ€¢ Nháº­p hÃ ng theo nguyÃªn táº¯c FIFO (vÃ o trÆ°á»›c bÃ¡n trÆ°á»›c)\nâ€¢ Äáº·t má»©c tá»“n kho tá»‘i thiá»ƒu cho tá»«ng máº·t hÃ ng\nâ€¢ Kiá»ƒm kÃª kho má»—i tuáº§n 1 láº§n\nâ€¢ Theo dÃµi hÃ ng bÃ¡n cháº­m â†’ xáº£ kho ká»‹p thá»i\nâ€¢ DÃ¹ng tab Kho trong app Ä‘á»ƒ biáº¿t chÃ­nh xÃ¡c sá»‘ lÆ°á»£ng!`
      ];
      return{text:tips[Math.floor(Date.now()/1000)%tips.length]};
    }

    case 'costTip':
      return{text:`ğŸ’° Quáº£n lÃ½ chi phÃ­ thÃ´ng minh:\n\nâ€¢ Ghi Ä‘áº§y Ä‘á»§ má»i chi phÃ­ (Ä‘iá»‡n, nÆ°á»›c, thuÃª máº·t báº±ng) vÃ o má»¥c Chi phÃ­\nâ€¢ So sÃ¡nh chi phÃ­ thÃ¡ng nÃ y vs thÃ¡ng trÆ°á»›c trong BÃ¡o cÃ¡o\nâ€¢ Chi phÃ­ cá»‘ Ä‘á»‹nh (thuÃª, nhÃ¢n cÃ´ng): Ä‘Ã m phÃ¡n láº¡i má»—i nÄƒm\nâ€¢ Chi phÃ­ biáº¿n Ä‘á»•i (Ä‘iá»‡n, nÆ°á»›c): tiáº¿t kiá»‡m báº±ng cÃ¡ch táº¯t thiáº¿t bá»‹ khi khÃ´ng cáº§n\nâ€¢ Nháº­p hÃ ng sá»‘ lÆ°á»£ng lá»›n thÆ°á»ng Ä‘Æ°á»£c giÃ¡ tá»‘t hÆ¡n`};

    case 'appHelp':
      return{text:`ğŸ“± TÃ­nh nÄƒng chÃ­nh cá»§a app:\n\nğŸ’° Thu/Chi:\nâ€¢ Ghi bÃ¡n hÃ ng, nháº­p kho, chi phÃ­ váº­n hÃ nh\nâ€¢ Theo dÃµi tá»“n kho tá»± Ä‘á»™ng\n\nğŸ“Š BÃ¡o cÃ¡o:\nâ€¢ Biá»ƒu Ä‘á»“ doanh thu, so sÃ¡nh thÃ¡ng, kiá»ƒm tra thuáº¿\n\nğŸ“£ Quáº£ng bÃ¡:\nâ€¢ AI viáº¿t bÃ i Facebook vÃ  hÆ°á»›ng dáº«n TikTok\n\nğŸ¤– AI Chat (Ä‘Ã¢y):\nâ€¢ NÃ³i tá»± nhiÃªn Ä‘á»ƒ ghi giao dá»‹ch: "bÃ¡n 5 mÃ¬ 15k"\nâ€¢ Há»i kho, doanh thu, thuáº¿ báº¥t ká»³ lÃºc nÃ o!`};

    case 'greet':
      return{text:`ğŸ‘‹ Xin chÃ o! MÃ¬nh lÃ  Trá»£ lÃ½ Há»™ Má»‡nh ğŸ’š\n\nMÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n:\nâ€¢ Ghi bÃ¡n hÃ ng: "bÃ¡n 5 gÃ³i mÃ¬ 15k"\nâ€¢ Nháº­p kho: "nháº­p 2 thÃ¹ng bia 300k"\nâ€¢ Kiá»ƒm tra: "kho cÃ²n gÃ¬?", "thÃ¡ng nÃ y lÃ£i bao nhiÃªu?"\nâ€¢ TÆ° váº¥n thuáº¿ vÃ  kinh doanh\n\nBáº¡n cáº§n gÃ¬ cá»© nháº¯n nhÃ©!`};

    default:{
      // Cá»‘ tÃ¬m xem cÃ³ pháº£i giao dá»‹ch khÃ´ng rÃµ format
      const hasNum=/\d/.test(msg),hasMoney=/(k|tr|triá»‡u|Ä‘á»“ng|Ä‘)\b/i.test(msg);
      if(hasNum&&hasMoney&&/(bÃ¡n|nháº­p|mua)/i.test(msg))
        return{text:`â“ MÃ¬nh chÆ°a hiá»ƒu rÃµ giao dá»‹ch nÃ y.\n\nBáº¡n thá»­ viáº¿t theo máº«u:\nâ€¢ BÃ¡n: "bÃ¡n 5 gÃ³i mÃ¬ 15k"\nâ€¢ Nháº­p: "nháº­p 2 thÃ¹ng bia 300k"\n\nHoáº·c dÃ¹ng tab Thu/Chi Ä‘á»ƒ nháº­p trá»±c tiáº¿p!`};
      return{text:`ğŸ’¬ Báº¡n há»i vá» "${msg.slice(0,50)}${msg.length>50?'...':''}"?\n\nMÃ¬nh cÃ³ thá»ƒ giÃºp vá»:\nğŸ“¦ Kho hÃ ng Â· ğŸ’° Doanh thu Â· ğŸ§¾ Thuáº¿ Â· ğŸ“£ Marketing Â· ğŸ’¡ Máº¹o kinh doanh\n\nHoáº·c ghi giao dá»‹ch: "bÃ¡n 5 mÃ¬ 15k", "nháº­p 2 thÃ¹ng bia 300k"`};
    }
  }
}

// â”€â”€ Smart fallback (no API needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function invSummaryText(){
  const inv=computeInv();if(!inv.length)return'Kho Ä‘ang trá»‘ng.';
  const out=inv.filter(x=>x.stock===0),low=inv.filter(x=>x.stock>0&&x.stock<LOW),ok=inv.filter(x=>x.stock>=LOW);
  let s='';
  if(out.length)s+=`ğŸ”´ Háº¿t hÃ ng: ${out.map(x=>x.name+(x.unitOut?' ('+x.unitOut+')':'')).join(', ')}.\n`;
  if(low.length)s+=`ğŸŸ¡ Sáº¯p háº¿t: ${low.map(x=>x.name+' cÃ²n '+x.stock+(x.unitOut?' '+x.unitOut:'')).join(', ')}.\n`;
  if(ok.length)s+=`ğŸŸ¢ Äá»§ hÃ ng: ${ok.slice(0,6).map(x=>x.name+' ('+x.stock+')').join(', ')}${ok.length>6?' +'+( ok.length-6)+' ná»¯a':''}.`;
  return s.trim()||'Kho á»•n ğŸ‘';
}

function fallbackResponse(msg){
  const yRev=yearRevenue(),thu=getRev(CUR),chi=getCost(CUR),lai=thu-chi;
  const m=msg.toLowerCase();

  // Thuáº¿
  if(/(thuáº¿|ná»™p|tá» khai|gtgt|tncn|500|canhan|Ã´ 21|o 21|khai thuáº¿)/i.test(msg)){
    if(yRev>TAX_TH)return{text:`Doanh thu nÄƒm nay cá»§a báº¡n lÃ  ${fmt(yRev)}, Ä‘Ã£ vÆ°á»£t ngÆ°á»¡ng 500 triá»‡u rá»“i!\nBáº¡n cáº§n khai thuáº¿ táº¡i canhan.gdt.gov.vn â€” Ä‘iá»n vÃ o Ã” [21]: ${fmt(yRev)}`,taxCard:true,yRev};
    const rem=TAX_TH-yRev;
    return{text:`Doanh thu ${fmt(yRev)}, chÆ°a Ä‘áº¿n 500 triá»‡u nÃªn chÆ°a cáº§n ná»™p thuáº¿ nhÃ©!\nCÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm ${fmt(rem)} trÆ°á»›c khi lo.`,safeTaxCard:true,yRev};
  }

  // Kho / tá»“n kho
  if(/(kho|tá»“n kho|cÃ²n gÃ¬|háº¿t hÃ ng|sáº¯p háº¿t|cÃ²n bao nhiÃªu|stock)/i.test(msg)){
    const inv=computeInv();
    if(!inv.length)return{text:'Kho Ä‘ang trá»‘ng. VÃ o Thu/Chi â†’ Nháº­p hÃ ng Ä‘á»ƒ thÃªm sáº£n pháº©m nhÃ©!'};
    return{text:'ğŸ“¦ TÃ¬nh hÃ¬nh kho:\n'+invSummaryText()};
  }

  // Doanh thu / lÃ£i lá»—
  if(/(doanh thu|lÃ£i|lá»£i nhuáº­n|thu nháº­p|bÃ¡n Ä‘Æ°á»£c|thÃ¡ng nÃ y|thÃ¡ng|hÃ´m nay thu|hÃ´m nay lÃ£i)/i.test(msg)){
    return{text:`ğŸ“Š Káº¿t quáº£ thÃ¡ng ${CUR}:\nğŸ’° Doanh thu: ${fmt(thu)}\nğŸ“‰ Chi phÃ­: ${fmt(chi)}\nğŸ’¼ LÃ£i/Lá»—: ${(lai>=0?'+':'')+fmt(lai)}\n\nğŸ“… Doanh thu cáº£ nÄƒm: ${fmt(yRev)}`};
  }

  // BÃ¡n hÃ ng / tÄƒng doanh thu / kinh doanh
  if(/(bÃ¡n|kinh doanh|tÄƒng doanh|cÃ¡ch nÃ o|lÃ m sao|tháº¿ nÃ o|giÃ¡|khÃ¡ch|marketing|quáº£ng cÃ¡o|máº¹o|tip)/i.test(msg)){
    const tips=[
      'ğŸ’¡ Máº¹o tÄƒng doanh thu hiá»‡u quáº£:\nâ€¢ ÄÄƒng áº£nh sáº£n pháº©m + giÃ¡ lÃªn Facebook/Zalo má»—i sÃ¡ng\nâ€¢ Táº¡o combo: mua 2 táº·ng 1, hoáº·c giáº£m giÃ¡ sá»‘ lÆ°á»£ng lá»›n\nâ€¢ Ghi nhá»› khÃ¡ch quen â†’ chá»§ Ä‘á»™ng nháº¯c khi cÃ³ hÃ ng má»›i\nâ€¢ Báº¡n cÃ³ thá»ƒ dÃ¹ng má»¥c "Quáº£ng bÃ¡" Ä‘á»ƒ AI viáº¿t bÃ i cho!',
      'ğŸ“ˆ Chiáº¿n lÆ°á»£c bÃ¡n cháº¡y hÆ¡n:\nâ€¢ Theo dÃµi sáº£n pháº©m bÃ¡n cháº¡y nháº¥t â†’ nháº­p thÃªm Ä‘Ãºng lÃºc\nâ€¢ HÃ ng sáº¯p háº¿t háº¡n â†’ Ä‘áº©y giÃ¡ tháº¥p Ä‘á»ƒ giáº£i phÃ³ng kho nhanh\nâ€¢ BÃ y hÃ ng á»Ÿ nÆ¡i dá»… tháº¥y, gáº¯n giÃ¡ rÃµ rÃ ng\nâ€¢ Giá» cao Ä‘iá»ƒm: 7â€“9h sÃ¡ng vÃ  5â€“7h chiá»u',
      'ğŸ›’ CÃ¡ch giá»¯ chÃ¢n khÃ¡ch quen:\nâ€¢ ThÃ¡i Ä‘á»™ niá»m ná»Ÿ, nhá»› tÃªn vÃ  sá»Ÿ thÃ­ch cá»§a khÃ¡ch\nâ€¢ LuÃ´n cÃ³ hÃ ng Ä‘á»§ tá»“n, khÃ´ng Ä‘á»ƒ khÃ¡ch Ä‘áº¿n mÃ  háº¿t hÃ ng\nâ€¢ Giao hÃ ng táº­n nÆ¡i cho Ä‘Æ¡n lá»›n náº¿u Ä‘Æ°á»£c\nâ€¢ ChÆ°Æ¡ng trÃ¬nh tÃ­ch Ä‘iá»ƒm Ä‘Æ¡n giáº£n: mua 10 láº§n táº·ng 1 láº§n'
    ];
    return{text:tips[Math.floor(Math.random()*tips.length)]};
  }

  // Nháº­p hÃ ng / Ä‘áº·t hÃ ng
  if(/(nháº­p|Ä‘áº·t hÃ ng|nhÃ  cung cáº¥p|giÃ¡ nháº­p|nguá»“n hÃ ng)/i.test(msg)){
    return{text:'ğŸ“¦ Äá»ƒ nháº­p hÃ ng:\nâ€¢ VÃ o Thu/Chi â†’ tab Nháº­p hÃ ng\nâ€¢ Äiá»n tÃªn, Ä‘Æ¡n vá»‹, sá»‘ lÆ°á»£ng vÃ  tá»•ng tiá»n\nâ€¢ Há»‡ thá»‘ng tá»± cáº­p nháº­t tá»“n kho ngay!\n\nMáº¹o: Nháº­p Ä‘á»§ thÃ´ng tin Ä‘á»ƒ theo dÃµi lÃ£i gá»™p chÃ­nh xÃ¡c nhÃ©.'};
  }

  // HÆ°á»›ng dáº«n sá»­ dá»¥ng app
  if(/(hÆ°á»›ng dáº«n|cÃ¡ch dÃ¹ng|sá»­ dá»¥ng|app|á»©ng dá»¥ng|tÃ­nh nÄƒng|lÃ m gÃ¬ Ä‘Æ°á»£c)/i.test(msg)){
    return{text:'ğŸ“± App nÃ y giÃºp báº¡n:\nâ€¢ ğŸ’° Thu/Chi: Ghi bÃ¡n hÃ ng, nháº­p kho, chi phÃ­\nâ€¢ ğŸ“Š BÃ¡o cÃ¡o: Biá»ƒu Ä‘á»“ doanh thu, so sÃ¡nh thÃ¡ng, kiá»ƒm tra thuáº¿\nâ€¢ ğŸ“£ Quáº£ng bÃ¡: AI viáº¿t bÃ i Facebook & hÆ°á»›ng dáº«n TikTok\nâ€¢ ğŸ¤– AI nÃ y: Há»i gÃ¬ cÅ©ng Ä‘Æ°á»£c, ghi giao dá»‹ch báº±ng chat!'};
  }

  // Default thÃ´ng minh hÆ¡n â€” khÃ´ng tráº£ vá» cÃ¢u rá»—ng
  return{text:`MÃ¬nh hiá»ƒu báº¡n Ä‘ang há»i vá» "${msg.slice(0,40)}${msg.length>40?'...':''}".\n\nHiá»‡n káº¿t ná»‘i AI táº¡m giÃ¡n Ä‘oáº¡n, nhÆ°ng mÃ¬nh cÃ³ thá»ƒ giÃºp ngay:\nâ€¢ GÃµ "kho cÃ²n gÃ¬?" â†’ xem tá»“n kho\nâ€¢ GÃµ "thÃ¡ng nÃ y lÃ£i bao nhiÃªu?" â†’ xem doanh thu\nâ€¢ GÃµ "bÃ¡n 5 gÃ³i mÃ¬ 15k" â†’ ghi giao dá»‹ch\nâ€¢ GÃµ "tÃ´i cÃ³ pháº£i ná»™p thuáº¿ khÃ´ng?" â†’ kiá»ƒm tra thuáº¿`};
}

// â”€â”€ Tax card helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTaxCard(yRev){
  const gT=Math.round(yRev*.01),tncn=Math.round((yRev-TAX_TH)*.005);
  return`<div class="taxcard"><div class="taxcard-title">ğŸ›¡ï¸ Há»™ Má»‡nh Thuáº¿ â€” Ã” [21] Tá» Khai</div><div class="taxcard-sub">Báº¡n Ä‘iá»n con sá»‘ nÃ y vÃ o <strong>Ã” sá»‘ [21]</strong>:</div><div class="taxcard-amt">${fmt(yRev)}</div><div style="font-size:.68rem;color:#856404;margin-top:4px;line-height:1.6">ğŸ’¡ GTGT â‰ˆ ${fmt(gT)} &nbsp;|&nbsp; TNCN â‰ˆ ${fmt(tncn)}<br>Tá»•ng thuáº¿ â‰ˆ <strong>${fmt(gT+tncn)}</strong></div><div class="taxcard-btns"><button class="tcopy" onclick="clip('${yRev}','ğŸ“‹ ÄÃ£ sao chÃ©p!')">ğŸ“‹ Sao chÃ©p sá»‘ tiá»n</button><a href="https://canhan.gdt.gov.vn" target="_blank" class="topen">ğŸŒ Má»Ÿ trang Thuáº¿</a></div></div>`;
}
function buildSafeTaxCard(yRev){
  const rem=TAX_TH-yRev;
  return`<div style="background:linear-gradient(135deg,#E8F5E9,#F1F8E9);border:2px solid #4CAF50;border-radius:14px;padding:12px;margin-top:8px;text-align:center"><div style="font-size:.88rem;font-weight:900;color:#2E7D32;margin-bottom:4px">ğŸ›¡ï¸ ChÆ°a pháº£i ná»™p thuáº¿ âœ…</div><div style="font-size:.72rem;color:#388E3C;margin-bottom:6px">Doanh thu nÄƒm cá»§a báº¡n:</div><div style="font-size:1.3rem;font-weight:900;color:#1B6B3A">${fmt(yRev)}</div><div style="font-size:.7rem;color:#5A7A66;margin-top:4px">CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm <strong style="color:#1B6B3A">${fmt(rem)}</strong> trÆ°á»›c khi lo thuáº¿</div><button onclick="clip('${yRev}','ğŸ“‹ ÄÃ£ sao chÃ©p!')" style="margin-top:8px;padding:7px 14px;background:#1B6B3A;color:#fff;border:none;border-radius:16px;font-weight:800;cursor:pointer;font-size:.74rem;font-family:inherit">ğŸ“‹ Sao chÃ©p doanh thu</button></div>`;
}

// â”€â”€ Promo AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function genFb(){
  const prod=gv('fbProd'),hl=gv('fbHl'),price=getRaw('fbPrice');
  if(!prod){toast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return}
  const card=document.getElementById('fbCard'),ld=document.getElementById('fbLoader'),box=document.getElementById('fbRes'),btn=document.getElementById('fbCopy');
  card.style.display='block';if(ld)ld.style.display='block';if(box)box.style.display='none';if(btn)btn.style.display='none';
  const sys='Báº¡n lÃ  chuyÃªn gia marketing cho tiá»ƒu thÆ°Æ¡ng Viá»‡t Nam. Viáº¿t bÃ i bÃ¡n hÃ ng Facebook ngáº¯n gá»n, chÃ¢n tháº­t, gáº§n gÅ©i, cÃ³ emoji, cÃ³ call-to-action. KhÃ´ng quÃ¡ 150 tá»«. Chá»‰ tráº£ vá» bÃ i viáº¿t, khÃ´ng giáº£i thÃ­ch thÃªm.';
  const prompt=`Viáº¿t bÃ i Ä‘Äƒng Facebook bÃ¡n "${prod}"${hl?' â€” Ä‘iá»ƒm ná»•i báº­t: '+hl:''}${price?' â€” giÃ¡: '+fmt(price):''}. CÃ³ 2-3 hashtag phÃ¹ há»£p.`;
  try{
    const raw=await callAIWithRetry(sys,prompt,450);
    if(ld)ld.style.display='none';if(box){box.textContent=raw.trim();box.style.display='block'}if(btn)btn.style.display='inline-block';
  }catch{
    if(ld)ld.style.display='none';
    const emoji=['ğŸ”¥','â­','âœ¨','ğŸ’«'][Math.floor(Math.random()*4)];
    const fb=`${emoji} ${prod.toUpperCase()}${hl?' â€” '+hl:''}!\n\nâœ… HÃ ng chÃ­nh hÃ£ng, cháº¥t lÆ°á»£ng Ä‘áº£m báº£o${price?'\nğŸ’° Chá»‰ '+fmt(price)+'/cÃ¡i':''}\n\nğŸ“ LiÃªn há»‡ ngay hoáº·c ghÃ© cá»­a hÃ ng!\nâ° Sá»‘ lÆ°á»£ng cÃ³ háº¡n, Ä‘áº·t sá»›m káº»o háº¿t!\n\n#${prod.replace(/\s+/g,'')} #HÃ ngTá»‘t #GiÃ¡Ráº»`;
    if(box){box.textContent=fb;box.style.display='block'}if(btn)btn.style.display='inline-block';
    toast('â„¹ï¸ DÃ¹ng máº«u nhanh (AI táº¡m báº­n)');
  }
}
async function genTT(){
  if(!gv('ttProd')){toast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return}
  const prod=gv('ttProd');const rm={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},x=rm[gv('ttRole')]||'báº¡n';
  const card=document.getElementById('ttCard'),ld=document.getElementById('ttLoader'),box=document.getElementById('ttRes'),btn=document.getElementById('ttCopy');
  card.style.display='block';if(ld)ld.style.display='block';if(box)box.style.display='none';if(btn)btn.style.display='none';
  const sys=`HÆ°á»›ng dáº«n quay TikTok bÃ¡n hÃ ng siÃªu Ä‘Æ¡n giáº£n cho ngÆ°á»i khÃ´ng rÃ nh cÃ´ng nghá»‡. Chia 3 bÆ°á»›c rÃµ rÃ ng, ngáº¯n gá»n, thÃ¢n thiá»‡n. Káº¿t thÃºc báº±ng cÃ¢u Ä‘á»™ng viÃªn "${x.charAt(0).toUpperCase()+x.slice(1)} quay xong Ä‘Äƒng luÃ´n nhÃ© ğŸ’š". Chá»‰ tráº£ hÆ°á»›ng dáº«n, khÃ´ng giáº£i thÃ­ch thÃªm.`;
  try{
    const raw=await callAIWithRetry(sys,`HÆ°á»›ng dáº«n ${x} quay TikTok bÃ¡n "${prod}". 3 bÆ°á»›c cá»±c Ä‘Æ¡n giáº£n.`,400);
    if(ld)ld.style.display='none';if(box){box.textContent=raw.trim();box.style.display='block'}if(btn)btn.style.display='inline-block';
  }catch{
    if(ld)ld.style.display='none';
    const tt=`ğŸ¬ HÆ°á»›ng dáº«n quay TikTok bÃ¡n ${prod}:\n\nBÆ°á»›c 1 ğŸ“± Má»Ÿ camera, Ä‘á»ƒ cháº¿ Ä‘á»™ quay dá»c\nQuay tháº³ng vÃ o sáº£n pháº©m â€” Ã¡nh sÃ¡ng tá»± nhiÃªn lÃ  Ä‘áº¹p nháº¥t!\n\nBÆ°á»›c 2 ğŸ—£ï¸ NÃ³i ngáº¯n gá»n:\n"${prod} hÃ´m nay ${x} cÃ³ hÃ ng rá»“i nha! Cháº¥t lÆ°á»£ng tá»‘t, giÃ¡ há»£p lÃ½ â€” vÃ o láº¥y nhanh!"\n\nBÆ°á»›c 3 âœ… ÄÄƒng lÃªn TikTok\nThÃªm hashtag #${prod.replace(/\s+/g,'')} #tiá»‡mtáº¡phÃ³a â€” ÄÄƒng giá» cao Ä‘iá»ƒm 8h tá»‘i!\n\n${x.charAt(0).toUpperCase()+x.slice(1)} quay xong Ä‘Äƒng luÃ´n nhÃ© ğŸ’š`;
    if(box){box.textContent=tt;box.style.display='block'}if(btn)btn.style.display='inline-block';
  }
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHS={};
function destC(id){if(CHS[id]){try{CHS[id].destroy()}catch{}delete CHS[id]}}
function getChData(){
  if(perChart==='week'){const days=[],thu=[],chi=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}
  if(perChart==='month'){const[y,m]=CUR.split('-'),dIM=new Date(y,m,0).getDate(),days=[],thu=[],chi=[];for(let i=1;i<=dIM;i++){const iso=`${CUR}-${String(i).padStart(2,'0')}`;days.push(String(i));thu.push(FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}
  const so=[...allMKs()].reverse();return{days:so.map(k=>{const[y,mo]=k.split('-');return`T${parseInt(mo)}/${y.slice(2)}`}),thu:so.map(k=>getRev(k)),chi:so.map(k=>getCost(k))};
}
function trunc(s,n=12){return s.length>n?s.slice(0,n)+'â€¦':s}
function doCharts(){
  ['pieC','barC','lineC'].forEach(destC);
  const thu=getRev(CUR),imp=FIN.imports.reduce((s,x)=>s+x.totalAmt,0),cp=FIN.costs.reduce((s,x)=>s+x.amount,0);
  const has=thu>0||imp>0||cp>0;
  document.getElementById('chartEmpty').style.display=has?'none':'block';
  document.getElementById('chartContent').style.display=has?'block':'none';
  if(!has)return;
  const pie=document.getElementById('pieC');
  if(pie)CHS['pieC']=new Chart(pie,{type:'doughnut',data:{labels:['Thu','Nháº­p','Chi phÃ­'],datasets:[{data:[thu,imp,cp],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8},padding:4,boxWidth:10}}}}});
  const names=[...new Set(FIN.imports.map(x=>x.name))].slice(0,5);
  const bd=names.map(n=>({n,v:FIN.imports.filter(x=>x.name===n).reduce((s,x)=>s+x.totalAmt,0)})).sort((a,b)=>b.v-a.v);
  const bar=document.getElementById('barC');
  if(bar)CHS['barC']=new Chart(bar,{type:'bar',data:{labels:bd.length?bd.map(x=>trunc(x.n)):['ChÆ°a cÃ³'],datasets:[{data:bd.length?bd.map(x=>x.v):[0],backgroundColor:['rgba(27,107,58,.8)','rgba(12,84,96,.75)','rgba(133,100,4,.7)','rgba(124,58,237,.65)','rgba(217,79,61,.65)'],borderRadius:5,borderSkipped:false}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>' '+axFmt(c.raw)+'Ä‘'}}},scales:{x:{beginAtZero:true,grid:{color:'rgba(0,0,0,.05)'},ticks:{callback:v=>axFmt(v),font:{size:7}}},y:{grid:{display:false},ticks:{font:{size:8},padding:4}}}}});
  const{days,thu:th,chi:ch}=getChData();
  const line=document.getElementById('lineC');
  if(line)CHS['lineC']=new Chart(line,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:th,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:ch,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8},boxWidth:10}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>axFmt(v),font:{size:8}},grid:{color:'rgba(0,0,0,.05)'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
}
function doHomeChart(){
  destC('homeChart');
  const days=[],thu=[],chi=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}
  const c=document.getElementById('homeChart');if(!c)return;
  CHS['homeChart']=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8},boxWidth:10}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>axFmt(v),font:{size:8}},grid:{color:'rgba(0,0,0,.05)'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
}

// â”€â”€ Compare & Tax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doCompare(){
  const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;
  if(!a||!b||a===b){toast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return}
  const aT=getRev(a),aC=getCost(a),aL=aT-aC,bT=getRev(b),bC=getCost(b),bL=bT-bC;
  const dl=(c,p)=>{const d=c-p,pct=p>0?Math.round(d/p*100):0;return`<div class="cmpd ${d>=0?'dup':'ddn'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`};
  const box=document.getElementById('cmpBox');
  box.innerHTML=`<h3 style="font-size:.82rem;font-weight:800;color:var(--g2);margin-bottom:7px">ğŸ“Š ${mLabel(a)} vs ${mLabel(b)}</h3><div class="cmpgrid"><div class="cmpi"><div class="cmpl">ğŸ“ˆ Thu</div><div class="cmpc">${fmt(aT)}</div><div class="cmpp">${fmt(bT)}</div>${dl(aT,bT)}</div><div class="cmpi"><div class="cmpl">ğŸ“‰ Chi</div><div class="cmpc">${fmt(aC)}</div><div class="cmpp">${fmt(bC)}</div>${dl(aC,bC)}</div><div class="cmpi"><div class="cmpl">ğŸ’¼ LÃ£i</div><div class="cmpc" style="color:${aL>=0?'var(--g)':'var(--r)'}">${(aL>=0?'+':'')+fmt(aL)}</div><div class="cmpp">${(bL>=0?'+':'')+fmt(bL)}</div>${dl(aL,bL)}</div></div>`;
  box.classList.add('on');
}
function buildAllTime(){
  const el=document.getElementById('allTime');if(!el)return;
  const opts=getMonthOpts();
  if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return}
  const rows=opts.map(k=>{const t=getRev(k),c=getCost(k),l=t-c;return`<tr><td>${mLabel(k)}</td><td class="tv">+${fmt(t)}</td><td class="rv">-${fmt(c)}</td><td style="font-weight:800;color:${l>=0?'var(--g)':'var(--r)'}">${(l>=0?'+':'')+fmt(l)}</td></tr>`}).join('');
  const aT=opts.reduce((s,k)=>s+getRev(k),0),aC=opts.reduce((s,k)=>s+getCost(k),0),aL=aT-aC;
  el.innerHTML=`<div class="tblwrap"><table><thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:var(--g2);color:#fff"><td style="padding:6px 7px;font-weight:800">Tá»•ng</td><td style="padding:6px 7px;font-weight:900">+${fmt(aT)}</td><td style="padding:6px 7px;font-weight:900">-${fmt(aC)}</td><td style="padding:6px 7px;font-weight:900;color:${aL>=0?'#A8E6C1':'#FFB3AA'}">${(aL>=0?'+':'')+fmt(aL)}</td></tr></tfoot></table></div>`;
}
function doTax(){
  const pw=document.getElementById('taxProg'),tb=document.getElementById('taxBox');if(!pw||!tb)return;
  const yr=new Date().getFullYear(),yRev=yearRevenue();
  const mo=new Date().getMonth()+1,proj=mo?yRev/mo*12:0,rem=Math.max(0,TAX_TH-yRev);
  const pct=Math.min(100,Math.round(yRev/TAX_TH*100));
  const bc=pct<60?'pb-safe':pct<90?'pb-warn':'pb-dng';
  pw.innerHTML=`<div style="display:flex;justify-content:space-between;font-size:.67rem;margin-bottom:4px"><span style="font-weight:800;color:var(--g2)">ğŸ“Š ÄÃ£ thu ${yr}: ${fmt(yRev)}</span><span style="color:var(--muted)">${pct}%</span></div><div class="progwrap"><div class="progbar ${bc}" style="width:${pct}%">${pct>10?pct+'%':''}</div></div><div style="display:flex;justify-content:space-between;font-size:.64rem;margin-top:3px;color:var(--muted)"><span>0Ä‘</span><span>500 triá»‡u</span></div><div class="g2" style="margin-top:8px"><div style="background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:8px;text-align:center"><div style="font-size:.58rem;font-weight:800;color:var(--muted)">ğŸ’° ÄÃ£ thu</div><div style="font-size:.8rem;font-weight:900;color:var(--g)">${fmt(yRev)}</div></div><div style="background:${rem?'var(--g4)':'var(--rb)'};border:1.5px solid ${rem?'var(--g5)':'var(--r)'};border-radius:8px;padding:8px;text-align:center"><div style="font-size:.58rem;font-weight:800;color:var(--muted)">ğŸ›’ CÃ²n Ä‘Æ°á»£c bÃ¡n</div><div style="font-size:.8rem;font-weight:900;color:${rem?'var(--g)':'var(--r)'}">${fmt(rem)}</div></div></div>`;
  let html='';
  if(yRev>=TAX_TH){const gT=Math.round(yRev*.01),tncn=Math.round((yRev-TAX_TH)*.005);html=`<div class="taxbox tx-dng"><span class="txicon">âš ï¸</span><div class="txmsg">Doanh thu vÆ°á»£t 500 triá»‡u!</div><div class="txdet"><strong>DT ${yr}:</strong> ${fmt(yRev)}<br><strong>GTGT ~1%:</strong> ${fmt(gT)}<br><strong>TNCN =(DT-500tr)Ã—0.5%:</strong> ${fmt(tncn)}<br><strong style="color:var(--r)">Tá»•ng ná»™p: ${fmt(gT+tncn)}</strong><br><br>â†’ Khai táº¡i: <a href="https://canhan.gdt.gov.vn" target="_blank" style="color:var(--g);font-weight:800">canhan.gdt.gov.vn</a> â€” Ã” <strong>[21]</strong>: ${fmt(yRev)}</div></div><div style="background:#FFF8E1;border:2px solid #F5A623;border-radius:12px;padding:10px;text-align:center;margin-bottom:10px"><div style="font-size:.78rem;font-weight:800;color:#7A5200;margin-bottom:4px">ğŸ“‹ Sao chÃ©p Ä‘á»ƒ Ä‘iá»n Ã” [21]</div><div style="font-size:1.2rem;font-weight:900;color:#D94F3D;margin:4px 0">${fmt(yRev)}</div><div style="display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin-top:7px"><button onclick="clip('${yRev}','ğŸ“‹ ÄÃ£ sao chÃ©p!')" style="padding:7px 14px;background:#F5A623;color:#1A2E23;border:none;border-radius:16px;font-weight:800;cursor:pointer;font-size:.76rem;font-family:inherit">ğŸ“‹ Sao chÃ©p</button><a href="https://canhan.gdt.gov.vn" target="_blank" style="padding:7px 14px;background:#1B6B3A;color:#fff;border-radius:16px;font-weight:800;font-size:.76rem;text-decoration:none">ğŸŒ Má»Ÿ trang Thuáº¿</a></div></div>`}
  else if(proj>=TAX_TH)html=`<div class="taxbox tx-warn"><span class="txicon">ğŸ””</span><div class="txmsg">Dá»± bÃ¡o gáº§n Ä‘áº¡t 500 triá»‡u!</div><div class="txdet"><strong>ÄÃ£ thu:</strong> ${fmt(yRev)}<br><strong>Dá»± bÃ¡o cáº£ nÄƒm:</strong> ${fmt(Math.round(proj))}<br><strong>CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm:</strong> ${fmt(rem)}</div></div>`;
  else html=`<div class="taxbox tx-safe"><span class="txicon">ğŸ˜Š</span><div class="txmsg">Báº¡n chÆ°a pháº£i ná»™p thuáº¿!</div><div class="txdet"><strong>ÄÃ£ thu ${yr}:</strong> ${fmt(yRev)}<br><strong>CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm:</strong> ${fmt(rem)}</div></div>`;
  tb.innerHTML=html;
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _hcsv=[];
function renderHist(){
  const months=getMonthOpts(),all=[];
  months.forEach(mk=>{const f=loadFin(mk);f.sales.forEach(x=>all.push({...x,tt:'ban',mk}));f.imports.forEach(x=>all.push({...x,tt:'nhap',mk}));f.costs.forEach(x=>all.push({...x,tt:'chiphi',mk}));(f.adjs||[]).forEach(x=>all.push({...x,tt:'adj',totalAmt:0,amount:0,mk}))});
  all.sort((a,b)=>b.id-a.id);
  const srch=(gv('hSearch')||'').toLowerCase(),tf=gv('hType'),mf=gv('hMon'),df=gv('hFrom'),dt=gv('hTo');
  const ms=document.getElementById('hMon');if(ms){const cv=ms.value;ms.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+months.map(m=>`<option value="${m}"${m===cv?' selected':''}>${mLabel(m)}</option>`).join('')}
  const filtered=all.filter(x=>{const n=(x.name||x.desc||'').toLowerCase();if(srch&&!n.includes(srch))return false;if(tf&&x.tt!==tf)return false;if(mf&&x.mk!==mf)return false;const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(df&&d&&d<df)return false;if(dt&&d&&d>dt)return false;return true});
  _hcsv=filtered;
  const thu=filtered.filter(x=>x.tt==='ban').reduce((s,x)=>s+x.totalAmt,0);
  const chi=filtered.filter(x=>x.tt==='nhap').reduce((s,x)=>s+x.totalAmt,0)+filtered.filter(x=>x.tt==='chiphi').reduce((s,x)=>s+(x.amount||0),0);
  const lai=thu-chi;
  const se=(id,v,c)=>{const e=document.getElementById(id);if(!e)return;e.textContent=v;if(c)e.style.color=c};
  se('hall-thu',fmt(thu));se('hall-chi',fmt(chi));se('hall-lai',(lai>=0?'+':'')+fmt(lai),lai>=0?'var(--g)':'var(--r)');
  const w=document.getElementById('histTable');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch</div>';return}
  const tm={ban:'<span class="tag t-sell">ğŸ’° BÃ¡n</span>',nhap:'<span class="tag t-imp">ğŸ“¦ Nháº­p</span>',chiphi:'<span class="tag t-op">âš¡ Chi phÃ­</span>',adj:'<span class="tag t-adj">âš™ï¸ Äiá»u chá»‰nh</span>'};
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn</th><th>Tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${filtered.map(x=>{const amt=x.tt==='ban'?x.totalAmt:x.tt==='nhap'?x.totalAmt:(x.amount||0);const isAdj=x.tt==='adj';return`<tr class="hrow" onclick="jumpMon('${x.mk}')"><td>${fmtDt(x.date)}</td><td>${tm[x.tt]||''}</td><td>${(x.name||x.desc||'â€”')+(x.unitOut&&x.tt==='ban'?' ('+x.unitOut+')':'')+(isAdj?' (-'+x.qty+')':'')}</td><td class="${x.tt==='ban'?'tv':'rv'}">${isAdj?'â€”':(x.tt==='ban'?'+':'-')+fmt(amt)}</td><td><span class="jbadge">${mLabel(x.mk)}</span></td></tr>`}).join('')}</tbody></table></div>`;
}
function jumpMon(k){CUR=k;FIN=loadFin(k);buildMonthSel();renderAll();goPage('money',document.querySelectorAll('.nb')[1]);toast(`âœ… â†’ ${mLabel(k)}`)}
function exportCSV(){if(!_hcsv.length){toast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u!',true);return}const rows=['NgÃ y,Loáº¡i,TÃªn,Tiá»n,ThÃ¡ng',..._hcsv.map(x=>{const loai=x.tt==='ban'?'BÃ¡n':x.tt==='nhap'?'Nháº­p':x.tt==='chiphi'?'Chi phÃ­':'Äiá»u chá»‰nh';const amt=x.tt==='ban'?x.totalAmt:x.tt==='nhap'?x.totalAmt:(x.amount||0);return`"${x.date}","${loai}","${(x.name||x.desc||'').replace(/"/g,'""')}","${amt}","${x.mk}"`})].join('\n');clip(rows,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function invSumForAI(){
  const inv=computeInv();if(!inv.length)return'Kho trá»‘ng.';
  const out=inv.filter(x=>x.stock===0).map(x=>x.name+(x.unitOut?'('+x.unitOut+')':'')),
    low=inv.filter(x=>x.stock>0&&x.stock<LOW).map(x=>`${x.name}${x.unitOut?'('+x.unitOut+')':''}:${x.stock}`),
    ok=inv.filter(x=>x.stock>=LOW).map(x=>`${x.name}${x.unitOut?'('+x.unitOut+')':''}:${x.stock}`);
  let s='';if(out.length)s+=`Háº¿t:[${out.join(',')}] `;if(low.length)s+=`Sáº¯pHáº¿t:[${low.join(',')}] `;if(ok.length)s+=`Äá»§:[${ok.slice(0,8).join(',')}${ok.length>8?'+'+( ok.length-8):''}]`;return s||'Kho á»•n.';
}
function doAiSt(){
  const el=document.getElementById('aiSt');if(!el)return;
  const inv=computeInv();if(!inv.length){el.textContent='Kho trá»‘ng';return}
  const out=inv.filter(x=>x.stock===0).length,low=inv.filter(x=>x.stock>0&&x.stock<LOW).length,ok=inv.filter(x=>x.stock>=LOW).length;
  const p=[];if(out)p.push(`${out} háº¿t`);if(low)p.push(`${low} sáº¯p háº¿t`);if(ok)p.push(`${ok} Ä‘á»§ hÃ ng`);
  el.textContent=p.join(' Â· ')||'Kho á»•n âœ…';
}
function scrollMsgs(){const m=document.getElementById('msgs');if(m)m.scrollTop=m.scrollHeight}
function useChip(btn){const t=btn.textContent.trim(),i=document.getElementById('chatInp');if(i){i.value=t;i.focus();i.style.height='auto';i.style.height=Math.min(i.scrollHeight,100)+'px'}}
function addMsgRaw(html,role){const m=document.getElementById('msgs');if(!m)return;const d=document.createElement('div');d.className='msg '+role;d.innerHTML=html;m.insertBefore(d,document.getElementById('typing'));scrollMsgs()}
function addMsg(txt,role){addMsgRaw(txt.replace(/\n/g,'<br>'),role)}
function addMsgCfm(txt,data){
  const m=document.getElementById('msgs');if(!m)return;
  const d=document.createElement('div');d.className='msg bot';
  d.innerHTML=txt.replace(/\n/g,'<br>')+`<div class="cpill"><button class="py" onclick="aiCfm(this,true)">âœ… LÆ°u</button><button class="pn" onclick="aiCfm(this,false)">âŒ Bá»</button></div>`;
  d._data=data;m.insertBefore(d,document.getElementById('typing'));scrollMsgs();
}
function aiCfm(btn,yes){const d=btn.closest('.msg');const data=d._data;const p=d.querySelector('.cpill');if(p)p.remove();if(yes&&data)aiProcess(data);else addMsg('ğŸ‘ Bá» qua rá»“i nhÃ©!','bot');scrollMsgs()}
function aiProcess(items){
  if(!Array.isArray(items))return;const today=nowDT();
  items.forEach(it=>{
    const name=(it.item||it.name||'').trim();if(!name)return;
    const qty=parseInt(String(it.quantity||1).replace(/\D/g,''))||1,price=parseInt(String(it.price||0).replace(/\D/g,''))||0;
    const isSale=/(bÃ¡n|thu|sell)/i.test(it.type||'');
    if(isSale)FIN.sales.push({id:Date.now()+Math.random(),name,type:'hangban',qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: '+name,unitOut:''});
    else{FIN.imports.push({id:Date.now()+Math.random(),name,kind:'hangban',qtyIn:qty,unitIn:'',unitOut:'',factor:1,stockAdded:qty,totalAmt:qty*price,date:today});upsertProd({name,kind:'hangban',unitIn:'',unitOut:'',factor:1})}
    persist();
  });
  renderAll();renderInv();doAiSt();renderToday();toast(`âœ… Ghi ${items.length} giao dá»‹ch!`);
}

function sendChat(){
  const inp=document.getElementById('chatInp'),msg=inp?inp.value.trim():'';
  if(!msg)return;
  if(inp){inp.value='';inp.style.height='auto'}
  addMsg(msg,'usr');
  const ty=document.getElementById('typing');if(ty)ty.classList.add('on');scrollMsgs();
  // Giáº£ láº­p Ä‘á»™ trá»… tá»± nhiÃªn 300-600ms
  setTimeout(()=>{
    if(ty)ty.classList.remove('on');
    const res=localAIResponse(msg);
    const yRev=yearRevenue();
    const isTaxQ=/(thuáº¿|ná»™p|tá» khai|gtgt|tncn|500|canhan|Ã´ 21|khai thuáº¿)/i.test(msg);
    if(res.confirm&&res.confirm.length){
      // Giao dá»‹ch cáº§n xÃ¡c nháº­n
      const pv=res.confirm.map(x=>`${/(nháº­p)/i.test(x.type)?'ğŸ“¦':'ğŸ’°'} ${x.quantity} ${x.item}${x.price?' Ã— '+fmt(x.price):''}${/(nháº­p)/i.test(x.type)?' â€” Tá»•ng: '+fmt(x.price*x.quantity):' = '+fmt(x.price*x.quantity)}`).join('\n');
      // Map confirm data cho aiProcess
      const pd=res.confirm.map(x=>({item:x.item,quantity:x.quantity,price:x.price,type:x.type}));
      addMsgCfm(res.text+'\n\n'+pv,pd);
    }else{
      let html=res.text.replace(/\n/g,'<br>');
      if(res.taxCard)html+=buildTaxCard(yRev);
      else if(res.safeTaxCard)html+=buildSafeTaxCard(yRev);
      else if(isTaxQ&&yRev>TAX_TH)html+=buildTaxCard(yRev);
      else if(isTaxQ)html+=buildSafeTaxCard(yRev);
      addMsgRaw(html,'bot');
    }
  },300+Math.random()*300);
}
function askAIInv(){goPage('ai',document.querySelectorAll('.nb')[4]);setTimeout(()=>{const i=document.getElementById('chatInp');if(i){i.value='TÃ¬nh hÃ¬nh kho hiá»‡n táº¡i tháº¿ nÃ o?';i.style.height='auto';sendChat()}},200)}

// â”€â”€ Clipboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function clip(text,msg){
  try{
    if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(text);
    else{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px;opacity:0';document.body.appendChild(ta);ta.focus();ta.select();document.execCommand('copy');document.body.removeChild(ta)}
    if(msg)toast(msg,false,true);return true;
  }catch{if(msg)toast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);return false}
}
async function doCopy(boxId,btnId){const b=document.getElementById(boxId);if(!b)return;const t=b.textContent.trim();if(!t){toast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return}const ok=await clip(t);if(ok){toast('ğŸ“‹ ÄÃ£ sao chÃ©p!');const btn=document.getElementById(btnId);if(btn){const orig=btn.innerHTML;btn.innerHTML='âœ… ÄÃ£ sao chÃ©p!';btn.disabled=true;setTimeout(()=>{btn.innerHTML=orig;btn.disabled=false},2000)}}}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  refreshDates();
  ['sDate','iDate','cpDate','adjDate'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener('change',()=>{el._locked=true;setTimeout(()=>{el._locked=false},600000)})});
  buildMonthSel();renderAll();renderToday();renderHomeRecent();doAiSt();
  setTimeout(doHomeChart,120);
})();
</script>
</body>
</html>
