<!DOCTYPE html>
<html lang="vi">
<head>
<script src="https://unpkg.com/html5-qrcode"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.13);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
  --nav-h:60px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--surface);color:var(--text);
  display:flex;flex-direction:column;height:100%;overflow:hidden}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}

/* â”€â”€ HEADER â”€â”€ */
header{background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;
  padding:10px 16px 8px;text-align:center;flex-shrink:0;
  box-shadow:0 2px 12px rgba(0,0,0,.22);z-index:300}
header h1{font-size:1.2rem;font-weight:800}
header p{font-size:.66rem;opacity:.75;margin-top:1px}
.badge{background:var(--a400);color:#1A2E23;font-size:.56rem;font-weight:900;
  padding:2px 6px;border-radius:20px;margin-left:5px;vertical-align:middle}

/* â”€â”€ API BAR â”€â”€ */
#apiSetup{background:#FFFDE7;border-bottom:2px solid var(--a400);
  padding:6px 12px;display:flex;align-items:center;flex-wrap:wrap;gap:5px;flex-shrink:0}
#apiSetup label{font-size:.72rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:100px;padding:5px 9px;border:2px solid var(--a400);
  border-radius:var(--r-sm);font-size:.82rem}
#apiKeyInput:focus{outline:none;border-color:#D4881A}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:5px 10px;
  border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.76rem}
#apiStatus{font-size:.68rem;width:100%;margin-top:-2px}

/* â”€â”€ MONTH BAR â”€â”€ */
#monthBar{background:var(--card);border-bottom:2px solid var(--border);
  padding:6px 12px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;flex-shrink:0}
#monthBar label{font-size:.7rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:5px 8px;border:2px solid var(--border);border-radius:var(--r-sm);
  font-size:.8rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
.month-badge{font-size:.64rem;background:var(--p50);color:var(--p600);padding:3px 9px;
  border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto}

/* â”€â”€ MAIN SCROLL AREA â”€â”€ */
#mainArea{flex:1;overflow:hidden;position:relative;min-height:0}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch}
.page.active{display:block}
.page-inner{padding:10px;max-width:660px;margin:0 auto;padding-bottom:12px}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{flex-shrink:0;height:var(--nav-h);background:var(--card);
  border-top:2px solid var(--border);display:flex;z-index:400;
  box-shadow:0 -3px 16px rgba(0,0,0,.10)}
.bn-btn{flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:2px;border:none;background:none;cursor:pointer;
  padding:4px 2px;border-top:3px solid transparent;transition:.15s;
  color:var(--muted);font-family:var(--font)}
.bn-btn .ni{font-size:1.2rem;line-height:1}
.bn-btn .nl{font-size:.52rem;font-weight:800;white-space:nowrap}
.bn-btn.active{color:var(--p600);border-top-color:var(--p600);background:var(--p50)}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border-radius:var(--r-md);padding:13px;
  margin-bottom:10px;box-shadow:var(--shadow-sm);border:1px solid var(--border);
  overflow:hidden}
.card-title{font-size:.9rem;font-weight:800;color:var(--p700);margin-bottom:8px;
  display:flex;align-items:center;gap:6px}
.card-sub{font-size:.7rem;color:var(--muted);margin-top:-5px;margin-bottom:8px;line-height:1.6}

/* â”€â”€ FIELDS â”€â”€ */
.field{margin-bottom:8px}
.field label{font-size:.69rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:9px 10px;border:2px solid var(--border);border-radius:var(--r-sm);
  font-size:.86rem;font-family:var(--font);background:#fff;color:var(--text);transition:.15s}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
@media(max-width:400px){.row2,.row3{grid-template-columns:1fr}}

/* â”€â”€ DROPDOWNS â”€â”€ */
.sug-wrap{position:relative}
.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;
  border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);
  z-index:600;max-height:160px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.sug-dropdown.open{display:block}
.sug-opt{padding:8px 11px;cursor:pointer;font-size:.83rem;border-bottom:1px solid var(--border);transition:.12s}
.sug-opt:last-child{border-bottom:none}
.sug-opt:hover{background:var(--p50);color:var(--p600)}
.sug-opt .sug-meta{font-size:.65rem;color:var(--muted);margin-top:1px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{width:100%;padding:11px;border:none;border-radius:var(--r-md);font-size:.86rem;
  font-weight:800;cursor:pointer;transition:.18s;display:flex;align-items:center;
  justify-content:center;gap:6px;margin-bottom:7px;font-family:var(--font)}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.2)}
.btn-primary:hover:not(:disabled){background:var(--p700);transform:translateY(-1px)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-danger{background:var(--red-bg);color:var(--red);border:2px solid #F5C6C0}
.btn-danger:hover:not(:disabled){background:var(--red);color:#fff}
.btn-sm{padding:5px 11px;font-size:.73rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* â”€â”€ UPLOAD â”€â”€ */
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);
  padding:18px 12px;text-align:center;cursor:pointer;transition:.18s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100)}
.upload-area .u-icon{font-size:1.8rem;margin-bottom:4px}
.upload-area strong{display:block;font-size:.82rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.68rem}
.img-preview-box{position:relative;margin-bottom:8px;display:none}
.img-preview-box img{width:100%;max-height:170px;object-fit:cover;
  border-radius:var(--r-sm);border:2px solid var(--p300);display:block}
.img-change-btn{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.55);
  color:#fff;border:none;border-radius:20px;padding:3px 9px;font-size:.68rem;font-weight:800;cursor:pointer}

/* â”€â”€ RESULT/LOADER â”€â”€ */
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);
  padding:11px;margin-top:7px;white-space:pre-wrap;font-size:.8rem;line-height:1.7;
  max-height:240px;overflow-y:auto;display:none;word-break:break-word}
.result-box.show{display:block}
.loader{display:none;text-align:center;padding:14px}
.loader.show{display:block}
.spinner{width:30px;height:30px;border:4px solid var(--p100);border-top:4px solid var(--p600);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 6px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.78rem}
.copy-btn{display:none;align-items:center;gap:5px;background:var(--p50);color:var(--p700);
  border:2px solid var(--p100);padding:6px 12px;border-radius:var(--r-sm);
  font-size:.76rem;font-weight:800;cursor:pointer;margin-top:6px;transition:.18s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);
  padding:8px 11px;font-size:.76rem;color:var(--p700);margin-top:6px;display:none}
.autofill-notice.show{display:block}

/* â”€â”€ SUB-TABS â”€â”€ */
.sub-tabs{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.sub-tab{padding:5px 12px;border:2px solid var(--border);background:#fff;border-radius:30px;
  font-size:.73rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* â”€â”€ SUMMARY STRIP â”€â”€ */
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:9px 6px;
  text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.6rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.s-val{font-size:.88rem;font-weight:900;word-break:break-all}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}

/* â”€â”€ TABLES â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--border);
  max-height:340px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.77rem;min-width:360px}
thead{position:sticky;top:0;z-index:5}
thead tr{background:var(--p600)}
th{padding:7px 8px;text-align:left;color:#fff;font-size:.68rem;font-weight:800;white-space:nowrap}
td{padding:7px 8px;border-bottom:1px solid var(--border);vertical-align:middle;
  word-break:break-word;max-width:160px}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800;white-space:nowrap}
.chi-v{color:var(--red);font-weight:800;white-space:nowrap}
.del-btn{background:none;border:none;cursor:pointer;font-size:.82rem;
  padding:2px 4px;border-radius:5px;transition:.12s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;
  font-size:.63rem;font-weight:800;white-space:nowrap}
.tag-sell{background:#D4EDDA;color:var(--p700)}
.tag-ing{background:#FFF3CD;color:#856404}
.tag-thu{background:#D4EDDA;color:var(--p700)}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-op{background:#FFF3CD;color:#856404}

/* â”€â”€ PERIOD TABS â”€â”€ */
.period-tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.period-tab{padding:4px 11px;border:2px solid var(--border);background:#fff;border-radius:20px;
  font-size:.7rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.period-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.period-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* â”€â”€ BULK BAR â”€â”€ */
.bulk-bar{display:flex;align-items:center;gap:7px;margin-bottom:8px;flex-wrap:wrap}
.bulk-bar input[type=checkbox]{width:14px;height:14px;accent-color:var(--p600);cursor:pointer}
.bulk-bar label{font-size:.74rem;font-weight:800;color:var(--muted);cursor:pointer}
.cb-cell input[type=checkbox]{width:13px;height:13px;accent-color:var(--p600);cursor:pointer}

/* â”€â”€ INVENTORY SMART VIEW â”€â”€ */
.inv-section{margin-bottom:11px}
.inv-section-title{font-size:.78rem;font-weight:900;color:var(--p700);
  margin-bottom:6px;display:flex;align-items:center;gap:5px}
.inv-alert-card{border-radius:var(--r-sm);padding:10px 12px;margin-bottom:6px;
  display:flex;align-items:flex-start;gap:9px;border:2px solid}
.inv-alert-low{background:#FFF8E1;border-color:var(--a400)}
.inv-alert-out{background:var(--red-bg);border-color:var(--red)}
.inv-alert-ok{background:var(--p50);border-color:var(--p300)}
.inv-alert-slow{background:#EEF2FF;border-color:#7C83FD}
.inv-alert-ing{background:#FFFDE7;border-color:#F0CC70}
.inv-alert-icon{font-size:1.3rem;flex-shrink:0}
.inv-alert-body{flex:1;min-width:0}
.inv-alert-name{font-size:.86rem;font-weight:800;word-break:break-word}
.inv-alert-meta{font-size:.68rem;color:var(--muted);margin-top:2px;line-height:1.5}
.inv-alert-qty{font-size:.8rem;font-weight:900;white-space:nowrap;
  padding:3px 8px;border-radius:20px;flex-shrink:0}
.qty-out{background:var(--red-bg);color:var(--red)}
.qty-low{background:#FFF3CD;color:#7A5200}
.qty-ok{background:var(--p50);color:var(--p600)}
.inv-restock-notice{background:var(--a400);color:#1A2E23;border-radius:var(--r-sm);
  padding:8px 12px;font-size:.76rem;font-weight:800;margin-bottom:9px;
  display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.inv-ask-btn{width:100%;padding:10px;background:var(--p600);color:#fff;border:none;
  border-radius:var(--r-md);font-size:.85rem;font-weight:800;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:7px;margin-top:4px;transition:.18s}
.inv-ask-btn:hover{background:var(--p700)}

/* â”€â”€ INVOICE TABLE â”€â”€ */
.invoice-table-wrap{margin-top:8px;overflow-x:auto;display:none}
.invoice-table-wrap.show{display:block}
.inv-tbl{width:100%;border-collapse:collapse;font-size:.79rem;min-width:320px}
.inv-tbl th{background:var(--p600);color:#fff;padding:7px 8px;font-size:.7rem;font-weight:800;text-align:left;white-space:nowrap}
.inv-tbl td{padding:7px 8px;border-bottom:1px solid var(--border);word-break:break-word}
.inv-tbl tr:last-child td{border-bottom:none}
.inv-tbl tr:nth-child(even) td{background:var(--p50)}

/* â”€â”€ UNIT CONVERSION BOX â”€â”€ */
.conv-box{background:#EEF2FF;border:2px solid #7C83FD;border-radius:var(--r-sm);
  padding:10px 12px;margin-top:8px;font-size:.78rem;line-height:1.7;display:none}
.conv-box.show{display:block}
.conv-box strong{color:#4F46E5}

/* â”€â”€ PLANS â”€â”€ */
.plan-item{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);
  padding:9px 11px;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.plan-body{flex:1;min-width:0}
.plan-name{font-size:.83rem;font-weight:800;color:var(--p700);word-break:break-word}
.plan-meta{font-size:.69rem;color:var(--muted);margin-top:2px}
.plan-amount{font-size:.88rem;font-weight:900;color:var(--red);white-space:nowrap}
.plan-del{background:none;border:none;cursor:pointer;font-size:.82rem;
  color:var(--subtle);padding:3px 4px;border-radius:5px;transition:.12s}
.plan-del:hover{background:var(--red-bg);color:var(--red)}

/* â”€â”€ COMPARE â”€â”€ */
.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);
  padding:12px;margin-bottom:10px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.83rem;font-weight:800;color:var(--p700);margin-bottom:8px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:8px 4px;border:1px solid var(--border)}
.cmp-lbl{font-size:.6rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmp-cur{font-size:.8rem;font-weight:900;color:var(--p700)}
.cmp-prev{font-size:.66rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.66rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}

/* â”€â”€ CHARTS â”€â”€ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
@media(max-width:480px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:10px;border:1px solid var(--border)}
.ch-card h3{font-size:.72rem;font-weight:800;color:var(--p700);margin-bottom:6px;text-align:center}
.ch-wrap{position:relative;height:140px}
.ch-full{position:relative;height:160px}

/* â”€â”€ HISTORY FILTERS â”€â”€ */
.history-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:9px;align-items:center}
.history-filters input,.history-filters select{padding:6px 9px;border:2px solid var(--border);
  border-radius:var(--r-sm);font-size:.77rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:100px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.hist-row-clickable{cursor:pointer;transition:.12s}
.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);
  border:1px solid var(--p100);border-radius:6px;font-size:.6rem;padding:1px 5px;font-weight:800}

/* â”€â”€ AI CHAT â”€â”€ */
.ai-status-bar{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);
  padding:7px 11px;margin-bottom:9px;font-size:.76rem;color:var(--p700);
  display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.ai-status-bar strong{color:var(--p800)}
.chat-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;
  box-shadow:var(--shadow-md);border:1px solid var(--border);display:flex;flex-direction:column}
.chat-head{background:var(--p600);color:#fff;padding:10px 13px;
  display:flex;align-items:center;gap:8px;flex-shrink:0}
.chat-av{width:30px;height:30px;border-radius:50%;background:var(--a400);
  display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.chat-title{font-weight:800;font-size:.85rem}
.chat-status{font-size:.61rem;opacity:.74}
.chat-msgs{padding:10px;height:260px;overflow-y:auto;overflow-x:hidden;
  display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.msg{max-width:90%;padding:8px 11px;border-radius:13px;font-size:.81rem;
  line-height:1.6;word-break:break-word}
.msg.bot{background:var(--p50);border:1.5px solid var(--p100);
  align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:var(--p600);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{display:none;align-self:flex-start}.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:7px 11px;background:var(--p50);
  border:1.5px solid var(--p100);border-radius:13px;border-bottom-left-radius:4px}
.dot{width:5px;height:5px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.chat-foot{display:flex;gap:5px;padding:8px 10px;border-top:2px solid var(--border);
  background:var(--surface);flex-shrink:0}
.chat-inp{flex:1;padding:8px 10px;border:2px solid var(--border);
  border-radius:var(--r-sm);font-size:.82rem;font-family:var(--font);min-width:0}
.chat-inp:focus{outline:none;border-color:var(--p600)}
.chat-send{background:var(--p600);color:#fff;border:none;padding:8px 13px;
  border-radius:var(--r-sm);font-size:.88rem;cursor:pointer;transition:.15s;flex-shrink:0}
.chat-send:hover{background:var(--p700)}
.confirm-pill{display:inline-flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.confirm-pill button{padding:6px 13px;border-radius:20px;font-size:.78rem;font-weight:800;
  cursor:pointer;border:2px solid;transition:.15s;font-family:var(--font)}
.pill-yes{background:var(--p600);color:#fff;border-color:var(--p600)}
.pill-yes:hover{background:var(--p700)}
.pill-no{background:#fff;color:var(--red);border-color:var(--red)}
.pill-no:hover{background:var(--red);color:#fff}

/* â”€â”€ TAX â”€â”€ */
.tax-box{border-radius:var(--r-md);padding:14px;margin-bottom:11px;border:3px solid}
.tax-safe{background:#E8F5E9;border-color:#4CAF50}
.tax-warn{background:#FFF8E1;border-color:var(--a400)}
.tax-danger{background:var(--red-bg);border-color:var(--red)}
.tax-box .tx-icon{font-size:1.8rem;margin-bottom:5px;display:block;text-align:center}
.tax-box .tx-msg{font-size:1.1rem;font-weight:800;line-height:1.5;text-align:center;margin-bottom:7px}
.tax-safe .tx-msg{color:#2E7D32}.tax-warn .tx-msg{color:#7A5200}.tax-danger .tx-msg{color:var(--red)}
.tax-box .tx-detail{font-size:.8rem;color:var(--muted);line-height:1.8;
  background:rgba(255,255,255,.6);border-radius:var(--r-sm);padding:8px 10px;margin-top:5px}
.tax-box .tx-detail strong{color:var(--text)}
.tax-amount{font-size:1.4rem;font-weight:900;color:var(--red);text-align:center;display:block;margin:5px 0}

/* â”€â”€ MODAL â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:900;align-items:flex-end;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg) var(--r-lg) 0 0;padding:16px;
  width:100%;max-width:500px;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto}
.modal h3{font-size:.92rem;font-weight:800;color:var(--p700);margin-bottom:9px}
.modal-btns{display:flex;gap:7px;margin-top:11px}
.modal-btns button{flex:1;padding:10px;border-radius:var(--r-sm);font-weight:800;
  font-size:.82rem;cursor:pointer;border:none;transition:.15s;font-family:var(--font)}
.modal-cancel{background:var(--surface);color:var(--muted);border:2px solid var(--border)!important}
.modal-confirm{background:var(--red);color:#fff}
.modal-confirm:hover{background:#b03a2e}
.stock-alert-modal{border:3px solid var(--red)}
.stock-alert-modal h3{color:var(--red);font-size:1rem}
.stock-alert-msg{font-size:1rem;font-weight:700;color:var(--red);line-height:1.6;padding:9px 0;text-align:center}

/* â”€â”€ EMPTY / TOAST â”€â”€ */
.empty{text-align:center;color:var(--muted);padding:20px 10px;font-size:.8rem}
.empty .ei{font-size:1.8rem;margin-bottom:5px}
#toast{position:fixed;bottom:70px;left:50%;
  transform:translateX(-50%) translateY(100px);background:var(--p700);color:#fff;
  padding:10px 20px;border-radius:30px;font-size:.86rem;font-weight:700;z-index:9999;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);opacity:0;
  max-width:92vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--red)}
#toast.ok{background:#27AE60}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Há»‡ thá»‘ng quáº£n lÃ½ kinh doanh thá»±c táº¿</p>
</header>

<div id="apiSetup">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <p id="apiStatus"></p>
</div>

<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>

<div id="mainArea">

<!-- HOME -->
<div id="page-home" class="page active">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="h-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="h-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="h-profit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y gáº§n nháº¥t</div>
    <div class="ch-full"><canvas id="homeLineChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div>
    <div id="homeRecentWrap"></div>
  </div>
</div>
</div>

<!-- THU / CHI -->
<div id="page-money" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="m-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="m-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="m-profit">0Ä‘</div></div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('inc',this)">ğŸ’° BÃ¡n hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('imp',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('op',this)">âš¡ Chi phÃ­</button>
    <button class="sub-tab" onclick="switchSub('inv',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="sub-tab" onclick="switchSub('plan',this)">ğŸ“‹ Káº¿ hoáº¡ch</button>
  </div>

  <!-- BÃN HÃ€NG -->
  <div id="msub-inc">
    <div class="card">
      <div class="card-title">ğŸ“· QuÃ©t Bill thanh toÃ¡n</div>
      <div class="upload-area" onclick="document.getElementById('incInvoiceFile').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p bill Ä‘Ã£ thanh toÃ¡n</strong><small>AI Ä‘á»c vÃ  Ä‘iá»n vÃ o form</small>
      </div>
      <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
      <div class="img-preview-box" id="incImgPreviewBox">
        <img id="incInvoicePreview"/>
        <button class="img-change-btn" onclick="resetIncImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:7px">ğŸ¤– AI Ä‘á»c bill</button>
      <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c bill...</p></div>
      <div class="autofill-notice" id="incAutofillNotice">âœ… ÄÃ£ Ä‘iá»n â€” kiá»ƒm tra rá»“i báº¥m "XÃ¡c nháº­n bÃ¡n"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="card-sub">Chá»‰ hiá»ƒn thá»‹ hÃ ng <strong>resell</strong> â€” hÃ ng tá»“n kho Ä‘á»§ má»›i bÃ¡n Ä‘Æ°á»£c</div>
      <div class="field">
        <label>ğŸ›’ Chá»n sáº£n pháº©m bÃ¡n</label>
        <div class="sug-wrap">
          <input class="inp" id="incSellName" placeholder="GÃµ tÃªn sáº£n pháº©m..." autocomplete="off"
            oninput="onSellSug()" onfocus="onSellSug()" onblur="setTimeout(closeSellSug,200)"/>
          <div class="sug-dropdown" id="sellSugDrop"></div>
        </div>
      </div>
      <div id="stockInfoBox" style="display:none;background:var(--p50);border:1.5px solid var(--p300);
        border-radius:var(--r-sm);padding:8px 11px;font-size:.78rem;color:var(--p700);margin-bottom:8px">
      </div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="incDesc" placeholder="VD: KhÃ¡ch quen, combo..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng (Ä‘Æ¡n vá»‹ bÃ¡n)</label>
          <input class="inp" type="text" id="incQty" placeholder="0"
            oninput="handleMoney(this);updateSellTotal()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’µ ÄÆ¡n giÃ¡ bÃ¡n</label>
          <input class="inp" type="text" id="incUnitPrice" placeholder="0 Ä‘"
            oninput="handleMoney(this);updateSellTotal()" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div id="sellTotalBox" style="display:none;background:#E8F5E9;border:1.5px solid var(--p300);
        border-radius:var(--r-sm);padding:7px 11px;font-size:.8rem;color:var(--p700);font-weight:800;margin-bottom:8px"></div>
      <div class="field"><label>ğŸ“… NgÃ y bÃ¡n</label><input class="inp" type="date" id="incDate"/></div>
      <button class="btn btn-primary" onclick="addSale()">âœ… XÃ¡c nháº­n bÃ¡n (trá»« kho)</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('inc','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('inc','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('inc','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('inc','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="incSelectAll" onchange="toggleSelectAll('inc',this.checked)">
        <label for="incSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('inc')" id="incBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('inc')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="incTableWrap"></div>
    </div>
  </div>

  <!-- NHáº¬P HÃ€NG -->
  <div id="msub-imp" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="upload-area" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p hÃ³a Ä‘Æ¡n nhÃ  cung cáº¥p</strong><small>AI trÃ­ch xuáº¥t danh sÃ¡ch hÃ ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <div class="img-preview-box" id="expImgPreviewBox">
        <img id="invoicePreview"/>
        <button class="img-change-btn" onclick="resetExpImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:7px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="invoiceTableWrap"></div>
      <div id="invActions" style="display:none;gap:5px;margin-top:7px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ Xuáº¥t CSV</button>
        <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Äiá»n vÃ o form</button>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… ÄÃ£ Ä‘iá»n â€” kiá»ƒm tra rá»“i báº¥m "Nháº­p hÃ ng"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng vÃ o kho</div>
      <div class="row2">
        <div class="field">
          <label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onImpSug()" onfocus="onImpSug()" onblur="setTimeout(closeImpSug,200)"/>
            <div class="sug-dropdown" id="impSugDrop"></div>
          </div>
        </div>
        <div class="field"><label>ğŸ“‚ Loáº¡i hÃ ng</label>
          <select class="inp" id="impType" onchange="toggleIngMode()">
            <option value="resell">ğŸ›’ BÃ¡n trá»±c tiáº¿p (resell)</option>
            <option value="ingredient">ğŸ§‚ NguyÃªn liá»‡u (ingredient)</option>
          </select>
        </div>
      </div>
      <!-- ÄÆ¡n vá»‹ quy Ä‘á»•i â€” chá»‰ hiá»‡n cho resell -->
      <div id="convFields">
        <div class="row3">
          <div class="field"><label>ğŸ“¦ ÄÆ¡n vá»‹ nháº­p</label>
            <input class="inp" type="text" id="impUnitIn" placeholder="thÃ¹ng, kÃ©t, kg..."/></div>
          <div class="field"><label>ğŸ·ï¸ ÄÆ¡n vá»‹ bÃ¡n</label>
            <input class="inp" type="text" id="impUnitOut" placeholder="gÃ³i, chai, gram..."/></div>
          <div class="field"><label>ğŸ”¢ Há»‡ sá»‘ (1 nháº­p = ? bÃ¡n)</label>
            <input class="inp" type="text" id="impConvFactor" placeholder="30"
              oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        </div>
        <div class="conv-box" id="convPreview"></div>
      </div>
      <div class="row2">
        <div class="field"><label>ğŸ“¥ Sá»‘ lÆ°á»£ng nháº­p (Ä‘Æ¡n vá»‹ nháº­p)</label>
          <input class="inp" type="text" id="impQty" placeholder="0"
            oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° ThÃ nh tiá»n (tá»•ng lÃ´)</label>
          <input class="inp" type="text" id="impAmount" placeholder="0 Ä‘"
            oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="date" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()">â• Nháº­p hÃ ng vÃ o kho</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ nháº­p hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('exp','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('exp','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('exp','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('exp','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="expSelectAll" onchange="toggleSelectAll('exp',this.checked)">
        <label for="expSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('exp')" id="expBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('exp')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="expTableWrap"></div>
    </div>
  </div>

  <!-- CHI PHÃ -->
  <div id="msub-op" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, váº­n chuyá»ƒn â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field"><label>ğŸ“‚ Loáº¡i chi phÃ­</label>
        <select class="inp" id="opType">
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="opDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label>
          <input class="inp" type="text" id="opAmount" placeholder="0 Ä‘"
            oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="opDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addOperational()">â• ThÃªm chi phÃ­</button>
    </div>
  </div>

  <!-- Tá»’N KHO -->
  <div id="msub-inv" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ—„ï¸ Tá»“n kho thÃ´ng minh</div>
      <div class="card-sub">Tá»“n kho tÃ­nh báº±ng <strong>Ä‘Æ¡n vá»‹ bÃ¡n</strong>. ğŸ”´ Háº¿t Â· ğŸŸ¡ &lt;5 Â· ğŸŸ¢ Äá»§</div>
      <div id="inventorySmartView"></div>
      <button class="inv-ask-btn" onclick="askAIAboutInventory()">ğŸ¤– Há»i trá»£ lÃ½ vá» tÃ¬nh hÃ¬nh kho</button>
    </div>
  </div>

  <!-- Káº¾ HOáº CH -->
  <div id="msub-plan" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“‹ Káº¿ hoáº¡ch chi / nháº­p hÃ ng</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn káº¿ hoáº¡ch</label><input class="inp" type="text" id="planName" placeholder="VD: Nháº­p 50 thÃ¹ng bia..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“‚ Loáº¡i</label>
          <select class="inp" id="planType">
            <option value="import">ğŸ“¦ Nháº­p hÃ ng</option>
            <option value="utility">ğŸ”Œ Äiá»‡n/NÆ°á»›c</option>
            <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
            <option value="rental">ğŸª Máº·t báº±ng</option>
            <option value="other">ğŸ“Œ KhÃ¡c</option>
          </select>
        </div>
        <div class="field"><label>ğŸ’µ Dá»± kiáº¿n</label>
          <input class="inp" type="text" id="planAmount" placeholder="0 Ä‘"
            oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="planNote" placeholder="Ghi chÃº..."/></div>
      <button class="btn btn-primary" onclick="addPlan()">â• ThÃªm káº¿ hoáº¡ch</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“… Danh sÃ¡ch káº¿ hoáº¡ch</div><div id="planList"></div></div>
  </div>
</div>
</div>

<!-- QUáº¢NG BÃ -->
<div id="page-promo" class="page">
<div class="page-inner">
  <div class="card" style="background:#FFF8E1;border:2px solid var(--a400)">
    <div class="card-title">ğŸ“£ Marketing â€” KhÃ´ng lÆ°u kho</div>
    <div class="card-sub">áº¢nh á»Ÿ Ä‘Ã¢y <strong>KHÃ”NG</strong> lÆ°u kho. ÄÆ¡n hÃ ng tháº­t â†’ Tab <strong>Thu/Chi</strong>.</div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchPromoSub('fb',this)">ğŸ“£ BÃ i FB</button>
    <button class="sub-tab" onclick="switchPromoSub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="psub-fb">
    <div class="card">
      <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook</div>
      <div class="upload-area" onclick="document.getElementById('fbImgInput').click()">
        <div class="u-icon">ğŸ–¼ï¸</div><strong>Chá»n áº£nh sáº£n pháº©m</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i</small>
      </div>
      <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
      <div class="img-preview-box" id="fbImgPreviewBox">
        <img id="fbPreview"/><button class="img-change-btn" onclick="resetFbImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateFbPost()" id="fbPostBtn" disabled>ğŸ¤– AI viáº¿t bÃ i Facebook</button>
    <div class="card" id="fbResultCard" style="display:none">
      <div class="card-title">âœï¸ BÃ i Ä‘Äƒng</div>
      <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t...</p></div>
      <div class="result-box" id="fbPost"></div>
      <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
  <div id="psub-tt" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateScript()" id="scriptBtn">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n quay</button>
    <div class="card" id="videoResult" style="display:none">
      <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n quay</div>
      <div class="loader" id="videoLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="result-box" id="scriptBox"></div>
      <button class="copy-btn" id="copyScript" onclick="doCopy('scriptBox','copyScript')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- BÃO CÃO -->
<div id="page-reports" class="page">
<div class="page-inner">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchReportSub('chart',this)">ğŸ“Š BÃ¡o cÃ¡o</button>
    <button class="sub-tab" onclick="switchReportSub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="sub-tab" onclick="switchReportSub('tax',this)">ğŸ§¾ Thuáº¿</button>
  </div>
  <div id="rsub-chart">
    <div class="period-tabs">
      <button class="period-tab active" onclick="setChartPeriod('week',this)">7 ngÃ y</button>
      <button class="period-tab" onclick="setChartPeriod('month',this)">ThÃ¡ng</button>
      <button class="period-tab" onclick="setChartPeriod('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o â€” <span id="chartMonthLabel" style="font-weight:400;font-size:.77rem;color:var(--muted)"></span></div>
      <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="charts-grid">
          <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
          <div class="ch-card"><h3>ğŸ“¦ Nháº­p hÃ ng</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        </div>
        <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rsub-compare" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“ˆ So sÃ¡nh cÃ¡c thÃ¡ng</div>
      <div class="row2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-primary" onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="compare-box" id="compareBox"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£ thá»i gian</div>
      <div id="allTimeCompare"></div>
      <button class="btn btn-secondary" style="margin-top:7px" onclick="buildAllTimeCompare()">ğŸ”„ Cáº­p nháº­t</button>
    </div>
  </div>
  <div id="rsub-tax" style="display:none">
    <div id="taxAssistantBox"></div>
    <div class="card">
      <div class="card-sub" style="font-size:.74rem;color:var(--muted);line-height:1.8;margin:0">
        <strong>ğŸ“Œ Quy Ä‘á»‹nh thuáº¿ 2026:</strong><br>
        â€¢ Doanh thu â‰¤ 500 triá»‡u/nÄƒm â†’ <strong>Miá»…n thuáº¿</strong><br>
        â€¢ Doanh thu > 500 triá»‡u/nÄƒm â†’ Thuáº¿ khoÃ¡n <strong>1.5%</strong>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="renderTaxAssistant()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
</div>
</div>

<!-- AI -->
<div id="page-ai" class="page">
<div class="page-inner">
  <div class="ai-status-bar" id="aiStatusBar">
    <span>ğŸ“¦</span><span id="aiInvSummary">Äang táº£i dá»¯ liá»‡u kho...</span>
  </div>
  <div class="card" style="background:var(--p50);border:2px solid var(--p100);margin-bottom:9px">
    <div class="card-title">ğŸ¤– Trá»£ lÃ½ nháº­p liá»‡u AI</div>
    <div class="card-sub">Nháº¯n Ä‘á»ƒ ghi giao dá»‹ch hoáº·c há»i sá»‘ liá»‡u:<br>
      â€¢ "BÃ¡n 5 gÃ³i mÃ¬ 15k" Â· "Nháº­p 2 thÃ¹ng bia 300k"<br>â€¢ "Kho cÃ²n gÃ¬?" Â· "ThÃ¡ng nÃ y lÃ£i bao nhiÃªu?"
    </div>
  </div>
  <div class="chat-box">
    <div class="chat-head">
      <div class="chat-av">ğŸŒ¿</div>
      <div><div class="chat-title">Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</div><div class="chat-status" id="chatStatusDot">â— Sáºµn sÃ ng</div></div>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg bot">ğŸ‘‹ ChÃ o! MÃ¬nh cÃ³ thá»ƒ:<br>â€¢ Ghi <strong>bÃ¡n/nháº­p</strong> hÃ ng ngay láº­p tá»©c<br>â€¢ Tra <strong>tá»“n kho</strong> vÃ  sá»‘ liá»‡u<br>â€¢ TÆ° váº¥n kinh doanh</div>
      <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
    </div>
    <div class="chat-foot">
      <input class="chat-inp" id="chatInp" placeholder="Nháº¯n: BÃ¡n 5 gÃ³i mÃ¬..." onkeydown="if(event.key==='Enter')sendChat()"/>
      <button class="chat-send" onclick="sendChat()">â¤</button>
    </div>
  </div>
</div>
</div>

<!-- Lá»ŠCH Sá»¬ -->
<div id="page-history" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="histAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="histAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="histAllProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m tÃªn hÃ ng..." oninput="renderHistory()"/>
      <select id="histTypeFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="sale">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="import">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="op">âš¡ Chi phÃ­</option>
      </select>
      <select id="histMonthFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ thÃ¡ng</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="exportFilteredCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>
</div>

</div><!-- /mainArea -->

<nav class="bottom-nav">
  <button class="bn-btn active" onclick="switchPage('home',this)"><span class="ni">ğŸ </span><span class="nl">Tá»•ng quan</span></button>
  <button class="bn-btn" onclick="switchPage('money',this)"><span class="ni">ğŸ’°</span><span class="nl">Thu/Chi</span></button>
  <button class="bn-btn" onclick="switchPage('promo',this)"><span class="ni">ğŸ“£</span><span class="nl">Quáº£ng bÃ¡</span></button>
  <button class="bn-btn" onclick="switchPage('reports',this)"><span class="ni">ğŸ“Š</span><span class="nl">BÃ¡o cÃ¡o</span></button>
  <button class="bn-btn" onclick="switchPage('ai',this)"><span class="ni">ğŸ¤–</span><span class="nl">AI</span></button>
  <button class="bn-btn" onclick="switchPage('history',this)"><span class="ni">ğŸ“š</span><span class="nl">Lá»‹ch sá»­</span></button>
</nav>

<!-- MODALS -->
<div class="overlay" id="confirmOverlay">
  <div class="modal">
    <h3 id="confirmTitle">XÃ¡c nháº­n</h3>
    <p id="confirmMsg" style="font-size:.82rem;color:var(--muted);line-height:1.6"></p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeConfirm()">Huá»·</button>
      <button class="modal-confirm" id="confirmOkBtn">XÃ¡c nháº­n</button>
    </div>
  </div>
</div>
<div class="overlay" id="stockAlertOverlay">
  <div class="modal stock-alert-modal">
    <h3>âš ï¸ Tá»“n kho khÃ´ng Ä‘á»§!</h3>
    <div class="stock-alert-msg" id="stockAlertMsg"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeStockAlert()">Huá»· bá» giao dá»‹ch</button>
      <button style="flex:1;padding:10px;border-radius:var(--r-sm);font-weight:800;font-size:.82rem;
        cursor:pointer;background:var(--a400);color:#1A2E23;border:none" onclick="forceConfirmSale()">Váº«n ghi nháº­n</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GEMINI_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent';
const TAX_RATE=0.015;
const TAX_THRESHOLD=500_000_000;
const LOW_STOCK=5;
const TODAY=()=>new Date().toISOString().slice(0,10);
const getCurMonthKey=()=>new Date().toISOString().slice(0,7);

let API_KEY=localStorage.getItem('tt40_key')||'';
let currentMonth=getCurMonthKey();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA SCHEMA
   finance-YYYY-MM = {
     sales:   [{id,name,qty,unitPrice,totalAmt,date,desc,unitOut}],
     imports: [{id,name,type,qtyIn,unitIn,unitOut,convFactor,stockAdded,totalAmt,date}],
     ops:     [{id,desc,amount,type,date}],
     plans:   [{id,name,amount,type,note}]
   }
   products (global) = [{name,type,unitIn,unitOut,convFactor,lastPrice}]
   inventory (global, computed) â€” NOT stored, always recomputed
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Finance data (per month) â”€â”€
function getFinKey(mk){return'finance-'+mk;}
function loadFinance(mk){
  try{
    const r=localStorage.getItem(getFinKey(mk));
    if(!r)return emptyFinance();
    const d=JSON.parse(r);
    ['sales','imports','ops','plans'].forEach(k=>{if(!d[k])d[k]=[];});
    return d;
  }catch{return emptyFinance();}
}
function saveFinance(mk,data){localStorage.setItem(getFinKey(mk),JSON.stringify(data));}
function emptyFinance(){return{sales:[],imports:[],ops:[],plans:[]};}

let FIN=loadFinance(currentMonth);
function persist(){saveFinance(currentMonth,FIN);}

// â”€â”€ Products catalogue (global) â”€â”€
function loadProducts(){try{return JSON.parse(localStorage.getItem('tt40_products')||'[]');}catch{return[];}}
function saveProducts(arr){localStorage.setItem('tt40_products',JSON.stringify(arr));}
function upsertProduct(p){
  const arr=loadProducts();
  const idx=arr.findIndex(x=>x.name===p.name);
  if(idx>=0)arr[idx]={...arr[idx],...p};
  else arr.push(p);
  saveProducts(arr);
}
function getProduct(name){return loadProducts().find(x=>x.name===name)||null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVENTORY ENGINE
   Inventory is ALWAYS recomputed from all imports and sales across ALL months
   so it's always accurate regardless of month filter.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function computeInventory(){
  // Collect all months that have data
  const months=getAllMonthKeys();
  const map={}; // name â†’ {name,type,unitIn,unitOut,convFactor,stockSellUnits,totalImportedSellUnits,totalSoldUnits,lastPrice,lastInDate}

  months.forEach(mk=>{
    const fin=loadFinance(mk);
    // Process imports
    fin.imports.forEach(imp=>{
      if(!map[imp.name]){
        map[imp.name]={
          name:imp.name,type:imp.type||'resell',
          unitIn:imp.unitIn||'',unitOut:imp.unitOut||imp.unitIn||'',
          convFactor:imp.convFactor||1,
          stockSellUnits:0,totalImportedSellUnits:0,totalSoldUnits:0,
          lastPrice:0,lastInDate:null
        };
      }
      const stockAdded=imp.stockAdded||imp.qtyIn*(imp.convFactor||1);
      map[imp.name].stockSellUnits+=stockAdded;
      map[imp.name].totalImportedSellUnits+=stockAdded;
      if(imp.totalAmt>0)map[imp.name].lastPrice=Math.round(imp.totalAmt/(imp.qtyIn*(imp.convFactor||1)));
      if(!map[imp.name].lastInDate||imp.date>map[imp.name].lastInDate)map[imp.name].lastInDate=imp.date;
      // Update meta
      map[imp.name].unitIn=imp.unitIn||map[imp.name].unitIn;
      map[imp.name].unitOut=imp.unitOut||map[imp.name].unitOut;
      map[imp.name].convFactor=imp.convFactor||map[imp.name].convFactor;
      map[imp.name].type=imp.type||map[imp.name].type;
    });
    // Process sales (only resell items consumed from stock)
    fin.sales.forEach(s=>{
      if(map[s.name]&&map[s.name].type==='resell'){
        map[s.name].stockSellUnits=Math.max(0,map[s.name].stockSellUnits-s.qty);
        map[s.name].totalSoldUnits+=s.qty;
      }
    });
  });

  return Object.values(map);
}

function getStock(name){
  const inv=computeInventory();
  const item=inv.find(x=>x.name===name);
  return item?{stock:item.stockSellUnits,unitOut:item.unitOut,type:item.type}:{stock:0,unitOut:'',type:'resell'};
}

function getAllMonthKeys(){
  const keys=new Set();
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith('finance-2'))keys.add(k.replace('finance-',''));
  });
  keys.add(currentMonth);
  return[...keys].sort();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const monthLabel=k=>{const[y,m]=k.split('-');return`ThÃ¡ng ${parseInt(m)}/${y}`;};
function getMonthOpts(){
  const k=new Set();
  for(let i=0;i<4;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);k.add(d.toISOString().slice(0,7));}
  getAllMonthKeys().forEach(mk=>k.add(mk));
  return[...k].sort().reverse();
}
function buildMonthSelect(){
  const cur=getCurMonthKey(),opts=getMonthOpts();
  const sel=document.getElementById('monthSelect');
  if(!sel)return;
  sel.innerHTML=opts.map(k=>`<option value="${k}"${k===currentMonth?' selected':''}>${monthLabel(k)}${k===cur?' â­':''}</option>`).join('');
  const mb=document.getElementById('monthBadge');
  if(mb)mb.textContent=currentMonth===cur?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':monthLabel(currentMonth);
  const cl=document.getElementById('chartMonthLabel');
  if(cl)cl.textContent=monthLabel(currentMonth);
  ['cmpA','cmpB'].forEach((id,i)=>{
    const el=document.getElementById(id);if(!el)return;
    el.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');
    if(i===1&&opts.length>1)el.value=opts[1];
  });
}
function switchMonth(k){
  currentMonth=k;FIN=loadFinance(k);
  buildMonthSelect();renderAll();
  if(document.getElementById('page-reports').classList.contains('active'))setTimeout(refreshCharts,80);
  if(document.getElementById('page-history').classList.contains('active'))renderHistory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveApiKey(){
  const v=document.getElementById('apiKeyInput').value.trim();
  if(!v){showSt('âš ï¸ Nháº­p key!','#c62828');return;}
  API_KEY=v;localStorage.setItem('tt40_key',v);
  showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');
  document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';
}
function showSt(m,c){const e=document.getElementById('apiStatus');if(e){e.textContent=m;e.style.color=c;}}
if(API_KEY){document.getElementById('apiKeyInput').value=API_KEY;showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE / TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='home'){renderSummary();renderHomeRecent();setTimeout(refreshHomeChart,80);}
  if(name==='reports')setTimeout(refreshCharts,80);
  if(name==='history')renderHistory();
  if(name==='ai')updateAIStatusBar();
}
function switchSub(name,btn){
  ['inc','imp','op','inv','plan'].forEach(n=>{const e=document.getElementById('msub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-money .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='inv')renderInventory();
  if(name==='plan')renderPlans();
}
function switchPromoSub(name,btn){
  ['fb','tt'].forEach(n=>{const e=document.getElementById('psub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-promo .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}
function switchReportSub(name,btn){
  ['chart','compare','tax'].forEach(n=>{const e=document.getElementById('rsub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-reports .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='chart')setTimeout(refreshCharts,80);
  if(name==='compare')buildAllTimeCompare();
  if(name==='tax')renderTaxAssistant();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleMoney(el){const d=(el.value||'').replace(/\D/g,'');el.dataset.raw=d;el.value=d?parseInt(d,10).toLocaleString('vi-VN'):'';}
function blockNonDigit(e){if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault();}
function getRaw(id){const el=document.getElementById(id);return el?parseInt((el.dataset.raw||'0').replace(/\D/g,'')||'0',10)||0:0;}
function getVal(id){const el=document.getElementById(id);return el?(el.value||'').trim():'';}
function setVal(id,v){const el=document.getElementById(id);if(el)el.value=v;}
function clearFields(...ids){ids.forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.dataset.raw='';}});}
const fmt=n=>(n||0).toLocaleString('vi-VN')+'Ä‘';
const fmtD=d=>{try{const[,m,day]=d.split('-');return`${day}/${m}`;}catch{return d||'';}};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNIT CONVERSION HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConvPreview(){
  const box=document.getElementById('convPreview');if(!box)return;
  const qty=getRaw('impQty');
  const factor=getRaw('impConvFactor')||1;
  const unitIn=getVal('impUnitIn')||'Ä‘Æ¡n vá»‹ nháº­p';
  const unitOut=getVal('impUnitOut')||'Ä‘Æ¡n vá»‹ bÃ¡n';
  if(qty>0&&factor>0){
    box.innerHTML=`ğŸ“¦ <strong>${qty} ${unitIn}</strong> Ã— <strong>${factor}</strong> = <strong>${qty*factor} ${unitOut}</strong> vÃ o kho`;
    box.classList.add('show');
  }else box.classList.remove('show');
}
function toggleIngMode(){
  const type=getVal('impType');
  const cf=document.getElementById('convFields');
  if(cf)cf.style.display=type==='ingredient'?'none':'block';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELL SUGGESTIONS â€” only resell products
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onSellSug(){
  const inp=document.getElementById('incSellName');
  const drop=document.getElementById('sellSugDrop');
  if(!inp||!drop)return;
  const val=inp.value.toLowerCase();
  const prods=loadProducts().filter(p=>p.type==='resell'&&(val?p.name.toLowerCase().includes(val):true));
  drop.innerHTML='';
  if(!prods.length){drop.classList.remove('open');clearStockInfo();return;}
  prods.slice(0,10).forEach(p=>{
    const {stock}=getStock(p.name);
    const d=document.createElement('div');d.className='sug-opt';
    d.innerHTML=`<div>${p.name}</div><div class="sug-meta">Tá»“n: <strong>${stock} ${p.unitOut||''}</strong>${p.lastPrice?` Â· GiÃ¡ nháº­p: ${fmt(p.lastPrice)}`:''}</div>`;
    d.onmousedown=()=>{inp.value=p.name;drop.classList.remove('open');showStockInfo(p.name);};
    drop.appendChild(d);
  });
  drop.classList.add('open');
}
function closeSellSug(){const el=document.getElementById('sellSugDrop');if(el)el.classList.remove('open');}
function showStockInfo(name){
  const box=document.getElementById('stockInfoBox');if(!box)return;
  const {stock,unitOut}=getStock(name);
  const p=getProduct(name);
  box.style.display='block';
  box.innerHTML=`ğŸ“¦ <strong>${name}</strong> â€” Tá»“n kho: <strong>${stock} ${unitOut||''}</strong>${p?.lastPrice?` Â· GiÃ¡ nháº­p ${fmt(p.lastPrice)}/${unitOut||'cÃ¡i'}`:''}<br><span style="font-size:.7rem;color:var(--muted)">ÄÆ¡n vá»‹ bÃ¡n: ${unitOut||'â€”'}</span>`;
}
function clearStockInfo(){const box=document.getElementById('stockInfoBox');if(box)box.style.display='none';}
function updateSellTotal(){
  const box=document.getElementById('sellTotalBox');if(!box)return;
  const qty=getRaw('incQty'),price=getRaw('incUnitPrice');
  if(qty>0&&price>0){box.style.display='block';box.textContent=`ğŸ’° Tá»•ng thu: ${fmt(qty*price)}`;}
  else box.style.display='none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORT SUGGESTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onImpSug(){
  const inp=document.getElementById('impName');
  const drop=document.getElementById('impSugDrop');
  if(!inp||!drop)return;
  const val=inp.value.toLowerCase();
  const prods=loadProducts().filter(p=>val?p.name.toLowerCase().includes(val):true);
  drop.innerHTML='';
  if(!prods.length){drop.classList.remove('open');return;}
  prods.slice(0,10).forEach(p=>{
    const d=document.createElement('div');d.className='sug-opt';
    d.innerHTML=`<div>${p.name}</div><div class="sug-meta">${p.type==='ingredient'?'ğŸ§‚ NguyÃªn liá»‡u':'ğŸ›’ BÃ¡n trá»±c tiáº¿p'}${p.unitIn?` Â· ${p.unitIn}â†’${p.unitOut} (Ã—${p.convFactor||1})`:''}</div>`;
    d.onmousedown=()=>{
      inp.value=p.name;drop.classList.remove('open');
      // Auto-fill conversion fields
      setVal('impType',p.type||'resell');
      setVal('impUnitIn',p.unitIn||'');
      setVal('impUnitOut',p.unitOut||'');
      const cf=document.getElementById('impConvFactor');
      if(cf){cf.value=p.convFactor||1;cf.dataset.raw=String(p.convFactor||1);}
      toggleIngMode();showConvPreview();
    };
    drop.appendChild(d);
  });
  drop.classList.add('open');
}
function closeImpSug(){const el=document.getElementById('impSugDrop');if(el)el.classList.remove('open');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM / STOCK MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _pendingSaleFn=null;
function showConfirm(title,msg,fn){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  document.getElementById('confirmOverlay').classList.add('show');
  document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();fn();};
}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('show');}
function showStockAlert(msg,fn){document.getElementById('stockAlertMsg').innerHTML=msg;document.getElementById('stockAlertOverlay').classList.add('show');_pendingSaleFn=fn;}
function closeStockAlert(){document.getElementById('stockAlertOverlay').classList.remove('show');_pendingSaleFn=null;}
function forceConfirmSale(){closeStockAlert();if(_pendingSaleFn)_pendingSaleFn();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD SALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addSale(forceSkip=false){
  const name=getVal('incSellName');
  const desc=getVal('incDesc');
  const qty=getRaw('incQty');
  const unitPrice=getRaw('incUnitPrice');
  const date=getVal('incDate');

  if(!name){showToast('âš ï¸ Chá»n sáº£n pháº©m bÃ¡n!',true);return;}
  if(!qty){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return;}
  if(!unitPrice){showToast('âš ï¸ Nháº­p Ä‘Æ¡n giÃ¡!',true);return;}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}

  // Check product is resell
  const prod=getProduct(name);
  if(prod&&prod.type==='ingredient'){showToast('âš ï¸ NguyÃªn liá»‡u khÃ´ng bÃ¡n trá»±c tiáº¿p!',true);return;}

  // Check stock
  if(!forceSkip){
    const {stock,unitOut}=getStock(name);
    if(stock<qty){
      showStockAlert(
        `<strong>${name}</strong><br>Kho cÃ²n: <strong>${stock} ${unitOut}</strong><br>Äá»‹nh bÃ¡n: <strong>${qty} ${unitOut}</strong>`,
        ()=>doSaveSale(name,qty,unitPrice,date,desc,prod?.unitOut||'')
      );
      return;
    }
  }
  doSaveSale(name,qty,unitPrice,date,desc,prod?.unitOut||'');
}

function doSaveSale(name,qty,unitPrice,date,desc,unitOut){
  FIN.sales.push({id:Date.now(),name,qty,unitPrice,totalAmt:qty*unitPrice,date,desc:desc||('BÃ¡n '+name),unitOut});
  persist();
  renderAll();
  clearFields('incQty','incUnitPrice','incDesc');
  setVal('incSellName','');clearStockInfo();
  document.getElementById('sellTotalBox').style.display='none';
  showToast(`âœ… ÄÃ£ ghi bÃ¡n ${qty} ${unitOut||''} ${name}!`,'',true);
}

function delSale(id){
  showConfirm('XoÃ¡ giao dá»‹ch bÃ¡n','XoÃ¡ giao dá»‹ch nÃ y?',()=>{
    FIN.sales=FIN.sales.filter(x=>x.id!==id);persist();renderAll();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addImport(){
  const name=getVal('impName');
  const type=getVal('impType')||'resell';
  const qtyIn=getRaw('impQty');
  const totalAmt=getRaw('impAmount');
  const date=getVal('impDate');
  const unitIn=getVal('impUnitIn')||'Ä‘Æ¡n vá»‹';
  const unitOut=type==='ingredient'?unitIn:(getVal('impUnitOut')||unitIn);
  const convFactor=type==='ingredient'?1:(getRaw('impConvFactor')||1);

  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng!',true);return;}
  if(!qtyIn){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return;}
  if(!totalAmt){showToast('âš ï¸ Nháº­p thÃ nh tiá»n!',true);return;}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}

  const stockAdded=qtyIn*convFactor;

  const imp={
    id:Date.now(),name,type,qtyIn,unitIn,unitOut,convFactor,
    stockAdded,totalAmt,date,
    desc:`Nháº­p ${qtyIn} ${unitIn} ${name}`
  };
  FIN.imports.push(imp);
  persist();

  // Update product catalogue
  upsertProduct({
    name,type,unitIn,unitOut,convFactor,
    lastPrice:Math.round(totalAmt/stockAdded)
  });

  renderAll();renderInventory();
  clearFields('impQty','impAmount','impName');
  setVal('impUnitIn','');setVal('impUnitOut','');
  const cf=document.getElementById('impConvFactor');if(cf){cf.value='';cf.dataset.raw='';}
  document.getElementById('convPreview').classList.remove('show');
  document.getElementById('expAutofillNotice').classList.remove('show');

  showToast(`âœ… Nháº­p ${qtyIn} ${unitIn} ${name} â†’ +${stockAdded} ${unitOut} vÃ o kho!`);
}

function delImport(id){
  showConfirm('XoÃ¡ khoáº£n nháº­p','XoÃ¡ khoáº£n nháº­p hÃ ng nÃ y? Tá»“n kho sáº½ bá»‹ Ä‘iá»u chá»‰nh.',()=>{
    FIN.imports=FIN.imports.filter(x=>x.id!==id);persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPERATIONAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addOperational(){
  const desc=getVal('opDesc'),amount=getRaw('opAmount'),date=getVal('opDate');
  const type=getVal('opType');
  if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return;}
  if(!amount){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  FIN.ops.push({id:Date.now(),desc,amount,type,date});
  persist();renderAll();clearFields('opDesc','opAmount');showToast('âœ… ÄÃ£ thÃªm chi phÃ­!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLANS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addPlan(){
  const name=getVal('planName'),amount=getRaw('planAmount');
  const type=getVal('planType'),note=getVal('planNote');
  if(!name){showToast('âš ï¸ Nháº­p tÃªn káº¿ hoáº¡ch!',true);return;}
  if(!amount){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}
  FIN.plans.push({id:Date.now(),name,amount,type,note});
  persist();renderPlans();clearFields('planName','planAmount','planNote');showToast('âœ… ÄÃ£ thÃªm!');
}
function delPlan(id){
  showConfirm('XoÃ¡ káº¿ hoáº¡ch','XoÃ¡ káº¿ hoáº¡ch nÃ y?',()=>{
    FIN.plans=FIN.plans.filter(x=>x.id!==id);persist();renderPlans();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}
function renderPlans(){
  const el=document.getElementById('planList');if(!el)return;
  if(!FIN.plans.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ káº¿ hoáº¡ch nÃ o</div>';return;}
  const tl={import:'ğŸ“¦ Nháº­p hÃ ng',utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',rental:'ğŸª Máº·t báº±ng',other:'ğŸ“Œ KhÃ¡c'};
  el.innerHTML=FIN.plans.map(p=>`<div class="plan-item"><div class="plan-body"><div class="plan-name">${p.name}</div><div class="plan-meta">${tl[p.type]||p.type}${p.note?' Â· '+p.note:''}</div></div><div class="plan-amount">-${fmt(p.amount)}</div><button class="plan-del" onclick="delPlan(${p.id})">ğŸ—‘ï¸</button></div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK DELETE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bulkDelete(type){
  const ids=[];document.querySelectorAll(`.cb-${type}:checked`).forEach(cb=>ids.push(parseInt(cb.value)));
  if(!ids.length){showToast('âš ï¸ ChÆ°a chá»n giao dá»‹ch nÃ o!',true);return;}
  showConfirm(`XoÃ¡ ${ids.length} giao dá»‹ch`,`KhÃ´ng thá»ƒ hoÃ n tÃ¡c.`,()=>{
    const s=new Set(ids);
    if(type==='inc')FIN.sales=FIN.sales.filter(x=>!s.has(x.id));
    else FIN.imports=FIN.imports.filter(x=>!s.has(x.id));
    persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');
  });
}
function confirmDeleteAll(type){
  showConfirm('XoÃ¡ táº¥t cáº£',`XoÃ¡ TOÃ€N Bá»˜ ${type==='inc'?'bÃ¡n hÃ ng':'nháº­p hÃ ng'} thÃ¡ng ${monthLabel(currentMonth)}?`,()=>{
    if(type==='inc')FIN.sales=[];else FIN.imports=[];
    persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡ táº¥t cáº£!');
  });
}
function toggleSelectAll(type,checked){document.querySelectorAll(`.cb-${type}`).forEach(cb=>cb.checked=checked);updateBulkBtn(type);}
function updateBulkBtn(type){const c=document.querySelectorAll(`.cb-${type}:checked`).length;const b=document.getElementById(type+'BulkDelBtn');if(b)b.style.display=c>0?'inline-flex':'none';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERIOD FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let incPeriod='all',expPeriod='all',chartPeriod='week';
function setPeriod(type,p,btn){
  if(type==='inc')incPeriod=p;else expPeriod=p;
  document.querySelectorAll(`#msub-${type==='inc'?'inc':'imp'} .period-tab`).forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(type==='inc')renderIncTable();else renderExpTable();
}
function filterByPeriod(arr,period){
  if(period==='all')return arr;
  const now=new Date(),tod=TODAY();
  return arr.filter(x=>{
    if(!x.date)return false;
    const d=new Date(x.date+'T00:00:00');
    if(period==='today')return x.date===tod;
    if(period==='week'){const w=new Date(now);w.setDate(now.getDate()-6);return d>=w;}
    if(period==='month')return x.date&&x.date.slice(0,7)===currentMonth;
    return true;
  });
}
function setChartPeriod(p,btn){chartPeriod=p;document.querySelectorAll('#rsub-chart .period-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');refreshCharts();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getRevenue(mk){const f=loadFinance(mk);return f.sales.reduce((s,x)=>s+x.totalAmt,0);}
function getCost(mk){const f=loadFinance(mk);const imp=f.imports.reduce((s,x)=>s+x.totalAmt,0);const op=f.ops.reduce((s,x)=>s+x.amount,0);return imp+op;}

function renderAll(){renderSummary();renderIncTable();renderExpTable();}
function renderSummary(){
  const thu=getRevenue(currentMonth),chi=getCost(currentMonth),p=thu-chi;
  ['h-thu','m-thu'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=fmt(thu);});
  ['h-chi','m-chi'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=fmt(chi);});
  ['h-profit','m-profit'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=(p>=0?'+':'')+fmt(p);el.style.color=p>=0?'var(--p600)':'var(--red)';}});
}

function renderIncTable(){
  const w=document.getElementById('incTableWrap');if(!w)return;
  const filtered=filterByPeriod(FIN.sales,incPeriod).slice().sort((a,b)=>b.id-a.id);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ giao dá»‹ch bÃ¡n nÃ o</div>';return;}
  const rows=filtered.map(t=>`<tr>
    <td class="cb-cell"><input type="checkbox" class="cb-inc" value="${t.id}" onchange="updateBulkBtn('inc')"></td>
    <td>${fmtD(t.date)}</td>
    <td><span class="tag tag-sell">${t.name}</span></td>
    <td style="text-align:center">${t.qty}${t.unitOut?' '+t.unitOut:''}</td>
    <td class="thu-v">+${fmt(t.totalAmt)}</td>
    <td><button class="del-btn" onclick="delSale(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>SL</th><th>Doanh thu</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderExpTable(){
  const w=document.getElementById('expTableWrap');if(!w)return;
  const filtered=filterByPeriod(FIN.imports,expPeriod).slice().sort((a,b)=>b.id-a.id);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’¸</div>ChÆ°a cÃ³ khoáº£n nháº­p nÃ o</div>';return;}
  const rows=filtered.map(t=>`<tr>
    <td class="cb-cell"><input type="checkbox" class="cb-exp" value="${t.id}" onchange="updateBulkBtn('exp')"></td>
    <td>${fmtD(t.date)}</td>
    <td><span class="tag ${t.type==='ingredient'?'tag-ing':'tag-imp'}">${t.name}</span></td>
    <td style="text-align:center">${t.qtyIn} ${t.unitIn}${t.type==='resell'?` â†’ ${t.stockAdded} ${t.unitOut}`:''}</td>
    <td class="chi-v">-${fmt(t.totalAmt)}</td>
    <td><button class="del-btn" onclick="delImport(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>HÃ ng hÃ³a</th><th>Sá»‘ lÆ°á»£ng</th><th>Chi phÃ­</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART INVENTORY VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderInventory(){
  const el=document.getElementById('inventorySmartView');if(!el)return;
  const inv=computeInventory();
  if(!inv.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng â€” hÃ£y nháº­p hÃ ng trÆ°á»›c</div>';return;}

  const resell=inv.filter(x=>x.type==='resell');
  const ingredient=inv.filter(x=>x.type==='ingredient');
  const outItems=resell.filter(x=>x.stockSellUnits===0);
  const lowItems=resell.filter(x=>x.stockSellUnits>0&&x.stockSellUnits<LOW_STOCK);
  const okItems=resell.filter(x=>x.stockSellUnits>=LOW_STOCK);
  const now=new Date();
  const slowItems=resell.filter(x=>{
    if(!x.lastInDate)return false;
    const d=new Date(x.lastInDate+'T00:00:00');
    return Math.floor((now-d)/86400000)>=30&&x.totalSoldUnits===0&&x.stockSellUnits>0;
  });

  let html='';

  if(outItems.length||lowItems.length){
    html+=`<div class="inv-restock-notice">ğŸ”” Cáº§n nháº­p thÃªm: ${[...outItems.map(x=>`<strong>${x.name}</strong>(háº¿t)`),...lowItems.map(x=>`<strong>${x.name}</strong>(${x.stockSellUnits}${x.unitOut?' '+x.unitOut:''})`).join(' Â· ')].join(' Â· ')}</div>`;
  }

  // Háº¿t hÃ ng
  if(outItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”´ ÄÃ£ háº¿t hÃ ng (${outItems.length})</div>`;
    outItems.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-out"><div class="inv-alert-icon">ğŸ”´</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">ÄÃ£ nháº­p: ${x.totalImportedSellUnits} Â· ÄÃ£ bÃ¡n: ${x.totalSoldUnits} ${x.unitOut||''}</div></div><span class="inv-alert-qty qty-out">Háº¿t hÃ ng</span></div>`;});
    html+=`</div>`;
  }

  // Sáº¯p háº¿t
  if(lowItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¡ Sáº¯p háº¿t (< ${LOW_STOCK} ${lowItems[0]?.unitOut||'cÃ¡i'})</div>`;
    lowItems.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-low"><div class="inv-alert-icon">ğŸŸ¡</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">Nháº­p theo: ${x.unitIn||'â€”'} â†’ bÃ¡n theo: ${x.unitOut||'â€”'} (Ã—${x.convFactor||1})</div></div><span class="inv-alert-qty qty-low">CÃ²n ${x.stockSellUnits} ${x.unitOut||''}</span></div>`;});
    html+=`</div>`;
  }

  // BÃ¡n cháº­m
  if(slowItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”µ HÃ ng bÃ¡n cháº­m (nháº­p >30 ngÃ y, chÆ°a bÃ¡n)</div>`;
    slowItems.forEach(x=>{
      const days=Math.floor((now-new Date(x.lastInDate+'T00:00:00'))/86400000);
      html+=`<div class="inv-alert-card inv-alert-slow"><div class="inv-alert-icon">ğŸ”µ</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">Nháº­p ${days} ngÃ y trÆ°á»›c Â· Tá»“n: ${x.stockSellUnits} ${x.unitOut||''}</div></div><span class="inv-alert-qty" style="background:#EEF2FF;color:#4F46E5">Cháº­m bÃ¡n</span></div>`;
    });
    html+=`</div>`;
  }

  // HÃ ng Ä‘á»§ (loáº¡i trá»« bÃ¡n cháº­m)
  const okFiltered=okItems.filter(x=>!slowItems.find(s=>s.name===x.name));
  if(okFiltered.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¢ HÃ ng Ä‘á»§ (${okFiltered.length})</div>`;
    okFiltered.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-ok"><div class="inv-alert-icon">ğŸŸ¢</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">${x.unitIn&&x.unitIn!==x.unitOut?`Nháº­p: ${x.unitIn} â†’ BÃ¡n: ${x.unitOut} (Ã—${x.convFactor})`:''}</div></div><span class="inv-alert-qty qty-ok">CÃ²n ${x.stockSellUnits} ${x.unitOut||''}</span></div>`;});
    html+=`</div>`;
  }

  // NguyÃªn liá»‡u
  if(ingredient.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸ§‚ NguyÃªn liá»‡u (${ingredient.length})</div>`;
    ingredient.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-ing"><div class="inv-alert-icon">ğŸ§‚</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">ÄÃ£ nháº­p: ${x.totalImportedSellUnits} ${x.unitOut||''} Â· TÃ­nh vÃ o chi phÃ­</div></div><span class="inv-alert-qty" style="background:#FFFDE7;color:#7A5200">${x.totalImportedSellUnits} ${x.unitOut||''}</span></div>`;});
    html+=`</div>`;
  }

  el.innerHTML=html||'<div class="empty"><div class="ei">ğŸ“¦</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderHomeRecent(){
  const w=document.getElementById('homeRecentWrap');if(!w)return;
  const sales=FIN.sales.map(x=>({...x,txType:'sale'}));
  const imps=FIN.imports.map(x=>({...x,txType:'import'}));
  const all=[...sales,...imps].sort((a,b)=>b.id-a.id).slice(0,8);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return;}
  const rows=all.map(x=>`<tr>
    <td>${fmtD(x.date)}</td>
    <td>${x.txType==='sale'?'<span class="tag tag-sell">ğŸ’° BÃ¡n</span>':'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>'}</td>
    <td>${x.name||''}</td>
    <td class="${x.txType==='sale'?'thu-v':'chi-v'}">${x.txType==='sale'?'+':'-'}${fmt(x.txType==='sale'?x.totalAmt:x.totalAmt)}</td>
  </tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn hÃ ng</th><th>Sá»‘ tiá»n</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _filteredForCSV=[];
function renderHistory(){
  const months=getMonthOpts();
  const allItems=[];
  months.forEach(mk=>{
    const f=loadFinance(mk);
    f.sales.forEach(x=>allItems.push({...x,txType:'sale',monthKey:mk}));
    f.imports.forEach(x=>allItems.push({...x,txType:'import',monthKey:mk}));
    f.ops.forEach(x=>allItems.push({...x,txType:'op',monthKey:mk}));
  });
  allItems.sort((a,b)=>b.id-a.id);

  const search=getVal('histSearch').toLowerCase();
  const typeF=getVal('histTypeFilter');
  const monthF=getVal('histMonthFilter');

  const mSel=document.getElementById('histMonthFilter');
  if(mSel){const cur=mSel.value;mSel.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+months.map(m=>`<option value="${m}"${m===cur?' selected':''}>${monthLabel(m)}</option>`).join('');}

  const filtered=allItems.filter(x=>{
    if(search&&!(x.name||'').toLowerCase().includes(search)&&!(x.desc||'').toLowerCase().includes(search))return false;
    if(typeF&&x.txType!==typeF)return false;
    if(monthF&&x.monthKey!==monthF)return false;
    return true;
  });
  _filteredForCSV=filtered;

  const allThu=filtered.filter(x=>x.txType==='sale').reduce((s,x)=>s+x.totalAmt,0);
  const allChi=filtered.filter(x=>x.txType!=='sale').reduce((s,x)=>s+(x.totalAmt||x.amount||0),0);
  const allP=allThu-allChi;
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('histAllThu',fmt(allThu));set('histAllChi',fmt(allChi));
  const pe=document.getElementById('histAllProfit');if(pe){pe.textContent=(allP>=0?'+':'')+fmt(allP);pe.style.color=allP>=0?'var(--p600)':'var(--red)';}

  const w=document.getElementById('histTableWrap');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch</div>';return;}
  const rows=filtered.map(x=>{
    const tag=x.txType==='sale'?'<span class="tag tag-sell">ğŸ’° BÃ¡n</span>':x.txType==='op'?'<span class="tag tag-op">âš¡ CP</span>':'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>';
    const amt=x.txType==='sale'?x.totalAmt:(x.totalAmt||x.amount||0);
    return`<tr class="hist-row-clickable" onclick="jumpToMonth('${x.monthKey}')">
      <td>${fmtD(x.date)}</td><td>${tag}</td><td>${x.name||x.desc||'â€”'}</td>
      <td class="${x.txType==='sale'?'thu-v':'chi-v'}">${x.txType==='sale'?'+':'-'}${fmt(amt)}</td>
      <td><span class="jump-badge">${monthLabel(x.monthKey)}</span></td>
    </tr>`;
  }).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn hÃ ng</th><th>Sá»‘ tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function jumpToMonth(key){currentMonth=key;FIN=loadFinance(key);buildMonthSelect();renderAll();switchPage('money',document.querySelectorAll('.bn-btn')[1]);showToast(`âœ… ÄÃ£ chuyá»ƒn â†’ ${monthLabel(key)}`);}

function exportFilteredCSV(){
  if(!_filteredForCSV.length){showToast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u!',true);return;}
  const rows=['NgÃ y,Loáº¡i,TÃªn hÃ ng,MÃ´ táº£,Sá»‘ tiá»n,ThÃ¡ng',..._filteredForCSV.map(x=>{
    const loai=x.txType==='sale'?'BÃ¡n hÃ ng':x.txType==='import'?'Nháº­p hÃ ng':'Chi phÃ­';
    const amt=x.txType==='sale'?x.totalAmt:(x.totalAmt||x.amount||0);
    return`"${x.date}","${loai}","${x.name||''}","${(x.desc||'').replace(/"/g,'""')}","${amt}","${x.monthKey}"`;
  })].join('\n');
  copyRaw(rows,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getInventorySummary(){
  const inv=computeInventory();
  if(!inv.length)return'Kho trá»‘ng.';
  const out=inv.filter(x=>x.type==='resell'&&x.stockSellUnits===0).map(x=>x.name);
  const low=inv.filter(x=>x.type==='resell'&&x.stockSellUnits>0&&x.stockSellUnits<LOW_STOCK).map(x=>`${x.name}(${x.stockSellUnits}${x.unitOut?' '+x.unitOut:''})`);
  const ok=inv.filter(x=>x.type==='resell'&&x.stockSellUnits>=LOW_STOCK).map(x=>`${x.name}:${x.stockSellUnits}${x.unitOut?' '+x.unitOut:''}`);
  const ing=inv.filter(x=>x.type==='ingredient').map(x=>x.name);
  let s=`HÃ ng bÃ¡n (resell): `;
  if(out.length)s+=`Háº¿t: ${out.join(', ')}. `;
  if(low.length)s+=`Sáº¯p háº¿t: ${low.join(', ')}. `;
  if(ok.length)s+=`Äá»§: ${ok.join(', ')}. `;
  if(ing.length)s+=`NguyÃªn liá»‡u: ${ing.join(', ')}.`;
  return s;
}

function updateAIStatusBar(){
  const el=document.getElementById('aiInvSummary');if(!el)return;
  const inv=computeInventory().filter(x=>x.type==='resell');
  if(!inv.length){el.innerHTML='Kho trá»‘ng';return;}
  const out=inv.filter(x=>x.stockSellUnits===0).length;
  const low=inv.filter(x=>x.stockSellUnits>0&&x.stockSellUnits<LOW_STOCK).length;
  const ok=inv.filter(x=>x.stockSellUnits>=LOW_STOCK).length;
  const parts=[];
  if(out)parts.push(`<strong style="color:var(--red)">${out} háº¿t hÃ ng</strong>`);
  if(low)parts.push(`<strong style="color:#7A5200">${low} sáº¯p háº¿t</strong>`);
  if(ok)parts.push(`<strong style="color:var(--p600)">${ok} Ä‘á»§ hÃ ng</strong>`);
  el.innerHTML=parts.join(' Â· ')||'Kho á»•n Ä‘á»‹nh';
}

function setChatStatus(t,busy=false){const el=document.getElementById('chatStatusDot');if(el)el.textContent=busy?'â³ '+t:'â— '+t;}

async function sendChat(){
  const inp=document.getElementById('chatInp');
  const msg=inp?inp.value.trim():'';
  if(!msg)return;
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  if(inp)inp.value='';
  addMsg(msg,'user');
  setChatStatus('Äang kiá»ƒm tra kho...',true);
  const typing=document.getElementById('chatTyping');
  if(typing)typing.classList.add('show');
  scrollChat();

  const invSummary=getInventorySummary();
  const bizCtx=buildBizContext();
  const prompt=`Báº¡n lÃ  trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, nÃ³i chuyá»‡n thÃ¢n thiá»‡n (bÃ /cÃ´/chÃº bÃ¡n hÃ ng VN).

=== KHO HÃ€NG THá»°C Táº¾ ===
${invSummary}

=== Sá» LIá»†U KINH DOANH ===
${bizCtx}

QUAN TRá»ŒNG:
- Tráº£ lá»i tá»‘i Ä‘a 2 cÃ¢u ngáº¯n gá»n, dÃ¹ng emoji.
- Há»i vá» kho: liá»‡t kÃª sá»‘ liá»‡u ngay, khÃ´ng chÃ o há»i dÃ i.
- Náº¿u ngÆ°á»i dÃ¹ng nÃ³i vá» giao dá»‹ch (bÃ¡n/nháº­p): tráº£ vá» JSON trong dáº¥u []:
  [{"item":"tÃªn","quantity":sá»‘,"price":Ä‘Æ¡n_giÃ¡_náº¿u_cÃ³,"type":"bÃ¡n hoáº·c nháº­p"}]
- KhÃ´ng giáº£i thÃ­ch dÃ i dÃ²ng.

Tin nháº¯n: ${msg}`;

  try{
    const raw=await callGemini([{text:prompt}]);
    if(typing)typing.classList.remove('show');
    setChatStatus('Sáºµn sÃ ng',false);
    const jm=raw.match(/\[[\s\S]*?\]/);
    if(jm){
      try{
        const parsed=JSON.parse(jm[0]);
        if(parsed.length>0){
          const preview=parsed.map(x=>`${/(nháº­p)/i.test(x.type)?'ğŸ“¦ Nháº­p':'ğŸ’° BÃ¡n'} ${x.quantity} ${x.item}${x.price>0?' @ '+fmt(x.price):''}`).join('\n');
          const textPart=raw.replace(jm[0],'').trim()||'ÄÃºng khÃ´ng?';
          addMsgWithConfirm(textPart+'\n\n'+preview,parsed);
          return;
        }
      }catch{}
    }
    addMsg(raw,'bot');
  }catch(err){
    if(typing)typing.classList.remove('show');
    setChatStatus('Lá»—i',false);
    addMsg('âŒ '+err.message,'bot');
  }
}

function addMsgWithConfirm(text,data){
  const msgs=document.getElementById('chatMsgs');if(!msgs)return;
  const div=document.createElement('div');div.className='msg bot';
  div.innerHTML=text.replace(/\n/g,'<br>')+`<div class="confirm-pill"><button class="pill-yes" onclick="confirmAITx(this,true)">âœ… LÆ°u vÃ o kho</button><button class="pill-no" onclick="confirmAITx(this,false)">âŒ Bá» qua</button></div>`;
  div._aiData=data;msgs.insertBefore(div,document.getElementById('chatTyping'));scrollChat();
}

function confirmAITx(btn,yes){
  const msgDiv=btn.closest('.msg');const data=msgDiv._aiData;
  const pill=msgDiv.querySelector('.confirm-pill');if(pill)pill.remove();
  if(yes&&data)processAIResponse(data);
  else addMsg('ğŸ‘ OK, bá» qua nhÃ©!','bot');
  scrollChat();
}

function processAIResponse(items){
  if(!Array.isArray(items))return;
  const today=TODAY();
  items.forEach(it=>{
    const name=(it.item||it.name||'').trim();if(!name)return;
    const qty=parseInt(String(it.quantity||1).replace(/\D/g,''))||1;
    const price=parseInt(String(it.price||0).replace(/\D/g,''))||0;
    const isSale=/(bÃ¡n|thu|sell)/i.test(it.type||'');
    if(isSale){
      const {stock,unitOut}=getStock(name);
      if(stock<qty){
        showStockAlert(`<strong>${name}</strong><br>Kho cÃ²n: ${stock} ${unitOut}<br>Äá»‹nh bÃ¡n: ${qty} ${unitOut}`,()=>{
          FIN.sales.push({id:Date.now(),name,qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut});
          persist();renderAll();showToast(`âœ… Ghi bÃ¡n ${qty} ${name}!`);
        });
        return;
      }
      FIN.sales.push({id:Date.now(),name,qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut});
    }else{
      FIN.imports.push({id:Date.now(),name,type:'resell',qtyIn:qty,unitIn:'',unitOut:'',convFactor:1,stockAdded:qty,totalAmt:qty*price,date:today,desc:'AI: nháº­p '+name});
      upsertProduct({name,type:'resell',unitIn:'',unitOut:'',convFactor:1,lastPrice:price});
    }
    persist();
  });
  renderAll();renderInventory();updateAIStatusBar();
  showToast(`âœ… ÄÃ£ ghi ${items.length} giao dá»‹ch!`);
}

function buildBizContext(){
  const thu=getRevenue(currentMonth),chi=getCost(currentMonth);
  const prev=new Date();prev.setMonth(prev.getMonth()-1);
  const prevKey=prev.toISOString().slice(0,7);
  const prevThu=getRevenue(prevKey);
  const yearRev=getAllMonthKeys().filter(k=>k.startsWith(new Date().getFullYear()+'')).reduce((s,k)=>s+getRevenue(k),0);
  return`ThÃ¡ng ${currentMonth}: Thu=${fmt(thu)}, Chi=${fmt(chi)}, LÃ£i=${fmt(thu-chi)}\nThÃ¡ng trÆ°á»›c: Thu=${fmt(prevThu)}\nNÄƒm nay: ${fmt(yearRev)}/500tr ngÆ°á»¡ng thuáº¿`;
}

function addMsg(text,role){
  const msgs=document.getElementById('chatMsgs');if(!msgs)return;
  const div=document.createElement('div');div.className='msg '+role;
  div.innerHTML=text.replace(/\n/g,'<br>');
  msgs.insertBefore(div,document.getElementById('chatTyping'));scrollChat();
}
function scrollChat(){const m=document.getElementById('chatMsgs');if(m)m.scrollTop=m.scrollHeight;}
function askAIAboutInventory(){
  const aiBtn=document.querySelectorAll('.bn-btn')[4];switchPage('ai',aiBtn);
  setTimeout(()=>{const inp=document.getElementById('chatInp');if(inp){inp.value='TÃ¬nh hÃ¬nh hÃ ng hÃ³a trong kho cá»§a tÃ´i tháº¿ nÃ o?';sendChat();}},200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(parts){
  if(!API_KEY)throw new Error('ChÆ°a cÃ³ API Key!');
  const res=await fetch(`${GEMINI_URL}?key=${API_KEY}`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts}],generationConfig:{maxOutputTokens:600,temperature:0.3}})
  });
  if(!res.ok)throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  if(data.error)throw new Error(data.error.message||'Lá»—i API');
  const txt=data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!txt)throw new Error('AI khÃ´ng tráº£ vá» ná»™i dung');
  return txt;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _invoiceBase64='',_incInvBase64='',_invoiceData=[];

function handleInvoiceImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    _invoiceBase64=ev.target.result.split(',')[1];
    const box=document.getElementById('expImgPreviewBox'),img=document.getElementById('invoicePreview'),ua=document.getElementById('expUploadArea');
    if(ua)ua.style.display='none';if(box)box.style.display='block';if(img)img.src=ev.target.result;
    document.getElementById('scanBtn').disabled=false;
  };r.readAsDataURL(f);
}
function resetExpImg(){
  _invoiceBase64='';document.getElementById('invoiceImg').value='';
  const box=document.getElementById('expImgPreviewBox'),ua=document.getElementById('expUploadArea');
  if(box)box.style.display='none';if(ua)ua.style.display='block';
  document.getElementById('scanBtn').disabled=true;
}

async function scanInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanLoader'),wrap=document.getElementById('invoiceTableWrap'),
    acts=document.getElementById('invActions'),btn=document.getElementById('scanBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML='';}
  if(acts)acts.style.display='none';if(btn)btn.disabled=true;
  _invoiceData=[];document.getElementById('expAutofillNotice').classList.remove('show');
  const PROMPT=`TrÃ­ch xuáº¥t táº¥t cáº£ máº·t hÃ ng tá»« hÃ³a Ä‘Æ¡n. Tráº£ vá» JSON khÃ´ng markdown:
{"rows":[{"ten":"tÃªn hÃ ng","soluong":"sá»‘ lÆ°á»£ng","dongia":"Ä‘Æ¡n giÃ¡","thanhtien":"thÃ nh tiá»n"}]}`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_invoiceBase64}},{text:PROMPT}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed?.rows?.length){
      _invoiceData=parsed.rows;
      const rh=parsed.rows.map(r=>`<tr><td>${r.ten||''}</td><td>${r.soluong||''}</td><td style="text-align:right">${r.dongia||''}</td><td style="text-align:right;font-weight:800;color:var(--p700)">${r.thanhtien||''}</td></tr>`).join('');
      if(wrap){wrap.innerHTML=`<table class="inv-tbl"><thead><tr><th>TÃªn hÃ ng</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th></tr></thead><tbody>${rh}</tbody></table>`;wrap.classList.add('show');}
      if(acts)acts.style.display='flex';
    }else if(wrap){wrap.innerHTML=`<pre style="padding:10px;font-size:.78rem;overflow:auto;max-height:180px">${raw}</pre>`;wrap.classList.add('show');}
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}

function autoFillImport(){
  if(!_invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const first=_invoiceData[0];
  setVal('impName',first.ten||'');
  const q=(first.soluong||'').replace(/\D/g,'');
  const qEl=document.getElementById('impQty');if(qEl){qEl.dataset.raw=q;qEl.value=q?parseInt(q).toLocaleString('vi-VN'):'';}
  const rawA=(first.thanhtien||'').replace(/\D/g,'');
  const aEl=document.getElementById('impAmount');if(aEl&&rawA){aEl.dataset.raw=rawA;aEl.value=parseInt(rawA).toLocaleString('vi-VN');}
  document.getElementById('expAutofillNotice').classList.add('show');showToast('âœ… ÄÃ£ Ä‘iá»n form!');
}

async function copyInvoiceCSV(){
  if(!_invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³!',true);return;}
  const csv=['TÃªn,SL,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',..._invoiceData.map(r=>`"${r.ten||''}","${r.soluong||''}","${r.dongia||''}","${r.thanhtien||''}"`)].join('\n');
  await copyRaw(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');
}

function handleIncInvoice(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    _incInvBase64=ev.target.result.split(',')[1];
    const box=document.getElementById('incImgPreviewBox'),img=document.getElementById('incInvoicePreview');
    if(box)box.style.display='block';if(img)img.src=ev.target.result;
    document.getElementById('scanIncBtn').disabled=false;
  };r.readAsDataURL(f);
}
function resetIncImg(){
  _incInvBase64='';document.getElementById('incInvoiceFile').value='';
  const box=document.getElementById('incImgPreviewBox');if(box)box.style.display='none';
  document.getElementById('scanIncBtn').disabled=true;
}
async function scanIncInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanIncLoader'),btn=document.getElementById('scanIncBtn');
  if(loader)loader.classList.add('show');if(btn)btn.disabled=true;
  document.getElementById('incAutofillNotice').classList.remove('show');
  const PROMPT=`ÄÃ¢y lÃ  bill/hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n. TrÃ­ch xuáº¥t thÃ´ng tin bÃ¡n hÃ ng. Tráº£ vá» JSON khÃ´ng markdown:
{"items":[{"item":"tÃªn","quantity":"sá»‘","price":"Ä‘Æ¡n giÃ¡","type":"thu"}],"tongtien":"tá»•ng","ngay":"YYYY-MM-DD"}`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_incInvBase64}},{text:PROMPT}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed){
      const nameVal=parsed.items?.length?parsed.items.map(x=>x.item).join(', '):'';
      const total=(parsed.tongtien||'').replace(/\D/g,'');
      setVal('incSellName',nameVal);
      setVal('incDesc','BÃ¡n '+nameVal);
      if(total){const aEl=document.getElementById('incUnitPrice');if(aEl){aEl.dataset.raw=total;aEl.value=parseInt(total).toLocaleString('vi-VN');}}
      if(parsed.ngay&&/^\d{4}-\d{2}-\d{2}$/.test(parsed.ngay))setVal('incDate',parsed.ngay);
      setVal('incQty','1');document.getElementById('incQty').dataset.raw='1';
      document.getElementById('incAutofillNotice').classList.add('show');
      showToast('âœ… AI Ä‘Ã£ Ä‘á»c bill!');
    }
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMO (Facebook / TikTok)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _fbBase64='';
function handleFbImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    _fbBase64=ev.target.result.split(',')[1];
    const box=document.getElementById('fbImgPreviewBox'),img=document.getElementById('fbPreview');
    if(box)box.style.display='block';if(img)img.src=ev.target.result;
    document.getElementById('fbPostBtn').disabled=false;
  };r.readAsDataURL(f);
}
function resetFbImg(){_fbBase64='';document.getElementById('fbImgInput').value='';const box=document.getElementById('fbImgPreviewBox');if(box)box.style.display='none';document.getElementById('fbPostBtn').disabled=true;}

async function generateFbPost(){
  if(!API_KEY||!_fbBase64){showToast('âš ï¸ Cáº§n API Key vÃ  áº£nh!',true);return;}
  const card=document.getElementById('fbResultCard'),loader=document.getElementById('fbLoader'),
    box=document.getElementById('fbPost'),btn=document.getElementById('copyFb'),postBtn=document.getElementById('fbPostBtn');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');
  if(btn)btn.classList.remove('show');if(postBtn)postBtn.disabled=true;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_fbBase64}},{text:'Viáº¿t bÃ i Ä‘Äƒng Facebook bÃ¡n hÃ ng tiá»ƒu thÆ°Æ¡ng VN. CÃ³ emoji, call-to-action, hashtag. Chá»‰ tráº£ vá» bÃ i viáº¿t.'}]);
    if(loader)loader.classList.remove('show');if(box){box.textContent=raw;box.classList.add('show');}if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(postBtn)postBtn.disabled=false;
}

async function generateScript(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const product=getVal('ttProduct');if(!product){showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return;}
  const roleMap={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},xung=roleMap[getVal('ttRole')]||'báº¡n';
  const card=document.getElementById('videoResult'),loader=document.getElementById('videoLoader'),
    box=document.getElementById('scriptBox'),btn=document.getElementById('copyScript'),sbtn=document.getElementById('scriptBtn');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');
  if(btn)btn.classList.remove('show');if(sbtn)sbtn.disabled=true;
  try{
    const text=await callGemini([{text:`HÆ°á»›ng dáº«n ${xung} quay TikTok bÃ¡n "${product}". NgÃ´n ngá»¯ Ä‘Æ¡n giáº£n, 3 bÆ°á»›c rÃµ. Káº¿t: "${xung.charAt(0).toUpperCase()+xung.slice(1)} cá»© quay xong Ä‘Äƒng luÃ´n ğŸ’š"`}]);
    if(loader)loader.classList.remove('show');if(box){box.textContent=text;box.classList.add('show');}if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(sbtn)sbtn.disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTaxAssistant(){
  const el=document.getElementById('taxAssistantBox');if(!el)return;
  const now=new Date(),year=now.getFullYear();
  const yearRevenue=getAllMonthKeys().filter(k=>k.startsWith(year+'')).reduce((s,k)=>s+getRevenue(k),0);
  const month=now.getMonth()+1;
  const avg=month>0?yearRevenue/month:0,projected=avg*12,remaining=TAX_THRESHOLD-yearRevenue;
  let html='';
  if(yearRevenue>=TAX_THRESHOLD)
    html=`<div class="tax-box tax-danger"><span class="tx-icon">âš ï¸</span><div class="tx-msg">BÃ  Æ¡i! Doanh thu vÆ°á»£t 500 triá»‡u â€” cáº§n ná»™p thuáº¿!</div><span class="tax-amount">${fmt(yearRevenue*TAX_RATE)}</span><div class="tx-detail"><strong>Doanh thu nÄƒm ${year}:</strong> ${fmt(yearRevenue)}<br><strong>Thuáº¿ 1.5%:</strong> ${fmt(yearRevenue*TAX_RATE)}</div></div>`;
  else if(projected>=TAX_THRESHOLD)
    html=`<div class="tax-box tax-warn"><span class="tx-icon">ğŸ””</span><div class="tx-msg">CÃ³ thá»ƒ cháº¡m ngÆ°á»¡ng 500tr trong nÄƒm nay!</div><div class="tx-detail"><strong>ÄÃ£ thu:</strong> ${fmt(yearRevenue)}<br><strong>Dá»± bÃ¡o:</strong> ${fmt(projected)}<br><strong>CÃ²n:</strong> ${fmt(remaining)}</div></div>`;
  else
    html=`<div class="tax-box tax-safe"><span class="tx-icon">ğŸ˜Š</span><div class="tx-msg">ChÆ°a pháº£i ná»™p thuáº¿. Cá»© yÃªn tÃ¢m bÃ¡n!</div><div class="tx-detail"><strong>ÄÃ£ thu ${year}:</strong> ${fmt(yearRevenue)}<br><strong>CÃ²n bÃ¡n thÃªm Ä‘Æ°á»£c:</strong> ${fmt(remaining)}</div></div>`;
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPARE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showCompare(){
  const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;
  if(!a||!b||a===b){showToast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return;}
  const aThu=getRevenue(a),aChi=getCost(a),aLai=aThu-aChi;
  const bThu=getRevenue(b),bChi=getCost(b),bLai=bThu-bChi;
  const delta=(cur,prv)=>{const d=cur-prv,pct=prv>0?Math.round(d/prv*100):0;return`<div class="cmp-delta ${d>=0?'delta-up':'delta-down'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`;};
  const box=document.getElementById('compareBox');
  box.innerHTML=`<h3>ğŸ“Š ${monthLabel(a)} vs ${monthLabel(b)}</h3><div class="cmp-grid"><div class="cmp-item"><div class="cmp-lbl">ğŸ“ˆ Thu</div><div class="cmp-cur">${fmt(aThu)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bThu)}</div>${delta(aThu,bThu)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ“‰ Chi</div><div class="cmp-cur">${fmt(aChi)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bChi)}</div>${delta(aChi,bChi)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ’¼ LÃ£i</div><div class="cmp-cur" style="color:${aLai>=0?'var(--p600)':'var(--red)'}">${(aLai>=0?'+':'')+fmt(aLai)}</div><div class="cmp-prev">${(bLai>=0?'+':'')+fmt(bLai)}</div>${delta(aLai,bLai)}</div></div>`;
  box.classList.add('show');
}

function buildAllTimeCompare(){
  const el=document.getElementById('allTimeCompare');if(!el)return;
  const opts=getMonthOpts();
  if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return;}
  const rows=opts.map(k=>{const thu=getRevenue(k),chi=getCost(k),lai=thu-chi;return`<tr><td>${monthLabel(k)}</td><td class="thu-v">+${fmt(thu)}</td><td class="chi-v">-${fmt(chi)}</td><td style="font-weight:800;color:${lai>=0?'var(--p600)':'var(--red)'}">${(lai>=0?'+':'')+fmt(lai)}</td></tr>`;}).join('');
  const aT=opts.reduce((s,k)=>s+getRevenue(k),0),aC=opts.reduce((s,k)=>s+getCost(k),0),aL=aT-aC;
  el.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:var(--p700);color:#fff"><td style="padding:7px 8px;font-weight:800">Tá»•ng</td><td style="padding:7px 8px;font-weight:900">+${fmt(aT)}</td><td style="padding:7px 8px;font-weight:900">-${fmt(aC)}</td><td style="padding:7px 8px;font-weight:900;color:${aL>=0?'#A8E6C1':'#FFB3AA'}">${(aL>=0?'+':'')+fmt(aL)}</td></tr></tfoot></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS â€” no global accumulation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _charts={};
function destroyChart(id){if(_charts[id]){try{_charts[id].destroy();}catch{}delete _charts[id];}}
function destroyAllCharts(){['pieChart','barChart','lineChart','homeLineChart'].forEach(destroyChart);}

function getChartTrend(){
  const allMonths=getAllMonthKeys();
  if(chartPeriod==='week'){
    const days=[],thu=[],chi=[];
    for(let i=6;i>=0;i--){
      const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);
      const mk=iso.slice(0,7);const f=loadFinance(mk);
      days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);
      thu.push(f.sales.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
      chi.push(f.imports.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
    }
    return{days,thu,chi};
  }else if(chartPeriod==='month'){
    const[y,m]=currentMonth.split('-');const dIM=new Date(y,m,0).getDate();
    const days=[],thu=[],chi=[];
    for(let i=1;i<=dIM;i++){
      const iso=`${currentMonth}-${String(i).padStart(2,'0')}`;
      const f=FIN;
      days.push(String(i));
      thu.push(f.sales.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
      chi.push(f.imports.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
    }
    return{days,thu,chi};
  }else{
    const opts=getMonthOpts().slice().reverse();
    return{days:opts.map(k=>{const[y,mth]=k.split('-');return`T${parseInt(mth)}/${y.slice(2)}`;}),thu:opts.map(k=>getRevenue(k)),chi:opts.map(k=>getCost(k))};
  }
}

function refreshCharts(){
  destroyAllCharts();
  const thu=getRevenue(currentMonth);
  const impAmt=FIN.imports.reduce((s,x)=>s+x.totalAmt,0);
  const opAmt=FIN.ops.reduce((s,x)=>s+x.amount,0);
  const hasData=thu>0||impAmt>0||opAmt>0;
  document.getElementById('noChartData').style.display=hasData?'none':'block';
  document.getElementById('chartContent').style.display=hasData?'block':'none';
  if(!hasData)return;

  const pieEl=document.getElementById('pieChart');
  if(pieEl)_charts['pieChart']=new Chart(pieEl,{type:'doughnut',data:{labels:['Thu','Nháº­p hÃ ng','Chi phÃ­'],datasets:[{data:[thu,impAmt,opAmt],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},padding:5}}}}});

  const barData=[...new Set(FIN.imports.map(x=>x.name))].slice(0,5).map(n=>({n,v:FIN.imports.filter(x=>x.name===n).reduce((s,x)=>s+x.totalAmt,0)}));
  const barEl=document.getElementById('barChart');
  if(barEl)_charts['barChart']=new Chart(barEl,{type:'bar',data:{labels:barData.length?barData.map(x=>x.n):['ChÆ°a cÃ³'],datasets:[{label:'Ä‘',data:barData.length?barData.map(x=>x.v):[0],backgroundColor:'rgba(27,107,58,.72)',borderRadius:5,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3)+'K':v}},x:{grid:{display:false},ticks:{font:{size:8},maxRotation:0}}}}});

  const{days,thu:thuL,chi:chiL}=getChartTrend();
  const lineEl=document.getElementById('lineChart');
  if(lineEl)_charts['lineChart']=new Chart(lineEl,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thuL,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chiL,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
}

function refreshHomeChart(){
  destroyChart('homeLineChart');
  const days=[],thu=[],chi=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);
    const mk=iso.slice(0,7);const f=loadFinance(mk);
    days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);
    thu.push(f.sales.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
    chi.push(f.imports.filter(x=>x.date===iso).reduce((s,x)=>s+x.totalAmt,0));
  }
  const c=document.getElementById('homeLineChart');if(!c)return;
  _charts['homeLineChart']=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'},grid:{color:'#eee'}},x:{grid:{display:false}}}}});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COPY UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function writeClip(text){
  try{if(navigator.clipboard?.writeText){await navigator.clipboard.writeText(text);return true;}const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px';document.body.appendChild(ta);ta.focus();ta.select();const ok=document.execCommand('copy');document.body.removeChild(ta);return ok;}catch{return false;}
}
async function doCopy(boxId,btnId){
  const box=document.getElementById(boxId);if(!box)return;
  const text=box.textContent.trim();if(!text){showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return;}
  const ok=await writeClip(text);
  if(ok){showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');const b=document.getElementById(btnId);if(b){const o=b.innerHTML;b.innerHTML='âœ… ÄÃ£ sao chÃ©p!';b.classList.add('ok');b.disabled=true;setTimeout(()=>{b.innerHTML=o;b.classList.remove('ok');b.disabled=false;},2e3);}}
  else showToast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);
}
async function copyRaw(text,msg){const ok=await writeClip(text);showToast(ok?msg:'âŒ KhÃ´ng sao chÃ©p Ä‘Æ°á»£c',!ok);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _toastTimer=null;
function showToast(msg,isErr=false,isOk=false){
  const t=document.getElementById('toast');if(!t)return;
  t.textContent=msg;t.className='';
  if(isErr)t.classList.add('err');if(isOk)t.classList.add('ok');
  t.classList.add('show');clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>t.classList.remove('show'),3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tod=TODAY();
['incDate','impDate','opDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=tod;});
buildMonthSelect();
renderAll();
renderHomeRecent();
updateAIStatusBar();
setTimeout(refreshHomeChart,120);
</script>
</body>
</html>
