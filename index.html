<!DOCTYPE html>
<html lang="vi">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.13);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
  --nav-h:60px;
  --ai-bg:#0D1F16;--ai-surface:#111F17;--ai-card:#162A1F;
  --ai-border:#1E3829;--ai-input-bg:#1A2E23;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;overflow:hidden;max-width:100vw}
body{font-family:var(--font);background:var(--surface);color:var(--text);display:flex;flex-direction:column;height:100dvh}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}
header{flex-shrink:0;background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:8px 14px 6px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.22);z-index:300}
header h1{font-size:1.1rem;font-weight:800;line-height:1.2}
header p{font-size:.62rem;opacity:.75;margin-top:1px}
.badge{background:var(--a400);color:#1A2E23;font-size:.52rem;font-weight:900;padding:2px 5px;border-radius:20px;margin-left:4px;vertical-align:middle}
#apiBar{flex-shrink:0;background:#FFFDE7;border-bottom:2px solid var(--a400);padding:5px 10px;display:flex;align-items:center;flex-wrap:wrap;gap:5px}
#apiBar label{font-size:.68rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:80px;padding:4px 8px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.78rem}
#apiKeyInput:focus{outline:none;border-color:#D4881A}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:4px 9px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.72rem;white-space:nowrap}
#apiStatus{font-size:.65rem;color:#7A5200;flex-basis:100%;margin-top:-2px}
#monthBar{flex-shrink:0;background:var(--card);border-bottom:2px solid var(--border);padding:5px 10px;display:flex;align-items:center;gap:7px}
#monthBar label{font-size:.68rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:4px 7px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.78rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
.month-badge{font-size:.62rem;background:var(--p50);color:var(--p600);padding:2px 8px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto;white-space:nowrap}
#mainArea{flex:1 1 0;min-height:0;position:relative;overflow:hidden}
.page{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.page.active{display:block}
.page-inner{padding:10px;max-width:600px;margin:0 auto;padding-bottom:16px;width:100%}
#page-ai{display:none;position:absolute;inset:0;flex-direction:column;background:var(--ai-bg);overflow:hidden;}
#page-ai.active{display:flex}
.ai-topbar{flex-shrink:0;background:var(--ai-surface);border-bottom:1px solid var(--ai-border);padding:8px 14px;display:flex;align-items:center;gap:8px;}
.ai-topbar-dot{width:8px;height:8px;border-radius:50%;background:#27AE60;box-shadow:0 0 6px #27AE60;flex-shrink:0;animation:aipulse 2s infinite;}
@keyframes aipulse{0%,100%{opacity:1}50%{opacity:.4}}
.ai-topbar-text{flex:1;font-size:.72rem;color:#8FB89A;line-height:1.4}
.ai-topbar-text strong{color:#A8E6C1;font-size:.74rem}
.ai-av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--p600),#27AE60);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;box-shadow:0 2px 8px rgba(27,107,58,.4)}
.chat-msgs{flex:1 1 0;min-height:0;overflow-y:auto;overflow-x:hidden;padding:12px 12px 8px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:#1E3829;border-radius:10px}
.msg{max-width:88%;padding:9px 13px;border-radius:18px;font-size:.82rem;line-height:1.6;word-break:break-word;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:var(--ai-card);border:1px solid var(--ai-border);color:#D4EDD9;align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:linear-gradient(135deg,var(--p600),#218C4A);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;box-shadow:0 3px 12px rgba(27,107,58,.35)}
.typing{align-self:flex-start;display:none}
.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:9px 14px;background:var(--ai-card);border:1px solid var(--ai-border);border-radius:18px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.confirm-pill{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.confirm-pill button{padding:6px 14px;border-radius:20px;font-size:.75rem;font-weight:800;cursor:pointer;border:1.5px solid;transition:.15s;font-family:var(--font)}
.pill-yes{background:var(--p600);color:#fff;border-color:var(--p600)}
.pill-yes:hover{background:var(--p700)}
.pill-no{background:transparent;color:#E87A6A;border-color:#E87A6A}
.quick-chips{flex-shrink:0;padding:6px 12px 5px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;border-top:1px solid var(--ai-border);background:var(--ai-surface);}
.quick-chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:5px 11px;background:var(--ai-card);border:1px solid var(--ai-border);border-radius:20px;color:#8FB89A;font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:.15s;font-family:var(--font);}
.chip:hover,.chip:active{background:var(--p700);color:#fff;border-color:var(--p700)}
.chat-foot{flex-shrink:0;padding:8px 10px 10px;background:var(--ai-surface);border-top:1px solid var(--ai-border);display:flex;gap:8px;align-items:flex-end;}
.chat-inp{flex:1;min-height:40px;max-height:100px;padding:9px 14px;background:var(--ai-input-bg);border:1.5px solid var(--ai-border);border-radius:22px;color:#E0F0E6;font-size:.85rem;font-family:var(--font);resize:none;line-height:1.45;overflow-y:auto;transition:border-color .2s;outline:none;-webkit-tap-highlight-color:transparent;}
.chat-inp::placeholder{color:#3A5A48}
.chat-inp:focus{border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.15)}
.chat-send{flex-shrink:0;width:40px;height:40px;background:linear-gradient(135deg,var(--p600),#218C4A);border:none;border-radius:50%;color:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(27,107,58,.4);transition:.18s;}
.chat-send:hover{transform:scale(1.08)}
.chat-send:active{transform:scale(.95)}
.chat-send:disabled{opacity:.4;transform:none}
#chatStatusDot{font-size:.62rem;color:#6ABF8A}
.bottom-nav{flex-shrink:0;height:var(--nav-h);background:var(--card);border-top:2px solid var(--border);display:flex;z-index:400;box-shadow:0 -3px 16px rgba(0,0,0,.10);width:100%}
.bn-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:4px 2px;border-top:3px solid transparent;transition:.15s;color:var(--muted);font-family:var(--font);min-width:0}
.bn-btn .ni{font-size:1.15rem;line-height:1}
.bn-btn .nl{font-size:.5rem;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.bn-btn.active{color:var(--p600);border-top-color:var(--p600);background:var(--p50)}
.card{background:var(--card);border-radius:var(--r-md);padding:12px;margin-bottom:10px;box-shadow:var(--shadow-sm);border:1px solid var(--border);overflow:hidden;width:100%}
.card-title{font-size:.88rem;font-weight:800;color:var(--p700);margin-bottom:7px;display:flex;align-items:center;gap:5px}
.card-sub{font-size:.68rem;color:var(--muted);margin-top:-4px;margin-bottom:7px;line-height:1.5}
.field{margin-bottom:8px;width:100%}
.field label{font-size:.67rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:8px 10px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-family:var(--font);background:#fff;color:var(--text);transition:.15s;box-sizing:border-box}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
@media(max-width:380px){.row2,.row3{grid-template-columns:1fr}}
.sug-wrap{position:relative}
.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:600;max-height:180px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.sug-dropdown.open{display:block}
.sug-opt{padding:8px 11px;cursor:pointer;font-size:.82rem;border-bottom:1px solid var(--border);transition:.12s}
.sug-opt:last-child{border-bottom:none}
.sug-opt:hover,.sug-opt:active{background:var(--p50);color:var(--p600)}
.sug-opt .sug-meta{font-size:.63rem;color:var(--muted);margin-top:1px}
.sug-group{padding:5px 11px 2px;font-size:.6rem;font-weight:900;color:var(--p600);background:var(--p50);text-transform:uppercase;letter-spacing:.5px}
.btn{width:100%;padding:10px;border:none;border-radius:var(--r-md);font-size:.84rem;font-weight:800;cursor:pointer;transition:.18s;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:7px;font-family:var(--font);box-sizing:border-box}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.2)}
.btn-primary:hover:not(:disabled){background:var(--p700)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-danger{background:var(--red-bg);color:var(--red);border:2px solid #F5C6C0}
.btn-danger:hover:not(:disabled){background:var(--red);color:#fff}
.btn-sm{padding:5px 10px;font-size:.71rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.4;cursor:not-allowed}
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:16px 10px;text-align:center;cursor:pointer;transition:.18s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100)}
.upload-area .u-icon{font-size:1.7rem;margin-bottom:3px}
.upload-area strong{display:block;font-size:.8rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.66rem}
.img-preview-box{position:relative;margin-bottom:8px;display:none}
.img-preview-box img{width:100%;max-height:160px;object-fit:cover;border-radius:var(--r-sm);border:2px solid var(--p300);display:block}
.img-change-btn{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:20px;padding:3px 8px;font-size:.65rem;font-weight:800;cursor:pointer}
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:10px;margin-top:7px;white-space:pre-wrap;font-size:.78rem;line-height:1.7;max-height:220px;overflow-y:auto;display:none;word-break:break-word}
.result-box.show{display:block}
.loader{display:none;text-align:center;padding:12px}
.loader.show{display:block}
.spinner{width:28px;height:28px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 5px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.75rem}
.copy-btn{display:none;align-items:center;gap:5px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:6px 11px;border-radius:var(--r-sm);font-size:.73rem;font-weight:800;cursor:pointer;margin-top:5px;transition:.18s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:7px 10px;font-size:.73rem;color:var(--p700);margin-top:5px;display:none}
.autofill-notice.show{display:block}
.sub-tabs{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.sub-tab{padding:5px 11px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.71rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:8px 5px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.58rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.s-val{font-size:.84rem;font-weight:900;word-break:break-all}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}
.tbl-wrap{overflow-x:auto;overflow-y:auto;border-radius:var(--r-sm);border:1px solid var(--border);max-height:300px;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:.76rem;min-width:320px}
thead{position:sticky;top:0;z-index:5}
thead tr{background:var(--p600)}
th{padding:6px 7px;text-align:left;color:#fff;font-size:.66rem;font-weight:800;white-space:nowrap}
td{padding:6px 7px;border-bottom:1px solid var(--border);vertical-align:middle;word-break:break-word;max-width:140px}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800;white-space:nowrap}
.chi-v{color:var(--red);font-weight:800;white-space:nowrap}
.del-btn{background:none;border:none;cursor:pointer;font-size:.8rem;padding:2px 3px;border-radius:5px;transition:.12s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;font-size:.62rem;font-weight:800;white-space:nowrap}
.tag-sell{background:#D4EDDA;color:var(--p700)}
.tag-cook{background:#E0E7FF;color:#3730A3}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-mat{background:#FFF3CD;color:#856404}
.tag-op{background:#F3E8FF;color:#7C3AED}
.period-tabs{display:flex;gap:4px;margin-bottom:9px;flex-wrap:wrap}
.period-tab{padding:4px 10px;border:2px solid var(--border);background:#fff;border-radius:20px;font-size:.68rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.period-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.period-tab:hover:not(.active){background:var(--p50);color:var(--p600)}
.bulk-bar{display:flex;align-items:center;gap:6px;margin-bottom:7px;flex-wrap:wrap}
.bulk-bar input[type=checkbox]{width:13px;height:13px;accent-color:var(--p600);cursor:pointer}
.bulk-bar label{font-size:.72rem;font-weight:800;color:var(--muted);cursor:pointer}
.cb-cell input[type=checkbox]{width:13px;height:13px;accent-color:var(--p600);cursor:pointer}
.inv-section{margin-bottom:10px}
.inv-section-title{font-size:.76rem;font-weight:900;color:var(--p700);margin-bottom:5px;display:flex;align-items:center;gap:4px}
.inv-alert-card{border-radius:var(--r-sm);padding:9px 11px;margin-bottom:5px;display:flex;align-items:flex-start;gap:8px;border:2px solid}
.inv-alert-out{background:var(--red-bg);border-color:var(--red)}
.inv-alert-low{background:#FFF8E1;border-color:var(--a400)}
.inv-alert-ok{background:var(--p50);border-color:var(--p300)}
.inv-alert-slow{background:#EEF2FF;border-color:#7C83FD}
.inv-alert-icon{font-size:1.2rem;flex-shrink:0}
.inv-alert-body{flex:1;min-width:0}
.inv-alert-name{font-size:.84rem;font-weight:800;word-break:break-word}
.inv-alert-meta{font-size:.66rem;color:var(--muted);margin-top:2px;line-height:1.4}
.inv-alert-qty{font-size:.78rem;font-weight:900;white-space:nowrap;padding:3px 8px;border-radius:20px;flex-shrink:0;align-self:center}
.qty-out{background:var(--red-bg);color:var(--red)}
.qty-low{background:#FFF3CD;color:#7A5200}
.qty-ok{background:var(--p50);color:var(--p600)}
.inv-restock-notice{background:var(--a400);color:#1A2E23;border-radius:var(--r-sm);padding:7px 11px;font-size:.73rem;font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.inv-ask-btn{width:100%;padding:9px;background:var(--p600);color:#fff;border:none;border-radius:var(--r-md);font-size:.82rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:3px;transition:.18s}
.inv-ask-btn:hover{background:var(--p700)}
.stock-info-box{background:var(--p50);border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:7px 10px;font-size:.76rem;color:var(--p700);margin-bottom:8px;display:none}
.sell-total-box{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:6px 10px;font-size:.78rem;color:var(--p700);font-weight:800;margin-bottom:8px;display:none}
.conv-box{background:#EEF2FF;border:2px solid #7C83FD;border-radius:var(--r-sm);padding:9px 11px;margin-top:7px;font-size:.76rem;line-height:1.6;display:none}
.conv-box.show{display:block}
.conv-box strong{color:#4F46E5}
.invoice-table-wrap{margin-top:8px;overflow-x:auto;display:none}
.invoice-table-wrap.show{display:block}
.inv-tbl{width:100%;border-collapse:collapse;font-size:.78rem;min-width:300px}
.inv-tbl th{background:var(--p600);color:#fff;padding:6px 7px;font-size:.68rem;font-weight:800;text-align:left;white-space:nowrap}
.inv-tbl td{padding:6px 7px;border-bottom:1px solid var(--border);word-break:break-word}
.inv-tbl tr:last-child td{border-bottom:none}
.inv-tbl tr:nth-child(even) td{background:var(--p50)}
.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);padding:11px;margin-bottom:10px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.82rem;font-weight:800;color:var(--p700);margin-bottom:7px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:7px 4px;border:1px solid var(--border)}
.cmp-lbl{font-size:.58rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmp-cur{font-size:.78rem;font-weight:900;color:var(--p700)}
.cmp-prev{font-size:.64rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.64rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
@media(max-width:440px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:9px;border:1px solid var(--border)}
.ch-card h3{font-size:.7rem;font-weight:800;color:var(--p700);margin-bottom:5px;text-align:center}
.ch-wrap{position:relative;height:130px}
.ch-full{position:relative;height:150px}
.history-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
.history-filters input,.history-filters select{padding:5px 8px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.75rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:90px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.hist-row-clickable{cursor:pointer;transition:.12s}
.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);border:1px solid var(--p100);border-radius:6px;font-size:.58rem;padding:1px 4px;font-weight:800}
.tax-box{border-radius:var(--r-md);padding:13px;margin-bottom:10px;border:3px solid}
.tax-safe{background:#E8F5E9;border-color:#4CAF50}
.tax-warn{background:#FFF8E1;border-color:var(--a400)}
.tax-danger{background:var(--red-bg);border-color:var(--red)}
.tx-icon{font-size:1.6rem;margin-bottom:4px;display:block;text-align:center}
.tx-msg{font-size:1rem;font-weight:800;line-height:1.4;text-align:center;margin-bottom:6px}
.tax-safe .tx-msg{color:#2E7D32}.tax-warn .tx-msg{color:#7A5200}.tax-danger .tx-msg{color:var(--red)}
.tx-detail{font-size:.77rem;color:var(--muted);line-height:1.7;background:rgba(255,255,255,.6);border-radius:var(--r-sm);padding:7px 9px;margin-top:4px}
.tx-detail strong{color:var(--text)}
.tax-amount{font-size:1.3rem;font-weight:900;color:var(--red);text-align:center;display:block;margin:4px 0}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:flex-end;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg) var(--r-lg) 0 0;padding:15px;width:100%;max-width:500px;box-shadow:var(--shadow-md);max-height:85vh;overflow-y:auto}
.modal h3{font-size:.9rem;font-weight:800;color:var(--p700);margin-bottom:8px}
.modal-btns{display:flex;gap:7px;margin-top:10px}
.modal-btns button{flex:1;padding:9px;border-radius:var(--r-sm);font-weight:800;font-size:.8rem;cursor:pointer;border:none;transition:.15s;font-family:var(--font)}
.modal-cancel{background:var(--surface);color:var(--muted);border:2px solid var(--border)!important}
.modal-confirm{background:var(--red);color:#fff}
.stock-alert-modal{border:3px solid var(--red)}
.stock-alert-modal h3{color:var(--red)}
.stock-alert-msg{font-size:.96rem;font-weight:700;color:var(--red);line-height:1.5;padding:8px 0;text-align:center}
.cook-item{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:7px}
.cook-body{flex:1;min-width:0}
.cook-name{font-size:.82rem;font-weight:800;color:var(--p700);word-break:break-word}
.cook-meta{font-size:.67rem;color:var(--muted);margin-top:1px}
.cook-price{font-size:.85rem;font-weight:900;color:var(--p600);white-space:nowrap}
.cook-del{background:none;border:none;cursor:pointer;font-size:.8rem;color:var(--subtle);padding:2px 3px;border-radius:5px;transition:.12s}
.cook-del:hover{background:var(--red-bg);color:var(--red)}
.empty{text-align:center;color:var(--muted);padding:18px 10px;font-size:.78rem}
.empty .ei{font-size:1.7rem;margin-bottom:4px}
#toast{position:fixed;bottom:72px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--p700);color:#fff;padding:9px 18px;border-radius:30px;font-size:.83rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1),opacity .28s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);opacity:0;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--red)}
#toast.ok{background:#27AE60}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Quáº£n lÃ½ kinh doanh Â· Tiá»‡m táº¡p hÃ³a / quÃ¡n Äƒn</p>
</header>

<div id="apiBar">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key API táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <span id="apiStatus"></span>
</div>

<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ Hiá»‡n táº¡i</span>
</div>

<div id="mainArea">

<!-- Tá»”NG QUAN -->
<div id="page-home" class="page active">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="h-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng chi</div><div class="s-val" id="h-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="h-profit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y</div>
    <div class="ch-full"><canvas id="homeLineChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div>
    <div id="homeRecentWrap"></div>
  </div>
</div>
</div>

<!-- THU / CHI -->
<div id="page-money" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="m-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng chi</div><div class="s-val" id="m-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="m-profit">0Ä‘</div></div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('ban',this)">ğŸ’° BÃ¡n hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('nhap',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('chiphi',this)">âš¡ Chi phÃ­</button>
    <button class="sub-tab" onclick="switchSub('kho',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="sub-tab" onclick="switchSub('chebien',this)">ğŸ³ Cháº¿ biáº¿n</button>
  </div>
  <div id="msub-ban">
    <div class="card">
      <div class="card-title">ğŸ“· QuÃ©t bill thanh toÃ¡n</div>
      <div class="upload-area" onclick="document.getElementById('incInvoiceFile').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p bill Ä‘Ã£ thanh toÃ¡n</strong><small>AI Ä‘á»c vÃ  Ä‘iá»n vÃ o form</small>
      </div>
      <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
      <div class="img-preview-box" id="incImgBox"><img id="incInvoicePreview"/><button class="img-change-btn" onclick="resetIncImg()">âœï¸ Äá»•i áº£nh</button></div>
      <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:7px">ğŸ¤– AI Ä‘á»c bill</button>
      <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c bill...</p></div>
      <div class="autofill-notice" id="incAutofillNotice">âœ… AI Ä‘Ã£ Ä‘á»c â€” kiá»ƒm tra danh sÃ¡ch bÃªn dÆ°á»›i rá»“i báº¥m "XÃ¡c nháº­n lÆ°u táº¥t cáº£"</div>
      <!-- PREVIEW DANH SÃCH MÃ“N -->
      <div class="inv-preview-wrap" id="incPreviewWrap">
        <div class="inv-preview-title">ğŸ‘ï¸ Xem trÆ°á»›c â€” Nháº¥n ğŸ—‘ï¸ Ä‘á»ƒ bá» mÃ³n khÃ´ng muá»‘n lÆ°u</div>
        <div class="inv-preview-list" id="incPreviewList"></div>
        <div class="inv-preview-footer">
          <span class="inv-preview-count" id="incPreviewCount"></span>
          <span class="inv-preview-total" id="incPreviewTotal"></span>
        </div>
        <button class="btn btn-primary" style="margin-top:9px" onclick="confirmIncItems()">âœ… XÃ¡c nháº­n lÆ°u táº¥t cáº£</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="card-sub">Hiá»ƒn thá»‹ <strong>hÃ ng trong kho</strong> vÃ  <strong>sáº£n pháº©m cháº¿ biáº¿n</strong></div>
      <div class="field"><label>ğŸ›’ Chá»n sáº£n pháº©m bÃ¡n</label>
        <div class="sug-wrap">
          <input class="inp" id="sellName" placeholder="GÃµ tÃªn sáº£n pháº©m..." autocomplete="off"
            oninput="onSellSug(this.value)" onfocus="onSellSug(this.value)" onblur="setTimeout(closeSellSug,250)"/>
          <div class="sug-dropdown" id="sellDrop"></div>
        </div>
      </div>
      <div class="stock-info-box" id="stockInfoBox"></div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="sellDesc" placeholder="Ghi chÃº thÃªm..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="sellQty" placeholder="0" oninput="handleMoney(this);calcSellTotal()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’µ ÄÆ¡n giÃ¡ bÃ¡n</label><input class="inp" type="text" id="sellPrice" placeholder="0Ä‘" oninput="handleMoney(this);calcSellTotal()" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="sell-total-box" id="sellTotalBox"></div>
      <div class="field"><label>ğŸ“… NgÃ y bÃ¡n</label><input class="inp" type="datetime-local" id="sellDate"/></div>
      <button class="btn btn-primary" onclick="addSale()">âœ… XÃ¡c nháº­n bÃ¡n</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('ban','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('ban','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('ban','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('ban','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="banSelectAll" onchange="toggleSelectAll('ban',this.checked)">
        <label for="banSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('ban')" id="banBulkBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('ban')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="banTableWrap"></div>
    </div>
  </div>
  <div id="msub-nhap" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="upload-area" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p hÃ³a Ä‘Æ¡n nhÃ  cung cáº¥p</strong><small>AI trÃ­ch xuáº¥t danh sÃ¡ch hÃ ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <div class="img-preview-box" id="expImgBox"><img id="invoicePreview"/><button class="img-change-btn" onclick="resetExpImg()">âœï¸ Äá»•i áº£nh</button></div>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:7px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="invoiceTableWrap"></div>
      <div id="invActions" style="display:none;gap:5px;margin-top:7px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ Xuáº¥t CSV</button>
        <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Äiá»n vÃ o form</button>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… ÄÃ£ Ä‘iá»n â€” kiá»ƒm tra rá»“i báº¥m "Nháº­p hÃ ng"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng vÃ o kho</div>
      <div class="card-sub">Chá»n loáº¡i Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ³ vÃ o tá»“n kho hay khÃ´ng</div>
      <div class="row2">
        <div class="field"><label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onImpSug(this.value)" onfocus="onImpSug(this.value)" onblur="setTimeout(closeImpSug,250)"/>
            <div class="sug-dropdown" id="impDrop"></div>
          </div>
        </div>
        <div class="field"><label>ğŸ“‚ Loáº¡i hÃ ng</label>
          <select class="inp" id="impType" onchange="toggleImpMode()">
            <option value="hangban">ğŸ›’ HÃ ng bÃ¡n láº¡i (vÃ o kho)</option>
            <option value="nguyenlieu">ğŸ§‚ NguyÃªn liá»‡u (khÃ´ng vÃ o kho)</option>
          </select>
        </div>
      </div>
      <div id="convFields">
        <div class="row3">
          <div class="field"><label>ğŸ“¦ ÄÆ¡n vá»‹ nháº­p</label><input class="inp" type="text" id="impUnitIn" placeholder="thÃ¹ng, kg..."/></div>
          <div class="field"><label>ğŸ·ï¸ ÄÆ¡n vá»‹ bÃ¡n</label><input class="inp" type="text" id="impUnitOut" placeholder="gÃ³i, chai..."/></div>
          <div class="field"><label>ğŸ”¢ Há»‡ sá»‘ (1 nháº­p = ? bÃ¡n)</label><input class="inp" type="text" id="impFactor" placeholder="1" oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        </div>
        <div class="conv-box" id="convPreview"></div>
      </div>
      <div class="row2">
        <div class="field"><label>ğŸ“¥ Sá»‘ lÆ°á»£ng nháº­p</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° Tá»•ng tiá»n lÃ´</label><input class="inp" type="text" id="impAmt" placeholder="0Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="datetime-local" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()">â• Nháº­p hÃ ng</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ nháº­p hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('nhap','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('nhap','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('nhap','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('nhap','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="nhapSelectAll" onchange="toggleSelectAll('nhap',this.checked)">
        <label for="nhapSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('nhap')" id="nhapBulkBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('nhap')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="nhapTableWrap"></div>
    </div>
  </div>
  <div id="msub-chiphi" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, thuÃª máº·t báº±ng... â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field"><label>ğŸ“‚ Loáº¡i chi phÃ­</label>
        <select class="inp" id="cpType">
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="cpDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="cpAmt" placeholder="0Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="cpDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addCost()">â• ThÃªm chi phÃ­</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ Lá»‹ch sá»­ chi phÃ­</div><div id="cpTableWrap"></div></div>
  </div>
  <div id="msub-kho" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ—„ï¸ Tá»“n kho thÃ´ng minh</div>
      <div class="card-sub">ğŸ”´ Háº¿t Â· ğŸŸ¡ DÆ°á»›i 5 Â· ğŸŸ¢ Äá»§ hÃ ng Â· TÃ­nh theo Ä‘Æ¡n vá»‹ bÃ¡n</div>
      <div id="inventoryView"></div>
      <button class="inv-ask-btn" onclick="askAIInventory()">ğŸ¤– Há»i trá»£ lÃ½ vá» kho</button>
    </div>
  </div>
  <div id="msub-chebien" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ³ Quáº£n lÃ½ sáº£n pháº©m cháº¿ biáº¿n</div>
      <div class="card-sub">Phá»Ÿ, cÆ¡m, nÆ°á»›c Ã©p... â€” chá»‰ ghi doanh thu, <strong>khÃ´ng trá»« kho</strong></div>
      <div class="row2">
        <div class="field"><label>ğŸ“ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="cbName" placeholder="VD: Phá»Ÿ bÃ², CÆ¡m táº¥m..."/></div>
        <div class="field"><label>ğŸ’µ GiÃ¡ bÃ¡n máº·c Ä‘á»‹nh</label><input class="inp" type="text" id="cbPrice" placeholder="0Ä‘ (tuá»³ chá»n)" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <button class="btn btn-primary" onclick="addCookProduct()">â• ThÃªm sáº£n pháº©m cháº¿ biáº¿n</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ Danh sÃ¡ch sáº£n pháº©m cháº¿ biáº¿n</div><div id="cookList"></div></div>
  </div>
</div>
</div>

<!-- QUáº¢NG BÃ -->
<div id="page-promo" class="page">
<div class="page-inner">
  <div class="card" style="background:#FFF8E1;border:2px solid var(--a400)">
    <div class="card-title">ğŸ“£ Marketing â€” KhÃ´ng lÆ°u kho</div>
    <div class="card-sub">áº¢nh á»Ÿ Ä‘Ã¢y <strong>khÃ´ng</strong> táº¡o giao dá»‹ch. ÄÆ¡n tháº­t â†’ Tab <strong>Thu/Chi</strong>.</div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchPromoSub('fb',this)">ğŸ“£ Facebook</button>
    <button class="sub-tab" onclick="switchPromoSub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="psub-fb">
    <div class="card">
      <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook</div>
      <div class="upload-area" onclick="document.getElementById('fbImgInput').click()">
        <div class="u-icon">ğŸ–¼ï¸</div><strong>Chá»n áº£nh sáº£n pháº©m</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i</small>
      </div>
      <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
      <div class="img-preview-box" id="fbImgBox"><img id="fbPreview"/><button class="img-change-btn" onclick="resetFbImg()">âœï¸ Äá»•i áº£nh</button></div>
    </div>
    <button class="btn btn-primary" onclick="genFbPost()" id="fbBtn" disabled>ğŸ¤– AI viáº¿t bÃ i</button>
    <div class="card" id="fbResultCard" style="display:none">
      <div class="card-title">âœï¸ BÃ i Ä‘Äƒng</div>
      <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t...</p></div>
      <div class="result-box" id="fbPost"></div>
      <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
  <div id="psub-tt" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="genScript()">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n quay</button>
    <div class="card" id="ttResultCard" style="display:none">
      <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n quay</div>
      <div class="loader" id="ttLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="result-box" id="ttScript"></div>
      <button class="copy-btn" id="copyScript" onclick="doCopy('ttScript','copyScript')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- BÃO CÃO -->
<div id="page-reports" class="page">
<div class="page-inner">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchReportSub('chart',this)">ğŸ“Š Biá»ƒu Ä‘á»“</button>
    <button class="sub-tab" onclick="switchReportSub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="sub-tab" onclick="switchReportSub('tax',this)">ğŸ§¾ Thuáº¿</button>
  </div>
  <div id="rsub-chart">
    <div class="period-tabs">
      <button class="period-tab active" onclick="setChartPeriod('week',this)">7 ngÃ y</button>
      <button class="period-tab" onclick="setChartPeriod('month',this)">ThÃ¡ng</button>
      <button class="period-tab" onclick="setChartPeriod('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o <span id="chartLabel" style="font-weight:400;font-size:.74rem;color:var(--muted)"></span></div>
      <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="charts-grid">
          <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
          <div class="ch-card"><h3>ğŸ“¦ Nháº­p hÃ ng</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        </div>
        <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rsub-compare" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“ˆ So sÃ¡nh thÃ¡ng</div>
      <div class="row2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-primary" onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="compare-box" id="compareBox"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£ thá»i gian</div>
      <div id="allTimeCompare"></div>
      <button class="btn btn-secondary" style="margin-top:7px" onclick="buildAllTimeCompare()">ğŸ”„ Cáº­p nháº­t</button>
    </div>
  </div>
  <div id="rsub-tax" style="display:none">
    <div id="taxBox"></div>
    <div class="card">
      <div class="card-sub" style="font-size:.72rem;color:var(--muted);line-height:1.7;margin:0">
        <strong>ğŸ“Œ Quy Ä‘á»‹nh thuáº¿ 2026:</strong><br>
        â€¢ Doanh thu â‰¤ 500 triá»‡u/nÄƒm â†’ <strong>Miá»…n thuáº¿</strong><br>
        â€¢ Doanh thu > 500 triá»‡u/nÄƒm â†’ Thuáº¿ khoÃ¡n <strong>1.5%</strong>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="renderTax()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
</div>
</div>

<!-- TRá»¢ LÃ AI -->
<div id="page-ai" class="page">
  <div class="ai-topbar">
    <div class="ai-av">ğŸ¤–</div>
    <div class="ai-topbar-text">
      <strong>Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</strong><br>
      <span id="aiInvSummary">Äang táº£i...</span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
      <div class="ai-topbar-dot"></div>
      <span id="chatStatusDot" style="font-size:.58rem;color:#6ABF8A">Sáºµn sÃ ng</span>
    </div>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="msg bot">ğŸ‘‹ ChÃ o! MÃ¬nh cÃ³ thá»ƒ:<br>â€¢ Ghi <strong>bÃ¡n / nháº­p</strong> hÃ ng ngay<br>â€¢ Tra <strong>tá»“n kho</strong> vÃ  sá»‘ liá»‡u<br>â€¢ TÆ° váº¥n kinh doanh ğŸ’š</div>
    <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  </div>
  <div class="quick-chips">
    <button class="chip" onclick="useChip(this)">ğŸ“¦ Kho cÃ²n gÃ¬?</button>
    <button class="chip" onclick="useChip(this)">ğŸ’° ThÃ¡ng nÃ y lÃ£i bao nhiÃªu?</button>
    <button class="chip" onclick="useChip(this)">ğŸ›’ BÃ¡n 5 gÃ³i mÃ¬ 15k</button>
    <button class="chip" onclick="useChip(this)">ğŸ“¥ Nháº­p 2 thÃ¹ng bia 300k</button>
    <button class="chip" onclick="useChip(this)">âš ï¸ HÃ ng sáº¯p háº¿t?</button>
    <button class="chip" onclick="useChip(this)">ğŸ“Š Doanh thu hÃ´m nay</button>
  </div>
  <div class="chat-foot">
    <textarea class="chat-inp" id="chatInp" placeholder="Nháº¯n: BÃ¡n 5 gÃ³i mÃ¬..." rows="1"
      oninput="autoResizeChat(this)"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"
    ></textarea>
    <button class="chat-send" id="chatSendBtn" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- Lá»ŠCH Sá»¬ -->
<div id="page-history" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng thu</div><div class="s-val" id="hAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng chi</div><div class="s-val" id="hAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="hAllProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m..." oninput="renderHistory()"/>
      <select id="histType" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="ban">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="nhap">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="chiphi">âš¡ Chi phÃ­</option>
      </select>
      <select id="histMonth" onchange="renderHistory()"><option value="">Táº¥t cáº£ thÃ¡ng</option></select>
      <button class="btn btn-secondary btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>
</div>

</div>

<nav class="bottom-nav">
  <button class="bn-btn active" onclick="switchPage('home',this)"><span class="ni">ğŸ </span><span class="nl">Tá»•ng quan</span></button>
  <button class="bn-btn" onclick="switchPage('money',this)"><span class="ni">ğŸ’°</span><span class="nl">Thu/Chi</span></button>
  <button class="bn-btn" onclick="switchPage('promo',this)"><span class="ni">ğŸ“£</span><span class="nl">Quáº£ng bÃ¡</span></button>
  <button class="bn-btn" onclick="switchPage('reports',this)"><span class="ni">ğŸ“Š</span><span class="nl">BÃ¡o cÃ¡o</span></button>
  <button class="bn-btn" onclick="switchPage('ai',this)"><span class="ni">ğŸ¤–</span><span class="nl">AI</span></button>
  <button class="bn-btn" onclick="switchPage('history',this)"><span class="ni">ğŸ“š</span><span class="nl">Lá»‹ch sá»­</span></button>
</nav>

<div class="overlay" id="confirmOverlay">
  <div class="modal">
    <h3 id="confirmTitle">XÃ¡c nháº­n</h3>
    <p id="confirmMsg" style="font-size:.8rem;color:var(--muted);line-height:1.5"></p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeConfirm()">Huá»·</button>
      <button class="modal-confirm" id="confirmOkBtn">XÃ¡c nháº­n</button>
    </div>
  </div>
</div>
<div class="overlay" id="stockAlertOverlay">
  <div class="modal stock-alert-modal">
    <h3>âš ï¸ Tá»“n kho khÃ´ng Ä‘á»§!</h3>
    <div class="stock-alert-msg" id="stockAlertMsg"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeStockAlert()">Huá»· bá»</button>
      <button style="flex:1;padding:9px;border-radius:var(--r-sm);font-weight:800;font-size:.8rem;cursor:pointer;background:var(--a400);color:#1A2E23;border:none" onclick="forceConfirmSale()">Váº«n ghi nháº­n</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
const GEMINI_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent';
const TAX_THRESHOLD=500_000_000,TAX_RATE=.015,LOW_STOCK=5;
let apiKey='';
let curMonth=new Date().toISOString().slice(0,7);

// In-memory storage (no localStorage)
const MEM={};
const LS={
  get:k=>{try{return MEM[k]?JSON.parse(MEM[k]):null}catch{return null}},
  set:(k,v)=>{MEM[k]=JSON.stringify(v)},
  keys:()=>Object.keys(MEM)
};
function finKey(mk){return'finance-'+mk}
function emptyFin(){return{sales:[],imports:[],costs:[]}}
function loadFin(mk){const d=LS.get(finKey(mk));if(!d)return emptyFin();return{sales:d.sales||[],imports:d.imports||[],costs:d.costs||[]}}
function saveFin(mk,d){LS.set(finKey(mk),d)}
let FIN=loadFin(curMonth);
function persist(){saveFin(curMonth,FIN)}
function loadProducts(){return LS.get('tt40_products')||[]}
function saveProducts(a){LS.set('tt40_products',a)}
function upsertProduct(p){const a=loadProducts(),i=a.findIndex(x=>x.name===p.name);if(i>=0)Object.assign(a[i],p);else a.push(p);saveProducts(a)}
function loadCookItems(){return LS.get('tt40_cook')||[]}
function saveCookItems(a){LS.set('tt40_cook',a)}
function allMonthKeys(){const s=new Set([curMonth]);LS.keys().filter(k=>/^finance-\d{4}-\d{2}$/.test(k)).forEach(k=>s.add(k.replace('finance-','')));return[...s].sort()}

function computeInventory(){
  const map={};
  allMonthKeys().forEach(mk=>{
    const fin=loadFin(mk);
    fin.imports.forEach(imp=>{
      if(imp.kind!=='hangban')return;
      if(!map[imp.name])map[imp.name]={name:imp.name,unitIn:imp.unitIn||'',unitOut:imp.unitOut||'',factor:imp.factor||1,stockUnits:0,totalImported:0,totalSold:0,lastPrice:0,lastInDate:''};
      const added=imp.stockAdded||(imp.qtyIn*(imp.factor||1));
      map[imp.name].stockUnits+=added;map[imp.name].totalImported+=added;
      if(imp.totalAmt>0&&imp.qtyIn>0)map[imp.name].lastPrice=Math.round(imp.totalAmt/(imp.qtyIn*(imp.factor||1)));
      if(!map[imp.name].lastInDate||imp.date>map[imp.name].lastInDate)map[imp.name].lastInDate=imp.date;
      map[imp.name].unitIn=imp.unitIn||map[imp.name].unitIn;
      map[imp.name].unitOut=imp.unitOut||map[imp.name].unitOut;
      map[imp.name].factor=imp.factor||map[imp.name].factor;
    });
    fin.sales.forEach(s=>{
      if(s.type!=='hangban')return;
      if(map[s.name]){map[s.name].stockUnits=Math.max(0,map[s.name].stockUnits-s.qty);map[s.name].totalSold+=s.qty}
    });
  });
  return Object.values(map);
}
function getStock(name){const inv=computeInventory(),it=inv.find(x=>x.name===name);return it?{stock:it.stockUnits,unitOut:it.unitOut}:{stock:0,unitOut:''}}
function getRevenue(mk){return loadFin(mk).sales.reduce((s,x)=>s+x.totalAmt,0)}
function getCost(mk){const f=loadFin(mk);return f.imports.reduce((s,x)=>s+x.totalAmt,0)+f.costs.reduce((s,x)=>s+x.amount,0)}

function monthLabel(k){const[y,m]=k.split('-');return`ThÃ¡ng ${parseInt(m)}/${y}`}
function getMonthOpts(){const s=new Set();for(let i=0;i<6;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);s.add(d.toISOString().slice(0,7))}allMonthKeys().forEach(mk=>s.add(mk));return[...s].sort().reverse()}
function buildMonthSelect(){
  const now=new Date().toISOString().slice(0,7),opts=getMonthOpts();
  const sel=document.getElementById('monthSelect');
  if(sel)sel.innerHTML=opts.map(k=>`<option value="${k}"${k===curMonth?' selected':''}>${monthLabel(k)}${k===now?' â­':''}</option>`).join('');
  const mb=document.getElementById('monthBadge');if(mb)mb.textContent=curMonth===now?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':monthLabel(curMonth);
  const cl=document.getElementById('chartLabel');if(cl)cl.textContent=monthLabel(curMonth);
  ['cmpA','cmpB'].forEach((id,i)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');if(i===1&&opts.length>1)el.value=opts[1]});
}
function switchMonth(k){curMonth=k;FIN=loadFin(k);buildMonthSelect();renderAll();if(document.getElementById('page-reports').classList.contains('active'))setTimeout(refreshCharts,80);if(document.getElementById('page-history').classList.contains('active'))renderHistory()}

const fmt=n=>(!n||n===0)?'0Ä‘':n.toLocaleString('vi-VN')+'Ä‘';
const fmtDate=d=>{if(!d)return'';const s=d.includes('T')?d:d+'T00:00';const dt=new Date(s);if(isNaN(dt))return d.slice(0,10);const dd=String(dt.getDate()).padStart(2,'0'),mm=String(dt.getMonth()+1).padStart(2,'0'),hh=String(dt.getHours()).padStart(2,'0'),mn=String(dt.getMinutes()).padStart(2,'0');return dt.getHours()===0&&dt.getMinutes()===0?`${dd}/${mm}`:`${dd}/${mm} ${hh}:${mn}`};
function nowDatetimeLocal(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function todayISO(){return new Date().toISOString().slice(0,10)}
function handleMoney(el){const raw=(el.value||'').replace(/\D/g,'');el.dataset.raw=raw;el.value=raw?parseInt(raw,10).toLocaleString('vi-VN'):''}
function blockNonDigit(e){if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault()}
function getRaw(id){const el=document.getElementById(id);return el?(parseInt((el.dataset.raw||'0').replace(/\D/g,'')||'0',10)||0):0}
function getVal(id){const el=document.getElementById(id);return el?(el.value||'').trim():''}
function setVal(id,v){const el=document.getElementById(id);if(el)el.value=v}
function setMoneyVal(id,n){const el=document.getElementById(id);if(!el)return;el.dataset.raw=String(n);el.value=n?n.toLocaleString('vi-VN'):''}
function clearMoneyField(id){const el=document.getElementById(id);if(el){el.value='';el.dataset.raw=''}}

function switchPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='home'){renderSummary();renderHomeRecent();setTimeout(refreshHomeChart,80)}
  if(name==='reports')setTimeout(refreshCharts,80);
  if(name==='history')renderHistory();
  if(name==='ai'){updateAIStatusBar();setTimeout(scrollChat,80)}
}
const SUB_MONEY=['ban','nhap','chiphi','kho','chebien'];
function switchSub(name,btn){
  SUB_MONEY.forEach(n=>{const el=document.getElementById('msub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-money .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='kho')renderInventory();if(name==='chebien')renderCookList();if(name==='chiphi')renderCostTable();
}
function switchPromoSub(name,btn){
  ['fb','tt'].forEach(n=>{const el=document.getElementById('psub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-promo .sub-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');
}
function switchReportSub(name,btn){
  ['chart','compare','tax'].forEach(n=>{const el=document.getElementById('rsub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-reports .sub-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');
  if(name==='chart')setTimeout(refreshCharts,80);if(name==='compare')buildAllTimeCompare();if(name==='tax')renderTax();
}

let _curSellType='hangban';
function onSellSug(val){
  const drop=document.getElementById('sellDrop'),q=(val||'').toLowerCase(),inv=computeInventory(),cooks=loadCookItems();
  const hangban=inv.filter(x=>!q||x.name.toLowerCase().includes(q)),chebien=cooks.filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';
  if(!hangban.length&&!chebien.length){drop.classList.remove('open');clearStockInfo();return}
  if(hangban.length){const g=document.createElement('div');g.className='sug-group';g.textContent='ğŸ—„ï¸ HÃ ng trong kho';drop.appendChild(g);hangban.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.innerHTML=`<div>${p.name}</div><div class="sug-meta">Tá»“n: <strong>${p.stockUnits} ${p.unitOut||''}</strong>${p.lastPrice?' Â· Nháº­p: '+fmt(p.lastPrice):''}</div>`;d.onmousedown=()=>{selectSellItem(p.name,'hangban',p);drop.classList.remove('open')};drop.appendChild(d)})}
  if(chebien.length){const g2=document.createElement('div');g2.className='sug-group';g2.textContent='ğŸ³ Sáº£n pháº©m cháº¿ biáº¿n';drop.appendChild(g2);chebien.slice(0,8).forEach(c=>{const d=document.createElement('div');d.className='sug-opt';d.innerHTML=`<div>${c.name}</div><div class="sug-meta">Cháº¿ biáº¿n Â· ${c.price?'GiÃ¡: '+fmt(c.price):'ChÆ°a Ä‘áº·t giÃ¡'}</div>`;d.onmousedown=()=>{selectSellItem(c.name,'chebien',c);drop.classList.remove('open')};drop.appendChild(d)})}
  drop.classList.add('open');
}
function selectSellItem(name,type,data){
  setVal('sellName',name);_curSellType=type;
  if(type==='hangban'){showStockInfo(data);if(data.lastPrice)setMoneyVal('sellPrice',data.lastPrice)}
  else{const box=document.getElementById('stockInfoBox');if(box){box.style.display='block';box.innerHTML=`ğŸ³ <strong>${name}</strong> â€” Sáº£n pháº©m cháº¿ biáº¿n Â· KhÃ´ng trá»« kho`}if(data.price)setMoneyVal('sellPrice',data.price)}
}
function closeSellSug(){const d=document.getElementById('sellDrop');if(d)d.classList.remove('open')}
function showStockInfo(inv){const box=document.getElementById('stockInfoBox');if(!box)return;box.style.display='block';box.innerHTML=`ğŸ“¦ <strong>${inv.name}</strong> â€” Tá»“n kho: <strong>${inv.stockUnits} ${inv.unitOut||''}</strong>${inv.lastPrice?' Â· GiÃ¡ nháº­p '+fmt(inv.lastPrice):''}`}
function clearStockInfo(){const box=document.getElementById('stockInfoBox');if(box)box.style.display='none';_curSellType='hangban'}
function calcSellTotal(){const box=document.getElementById('sellTotalBox');if(!box)return;const qty=getRaw('sellQty'),price=getRaw('sellPrice');if(qty>0&&price>0){box.style.display='block';box.textContent=`ğŸ’° ThÃ nh tiá»n: ${fmt(qty*price)}`}else box.style.display='none'}
function onImpSug(val){
  const drop=document.getElementById('impDrop'),q=(val||'').toLowerCase(),prods=loadProducts().filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';if(!prods.length){drop.classList.remove('open');return}
  prods.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.innerHTML=`<div>${p.name}</div><div class="sug-meta">${p.kind==='hangban'?'ğŸ›’ HÃ ng bÃ¡n láº¡i':'ğŸ§‚ NguyÃªn liá»‡u'}${p.unitIn?' Â· '+p.unitIn+'â†’'+p.unitOut:''}</div>`;d.onmousedown=()=>{setVal('impName',p.name);drop.classList.remove('open');setVal('impType',p.kind||'hangban');setVal('impUnitIn',p.unitIn||'');setVal('impUnitOut',p.unitOut||'');const fEl=document.getElementById('impFactor');if(fEl){fEl.value=p.factor||1;fEl.dataset.raw=String(p.factor||1)}toggleImpMode();showConvPreview()};drop.appendChild(d)});
  drop.classList.add('open');
}
function closeImpSug(){const d=document.getElementById('impDrop');if(d)d.classList.remove('open')}
function toggleImpMode(){const type=getVal('impType'),cf=document.getElementById('convFields');if(cf)cf.style.display=type==='nguyenlieu'?'none':'block'}
function showConvPreview(){const box=document.getElementById('convPreview');if(!box)return;const qty=getRaw('impQty'),factor=getRaw('impFactor')||1,uIn=getVal('impUnitIn')||'Ä‘Æ¡n vá»‹ nháº­p',uOut=getVal('impUnitOut')||'Ä‘Æ¡n vá»‹ bÃ¡n';if(qty>0&&factor>0){box.innerHTML=`ğŸ“¦ <strong>${qty} ${uIn}</strong> Ã— <strong>${factor}</strong> = <strong>${qty*factor} ${uOut}</strong> vÃ o kho`;box.classList.add('show')}else box.classList.remove('show')}

let _pendingSaleFn=null;
function showConfirm(title,msg,fn){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmOverlay').classList.add('show');document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();fn()}}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('show')}
function showStockAlert(msg,fn){document.getElementById('stockAlertMsg').innerHTML=msg;document.getElementById('stockAlertOverlay').classList.add('show');_pendingSaleFn=fn}
function closeStockAlert(){document.getElementById('stockAlertOverlay').classList.remove('show');_pendingSaleFn=null}
function forceConfirmSale(){closeStockAlert();if(_pendingSaleFn)_pendingSaleFn()}
let _toastTimer=null;
function showToast(msg,isErr=false,isOk=false){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className='';if(isErr)t.classList.add('err');if(isOk)t.classList.add('ok');t.classList.add('show');clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>t.classList.remove('show'),3500)}

function saveApiKey(){const v=document.getElementById('apiKeyInput').value.trim();if(!v){showToast('âš ï¸ Nháº­p key!',true);return}apiKey=v;document.getElementById('apiStatus').textContent='âœ… Sáºµn sÃ ng!';document.getElementById('apiStatus').style.color='#1B6B3A';document.getElementById('apiBar').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';showToast('âœ… ÄÃ£ lÆ°u API Key!',false,true)}

function addSale(forceSkip=false){
  const name=getVal('sellName'),qty=getRaw('sellQty'),price=getRaw('sellPrice'),date=getVal('sellDate'),desc=getVal('sellDesc');
  if(!name){showToast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}if(!qty){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}if(!price){showToast('âš ï¸ Nháº­p Ä‘Æ¡n giÃ¡!',true);return}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}
  const type=_curSellType||'hangban';
  if(type==='hangban'&&!forceSkip){const{stock,unitOut}=getStock(name);if(stock<qty){showStockAlert(`<strong>${name}</strong><br>Kho cÃ²n: <strong>${stock} ${unitOut}</strong><br>Äá»‹nh bÃ¡n: <strong>${qty} ${unitOut}</strong>`,()=>doSaveSale(name,type,qty,price,date,desc));return}}
  doSaveSale(name,type,qty,price,date,desc);
}
function doSaveSale(name,type,qty,price,date,desc){
  const{unitOut}=type==='hangban'?getStock(name):{unitOut:''};
  FIN.sales.push({id:Date.now(),name,type,qty,unitPrice:price,totalAmt:qty*price,date,desc:desc||('BÃ¡n '+name),unitOut});
  persist();renderAll();setVal('sellName','');clearMoneyField('sellQty');clearMoneyField('sellPrice');setVal('sellDesc','');
  document.getElementById('sellTotalBox').style.display='none';clearStockInfo();showToast(`âœ… ÄÃ£ ghi bÃ¡n ${qty} ${unitOut?unitOut+' ':''}${name}!`,false,true);
}
function delSale(id){showConfirm('XoÃ¡ giao dá»‹ch bÃ¡n','XoÃ¡ giao dá»‹ch nÃ y?',()=>{FIN.sales=FIN.sales.filter(x=>x.id!==id);persist();renderAll();showToast('âœ… ÄÃ£ xoÃ¡!')})}

function addImport(){
  const name=getVal('impName'),kind=getVal('impType')||'hangban',qtyIn=getRaw('impQty'),totalAmt=getRaw('impAmt'),date=getVal('impDate'),unitIn=getVal('impUnitIn')||'cÃ¡i',unitOut=kind==='nguyenlieu'?unitIn:(getVal('impUnitOut')||unitIn),factor=kind==='nguyenlieu'?1:(getRaw('impFactor')||1);
  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng!',true);return}if(!qtyIn){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}if(!totalAmt){showToast('âš ï¸ Nháº­p tá»•ng tiá»n!',true);return}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}
  const stockAdded=kind==='hangban'?qtyIn*factor:0;
  FIN.imports.push({id:Date.now(),name,kind,qtyIn,unitIn,unitOut,factor,stockAdded,totalAmt,date,desc:`Nháº­p ${qtyIn} ${unitIn} ${name}`});persist();
  if(kind==='hangban')upsertProduct({name,kind,unitIn,unitOut,factor,lastPrice:Math.round(totalAmt/(qtyIn*factor))});
  else upsertProduct({name,kind:'nguyenlieu',unitIn,unitOut:unitIn,factor:1,lastPrice:Math.round(totalAmt/qtyIn)});
  renderAll();renderInventory();setVal('impName','');clearMoneyField('impQty');clearMoneyField('impAmt');setVal('impUnitIn','');setVal('impUnitOut','');
  const fEl=document.getElementById('impFactor');if(fEl){fEl.value='';fEl.dataset.raw=''}
  document.getElementById('convPreview').classList.remove('show');document.getElementById('expAutofillNotice').classList.remove('show');
  showToast(kind==='hangban'?`âœ… Nháº­p ${qtyIn} ${unitIn} ${name} â†’ +${stockAdded} ${unitOut} vÃ o kho!`:`âœ… Ghi chi nguyÃªn liá»‡u ${name} (${fmt(totalAmt)})`);
}
function delImport(id){showConfirm('XoÃ¡ khoáº£n nháº­p','XoÃ¡ khoáº£n nháº­p hÃ ng nÃ y? Tá»“n kho sáº½ thay Ä‘á»•i.',()=>{FIN.imports=FIN.imports.filter(x=>x.id!==id);persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}

function addCost(){const desc=getVal('cpDesc'),amount=getRaw('cpAmt'),date=getVal('cpDate'),type=getVal('cpType');if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return}if(!amount){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}FIN.costs.push({id:Date.now(),desc,amount,type,date});persist();renderAll();renderCostTable();clearMoneyField('cpAmt');setVal('cpDesc','');showToast('âœ… ÄÃ£ thÃªm chi phÃ­!')}
function delCost(id){showConfirm('XoÃ¡ chi phÃ­','XoÃ¡ khoáº£n chi nÃ y?',()=>{FIN.costs=FIN.costs.filter(x=>x.id!==id);persist();renderAll();renderCostTable();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCostTable(){const w=document.getElementById('cpTableWrap');if(!w)return;const sorted=[...FIN.costs].sort((a,b)=>b.id-a.id);if(!sorted.length){w.innerHTML='<div class="empty"><div class="ei">âš¡</div>ChÆ°a cÃ³ chi phÃ­ nÃ o</div>';return}const typeMap={utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',loss:'ğŸ“‰ Hao há»¥t',rental:'ğŸª Máº·t báº±ng',labor:'ğŸ‘· NhÃ¢n cÃ´ng',other:'ğŸ“Œ KhÃ¡c'};w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>MÃ´ táº£</th><th>Tiá»n</th><th></th></tr></thead><tbody>${sorted.map(c=>`<tr><td>${fmtDate(c.date)}</td><td>${typeMap[c.type]||c.type}</td><td>${c.desc}</td><td class="chi-v">-${fmt(c.amount)}</td><td><button class="del-btn" onclick="delCost(${c.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`}

function addCookProduct(){const name=getVal('cbName'),price=getRaw('cbPrice');if(!name){showToast('âš ï¸ Nháº­p tÃªn!',true);return}const a=loadCookItems();if(a.find(x=>x.name===name)){showToast('âš ï¸ TÃªn Ä‘Ã£ tá»“n táº¡i!',true);return}a.push({id:Date.now(),name,price});saveCookItems(a);renderCookList();setVal('cbName','');clearMoneyField('cbPrice');showToast('âœ… ÄÃ£ thÃªm!')}
function delCookItem(id){showConfirm('XoÃ¡ sáº£n pháº©m','XoÃ¡ sáº£n pháº©m cháº¿ biáº¿n nÃ y?',()=>{saveCookItems(loadCookItems().filter(x=>x.id!==id));renderCookList();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCookList(){const el=document.getElementById('cookList');if(!el)return;const a=loadCookItems();if(!a.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ³</div>ChÆ°a cÃ³ sáº£n pháº©m cháº¿ biáº¿n nÃ o</div>';return}el.innerHTML=a.map(c=>`<div class="cook-item"><div class="cook-body"><div class="cook-name">${c.name}</div><div class="cook-meta">Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho</div></div><div class="cook-price">${c.price?fmt(c.price):'â€”'}</div><button class="cook-del" onclick="delCookItem(${c.id})">ğŸ—‘ï¸</button></div>`).join('')}

let periodBan='all',periodNhap='all',chartPeriod='week';
function setPeriod(tab,p,btn){if(tab==='ban')periodBan=p;else periodNhap=p;const pid=tab==='ban'?'msub-ban':'msub-nhap';document.querySelectorAll(`#${pid} .period-tab`).forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');if(tab==='ban')renderSaleTable();else renderImportTable()}
function setChartPeriod(p,btn){chartPeriod=p;document.querySelectorAll('#rsub-chart .period-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');refreshCharts()}
function filterByPeriod(arr,period){if(period==='all')return arr;const now=new Date(),tod=todayISO();return arr.filter(x=>{const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(period==='today')return d===tod;if(period==='week'){const dt=new Date(d+'T00:00'),w=new Date(now);w.setDate(now.getDate()-6);return dt>=w}if(period==='month')return d.slice(0,7)===curMonth;return true})}
function toggleSelectAll(tab,checked){document.querySelectorAll(`.cb-${tab}`).forEach(cb=>cb.checked=checked);updateBulkBtn(tab)}
function updateBulkBtn(tab){const c=document.querySelectorAll(`.cb-${tab}:checked`).length,b=document.getElementById(tab+'BulkBtn');if(b)b.style.display=c>0?'inline-flex':'none'}
function bulkDelete(tab){const ids=[];document.querySelectorAll(`.cb-${tab}:checked`).forEach(cb=>ids.push(parseInt(cb.value)));if(!ids.length){showToast('âš ï¸ ChÆ°a chá»n!',true);return}showConfirm(`XoÃ¡ ${ids.length} giao dá»‹ch`,'KhÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{const s=new Set(ids);if(tab==='ban')FIN.sales=FIN.sales.filter(x=>!s.has(x.id));else FIN.imports=FIN.imports.filter(x=>!s.has(x.id));persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function confirmDeleteAll(tab){const label=tab==='ban'?'bÃ¡n hÃ ng':'nháº­p hÃ ng';showConfirm('XoÃ¡ táº¥t cáº£',`XoÃ¡ TOÃ€N Bá»˜ ${label} thÃ¡ng ${monthLabel(curMonth)}?`,()=>{if(tab==='ban')FIN.sales=[];else FIN.imports=[];persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}

function renderAll(){renderSummary();renderSaleTable();renderImportTable()}
function renderSummary(){const thu=getRevenue(curMonth),chi=getCost(curMonth),profit=thu-chi;[['h-thu','m-thu'],['h-chi','m-chi'],['h-profit','m-profit']].forEach(([id1,id2],i)=>{const val=i===0?thu:i===1?chi:profit,txt=i===2?((profit>=0?'+':'')+fmt(profit)):fmt(val),clr=i===2?(profit>=0?'var(--p600)':'var(--red)'):'';[id1,id2].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.textContent=txt;if(clr)el.style.color=clr})})}
function renderSaleTable(){const w=document.getElementById('banTableWrap');if(!w)return;const filtered=filterByPeriod(FIN.sales,periodBan).slice().sort((a,b)=>b.id-a.id);if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ giao dá»‹ch bÃ¡n</div>';return}w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>SL</th><th>Doanh thu</th><th></th></tr></thead><tbody>${filtered.map(t=>`<tr><td class="cb-cell"><input type="checkbox" class="cb-ban" value="${t.id}" onchange="updateBulkBtn('ban')"></td><td>${fmtDate(t.date)}</td><td><span class="tag ${t.type==='chebien'?'tag-cook':'tag-sell'}">${t.name}</span></td><td>${t.qty}${t.unitOut?' '+t.unitOut:''}</td><td class="thu-v">+${fmt(t.totalAmt)}</td><td><button class="del-btn" onclick="delSale(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`}
function renderImportTable(){const w=document.getElementById('nhapTableWrap');if(!w)return;const filtered=filterByPeriod(FIN.imports,periodNhap).slice().sort((a,b)=>b.id-a.id);if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>ChÆ°a cÃ³ khoáº£n nháº­p</div>';return}w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>HÃ ng hÃ³a</th><th>Sá»‘ lÆ°á»£ng</th><th>Chi</th><th></th></tr></thead><tbody>${filtered.map(t=>`<tr><td class="cb-cell"><input type="checkbox" class="cb-nhap" value="${t.id}" onchange="updateBulkBtn('nhap')"></td><td>${fmtDate(t.date)}</td><td><span class="tag ${t.kind==='nguyenlieu'?'tag-mat':'tag-imp'}">${t.name}</span></td><td>${t.qtyIn} ${t.unitIn}${t.kind==='hangban'?' â†’ '+t.stockAdded+' '+t.unitOut:''}</td><td class="chi-v">-${fmt(t.totalAmt)}</td><td><button class="del-btn" onclick="delImport(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`}

function renderInventory(){
  const el=document.getElementById('inventoryView');if(!el)return;
  const inv=computeInventory();if(!inv.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng â€” hÃ£y nháº­p hÃ ng trÆ°á»›c</div>';return}
  const outItems=inv.filter(x=>x.stockUnits===0),lowItems=inv.filter(x=>x.stockUnits>0&&x.stockUnits<LOW_STOCK),okItems=inv.filter(x=>x.stockUnits>=LOW_STOCK),now=new Date();
  const slowItems=okItems.filter(x=>{if(!x.lastInDate)return false;const d=new Date(x.lastInDate+'T00:00');return Math.floor((now-d)/86400000)>=30&&x.totalSold===0});
  let html='';
  const urgents=[...outItems.map(x=>`<strong>${x.name}</strong>(háº¿t)`),...lowItems.map(x=>`<strong>${x.name}</strong>(${x.stockUnits})`)];
  if(urgents.length)html+=`<div class="inv-restock-notice">ğŸ”” Cáº§n nháº­p thÃªm: ${urgents.join(' Â· ')}</div>`;
  if(outItems.length){html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”´ ÄÃ£ háº¿t hÃ ng (${outItems.length})</div>`;outItems.forEach(x=>{html+=invCard(x,'out')});html+='</div>'}
  if(lowItems.length){html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¡ Sáº¯p háº¿t (dÆ°á»›i ${LOW_STOCK})</div>`;lowItems.forEach(x=>{html+=invCard(x,'low')});html+='</div>'}
  if(slowItems.length){html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”µ HÃ ng bÃ¡n cháº­m</div>`;slowItems.forEach(x=>{const days=Math.floor((now-new Date(x.lastInDate+'T00:00'))/86400000);html+=invCard(x,'slow',days)});html+='</div>'}
  const okFiltered=okItems.filter(x=>!slowItems.find(s=>s.name===x.name));
  if(okFiltered.length){html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¢ Äá»§ hÃ ng (${okFiltered.length})</div>`;okFiltered.forEach(x=>{html+=invCard(x,'ok')});html+='</div>'}
  el.innerHTML=html||'<div class="empty"><div class="ei">ğŸ“¦</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';
}
function invCard(x,st,days){
  const icons={out:'ğŸ”´',low:'ğŸŸ¡',ok:'ğŸŸ¢',slow:'ğŸ”µ'},clsMap={out:'inv-alert-out',low:'inv-alert-low',ok:'inv-alert-ok',slow:'inv-alert-slow'},qtyClsMap={out:'qty-out',low:'qty-low',ok:'qty-ok'};
  const meta=st==='slow'?`Nháº­p ${days} ngÃ y trÆ°á»›c Â· Tá»“n: ${x.stockUnits} ${x.unitOut}`:(x.unitIn&&x.unitIn!==x.unitOut?`Nháº­p: ${x.unitIn} â†’ BÃ¡n: ${x.unitOut} (Ã—${x.factor})`:`ÄÆ¡n vá»‹: ${x.unitOut}`);
  const qtyLabel=st==='out'?'Háº¿t hÃ ng':st==='slow'?'Cháº­m bÃ¡n':`CÃ²n ${x.stockUnits} ${x.unitOut}`;
  return`<div class="inv-alert-card ${clsMap[st]}"><div class="inv-alert-icon">${icons[st]}</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">${meta}</div></div><span class="inv-alert-qty ${qtyClsMap[st]||'qty-ok'}">${qtyLabel}</span></div>`;
}

function renderHomeRecent(){const w=document.getElementById('homeRecentWrap');if(!w)return;const all=[...FIN.sales.map(x=>({...x,txType:'ban'})),...FIN.imports.map(x=>({...x,txType:'nhap'}))].sort((a,b)=>b.id-a.id).slice(0,8);if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return}w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn hÃ ng</th><th>Tiá»n</th></tr></thead><tbody>${all.map(x=>`<tr><td>${fmtDate(x.date)}</td><td>${x.txType==='ban'?'<span class="tag tag-sell">ğŸ’° BÃ¡n</span>':'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>'}</td><td>${x.name||''}</td><td class="${x.txType==='ban'?'thu-v':'chi-v'}">${x.txType==='ban'?'+':'-'}${fmt(x.totalAmt)}</td></tr>`).join('')}</tbody></table></div>`}

let _csvData=[];
function renderHistory(){
  const months=getMonthOpts(),all=[];
  months.forEach(mk=>{const f=loadFin(mk);f.sales.forEach(x=>all.push({...x,txType:'ban',mk}));f.imports.forEach(x=>all.push({...x,txType:'nhap',mk}));f.costs.forEach(x=>all.push({...x,txType:'chiphi',mk}))});
  all.sort((a,b)=>b.id-a.id);
  const search=getVal('histSearch').toLowerCase(),typeF=getVal('histType'),monthF=getVal('histMonth');
  const mSel=document.getElementById('histMonth');if(mSel){const cur=mSel.value;mSel.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+months.map(m=>`<option value="${m}"${m===cur?' selected':''}>${monthLabel(m)}</option>`).join('')}
  const filtered=all.filter(x=>{const name=(x.name||x.desc||'').toLowerCase();if(search&&!name.includes(search))return false;if(typeF&&x.txType!==typeF)return false;if(monthF&&x.mk!==monthF)return false;return true});
  _csvData=filtered;
  const thu=filtered.filter(x=>x.txType==='ban').reduce((s,x)=>s+x.totalAmt,0),chi=filtered.filter(x=>x.txType!=='ban').reduce((s,x)=>s+(x.totalAmt||x.amount||0),0),profit=thu-chi;
  const se=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};se('hAllThu',fmt(thu));se('hAllChi',fmt(chi));
  const pe=document.getElementById('hAllProfit');if(pe){pe.textContent=(profit>=0?'+':'')+fmt(profit);pe.style.color=profit>=0?'var(--p600)':'var(--red)'}
  const w=document.getElementById('histTableWrap');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch</div>';return}
  const tagMap={ban:'<span class="tag tag-sell">ğŸ’° BÃ¡n</span>',nhap:'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>',chiphi:'<span class="tag tag-op">âš¡ Chi phÃ­</span>'};
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn</th><th>Tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${filtered.map(x=>{const amt=x.txType==='ban'?x.totalAmt:(x.totalAmt||x.amount||0);return`<tr class="hist-row-clickable" onclick="jumpToMonth('${x.mk}')"><td>${fmtDate(x.date)}</td><td>${tagMap[x.txType]||''}</td><td>${x.name||x.desc||'â€”'}</td><td class="${x.txType==='ban'?'thu-v':'chi-v'}">${x.txType==='ban'?'+':'-'}${fmt(amt)}</td><td><span class="jump-badge">${monthLabel(x.mk)}</span></td></tr>`}).join('')}</tbody></table></div>`
}
function jumpToMonth(key){curMonth=key;FIN=loadFin(key);buildMonthSelect();renderAll();switchPage('money',document.querySelectorAll('.bn-btn')[1]);showToast(`âœ… ÄÃ£ chuyá»ƒn â†’ ${monthLabel(key)}`)}
function exportCSV(){if(!_csvData.length){showToast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u!',true);return}const rows=['NgÃ y,Loáº¡i,TÃªn,Sá»‘ tiá»n,ThÃ¡ng',..._csvData.map(x=>{const loai=x.txType==='ban'?'BÃ¡n':x.txType==='nhap'?'Nháº­p':'Chi phÃ­',amt=x.txType==='ban'?x.totalAmt:(x.totalAmt||x.amount||0);return`"${x.date}","${loai}","${(x.name||x.desc||'').replace(/"/g,'""')}","${amt}","${x.mk}"`})].join('\n');writeClip(rows,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!')}

function getInvSummary(){const inv=computeInventory();if(!inv.length)return'Kho trá»‘ng.';const out=inv.filter(x=>x.stockUnits===0).map(x=>x.name),low=inv.filter(x=>x.stockUnits>0&&x.stockUnits<LOW_STOCK).map(x=>`${x.name}(${x.stockUnits}${x.unitOut?' '+x.unitOut:''})`),ok=inv.filter(x=>x.stockUnits>=LOW_STOCK).map(x=>`${x.name}:${x.stockUnits}${x.unitOut?' '+x.unitOut:''}`);let s='';if(out.length)s+=`Háº¿t: ${out.join(', ')}. `;if(low.length)s+=`Sáº¯p háº¿t: ${low.join(', ')}. `;if(ok.length)s+=`Äá»§: ${ok.join(', ')}.`;return s}
function updateAIStatusBar(){const el=document.getElementById('aiInvSummary');if(!el)return;const inv=computeInventory();if(!inv.length){el.innerHTML='Kho trá»‘ng';return}const out=inv.filter(x=>x.stockUnits===0).length,low=inv.filter(x=>x.stockUnits>0&&x.stockUnits<LOW_STOCK).length,ok=inv.filter(x=>x.stockUnits>=LOW_STOCK).length;const parts=[];if(out)parts.push(`<strong style="color:#FF8A80">${out} háº¿t hÃ ng</strong>`);if(low)parts.push(`<strong style="color:#FFD54F">${low} sáº¯p háº¿t</strong>`);if(ok)parts.push(`<strong style="color:#A8E6C1">${ok} Ä‘á»§ hÃ ng</strong>`);el.innerHTML=parts.join(' Â· ')||'Kho á»•n Ä‘á»‹nh âœ…'}
function setChatStatus(t,busy){const el=document.getElementById('chatStatusDot');if(el)el.textContent=busy?'â³ '+t:'â— '+t}
function autoResizeChat(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,100)+'px'}
function useChip(btn){const text=btn.textContent.replace(/^[\p{Emoji}\s]+/u,'').trim();const inp=document.getElementById('chatInp');if(inp){inp.value=text;inp.focus()}}

async function sendChat(){
  const inp=document.getElementById('chatInp'),msg=inp?inp.value.trim():'';
  if(!msg)return;
  if(!apiKey){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return}
  if(inp){inp.value='';inp.style.height='auto'}
  addMsg(msg,'user');setChatStatus('Äang xá»­ lÃ½...',true);
  const typing=document.getElementById('chatTyping');if(typing)typing.classList.add('show');scrollChat();
  const thu=getRevenue(curMonth),chi=getCost(curMonth);
  const prompt=`Báº¡n lÃ  trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, nÃ³i chuyá»‡n thÃ¢n thiá»‡n vá»›i ngÆ°á»i bÃ¡n táº¡p hÃ³a Viá»‡t Nam.\n\nKHO: ${getInvSummary()}\nTHÃNG ${curMonth}: Thu=${fmt(thu)}, Chi=${fmt(chi)}, LÃ£i=${fmt(thu-chi)}\n\nTráº£ lá»i ngáº¯n gá»n (1-2 cÃ¢u + emoji).\nNáº¿u ngÆ°á»i dÃ¹ng nÃ³i giao dá»‹ch, tráº£ vá» JSON trong []: [{"item":"tÃªn","quantity":sá»‘,"price":Ä‘Æ¡n_giÃ¡,"type":"bÃ¡n hoáº·c nháº­p"}]\nKhÃ´ng giáº£i thÃ­ch dÃ i dÃ²ng.\n\nTin: ${msg}`;
  try{
    const raw=await callGemini([{text:prompt}]);
    if(typing)typing.classList.remove('show');setChatStatus('Sáºµn sÃ ng',false);
    const jm=raw.match(/\[[\s\S]*?\]/);
    if(jm){try{const parsed=JSON.parse(jm[0]);if(parsed.length){const preview=parsed.map(x=>`${/(nháº­p)/i.test(x.type)?'ğŸ“¦ Nháº­p':'ğŸ’° BÃ¡n'} ${x.quantity} ${x.item}${x.price>0?' @ '+fmt(x.price):''}`).join('\n');addMsgWithConfirm((raw.replace(jm[0],'').trim()||'MÃ¬nh ghi nháº­n:')+'\n\n'+preview,parsed);return}}catch{}}
    addMsg(raw,'bot');
  }catch(err){if(typing)typing.classList.remove('show');setChatStatus('Lá»—i',false);addMsg('âŒ '+err.message,'bot')}
}
function addMsgWithConfirm(text,data){
  const msgs=document.getElementById('chatMsgs');if(!msgs)return;
  const div=document.createElement('div');div.className='msg bot';
  div.innerHTML=text.replace(/\n/g,'<br>')+`<div class="confirm-pill"><button class="pill-yes" onclick="confirmAITx(this,true)">âœ… LÆ°u</button><button class="pill-no" onclick="confirmAITx(this,false)">âŒ Bá»</button></div>`;
  div._aiData=data;msgs.insertBefore(div,document.getElementById('chatTyping'));scrollChat();
}
function confirmAITx(btn,yes){const msgDiv=btn.closest('.msg'),data=msgDiv._aiData,pill=msgDiv.querySelector('.confirm-pill');if(pill)pill.remove();if(yes&&data)processAITx(data);else addMsg('ğŸ‘ OK, bá» qua nhÃ©!','bot');scrollChat()}
function processAITx(items){
  if(!Array.isArray(items))return;
  const today=nowDatetimeLocal();
  items.forEach(it=>{
    const name=(it.item||it.name||'').trim();if(!name)return;
    const qty=parseInt(String(it.quantity||1).replace(/\D/g,''))||1,price=parseInt(String(it.price||0).replace(/\D/g,''))||0,isSale=/(bÃ¡n|thu|sell)/i.test(it.type||'');
    if(isSale){const{stock,unitOut}=getStock(name);if(stock<qty){showStockAlert(`<strong>${name}</strong><br>Kho cÃ²n: ${stock} ${unitOut}<br>Äá»‹nh bÃ¡n: ${qty}`,()=>{FIN.sales.push({id:Date.now(),name,type:'hangban',qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut});persist();renderAll();showToast(`âœ… Ghi bÃ¡n ${qty} ${name}!`)});return}FIN.sales.push({id:Date.now(),name,type:'hangban',qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut})}
    else{FIN.imports.push({id:Date.now(),name,kind:'hangban',qtyIn:qty,unitIn:'',unitOut:'',factor:1,stockAdded:qty,totalAmt:qty*price,date:today});upsertProduct({name,kind:'hangban',unitIn:'',unitOut:'',factor:1})}
    persist();
  });
  renderAll();renderInventory();updateAIStatusBar();showToast(`âœ… ÄÃ£ ghi ${items.length} giao dá»‹ch!`);
}
function addMsg(text,role){const msgs=document.getElementById('chatMsgs');if(!msgs)return;const div=document.createElement('div');div.className='msg '+role;div.innerHTML=text.replace(/\n/g,'<br>');msgs.insertBefore(div,document.getElementById('chatTyping'));scrollChat()}
function scrollChat(){const m=document.getElementById('chatMsgs');if(m)m.scrollTop=m.scrollHeight}
function askAIInventory(){switchPage('ai',document.querySelectorAll('.bn-btn')[4]);setTimeout(()=>{const inp=document.getElementById('chatInp');if(inp){inp.value='TÃ¬nh hÃ¬nh hÃ ng hÃ³a trong kho cá»§a tÃ´i tháº¿ nÃ o?';sendChat()}},200)}

async function callGemini(parts){
  if(!apiKey)throw new Error('ChÆ°a cÃ³ API Key!');
  const res=await fetch(`${GEMINI_URL}?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}],generationConfig:{maxOutputTokens:700,temperature:.3}})});
  if(!res.ok)throw new Error(`HTTP ${res.status}`);const data=await res.json();if(data.error)throw new Error(data.error.message||'Lá»—i API');
  const txt=data?.candidates?.[0]?.content?.parts?.[0]?.text;if(!txt)throw new Error('AI khÃ´ng tráº£ vá» ná»™i dung');return txt;
}

let _invoiceB64='',_incInvB64='',_invoiceRows=[];
function handleInvoiceImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{_invoiceB64=ev.target.result.split(',')[1];const box=document.getElementById('expImgBox'),img=document.getElementById('invoicePreview');if(box)box.style.display='block';if(img)img.src=ev.target.result;document.getElementById('scanBtn').disabled=false};r.readAsDataURL(f)}
function resetExpImg(){_invoiceB64='';document.getElementById('invoiceImg').value='';const box=document.getElementById('expImgBox');if(box)box.style.display='none';document.getElementById('scanBtn').disabled=true}
async function scanInvoice(){
  if(!apiKey){showToast('âš ï¸ Nháº­p API Key!',true);return}
  const loader=document.getElementById('scanLoader'),wrap=document.getElementById('invoiceTableWrap'),acts=document.getElementById('invActions'),btn=document.getElementById('scanBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML=''}if(acts)acts.style.display='none';if(btn)btn.disabled=true;_invoiceRows=[];document.getElementById('expAutofillNotice').classList.remove('show');
  const PROMPT=`TrÃ­ch xuáº¥t táº¥t cáº£ máº·t hÃ ng tá»« hÃ³a Ä‘Æ¡n. Tráº£ vá» JSON khÃ´ng markdown:\n{"rows":[{"ten":"tÃªn hÃ ng","soluong":"sá»‘ lÆ°á»£ng","dongia":"Ä‘Æ¡n giÃ¡","thanhtien":"thÃ nh tiá»n"}]}`;
  try{const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_invoiceB64}},{text:PROMPT}]);let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim())}catch{}if(loader)loader.classList.remove('show');if(parsed?.rows?.length){_invoiceRows=parsed.rows;if(wrap){wrap.innerHTML=`<table class="inv-tbl"><thead><tr><th>TÃªn hÃ ng</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th></tr></thead><tbody>${parsed.rows.map(r=>`<tr><td>${r.ten||''}</td><td>${r.soluong||''}</td><td>${r.dongia||''}</td><td style="font-weight:800;color:var(--p700)">${r.thanhtien||''}</td></tr>`).join('')}</tbody></table>`;wrap.classList.add('show')}if(acts)acts.style.display='flex'}else if(wrap){wrap.innerHTML=`<pre style="padding:8px;font-size:.75rem;overflow:auto;max-height:150px">${raw}</pre>`;wrap.classList.add('show')}}catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true)}if(btn)btn.disabled=false;
}
function autoFillImport(){if(!_invoiceRows.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return}const first=_invoiceRows[0];setVal('impName',first.ten||'');const q=(first.soluong||'').replace(/\D/g,'');const qEl=document.getElementById('impQty');if(qEl){qEl.dataset.raw=q;qEl.value=q?parseInt(q).toLocaleString('vi-VN'):''}const rawA=(first.thanhtien||'').replace(/\D/g,'');const aEl=document.getElementById('impAmt');if(aEl&&rawA){aEl.dataset.raw=rawA;aEl.value=parseInt(rawA).toLocaleString('vi-VN')}document.getElementById('expAutofillNotice').classList.add('show');showToast('âœ… ÄÃ£ Ä‘iá»n form!')}
async function copyInvoiceCSV(){if(!_invoiceRows.length){showToast('âš ï¸ ChÆ°a cÃ³!',true);return}const csv=['TÃªn,SL,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',..._invoiceRows.map(r=>`"${r.ten||''}","${r.soluong||''}","${r.dongia||''}","${r.thanhtien||''}"`)].join('\n');await writeClip(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!')}
let _incItems=[]; // preview items array

function handleIncInvoice(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{_incInvB64=ev.target.result.split(',')[1];const box=document.getElementById('incImgBox'),img=document.getElementById('incInvoicePreview');if(box)box.style.display='block';if(img)img.src=ev.target.result;document.getElementById('scanIncBtn').disabled=false};r.readAsDataURL(f)}
function resetIncImg(){_incInvB64='';_incItems=[];document.getElementById('incInvoiceFile').value='';const box=document.getElementById('incImgBox');if(box)box.style.display='none';document.getElementById('scanIncBtn').disabled=true;document.getElementById('incPreviewWrap').classList.remove('show');document.getElementById('incAutofillNotice').classList.remove('show')}

async function scanIncInvoice(){
  if(!apiKey){showToast('âš ï¸ Nháº­p API Key!',true);return}
  const loader=document.getElementById('scanIncLoader'),btn=document.getElementById('scanIncBtn');
  if(loader)loader.classList.add('show');if(btn)btn.disabled=true;
  document.getElementById('incAutofillNotice').classList.remove('show');
  document.getElementById('incPreviewWrap').classList.remove('show');
  _incItems=[];

  const PROMPT=`Báº¡n lÃ  há»‡ thá»‘ng OCR chuyÃªn nghiá»‡p. HÃ£y Ä‘á»c áº£nh bill/hÃ³a Ä‘Æ¡n nÃ y vÃ  trÃ­ch xuáº¥t Tá»ªNG MÃ“N HÃ€NG RIÃŠNG BIá»†T.
YÃŠU Cáº¦U Báº®T BUá»˜C:
- Tráº£ vá» má»™t Máº¢NG JSON (Array), KHÃ”NG pháº£i object Ä‘Æ¡n láº».
- Má»—i pháº§n tá»­ trong máº£ng lÃ  Má»˜T MÃ“N HÃ€NG DUY NHáº¤T.
- KHÃ”NG Ä‘Æ°á»£c gá»™p nhiá»u mÃ³n thÃ nh má»™t.
- Náº¿u cÃ³ 5 mÃ³n thÃ¬ máº£ng pháº£i cÃ³ Ä‘Ãºng 5 pháº§n tá»­.
- Tráº£ vá» JSON thuáº§n tÃºy, KHÃ”NG cÃ³ markdown, KHÃ”NG cÃ³ backtick.
Cáº¥u trÃºc báº¯t buá»™c:
[
  { "name": "tÃªn mÃ³n hÃ ng", "quantity": sá»‘_lÆ°á»£ng_nguyÃªn, "price": Ä‘Æ¡n_giÃ¡_nguyÃªn, "total": thÃ nh_tiá»n_nguyÃªn },
  { "name": "mÃ³n tiáº¿p theo", "quantity": 1, "price": 50000, "total": 50000 }
]
NgÃ y trÃªn bill (náº¿u cÃ³, Ä‘á»‹nh dáº¡ng YYYY-MM-DD): Ä‘áº·t vÃ o field "date" á»Ÿ pháº§n tá»­ Ä‘áº§u tiÃªn.`;

  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_incInvB64}},{text:PROMPT}]);
    if(loader)loader.classList.remove('show');
    // parse: strip markdown fences, find array
    let clean=raw.replace(/```json|```/g,'').trim();
    const arrMatch=clean.match(/\[[\s\S]*\]/);
    let parsed=null;
    if(arrMatch){try{parsed=JSON.parse(arrMatch[0])}catch{}}
    if(!parsed||!Array.isArray(parsed)||!parsed.length){
      showToast('âš ï¸ AI khÃ´ng tÃ¡ch Ä‘Æ°á»£c mÃ³n â€” thá»­ láº¡i!',true);
      if(btn)btn.disabled=false;return;
    }
    // normalize
    _incItems=parsed.map((it,i)=>({
      _id:i,
      removed:false,
      name:(it.name||it.item||it.ten||'MÃ³n '+(i+1)).trim(),
      quantity:Math.max(1,parseInt(it.quantity||it.qty||it.soluong||1)||1),
      price:parseInt(String(it.price||it.dongia||it.unitPrice||0).replace(/\D/g,'')||0),
      total:parseInt(String(it.total||it.thanhtien||it.totalAmt||0).replace(/\D/g,'')||0),
      date:it.date||''
    }));
    // if total missing, calc from price*qty
    _incItems.forEach(it=>{if(!it.total&&it.price&&it.quantity)it.total=it.price*it.quantity});
    renderIncPreview();
    document.getElementById('incAutofillNotice').classList.add('show');
    showToast(`âœ… TÃ¡ch Ä‘Æ°á»£c ${_incItems.length} mÃ³n!`,false,true);
  }catch(err){
    if(loader)loader.classList.remove('show');
    showToast('âŒ '+err.message,true);
  }
  if(btn)btn.disabled=false;
}

function renderIncPreview(){
  const wrap=document.getElementById('incPreviewWrap'),list=document.getElementById('incPreviewList');
  if(!wrap||!list)return;
  const active=_incItems.filter(x=>!x.removed);
  list.innerHTML=_incItems.map(it=>`
    <div class="inv-preview-item${it.removed?' remove':''}" id="incpi-${it._id}">
      <span class="inv-preview-idx">${it._id+1}</span>
      <span class="inv-preview-name">${it.name}</span>
      <span class="inv-preview-meta">Ã—${it.quantity} Â· ${it.price?fmt(it.price)+'/cÃ¡i':''} Â· <strong>${fmt(it.total||it.price*it.quantity)}</strong></span>
      <button class="inv-preview-del" onclick="toggleIncItem(${it._id})">${it.removed?'â†©ï¸':'ğŸ—‘ï¸'}</button>
    </div>`).join('');
  const grandTotal=active.reduce((s,x)=>s+(x.total||x.price*x.quantity),0);
  document.getElementById('incPreviewCount').textContent=`${active.length}/${_incItems.length} mÃ³n Ä‘Æ°á»£c chá»n`;
  document.getElementById('incPreviewTotal').textContent=grandTotal?`Tá»•ng: ${fmt(grandTotal)}`:'';
  wrap.classList.add('show');
}

function toggleIncItem(id){
  const it=_incItems.find(x=>x._id===id);if(it)it.removed=!it.removed;
  renderIncPreview();
}

function confirmIncItems(){
  const active=_incItems.filter(x=>!x.removed);
  if(!active.length){showToast('âš ï¸ KhÃ´ng cÃ³ mÃ³n nÃ o Ä‘Æ°á»£c chá»n!',true);return}
  const today=nowDatetimeLocal();
  let saved=0;
  active.forEach(it=>{
    const name=it.name,qty=it.quantity,price=it.price||Math.round((it.total||0)/qty)||0,date=it.date?it.date+'T00:00':today;
    if(!name||!qty)return;
    const{unitOut}=getStock(name);
    FIN.sales.push({id:Date.now()+Math.random(),name,type:'hangban',qty,unitPrice:price,totalAmt:it.total||(qty*price),date,desc:'Bill: '+name,unitOut});
    saved++;
  });
  persist();renderAll();
  document.getElementById('incPreviewWrap').classList.remove('show');
  document.getElementById('incAutofillNotice').classList.remove('show');
  _incItems=[];
  showToast(`âœ… ÄÃ£ lÆ°u ${saved} mÃ³n tá»« bill!`,false,true);
}

let _fbB64='';
function handleFbImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{_fbB64=ev.target.result.split(',')[1];const box=document.getElementById('fbImgBox'),img=document.getElementById('fbPreview');if(box)box.style.display='block';if(img)img.src=ev.target.result;document.getElementById('fbBtn').disabled=false};r.readAsDataURL(f)}
function resetFbImg(){_fbB64='';document.getElementById('fbImgInput').value='';const box=document.getElementById('fbImgBox');if(box)box.style.display='none';document.getElementById('fbBtn').disabled=true}
async function genFbPost(){
  if(!apiKey||!_fbB64){showToast('âš ï¸ Cáº§n API Key vÃ  áº£nh!',true);return}
  const card=document.getElementById('fbResultCard'),loader=document.getElementById('fbLoader'),box=document.getElementById('fbPost'),btn=document.getElementById('copyFb'),postBtn=document.getElementById('fbBtn');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');if(postBtn)postBtn.disabled=true;
  try{const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:_fbB64}},{text:'Viáº¿t bÃ i Ä‘Äƒng Facebook bÃ¡n hÃ ng cho tiá»ƒu thÆ°Æ¡ng VN. CÃ³ emoji, call-to-action, hashtag. Chá»‰ tráº£ vá» bÃ i viáº¿t.'}]);if(loader)loader.classList.remove('show');if(box){box.textContent=raw;box.classList.add('show')}if(btn)btn.classList.add('show')}
  catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show')}showToast('âŒ '+err.message,true)}
  if(postBtn)postBtn.disabled=false;
}
async function genScript(){
  if(!apiKey){showToast('âš ï¸ Nháº­p API Key!',true);return}const product=getVal('ttProduct');if(!product){showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return}
  const roleMap={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},xung=roleMap[getVal('ttRole')]||'báº¡n';
  const card=document.getElementById('ttResultCard'),loader=document.getElementById('ttLoader'),box=document.getElementById('ttScript'),btn=document.getElementById('copyScript');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');
  try{const text=await callGemini([{text:`HÆ°á»›ng dáº«n ${xung} quay TikTok bÃ¡n "${product}". NgÃ´n ngá»¯ Ä‘Æ¡n giáº£n, 3 bÆ°á»›c rÃµ. Káº¿t: "${xung.charAt(0).toUpperCase()+xung.slice(1)} cá»© quay xong Ä‘Äƒng luÃ´n ğŸ’š"`}]);if(loader)loader.classList.remove('show');if(box){box.textContent=text;box.classList.add('show')}if(btn)btn.classList.add('show')}
  catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show')}showToast('âŒ '+err.message,true)}
}

function renderTax(){const el=document.getElementById('taxBox');if(!el)return;const yr=new Date().getFullYear(),yearRev=allMonthKeys().filter(k=>k.startsWith(yr+'')).reduce((s,k)=>s+getRevenue(k),0),mo=new Date().getMonth()+1,avg=mo>0?yearRev/mo:0,projected=avg*12,remaining=TAX_THRESHOLD-yearRev;let html='';if(yearRev>=TAX_THRESHOLD)html=`<div class="tax-box tax-danger"><span class="tx-icon">âš ï¸</span><div class="tx-msg">Doanh thu vÆ°á»£t 500 triá»‡u â€” cáº§n ná»™p thuáº¿!</div><span class="tax-amount">${fmt(yearRev*TAX_RATE)}</span><div class="tx-detail"><strong>Doanh thu ${yr}:</strong> ${fmt(yearRev)}<br><strong>Thuáº¿ 1.5%:</strong> ${fmt(yearRev*TAX_RATE)}</div></div>`;else if(projected>=TAX_THRESHOLD)html=`<div class="tax-box tax-warn"><span class="tx-icon">ğŸ””</span><div class="tx-msg">Dá»± bÃ¡o cÃ³ thá»ƒ cháº¡m ngÆ°á»¡ng 500tr!</div><div class="tx-detail"><strong>ÄÃ£ thu:</strong> ${fmt(yearRev)}<br><strong>Dá»± bÃ¡o cáº£ nÄƒm:</strong> ${fmt(projected)}<br><strong>CÃ²n láº¡i:</strong> ${fmt(Math.max(0,remaining))}</div></div>`;else html=`<div class="tax-box tax-safe"><span class="tx-icon">ğŸ˜Š</span><div class="tx-msg">ChÆ°a pháº£i ná»™p thuáº¿. Cá»© yÃªn tÃ¢m bÃ¡n!</div><div class="tx-detail"><strong>ÄÃ£ thu ${yr}:</strong> ${fmt(yearRev)}<br><strong>CÃ³ thá»ƒ bÃ¡n thÃªm:</strong> ${fmt(Math.max(0,remaining))}</div></div>`;el.innerHTML=html}
function showCompare(){const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;if(!a||!b||a===b){showToast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return}const aThu=getRevenue(a),aChi=getCost(a),aL=aThu-aChi,bThu=getRevenue(b),bChi=getCost(b),bL=bThu-bChi;const delta=(cur,prv)=>{const d=cur-prv,p=prv>0?Math.round(d/prv*100):0;return`<div class="cmp-delta ${d>=0?'delta-up':'delta-down'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${p}%)</div>`};const box=document.getElementById('compareBox');box.innerHTML=`<h3>ğŸ“Š ${monthLabel(a)} vs ${monthLabel(b)}</h3><div class="cmp-grid"><div class="cmp-item"><div class="cmp-lbl">ğŸ“ˆ Thu</div><div class="cmp-cur">${fmt(aThu)}</div><div class="cmp-prev">${fmt(bThu)}</div>${delta(aThu,bThu)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ“‰ Chi</div><div class="cmp-cur">${fmt(aChi)}</div><div class="cmp-prev">${fmt(bChi)}</div>${delta(aChi,bChi)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ’¼ LÃ£i</div><div class="cmp-cur" style="color:${aL>=0?'var(--p600)':'var(--red)'}">${(aL>=0?'+':'')+fmt(aL)}</div><div class="cmp-prev">${(bL>=0?'+':'')+fmt(bL)}</div>${delta(aL,bL)}</div></div>`;box.classList.add('show')}
function buildAllTimeCompare(){const el=document.getElementById('allTimeCompare');if(!el)return;const opts=getMonthOpts();if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return}const rows=opts.map(k=>{const thu=getRevenue(k),chi=getCost(k),l=thu-chi;return`<tr><td>${monthLabel(k)}</td><td class="thu-v">+${fmt(thu)}</td><td class="chi-v">-${fmt(chi)}</td><td style="font-weight:800;color:${l>=0?'var(--p600)':'var(--red)'}">${(l>=0?'+':'')+fmt(l)}</td></tr>`}).join('');const aT=opts.reduce((s,k)=>s+getRevenue(k),0),aC=opts.reduce((s,k)=>s+getCost(k),0),aL=aT-aC;el.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:var(--p700);color:#fff"><td style="padding:6px 7px;font-weight:800">Tá»•ng</td><td style="padding:6px 7px;font-weight:900">+${fmt(aT)}</td><td style="padding:6px 7px;font-weight:900">-${fmt(aC)}</td><td style="padding:6px 7px;font-weight:900;color:${aL>=0?'#A8E6C1':'#FFB3AA'}">${(aL>=0?'+':'')+fmt(aL)}</td></tr></tfoot></table></div>`}

const _charts={};
function destroyChart(id){if(_charts[id]){try{_charts[id].destroy()}catch{}delete _charts[id]}}
function getChartData(){const opts=allMonthKeys();if(chartPeriod==='week'){const days=[],thu=[],chi=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}if(chartPeriod==='month'){const[y,m]=curMonth.split('-'),dIM=new Date(y,m,0).getDate(),days=[],thu=[],chi=[];for(let i=1;i<=dIM;i++){const iso=`${curMonth}-${String(i).padStart(2,'0')}`;days.push(String(i));thu.push(FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}const sortedOpts=[...opts].reverse();return{days:sortedOpts.map(k=>{const[y,mo]=k.split('-');return`T${parseInt(mo)}/${y.slice(2)}`}),thu:sortedOpts.map(k=>getRevenue(k)),chi:sortedOpts.map(k=>getCost(k))}}
function refreshCharts(){['pieChart','barChart','lineChart'].forEach(destroyChart);const thu=getRevenue(curMonth),impAmt=FIN.imports.reduce((s,x)=>s+x.totalAmt,0),cpAmt=FIN.costs.reduce((s,x)=>s+x.amount,0),hasData=thu>0||impAmt>0||cpAmt>0;document.getElementById('noChartData').style.display=hasData?'none':'block';document.getElementById('chartContent').style.display=hasData?'block':'none';if(!hasData)return;const pieEl=document.getElementById('pieChart');if(pieEl)_charts['pieChart']=new Chart(pieEl,{type:'doughnut',data:{labels:['Thu','Nháº­p hÃ ng','Chi phÃ­'],datasets:[{data:[thu,impAmt,cpAmt],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8},padding:4}}}}});const barData=[...new Set(FIN.imports.map(x=>x.name))].slice(0,5).map(n=>({n,v:FIN.imports.filter(x=>x.name===n).reduce((s,x)=>s+x.totalAmt,0)}));const barEl=document.getElementById('barChart');if(barEl)_charts['barChart']=new Chart(barEl,{type:'bar',data:{labels:barData.length?barData.map(x=>x.n):['ChÆ°a cÃ³'],datasets:[{data:barData.length?barData.map(x=>x.v):[0],backgroundColor:'rgba(27,107,58,.72)',borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3)+'K':v,font:{size:8}}},x:{grid:{display:false},ticks:{font:{size:7},maxRotation:0}}}}});const{days,thu:thuL,chi:chiL}=getChartData();const lineEl=document.getElementById('lineChart');if(lineEl)_charts['lineChart']=new Chart(lineEl,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thuL,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chiL,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K',font:{size:8}},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}})}
function refreshHomeChart(){destroyChart('homeLineChart');const days=[],thu=[],chi=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}const c=document.getElementById('homeLineChart');if(!c)return;_charts['homeLineChart']=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K',font:{size:8}},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}})}

async function writeClip(text,successMsg){try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(text);else{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px';document.body.appendChild(ta);ta.focus();ta.select();document.execCommand('copy');document.body.removeChild(ta)}if(successMsg)showToast(successMsg);return true}catch{if(successMsg)showToast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);return false}}
async function doCopy(boxId,btnId){const box=document.getElementById(boxId);if(!box)return;const text=box.textContent.trim();if(!text){showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return}const ok=await writeClip(text);if(ok){showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');const b=document.getElementById(btnId);if(b){const orig=b.innerHTML;b.innerHTML='âœ… ÄÃ£ sao chÃ©p!';b.classList.add('ok');b.disabled=true;setTimeout(()=>{b.innerHTML=orig;b.classList.remove('ok');b.disabled=false},2000)}}}

(function init(){
  const now=nowDatetimeLocal();
  ['sellDate','impDate','cpDate'].forEach(id=>setVal(id,now));
  buildMonthSelect();renderAll();renderHomeRecent();updateAIStatusBar();setTimeout(refreshHomeChart,100);
})();
</script>
</body>
</html>
