<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;background:#F7FBF8;color:#1A2E23;overflow:hidden}
:root{
  --g:#1B6B3A;--g2:#145230;--g3:#0D3A22;--g4:#E8F5E9;--g5:#C8E9D5;
  --r:#D94F3D;--rb:#FDF0EE;--a:#F5A623;
  --bd:#DDE8E2;--card:#fff;--muted:#5A7A66;--subtle:#8FA89A;
  --sh:0 2px 8px rgba(0,0,0,.09);
}
#app{display:flex;flex-direction:column;height:100dvh;max-width:100vw;overflow:hidden}
#hdr{background:linear-gradient(135deg,var(--g3),var(--g));color:#fff;padding:8px 14px 6px;text-align:center;flex-shrink:0}
#hdr h1{font-size:1.05rem;font-weight:900}
#hdr p{font-size:.6rem;opacity:.75;margin-top:1px}
.badge{background:var(--a);color:#1A2E23;font-size:.5rem;font-weight:900;padding:2px 5px;border-radius:20px;margin-left:4px}
#apiBar{flex-shrink:0;background:#FFFDE7;border-bottom:2px solid var(--a);padding:5px 10px;display:flex;gap:5px;align-items:center;flex-wrap:wrap}
#apiBar label{font-size:.68rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiIn{flex:1;min-width:80px;padding:4px 8px;border:2px solid var(--a);border-radius:8px;font-size:.78rem}
#apiSaveBtn{background:var(--a);color:#1A2E23;border:none;padding:4px 9px;border-radius:8px;font-weight:800;cursor:pointer;font-size:.72rem}
#apiSt{font-size:.65rem;color:#7A5200;flex-basis:100%;margin-top:-2px}
#monthBar{flex-shrink:0;background:var(--card);border-bottom:2px solid var(--bd);padding:5px 10px;display:flex;align-items:center;gap:7px;overflow:hidden}
#monthBar label{font-size:.68rem;font-weight:800;color:var(--muted);flex-shrink:0}
#monthSel{padding:4px 7px;border:2px solid var(--bd);border-radius:8px;font-size:.78rem;font-weight:700;color:var(--g);background:var(--g4);cursor:pointer;max-width:150px}
#monthBadge{font-size:.6rem;background:var(--g4);color:var(--g);padding:2px 8px;border-radius:20px;font-weight:800;border:1.5px solid var(--g5);margin-left:auto;white-space:nowrap;flex-shrink:0}
#main{flex:1;overflow:hidden;position:relative;min-height:0}
.pg{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.pg.on{display:block}
#pg-ai{display:none;position:absolute;inset:0;flex-direction:column;background:#0D1F16}
#pg-ai.on{display:flex}
.wrap{padding:10px;max-width:560px;margin:0 auto;padding-bottom:14px;overflow-x:hidden}
#nav{flex-shrink:0;display:flex;background:var(--card);border-top:2px solid var(--bd);box-shadow:0 -2px 12px rgba(0,0,0,.08)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:6px 2px;border-top:3px solid transparent;color:var(--muted);font-family:inherit;min-width:0;font-size:.45rem;font-weight:800}
.nb .ic{font-size:1.1rem;line-height:1}
.nb.on{color:var(--g);border-top-color:var(--g);background:var(--g4)}
.card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:10px;box-shadow:var(--sh);border:1px solid var(--bd);overflow:hidden}
.ctitle{font-size:.85rem;font-weight:800;color:var(--g2);margin-bottom:7px}
.csub{font-size:.67rem;color:var(--muted);margin-bottom:7px;line-height:1.5}
.strip3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.sc{background:var(--card);border-radius:10px;padding:8px 5px;text-align:center;border:1px solid var(--bd)}
.sc .sl{font-size:.56rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.sc .sv{font-size:.8rem;font-weight:900;word-break:break-all}
.sc.thu .sv{color:var(--g)}.sc.chi .sv{color:var(--r)}.sc.lai .sv{color:var(--g2)}
.todayCard{background:linear-gradient(135deg,var(--g3),var(--g));border-radius:14px;padding:10px 12px 8px;margin-bottom:8px;color:#fff}
.todayCard .tl{font-size:.58rem;opacity:.75;margin-bottom:5px}
.todayCard .strip3 .sc{background:rgba(255,255,255,.12);border:none}
.todayCard .strip3 .sc .sl{color:rgba(255,255,255,.7)}
.todayCard .strip3 .sc .sv{color:#fff}
.tabs{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.tab{padding:5px 11px;border:2px solid var(--bd);background:#fff;border-radius:30px;font-size:.69rem;font-weight:800;color:var(--muted);cursor:pointer;white-space:nowrap}
.tab.on{background:var(--g);color:#fff;border-color:var(--g)}
.field{margin-bottom:8px}
.field label{font-size:.66rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:8px 10px;border:2px solid var(--bd);border-radius:8px;font-size:.84rem;font-family:inherit;background:#fff;color:#1A2E23;transition:.15s}
.inp:focus{outline:none;border-color:var(--g);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.btn{width:100%;padding:10px;border:none;border-radius:12px;font-size:.83rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:7px;font-family:inherit;transition:.15s}
.btn-g{background:var(--g);color:#fff}.btn-g:hover{background:var(--g2)}
.btn-w{background:var(--g4);color:var(--g2);border:2px solid var(--g5)}.btn-w:hover{background:var(--g5)}
.btn-r{background:var(--rb);color:var(--r);border:2px solid #F5C6C0}
.btn-a{background:var(--a);color:#1A2E23}.btn-a:hover{background:#E09200}
.btn-sm{padding:5px 10px;font-size:.7rem;border-radius:8px;width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.4;cursor:not-allowed}
.uparea{border:3px dashed var(--bd);border-radius:12px;padding:14px 10px;text-align:center;cursor:pointer;background:var(--g4)}
.uparea:hover{border-color:var(--g);background:var(--g5)}
.uparea .ui{font-size:1.6rem;margin-bottom:3px}
.uparea strong{display:block;font-size:.78rem;color:var(--g2);margin-bottom:2px}
.uparea small{color:var(--subtle);font-size:.64rem}
.imgbox{position:relative;margin-bottom:8px;display:none}
.imgbox img{width:100%;max-height:150px;object-fit:cover;border-radius:8px;border:2px solid var(--g5);display:block}
.imgchg{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:20px;padding:3px 8px;font-size:.63rem;font-weight:800;cursor:pointer}
.sugwrap{position:relative}
.sugdrop{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--g5);border-top:none;border-radius:0 0 8px 8px;z-index:600;max-height:180px;overflow-y:auto;display:none;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.sugdrop.on{display:block}
.sugopt{padding:8px 11px;cursor:pointer;font-size:.82rem;border-bottom:1px solid var(--bd)}
.sugopt:last-child{border-bottom:none}.sugopt:hover{background:var(--g4);color:var(--g)}
.sugopt .sm{font-size:.62rem;color:var(--muted);margin-top:1px}
.suggrp{padding:4px 11px 2px;font-size:.58rem;font-weight:900;color:var(--g);background:var(--g4);text-transform:uppercase;letter-spacing:.5px}
.tblwrap{overflow-x:auto;overflow-y:auto;border-radius:8px;border:1px solid var(--bd);max-height:280px}
table{width:100%;border-collapse:collapse;font-size:.75rem;min-width:300px}
thead tr{background:var(--g)}
th{padding:6px 7px;text-align:left;color:#fff;font-size:.64rem;font-weight:800;white-space:nowrap}
td{padding:6px 7px;border-bottom:1px solid var(--bd);vertical-align:middle;max-width:130px;word-break:break-word}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--g4)}
.tv{color:var(--g);font-weight:800;white-space:nowrap}
.rv{color:var(--r);font-weight:800;white-space:nowrap}
.delbtn{background:none;border:none;cursor:pointer;font-size:.8rem;padding:2px 3px;border-radius:5px;color:var(--subtle)}
.delbtn:hover{background:var(--rb);color:var(--r)}
.tag{display:inline-block;padding:2px 6px;border-radius:6px;font-size:.61rem;font-weight:800;white-space:nowrap}
.t-sell{background:#D4EDDA;color:var(--g2)}.t-cook{background:#E0E7FF;color:#3730A3}
.t-imp{background:#D1ECF1;color:#0C5460}.t-mat{background:#FFF3CD;color:#856404}
.t-op{background:#F3E8FF;color:#7C3AED}.t-adj{background:#FCE4EC;color:#880E4F}
.ptabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
.ptab{padding:4px 10px;border:2px solid var(--bd);background:#fff;border-radius:20px;font-size:.67rem;font-weight:800;color:var(--muted);cursor:pointer}
.ptab.on{background:var(--g);color:#fff;border-color:var(--g)}
.bulkbar{display:flex;align-items:center;gap:6px;margin-bottom:7px;flex-wrap:wrap}
.bulkbar input{width:13px;height:13px;accent-color:var(--g);cursor:pointer}
.bulkbar label{font-size:.71rem;font-weight:800;color:var(--muted);cursor:pointer}
.cbcell input{width:13px;height:13px;accent-color:var(--g);cursor:pointer}
.infobox{background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:7px 10px;font-size:.75rem;color:var(--g2);margin-bottom:8px;display:none;word-break:break-word}
.totalbox{background:#E8F5E9;border:1.5px solid var(--g5);border-radius:8px;padding:6px 10px;font-size:.77rem;color:var(--g2);font-weight:800;margin-bottom:8px;display:none}
.notice{background:#E8F5E9;border:1.5px solid var(--g5);border-radius:8px;padding:7px 10px;font-size:.72rem;color:var(--g2);margin-top:5px;display:none}
.notice.on{display:block}
.warnbox{background:#FFF8E1;border:1.5px solid var(--a);border-radius:8px;padding:7px 10px;font-size:.72rem;color:#7A5200;margin-bottom:8px}
.prevwrap{display:none;margin-top:8px}.prevwrap.on{display:block}
.prevtitle{font-size:.73rem;font-weight:800;color:var(--g2);margin-bottom:5px}
.previtem{display:flex;align-items:center;gap:6px;padding:7px 9px;background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;margin-bottom:5px}
.previtem.rm{opacity:.35;background:#fff;border-style:dashed}
.pidx{font-size:.63rem;font-weight:900;color:var(--muted);min-width:16px;flex-shrink:0}
.pname{flex:1;font-size:.79rem;font-weight:800;color:var(--g2);word-break:break-word;min-width:0}
.pmeta{font-size:.67rem;color:var(--muted);white-space:nowrap;flex-shrink:0}
.pdel{background:none;border:none;cursor:pointer;font-size:.9rem;padding:2px 4px;border-radius:5px;flex-shrink:0}
.prevfoot{display:flex;justify-content:space-between;font-size:.71rem;font-weight:800;color:var(--g2);padding:5px 2px}
.loader{display:none;text-align:center;padding:12px}.loader.on{display:block}
.spin{width:26px;height:26px;border:4px solid var(--g5);border-top:4px solid var(--g);border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 5px}
@keyframes sp{to{transform:rotate(360deg)}}
.loader p{color:var(--g);font-weight:700;font-size:.74rem}
.resbox{background:var(--g4);border:2px solid var(--g5);border-radius:8px;padding:10px;margin-top:7px;white-space:pre-wrap;font-size:.77rem;line-height:1.7;max-height:220px;overflow-y:auto;display:none;word-break:break-word}
.resbox.on{display:block}
.copybtn{display:none;align-items:center;gap:5px;background:var(--g4);color:var(--g2);border:2px solid var(--g5);padding:6px 11px;border-radius:8px;font-size:.72rem;font-weight:800;cursor:pointer;margin-top:5px;transition:.15s;font-family:inherit}
.copybtn:hover{background:var(--g);color:#fff}.copybtn.on{display:inline-flex}
.invcard{border-radius:8px;padding:9px 11px;margin-bottom:5px;display:flex;align-items:flex-start;gap:8px;border:2px solid}
.ic-out{background:var(--rb);border-color:var(--r)}
.ic-low{background:#FFF8E1;border-color:var(--a)}
.ic-ok{background:var(--g4);border-color:var(--g5)}
.ic-slow{background:#EEF2FF;border-color:#7C83FD}
.invbody{flex:1;min-width:0}
.invname{font-size:.83rem;font-weight:800;word-break:break-word}
.invmeta{font-size:.65rem;color:var(--muted);margin-top:2px;line-height:1.4}
.invqty{font-size:.76rem;font-weight:900;white-space:nowrap;padding:3px 8px;border-radius:20px;flex-shrink:0;align-self:center}
.q-out{background:var(--rb);color:var(--r)}.q-low{background:#FFF3CD;color:#7A5200}.q-ok{background:var(--g4);color:var(--g)}
.invsec{margin-bottom:10px}
.invstitle{font-size:.74rem;font-weight:900;color:var(--g2);margin-bottom:5px}
.invnotice{background:var(--a);color:#1A2E23;border-radius:8px;padding:7px 11px;font-size:.71rem;font-weight:800;margin-bottom:8px}
.adjwarn{background:#FFF8E1;border:1.5px solid var(--a);border-radius:8px;padding:7px 10px;font-size:.72rem;color:#7A5200;margin-bottom:10px}
.chcard{background:var(--card);border-radius:10px;padding:9px;border:1px solid var(--bd)}
.chcard h3{font-size:.69rem;font-weight:800;color:var(--g2);margin-bottom:5px;text-align:center}
.ch2g{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.chh{position:relative;height:130px}.chfull{position:relative;height:150px}
.taxbox{border-radius:12px;padding:12px;margin-bottom:10px;border:3px solid}
.tx-safe{background:#E8F5E9;border-color:#4CAF50}
.tx-warn{background:#FFF8E1;border-color:var(--a)}
.tx-dng{background:var(--rb);border-color:var(--r)}
.txicon{font-size:1.5rem;text-align:center;display:block;margin-bottom:4px}
.txmsg{font-size:.95rem;font-weight:800;text-align:center;margin-bottom:5px;line-height:1.4}
.tx-safe .txmsg{color:#2E7D32}.tx-warn .txmsg{color:#7A5200}.tx-dng .txmsg{color:var(--r)}
.txdet{font-size:.76rem;color:var(--muted);line-height:1.7;background:rgba(255,255,255,.6);border-radius:8px;padding:7px 9px;margin-top:4px}
.txdet strong{color:#1A2E23}
.progwrap{background:var(--bd);border-radius:20px;overflow:hidden;height:18px;margin:8px 0}
.progbar{height:100%;border-radius:20px;transition:width .5s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.63rem;font-weight:900;color:#fff}
.pb-safe{background:linear-gradient(90deg,var(--g),#27AE60)}.pb-warn{background:linear-gradient(90deg,var(--a),#E67E00)}.pb-dng{background:linear-gradient(90deg,var(--r),#B71C1C)}
.filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
.filters input,.filters select{padding:5px 8px;border:2px solid var(--bd);border-radius:8px;font-size:.74rem;background:#fff;font-family:inherit;min-width:0}
.filters input{flex:1;min-width:70px}
.filters input:focus,.filters select:focus{outline:none;border-color:var(--g)}
.cmpbox{background:var(--g4);border:2px solid var(--g5);border-radius:12px;padding:11px;margin-bottom:10px;display:none}
.cmpbox.on{display:block}
.cmpgrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.cmpi{text-align:center;background:#fff;border-radius:8px;padding:7px 4px;border:1px solid var(--bd)}
.cmpl{font-size:.56rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmpc{font-size:.76rem;font-weight:900;color:var(--g2)}.cmpp{font-size:.63rem;color:var(--muted);margin-top:2px}
.cmpd{font-size:.63rem;font-weight:800;margin-top:2px}
.dup{color:var(--g)}.ddn{color:var(--r)}
/* AI chat */
.aitop{flex-shrink:0;background:#111F17;border-bottom:1px solid #1E3829;padding:8px 14px;display:flex;align-items:center;gap:8px}
.aiav{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--g),#27AE60);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.aitxt{flex:1;min-width:0;font-size:.71rem;color:#8FB89A;line-height:1.4}
.aitxt strong{color:#A8E6C1;font-size:.73rem}
.aidot{width:8px;height:8px;border-radius:50%;background:#27AE60;box-shadow:0 0 6px #27AE60;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.hodmenh{font-size:.52rem;color:#FFD54F;background:rgba(255,213,79,.15);border:1px solid rgba(255,213,79,.3);border-radius:10px;padding:2px 5px;white-space:nowrap}
.msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
.msg{max-width:88%;padding:9px 13px;border-radius:18px;font-size:.81rem;line-height:1.6;word-break:break-word;animation:fu .25s ease}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:#162A1F;border:1px solid #1E3829;color:#D4EDD9;align-self:flex-start;border-bottom-left-radius:4px}
.msg.usr{background:linear-gradient(135deg,var(--g),#218C4A);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{align-self:flex-start;display:none}.typing.on{display:flex}
.dots{display:flex;gap:4px;padding:9px 14px;background:#162A1F;border:1px solid #1E3829;border-radius:18px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:#6ABF8A;animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.cpill{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.cpill button{padding:6px 14px;border-radius:20px;font-size:.74rem;font-weight:800;cursor:pointer;border:1.5px solid;font-family:inherit}
.py{background:var(--g);color:#fff;border-color:var(--g)}.pn{background:transparent;color:#E87A6A;border-color:#E87A6A}
.aicopy{padding:4px 10px;border-radius:16px;font-size:.68rem;font-weight:800;cursor:pointer;border:1.5px solid rgba(168,230,193,.3);background:rgba(168,230,193,.1);color:#A8E6C1;font-family:inherit;margin-top:5px}
.aicopy:hover{background:rgba(168,230,193,.2)}
.chips{flex-shrink:0;padding:5px 12px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;border-top:1px solid #1E3829;background:#111F17}
.chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:5px 11px;background:#162A1F;border:1px solid #1E3829;border-radius:20px;color:#8FB89A;font-size:.69rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:inherit}
.chip:hover{background:var(--g2);color:#fff}
.chatfoot{flex-shrink:0;padding:8px 10px 10px;background:#111F17;border-top:1px solid #1E3829;display:flex;gap:8px;align-items:flex-end}
.chatinp{flex:1;min-height:40px;max-height:100px;padding:9px 14px;background:#1A2E23;border:1.5px solid #1E3829;border-radius:22px;color:#E0F0E6;font-size:.84rem;font-family:inherit;resize:none;line-height:1.45;overflow-y:auto;outline:none}
.chatinp::placeholder{color:#3A5A48}.chatinp:focus{border-color:var(--g)}
.sndbtn{flex-shrink:0;width:40px;height:40px;background:linear-gradient(135deg,var(--g),#218C4A);border:none;border-radius:50%;color:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:flex-end;justify-content:center}
.ov.on{display:flex}
.modal{background:#fff;border-radius:20px 20px 0 0;padding:15px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
.modal h3{font-size:.88rem;font-weight:800;color:var(--g2);margin-bottom:8px}
.mbtns{display:flex;gap:7px;margin-top:10px}
.mbtns button{flex:1;padding:9px;border-radius:8px;font-weight:800;font-size:.79rem;cursor:pointer;border:none;font-family:inherit}
.mbtnc{background:#F5F5F5;color:var(--muted);border:2px solid var(--bd)!important}
.mbtnok{background:var(--r);color:#fff}
.mbtna{background:var(--a);color:#1A2E23}
#toast{position:fixed;bottom:66px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--g2);color:#fff;padding:9px 18px;border-radius:30px;font-size:.82rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1),opacity .28s;pointer-events:none;white-space:nowrap;opacity:0;max-width:90vw;text-align:center}
#toast.on{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--r)}#toast.ok{background:#27AE60}
.empty{text-align:center;color:var(--muted);padding:18px 10px;font-size:.77rem}
.empty .ei{font-size:1.6rem;margin-bottom:4px}
.cookitem{background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:7px}
.cookbody{flex:1;min-width:0}
.cookname{font-size:.81rem;font-weight:800;color:var(--g2)}
.cookmeta{font-size:.66rem;color:var(--muted);margin-top:1px}
.cookprice{font-size:.83rem;font-weight:900;color:var(--g);white-space:nowrap}
.cookdel{background:none;border:none;cursor:pointer;font-size:.8rem;color:var(--subtle);padding:2px 3px;border-radius:5px}
.cookdel:hover{background:var(--rb);color:var(--r)}
.convbox{background:#EEF2FF;border:2px solid #7C83FD;border-radius:8px;padding:9px 11px;margin-top:7px;font-size:.75rem;line-height:1.6;display:none}
.convbox.on{display:block}
.hrow{cursor:pointer}.hrow:hover td{background:var(--g5)!important}
.jbadge{display:inline-block;background:var(--g4);color:var(--g);border:1px solid var(--g5);border-radius:5px;font-size:.57rem;padding:1px 4px;font-weight:800}
@media(max-width:370px){.g2,.g3{grid-template-columns:1fr}.ch2g{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app">
<div id="hdr">
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Quáº£n lÃ½ kinh doanh thÃ´ng minh Â· Táº¡p hÃ³a / QuÃ¡n Äƒn</p>
</div>
<div id="apiBar">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiIn" placeholder="DÃ¡n Gemini API Key...">
  <button id="apiSaveBtn" onclick="saveKey()">âœ… LÆ°u</button>
  <span id="apiSt"></span>
</div>
<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSel" onchange="switchMonth(this.value)"></select>
  <span id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>
<div id="main">

<!-- HOME -->
<div id="pg-home" class="pg on">
<div class="wrap">
  <div class="todayCard">
    <div class="tl" id="todayLabel">ğŸ“… HÃ´m nay</div>
    <div class="strip3">
      <div class="sc"><div class="sl">ğŸ“ˆ Thu hÃ´m nay</div><div class="sv" id="h-tthu">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ“‰ Chi hÃ´m nay</div><div class="sv" id="h-tchi">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ’¼ LÃ£i hÃ´m nay</div><div class="sv" id="h-tlai">0Ä‘</div></div>
    </div>
  </div>
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ ThÃ¡ng thu</div><div class="sv" id="h-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ ThÃ¡ng chi</div><div class="sv" id="h-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sv" id="h-lai">0Ä‘</div><div class="sl">ğŸ’¼ ThÃ¡ng lÃ£i</div></div>
  </div>
  <div class="card">
    <div class="ctitle">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y gáº§n nháº¥t</div>
    <div class="chfull"><canvas id="homeChart"></canvas></div>
  </div>
  <div class="card"><div class="ctitle">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div><div id="homeRecent"></div></div>
</div>
</div>

<!-- MONEY -->
<div id="pg-money" class="pg">
<div class="wrap">
  <div class="todayCard">
    <div class="tl">ğŸ“… HÃ´m nay</div>
    <div class="strip3">
      <div class="sc"><div class="sl">ğŸ“ˆ Thu</div><div class="sv" id="m-tthu">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ“‰ Chi</div><div class="sv" id="m-tchi">0Ä‘</div></div>
      <div class="sc"><div class="sl">ğŸ’¼ LÃ£i</div><div class="sv" id="m-tlai">0Ä‘</div></div>
    </div>
  </div>
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ ThÃ¡ng thu</div><div class="sv" id="m-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ ThÃ¡ng chi</div><div class="sv" id="m-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sl">ğŸ’¼ LÃ£i/Lá»—</div><div class="sv" id="m-lai">0Ä‘</div></div>
  </div>
  <div class="tabs">
    <button class="tab on" onclick="msub('ban',this)">ğŸ’° BÃ¡n hÃ ng</button>
    <button class="tab" onclick="msub('nhap',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="tab" onclick="msub('chiphi',this)">âš¡ Chi phÃ­</button>
    <button class="tab" onclick="msub('kho',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="tab" onclick="msub('chebien',this)">ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n</button>
  </div>

  <!-- BAN -->
  <div id="ms-ban">
    <div class="card">
      <div class="ctitle">ğŸ“· QuÃ©t bill thanh toÃ¡n</div>
      <div class="uparea" onclick="document.getElementById('billFile').click()">
        <div class="ui">ğŸ§¾</div><strong>Chá»¥p bill Ä‘Ã£ thanh toÃ¡n</strong><small>AI Ä‘á»c & tÃ¡ch tá»«ng mÃ³n</small>
      </div>
      <input type="file" id="billFile" accept="image/*" style="display:none" onchange="onBillFile(event)">
      <div class="imgbox" id="billImgBox"><img id="billImg"><button class="imgchg" onclick="resetBill()">âœï¸ Äá»•i</button></div>
      <button class="btn btn-g" id="billScanBtn" onclick="scanBill()" disabled style="margin-top:7px">ğŸ¤– AI Ä‘á»c bill</button>
      <div class="loader" id="billLoader"><div class="spin"></div><p>AI Ä‘ang tÃ¡ch tá»«ng mÃ³n...</p></div>
      <div class="notice" id="billNotice">âœ… Kiá»ƒm tra danh sÃ¡ch rá»“i báº¥m "XÃ¡c nháº­n lÆ°u"</div>
      <div class="prevwrap" id="billPrev">
        <div class="prevtitle">ğŸ‘ï¸ Xem trÆ°á»›c â€” nháº¥n ğŸ—‘ï¸ Ä‘á»ƒ bá» mÃ³n</div>
        <div id="billPrevList"></div>
        <div class="prevfoot"><span id="billPrevCount"></span><span id="billPrevTotal"></span></div>
        <button class="btn btn-g" style="margin-top:8px" onclick="confirmBill()">âœ… XÃ¡c nháº­n lÆ°u táº¥t cáº£</button>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">âœï¸ Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="field"><label>ğŸ›’ Chá»n sáº£n pháº©m</label>
        <div class="sugwrap">
          <input class="inp" id="sName" placeholder="GÃµ tÃªn sáº£n pháº©m..." autocomplete="off"
            oninput="onSellSug(this.value)" onfocus="onSellSug(this.value)" onblur="setTimeout(closeSellSug,220)">
          <div class="sugdrop" id="sDrop"></div>
        </div>
      </div>
      <div class="infobox" id="sInfo"></div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" id="sDesc" placeholder="Ghi chÃº thÃªm..."></div>
      <div class="g2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" id="sQty" placeholder="0" oninput="handleM(this);calcTotal()" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ’µ ÄÆ¡n giÃ¡</label><input class="inp" id="sPrice" placeholder="0Ä‘" oninput="handleM(this);calcTotal()" onkeydown="noKey(event)"></div>
      </div>
      <div class="totalbox" id="sTotal"></div>
      <div class="field"><label>ğŸ“… NgÃ y bÃ¡n</label><input class="inp" type="datetime-local" id="sDate"></div>
      <button class="btn btn-g" onclick="addSale()">âœ… XÃ¡c nháº­n bÃ¡n</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n</div>
      <div class="ptabs">
        <button class="ptab on" onclick="setPer('ban','all',this)">Táº¥t cáº£</button>
        <button class="ptab" onclick="setPer('ban','today',this)">HÃ´m nay</button>
        <button class="ptab" onclick="setPer('ban','week',this)">7 ngÃ y</button>
        <button class="ptab" onclick="setPer('ban','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulkbar">
        <input type="checkbox" id="banAll" onchange="selAll('ban',this.checked)">
        <label for="banAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-r btn-sm" id="banBulk" onclick="bulkDel('ban')" style="display:none">ğŸ—‘ï¸ XoÃ¡ chá»n</button>
        <button class="btn btn-r btn-sm" style="margin-left:auto" onclick="cfmDelAll('ban')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="banTable"></div>
    </div>
  </div>

  <!-- NHAP -->
  <div id="ms-nhap" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="uparea" onclick="document.getElementById('invFile').click()">
        <div class="ui">ğŸ§¾</div><strong>Chá»¥p hÃ³a Ä‘Æ¡n nhÃ  cung cáº¥p</strong><small>AI trÃ­ch xuáº¥t danh sÃ¡ch hÃ ng</small>
      </div>
      <input type="file" id="invFile" accept="image/*" style="display:none" onchange="onInvFile(event)">
      <div class="imgbox" id="invImgBox"><img id="invImg"><button class="imgchg" onclick="resetInv()">âœï¸ Äá»•i</button></div>
      <button class="btn btn-g" id="invScanBtn" onclick="scanInv()" disabled style="margin-top:7px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="invLoader"><div class="spin"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="prevwrap" id="invPrev">
        <div class="prevtitle">ğŸ‘ï¸ Danh sÃ¡ch trÃ­ch xuáº¥t â€” nháº¥n ğŸ—‘ï¸ Ä‘á»ƒ bá»</div>
        <div id="invPrevList"></div>
        <div class="prevfoot"><span id="invPrevCount"></span><span id="invPrevTotal"></span></div>
        <div style="display:flex;gap:6px;margin-top:7px;flex-wrap:wrap">
          <button class="btn btn-w btn-sm" onclick="copyInvCSV()">ğŸ“¥ Xuáº¥t CSV</button>
          <button class="btn btn-g btn-sm" onclick="fillFromInv()">âš¡ Äiá»n form</button>
        </div>
      </div>
      <div class="notice" id="invNotice">âœ… ÄÃ£ Ä‘iá»n form â€” kiá»ƒm tra rá»“i báº¥m "Nháº­p hÃ ng"</div>
    </div>
    <div class="card">
      <div class="ctitle">âœï¸ Nháº­p hÃ ng vÃ o kho</div>
      <div class="g2">
        <div class="field"><label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sugwrap">
            <input class="inp" id="iName" placeholder="VD: MÃ¬ tÃ´m" autocomplete="off"
              oninput="onImpSug(this.value)" onfocus="onImpSug(this.value)" onblur="setTimeout(closeImpSug,220)">
            <div class="sugdrop" id="iDrop"></div>
          </div>
        </div>
        <div class="field"><label>ğŸ“‚ Loáº¡i</label>
          <select class="inp" id="iType" onchange="togImpMode()">
            <option value="hangban">ğŸ›’ HÃ ng bÃ¡n láº¡i (vÃ o kho)</option>
            <option value="nguyenlieu">ğŸ§‚ NguyÃªn liá»‡u (khÃ´ng vÃ o kho)</option>
          </select>
        </div>
      </div>
      <div id="iConvWrap">
        <div class="g3">
          <div class="field"><label>ğŸ“¦ ÄV nháº­p</label><input class="inp" id="iUIn" placeholder="thÃ¹ng, kg..."></div>
          <div class="field"><label>ğŸ·ï¸ ÄV bÃ¡n</label><input class="inp" id="iUOut" placeholder="gÃ³i, chai..."></div>
          <div class="field"><label>ğŸ”¢ Há»‡ sá»‘</label><input class="inp" id="iFac" placeholder="1" oninput="handleM(this);showConv()" onkeydown="noKey(event)"></div>
        </div>
        <div class="convbox" id="convPreview"></div>
      </div>
      <div class="g2">
        <div class="field"><label>ğŸ“¥ Sá»‘ lÆ°á»£ng nháº­p</label><input class="inp" id="iQty" placeholder="0" oninput="handleM(this);showConv()" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ’° Tá»•ng tiá»n lÃ´</label><input class="inp" id="iAmt" placeholder="0Ä‘" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="datetime-local" id="iDate"></div>
      <button class="btn btn-g" onclick="addImport()">â• Nháº­p hÃ ng</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ nháº­p</div>
      <div class="ptabs">
        <button class="ptab on" onclick="setPer('nhap','all',this)">Táº¥t cáº£</button>
        <button class="ptab" onclick="setPer('nhap','today',this)">HÃ´m nay</button>
        <button class="ptab" onclick="setPer('nhap','week',this)">7 ngÃ y</button>
        <button class="ptab" onclick="setPer('nhap','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulkbar">
        <input type="checkbox" id="nhapAll" onchange="selAll('nhap',this.checked)">
        <label for="nhapAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-r btn-sm" id="nhapBulk" onclick="bulkDel('nhap')" style="display:none">ğŸ—‘ï¸ XoÃ¡ chá»n</button>
        <button class="btn btn-r btn-sm" style="margin-left:auto" onclick="cfmDelAll('nhap')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="nhapTable"></div>
    </div>
  </div>

  <!-- CHIPHI -->
  <div id="ms-chiphi" style="display:none">
    <div class="card">
      <div class="ctitle">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="field"><label>ğŸ“‚ Loáº¡i</label>
        <select class="inp" id="cpType">
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" id="cpDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng 6"></div>
      <div class="g2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" id="cpAmt" placeholder="0Ä‘" oninput="handleM(this)" onkeydown="noKey(event)"></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="cpDate"></div>
      </div>
      <button class="btn btn-g" onclick="addCost()">â• ThÃªm chi phÃ­</button>
    </div>
    <div class="card"><div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ chi phÃ­</div><div id="cpTable"></div></div>
  </div>

  <!-- KHO -->
  <div id="ms-kho" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ—„ï¸ Tá»“n kho thÃ´ng minh</div>
      <div class="filters">
        <input type="text" id="invSearch" placeholder="ğŸ” TÃ¬m sáº£n pháº©m..." oninput="renderInv()">
        <select id="invStatus" onchange="renderInv()">
          <option value="">Táº¥t cáº£</option>
          <option value="out">ğŸ”´ Háº¿t hÃ ng</option>
          <option value="low">ğŸŸ¡ Sáº¯p háº¿t</option>
          <option value="ok">ğŸŸ¢ Äá»§ hÃ ng</option>
        </select>
      </div>
      <div id="invView"></div>
      <div style="display:flex;gap:7px;margin-top:8px">
        <button class="btn btn-a" style="flex:1;margin:0" onclick="openAdj()">âš™ï¸ Äiá»u chá»‰nh / Hao há»¥t</button>
        <button class="btn btn-w" style="flex:1;margin:0" onclick="askAIInv()">ğŸ¤– Há»i AI</button>
      </div>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“‹ Lá»‹ch sá»­ Ä‘iá»u chá»‰nh kho</div>
      <div class="csub">âš ï¸ KhÃ´ng táº¡o khoáº£n chi â€” chá»‰ trá»« tá»“n kho</div>
      <div id="adjHist"></div>
    </div>
  </div>

  <!-- CHEBIEN -->
  <div id="ms-chebien" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ‘¨â€ğŸ³ Sáº£n pháº©m cháº¿ biáº¿n</div>
      <div class="csub">Phá»Ÿ, cÆ¡m, nÆ°á»›c Ã©p... â€” chá»‰ ghi doanh thu, khÃ´ng trá»« kho</div>
      <div class="g2">
        <div class="field"><label>ğŸ“ TÃªn sáº£n pháº©m</label><input class="inp" id="cbName" placeholder="VD: Phá»Ÿ bÃ²"></div>
        <div class="field"><label>ğŸ’µ GiÃ¡ bÃ¡n</label><input class="inp" id="cbPrice" placeholder="0Ä‘ (tuá»³ chá»n)" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      </div>
      <button class="btn btn-g" onclick="addCook()">â• ThÃªm</button>
    </div>
    <div class="card"><div class="ctitle">ğŸ“‹ Danh sÃ¡ch</div><div id="cookList"></div></div>
  </div>
</div>
</div>

<!-- PROMO -->
<div id="pg-promo" class="pg">
<div class="wrap">
  <div class="card warnbox">ğŸ“£ áº¢nh & ná»™i dung á»Ÿ Ä‘Ã¢y chá»‰ dÃ¹ng cho marketing, khÃ´ng táº¡o giao dá»‹ch kho.</div>
  <div class="tabs">
    <button class="tab on" onclick="psub('fb',this)">ğŸ“£ Facebook</button>
    <button class="tab" onclick="psub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="ps-fb">
    <div class="card">
      <div class="ctitle">ğŸ“£ Viáº¿t bÃ i Facebook</div>
      <div class="uparea" onclick="document.getElementById('fbFile').click()">
        <div class="ui">ğŸ–¼ï¸</div><strong>Chá»n áº£nh sáº£n pháº©m</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i</small>
      </div>
      <input type="file" id="fbFile" accept="image/*" style="display:none" onchange="onFbFile(event)">
      <div class="imgbox" id="fbImgBox"><img id="fbImg"><button class="imgchg" onclick="resetFb()">âœï¸ Äá»•i</button></div>
    </div>
    <button class="btn btn-g" id="fbBtn" onclick="genFb()" disabled>ğŸ¤– AI viáº¿t bÃ i</button>
    <div class="card" id="fbCard" style="display:none">
      <div class="ctitle">âœï¸ BÃ i Ä‘Äƒng</div>
      <div class="loader" id="fbLoader"><div class="spin"></div><p>AI Ä‘ang viáº¿t...</p></div>
      <div class="resbox" id="fbRes"></div>
      <button class="copybtn" id="fbCopy" onclick="doCopy('fbRes','fbCopy')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
  <div id="ps-tt" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" id="ttProd" placeholder="VD: Háº¡t bÃ­ rang muá»‘i"></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-g" onclick="genTT()">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n</button>
    <div class="card" id="ttCard" style="display:none">
      <div class="ctitle">ğŸï¸ HÆ°á»›ng dáº«n quay</div>
      <div class="loader" id="ttLoader"><div class="spin"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="resbox" id="ttRes"></div>
      <button class="copybtn" id="ttCopy" onclick="doCopy('ttRes','ttCopy')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- REPORTS -->
<div id="pg-reports" class="pg">
<div class="wrap">
  <div class="tabs">
    <button class="tab on" onclick="rsub('chart',this)">ğŸ“Š Biá»ƒu Ä‘á»“</button>
    <button class="tab" onclick="rsub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="tab" onclick="rsub('tax',this)">ğŸ§¾ Thuáº¿</button>
  </div>
  <div id="rs-chart">
    <div class="ptabs">
      <button class="ptab on" onclick="setChPer('week',this)">7 ngÃ y</button>
      <button class="ptab" onclick="setChPer('month',this)">ThÃ¡ng</button>
      <button class="ptab" onclick="setChPer('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ“Š BÃ¡o cÃ¡o</div>
      <div id="chartEmpty" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="ch2g">
          <div class="chcard"><h3>ğŸ¥§ Thu / Chi</h3><div class="chh"><canvas id="pieC"></canvas></div></div>
          <div class="chcard"><h3>ğŸ“¦ Top nháº­p</h3><div class="chh"><canvas id="barC"></canvas></div></div>
        </div>
        <div class="chcard"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="chfull"><canvas id="lineC"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-w" onclick="doCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rs-compare" style="display:none">
    <div class="card">
      <div class="ctitle">ğŸ“ˆ So sÃ¡nh thÃ¡ng</div>
      <div class="g2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-g" onclick="doCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="cmpbox" id="cmpBox"></div>
    </div>
    <div class="card"><div class="ctitle">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£</div><div id="allTime"></div><button class="btn btn-w" style="margin-top:7px" onclick="buildAllTime()">ğŸ”„ Cáº­p nháº­t</button></div>
  </div>
  <div id="rs-tax" style="display:none">
    <div class="card"><div class="ctitle">ğŸ“Š Thanh tiáº¿n trÃ¬nh doanh thu nÄƒm</div><div id="taxProg"></div></div>
    <div id="taxBox"></div>
    <div class="card csub" style="font-size:.71rem;line-height:1.7">
      <strong>ğŸ“Œ Luáº­t thuáº¿ 2026:</strong><br>
      â€¢ DT â‰¤ 500 triá»‡u/nÄƒm â†’ Miá»…n thuáº¿ TNCN & GTGT<br>
      â€¢ DT &gt; 500tr â†’ GTGT 1% (bÃ¡n láº») / 3% (Äƒn uá»‘ng) + TNCN = (DT-500tr)Ã—0.5%<br>
      â€¢ Khai thuáº¿: <a href="https://canhan.gdt.gov.vn" target="_blank" style="color:var(--g)">canhan.gdt.gov.vn</a>
    </div>
    <button class="btn btn-w" onclick="doTax()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
</div>
</div>

<!-- AI -->
<div id="pg-ai" class="pg">
  <div class="aitop">
    <div class="aiav">ğŸ¤–</div>
    <div class="aitxt"><strong>Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</strong><br><span id="aiSt">Äang táº£i...</span></div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0">
      <div style="display:flex;align-items:center;gap:4px"><div class="aidot"></div><span style="font-size:.57rem;color:#6ABF8A">Sáºµn sÃ ng</span></div>
      <span class="hodmenh">ğŸ›¡ï¸ Há»™ má»‡nh ON</span>
    </div>
  </div>
  <div class="msgs" id="msgs">
    <div class="msg bot">ğŸ‘‹ ChÃ o! MÃ¬nh lÃ  trá»£ lÃ½ <strong>Há»™ Má»‡nh</strong> cá»§a bÃ /cÃ´/chÃº ğŸ’š<br>â€¢ Ghi <strong>bÃ¡n / nháº­p</strong> hÃ ng ngay<br>â€¢ Tra <strong>tá»“n kho</strong> vÃ  sá»‘ liá»‡u<br>â€¢ TÆ° váº¥n <strong>thuáº¿ 2026</strong> chuáº©n xÃ¡c<br>â€¢ HÆ°á»›ng dáº«n <strong>ná»™p thuáº¿ Ä‘iá»‡n tá»­</strong> tá»«ng bÆ°á»›c</div>
    <div class="typing" id="typing"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  </div>
  <div class="chips">
    <button class="chip" onclick="useChip(this)">ğŸ“¦ Kho cÃ²n gÃ¬?</button>
    <button class="chip" onclick="useChip(this)">ğŸ’° ThÃ¡ng nÃ y lÃ£i bao nhiÃªu?</button>
    <button class="chip" onclick="useChip(this)">ğŸ›’ BÃ¡n 5 gÃ³i mÃ¬ 15k</button>
    <button class="chip" onclick="useChip(this)">ğŸ“¥ Nháº­p 2 thÃ¹ng bia 300k</button>
    <button class="chip" onclick="useChip(this)">âš ï¸ HÃ ng sáº¯p háº¿t?</button>
    <button class="chip" onclick="useChip(this)">ğŸ§¾ TÃ´i cÃ³ pháº£i ná»™p thuáº¿ khÃ´ng?</button>
    <button class="chip" onclick="useChip(this)">ğŸ“‹ HÆ°á»›ng dáº«n ná»™p thuáº¿</button>
  </div>
  <div class="chatfoot">
    <textarea class="chatinp" id="chatInp" placeholder="Nháº¯n: BÃ¡n 5 gÃ³i mÃ¬... hoáº·c há»i vá» thuáº¿..." rows="1"
      oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
    <button class="sndbtn" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- HISTORY -->
<div id="pg-history" class="pg">
<div class="wrap">
  <div class="strip3">
    <div class="sc thu"><div class="sl">ğŸ“ˆ Tá»•ng thu</div><div class="sv" id="hall-thu">0Ä‘</div></div>
    <div class="sc chi"><div class="sl">ğŸ“‰ Tá»•ng chi</div><div class="sv" id="hall-chi">0Ä‘</div></div>
    <div class="sc lai"><div class="sl">ğŸ’¼ LÃ£i/Lá»—</div><div class="sv" id="hall-lai">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="ctitle">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­</div>
    <div class="filters">
      <input type="text" id="hSearch" placeholder="ğŸ” TÃ¬m tÃªn..." oninput="renderHist()">
      <input type="date" id="hFrom" onchange="renderHist()">
      <input type="date" id="hTo" onchange="renderHist()">
    </div>
    <div class="filters">
      <select id="hType" onchange="renderHist()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="ban">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="nhap">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="chiphi">âš¡ Chi phÃ­</option>
        <option value="adj">âš™ï¸ Äiá»u chá»‰nh kho</option>
      </select>
      <select id="hMon" onchange="renderHist()"><option value="">Táº¥t cáº£ thÃ¡ng</option></select>
      <button class="btn btn-w btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTable"></div>
  </div>
</div>
</div>

</div><!-- end main -->

<div id="nav">
  <button class="nb on" onclick="goPage('home',this)"><span class="ic">ğŸ </span>Tá»•ng quan</button>
  <button class="nb" onclick="goPage('money',this)"><span class="ic">ğŸ’°</span>Thu/Chi</button>
  <button class="nb" onclick="goPage('promo',this)"><span class="ic">ğŸ“£</span>Quáº£ng bÃ¡</button>
  <button class="nb" onclick="goPage('reports',this)"><span class="ic">ğŸ“Š</span>BÃ¡o cÃ¡o</button>
  <button class="nb" onclick="goPage('ai',this)"><span class="ic">ğŸ¤–</span>AI</button>
  <button class="nb" onclick="goPage('history',this)"><span class="ic">ğŸ“š</span>Lá»‹ch sá»­</button>
</div>

<!-- OVERLAYS -->
<div class="ov" id="ovConfirm">
  <div class="modal">
    <h3 id="ovTitle">XÃ¡c nháº­n</h3>
    <p id="ovMsg" style="font-size:.79rem;color:var(--muted);line-height:1.5"></p>
    <div class="mbtns">
      <button class="mbtnc" onclick="closeOv('ovConfirm')">Huá»·</button>
      <button class="mbtnok" id="ovOkBtn">XÃ¡c nháº­n</button>
    </div>
  </div>
</div>
<div class="ov" id="ovStock">
  <div class="modal" style="border:3px solid var(--r)">
    <h3 style="color:var(--r)">âš ï¸ Tá»“n kho khÃ´ng Ä‘á»§!</h3>
    <div style="font-size:.93rem;font-weight:700;color:var(--r);line-height:1.5;padding:8px 0;text-align:center" id="ovStockMsg"></div>
    <div class="mbtns">
      <button class="mbtnc" onclick="closeOv('ovStock')">Huá»· bá»</button>
      <button class="mbtna" onclick="forceStock()">Váº«n ghi nháº­n</button>
    </div>
  </div>
</div>
<div class="ov" id="ovAdj">
  <div class="modal">
    <h3>âš™ï¸ Äiá»u chá»‰nh tá»“n kho / Hao há»¥t</h3>
    <div class="adjwarn">âš ï¸ Chá»‰ <strong>trá»« tá»“n kho</strong>, <strong>KHÃ”NG táº¡o khoáº£n chi</strong></div>
    <div class="field"><label>ğŸ“¦ Chá»n sáº£n pháº©m</label><select class="inp" id="adjProd"></select></div>
    <div class="g2">
      <div class="field"><label>ğŸ”¢ Sá»‘ lÆ°á»£ng giáº£m</label><input class="inp" id="adjQty" placeholder="0" oninput="handleM(this)" onkeydown="noKey(event)"></div>
      <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="adjDate"></div>
    </div>
    <div class="field"><label>ğŸ“‹ LÃ½ do</label>
      <select class="inp" id="adjReason">
        <option value="huhong">ğŸ”´ HÆ° há»ng</option>
        <option value="hethan">â° Háº¿t háº¡n</option>
        <option value="thathoat">ğŸ•µï¸ Tháº¥t thoÃ¡t</option>
        <option value="kiemke">ğŸ“‹ Kiá»ƒm kÃª sai</option>
        <option value="khac">ğŸ“Œ KhÃ¡c</option>
      </select>
    </div>
    <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" id="adjNote" placeholder="Tuá»³ chá»n..."></div>
    <div class="mbtns">
      <button class="mbtnc" onclick="closeOv('ovAdj')">Huá»·</button>
      <button class="mbtna" onclick="confirmAdj()">âš™ï¸ XÃ¡c nháº­n</button>
    </div>
  </div>
</div>
<div id="toast"></div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
const LOW = 5, TAX_TH = 500_000_000;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCALSTORAGE (persists across F5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mGet(k){try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{return null}}
function mSet(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){console.warn('Storage:',e)}}
function mKeys(){try{return Object.keys(localStorage)}catch{return[]}}

let KEY = mGet('_gemini_key')||'';
if(KEY){const el=document.getElementById('apiIn');if(el)el.value=KEY;const st=document.getElementById('apiSt');if(st){st.textContent='âœ… Key Ä‘Ã£ lÆ°u';st.style.color='#1B6B3A'}}

let CUR = new Date().toISOString().slice(0,7);

function emptyFin(){return{sales:[],imports:[],costs:[],adjs:[]}}
function loadFin(mk){const d=mGet('fin-'+mk);return d?{sales:d.sales||[],imports:d.imports||[],costs:d.costs||[],adjs:d.adjs||[]}:emptyFin()}
function saveFin(mk,d){mSet('fin-'+mk,d)}
let FIN = loadFin(CUR);
function persist(){saveFin(CUR,FIN)}

function loadProds(){return mGet('prods')||[]}
function saveProds(a){mSet('prods',a)}
function upsertProd(p){const a=loadProds(),i=a.findIndex(x=>x.name===p.name&&(x.unitOut||'')===(p.unitOut||''));if(i>=0)Object.assign(a[i],p);else a.push(p);saveProds(a)}
function loadCooks(){return mGet('cooks')||[]}
function saveCooks(a){mSet('cooks',a)}

function allMKs(){
  const s=new Set([CUR]);
  mKeys().filter(k=>/^fin-\d{4}-\d{2}$/.test(k)).forEach(k=>s.add(k.replace('fin-','')));
  return[...s].sort();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY â€” compound key name:::unitOut
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function invKey(name,unitOut){return name+':::'+( unitOut||'')}

function computeInv(){
  const map={};
  allMKs().forEach(mk=>{
    const f=loadFin(mk);
    f.imports.forEach(imp=>{
      if(imp.kind!=='hangban')return;
      const uOut=imp.unitOut||imp.unitIn||'';
      const k=invKey(imp.name,uOut);
      if(!map[k])map[k]={name:imp.name,unitIn:imp.unitIn||'',unitOut:uOut,factor:imp.factor||1,stock:0,totalIn:0,totalSold:0,lastP:0,lastD:'',key:k};
      const add=imp.stockAdded||(imp.qtyIn*(imp.factor||1));
      map[k].stock+=add;map[k].totalIn+=add;
      if(imp.totalAmt>0&&add>0)map[k].lastP=Math.round(imp.totalAmt/add);
      if(!map[k].lastD||imp.date>map[k].lastD)map[k].lastD=imp.date;
      map[k].unitIn=imp.unitIn||map[k].unitIn;
      map[k].factor=imp.factor||map[k].factor;
    });
    f.sales.forEach(s=>{
      if(s.type!=='hangban')return;
      const k=invKey(s.name,s.unitOut||'');
      if(map[k]){map[k].stock=Math.max(0,map[k].stock-s.qty);map[k].totalSold+=s.qty}
    });
    (f.adjs||[]).forEach(a=>{
      const k=invKey(a.name,a.unitOut||'');
      if(map[k])map[k].stock=Math.max(0,map[k].stock-a.qty);
    });
  });
  return Object.values(map);
}

function getStock(name,unitOut){
  const inv=computeInv(),k=invKey(name,unitOut||'');
  const it=inv.find(x=>x.key===k);
  if(!it){const any=inv.find(x=>x.name===name);return any?{stock:any.stock,unitOut:any.unitOut}:{stock:0,unitOut:unitOut||''}}
  return{stock:it.stock,unitOut:it.unitOut};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AGGREGATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRev(mk){return loadFin(mk).sales.reduce((s,x)=>s+x.totalAmt,0)}
function getCost(mk){const f=loadFin(mk);return f.imports.reduce((s,x)=>s+x.totalAmt,0)+f.costs.reduce((s,x)=>s+x.amount,0)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function getThu(){const t=todayISO();return FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.totalAmt,0)}
function getChi(){const t=todayISO();const i=FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.totalAmt,0);const c=FIN.costs.filter(x=>x.date&&x.date.slice(0,10)===t).reduce((s,x)=>s+x.amount,0);return i+c}
function yearRevenue(){const yr=new Date().getFullYear();return allMKs().filter(k=>k.startsWith(yr+'')).reduce((s,k)=>s+getRev(k),0)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt=n=>!n?'0Ä‘':n.toLocaleString('vi-VN')+'Ä‘';
function axFmt(v){if(!v)return'0';const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(1).replace('.0','')+'tá»·';if(a>=1e6)return(v/1e6).toFixed(1).replace('.0','')+'M';if(a>=1e3)return(v/1e3).toFixed(0)+'K';return String(v)}
const fmtDt=d=>{if(!d)return'';const s=d.includes('T')?d:d+'T00:00';const dt=new Date(s);if(isNaN(dt))return d.slice(0,10);const dd=String(dt.getDate()).padStart(2,'0'),mm=String(dt.getMonth()+1).padStart(2,'0'),hh=String(dt.getHours()).padStart(2,'0'),mn=String(dt.getMinutes()).padStart(2,'0');return dt.getHours()===0&&dt.getMinutes()===0?`${dd}/${mm}`:`${dd}/${mm} ${hh}:${mn}`};
function nowDT(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function mLabel(k){const[y,m]=k.split('-');return`ThÃ¡ng ${parseInt(m)}/${y}`}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE FIELDS â€” auto-update
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshDates(){
  const now=nowDT();
  ['sDate','iDate','cpDate','adjDate'].forEach(id=>{
    const el=document.getElementById(id);
    if(el&&!el._locked)el.value=now;
  });
}
// Lock when user manually changes
['sDate','iDate','cpDate','adjDate'].forEach(id=>{
  document.addEventListener('DOMContentLoaded',()=>{
    const el=document.getElementById(id);
    if(el)el.addEventListener('change',()=>{el._locked=true;setTimeout(()=>{el._locked=false},300000)});
  });
});
setInterval(refreshDates, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleM(el){const r=(el.value||'').replace(/\D/g,'');el.dataset.raw=r;el.value=r?parseInt(r).toLocaleString('vi-VN'):''}
function noKey(e){if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault()}
function getRaw(id){const el=document.getElementById(id);return el?parseInt((el.dataset.raw||'0').replace(/\D/g,'')||'0')||0:0}
function gv(id){const el=document.getElementById(id);return el?(el.value||'').trim():''}
function sv(id,v){const el=document.getElementById(id);if(el)el.value=v}
function setM(id,n){const el=document.getElementById(id);if(!el)return;el.dataset.raw=String(n);el.value=n?n.toLocaleString('vi-VN'):''}
function clrM(id){const el=document.getElementById(id);if(el){el.value='';el.dataset.raw=''}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMonthOpts(){
  const s=new Set();
  for(let i=0;i<6;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);s.add(d.toISOString().slice(0,7))}
  allMKs().forEach(k=>s.add(k));
  return[...s].sort().reverse();
}
function buildMonthSel(){
  const now=new Date().toISOString().slice(0,7),opts=getMonthOpts();
  const sel=document.getElementById('monthSel');
  if(sel)sel.innerHTML=opts.map(k=>`<option value="${k}"${k===CUR?' selected':''}>${mLabel(k)}${k===now?' â­':''}</option>`).join('');
  const mb=document.getElementById('monthBadge');
  if(mb)mb.textContent=CUR===now?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':mLabel(CUR);
  ['cmpA','cmpB'].forEach((id,i)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=opts.map(k=>`<option value="${k}">${mLabel(k)}</option>`).join('');if(i===1&&opts.length>1)el.value=opts[1]});
}
function switchMonth(k){CUR=k;FIN=loadFin(k);buildMonthSel();renderAll();if(document.getElementById('pg-history').classList.contains('on'))renderHist()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(name,btn){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');
  if(btn)btn.classList.add('on');
  refreshDates();
  if(name==='home'){renderAll();renderToday();renderHomeRecent();setTimeout(doHomeChart,80)}
  if(name==='reports')setTimeout(doCharts,80);
  if(name==='history')renderHist();
  if(name==='ai'){doAiSt();setTimeout(scrollMsgs,80)}
}
const MSUBS=['ban','nhap','chiphi','kho','chebien'];
function msub(name,btn){
  MSUBS.forEach(n=>{const el=document.getElementById('ms-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#pg-money .tab').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  refreshDates();
  if(name==='kho'){renderInv();renderAdjHist()}
  if(name==='chebien')renderCooks();
  if(name==='chiphi')renderCpTable();
}
function psub(name,btn){
  ['fb','tt'].forEach(n=>{const el=document.getElementById('ps-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#pg-promo .tab').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
}
function rsub(name,btn){
  ['chart','compare','tax'].forEach(n=>{const el=document.getElementById('rs-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#pg-reports .tab').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  if(name==='chart')setTimeout(doCharts,80);
  if(name==='compare')buildAllTime();
  if(name==='tax')doTax();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveKey(){const v=(document.getElementById('apiIn').value||'').trim();if(!v){toast('âš ï¸ Nháº­p key!',true);return}KEY=v;mSet('_gemini_key',KEY);const st=document.getElementById('apiSt');if(st){st.textContent='âœ… Sáºµn sÃ ng!';st.style.color='#1B6B3A'}document.getElementById('apiBar').style.background='#F1F8E9';toast('âœ… ÄÃ£ lÆ°u API Key!',false,true)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST & OVERLAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tt=null;
function toast(msg,err=false,ok=false){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className=err?'on err':ok?'on ok':'on';clearTimeout(_tt);_tt=setTimeout(()=>t.className='',3500)}
let _pendSale=null;
function showCfm(title,msg,fn){sv('ovTitle',title);document.getElementById('ovMsg').textContent=msg;document.getElementById('ovOkBtn').onclick=()=>{closeOv('ovConfirm');fn()};document.getElementById('ovConfirm').classList.add('on')}
function closeOv(id){document.getElementById(id).classList.remove('on')}
function showStockAlert(msg,fn){document.getElementById('ovStockMsg').innerHTML=msg;document.getElementById('ovStock').classList.add('on');_pendSale=fn}
function forceStock(){closeOv('ovStock');if(_pendSale)_pendSale();_pendSale=null}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELL SUGGESTIONS (compound items)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _curType='hangban',_sellName='',_sellUnitOut='';

function onSellSug(val){
  const drop=document.getElementById('sDrop'),q=(val||'').toLowerCase();
  const inv=computeInv(),cooks=loadCooks();
  const hb=inv.filter(x=>!q||x.name.toLowerCase().includes(q));
  const cb=cooks.filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';
  if(!hb.length&&!cb.length){drop.classList.remove('on');return}
  if(hb.length){
    const g=document.createElement('div');g.className='suggrp';g.textContent='ğŸ—„ï¸ HÃ ng trong kho';drop.appendChild(g);
    hb.slice(0,10).forEach(p=>{
      const d=document.createElement('div');d.className='sugopt';
      const dispName=p.unitOut?`${p.name} (${p.unitOut})`:p.name;
      d.innerHTML=`<div>${dispName}</div><div class="sm">Tá»“n: <strong>${p.stock} ${p.unitOut||''}</strong>${p.lastP?' Â· Nháº­p: '+fmt(p.lastP):''}</div>`;
      d.onmousedown=()=>{selSell(p.name,'hangban',p);drop.classList.remove('on')};
      drop.appendChild(d);
    });
  }
  if(cb.length){
    const g2=document.createElement('div');g2.className='suggrp';g2.textContent='ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n';drop.appendChild(g2);
    cb.slice(0,8).forEach(c=>{const d=document.createElement('div');d.className='sugopt';d.innerHTML=`<div>${c.name}</div><div class="sm">Cháº¿ biáº¿n Â· ${c.price?fmt(c.price):'ChÆ°a Ä‘áº·t giÃ¡'}</div>`;d.onmousedown=()=>{selSell(c.name,'chebien',c);drop.classList.remove('on')};drop.appendChild(d)});
  }
  drop.classList.add('on');
}
function selSell(name,type,data){
  _sellName=name;_curType=type;_sellUnitOut=data.unitOut||'';
  const disp=data.unitOut?`${name} (${data.unitOut})`:name;
  sv('sName',disp);
  const b=document.getElementById('sInfo');if(!b)return;b.style.display='block';
  if(type==='hangban'){b.textContent=`ğŸ“¦ ${disp} â€” Tá»“n kho: ${data.stock} ${data.unitOut||''}${data.lastP?' Â· Nháº­p: '+fmt(data.lastP):''}`;if(data.lastP)setM('sPrice',data.lastP)}
  else{b.textContent=`ğŸ‘¨â€ğŸ³ ${name} â€” Sáº£n pháº©m cháº¿ biáº¿n Â· KhÃ´ng trá»« kho`;if(data.price)setM('sPrice',data.price)}
}
function closeSellSug(){document.getElementById('sDrop').classList.remove('on')}
function clrSInfo(){const b=document.getElementById('sInfo');if(b)b.style.display='none';_curType='hangban';_sellName='';_sellUnitOut=''}
function calcTotal(){const b=document.getElementById('sTotal');if(!b)return;const q=getRaw('sQty'),p=getRaw('sPrice');if(q&&p){b.style.display='block';b.textContent=`ğŸ’° ThÃ nh tiá»n: ${fmt(q*p)}`}else b.style.display='none'}

// Import suggestions
function onImpSug(val){
  const drop=document.getElementById('iDrop'),q=(val||'').toLowerCase();
  const prods=loadProds().filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';if(!prods.length){drop.classList.remove('on');return}
  const seen=new Set();
  prods.slice(0,10).forEach(p=>{
    const lbl=p.unitOut?`${p.name} (${p.unitOut})`:p.name;
    if(seen.has(lbl))return;seen.add(lbl);
    const d=document.createElement('div');d.className='sugopt';
    d.innerHTML=`<div>${lbl}</div><div class="sm">${p.kind==='hangban'?'ğŸ›’ HÃ ng bÃ¡n láº¡i':'ğŸ§‚ NguyÃªn liá»‡u'}${p.unitIn?' Â· '+p.unitIn+(p.unitOut&&p.unitOut!==p.unitIn?'â†’'+p.unitOut:''):''}</div>`;
    d.onmousedown=()=>{sv('iName',p.name);drop.classList.remove('on');sv('iType',p.kind||'hangban');sv('iUIn',p.unitIn||'');sv('iUOut',p.unitOut||'');const fe=document.getElementById('iFac');if(fe){fe.value=p.factor||1;fe.dataset.raw=String(p.factor||1)}togImpMode();showConv()};
    drop.appendChild(d);
  });
  drop.classList.add('on');
}
function closeImpSug(){document.getElementById('iDrop').classList.remove('on')}
function togImpMode(){const t=gv('iType'),w=document.getElementById('iConvWrap');if(w)w.style.display=t==='nguyenlieu'?'none':'block'}
function showConv(){const b=document.getElementById('convPreview');if(!b)return;const q=getRaw('iQty'),f=getRaw('iFac')||1,uI=gv('iUIn')||'Ä‘v nháº­p',uO=gv('iUOut')||'Ä‘v bÃ¡n';if(q&&f){b.innerHTML=`ğŸ“¦ <strong>${q} ${uI}</strong> Ã— <strong>${f}</strong> = <strong>${q*f} ${uO}</strong> vÃ o kho`;b.classList.add('on')}else b.classList.remove('on')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERIOD FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let perBan='all',perNhap='all',perChart='week';
function setPer(tab,p,btn){
  if(tab==='ban')perBan=p;else perNhap=p;
  const pid=tab==='ban'?'ms-ban':'ms-nhap';
  document.querySelectorAll(`#${pid} .ptab`).forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  if(tab==='ban')renderBanTable();else renderNhapTable();
}
function setChPer(p,btn){perChart=p;document.querySelectorAll('#rs-chart .ptab').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');doCharts()}
function filterPer(arr,per){
  if(per==='all')return arr;
  const now=new Date(),tod=todayISO();
  return arr.filter(x=>{const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(per==='today')return d===tod;if(per==='week'){const dt=new Date(d+'T00:00'),w=new Date(now);w.setDate(now.getDate()-6);return dt>=w}if(per==='month')return d.slice(0,7)===CUR;return true});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selAll(tab,checked){document.querySelectorAll(`.cb-${tab}`).forEach(cb=>cb.checked=checked);updBulk(tab)}
function updBulk(tab){const c=document.querySelectorAll(`.cb-${tab}:checked`).length,b=document.getElementById(tab+'Bulk');if(b)b.style.display=c?'inline-flex':'none'}
function bulkDel(tab){const ids=[];document.querySelectorAll(`.cb-${tab}:checked`).forEach(cb=>ids.push(+cb.value));if(!ids.length){toast('âš ï¸ ChÆ°a chá»n!',true);return}showCfm(`XoÃ¡ ${ids.length} dÃ²ng`,'KhÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{const s=new Set(ids);if(tab==='ban')FIN.sales=FIN.sales.filter(x=>!s.has(x.id));else FIN.imports=FIN.imports.filter(x=>!s.has(x.id));persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}
function cfmDelAll(tab){showCfm('XoÃ¡ táº¥t cáº£',`XoÃ¡ TOÃ€N Bá»˜ ${tab==='ban'?'bÃ¡n hÃ ng':'nháº­p hÃ ng'} thÃ¡ng ${mLabel(CUR)}?`,()=>{if(tab==='ban')FIN.sales=[];else FIN.imports=[];persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderSummary();renderBanTable();renderNhapTable()}
function renderToday(){
  const thu=getThu(),chi=getChi(),lai=thu-chi;
  const d=new Date(),lbl=`ğŸ“… ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const el=document.getElementById('todayLabel');if(el)el.textContent=lbl;
  [['h-tthu',fmt(thu)],['h-tchi',fmt(chi)],['h-tlai',(lai>=0?'+':'')+fmt(lai)],['m-tthu',fmt(thu)],['m-tchi',fmt(chi)],['m-tlai',(lai>=0?'+':'')+fmt(lai)]].forEach(([id,v])=>{const e=document.getElementById(id);if(e)e.textContent=v});
}
function renderSummary(){
  const thu=getRev(CUR),chi=getCost(CUR),lai=thu-chi;
  [['h-thu',fmt(thu)],['h-chi',fmt(chi)],['h-lai',(lai>=0?'+':'')+fmt(lai),'color:'+(lai>=0?'var(--g)':'var(--r)')],['m-thu',fmt(thu)],['m-chi',fmt(chi)],['m-lai',(lai>=0?'+':'')+fmt(lai),'color:'+(lai>=0?'var(--g)':'var(--r)')]].forEach(([id,v,s])=>{const e=document.getElementById(id);if(!e)return;e.textContent=v;if(s)e.style.cssText=s});
}
function renderBanTable(){
  const w=document.getElementById('banTable');if(!w)return;
  const rows=filterPer(FIN.sales,perBan).sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ giao dá»‹ch bÃ¡n</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th></th><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>SL</th><th>Doanh thu</th><th></th></tr></thead><tbody>${rows.map(t=>`<tr><td class="cbcell"><input type="checkbox" class="cb-ban" value="${t.id}" onchange="updBulk('ban')"></td><td>${fmtDt(t.date)}</td><td><span class="tag ${t.type==='chebien'?'t-cook':'t-sell'}">${t.name}${t.unitOut?' ('+t.unitOut+')':''}</span></td><td>${t.qty}${t.unitOut?' '+t.unitOut:''}</td><td class="tv">+${fmt(t.totalAmt)}</td><td><button class="delbtn" onclick="delSale(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderNhapTable(){
  const w=document.getElementById('nhapTable');if(!w)return;
  const rows=filterPer(FIN.imports,perNhap).sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>ChÆ°a cÃ³ khoáº£n nháº­p</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th></th><th>NgÃ y</th><th>HÃ ng hÃ³a</th><th>SL</th><th>Chi</th><th></th></tr></thead><tbody>${rows.map(t=>`<tr><td class="cbcell"><input type="checkbox" class="cb-nhap" value="${t.id}" onchange="updBulk('nhap')"></td><td>${fmtDt(t.date)}</td><td><span class="tag ${t.kind==='nguyenlieu'?'t-mat':'t-imp'}">${t.name}</span></td><td>${t.qtyIn} ${t.unitIn||''}${t.kind==='hangban'&&t.unitOut&&t.unitOut!==t.unitIn?' â†’ '+t.stockAdded+' '+t.unitOut:''}</td><td class="rv">-${fmt(t.totalAmt)}</td><td><button class="delbtn" onclick="delImp(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderCpTable(){
  const w=document.getElementById('cpTable');if(!w)return;
  const rows=[...FIN.costs].sort((a,b)=>b.id-a.id);
  if(!rows.length){w.innerHTML='<div class="empty"><div class="ei">âš¡</div>ChÆ°a cÃ³ chi phÃ­</div>';return}
  const tm={utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',rental:'ğŸª Máº·t báº±ng',labor:'ğŸ‘· NhÃ¢n cÃ´ng',other:'ğŸ“Œ KhÃ¡c'};
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>MÃ´ táº£</th><th>Tiá»n</th><th></th></tr></thead><tbody>${rows.map(c=>`<tr><td>${fmtDt(c.date)}</td><td>${tm[c.type]||c.type}</td><td>${c.desc}</td><td class="rv">-${fmt(c.amount)}</td><td><button class="delbtn" onclick="delCp(${c.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`;
}
function renderHomeRecent(){
  const w=document.getElementById('homeRecent');if(!w)return;
  const all=[...FIN.sales.map(x=>({...x,tt:'ban'})),...FIN.imports.map(x=>({...x,tt:'nhap'}))].sort((a,b)=>b.id-a.id).slice(0,8);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn</th><th>Tiá»n</th></tr></thead><tbody>${all.map(x=>`<tr><td>${fmtDt(x.date)}</td><td>${x.tt==='ban'?'<span class="tag t-sell">ğŸ’° BÃ¡n</span>':'<span class="tag t-imp">ğŸ“¦ Nháº­p</span>'}</td><td>${(x.name||'')+(x.unitOut&&x.tt==='ban'?' ('+x.unitOut+')':'')}</td><td class="${x.tt==='ban'?'tv':'rv'}">${x.tt==='ban'?'+':'-'}${fmt(x.totalAmt)}</td></tr>`).join('')}</tbody></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInv(){
  const el=document.getElementById('invView');if(!el)return;
  const q=(gv('invSearch')||'').toLowerCase(),stf=gv('invStatus')||'';
  let inv=computeInv();
  if(q)inv=inv.filter(x=>x.name.toLowerCase().includes(q));
  if(!inv.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>KhÃ´ng tÃ¬m tháº¥y</div>';return}
  const now=new Date();
  const outI=inv.filter(x=>x.stock===0);
  const lowI=inv.filter(x=>x.stock>0&&x.stock<LOW);
  const okI=inv.filter(x=>x.stock>=LOW);
  const slowI=okI.filter(x=>{if(!x.lastD)return false;const dd=new Date(x.lastD+'T00:00');return Math.floor((now-dd)/86400000)>=30&&x.totalSold===0});
  const show=st=>!stf||stf===st;
  let html='';
  const urg=[...outI.map(x=>`<strong>${x.name}${x.unitOut?' ('+x.unitOut+')':''}</strong>(háº¿t)`),...lowI.map(x=>`<strong>${x.name}${x.unitOut?' ('+x.unitOut+')':''}</strong>(${x.stock})`)];
  if(urg.length&&!stf)html+=`<div class="invnotice">ğŸ”” Cáº§n nháº­p thÃªm: ${urg.join(' Â· ')}</div>`;
  if(show('out')&&outI.length){html+=`<div class="invsec"><div class="invstitle">ğŸ”´ ÄÃ£ háº¿t (${outI.length})</div>`;outI.forEach(x=>{html+=icrd(x,'out')});html+='</div>'}
  if(show('low')&&lowI.length){html+=`<div class="invsec"><div class="invstitle">ğŸŸ¡ Sáº¯p háº¿t (${lowI.length})</div>`;lowI.forEach(x=>{html+=icrd(x,'low')});html+='</div>'}
  if(show('slow')&&slowI.length){html+=`<div class="invsec"><div class="invstitle">ğŸ”µ BÃ¡n cháº­m (${slowI.length})</div>`;slowI.forEach(x=>{const days=Math.floor((now-new Date(x.lastD+'T00:00'))/86400000);html+=icrd(x,'slow',days)});html+='</div>'}
  const okF=okI.filter(x=>!slowI.find(s=>s.key===x.key));
  if(show('ok')&&okF.length){html+=`<div class="invsec"><div class="invstitle">ğŸŸ¢ Äá»§ hÃ ng (${okF.length})</div>`;okF.forEach(x=>{html+=icrd(x,'ok')});html+='</div>'}
  el.innerHTML=html||'<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng</div>';
}
function icrd(x,st,days){
  const ico={out:'ğŸ”´',low:'ğŸŸ¡',ok:'ğŸŸ¢',slow:'ğŸ”µ'},cs={out:'ic-out',low:'ic-low',ok:'ic-ok',slow:'ic-slow'},qs={out:'q-out',low:'q-low',ok:'q-ok'};
  const dispName=x.unitOut?`${x.name} <span style="font-size:.7rem;color:var(--muted)">(${x.unitOut})</span>`:x.name;
  const meta=st==='slow'?`Nháº­p ${days} ngÃ y trÆ°á»›c Â· Tá»“n: ${x.stock} ${x.unitOut}`:(x.unitIn&&x.unitOut&&x.unitIn!==x.unitOut?`${x.unitIn}â†’${x.unitOut} (Ã—${x.factor})`:`ÄV: ${x.unitOut||x.unitIn||'â€”'}`);
  const ql=st==='out'?'Háº¿t hÃ ng':st==='slow'?`Tá»“n: ${x.stock} (cháº­m)`:st==='low'?`âš ï¸ CÃ²n ${x.stock} ${x.unitOut}`:` âœ… ${x.stock} ${x.unitOut}`;
  return`<div class="invcard ${cs[st]}"><div style="font-size:1.2rem;flex-shrink:0">${ico[st]}</div><div class="invbody"><div class="invname">${dispName}</div><div class="invmeta">${meta}</div></div><span class="invqty ${qs[st]||'q-ok'}">${ql}</span></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADJUSTMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdj(){
  const inv=computeInv().filter(x=>x.stock>0);
  const sel=document.getElementById('adjProd');if(!sel)return;
  if(!inv.length){toast('âš ï¸ Kho trá»‘ng!',true);return}
  sel.innerHTML=inv.map(x=>{
    const label=x.unitOut?`${x.name} (${x.unitOut}) â€” Tá»“n: ${x.stock} ${x.unitOut}`:`${x.name} â€” Tá»“n: ${x.stock}`;
    return`<option value="${x.key}">${label}</option>`;
  }).join('');
  sv('adjDate',nowDT());clrM('adjQty');sv('adjNote','');
  document.getElementById('ovAdj').classList.add('on');
}
function confirmAdj(){
  const key=gv('adjProd'),qty=getRaw('adjQty'),reason=gv('adjReason'),note=gv('adjNote'),date=gv('adjDate');
  if(!key){toast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}
  if(!qty){toast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  const[name,unitOut]=(key+':::').split(':::');
  const{stock}=getStock(name,unitOut);
  if(stock<qty){toast(`âš ï¸ Kho chá»‰ cÃ²n ${stock}!`,true);return}
  const rmap={huhong:'HÆ° há»ng',hethan:'Háº¿t háº¡n',thathoat:'Tháº¥t thoÃ¡t',kiemke:'Kiá»ƒm kÃª sai',khac:'KhÃ¡c'};
  FIN.adjs.push({id:Date.now(),name,unitOut,qty,reason,reasonLabel:rmap[reason]||reason,note,date});
  persist();renderInv();renderAdjHist();closeOv('ovAdj');
  toast(`âœ… Giáº£m ${qty} ${unitOut} ${name} (${rmap[reason]||reason})`,false,true);
}
function renderAdjHist(){
  const w=document.getElementById('adjHist');if(!w)return;
  const all=[];allMKs().forEach(mk=>{const f=loadFin(mk);(f.adjs||[]).forEach(a=>all.push({...a,mk}))});
  all.sort((a,b)=>b.id-a.id);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">âš™ï¸</div>ChÆ°a cÃ³ Ä‘iá»u chá»‰nh</div>';return}
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>Giáº£m</th><th>LÃ½ do</th></tr></thead><tbody>${all.map(a=>`<tr><td>${fmtDt(a.date)}</td><td>${a.name}${a.unitOut?' ('+a.unitOut+')':''}</td><td class="rv">-${a.qty}</td><td>${a.reasonLabel||a.reason}${a.note?' â€” '+a.note:''}</td></tr>`).join('')}</tbody></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COOK PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCook(){const name=gv('cbName'),price=getRaw('cbPrice');if(!name){toast('âš ï¸ Nháº­p tÃªn!',true);return}const a=loadCooks();if(a.find(x=>x.name===name)){toast('âš ï¸ ÄÃ£ tá»“n táº¡i!',true);return}a.push({id:Date.now(),name,price});saveCooks(a);renderCooks();sv('cbName','');clrM('cbPrice');toast('âœ… ÄÃ£ thÃªm!')}
function delCook(id){showCfm('XoÃ¡ sáº£n pháº©m','XoÃ¡ sáº£n pháº©m nÃ y?',()=>{saveCooks(loadCooks().filter(x=>x.id!==id));renderCooks();toast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCooks(){const el=document.getElementById('cookList');if(!el)return;const a=loadCooks();if(!a.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ‘¨â€ğŸ³</div>ChÆ°a cÃ³ sáº£n pháº©m cháº¿ biáº¿n</div>';return}el.innerHTML=a.map(c=>`<div class="cookitem"><div class="cookbody"><div class="cookname">${c.name}</div><div class="cookmeta">Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho</div></div><div class="cookprice">${c.price?fmt(c.price):'â€”'}</div><button class="cookdel" onclick="delCook(${c.id})">ğŸ—‘ï¸</button></div>`).join('')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSale(force=false){
  const inputVal=gv('sName');
  const name=_sellName||inputVal.replace(/\s*\([^)]*\)\s*$/,'').trim();
  const qty=getRaw('sQty'),price=getRaw('sPrice'),date=gv('sDate'),desc=gv('sDesc');
  if(!name){toast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}
  if(!qty){toast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  if(!price){toast('âš ï¸ Nháº­p Ä‘Æ¡n giÃ¡!',true);return}
  if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}
  const type=_curType||'hangban';
  if(type==='hangban'&&!force){
    const{stock,unitOut}=getStock(name,_sellUnitOut);
    if(stock<qty){showStockAlert(`<strong>${name}${_sellUnitOut?' ('+_sellUnitOut+')':''}</strong><br>Kho cÃ²n: <strong>${stock} ${unitOut}</strong><br>Äá»‹nh bÃ¡n: <strong>${qty} ${unitOut}</strong>`,()=>doSave(name,type,qty,price,date,desc));return}
  }
  doSave(name,type,qty,price,date,desc);
}
function doSave(name,type,qty,price,date,desc){
  const unitOut=type==='hangban'?_sellUnitOut:(_sellUnitOut||'');
  FIN.sales.push({id:Date.now(),name,type,qty,unitPrice:price,totalAmt:qty*price,date,desc:desc||'BÃ¡n '+name,unitOut});
  persist();renderAll();renderToday();
  sv('sName','');clrM('sQty');clrM('sPrice');sv('sDesc','');
  document.getElementById('sTotal').style.display='none';clrSInfo();
  toast(`âœ… BÃ¡n ${qty}${unitOut?' '+unitOut:''} ${name}!`,false,true);
}
function delSale(id){showCfm('XoÃ¡ giao dá»‹ch','XoÃ¡ giao dá»‹ch bÃ¡n nÃ y?',()=>{FIN.sales=FIN.sales.filter(x=>x.id!==id);persist();renderAll();renderToday();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addImport(){
  const name=gv('iName'),kind=gv('iType')||'hangban',qtyIn=getRaw('iQty'),totalAmt=getRaw('iAmt'),date=gv('iDate'),unitIn=gv('iUIn')||'cÃ¡i';
  const unitOut=kind==='nguyenlieu'?unitIn:(gv('iUOut')||unitIn),factor=kind==='nguyenlieu'?1:(getRaw('iFac')||1);
  if(!name){toast('âš ï¸ Nháº­p tÃªn!',true);return}if(!qtyIn){toast('âš ï¸ Nháº­p SL!',true);return}if(!totalAmt){toast('âš ï¸ Nháº­p tiá»n!',true);return}if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}
  const stockAdded=kind==='hangban'?qtyIn*factor:0;
  FIN.imports.push({id:Date.now(),name,kind,qtyIn,unitIn,unitOut,factor,stockAdded,totalAmt,date,desc:`Nháº­p ${qtyIn} ${unitIn} ${name}`});
  persist();
  if(kind==='hangban')upsertProd({name,kind,unitIn,unitOut,factor,lastP:Math.round(totalAmt/(qtyIn*factor))});
  else upsertProd({name,kind:'nguyenlieu',unitIn,unitOut:unitIn,factor:1});
  renderAll();renderInv();renderToday();
  sv('iName','');clrM('iQty');clrM('iAmt');sv('iUIn','');sv('iUOut','');
  const fe=document.getElementById('iFac');if(fe){fe.value='';fe.dataset.raw=''}
  document.getElementById('convPreview').classList.remove('on');
  document.getElementById('invNotice').classList.remove('on');
  toast(kind==='hangban'?`âœ… Nháº­p ${qtyIn} ${unitIn} â†’ +${stockAdded} ${unitOut} kho!`:`âœ… Chi nguyÃªn liá»‡u ${fmt(totalAmt)}`);
}
function delImp(id){showCfm('XoÃ¡ khoáº£n nháº­p','Tá»“n kho sáº½ thay Ä‘á»•i.',()=>{FIN.imports=FIN.imports.filter(x=>x.id!==id);persist();renderAll();renderInv();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COSTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCost(){const desc=gv('cpDesc'),amount=getRaw('cpAmt'),date=gv('cpDate'),type=gv('cpType');if(!desc){toast('âš ï¸ Nháº­p mÃ´ táº£!',true);return}if(!amount){toast('âš ï¸ Nháº­p tiá»n!',true);return}if(!date){toast('âš ï¸ Chá»n ngÃ y!',true);return}FIN.costs.push({id:Date.now(),desc,amount,type,date});persist();renderAll();renderCpTable();renderToday();clrM('cpAmt');sv('cpDesc','');toast('âœ… ÄÃ£ thÃªm!')}
function delCp(id){showCfm('XoÃ¡ chi phÃ­','XoÃ¡ khoáº£n chi nÃ y?',()=>{FIN.costs=FIN.costs.filter(x=>x.id!==id);persist();renderAll();renderCpTable();toast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEMINI API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(parts,maxTokens=800){
  if(!KEY)throw new Error('ChÆ°a cÃ³ API Key! Vui lÃ²ng nháº­p key á»Ÿ thanh vÃ ng phÃ­a trÃªn.');
  const res=await fetch(`${GEMINI_URL}?key=${KEY}`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      contents:[{parts}],
      generationConfig:{maxOutputTokens:maxTokens,temperature:.3}
    })
  });
  if(!res.ok){
    const err=await res.json().catch(()=>({}));
    throw new Error(err?.error?.message||`Lá»—i HTTP ${res.status}`);
  }
  const data=await res.json();
  if(data.error)throw new Error(data.error.message||'Lá»—i API');
  const txt=data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!txt)throw new Error('AI khÃ´ng tráº£ vá» ná»™i dung. Thá»­ láº¡i!');
  return txt;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BILL SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _billB64='',_billMime='image/jpeg',_billItems=[];
function onBillFile(e){
  const f=e.target.files[0];if(!f)return;
  _billMime=f.type||'image/jpeg';
  const r=new FileReader();
  r.onload=ev=>{
    _billB64=ev.target.result.split(',')[1];
    const box=document.getElementById('billImgBox'),img=document.getElementById('billImg');
    if(box)box.style.display='block';if(img)img.src=ev.target.result;
    document.getElementById('billScanBtn').disabled=false;
  };r.readAsDataURL(f);
}
function resetBill(){_billB64='';_billItems=[];document.getElementById('billFile').value='';const b=document.getElementById('billImgBox');if(b)b.style.display='none';document.getElementById('billScanBtn').disabled=true;document.getElementById('billPrev').classList.remove('on');document.getElementById('billNotice').classList.remove('on')}
async function scanBill(){
  if(!KEY){toast('âš ï¸ Nháº­p API Key!',true);return}
  if(!_billB64){toast('âš ï¸ ChÆ°a chá»n áº£nh!',true);return}
  const ld=document.getElementById('billLoader'),btn=document.getElementById('billScanBtn');
  if(ld)ld.classList.add('on');if(btn)btn.disabled=true;
  document.getElementById('billNotice').classList.remove('on');
  document.getElementById('billPrev').classList.remove('on');_billItems=[];
  const PROMPT=`PhÃ¢n tÃ­ch bill/hÃ³a Ä‘Æ¡n thanh toÃ¡n nÃ y. Tráº£ vá» Máº¢NG JSON duy nháº¥t, khÃ´ng giáº£i thÃ­ch thÃªm.
Format: [{"name":"tÃªn mÃ³n","quantity":sá»‘,"price":Ä‘Æ¡n_giÃ¡_VND,"total":thÃ nh_tiá»n_VND}]
Náº¿u cÃ³ ngÃ y: thÃªm "date":"YYYY-MM-DD" vÃ o pháº§n tá»­ Ä‘áº§u tiÃªn.
Táº¥t cáº£ sá»‘ tiá»n lÃ  sá»‘ nguyÃªn VND. KHÃ”NG cÃ³ kÃ½ tá»± khÃ¡c ngoÃ i máº£ng JSON.`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:_billMime,data:_billB64}},{text:PROMPT}],600);
    if(ld)ld.classList.remove('on');
    const clean=raw.replace(/```json|```/g,'').trim();
    const m=clean.match(/\[[\s\S]*\]/);
    let parsed=null;if(m)try{parsed=JSON.parse(m[0])}catch{}
    if(!parsed||!Array.isArray(parsed)||!parsed.length){
      toast('âš ï¸ AI khÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c â€” thá»­ áº£nh rÃµ hÆ¡n hoáº·c Ä‘á»•i gÃ³c chá»¥p!',true);
      if(btn)btn.disabled=false;return;
    }
    _billItems=parsed.map((it,i)=>({_id:i,removed:false,name:(it.name||it.item||'MÃ³n '+(i+1)).trim(),qty:Math.max(1,parseInt(it.quantity||1)||1),price:parseInt(String(it.price||0).replace(/\D/g,'')||'0'),total:parseInt(String(it.total||0).replace(/\D/g,'')||'0'),date:it.date||''}));
    _billItems.forEach(it=>{if(!it.total&&it.price&&it.qty)it.total=it.price*it.qty});
    renderBillPrev();document.getElementById('billNotice').classList.add('on');
    toast(`âœ… TÃ¡ch Ä‘Æ°á»£c ${_billItems.length} mÃ³n!`,false,true);
  }catch(err){if(ld)ld.classList.remove('on');toast('âŒ '+err.message,true)}
  if(btn)btn.disabled=false;
}
function renderBillPrev(){
  const wrap=document.getElementById('billPrev'),list=document.getElementById('billPrevList');if(!wrap||!list)return;
  const act=_billItems.filter(x=>!x.removed);
  list.innerHTML=_billItems.map(it=>`<div class="previtem${it.removed?' rm':''}"><span class="pidx">${it._id+1}</span><span class="pname">${it.name}</span><span class="pmeta">Ã—${it.qty}${it.price?' Â· '+fmt(it.price):''}=<strong>${fmt(it.total||it.price*it.qty)}</strong></span><button class="pdel" onclick="togBill(${it._id})">${it.removed?'â†©ï¸':'ğŸ—‘ï¸'}</button></div>`).join('');
  const gt=act.reduce((s,x)=>s+(x.total||x.price*x.qty),0);
  document.getElementById('billPrevCount').textContent=`${act.length}/${_billItems.length} mÃ³n`;
  document.getElementById('billPrevTotal').textContent=gt?`Tá»•ng: ${fmt(gt)}`:'';
  wrap.classList.add('on');
}
function togBill(id){const it=_billItems.find(x=>x._id===id);if(it)it.removed=!it.removed;renderBillPrev()}
function confirmBill(){
  const act=_billItems.filter(x=>!x.removed);if(!act.length){toast('âš ï¸ KhÃ´ng cÃ³ mÃ³n nÃ o!',true);return}
  const today=nowDT();
  act.forEach(it=>{FIN.sales.push({id:Date.now()+Math.random(),name:it.name,type:'hangban',qty:it.qty,unitPrice:it.price,totalAmt:it.total||(it.qty*it.price),date:it.date?it.date+'T00:00':today,desc:'Bill: '+it.name,unitOut:''})});
  persist();renderAll();renderToday();
  document.getElementById('billPrev').classList.remove('on');document.getElementById('billNotice').classList.remove('on');_billItems=[];
  toast(`âœ… LÆ°u ${act.length} mÃ³n tá»« bill!`,false,true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVOICE SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _invB64='',_invMime='image/jpeg',_invItems=[];
function onInvFile(e){
  const f=e.target.files[0];if(!f)return;
  _invMime=f.type||'image/jpeg';
  const r=new FileReader();r.onload=ev=>{_invB64=ev.target.result.split(',')[1];const box=document.getElementById('invImgBox'),img=document.getElementById('invImg');if(box)box.style.display='block';if(img)img.src=ev.target.result;document.getElementById('invScanBtn').disabled=false};r.readAsDataURL(f);
}
function resetInv(){_invB64='';_invItems=[];document.getElementById('invFile').value='';const b=document.getElementById('invImgBox');if(b)b.style.display='none';document.getElementById('invScanBtn').disabled=true;document.getElementById('invPrev').classList.remove('on');document.getElementById('invNotice').classList.remove('on')}
async function scanInv(){
  if(!KEY){toast('âš ï¸ Nháº­p API Key!',true);return}if(!_invB64){toast('âš ï¸ ChÆ°a chá»n áº£nh!',true);return}
  const ld=document.getElementById('invLoader'),btn=document.getElementById('invScanBtn');
  if(ld)ld.classList.add('on');if(btn)btn.disabled=true;
  document.getElementById('invPrev').classList.remove('on');document.getElementById('invNotice').classList.remove('on');_invItems=[];
  const PROMPT=`PhÃ¢n tÃ­ch hÃ³a Ä‘Æ¡n nháº­p hÃ ng nÃ y. Tráº£ vá» Máº¢NG JSON duy nháº¥t, khÃ´ng giáº£i thÃ­ch.
Format: [{"name":"tÃªn hÃ ng","quantity":sá»‘,"unit":"Ä‘Æ¡n vá»‹","price":Ä‘Æ¡n_giÃ¡_VND,"total":thÃ nh_tiá»n_VND}]
Náº¿u cÃ³ ngÃ y: thÃªm "date":"YYYY-MM-DD" vÃ o pháº§n tá»­ Ä‘áº§u tiÃªn. Sá»‘ tiá»n lÃ  sá»‘ nguyÃªn VND.`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:_invMime,data:_invB64}},{text:PROMPT}],600);
    if(ld)ld.classList.remove('on');
    const clean=raw.replace(/```json|```/g,'').trim();const m=clean.match(/\[[\s\S]*\]/);
    let parsed=null;if(m)try{parsed=JSON.parse(m[0])}catch{}
    if(!parsed||!Array.isArray(parsed)||!parsed.length){toast('âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c! Thá»­ áº£nh rÃµ hÆ¡n.',true);if(btn)btn.disabled=false;return}
    _invItems=parsed.map((it,i)=>({_id:i,removed:false,name:(it.name||it.ten||'HÃ ng '+(i+1)).trim(),qty:Math.max(1,parseInt(it.quantity||1)||1),unit:it.unit||it.dvt||'',price:parseInt(String(it.price||0).replace(/\D/g,'')||'0'),total:parseInt(String(it.total||0).replace(/\D/g,'')||'0'),date:it.date||''}));
    _invItems.forEach(it=>{if(!it.total&&it.price&&it.qty)it.total=it.price*it.qty});
    renderInvPrev();toast(`âœ… TrÃ­ch xuáº¥t ${_invItems.length} máº·t hÃ ng!`,false,true);
  }catch(err){if(ld)ld.classList.remove('on');toast('âŒ '+err.message,true)}
  if(btn)btn.disabled=false;
}
function renderInvPrev(){
  const wrap=document.getElementById('invPrev'),list=document.getElementById('invPrevList');if(!wrap||!list)return;
  const act=_invItems.filter(x=>!x.removed);
  list.innerHTML=_invItems.map(it=>`<div class="previtem${it.removed?' rm':''}"><span class="pidx">${it._id+1}</span><span class="pname">${it.name}</span><span class="pmeta">Ã—${it.qty}${it.unit?' '+it.unit:''}<strong>${fmt(it.total)}</strong></span><button class="pdel" onclick="togInv(${it._id})">${it.removed?'â†©ï¸':'ğŸ—‘ï¸'}</button></div>`).join('');
  const gt=act.reduce((s,x)=>s+(x.total||0),0);
  document.getElementById('invPrevCount').textContent=`${act.length}/${_invItems.length} máº·t hÃ ng`;
  document.getElementById('invPrevTotal').textContent=gt?`Tá»•ng: ${fmt(gt)}`:'';
  wrap.classList.add('on');
}
function togInv(id){const it=_invItems.find(x=>x._id===id);if(it)it.removed=!it.removed;renderInvPrev()}
function copyInvCSV(){const act=_invItems.filter(x=>!x.removed);if(!act.length){toast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u!',true);return}const csv=['TÃªn,SL,ÄV,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',...act.map(r=>`"${r.name}","${r.qty}","${r.unit}","${r.price}","${r.total}"`)].join('\n');clip(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!')}
function fillFromInv(){const act=_invItems.filter(x=>!x.removed);if(!act.length){toast('âš ï¸ ChÆ°a cÃ³!',true);return}const f=act[0];sv('iName',f.name||'');const qe=document.getElementById('iQty');if(qe){qe.dataset.raw=String(f.qty);qe.value=f.qty?f.qty.toLocaleString('vi-VN'):''}const ae=document.getElementById('iAmt');if(ae&&f.total){ae.dataset.raw=String(f.total);ae.value=f.total.toLocaleString('vi-VN')}if(f.unit)sv('iUIn',f.unit);document.getElementById('invNotice').classList.add('on');toast('âœ… ÄÃ£ Ä‘iá»n form!')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _fbB64='',_fbMime='image/jpeg';
function onFbFile(e){const f=e.target.files[0];if(!f)return;_fbMime=f.type||'image/jpeg';const r=new FileReader();r.onload=ev=>{_fbB64=ev.target.result.split(',')[1];const b=document.getElementById('fbImgBox'),i=document.getElementById('fbImg');if(b)b.style.display='block';if(i)i.src=ev.target.result;document.getElementById('fbBtn').disabled=false};r.readAsDataURL(f)}
function resetFb(){_fbB64='';document.getElementById('fbFile').value='';const b=document.getElementById('fbImgBox');if(b)b.style.display='none';document.getElementById('fbBtn').disabled=true}
async function genFb(){
  if(!KEY||!_fbB64){toast('âš ï¸ Cáº§n API Key vÃ  áº£nh!',true);return}
  const card=document.getElementById('fbCard'),ld=document.getElementById('fbLoader'),box=document.getElementById('fbRes'),btn=document.getElementById('fbCopy');
  card.style.display='block';if(ld)ld.classList.add('on');if(box)box.classList.remove('on');if(btn)btn.classList.remove('on');
  try{const raw=await callGemini([{inline_data:{mime_type:_fbMime,data:_fbB64}},{text:'Viáº¿t bÃ i Ä‘Äƒng Facebook bÃ¡n hÃ ng cho tiá»ƒu thÆ°Æ¡ng Viá»‡t Nam. CÃ³ emoji, call-to-action, hashtag phÃ¹ há»£p. Chá»‰ tráº£ vá» bÃ i viáº¿t.'}],700);if(ld)ld.classList.remove('on');if(box){box.textContent=raw;box.classList.add('on')}if(btn)btn.classList.add('on')}
  catch(err){if(ld)ld.classList.remove('on');if(box){box.textContent='âŒ '+err.message;box.classList.add('on')}toast('âŒ '+err.message,true)}
}
async function genTT(){
  if(!KEY){toast('âš ï¸ Nháº­p API Key!',true);return}const prod=gv('ttProd');if(!prod){toast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return}
  const rm={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},x=rm[gv('ttRole')]||'báº¡n';
  const card=document.getElementById('ttCard'),ld=document.getElementById('ttLoader'),box=document.getElementById('ttRes'),btn=document.getElementById('ttCopy');
  card.style.display='block';if(ld)ld.classList.add('on');if(box)box.classList.remove('on');if(btn)btn.classList.remove('on');
  try{const raw=await callGemini([{text:`HÆ°á»›ng dáº«n ${x} quay TikTok bÃ¡n "${prod}". NgÃ´n ngá»¯ Ä‘Æ¡n giáº£n gáº§n gÅ©i, chia 3 bÆ°á»›c rÃµ rÃ ng. Cuá»‘i bÃ i: "${x.charAt(0).toUpperCase()+x.slice(1)} cá»© quay xong Ä‘Äƒng luÃ´n nhÃ© ğŸ’š"`}],600);if(ld)ld.classList.remove('on');if(box){box.textContent=raw;box.classList.add('on')}if(btn)btn.classList.add('on')}
  catch(err){if(ld)ld.classList.remove('on');toast('âŒ '+err.message,true)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHS={};
function destC(id){if(CHS[id]){try{CHS[id].destroy()}catch{}delete CHS[id]}}
function getChData(){
  const opts=allMKs();
  if(perChart==='week'){const days=[],thu=[],chi=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}
  if(perChart==='month'){const[y,m]=CUR.split('-'),dIM=new Date(y,m,0).getDate(),days=[],thu=[],chi=[];for(let i=1;i<=dIM;i++){const iso=`${CUR}-${String(i).padStart(2,'0')}`;days.push(String(i));thu.push(FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}return{days,thu,chi}}
  const so=[...opts].reverse();return{days:so.map(k=>{const[y,mo]=k.split('-');return`T${parseInt(mo)}/${y.slice(2)}`}),thu:so.map(k=>getRev(k)),chi:so.map(k=>getCost(k))};
}
function doCharts(){
  ['pieC','barC','lineC'].forEach(destC);
  const thu=getRev(CUR),imp=FIN.imports.reduce((s,x)=>s+x.totalAmt,0),cp=FIN.costs.reduce((s,x)=>s+x.amount,0);
  const has=thu>0||imp>0||cp>0;
  document.getElementById('chartEmpty').style.display=has?'none':'block';
  document.getElementById('chartContent').style.display=has?'block':'none';
  if(!has)return;
  const pie=document.getElementById('pieC');
  if(pie)CHS['pieC']=new Chart(pie,{type:'doughnut',data:{labels:['Thu','Nháº­p','Chi phÃ­'],datasets:[{data:[thu,imp,cp],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8},padding:4}}}}});
  const bd=[...new Set(FIN.imports.map(x=>x.name))].slice(0,5).map(n=>({n,v:FIN.imports.filter(x=>x.name===n).reduce((s,x)=>s+x.totalAmt,0)}));
  const bar=document.getElementById('barC');
  if(bar)CHS['barC']=new Chart(bar,{type:'bar',data:{labels:bd.length?bd.map(x=>x.n):['ChÆ°a cÃ³'],datasets:[{data:bd.length?bd.map(x=>x.v):[0],backgroundColor:'rgba(27,107,58,.72)',borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>axFmt(v),font:{size:8}}},x:{grid:{display:false},ticks:{font:{size:7},maxRotation:0}}}}});
  const{days,thu:th,chi:ch}=getChData();
  const line=document.getElementById('lineC');
  if(line)CHS['lineC']=new Chart(line,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:th,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:ch,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:2,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>axFmt(v),font:{size:8}},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
}
function doHomeChart(){
  destC('homeChart');
  const days=[],thu=[],chi=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10),mk=iso.slice(0,7),f=loadFin(mk);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(f.sales.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0));chi.push(f.imports.filter(x=>x.date&&x.date.slice(0,10)===iso).reduce((s,x)=>s+x.totalAmt,0))}
  const c=document.getElementById('homeChart');if(!c)return;
  CHS['homeChart']=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:8}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>axFmt(v),font:{size:8}},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doCompare(){
  const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;
  if(!a||!b||a===b){toast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return}
  const aT=getRev(a),aC=getCost(a),aL=aT-aC,bT=getRev(b),bC=getCost(b),bL=bT-bC;
  const dl=(c,p)=>{const d=c-p,pct=p>0?Math.round(d/p*100):0;return`<div class="cmpd ${d>=0?'dup':'ddn'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`};
  const box=document.getElementById('cmpBox');
  box.innerHTML=`<h3 style="font-size:.82rem;font-weight:800;color:var(--g2);margin-bottom:7px">ğŸ“Š ${mLabel(a)} vs ${mLabel(b)}</h3><div class="cmpgrid"><div class="cmpi"><div class="cmpl">ğŸ“ˆ Thu</div><div class="cmpc">${fmt(aT)}</div><div class="cmpp">${fmt(bT)}</div>${dl(aT,bT)}</div><div class="cmpi"><div class="cmpl">ğŸ“‰ Chi</div><div class="cmpc">${fmt(aC)}</div><div class="cmpp">${fmt(bC)}</div>${dl(aC,bC)}</div><div class="cmpi"><div class="cmpl">ğŸ’¼ LÃ£i</div><div class="cmpc" style="color:${aL>=0?'var(--g)':'var(--r)'}">${(aL>=0?'+':'')+fmt(aL)}</div><div class="cmpp">${(bL>=0?'+':'')+fmt(bL)}</div>${dl(aL,bL)}</div></div>`;
  box.classList.add('on');
}
function buildAllTime(){
  const el=document.getElementById('allTime');if(!el)return;
  const opts=getMonthOpts();
  if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return}
  const rows=opts.map(k=>{const t=getRev(k),c=getCost(k),l=t-c;return`<tr><td>${mLabel(k)}</td><td class="tv">+${fmt(t)}</td><td class="rv">-${fmt(c)}</td><td style="font-weight:800;color:${l>=0?'var(--g)':'var(--r)'}">${(l>=0?'+':'')+fmt(l)}</td></tr>`}).join('');
  const aT=opts.reduce((s,k)=>s+getRev(k),0),aC=opts.reduce((s,k)=>s+getCost(k),0),aL=aT-aC;
  el.innerHTML=`<div class="tblwrap"><table><thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:var(--g2);color:#fff"><td style="padding:6px 7px;font-weight:800">Tá»•ng</td><td style="padding:6px 7px;font-weight:900">+${fmt(aT)}</td><td style="padding:6px 7px;font-weight:900">-${fmt(aC)}</td><td style="padding:6px 7px;font-weight:900;color:${aL>=0?'#A8E6C1':'#FFB3AA'}">${(aL>=0?'+':'')+fmt(aL)}</td></tr></tfoot></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAX 2026
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doTax(){
  const pw=document.getElementById('taxProg'),tb=document.getElementById('taxBox');if(!pw||!tb)return;
  const yr=new Date().getFullYear();
  const yRev=yearRevenue();
  const mo=new Date().getMonth()+1,avg=mo?yRev/mo:0,proj=avg*12,rem=Math.max(0,TAX_TH-yRev);
  const pct=Math.min(100,Math.round(yRev/TAX_TH*100));
  const bc=pct<60?'pb-safe':pct<90?'pb-warn':'pb-dng';
  pw.innerHTML=`<div style="display:flex;justify-content:space-between;font-size:.67rem;margin-bottom:4px"><span style="font-weight:800;color:var(--g2)">ğŸ“Š ÄÃ£ thu ${yr}: ${fmt(yRev)}</span><span style="color:var(--muted)">${pct}%</span></div><div class="progwrap"><div class="progbar ${bc}" style="width:${pct}%">${pct>10?pct+'%':''}</div></div><div style="display:flex;justify-content:space-between;font-size:.64rem;margin-top:3px;color:var(--muted)"><span>0Ä‘</span><span>500 triá»‡u</span></div><div class="g2" style="margin-top:8px"><div style="background:var(--g4);border:1.5px solid var(--g5);border-radius:8px;padding:8px;text-align:center"><div style="font-size:.58rem;font-weight:800;color:var(--muted)">ğŸ’° ÄÃ£ thu</div><div style="font-size:.8rem;font-weight:900;color:var(--g)">${fmt(yRev)}</div></div><div style="background:${rem?'var(--g4)':'var(--rb)'};border:1.5px solid ${rem?'var(--g5)':'var(--r)'};border-radius:8px;padding:8px;text-align:center"><div style="font-size:.58rem;font-weight:800;color:var(--muted)">ğŸ›’ CÃ²n Ä‘Æ°á»£c bÃ¡n</div><div style="font-size:.8rem;font-weight:900;color:${rem?'var(--g)':'var(--r)'}">${fmt(rem)}</div></div></div>`;
  let html='';
  if(yRev>=TAX_TH){const gT=Math.round(yRev*.01),tncn=Math.round((yRev-TAX_TH)*.005);html=`<div class="taxbox tx-dng"><span class="txicon">âš ï¸</span><div class="txmsg">Doanh thu vÆ°á»£t 500 triá»‡u â€” cáº§n ná»™p thuáº¿!</div><div class="txdet"><strong>Doanh thu ${yr}:</strong> ${fmt(yRev)}<br><strong>Thuáº¿ GTGT ~1%:</strong> ${fmt(gT)}<br><strong>Thuáº¿ TNCN = (DT-500tr)Ã—0.5%:</strong> ${fmt(tncn)}<br><strong style="color:var(--r)">Tá»•ng cáº§n ná»™p: ${fmt(gT+tncn)}</strong><br><br>â†’ Khai thuáº¿ táº¡i: <a href="https://canhan.gdt.gov.vn" target="_blank" style="color:var(--g)">canhan.gdt.gov.vn</a></div></div>`}
  else if(proj>=TAX_TH)html=`<div class="taxbox tx-warn"><span class="txicon">ğŸ””</span><div class="txmsg">Dá»± bÃ¡o cÃ³ thá»ƒ cháº¡m ngÆ°á»¡ng 500 triá»‡u!</div><div class="txdet"><strong>ÄÃ£ thu:</strong> ${fmt(yRev)}<br><strong>Dá»± bÃ¡o cáº£ nÄƒm:</strong> ${fmt(Math.round(proj))}<br><strong>CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm:</strong> ${fmt(rem)}</div></div>`;
  else html=`<div class="taxbox tx-safe"><span class="txicon">ğŸ˜Š</span><div class="txmsg">BÃ /chÃº chÆ°a pháº£i ná»™p thuáº¿. Cá»© yÃªn tÃ¢m bÃ¡n!</div><div class="txdet"><strong>ÄÃ£ thu ${yr}:</strong> ${fmt(yRev)}<br><strong>CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm trÆ°á»›c khi lo thuáº¿:</strong> ${fmt(rem)}</div></div>`;
  tb.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _hcsv=[];
function renderHist(){
  const months=getMonthOpts(),all=[];
  months.forEach(mk=>{const f=loadFin(mk);f.sales.forEach(x=>all.push({...x,tt:'ban',mk}));f.imports.forEach(x=>all.push({...x,tt:'nhap',mk}));f.costs.forEach(x=>all.push({...x,tt:'chiphi',mk}));(f.adjs||[]).forEach(x=>all.push({...x,tt:'adj',totalAmt:0,amount:0,mk}))});
  all.sort((a,b)=>b.id-a.id);
  const srch=(gv('hSearch')||'').toLowerCase(),tf=gv('hType'),mf=gv('hMon'),df=gv('hFrom'),dt=gv('hTo');
  const ms=document.getElementById('hMon');if(ms){const cv=ms.value;ms.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+months.map(m=>`<option value="${m}"${m===cv?' selected':''}>${mLabel(m)}</option>`).join('')}
  const filtered=all.filter(x=>{const n=(x.name||x.desc||'').toLowerCase();if(srch&&!n.includes(srch))return false;if(tf&&x.tt!==tf)return false;if(mf&&x.mk!==mf)return false;const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(df&&d&&d<df)return false;if(dt&&d&&d>dt)return false;return true});
  _hcsv=filtered;
  const thu=filtered.filter(x=>x.tt==='ban').reduce((s,x)=>s+x.totalAmt,0);
  const chi=filtered.filter(x=>x.tt==='nhap').reduce((s,x)=>s+x.totalAmt,0)+filtered.filter(x=>x.tt==='chiphi').reduce((s,x)=>s+(x.amount||0),0);
  const lai=thu-chi;
  const se=(id,v,c)=>{const e=document.getElementById(id);if(!e)return;e.textContent=v;if(c)e.style.color=c};
  se('hall-thu',fmt(thu));se('hall-chi',fmt(chi));se('hall-lai',(lai>=0?'+':'')+fmt(lai),lai>=0?'var(--g)':'var(--r)');
  const w=document.getElementById('histTable');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch</div>';return}
  const tm={ban:'<span class="tag t-sell">ğŸ’° BÃ¡n</span>',nhap:'<span class="tag t-imp">ğŸ“¦ Nháº­p</span>',chiphi:'<span class="tag t-op">âš¡ Chi phÃ­</span>',adj:'<span class="tag t-adj">âš™ï¸ Äiá»u chá»‰nh</span>'};
  w.innerHTML=`<div class="tblwrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn</th><th>Tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${filtered.map(x=>{const amt=x.tt==='ban'?x.totalAmt:x.tt==='nhap'?x.totalAmt:(x.amount||0);const isAdj=x.tt==='adj';return`<tr class="hrow" onclick="jumpMon('${x.mk}')"><td>${fmtDt(x.date)}</td><td>${tm[x.tt]||''}</td><td>${(x.name||x.desc||'â€”')+(x.unitOut&&x.tt==='ban'?' ('+x.unitOut+')':'')+(isAdj?' (-'+x.qty+')':'')}</td><td class="${x.tt==='ban'?'tv':'rv'}">${isAdj?'â€”':(x.tt==='ban'?'+':'-')+fmt(amt)}</td><td><span class="jbadge">${mLabel(x.mk)}</span></td></tr>`}).join('')}</tbody></table></div>`;
}
function jumpMon(k){CUR=k;FIN=loadFin(k);buildMonthSel();renderAll();goPage('money',document.querySelectorAll('.nb')[1]);toast(`âœ… â†’ ${mLabel(k)}`)}
function exportCSV(){if(!_hcsv.length){toast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u!',true);return}const rows=['NgÃ y,Loáº¡i,TÃªn,Tiá»n,ThÃ¡ng',..._hcsv.map(x=>{const loai=x.tt==='ban'?'BÃ¡n':x.tt==='nhap'?'Nháº­p':x.tt==='chiphi'?'Chi phÃ­':'Äiá»u chá»‰nh';const amt=x.tt==='ban'?x.totalAmt:x.tt==='nhap'?x.totalAmt:(x.amount||0);return`"${x.date}","${loai}","${(x.name||x.desc||'').replace(/"/g,'""')}","${amt}","${x.mk}"`})].join('\n');clip(rows,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI CHAT â€” Há»™ Má»‡nh Tax Specialist
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function invSum(){
  const inv=computeInv();
  if(!inv.length)return'Kho trá»‘ng.';
  const out=inv.filter(x=>x.stock===0).map(x=>x.name+(x.unitOut?'('+x.unitOut+')':'')),
        low=inv.filter(x=>x.stock>0&&x.stock<LOW).map(x=>`${x.name}${x.unitOut?'('+x.unitOut+')':''}:${x.stock}`),
        ok=inv.filter(x=>x.stock>=LOW).map(x=>`${x.name}${x.unitOut?'('+x.unitOut+')':''}:${x.stock}`);
  let s='';
  if(out.length)s+=`Háº¿t hÃ ng: ${out.join(', ')}. `;
  if(low.length)s+=`Sáº¯p háº¿t: ${low.join(', ')}. `;
  if(ok.length)s+=`Äá»§ hÃ ng: ${ok.join(', ')}.`;
  return s;
}
function doAiSt(){
  const el=document.getElementById('aiSt');if(!el)return;
  const inv=computeInv();
  if(!inv.length){el.textContent='Kho trá»‘ng';return}
  const out=inv.filter(x=>x.stock===0).length,low=inv.filter(x=>x.stock>0&&x.stock<LOW).length,ok=inv.filter(x=>x.stock>=LOW).length;
  const p=[];
  if(out)p.push(`${out} háº¿t`);if(low)p.push(`${low} sáº¯p háº¿t`);if(ok)p.push(`${ok} Ä‘á»§ hÃ ng`);
  el.textContent=p.join(' Â· ')||'Kho á»•n âœ…';
}
function scrollMsgs(){const m=document.getElementById('msgs');if(m)m.scrollTop=m.scrollHeight}
function useChip(btn){const t=btn.textContent.trim(),i=document.getElementById('chatInp');if(i){i.value=t;i.focus();i.style.height='auto';i.style.height=Math.min(i.scrollHeight,100)+'px'}}

function addMsg(txt,role){
  const m=document.getElementById('msgs');if(!m)return;
  const d=document.createElement('div');d.className='msg '+role;
  d.innerHTML=txt.replace(/\n/g,'<br>');
  m.insertBefore(d,document.getElementById('typing'));scrollMsgs();
}
function addMsgWithCopy(txt,copyText){
  const m=document.getElementById('msgs');if(!m)return;
  const d=document.createElement('div');d.className='msg bot';
  d.innerHTML=txt.replace(/\n/g,'<br>');
  if(copyText){
    const btn=document.createElement('button');
    btn.className='aicopy';btn.textContent='ğŸ“‹ Sao chÃ©p sá»‘ tiá»n';
    btn.onclick=()=>{clip(copyText,'ğŸ“‹ ÄÃ£ sao chÃ©p: '+copyText)};
    d.appendChild(document.createElement('br'));d.appendChild(btn);
  }
  m.insertBefore(d,document.getElementById('typing'));scrollMsgs();
}
function addMsgCfm(txt,data){
  const m=document.getElementById('msgs');if(!m)return;
  const d=document.createElement('div');d.className='msg bot';
  d.innerHTML=txt.replace(/\n/g,'<br>')+`<div class="cpill"><button class="py" onclick="aiCfm(this,true)">âœ… LÆ°u</button><button class="pn" onclick="aiCfm(this,false)">âŒ Bá»</button></div>`;
  d._data=data;m.insertBefore(d,document.getElementById('typing'));scrollMsgs();
}
function aiCfm(btn,yes){const d=btn.closest('.msg');const data=d._data;const p=d.querySelector('.cpill');if(p)p.remove();if(yes&&data)aiProcess(data);else addMsg('ğŸ‘ Bá» qua!','bot');scrollMsgs()}
function aiProcess(items){
  if(!Array.isArray(items))return;
  const today=nowDT();
  items.forEach(it=>{
    const name=(it.item||it.name||'').trim();if(!name)return;
    const qty=parseInt(String(it.quantity||1).replace(/\D/g,''))||1,price=parseInt(String(it.price||0).replace(/\D/g,''))||0;
    const isSale=/(bÃ¡n|thu|sell)/i.test(it.type||'');
    if(isSale){
      const{stock,unitOut}=getStock(name,'');
      if(stock>0&&stock<qty){
        showStockAlert(`<strong>${name}</strong><br>Kho: ${stock} ${unitOut}<br>BÃ¡n: ${qty}`,()=>{FIN.sales.push({id:Date.now(),name,type:'hangban',qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut:''});persist();renderAll();renderToday();toast(`âœ… Ghi bÃ¡n ${qty} ${name}!`)});return;
      }
      FIN.sales.push({id:Date.now(),name,type:'hangban',qty,unitPrice:price,totalAmt:qty*price,date:today,desc:'AI: bÃ¡n '+name,unitOut:''});
    }else{
      FIN.imports.push({id:Date.now(),name,kind:'hangban',qtyIn:qty,unitIn:'',unitOut:'',factor:1,stockAdded:qty,totalAmt:qty*price,date:today});
      upsertProd({name,kind:'hangban',unitIn:'',unitOut:'',factor:1});
    }
    persist();
  });
  renderAll();renderInv();doAiSt();renderToday();toast(`âœ… Ghi ${items.length} giao dá»‹ch!`);
}

async function sendChat(){
  const inp=document.getElementById('chatInp'),msg=inp?inp.value.trim():'';
  if(!msg)return;
  if(!KEY){toast('âš ï¸ Nháº­p API Key!',true);return}
  if(inp){inp.value='';inp.style.height='auto'}
  addMsg(msg,'usr');
  const ty=document.getElementById('typing');if(ty)ty.classList.add('on');scrollMsgs();

  const thu=getRev(CUR),chi=getCost(CUR),yRev=yearRevenue(),yr=new Date().getFullYear();
  const rem=Math.max(0,TAX_TH-yRev);
  const isTaxQ=/(thuáº¿|ná»™p thuáº¿|tá» khai|gtgt|tncn|500|canhan|tax)/i.test(msg);

  const SYSTEM=`Báº¡n lÃ  Trá»£ lÃ½ Há»™ Má»‡nh Tiá»ƒu ThÆ°Æ¡ng AI, chuyÃªn gia thuáº¿ vÃ  káº¿ toÃ¡n cho há»™ kinh doanh nhá» Viá»‡t Nam.

LUáº¬T THUáº¾ 2026:
- NgÆ°á»¡ng miá»…n thuáº¿: â‰¤ 500.000.000 VNÄ/nÄƒm â†’ KHÃ”NG pháº£i ná»™p GTGT vÃ  TNCN
- VÆ°á»£t 500 triá»‡u: GTGT 1% (bÃ¡n láº» thá»±c pháº©m/hÃ ng hoÃ¡) hoáº·c 3% (kinh doanh Äƒn uá»‘ng) + TNCN = (DT-500tr) Ã— 0.5%
- Tá» khai Máº«u 01/CNKD: Ã” [21] = Tá»•ng DT phÃ¡t sinh trong ká»³; Ã” [25] = DT tÃ­nh thuáº¿ (chá»‰ khi DT > 500tr)
- Link ná»™p thuáº¿ Ä‘iá»‡n tá»­: https://canhan.gdt.gov.vn

Dá»® LIá»†U THá»°C Táº¾ Cá»¦A NGÆ¯á»œI DÃ™NG:
- Doanh thu nÄƒm ${yr}: ${fmt(yRev)} (${yRev>=TAX_TH?'âš ï¸ ÄÃƒ VÆ¯á»¢T NGÆ¯á» NG':yRev>400000000?'ğŸ”” Gáº§n Ä‘áº¿n ngÆ°á»¡ng':'âœ… ChÆ°a Ä‘áº¿n ngÆ°á»¡ng'})
- CÃ²n Ä‘Æ°á»£c bÃ¡n thÃªm trÆ°á»›c khi ná»™p thuáº¿: ${fmt(rem)}
- ThÃ¡ng ${CUR}: Thu=${fmt(thu)}, Chi=${fmt(chi)}, LÃ£i=${fmt(thu-chi)}
- Kho: ${invSum()}

GIá»ŒNG VÄ‚N: ThÃ¢n thiá»‡n, xÆ°ng "con", gá»i ngÆ°á»i dÃ¹ng "bÃ /cÃ´/chÃº". Ngáº¯n gá»n, chia tá»«ng bÆ°á»›c nhá».
${isTaxQ?`HÆ¯á»šNG DáºªN THUáº¾ (náº¿u há»i vá» thuáº¿):
BÆ°á»›c 1: BÃ¡o tÃ¬nh tráº¡ng thuáº¿ dá»±a trÃªn sá»‘ liá»‡u thá»±c (${fmt(yRev)})
BÆ°á»›c 2: Náº¿u cáº§n ná»™p thuáº¿ â†’ cung cáº¥p link https://canhan.gdt.gov.vn
BÆ°á»›c 3: Chá»‰ Ä‘Ã­ch danh Ã´ cáº§n Ä‘iá»n: "Táº¡i Ã” [21] bÃ  Ä‘iá»n: [sá»‘ tiá»n]"
BÆ°á»›c 4: ÄÆ°a sá»‘ cáº§n copy Ä‘á»ƒ dÃ¡n vÃ o form`:''}
Náº¿u nháº­n lá»‡nh giao dá»‹ch (bÃ¡n/nháº­p hÃ ng), tráº£ JSON trong []: [{"item":"tÃªn","quantity":sá»‘,"price":Ä‘Æ¡n_giÃ¡,"type":"bÃ¡n hoáº·c nháº­p"}]
CÃ¢u tráº£ lá»i ngáº¯n gá»n, 2-4 cÃ¢u + emoji. KhÃ´ng giáº£i thÃ­ch dÃ i dÃ²ng.`;

  const prompt=`${SYSTEM}\n\nTin nháº¯n ngÆ°á»i dÃ¹ng: ${msg}`;
  try{
    const raw=await callGemini([{text:prompt}],600);
    if(ty)ty.classList.remove('on');

    // Check for transaction JSON
    const jm=raw.match(/\[[\s\S]*?\]/);
    if(jm){
      try{
        const p=JSON.parse(jm[0]);
        if(p.length){
          const pv=p.map(x=>`${/(nháº­p)/i.test(x.type)?'ğŸ“¦':'ğŸ’°'} ${x.quantity} ${x.item}${x.price?' @ '+fmt(x.price):''}`).join('\n');
          addMsgCfm((raw.replace(jm[0],'').trim()||'MÃ¬nh ghi nháº­n:')+'\n\n'+pv,p);return;
        }
      }catch{}
    }

    // Check if tax guidance with specific numbers
    const numMatch=raw.match(/[\d,\.]+\s*Ä‘/g);
    const copyText=yRev>0&&isTaxQ?yRev.toString():null;
    addMsgWithCopy(raw,copyText);
  }catch(err){
    if(ty)ty.classList.remove('on');
    addMsg('âŒ '+err.message,'bot');
  }
}
function askAIInv(){goPage('ai',document.querySelectorAll('.nb')[4]);setTimeout(()=>{const i=document.getElementById('chatInp');if(i){i.value='TÃ¬nh hÃ¬nh kho cá»§a tÃ´i tháº¿ nÃ o?';i.style.height='auto';sendChat()}},200)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLIPBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function clip(text,msg){
  try{
    if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(text);
    else{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px';document.body.appendChild(ta);ta.focus();ta.select();document.execCommand('copy');document.body.removeChild(ta)}
    if(msg)toast(msg);return true;
  }catch{if(msg)toast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);return false}
}
async function doCopy(boxId,btnId){const b=document.getElementById(boxId);if(!b)return;const t=b.textContent.trim();if(!t){toast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return}const ok=await clip(t);if(ok){toast('ğŸ“‹ ÄÃ£ sao chÃ©p!');const btn=document.getElementById(btnId);if(btn){const orig=btn.innerHTML;btn.innerHTML='âœ… ÄÃ£ sao chÃ©p!';btn.disabled=true;setTimeout(()=>{btn.innerHTML=orig;btn.disabled=false},2000)}}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  refreshDates();
  buildMonthSel();
  renderAll();
  renderToday();
  renderHomeRecent();
  doAiSt();
  setTimeout(doHomeChart,120);

  // Date field lock on manual change
  ['sDate','iDate','cpDate','adjDate'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    el.addEventListener('change',()=>{el._locked=true;setTimeout(()=>{el._locked=false},10*60000)});
  });
})();
</script>
</body>
</html>
