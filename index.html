<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.13);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
  --nav-h:60px;
  --ai-bg:#0A1A10;--ai-surface:#0F2016;--ai-card:#132A1A;
  --ai-border:#1A3825;--ai-input-bg:#152219;
  --hm-gold:#FFD700;--hm-glow:rgba(255,215,0,.15);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;overflow:hidden;max-width:100vw}
body{font-family:var(--font);background:var(--surface);color:var(--text);display:flex;flex-direction:column;height:100dvh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}
header{flex-shrink:0;background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:8px 14px 6px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.22);z-index:300}
header h1{font-size:1.1rem;font-weight:800;line-height:1.2}
header p{font-size:.62rem;opacity:.75;margin-top:1px}
.badge{background:var(--a400);color:#1A2E23;font-size:.52rem;font-weight:900;padding:2px 5px;border-radius:20px;margin-left:4px;vertical-align:middle}
#apiBar{flex-shrink:0;background:#FFFDE7;border-bottom:2px solid var(--a400);padding:5px 10px;display:flex;align-items:center;flex-wrap:wrap;gap:5px}
#apiBar label{font-size:.68rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:80px;padding:4px 8px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.78rem}
#apiKeyInput:focus{outline:none;border-color:#D4881A}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:4px 9px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.72rem;white-space:nowrap}
#apiStatus{font-size:.65rem;color:#7A5200;flex-basis:100%;margin-top:-2px}
#monthBar{flex-shrink:0;background:var(--card);border-bottom:2px solid var(--border);padding:5px 10px;display:flex;align-items:center;gap:7px}
#monthBar label{font-size:.68rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:4px 7px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.78rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
.month-badge{font-size:.62rem;background:var(--p50);color:var(--p600);padding:2px 8px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto;white-space:nowrap}
#mainArea{flex:1 1 0;min-height:0;position:relative;overflow:hidden}
.page{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.page.active{display:block}
.page-inner{padding:10px;max-width:600px;margin:0 auto;padding-bottom:16px;width:100%}
/* â”€â”€ AI PAGE (Há»™ Má»‡nh) â”€â”€ */
#page-ai{display:none;position:absolute;inset:0;flex-direction:column;background:var(--ai-bg);overflow:hidden}
#page-ai.active{display:flex}
.ai-topbar{flex-shrink:0;background:var(--ai-surface);border-bottom:2px solid var(--ai-border);padding:8px 14px;display:flex;align-items:center;gap:8px;position:relative}
.ai-topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--hm-gold),transparent);opacity:.5}
.ai-hm-badge{position:absolute;top:6px;right:10px;background:linear-gradient(135deg,#7A5200,var(--hm-gold));color:#1A1A00;font-size:.52rem;font-weight:900;padding:2px 7px;border-radius:20px;letter-spacing:.3px;box-shadow:0 0 8px var(--hm-glow);animation:hmglow 2.5s infinite}
@keyframes hmglow{0%,100%{box-shadow:0 0 6px var(--hm-glow)}50%{box-shadow:0 0 14px rgba(255,215,0,.4)}}
.ai-av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#7A5200,var(--hm-gold));display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;box-shadow:0 0 12px rgba(255,215,0,.3)}
.ai-topbar-text{flex:1;font-size:.72rem;color:#8FB89A;line-height:1.4;padding-right:80px}
.ai-topbar-text strong{color:var(--hm-gold);font-size:.78rem}
.ai-topbar-dot{width:8px;height:8px;border-radius:50%;background:var(--hm-gold);box-shadow:0 0 6px var(--hm-gold);flex-shrink:0;animation:aipulse 2s infinite}
@keyframes aipulse{0%,100%{opacity:1}50%{opacity:.4}}
.chat-msgs{flex:1 1 0;min-height:0;overflow-y:auto;overflow-x:hidden;padding:12px 12px 8px;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.chat-msgs::-webkit-scrollbar{width:3px}.chat-msgs::-webkit-scrollbar-thumb{background:#1E3829;border-radius:10px}
.msg{max-width:90%;padding:11px 14px;border-radius:18px;font-size:.84rem;line-height:1.7;word-break:break-word;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:var(--ai-card);border:1.5px solid var(--ai-border);color:#D4EDD9;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,.2)}
.msg.bot.hm-msg{border-color:rgba(255,215,0,.3);background:linear-gradient(135deg,#132A1A,#0F2416);box-shadow:0 2px 12px rgba(255,215,0,.08)}
.msg.user{background:linear-gradient(135deg,var(--p600),#218C4A);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;box-shadow:0 3px 12px rgba(27,107,58,.35)}
.msg-step{background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.2);border-radius:var(--r-sm);padding:8px 10px;margin-top:8px;font-size:.8rem}
.msg-step-title{font-size:.72rem;font-weight:900;color:var(--hm-gold);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.copy-amt-btn{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#7A5200,var(--hm-gold));color:#1A1A00;border:none;padding:5px 12px;border-radius:20px;font-size:.72rem;font-weight:900;cursor:pointer;margin-top:6px;transition:.15s;font-family:var(--font)}
.copy-amt-btn:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(255,215,0,.4)}
.copy-amt-btn.ok{background:linear-gradient(135deg,#1B6B3A,#27AE60);color:#fff}
.tax-status-pill{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:.74rem;font-weight:900;margin:4px 0;border:1.5px solid}
.tax-safe-pill{background:#0D2E1A;color:#6ABF8A;border-color:#1B6B3A}
.tax-danger-pill{background:#2E0D0D;color:#FF8A80;border-color:var(--red)}
.tax-warn-pill{background:#2E1F00;color:#FFD54F;border-color:var(--a400)}
.typing{align-self:flex-start;display:none}.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:9px 14px;background:var(--ai-card);border:1.5px solid var(--ai-border);border-radius:18px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--hm-gold);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.confirm-pill{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.confirm-pill button{padding:6px 14px;border-radius:20px;font-size:.75rem;font-weight:800;cursor:pointer;border:1.5px solid;transition:.15s;font-family:var(--font)}
.pill-yes{background:var(--p600);color:#fff;border-color:var(--p600)}.pill-yes:hover{background:var(--p700)}
.pill-no{background:transparent;color:#E87A6A;border-color:#E87A6A}
.quick-chips{flex-shrink:0;padding:6px 12px 5px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;border-top:1px solid var(--ai-border);background:var(--ai-surface)}
.quick-chips::-webkit-scrollbar{display:none}
.chip{flex-shrink:0;padding:5px 12px;background:var(--ai-card);border:1px solid var(--ai-border);border-radius:20px;color:#8FB89A;font-size:.7rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:.15s;font-family:var(--font)}
.chip:hover,.chip:active{background:rgba(255,215,0,.12);color:var(--hm-gold);border-color:rgba(255,215,0,.3)}
.chat-foot{flex-shrink:0;padding:8px 10px 10px;background:var(--ai-surface);border-top:1px solid var(--ai-border);display:flex;gap:8px;align-items:flex-end}
.chat-inp{flex:1;min-height:40px;max-height:100px;padding:9px 14px;background:var(--ai-input-bg);border:1.5px solid var(--ai-border);border-radius:22px;color:#E0F0E6;font-size:.85rem;font-family:var(--font);resize:none;line-height:1.45;overflow-y:auto;transition:border-color .2s;outline:none}
.chat-inp::placeholder{color:#2E4A38}.chat-inp:focus{border-color:rgba(255,215,0,.4);box-shadow:0 0 0 3px rgba(255,215,0,.06)}
.chat-send{flex-shrink:0;width:40px;height:40px;background:linear-gradient(135deg,#7A5200,var(--hm-gold));border:none;border-radius:50%;color:#1A1A00;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(255,215,0,.3);transition:.18s;font-weight:900}
.chat-send:hover{transform:scale(1.08)}.chat-send:active{transform:scale(.95)}.chat-send:disabled{opacity:.4;transform:none}
/* â”€â”€ COMMON â”€â”€ */
.bottom-nav{flex-shrink:0;height:var(--nav-h);background:var(--card);border-top:2px solid var(--border);display:flex;z-index:400;box-shadow:0 -3px 16px rgba(0,0,0,.10);width:100%;overflow-x:auto}
.bn-btn{flex:1;min-width:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:4px 2px;border-top:3px solid transparent;transition:.15s;color:var(--muted);font-family:var(--font)}
.bn-btn .ni{font-size:1.1rem;line-height:1}.bn-btn .nl{font-size:.46rem;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.bn-btn.active{color:var(--p600);border-top-color:var(--p600);background:var(--p50)}
.card{background:var(--card);border-radius:var(--r-md);padding:12px;margin-bottom:10px;box-shadow:var(--shadow-sm);border:1px solid var(--border);overflow:hidden;width:100%}
.card-title{font-size:.88rem;font-weight:800;color:var(--p700);margin-bottom:7px;display:flex;align-items:center;gap:5px}
.card-sub{font-size:.68rem;color:var(--muted);margin-top:-4px;margin-bottom:7px;line-height:1.5}
.field{margin-bottom:8px;width:100%}
.field label{font-size:.67rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:8px 10px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-family:var(--font);background:#fff;color:var(--text);transition:.15s;box-sizing:border-box}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
@media(max-width:380px){.row2,.row3{grid-template-columns:1fr}}
.sug-wrap{position:relative}
.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:600;max-height:200px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.sug-dropdown.open{display:block}
.sug-opt{padding:8px 11px;cursor:pointer;font-size:.82rem;border-bottom:1px solid var(--border);transition:.12s}
.sug-opt:last-child{border-bottom:none}.sug-opt:hover,.sug-opt:active{background:var(--p50);color:var(--p600)}
.sug-opt .sug-meta{font-size:.63rem;color:var(--muted);margin-top:1px}
.sug-group{padding:5px 11px 2px;font-size:.6rem;font-weight:900;color:var(--p600);background:var(--p50);text-transform:uppercase;letter-spacing:.5px}
.btn{width:100%;padding:10px;border:none;border-radius:var(--r-md);font-size:.84rem;font-weight:800;cursor:pointer;transition:.18s;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:7px;font-family:var(--font);box-sizing:border-box}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.2)}.btn-primary:hover:not(:disabled){background:var(--p700)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-danger{background:var(--red-bg);color:var(--red);border:2px solid #F5C6C0}.btn-danger:hover:not(:disabled){background:var(--red);color:#fff}
.btn-warn{background:#FFF8E1;color:#7A5200;border:2px solid var(--a400)}.btn-warn:hover:not(:disabled){background:var(--a400);color:#1A2E23}
.btn-sm{padding:5px 10px;font-size:.71rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.4;cursor:not-allowed}
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:16px 10px;text-align:center;cursor:pointer;transition:.18s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100)}
.upload-area .u-icon{font-size:1.7rem;margin-bottom:3px}
.upload-area strong{display:block;font-size:.8rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.66rem}
.img-preview-box{position:relative;margin-bottom:8px;display:none}
.img-preview-box img{width:100%;max-height:160px;object-fit:cover;border-radius:var(--r-sm);border:2px solid var(--p300);display:block}
.img-change-btn{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:20px;padding:3px 8px;font-size:.65rem;font-weight:800;cursor:pointer}
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:10px;margin-top:7px;white-space:pre-wrap;font-size:.78rem;line-height:1.7;max-height:220px;overflow-y:auto;display:none;word-break:break-word}
.result-box.show{display:block}
.loader{display:none;text-align:center;padding:12px}.loader.show{display:block}
.spinner{width:28px;height:28px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 5px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.75rem}
.copy-btn{display:none;align-items:center;gap:5px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:6px 11px;border-radius:var(--r-sm);font-size:.73rem;font-weight:800;cursor:pointer;margin-top:5px;transition:.18s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}.copy-btn.show{display:inline-flex}.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:7px 10px;font-size:.73rem;color:var(--p700);margin-top:5px;display:none}.autofill-notice.show{display:block}
.sub-tabs{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.sub-tab{padding:5px 11px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.71rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}
.today-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:0}
.ts-card{background:rgba(255,255,255,.12);border-radius:var(--r-sm);padding:7px 5px;text-align:center}
.ts-lbl{font-size:.55rem;font-weight:800;opacity:.8;margin-bottom:2px;color:#fff}
.ts-val{font-size:.76rem;font-weight:900;color:#fff;word-break:break-all}
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:8px 5px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.58rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.s-val{font-size:.84rem;font-weight:900;word-break:break-all}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}
.tbl-wrap{overflow-x:auto;overflow-y:auto;border-radius:var(--r-sm);border:1px solid var(--border);max-height:300px;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:.76rem;min-width:320px}
thead{position:sticky;top:0;z-index:5}
thead tr{background:var(--p600)}
th{padding:6px 7px;text-align:left;color:#fff;font-size:.66rem;font-weight:800;white-space:nowrap}
td{padding:6px 7px;border-bottom:1px solid var(--border);vertical-align:middle;word-break:break-word;max-width:140px}
tr:last-child td{border-bottom:none}tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800;white-space:nowrap}
.chi-v{color:var(--red);font-weight:800;white-space:nowrap}
.del-btn{background:none;border:none;cursor:pointer;font-size:.8rem;padding:2px 3px;border-radius:5px;transition:.12s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;font-size:.62rem;font-weight:800;white-space:nowrap}
.tag-sell{background:#D4EDDA;color:var(--p700)}.tag-cook{background:#E0E7FF;color:#3730A3}
.tag-imp{background:#D1ECF1;color:#0C5460}.tag-mat{background:#FFF3CD;color:#856404}
.tag-op{background:#F3E8FF;color:#7C3AED}.tag-adj{background:#FCE4EC;color:#880E4F}
.period-tabs{display:flex;gap:4px;margin-bottom:9px;flex-wrap:wrap}
.period-tab{padding:4px 10px;border:2px solid var(--border);background:#fff;border-radius:20px;font-size:.68rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.period-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}.period-tab:hover:not(.active){background:var(--p50);color:var(--p600)}
.bulk-bar{display:flex;align-items:center;gap:6px;margin-bottom:7px;flex-wrap:wrap}
.bulk-bar input[type=checkbox]{width:13px;height:13px;accent-color:var(--p600);cursor:pointer}
.bulk-bar label{font-size:.72rem;font-weight:800;color:var(--muted);cursor:pointer}
.cb-cell input[type=checkbox]{width:13px;height:13px;accent-color:var(--p600);cursor:pointer}
.inv-section{margin-bottom:10px}
.inv-section-title{font-size:.76rem;font-weight:900;color:var(--p700);margin-bottom:5px;display:flex;align-items:center;gap:4px}
.inv-alert-card{border-radius:var(--r-sm);padding:9px 11px;margin-bottom:5px;display:flex;align-items:flex-start;gap:8px;border:2px solid}
.inv-alert-out{background:var(--red-bg);border-color:var(--red)}
.inv-alert-low{background:#FFF8E1;border-color:var(--a400)}
.inv-alert-ok{background:var(--p50);border-color:var(--p300)}
.inv-alert-slow{background:#EEF2FF;border-color:#7C83FD}
.inv-alert-icon{font-size:1.2rem;flex-shrink:0}
.inv-alert-body{flex:1;min-width:0}
.inv-alert-name{font-size:.84rem;font-weight:800;word-break:break-word}
.inv-alert-meta{font-size:.66rem;color:var(--muted);margin-top:2px;line-height:1.4}
.inv-alert-qty{font-size:.78rem;font-weight:900;white-space:nowrap;padding:3px 8px;border-radius:20px;flex-shrink:0;align-self:center}
.qty-out{background:var(--red-bg);color:var(--red)}.qty-low{background:#FFF3CD;color:#7A5200}.qty-ok{background:var(--p50);color:var(--p600)}
.inv-restock-notice{background:var(--a400);color:#1A2E23;border-radius:var(--r-sm);padding:7px 11px;font-size:.73rem;font-weight:800;margin-bottom:8px}
.inv-ask-btn{width:100%;padding:9px;background:var(--p600);color:#fff;border:none;border-radius:var(--r-md);font-size:.82rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:3px;transition:.18s}
.inv-ask-btn:hover{background:var(--p700)}
.stock-info-box{background:var(--p50);border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:7px 10px;font-size:.76rem;color:var(--p700);margin-bottom:8px;display:none}
.sell-total-box{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:6px 10px;font-size:.78rem;color:var(--p700);font-weight:800;margin-bottom:8px;display:none}
.conv-box{background:#EEF2FF;border:2px solid #7C83FD;border-radius:var(--r-sm);padding:9px 11px;margin-top:7px;font-size:.76rem;line-height:1.6;display:none}
.conv-box.show{display:block}
.invoice-table-wrap{margin-top:8px;overflow-x:auto;display:none}.invoice-table-wrap.show{display:block}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
@media(max-width:440px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:9px;border:1px solid var(--border)}
.ch-card h3{font-size:.7rem;font-weight:800;color:var(--p700);margin-bottom:5px;text-align:center}
.ch-wrap{position:relative;height:130px}.ch-full{position:relative;height:150px}
.history-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
.history-filters input,.history-filters select{padding:5px 8px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.75rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:90px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.hist-row-clickable{cursor:pointer;transition:.12s}.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);border:1px solid var(--p100);border-radius:6px;font-size:.58rem;padding:1px 4px;font-weight:800}
.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);padding:11px;margin-bottom:10px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.82rem;font-weight:800;color:var(--p700);margin-bottom:7px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:7px 4px;border:1px solid var(--border)}
.cmp-lbl{font-size:.58rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmp-cur{font-size:.78rem;font-weight:900;color:var(--p700)}.cmp-prev{font-size:.64rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.64rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}
.tax-box{border-radius:var(--r-md);padding:13px;margin-bottom:10px;border:3px solid}
.tax-safe{background:#E8F5E9;border-color:#4CAF50}
.tax-warn{background:#FFF8E1;border-color:var(--a400)}
.tax-danger{background:var(--red-bg);border-color:var(--red)}
.tx-icon{font-size:1.6rem;margin-bottom:4px;display:block;text-align:center}
.tx-msg{font-size:1rem;font-weight:800;line-height:1.4;text-align:center;margin-bottom:6px}
.tax-safe .tx-msg{color:#2E7D32}.tax-warn .tx-msg{color:#7A5200}.tax-danger .tx-msg{color:var(--red)}
.tx-detail{font-size:.77rem;color:var(--muted);line-height:1.7;background:rgba(255,255,255,.6);border-radius:var(--r-sm);padding:7px 9px;margin-top:4px}
.tx-detail strong{color:var(--text)}
.tax-amount{font-size:1.3rem;font-weight:900;color:var(--red);text-align:center;display:block;margin:4px 0}
.progress-wrap{margin:10px 0;background:var(--border);border-radius:20px;overflow:hidden;height:18px}
.progress-bar{height:100%;border-radius:20px;transition:width .5s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.64rem;font-weight:900;color:#fff}
.progress-bar.safe{background:linear-gradient(90deg,var(--p600),#27AE60)}
.progress-bar.warn{background:linear-gradient(90deg,var(--a400),#E67E00)}
.progress-bar.danger{background:linear-gradient(90deg,var(--red),#B71C1C)}
.s1a-tbl{width:100%;border-collapse:collapse;font-size:.72rem;min-width:480px}
.s1a-tbl th{background:var(--p700);color:#fff;padding:5px 6px;font-size:.63rem;font-weight:800;text-align:center;white-space:nowrap;border:1px solid var(--border-strong)}
.s1a-tbl td{padding:5px 6px;border:1px solid var(--border);vertical-align:middle;word-break:break-word}
.s1a-tbl tr:nth-child(even) td{background:var(--p50)}
.s1a-rate1{color:#1B5E20;font-weight:800}.s1a-rate3{color:#7A5200;font-weight:800}
.inv-filter-bar{display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap;align-items:center}
.inv-filter-bar input,.inv-filter-bar select{padding:5px 8px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.75rem;background:#fff;font-family:var(--font);flex:1;min-width:80px}
.cook-item{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:7px}
.cook-body{flex:1;min-width:0}.cook-name{font-size:.82rem;font-weight:800;color:var(--p700);word-break:break-word}
.cook-meta{font-size:.67rem;color:var(--muted);margin-top:1px}
.cook-price{font-size:.85rem;font-weight:900;color:var(--p600);white-space:nowrap}
.cook-del{background:none;border:none;cursor:pointer;font-size:.8rem;color:var(--subtle);padding:2px 3px;border-radius:5px;transition:.12s}
.cook-del:hover{background:var(--red-bg);color:var(--red)}
.inv-preview-wrap{display:none;margin-top:8px}.inv-preview-wrap.show{display:block}
.inv-preview-title{font-size:.74rem;font-weight:800;color:var(--p700);margin-bottom:6px}
.inv-preview-item{display:flex;align-items:center;gap:6px;padding:7px 9px;background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);margin-bottom:5px;transition:.2s}
.inv-preview-item.remove{opacity:.4;background:#fff;border-style:dashed}
.inv-preview-idx{font-size:.65rem;font-weight:900;color:var(--muted);flex-shrink:0;min-width:16px}
.inv-preview-name{flex:1;font-size:.8rem;font-weight:800;color:var(--p700);word-break:break-word}
.inv-preview-meta{font-size:.68rem;color:var(--muted);white-space:nowrap}
.inv-preview-del{background:none;border:none;cursor:pointer;font-size:.9rem;padding:2px 4px;border-radius:5px;flex-shrink:0}
.inv-preview-footer{display:flex;justify-content:space-between;font-size:.72rem;font-weight:800;color:var(--p700);padding:6px 2px}
.empty{text-align:center;color:var(--muted);padding:18px 10px;font-size:.78rem}
.empty .ei{font-size:1.7rem;margin-bottom:4px}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:flex-end;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg) var(--r-lg) 0 0;padding:15px;width:100%;max-width:500px;box-shadow:var(--shadow-md);max-height:85vh;overflow-y:auto}
.modal h3{font-size:.9rem;font-weight:800;color:var(--p700);margin-bottom:8px}
.modal-btns{display:flex;gap:7px;margin-top:10px}
.modal-btns button{flex:1;padding:9px;border-radius:var(--r-sm);font-weight:800;font-size:.8rem;cursor:pointer;border:none;transition:.15s;font-family:var(--font)}
.modal-cancel{background:var(--surface);color:var(--muted);border:2px solid var(--border)!important}
.modal-confirm{background:var(--red);color:#fff}
.stock-alert-modal{border:3px solid var(--red)}.stock-alert-modal h3{color:var(--red)}
.stock-alert-msg{font-size:.96rem;font-weight:700;color:var(--red);line-height:1.5;padding:8px 0;text-align:center}
#toast{position:fixed;bottom:72px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--p700);color:#fff;padding:9px 18px;border-radius:30px;font-size:.83rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1),opacity .28s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);opacity:0;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--red)}#toast.ok{background:#27AE60}
</style>
</head>
<body>
<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Quáº£n lÃ½ kinh doanh thÃ´ng minh Â· Táº¡p hÃ³a / QuÃ¡n Äƒn</p>
</header>
<div id="apiBar">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key API táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <span id="apiStatus"></span>
</div>
<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ Hiá»‡n táº¡i</span>
</div>
<div id="mainArea">

<!-- Tá»”NG QUAN -->
<div id="page-home" class="page active">
<div class="page-inner">
  <div class="card" style="background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:10px 14px 10px">
    <div style="font-size:.65rem;opacity:.75;margin-bottom:6px">ğŸ“… HÃ´m nay â€” <span id="homeTodayLabel"></span></div>
    <div class="today-strip">
      <div class="ts-card"><div class="ts-lbl">ğŸ“ˆ Thu hÃ´m nay</div><div class="ts-val" id="todayThu">0Ä‘</div></div>
      <div class="ts-card" style="background:rgba(217,79,61,.3)"><div class="ts-lbl">ğŸ“‰ Chi hÃ´m nay</div><div class="ts-val" id="todayChi">0Ä‘</div></div>
      <div class="ts-card" style="background:rgba(255,255,255,.18)"><div class="ts-lbl">ğŸ’¼ LÃ£i hÃ´m nay</div><div class="ts-val" id="todayProfit">0Ä‘</div></div>
    </div>
  </div>
  <div class="sum-strip" style="margin-top:8px">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ ThÃ¡ng thu</div><div class="s-val" id="h-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ ThÃ¡ng chi</div><div class="s-val" id="h-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ ThÃ¡ng lÃ£i</div><div class="s-val" id="h-profit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y</div>
    <div class="ch-full"><canvas id="homeLineChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div>
    <div id="homeRecentWrap"></div>
  </div>
</div>
</div>

<!-- THU / CHI -->
<div id="page-money" class="page">
<div class="page-inner">
  <div class="card" style="background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:8px 12px 8px;margin-bottom:8px">
    <div style="font-size:.6rem;opacity:.75;margin-bottom:4px">ğŸ“… HÃ´m nay</div>
    <div class="today-strip">
      <div class="ts-card"><div class="ts-lbl">ğŸ“ˆ Thu</div><div class="ts-val" id="m-todayThu">0Ä‘</div></div>
      <div class="ts-card" style="background:rgba(217,79,61,.3)"><div class="ts-lbl">ğŸ“‰ Chi</div><div class="ts-val" id="m-todayChi">0Ä‘</div></div>
      <div class="ts-card" style="background:rgba(255,255,255,.18)"><div class="ts-lbl">ğŸ’¼ LÃ£i</div><div class="ts-val" id="m-todayProfit">0Ä‘</div></div>
    </div>
  </div>
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="m-thu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng chi</div><div class="s-val" id="m-chi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="m-profit">0Ä‘</div></div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('ban',this)">ğŸ’° BÃ¡n hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('nhap',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('chiphi',this)">âš¡ Chi phÃ­</button>
    <button class="sub-tab" onclick="switchSub('kho',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="sub-tab" onclick="switchSub('chebien',this)">ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n</button>
  </div>
  <div id="msub-ban">
    <div class="card">
      <div class="card-title">ğŸ“· QuÃ©t bill thanh toÃ¡n</div>
      <div class="upload-area" onclick="document.getElementById('incInvoiceFile').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p bill Ä‘Ã£ thanh toÃ¡n</strong><small>AI Ä‘á»c & tÃ¡ch tá»«ng mÃ³n riÃªng</small>
      </div>
      <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
      <div class="img-preview-box" id="incImgBox"><img id="incInvoicePreview"/><button class="img-change-btn" onclick="resetIncImg()">âœï¸ Äá»•i áº£nh</button></div>
      <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:7px">ğŸ¤– AI Ä‘á»c bill</button>
      <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c & tÃ¡ch tá»«ng mÃ³n...</p></div>
      <div class="autofill-notice" id="incAutofillNotice">âœ… AI Ä‘Ã£ tÃ¡ch â€” kiá»ƒm tra rá»“i báº¥m "XÃ¡c nháº­n lÆ°u"</div>
      <div class="inv-preview-wrap" id="incPreviewWrap">
        <div class="inv-preview-title">ğŸ‘ï¸ Xem trÆ°á»›c â€” ğŸ—‘ï¸ Ä‘á»ƒ bá» mÃ³n</div>
        <div id="incPreviewList"></div>
        <div class="inv-preview-footer"><span id="incPreviewCount"></span><span id="incPreviewTotal"></span></div>
        <button class="btn btn-primary" style="margin-top:9px" onclick="confirmIncItems()">âœ… XÃ¡c nháº­n lÆ°u táº¥t cáº£</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="card-sub">Hiá»ƒn thá»‹ hÃ ng trong kho vÃ  sáº£n pháº©m cháº¿ biáº¿n</div>
      <div class="field"><label>ğŸ›’ Chá»n sáº£n pháº©m bÃ¡n</label>
        <div class="sug-wrap">
          <input class="inp" id="sellName" placeholder="GÃµ tÃªn sáº£n pháº©m..." autocomplete="off"
            oninput="onSellSug(this.value)" onfocus="onSellSug(this.value)" onblur="setTimeout(closeSellSug,250)"/>
          <div class="sug-dropdown" id="sellDrop"></div>
        </div>
      </div>
      <div class="stock-info-box" id="stockInfoBox"></div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="sellDesc" placeholder="Ghi chÃº thÃªm..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="sellQty" placeholder="0" oninput="handleMoney(this);calcSellTotal()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’µ ÄÆ¡n giÃ¡ bÃ¡n</label><input class="inp" type="text" id="sellPrice" placeholder="0Ä‘" oninput="handleMoney(this);calcSellTotal()" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="sell-total-box" id="sellTotalBox"></div>
      <div class="field"><label>ğŸ“… NgÃ y bÃ¡n</label><input class="inp" type="datetime-local" id="sellDate"/></div>
      <button class="btn btn-primary" onclick="addSale()">âœ… XÃ¡c nháº­n bÃ¡n</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('ban','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('ban','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('ban','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('ban','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="banSelectAll" onchange="toggleSelectAll('ban',this.checked)">
        <label for="banSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('ban')" id="banBulkBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('ban')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="banTableWrap"></div>
    </div>
  </div>
  <div id="msub-nhap" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="upload-area" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p hÃ³a Ä‘Æ¡n nhÃ  cung cáº¥p</strong><small>AI trÃ­ch xuáº¥t danh sÃ¡ch hÃ ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <div class="img-preview-box" id="expImgBox"><img id="invoicePreview"/><button class="img-change-btn" onclick="resetExpImg()">âœï¸ Äá»•i áº£nh</button></div>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:7px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="inv-preview-wrap" id="expPreviewWrap">
        <div class="inv-preview-title">ğŸ‘ï¸ Danh sÃ¡ch â€” ğŸ—‘ï¸ Ä‘á»ƒ bá» dÃ²ng</div>
        <div id="expPreviewList"></div>
        <div class="inv-preview-footer"><span id="expPreviewCount"></span><span id="expPreviewTotal"></span></div>
        <div style="display:flex;gap:6px;margin-top:7px;flex-wrap:wrap">
          <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ Xuáº¥t CSV</button>
          <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Äiá»n vÃ o form</button>
        </div>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… ÄÃ£ Ä‘iá»n â€” kiá»ƒm tra rá»“i báº¥m "Nháº­p hÃ ng"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng vÃ o kho</div>
      <div class="card-sub">Chá»n loáº¡i Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ³ vÃ o tá»“n kho hay khÃ´ng</div>
      <div class="row2">
        <div class="field"><label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onImpSug(this.value)" onfocus="onImpSug(this.value)" onblur="setTimeout(closeImpSug,250)"/>
            <div class="sug-dropdown" id="impDrop"></div>
          </div>
        </div>
        <div class="field"><label>ğŸ“‚ Loáº¡i hÃ ng</label>
          <select class="inp" id="impType" onchange="toggleImpMode()">
            <option value="hangban">ğŸ›’ HÃ ng bÃ¡n láº¡i (vÃ o kho)</option>
            <option value="nguyenlieu">ğŸ§‚ NguyÃªn liá»‡u (khÃ´ng vÃ o kho)</option>
          </select>
        </div>
      </div>
      <div id="convFields">
        <div class="row3">
          <div class="field"><label>ğŸ“¦ ÄÆ¡n vá»‹ nháº­p</label><input class="inp" type="text" id="impUnitIn" placeholder="thÃ¹ng, kg..."/></div>
          <div class="field"><label>ğŸ·ï¸ ÄÆ¡n vá»‹ bÃ¡n</label><input class="inp" type="text" id="impUnitOut" placeholder="gÃ³i, chai..."/></div>
          <div class="field"><label>ğŸ”¢ Há»‡ sá»‘ (1 nháº­p=?bÃ¡n)</label><input class="inp" type="text" id="impFactor" placeholder="1" oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        </div>
        <div class="conv-box" id="convPreview"></div>
      </div>
      <div class="row2">
        <div class="field"><label>ğŸ“¥ Sá»‘ lÆ°á»£ng nháº­p</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this);showConvPreview()" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° Tá»•ng tiá»n lÃ´</label><input class="inp" type="text" id="impAmt" placeholder="0Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="datetime-local" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()">â• Nháº­p hÃ ng</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ nháº­p hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('nhap','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('nhap','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('nhap','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('nhap','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="nhapSelectAll" onchange="toggleSelectAll('nhap',this.checked)">
        <label for="nhapSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('nhap')" id="nhapBulkBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('nhap')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="nhapTableWrap"></div>
    </div>
  </div>
  <div id="msub-chiphi" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, thuÃª máº·t báº±ng...</div>
      <div class="field"><label>ğŸ“‚ Loáº¡i chi phÃ­</label>
        <select class="inp" id="cpType">
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="cpDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="cpAmt" placeholder="0Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="cpDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addCost()">â• ThÃªm chi phÃ­</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ Lá»‹ch sá»­ chi phÃ­</div><div id="cpTableWrap"></div></div>
  </div>
  <div id="msub-kho" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ—„ï¸ Tá»“n kho thÃ´ng minh</div>
      <div class="card-sub">CÃ¹ng tÃªn + khÃ¡c Ä‘Æ¡n vá»‹ bÃ¡n = sáº£n pháº©m riÃªng biá»‡t</div>
      <div class="inv-filter-bar">
        <input type="text" id="invSearch" placeholder="ğŸ” TÃ¬m sáº£n pháº©m..." oninput="renderInventory()"/>
        <select id="invStatus" onchange="renderInventory()">
          <option value="">Táº¥t cáº£ tráº¡ng thÃ¡i</option>
          <option value="out">ğŸ”´ Háº¿t hÃ ng</option>
          <option value="low">ğŸŸ¡ Sáº¯p háº¿t</option>
          <option value="ok">ğŸŸ¢ Äá»§ hÃ ng</option>
          <option value="slow">ğŸ”µ BÃ¡n cháº­m</option>
        </select>
      </div>
      <div id="inventoryView"></div>
      <div style="display:flex;gap:7px;margin-top:8px;flex-wrap:wrap">
        <button class="btn btn-warn" style="flex:1" onclick="openAdjModal()">âš™ï¸ Äiá»u chá»‰nh / Hao há»¥t</button>
        <button class="inv-ask-btn" style="flex:1;margin-top:0" onclick="askAIInventory()">ğŸ¤– Há»i trá»£ lÃ½</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ Ä‘iá»u chá»‰nh kho</div>
      <div class="card-sub">Chá»‰ trá»« kho â€” khÃ´ng táº¡o khoáº£n chi</div>
      <div id="adjHistWrap"></div>
    </div>
  </div>
  <div id="msub-chebien" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ‘¨â€ğŸ³ Sáº£n pháº©m cháº¿ biáº¿n</div>
      <div class="card-sub">Phá»Ÿ, cÆ¡m, nÆ°á»›c Ã©p... â€” chá»‰ ghi doanh thu, khÃ´ng trá»« kho</div>
      <div class="row2">
        <div class="field"><label>ğŸ“ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="cbName" placeholder="VD: Phá»Ÿ bÃ²..."/></div>
        <div class="field"><label>ğŸ’µ GiÃ¡ bÃ¡n máº·c Ä‘á»‹nh</label><input class="inp" type="text" id="cbPrice" placeholder="0Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <button class="btn btn-primary" onclick="addCookProduct()">â• ThÃªm sáº£n pháº©m</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ Danh sÃ¡ch</div><div id="cookList"></div></div>
  </div>
</div>
</div>

<!-- QUáº¢NG BÃ -->
<div id="page-promo" class="page">
<div class="page-inner">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchPromoSub('fb',this)">ğŸ“£ Facebook</button>
    <button class="sub-tab" onclick="switchPromoSub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="psub-fb">
    <div class="card">
      <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook</div>
      <div class="upload-area" onclick="document.getElementById('fbImgInput').click()">
        <div class="u-icon">ğŸ–¼ï¸</div><strong>Chá»n áº£nh sáº£n pháº©m</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i</small>
      </div>
      <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
      <div class="img-preview-box" id="fbImgBox"><img id="fbPreview"/><button class="img-change-btn" onclick="resetFbImg()">âœï¸ Äá»•i áº£nh</button></div>
    </div>
    <button class="btn btn-primary" onclick="genFbPost()" id="fbBtn" disabled>ğŸ¤– AI viáº¿t bÃ i</button>
    <div class="card" id="fbResultCard" style="display:none">
      <div class="card-title">âœï¸ BÃ i Ä‘Äƒng</div>
      <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t...</p></div>
      <div class="result-box" id="fbPost"></div>
      <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
  <div id="psub-tt" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="genScript()">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n quay</button>
    <div class="card" id="ttResultCard" style="display:none">
      <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n quay</div>
      <div class="loader" id="ttLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="result-box" id="ttScript"></div>
      <button class="copy-btn" id="copyScript" onclick="doCopy('ttScript','copyScript')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- BÃO CÃO -->
<div id="page-reports" class="page">
<div class="page-inner">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchReportSub('chart',this)">ğŸ“Š Biá»ƒu Ä‘á»“</button>
    <button class="sub-tab" onclick="switchReportSub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="sub-tab" onclick="switchReportSub('tax',this)">ğŸ§¾ Thuáº¿ 2026</button>
    <button class="sub-tab" onclick="switchReportSub('s1a',this)">ğŸ“’ Sá»• S1A</button>
  </div>
  <div id="rsub-chart">
    <div class="period-tabs">
      <button class="period-tab active" onclick="setChartPeriod('week',this)">7 ngÃ y</button>
      <button class="period-tab" onclick="setChartPeriod('month',this)">ThÃ¡ng</button>
      <button class="period-tab" onclick="setChartPeriod('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o <span id="chartLabel" style="font-weight:400;font-size:.74rem;color:var(--muted)"></span></div>
      <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="charts-grid">
          <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
          <div class="ch-card"><h3>ğŸ“¦ Top nháº­p</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        </div>
        <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rsub-compare" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“ˆ So sÃ¡nh thÃ¡ng</div>
      <div class="row2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-primary" onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="compare-box" id="compareBox"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£ thá»i gian</div>
      <div id="allTimeCompare"></div>
      <button class="btn btn-secondary" style="margin-top:7px" onclick="buildAllTimeCompare()">ğŸ”„ Cáº­p nháº­t</button>
    </div>
  </div>
  <div id="rsub-tax" style="display:none">
    <div class="card"><div class="card-title">ğŸ§¾ Thanh tiáº¿n trÃ¬nh doanh thu</div><div id="taxProgressWrap"></div></div>
    <div id="taxBox"></div>
    <div class="card"><div class="card-sub" style="font-size:.72rem;color:var(--muted);line-height:1.7;margin:0">
      <strong>ğŸ“Œ Quy Ä‘á»‹nh 01/01/2026:</strong><br>
      â€¢ DT â‰¤ 500 triá»‡u/nÄƒm â†’ <strong>Miá»…n thuáº¿ TNCN & GTGT</strong><br>
      â€¢ DT &gt; 500 triá»‡u â†’ GTGT theo tá»· lá»‡ + TNCN = (DT - 500tr) Ã— 0.5%<br>
      â€¢ HÃ ng bÃ¡n láº»: 1% Â· Ä‚n uá»‘ng: 3% Â· SX/Váº­n táº£i: 2% Â· Dá»‹ch vá»¥: 5%
    </div></div>
    <button class="btn btn-secondary" onclick="renderTax()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
  <div id="rsub-s1a" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“’ Sá»• SÃ¡ch S1A-HKD (TT 152/2025)</div>
      <div class="history-filters" style="margin-bottom:8px">
        <select class="inp" id="s1aMonth" onchange="renderS1A()" style="flex:none;width:auto"></select>
        <button class="btn btn-secondary btn-sm" onclick="exportS1ACSV()">ğŸ“¥ CSV</button>
      </div>
      <div style="overflow-x:auto"><div id="s1aTableWrap"></div></div>
    </div>
  </div>
</div>
</div>

<!-- AI â€” CHáº¾ Äá»˜ Há»˜ Má»†NH -->
<div id="page-ai" class="page">
  <div class="ai-topbar">
    <div class="ai-av">ğŸ›¡ï¸</div>
    <div class="ai-topbar-text">
      <strong>NgÆ°á»i Há»™ Má»‡nh Tiá»ƒu ThÆ°Æ¡ng</strong><br>
      <span id="aiInvSummary" style="font-size:.65rem">Äang táº£i dá»¯ liá»‡u...</span>
    </div>
    <div class="ai-hm-badge">ğŸ›¡ï¸ Há»™ Má»‡nh</div>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="msg bot hm-msg">ğŸ™ ChÃ o bÃ /cÃ´/chÃº! Con lÃ  <strong>NgÆ°á»i Há»™ Má»‡nh</strong> cá»§a tiá»‡m mÃ¬nh.<br><br>Con cÃ³ thá»ƒ giÃºp:<br>â€¢ ğŸ§¾ Kiá»ƒm tra <strong>tÃ¬nh tráº¡ng thuáº¿</strong> theo sá»‘ liá»‡u thá»±c<br>â€¢ ğŸ“ HÆ°á»›ng dáº«n <strong>Ä‘iá»n tá» khai thuáº¿</strong> tá»«ng bÆ°á»›c<br>â€¢ ğŸ“¦ Ghi <strong>bÃ¡n / nháº­p hÃ ng</strong> ngay trong chat<br>â€¢ ğŸ—„ï¸ Tra <strong>tá»“n kho</strong> vÃ  sá»‘ liá»‡u kinh doanh</div>
    <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
  </div>
  <div class="quick-chips">
    <button class="chip" onclick="useChip(this)">ğŸ§¾ TÃ´i cÃ³ pháº£i ná»™p thuáº¿ khÃ´ng?</button>
    <button class="chip" onclick="useChip(this)">ğŸ“ HÆ°á»›ng dáº«n Ä‘iá»n tá» khai thuáº¿</button>
    <button class="chip" onclick="useChip(this)">ğŸ’° Doanh thu nÄƒm nay bao nhiÃªu?</button>
    <button class="chip" onclick="useChip(this)">ğŸ“¦ Kho cÃ²n gÃ¬?</button>
    <button class="chip" onclick="useChip(this)">ğŸ›’ BÃ¡n 5 gÃ³i mÃ¬ 15k</button>
    <button class="chip" onclick="useChip(this)">ğŸ“Š LÃ£i thÃ¡ng nÃ y</button>
  </div>
  <div class="chat-foot">
    <textarea class="chat-inp" id="chatInp" placeholder="Há»i vá» thuáº¿, bÃ¡n hÃ ng, tá»“n kho..." rows="1"
      oninput="autoResizeChat(this)"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
    <button class="chat-send" id="chatSendBtn" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- Lá»ŠCH Sá»¬ -->
<div id="page-history" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng thu</div><div class="s-val" id="hAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng chi</div><div class="s-val" id="hAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="hAllProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m tÃªn..." oninput="renderHistory()"/>
      <input type="date" id="histDateFrom" onchange="renderHistory()" title="Tá»« ngÃ y"/>
      <input type="date" id="histDateTo" onchange="renderHistory()" title="Äáº¿n ngÃ y"/>
    </div>
    <div class="history-filters">
      <select id="histType" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="ban">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="nhap">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="chiphi">âš¡ Chi phÃ­</option>
        <option value="dieuchinhtk">âš™ï¸ Äiá»u chá»‰nh kho</option>
      </select>
      <select id="histMonth" onchange="renderHistory()"><option value="">Táº¥t cáº£ thÃ¡ng</option></select>
      <button class="btn btn-secondary btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>
</div>

</div><!-- end mainArea -->

<nav class="bottom-nav">
  <button class="bn-btn active" onclick="switchPage('home',this)"><span class="ni">ğŸ </span><span class="nl">Tá»•ng quan</span></button>
  <button class="bn-btn" onclick="switchPage('money',this)"><span class="ni">ğŸ’°</span><span class="nl">Thu/Chi</span></button>
  <button class="bn-btn" onclick="switchPage('promo',this)"><span class="ni">ğŸ“£</span><span class="nl">Quáº£ng bÃ¡</span></button>
  <button class="bn-btn" onclick="switchPage('reports',this)"><span class="ni">ğŸ“Š</span><span class="nl">BÃ¡o cÃ¡o</span></button>
  <button class="bn-btn" onclick="switchPage('ai',this)"><span class="ni">ğŸ›¡ï¸</span><span class="nl">Há»™ Má»‡nh</span></button>
  <button class="bn-btn" onclick="switchPage('history',this)"><span class="ni">ğŸ“š</span><span class="nl">Lá»‹ch sá»­</span></button>
</nav>

<!-- CONFIRM -->
<div class="overlay" id="confirmOverlay">
  <div class="modal">
    <h3 id="confirmTitle">XÃ¡c nháº­n</h3>
    <p id="confirmMsg" style="font-size:.8rem;color:var(--muted);line-height:1.5"></p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeConfirm()">Huá»·</button>
      <button class="modal-confirm" id="confirmOkBtn">XÃ¡c nháº­n</button>
    </div>
  </div>
</div>
<!-- STOCK ALERT -->
<div class="overlay" id="stockAlertOverlay">
  <div class="modal stock-alert-modal">
    <h3>âš ï¸ Tá»“n kho khÃ´ng Ä‘á»§!</h3>
    <div class="stock-alert-msg" id="stockAlertMsg"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeStockAlert()">Huá»· bá»</button>
      <button style="flex:1;padding:9px;border-radius:var(--r-sm);font-weight:800;font-size:.8rem;cursor:pointer;background:var(--a400);color:#1A2E23;border:none" onclick="forceConfirmSale()">Váº«n ghi nháº­n</button>
    </div>
  </div>
</div>
<!-- ADJUSTMENT -->
<div class="overlay" id="adjOverlay">
  <div class="modal">
    <h3>âš™ï¸ Äiá»u chá»‰nh tá»“n kho / Hao há»¥t</h3>
    <div class="card-sub" style="color:#7A5200;background:#FFF8E1;border-radius:var(--r-sm);padding:7px 10px;margin-bottom:10px;border:1.5px solid var(--a400)">
      âš ï¸ Chá»‰ <strong>trá»« tá»“n kho</strong> â€” KHÃ”NG táº¡o khoáº£n chi (chi Ä‘Ã£ ghi lÃºc nháº­p)
    </div>
    <div class="field"><label>ğŸ“¦ Chá»n sáº£n pháº©m (hÃ ng bÃ¡n láº¡i)</label>
      <select class="inp" id="adjProduct"></select>
    </div>
    <div class="row2">
      <div class="field"><label>ğŸ”¢ Sá»‘ lÆ°á»£ng giáº£m</label><input class="inp" type="text" id="adjQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="datetime-local" id="adjDate"/></div>
    </div>
    <div class="field"><label>ğŸ“‹ LÃ½ do</label>
      <select class="inp" id="adjReason">
        <option value="huhong">ğŸ”´ HÆ° há»ng</option>
        <option value="hethan">â° Háº¿t háº¡n sá»­ dá»¥ng</option>
        <option value="thatThoat">ğŸ•µï¸ Tháº¥t thoÃ¡t</option>
        <option value="kiemke">ğŸ“‹ Kiá»ƒm kÃª láº¡i</option>
        <option value="khac">ğŸ“Œ KhÃ¡c</option>
      </select>
    </div>
    <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="adjNote" placeholder="Tuá»³ chá»n..."/></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeAdjModal()">Huá»·</button>
      <button style="flex:1;padding:9px;border-radius:var(--r-sm);font-weight:800;font-size:.8rem;cursor:pointer;background:var(--a400);color:#1A2E23;border:none" onclick="confirmAdj()">âš™ï¸ XÃ¡c nháº­n Ä‘iá»u chá»‰nh</button>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent';
const TAX_THRESHOLD = 500_000_000;   // 500 triá»‡u VNÄ/nÄƒm
const TAX_TNCN_RATE = 0.005;         // (DT - 500tr) Ã— 0.5%
const LOW_STOCK = 5;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IN-MEMORY STORAGE (no localStorage - data lives in session)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MEM = {};
const LS = {
  get: k => { try { return MEM[k] ? JSON.parse(MEM[k]) : null } catch { return null } },
  set: (k, v) => { MEM[k] = JSON.stringify(v) },
  keys: () => Object.keys(MEM)
};

let apiKey = '';
let curMonth = new Date().toISOString().slice(0, 7);

// â”€â”€ Data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function finKey(mk) { return 'finance-' + mk }
function emptyFin() { return { sales:[], imports:[], costs:[], adjustments:[] } }
function loadFin(mk) {
  const d = LS.get(finKey(mk));
  if (!d) return emptyFin();
  return { sales:d.sales||[], imports:d.imports||[], costs:d.costs||[], adjustments:d.adjustments||[] };
}
function saveFin(mk, d) { LS.set(finKey(mk), d) }
let FIN = loadFin(curMonth);
function persist() { saveFin(curMonth, FIN) }

function loadProducts() { return LS.get('tt40_products') || [] }
function saveProducts(a) { LS.set('tt40_products', a) }
function upsertProduct(p) {
  // KEY = name + '|' + unitOut  â€” cÃ¹ng tÃªn khÃ¡c Ä‘Æ¡n vá»‹ = riÃªng biá»‡t
  const key = (p.name || '') + '|' + (p.unitOut || '');
  const a = loadProducts();
  const i = a.findIndex(x => (x.name+'|'+x.unitOut) === key);
  if (i >= 0) Object.assign(a[i], p); else a.push(p);
  saveProducts(a);
}
function loadCookItems() { return LS.get('tt40_cook') || [] }
function saveCookItems(a) { LS.set('tt40_cook', a) }

function allMonthKeys() {
  const s = new Set([curMonth]);
  LS.keys().filter(k => /^finance-\d{4}-\d{2}$/.test(k)).forEach(k => s.add(k.replace('finance-','')));
  return [...s].sort();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY â€” KEY = name + '|' + unitOut
//  CÃ¹ng tÃªn + khÃ¡c Ä‘Æ¡n vá»‹ bÃ¡n = 2 sáº£n pháº©m riÃªng biá»‡t
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function invKey(name, unitOut) { return (name||'') + '|' + (unitOut||'') }

function computeInventory() {
  const map = {}; // key = invKey(name, unitOut)

  allMonthKeys().forEach(mk => {
    const fin = loadFin(mk);

    // Nháº­p hÃ ng bÃ¡n láº¡i â†’ cá»™ng kho
    fin.imports.forEach(imp => {
      if (imp.kind !== 'hangban') return;
      const uOut = imp.unitOut || imp.unitIn || '';
      const k = invKey(imp.name, uOut);
      if (!map[k]) map[k] = {
        name: imp.name, unitIn: imp.unitIn||'', unitOut: uOut,
        factor: imp.factor||1, stockUnits: 0, totalImported: 0,
        totalSold: 0, lastPrice: 0, lastInDate: ''
      };
      const added = imp.stockAdded || (imp.qtyIn * (imp.factor||1));
      map[k].stockUnits += added;
      map[k].totalImported += added;
      if (imp.totalAmt > 0 && imp.qtyIn > 0)
        map[k].lastPrice = Math.round(imp.totalAmt / (imp.qtyIn * (imp.factor||1)));
      if (!map[k].lastInDate || imp.date > map[k].lastInDate)
        map[k].lastInDate = imp.date;
      map[k].unitIn = imp.unitIn || map[k].unitIn;
      map[k].factor = imp.factor || map[k].factor;
    });

    // BÃ¡n hÃ ng tá»“n kho â†’ trá»« kho (match theo name + unitOut)
    fin.sales.forEach(s => {
      if (s.type !== 'hangban') return;
      const uOut = s.unitOut || '';
      const k = invKey(s.name, uOut);
      // Thá»­ match chÃ­nh xÃ¡c trÆ°á»›c, náº¿u khÃ´ng cÃ³ thÃ¬ tÃ¬m báº¥t ká»³ cÃ¹ng tÃªn
      if (map[k]) {
        map[k].stockUnits = Math.max(0, map[k].stockUnits - s.qty);
        map[k].totalSold += s.qty;
      } else {
        // Fallback: tÃ¬m key nÃ o cÃ³ cÃ¹ng tÃªn
        const fallbackKey = Object.keys(map).find(kk => map[kk].name === s.name);
        if (fallbackKey) {
          map[fallbackKey].stockUnits = Math.max(0, map[fallbackKey].stockUnits - s.qty);
          map[fallbackKey].totalSold += s.qty;
        }
      }
    });

    // Äiá»u chá»‰nh kho â†’ trá»« kho, KHÃ”NG táº¡o chi
    (fin.adjustments||[]).forEach(adj => {
      const k = invKey(adj.name, adj.unitOut||'');
      if (map[k]) {
        map[k].stockUnits = Math.max(0, map[k].stockUnits - adj.qty);
      } else {
        // fallback by name
        const fbk = Object.keys(map).find(kk => map[kk].name === adj.name);
        if (fbk) map[fbk].stockUnits = Math.max(0, map[fbk].stockUnits - adj.qty);
      }
    });
  });
  return Object.values(map);
}

function getStock(name, unitOut) {
  const inv = computeInventory();
  // Æ¯u tiÃªn match chÃ­nh xÃ¡c name + unitOut
  let it = inv.find(x => x.name === name && (x.unitOut === unitOut || !unitOut));
  if (!it) it = inv.find(x => x.name === name);
  return it ? { stock: it.stockUnits, unitOut: it.unitOut } : { stock: 0, unitOut: unitOut||'' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINANCIAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRevenue(mk) { return loadFin(mk).sales.reduce((s,x)=>s+x.totalAmt,0) }
function getCost(mk) {
  const f = loadFin(mk);
  return f.imports.reduce((s,x)=>s+x.totalAmt,0) + f.costs.reduce((s,x)=>s+x.amount,0);
}
function getTodayThu() {
  const tod = todayISO();
  return FIN.sales.filter(x=>x.date&&x.date.slice(0,10)===tod).reduce((s,x)=>s+x.totalAmt,0);
}
function getTodayChi() {
  const tod = todayISO();
  return FIN.imports.filter(x=>x.date&&x.date.slice(0,10)===tod).reduce((s,x)=>s+x.totalAmt,0)
       + FIN.costs.filter(x=>x.date&&x.date.slice(0,10)===tod).reduce((s,x)=>s+x.amount,0);
}
function getYearRevenue() {
  const yr = new Date().getFullYear().toString();
  return allMonthKeys().filter(k=>k.startsWith(yr)).reduce((s,k)=>s+getRevenue(k),0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n) { if(!n||n===0) return '0Ä‘'; return n.toLocaleString('vi-VN')+'Ä‘' }
function fmtAxis(v) {
  if(v===0) return '0';
  const a=Math.abs(v);
  if(a>=1_000_000_000) return (v/1_000_000_000).toFixed(1).replace('.0','')+'tá»·';
  if(a>=1_000_000) return (v/1_000_000).toFixed(1).replace('.0','')+'M';
  if(a>=1_000) return (v/1_000).toFixed(0)+'K';
  return v.toString();
}
function fmtDate(d) {
  if(!d) return '';
  const s=d.includes('T')?d:d+'T00:00', dt=new Date(s);
  if(isNaN(dt)) return d.slice(0,10);
  const dd=String(dt.getDate()).padStart(2,'0'), mm=String(dt.getMonth()+1).padStart(2,'0');
  const hh=String(dt.getHours()).padStart(2,'0'), mn=String(dt.getMinutes()).padStart(2,'0');
  return (dt.getHours()===0&&dt.getMinutes()===0)?`${dd}/${mm}`:`${dd}/${mm} ${hh}:${mn}`;
}
function nowDatetimeLocal() {
  const d=new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')
    +'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
}
function todayISO() { return new Date().toISOString().slice(0,10) }
function monthLabel(k) { const[y,m]=k.split('-'); return `ThÃ¡ng ${parseInt(m)}/${y}` }
function getMonthOpts() {
  const s=new Set();
  for(let i=0;i<6;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);s.add(d.toISOString().slice(0,7))}
  allMonthKeys().forEach(mk=>s.add(mk));
  return [...s].sort().reverse();
}
function handleMoney(el) { const r=(el.value||'').replace(/\D/g,'');el.dataset.raw=r;el.value=r?parseInt(r,10).toLocaleString('vi-VN'):'' }
function blockNonDigit(e) { if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault() }
function getRaw(id) { const el=document.getElementById(id);return el?(parseInt((el.dataset.raw||'0').replace(/\D/g,'')||'0',10)||0):0 }
function getVal(id) { const el=document.getElementById(id);return el?(el.value||'').trim():'' }
function setVal(id,v) { const el=document.getElementById(id);if(el)el.value=v }
function setMoneyVal(id,n) { const el=document.getElementById(id);if(!el)return;el.dataset.raw=String(n);el.value=n?n.toLocaleString('vi-VN'):'' }
function clearMoneyField(id) { const el=document.getElementById(id);if(el){el.value='';el.dataset.raw=''} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTH SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMonthSelect() {
  const now=new Date().toISOString().slice(0,7), opts=getMonthOpts();
  const sel=document.getElementById('monthSelect');
  if(sel) sel.innerHTML=opts.map(k=>`<option value="${k}"${k===curMonth?' selected':''}>${monthLabel(k)}${k===now?' â­':''}</option>`).join('');
  const mb=document.getElementById('monthBadge');
  if(mb) mb.textContent=curMonth===now?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':monthLabel(curMonth);
  const cl=document.getElementById('chartLabel');if(cl)cl.textContent=monthLabel(curMonth);
  ['cmpA','cmpB'].forEach((id,i)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');if(i===1&&opts.length>1)el.value=opts[1]});
  const s1aSel=document.getElementById('s1aMonth');
  if(s1aSel) s1aSel.innerHTML=opts.map(k=>`<option value="${k}"${k===curMonth?' selected':''}>${monthLabel(k)}</option>`).join('');
}
function switchMonth(k) {
  curMonth=k; FIN=loadFin(k); buildMonthSelect(); renderAll();
  if(document.getElementById('page-reports').classList.contains('active'))setTimeout(refreshCharts,80);
  if(document.getElementById('page-history').classList.contains('active'))renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE / TAB NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPage(name,btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='home'){renderSummary();renderTodaySummary();renderHomeRecent();setTimeout(refreshHomeChart,80)}
  if(name==='reports')setTimeout(refreshCharts,80);
  if(name==='history')renderHistory();
  if(name==='ai'){updateAIStatusBar();setTimeout(scrollChat,80)}
}
const SUB_MONEY=['ban','nhap','chiphi','kho','chebien'];
function switchSub(name,btn) {
  SUB_MONEY.forEach(n=>{const el=document.getElementById('msub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-money .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='kho'){renderInventory();renderAdjHistory()}
  if(name==='chebien')renderCookList();
  if(name==='chiphi')renderCostTable();
}
function switchPromoSub(name,btn) {
  ['fb','tt'].forEach(n=>{const el=document.getElementById('psub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-promo .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}
function switchReportSub(name,btn) {
  ['chart','compare','tax','s1a'].forEach(n=>{const el=document.getElementById('rsub-'+n);if(el)el.style.display=n===name?'block':'none'});
  document.querySelectorAll('#page-reports .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='chart')setTimeout(refreshCharts,80);
  if(name==='compare')buildAllTimeCompare();
  if(name==='tax')renderTax();
  if(name==='s1a')renderS1A();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUGGESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _curSellType='hangban', _curSellUnitOut='';
function onSellSug(val) {
  const drop=document.getElementById('sellDrop'),q=(val||'').toLowerCase();
  const inv=computeInventory(),cooks=loadCookItems();
  const hangban=inv.filter(x=>!q||x.name.toLowerCase().includes(q));
  const chebien=cooks.filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';
  if(!hangban.length&&!chebien.length){drop.classList.remove('open');clearStockInfo();return}
  if(hangban.length){
    const g=document.createElement('div');g.className='sug-group';g.textContent='ğŸ—„ï¸ HÃ ng trong kho';drop.appendChild(g);
    hangban.slice(0,10).forEach(p=>{
      const d=document.createElement('div');d.className='sug-opt';
      d.innerHTML=`<div>${p.name} <span style="font-size:.62rem;color:var(--muted)">[${p.unitOut}]</span></div><div class="sug-meta">Tá»“n: <strong>${p.stockUnits} ${p.unitOut}</strong>${p.lastPrice?' Â· Nháº­p: '+fmt(p.lastPrice):''}</div>`;
      d.onmousedown=()=>{selectSellItem(p.name,'hangban',p);drop.classList.remove('open')};
      drop.appendChild(d);
    });
  }
  if(chebien.length){
    const g2=document.createElement('div');g2.className='sug-group';g2.textContent='ğŸ‘¨â€ğŸ³ Cháº¿ biáº¿n';drop.appendChild(g2);
    chebien.slice(0,8).forEach(c=>{
      const d=document.createElement('div');d.className='sug-opt';
      d.innerHTML=`<div>${c.name}</div><div class="sug-meta">Cháº¿ biáº¿n Â· ${c.price?'GiÃ¡: '+fmt(c.price):'â€”'}</div>`;
      d.onmousedown=()=>{selectSellItem(c.name,'chebien',c);drop.classList.remove('open')};
      drop.appendChild(d);
    });
  }
  drop.classList.add('open');
}
function selectSellItem(name,type,data) {
  setVal('sellName',name);_curSellType=type;
  _curSellUnitOut=type==='hangban'?(data.unitOut||''):'';
  if(type==='hangban'){showStockInfo(data);if(data.lastPrice)setMoneyVal('sellPrice',data.lastPrice)}
  else{
    const box=document.getElementById('stockInfoBox');
    if(box){box.style.display='block';box.innerHTML=`ğŸ‘¨â€ğŸ³ <strong>${name}</strong> â€” Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho`}
    if(data.price)setMoneyVal('sellPrice',data.price);
  }
}
function closeSellSug(){const d=document.getElementById('sellDrop');if(d)d.classList.remove('open')}
function showStockInfo(inv){const box=document.getElementById('stockInfoBox');if(!box)return;box.style.display='block';box.innerHTML=`ğŸ“¦ <strong>${inv.name}</strong> [${inv.unitOut}] â€” Tá»“n: <strong>${inv.stockUnits} ${inv.unitOut}</strong>${inv.lastPrice?' Â· Nháº­p: '+fmt(inv.lastPrice):''}`;
}
function clearStockInfo(){const box=document.getElementById('stockInfoBox');if(box)box.style.display='none';_curSellType='hangban';_curSellUnitOut=''}
function calcSellTotal(){const box=document.getElementById('sellTotalBox');if(!box)return;const qty=getRaw('sellQty'),p=getRaw('sellPrice');if(qty>0&&p>0){box.style.display='block';box.textContent=`ğŸ’° ThÃ nh tiá»n: ${fmt(qty*p)}`}else box.style.display='none'}
function onImpSug(val){
  const drop=document.getElementById('impDrop'),q=(val||'').toLowerCase();
  const prods=loadProducts().filter(x=>!q||x.name.toLowerCase().includes(q));
  drop.innerHTML='';if(!prods.length){drop.classList.remove('open');return}
  prods.slice(0,10).forEach(p=>{
    const d=document.createElement('div');d.className='sug-opt';
    d.innerHTML=`<div>${p.name} <span style="font-size:.62rem;color:var(--muted)">[${p.unitOut||''}]</span></div><div class="sug-meta">${p.kind==='hangban'?'ğŸ›’ BÃ¡n láº¡i':'ğŸ§‚ NguyÃªn liá»‡u'}${p.unitIn?' Â· '+p.unitIn+'â†’'+p.unitOut:''}</div>`;
    d.onmousedown=()=>{
      setVal('impName',p.name);drop.classList.remove('open');
      setVal('impType',p.kind||'hangban');setVal('impUnitIn',p.unitIn||'');setVal('impUnitOut',p.unitOut||'');
      const fEl=document.getElementById('impFactor');if(fEl){fEl.value=p.factor||1;fEl.dataset.raw=String(p.factor||1)}
      toggleImpMode();showConvPreview();
    };
    drop.appendChild(d);
  });
  drop.classList.add('open');
}
function closeImpSug(){const d=document.getElementById('impDrop');if(d)d.classList.remove('open')}
function toggleImpMode(){const type=getVal('impType'),cf=document.getElementById('convFields');if(cf)cf.style.display=type==='nguyenlieu'?'none':'block'}
function showConvPreview(){
  const box=document.getElementById('convPreview');if(!box)return;
  const qty=getRaw('impQty'),factor=getRaw('impFactor')||1,uIn=getVal('impUnitIn')||'Ä‘Æ¡n vá»‹ nháº­p',uOut=getVal('impUnitOut')||'Ä‘Æ¡n vá»‹ bÃ¡n';
  if(qty>0&&factor>0){box.innerHTML=`ğŸ“¦ <strong>${qty} ${uIn}</strong> Ã— <strong>${factor}</strong> = <strong>${qty*factor} ${uOut}</strong> vÃ o kho`;box.classList.add('show')}else box.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIALOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pendingSaleFn=null;
function showConfirm(title,msg,fn){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmOverlay').classList.add('show');document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();fn()}}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('show')}
function showStockAlert(msg,fn){document.getElementById('stockAlertMsg').innerHTML=msg;document.getElementById('stockAlertOverlay').classList.add('show');_pendingSaleFn=fn}
function closeStockAlert(){document.getElementById('stockAlertOverlay').classList.remove('show');_pendingSaleFn=null}
function forceConfirmSale(){closeStockAlert();if(_pendingSaleFn)_pendingSaleFn()}
let _toastTimer=null;
function showToast(msg,isErr=false,isOk=false){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className='';if(isErr)t.classList.add('err');if(isOk)t.classList.add('ok');t.classList.add('show');clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>t.classList.remove('show'),3500)}
function saveApiKey(){const v=document.getElementById('apiKeyInput').value.trim();if(!v){showToast('âš ï¸ Nháº­p key!',true);return}apiKey=v;document.getElementById('apiStatus').textContent='âœ… Sáºµn sÃ ng!';document.getElementById('apiStatus').style.color='#1B6B3A';document.getElementById('apiBar').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';showToast('âœ… ÄÃ£ lÆ°u API Key!',false,true)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSale(forceSkip=false){
  const name=getVal('sellName'),qty=getRaw('sellQty'),price=getRaw('sellPrice'),date=getVal('sellDate'),desc=getVal('sellDesc');
  if(!name){showToast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}
  if(!qty){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  if(!price){showToast('âš ï¸ Nháº­p Ä‘Æ¡n giÃ¡!',true);return}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}
  const type=_curSellType||'hangban';
  if(type==='hangban'&&!forceSkip){
    const{stock,unitOut}=getStock(name,_curSellUnitOut);
    if(stock<qty){showStockAlert(`<strong>${name}</strong> [${unitOut}]<br>Kho cÃ²n: <strong>${stock} ${unitOut}</strong><br>Äá»‹nh bÃ¡n: <strong>${qty} ${unitOut}</strong>`,()=>doSaveSale(name,type,qty,price,date,desc));return}
  }
  doSaveSale(name,type,qty,price,date,desc);
}
function doSaveSale(name,type,qty,price,date,desc){
  const{unitOut}=type==='hangban'?getStock(name,_curSellUnitOut):{unitOut:''};
  FIN.sales.push({id:Date.now(),name,type,qty,unitPrice:price,totalAmt:qty*price,date,desc:desc||('BÃ¡n '+name),unitOut});
  persist();renderAll();renderTodaySummary();
  setVal('sellName','');clearMoneyField('sellQty');clearMoneyField('sellPrice');setVal('sellDesc','');
  document.getElementById('sellTotalBox').style.display='none';clearStockInfo();
  showToast(`âœ… ÄÃ£ ghi bÃ¡n ${qty} ${unitOut?unitOut+' ':''}${name}!`,false,true);
}
function delSale(id){showConfirm('XoÃ¡ giao dá»‹ch bÃ¡n','XoÃ¡ giao dá»‹ch nÃ y?',()=>{FIN.sales=FIN.sales.filter(x=>x.id!==id);persist();renderAll();renderTodaySummary();showToast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addImport(){
  const name=getVal('impName'),kind=getVal('impType')||'hangban',qtyIn=getRaw('impQty'),totalAmt=getRaw('impAmt'),date=getVal('impDate');
  const unitIn=getVal('impUnitIn')||'cÃ¡i';
  const unitOut=kind==='nguyenlieu'?unitIn:(getVal('impUnitOut')||unitIn);
  const factor=kind==='nguyenlieu'?1:(getRaw('impFactor')||1);
  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng!',true);return}
  if(!qtyIn){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  if(!totalAmt){showToast('âš ï¸ Nháº­p tá»•ng tiá»n!',true);return}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}
  const stockAdded=kind==='hangban'?qtyIn*factor:0;
  FIN.imports.push({id:Date.now(),name,kind,qtyIn,unitIn,unitOut,factor,stockAdded,totalAmt,date,desc:`Nháº­p ${qtyIn} ${unitIn} ${name}`});
  persist();
  if(kind==='hangban') upsertProduct({name,kind,unitIn,unitOut,factor,lastPrice:Math.round(totalAmt/(qtyIn*factor))});
  else upsertProduct({name,kind:'nguyenlieu',unitIn,unitOut:unitIn,factor:1,lastPrice:Math.round(totalAmt/qtyIn)});
  renderAll();renderInventory();renderTodaySummary();
  setVal('impName','');clearMoneyField('impQty');clearMoneyField('impAmt');setVal('impUnitIn','');setVal('impUnitOut','');
  const fEl=document.getElementById('impFactor');if(fEl){fEl.value='';fEl.dataset.raw=''}
  document.getElementById('convPreview').classList.remove('show');
  document.getElementById('expAutofillNotice').classList.remove('show');
  showToast(kind==='hangban'?`âœ… Nháº­p ${qtyIn} ${unitIn} ${name} â†’ +${stockAdded} ${unitOut} vÃ o kho!`:`âœ… Ghi chi nguyÃªn liá»‡u ${name} (${fmt(totalAmt)})`);
}
function delImport(id){showConfirm('XoÃ¡ khoáº£n nháº­p','Tá»“n kho sáº½ thay Ä‘á»•i.',()=>{FIN.imports=FIN.imports.filter(x=>x.id!==id);persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COSTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCost(){const desc=getVal('cpDesc'),amount=getRaw('cpAmt'),date=getVal('cpDate'),type=getVal('cpType');if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return}if(!amount){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return}FIN.costs.push({id:Date.now(),desc,amount,type,date});persist();renderAll();renderCostTable();renderTodaySummary();clearMoneyField('cpAmt');setVal('cpDesc','');showToast('âœ… ÄÃ£ thÃªm chi phÃ­!')}
function delCost(id){showConfirm('XoÃ¡ chi phÃ­','XoÃ¡ khoáº£n chi nÃ y?',()=>{FIN.costs=FIN.costs.filter(x=>x.id!==id);persist();renderAll();renderCostTable();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCostTable(){const w=document.getElementById('cpTableWrap');if(!w)return;const sorted=[...FIN.costs].sort((a,b)=>b.id-a.id);if(!sorted.length){w.innerHTML='<div class="empty"><div class="ei">âš¡</div>ChÆ°a cÃ³ chi phÃ­ nÃ o</div>';return}const tm={utility:'ğŸ”Œ',transport:'ğŸšš',loss:'ğŸ“‰',rental:'ğŸª',labor:'ğŸ‘·',other:'ğŸ“Œ'};w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>MÃ´ táº£</th><th>Tiá»n</th><th></th></tr></thead><tbody>${sorted.map(c=>`<tr><td>${fmtDate(c.date)}</td><td>${tm[c.type]||'ğŸ“Œ'}</td><td>${c.desc}</td><td class="chi-v">-${fmt(c.amount)}</td><td><button class="del-btn" onclick="delCost(${c.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody></table></div>`}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COOK PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCookProduct(){const name=getVal('cbName'),price=getRaw('cbPrice');if(!name){showToast('âš ï¸ Nháº­p tÃªn!',true);return}const a=loadCookItems();if(a.find(x=>x.name===name)){showToast('âš ï¸ TÃªn Ä‘Ã£ tá»“n táº¡i!',true);return}a.push({id:Date.now(),name,price});saveCookItems(a);renderCookList();setVal('cbName','');clearMoneyField('cbPrice');showToast('âœ… ÄÃ£ thÃªm!')}
function delCookItem(id){showConfirm('XoÃ¡ sáº£n pháº©m','XoÃ¡ sáº£n pháº©m cháº¿ biáº¿n nÃ y?',()=>{saveCookItems(loadCookItems().filter(x=>x.id!==id));renderCookList();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function renderCookList(){const el=document.getElementById('cookList');if(!el)return;const a=loadCookItems();if(!a.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ‘¨â€ğŸ³</div>ChÆ°a cÃ³ sáº£n pháº©m cháº¿ biáº¿n nÃ o</div>';return}el.innerHTML=a.map(c=>`<div class="cook-item"><div class="cook-body"><div class="cook-name">${c.name}</div><div class="cook-meta">Cháº¿ biáº¿n Â· KhÃ´ng trá»« kho</div></div><div class="cook-price">${c.price?fmt(c.price):'â€”'}</div><button class="cook-del" onclick="delCookItem(${c.id})">ğŸ—‘ï¸</button></div>`).join('')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADJUSTMENT (Hao há»¥t â€” chá»‰ trá»« kho, khÃ´ng táº¡o chi)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdjModal(){
  const inv=computeInventory().filter(x=>x.stockUnits>0);
  const sel=document.getElementById('adjProduct');if(!sel)return;
  if(!inv.length){showToast('âš ï¸ Kho trá»‘ng!',true);return}
  sel.innerHTML=inv.map(x=>`<option value="${x.name}|${x.unitOut}">${x.name} [${x.unitOut}] (Tá»“n: ${x.stockUnits})</option>`).join('');
  setVal('adjDate',nowDatetimeLocal());clearMoneyField('adjQty');setVal('adjNote','');
  document.getElementById('adjOverlay').classList.add('show');
}
function closeAdjModal(){document.getElementById('adjOverlay').classList.remove('show')}
function confirmAdj(){
  const selVal=getVal('adjProduct');
  const [adjName,...rest]=selVal.split('|');const adjUnitOut=rest.join('|');
  const qty=getRaw('adjQty'),reason=getVal('adjReason'),note=getVal('adjNote'),date=getVal('adjDate');
  if(!adjName){showToast('âš ï¸ Chá»n sáº£n pháº©m!',true);return}
  if(!qty||qty<=0){showToast('âš ï¸ Nháº­p sá»‘ lÆ°á»£ng!',true);return}
  const{stock,unitOut}=getStock(adjName,adjUnitOut);
  if(stock<qty){showToast(`âš ï¸ Kho chá»‰ cÃ²n ${stock} ${unitOut}!`,true);return}
  const reasonMap={huhong:'HÆ° há»ng',hethan:'Háº¿t háº¡n',thatThoat:'Tháº¥t thoÃ¡t',kiemke:'Kiá»ƒm kÃª',khac:'KhÃ¡c'};
  FIN.adjustments.push({id:Date.now(),name:adjName,unitOut:adjUnitOut,qty,reason,reasonLabel:reasonMap[reason]||reason,note,date});
  persist();renderInventory();renderAdjHistory();closeAdjModal();
  showToast(`âœ… ÄÃ£ Ä‘iá»u chá»‰nh: -${qty} ${unitOut} ${adjName}`,false,true);
}
function renderAdjHistory(){
  const w=document.getElementById('adjHistWrap');if(!w)return;
  const allAdj=[];
  allMonthKeys().forEach(mk=>{loadFin(mk).adjustments.forEach(a=>allAdj.push({...a,mk}))});
  allAdj.sort((a,b)=>b.id-a.id);
  if(!allAdj.length){w.innerHTML='<div class="empty"><div class="ei">âš™ï¸</div>ChÆ°a cÃ³ Ä‘iá»u chá»‰nh nÃ o</div>';return}
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Sáº£n pháº©m</th><th>ÄV</th><th>Giáº£m SL</th><th>LÃ½ do</th></tr></thead><tbody>${allAdj.map(a=>`<tr><td>${fmtDate(a.date)}</td><td>${a.name}</td><td>${a.unitOut||''}</td><td style="color:var(--red);font-weight:800">-${a.qty}</td><td>${a.reasonLabel||a.reason}${a.note?' â€” '+a.note:''}</td></tr>`).join('')}</tbody></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERIOD FILTERS & BULK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let periodBan='all',periodNhap='all',chartPeriod='week';
function setPeriod(tab,p,btn){if(tab==='ban')periodBan=p;else periodNhap=p;const pid=tab==='ban'?'msub-ban':'msub-nhap';document.querySelectorAll(`#${pid} .period-tab`).forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');if(tab==='ban')renderSaleTable();else renderImportTable()}
function setChartPeriod(p,btn){chartPeriod=p;document.querySelectorAll('#rsub-chart .period-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');refreshCharts()}
function filterByPeriod(arr,period){if(period==='all')return arr;const now=new Date(),tod=todayISO();return arr.filter(x=>{const d=x.date?(x.date.includes('T')?x.date.slice(0,10):x.date):'';if(period==='today')return d===tod;if(period==='week'){const dt=new Date(d+'T00:00'),w=new Date(now);w.setDate(now.getDate()-6);return dt>=w}if(period==='month')return d.slice(0,7)===curMonth;return true})}
function toggleSelectAll(tab,checked){document.querySelectorAll(`.cb-${tab}`).forEach(cb=>cb.checked=checked);updateBulkBtn(tab)}
function updateBulkBtn(tab){const c=document.querySelectorAll(`.cb-${tab}:checked`).length,b=document.getElementById(tab+'BulkBtn');if(b)b.style.display=c>0?'inline-flex':'none'}
function bulkDelete(tab){const ids=[];document.querySelectorAll(`.cb-${tab}:checked`).forEach(cb=>ids.push(parseInt(cb.value)));if(!ids.length){showToast('âš ï¸ ChÆ°a chá»n!',true);return}showConfirm(`XoÃ¡ ${ids.length} giao dá»‹ch`,'KhÃ´ng thá»ƒ hoÃ n tÃ¡c.',()=>{const s=new Set(ids);if(tab==='ban')FIN.sales=FIN.sales.filter(x=>!s.has(x.id));else FIN.imports=FIN.imports.filter(x=>!s.has(x.id));persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}
function confirmDeleteAll(tab){const label=tab==='ban'?'bÃ¡n hÃ ng':'nháº­p hÃ ng';showConfirm('XoÃ¡ táº¥t cáº£',`XoÃ¡ TOÃ€N Bá»˜ ${label} thÃ¡ng ${monthLabel(curMonth)}?`,()=>{if(tab==='ban')FIN.sales=[];else FIN.imports=[];persist();renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!')})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderSummary();renderSaleTable();renderImportTable()}
function renderTodaySummary(){
  const tod=todayISO();
  const label=(()=>{const d=new Date();retur
