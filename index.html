<!DOCTYPE html>
<html lang="vi">
<head>
<script src="https://unpkg.com/html5-qrcode"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--a600:#D4881A;
  --red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.11);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--surface);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}

header{background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:15px 18px 12px;text-align:center;position:sticky;top:0;z-index:300;box-shadow:0 2px 12px rgba(0,0,0,.22)}
header h1{font-size:1.4rem;font-weight:800}
header p{font-size:.74rem;opacity:.75;margin-top:2px}
.badge{background:var(--a400);color:#1A2E23;font-size:.6rem;font-weight:900;padding:2px 8px;border-radius:20px;margin-left:6px;vertical-align:middle}

#apiSetup{background:#FFFDE7;border-bottom:2px solid var(--a400);padding:10px 14px;display:flex;align-items:center;flex-wrap:wrap;gap:7px}
#apiSetup label{font-size:.78rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:140px;padding:8px 11px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.86rem}
#apiKeyInput:focus{outline:none;border-color:var(--a600)}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:8px 13px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.82rem;transition:.18s;white-space:nowrap}
#saveKeyBtn:hover{background:var(--a600);color:#fff}
#apiStatus{font-size:.74rem;width:100%;margin-top:-2px}

#monthBar{background:var(--card);border-bottom:2px solid var(--border);padding:9px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;position:sticky;top:52px;z-index:290}
#monthBar label{font-size:.76rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:7px 10px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
#monthSelect:focus{outline:none;border-color:var(--p600)}
.month-badge{font-size:.7rem;background:var(--p50);color:var(--p600);padding:3px 10px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto;white-space:nowrap}
.compare-row{width:100%;display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:2px}
.compare-row select{padding:6px 10px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:.78rem;background:var(--surface)}
.compare-row button{padding:6px 12px;background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);font-size:.76rem;font-weight:800;color:var(--p700);cursor:pointer;transition:.18s}
.compare-row button:hover{background:var(--p600);color:#fff}

nav{display:flex;background:var(--card);border-bottom:2px solid var(--border);position:sticky;top:102px;z-index:280;overflow-x:auto}
nav button{flex:1;min-width:55px;padding:10px 3px;border:none;background:none;font-size:.65rem;font-weight:800;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;border-bottom:3px solid transparent;transition:.18s;white-space:nowrap}
nav button .ni{font-size:1.2rem}
nav button:hover{background:var(--p50);color:var(--p600)}
nav button.active{color:var(--p600);border-bottom-color:var(--p600);background:var(--p50)}

.section{display:none;padding:12px;max-width:660px;margin:0 auto}
.section.active{display:block}

.card{background:var(--card);border-radius:var(--r-md);padding:16px;margin-bottom:12px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}
.card-title{font-size:.95rem;font-weight:800;color:var(--p700);margin-bottom:11px;display:flex;align-items:center;gap:7px}
.card-sub{font-size:.76rem;color:var(--muted);margin-top:-7px;margin-bottom:11px}

.field{margin-bottom:10px}
.field label{font-size:.74rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:11px 12px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.9rem;font-family:var(--font);background:#fff;color:var(--text);transition:.18s}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.09)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
@media(max-width:380px){.row2{grid-template-columns:1fr}}

.cat-wrap{position:relative}
.cat-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:500;max-height:180px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.cat-dropdown.open{display:block}
.cat-opt{padding:10px 13px;cursor:pointer;font-size:.87rem;border-bottom:1px solid var(--border);transition:.15s}
.cat-opt:last-child{border-bottom:none}
.cat-opt:hover{background:var(--p50);color:var(--p600)}
.cat-opt.new-item{color:var(--p600);font-weight:800;font-style:italic}

.sug-wrap{position:relative}
.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:500;max-height:160px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.sug-dropdown.open{display:block}
.sug-opt{padding:9px 13px;cursor:pointer;font-size:.87rem;border-bottom:1px solid var(--border);transition:.15s}
.sug-opt:last-child{border-bottom:none}
.sug-opt:hover{background:var(--p50)}

.btn{width:100%;padding:13px;border:none;border-radius:var(--r-md);font-size:.9rem;font-weight:800;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:9px;font-family:var(--font)}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.22)}
.btn-primary:hover:not(:disabled){background:var(--p700);transform:translateY(-1px)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-sm{padding:7px 13px;font-size:.78rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.48;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn .bi{font-size:1.1rem}

.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:22px 14px;text-align:center;cursor:pointer;transition:.2s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100);transform:translateY(-2px)}
.upload-area .u-icon{font-size:2.2rem;margin-bottom:5px}
.upload-area strong{display:block;font-size:.86rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.72rem}
.preview-img{width:100%;max-height:200px;object-fit:cover;border-radius:var(--r-sm);margin-top:10px;display:none;border:3px solid var(--p300)}

.copy-btn{display:none;align-items:center;gap:6px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:8px 15px;border-radius:var(--r-sm);font-size:.8rem;font-weight:800;cursor:pointer;margin-top:8px;transition:.2s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}

.invoice-table-wrap{margin-top:11px;overflow-x:auto;display:none}
.invoice-table-wrap.show{display:block}
.inv-tbl{width:100%;border-collapse:collapse;font-size:.84rem}
.inv-tbl th{background:var(--p600);color:#fff;padding:9px 10px;text-align:left;font-size:.76rem;font-weight:800}
.inv-tbl th:first-child{border-radius:var(--r-sm) 0 0 0}.inv-tbl th:last-child{border-radius:0 var(--r-sm) 0 0}
.inv-tbl td{padding:9px 10px;border-bottom:1px solid var(--border)}
.inv-tbl tr:last-child td{border-bottom:none}
.inv-tbl tr:nth-child(even) td{background:var(--p50)}
.inv-actions{display:flex;gap:7px;margin-top:9px;flex-wrap:wrap;align-items:center}

/* Auto-fill notice */
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:10px 13px;font-size:.8rem;color:var(--p700);margin-top:8px;display:none}
.autofill-notice.show{display:block}

.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:13px;margin-top:10px;white-space:pre-wrap;font-size:.84rem;line-height:1.7;max-height:300px;overflow-y:auto;display:none}
.result-box.show{display:block}

.loader{display:none;text-align:center;padding:18px}
.loader.show{display:block}
.spinner{width:36px;height:36px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 8px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.82rem}

.sub-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.sub-tab{padding:7px 14px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.78rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

.chip-group{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;min-height:8px}
.chip{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:5px 11px;border-radius:20px;font-size:.74rem;font-weight:800;cursor:pointer;transition:.18s}
.chip:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.chip.chi-c{border-color:#F5C6C0;color:var(--red)}
.chip.chi-c:hover{background:var(--red);color:#fff;border-color:var(--red)}

.tbl-wrap{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:.81rem}
thead tr{background:var(--p600)}
th{padding:9px 10px;text-align:left;color:#fff;font-size:.74rem;font-weight:800;white-space:nowrap}
th:first-child{border-radius:var(--r-sm) 0 0 0}th:last-child{border-radius:0 var(--r-sm) 0 0}
td{padding:9px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800}
.chi-v{color:var(--red);font-weight:800}
.del-btn{background:none;border:none;cursor:pointer;font-size:.9rem;padding:4px 6px;border-radius:6px;transition:.15s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 7px;border-radius:8px;font-size:.68rem;font-weight:800;white-space:nowrap}
.tag-thu{background:#D4EDDA;color:var(--p700)}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-op{background:#FFF3CD;color:#856404}

.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:12px 9px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.68rem;font-weight:800;color:var(--muted);margin-bottom:3px}
.s-val{font-size:.97rem;font-weight:900}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}

.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);padding:14px;margin-bottom:12px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.88rem;font-weight:800;color:var(--p700);margin-bottom:10px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:10px 6px;border:1px solid var(--border)}
.cmp-lbl{font-size:.65rem;font-weight:800;color:var(--muted);margin-bottom:3px}
.cmp-cur{font-size:.85rem;font-weight:900;color:var(--p700)}
.cmp-prev{font-size:.72rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.72rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}

.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:480px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:12px;border:1px solid var(--border)}
.ch-card h3{font-size:.78rem;font-weight:800;color:var(--p700);margin-bottom:8px;text-align:center}
.ch-wrap{position:relative;height:160px}
.ch-full{position:relative;height:180px}

/* HISTORY TAB */
.history-filters{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.history-filters input,.history-filters select{padding:8px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.82rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:140px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.history-total-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.hist-row-clickable{cursor:pointer;transition:.15s}
.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);border:1px solid var(--p100);border-radius:6px;font-size:.65rem;padding:1px 6px;margin-left:4px;font-weight:800;cursor:pointer}
.jump-badge:hover{background:var(--p600);color:#fff}

.chat-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;box-shadow:var(--shadow-md);border:1px solid var(--border)}
.chat-head{background:var(--p600);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:10px}
.chat-av{width:34px;height:34px;border-radius:50%;background:var(--a400);display:flex;align-items:center;justify-content:center;font-size:1.15rem;flex-shrink:0}
.chat-title{font-weight:800;font-size:.9rem}
.chat-status{font-size:.67rem;opacity:.74;font-weight:400}
.chat-msgs{padding:12px;max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.msg{max-width:85%;padding:9px 12px;border-radius:16px;font-size:.83rem;line-height:1.55}
.msg.bot{background:var(--p50);border:1.5px solid var(--p100);align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:var(--p600);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{display:none;align-self:flex-start}.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:9px 13px;background:var(--p50);border:1.5px solid var(--p100);border-radius:16px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
.chat-foot{display:flex;gap:7px;padding:10px 12px;border-top:2px solid var(--border);background:var(--surface)}
.chat-inp{flex:1;padding:9px 12px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.86rem;font-family:var(--font)}
.chat-inp:focus{outline:none;border-color:var(--p600)}
.chat-send{background:var(--p600);color:#fff;border:none;padding:9px 15px;border-radius:var(--r-sm);font-size:.95rem;cursor:pointer;transition:.18s}
.chat-send:hover{background:var(--p700)}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:center;justify-content:center;padding:16px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg);padding:18px;width:100%;max-width:360px;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto}
.modal h3{font-size:.94rem;font-weight:800;color:var(--p700);margin-bottom:10px}
#qr-reader-container{width:100%;min-height:160px;border-radius:var(--r-sm);overflow:hidden;border:2px solid var(--border);margin-bottom:10px;background:var(--surface);display:flex;align-items:center;justify-content:center}
.qr-fallback{text-align:center;padding:16px;color:var(--muted);font-size:.8rem}
.modal-close{width:100%;padding:10px;border:2px solid var(--border);background:#fff;border-radius:var(--r-sm);font-weight:800;cursor:pointer;color:var(--muted);font-size:.84rem;margin-top:8px;transition:.18s}
.modal-close:hover{background:var(--red-bg);color:var(--red)}
.qr-inline{display:flex;gap:6px}
.qr-inline .inp{flex:1}
.qr-btn{padding:11px 12px;background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);cursor:pointer;font-size:1rem;transition:.18s;flex-shrink:0}
.qr-btn:hover{background:var(--p600)}
.modal-sub-tabs{display:flex;gap:6px;margin-bottom:12px}
.modal-sub-tab{flex:1;padding:8px;border:2px solid var(--border);background:#fff;border-radius:var(--r-sm);font-size:.78rem;font-weight:800;color:var(--muted);cursor:pointer;text-align:center;transition:.18s}
.modal-sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}

.inv-kho-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.inv-kho-row:last-child{border-bottom:none}
.inv-kho-name{flex:1;font-size:.86rem;font-weight:700}
.inv-qty{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:3px 10px;border-radius:20px;font-size:.78rem;font-weight:800}
.inv-price{color:var(--muted);font-size:.76rem}

.empty{text-align:center;color:var(--muted);padding:26px 10px;font-size:.84rem}
.empty .ei{font-size:2.2rem;margin-bottom:6px}
.info-box{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:10px 12px;font-size:.78rem;color:var(--muted);line-height:1.6;margin-top:10px}
.info-box strong{color:var(--p700)}
code{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:2px 6px;font-size:.74rem;font-family:monospace}

#toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(90px);background:var(--p700);color:#fff;padding:10px 20px;border-radius:30px;font-size:.84rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md)}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.err{background:var(--red)}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Há»‡ thá»‘ng quáº£n lÃ½ kinh doanh theo thÃ¡ng</p>
</header>

<div id="apiSetup">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <p id="apiStatus"></p>
</div>

<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
  <div class="compare-row">
    <label style="font-size:.74rem;font-weight:800;color:var(--muted)">So sÃ¡nh:</label>
    <select id="compareSelect"></select>
    <button onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
    <button onclick="hideCompare()" style="background:var(--red-bg);color:var(--red);border-color:#F5C6C0">âœ•</button>
  </div>
</div>

<nav>
  <button class="active" onclick="switchTab('income',this)"><span class="ni">ğŸ’°</span>Thu</button>
  <button onclick="switchTab('expense',this)"><span class="ni">ğŸ’¸</span>Chi/Kho</button>
  <button onclick="switchTab('facebook',this)"><span class="ni">ğŸ“£</span>BÃ i Ä‘Äƒng</button>
  <button onclick="switchTab('video',this)"><span class="ni">ğŸ¬</span>TikTok</button>
  <button onclick="switchTab('charts',this)"><span class="ni">ğŸ“Š</span>BÃ¡o cÃ¡o</button>
  <button onclick="switchTab('history',this)"><span class="ni">ğŸ§¾</span>Lá»‹ch sá»­</button>
  <button onclick="switchTab('chat',this)"><span class="ni">ğŸ¤–</span>AI Chat</button>
</nav>

<!-- â•â•â• THU â•â•â• -->
<div id="tab-income" class="section active">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="totalThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="totalProfit">0Ä‘</div></div>
  </div>
  <div class="compare-box" id="compareBox"></div>

  <!-- QuÃ©t hÃ³a Ä‘Æ¡n + QR bÃªn Thu -->
  <div class="card">
    <div class="card-title">ğŸ“· QuÃ©t hÃ³a Ä‘Æ¡n / QR â€” Thu</div>
    <div class="card-sub">AI Ä‘á»c áº£nh hoáº·c quÃ©t QR â†’ tá»± Ä‘iá»n vÃ o form Thu</div>
    <div class="modal-sub-tabs">
      <div class="modal-sub-tab active" onclick="incScanMode('img',this)">ğŸ“¸ áº¢nh hÃ³a Ä‘Æ¡n</div>
      <div class="modal-sub-tab" onclick="incScanMode('qr',this)">ğŸ“· QuÃ©t QR</div>
    </div>

    <!-- áº¢NH -->
    <div id="incScanImg">
      <div class="upload-area" onclick="document.getElementById('incInvoiceFile').click()">
        <div class="u-icon">ğŸ§¾</div>
        <strong>Báº¥m Ä‘á»ƒ chá»n áº£nh hÃ³a Ä‘Æ¡n</strong>
        <small>AI trÃ­ch xuáº¥t vÃ  tá»± Ä‘iá»n vÃ o form</small>
      </div>
      <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
      <img id="incInvoicePreview" class="preview-img"/>
      <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:10px">
        <span class="bi">ğŸ¤–</span>TrÃ­ch xuáº¥t & tá»± Ä‘iá»n
      </button>
      <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="incInvoiceTableWrap"></div>
      <div class="autofill-notice" id="incAutofillNotice">âœ… AI Ä‘Ã£ tá»± Ä‘iá»n vÃ o form bÃªn dÆ°á»›i â€” kiá»ƒm tra vÃ  báº¥m "ThÃªm khoáº£n thu"</div>
    </div>

    <!-- QR -->
    <div id="incScanQR" style="display:none">
      <div id="qr-inc-container" style="width:100%;min-height:160px;border-radius:var(--r-sm);border:2px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
        <div class="qr-fallback" id="qrIncFallback"><div style="font-size:1.8rem;margin-bottom:6px">ğŸ“·</div><p>Báº¥m nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ má»Ÿ camera QR</p></div>
      </div>
      <button class="btn btn-secondary" onclick="startIncQR()" id="startIncQRBtn"><span class="bi">ğŸ“·</span>Má»Ÿ camera quÃ©t QR</button>
      <button class="btn btn-secondary" onclick="stopIncQR()" id="stopIncQRBtn" style="display:none"><span class="bi">â¹</span>Dá»«ng camera</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title">â• ThÃªm khoáº£n thu</div>
    <div class="field">
      <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
      <div class="cat-wrap">
        <input class="inp" id="incCatInput" placeholder="Nháº­p hoáº·c chá»n loáº¡i hÃ ng..." autocomplete="off"
          oninput="onCatInput('inc')" onfocus="openDrop('incCatDrop','inc')" onblur="setTimeout(()=>closeDrop('incCatDrop'),200)"/>
        <div class="cat-dropdown" id="incCatDrop"></div>
      </div>
    </div>
    <div class="chip-group" id="incChips"></div>
    <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="incDesc" placeholder="VD: BÃ¡n mÃ¬ tÃ´m láº» 20 gÃ³i"/></div>
    <div class="row2">
      <div class="field">
        <label>ğŸ’µ Sá»‘ tiá»n</label>
        <input class="inp" type="text" id="incAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/>
      </div>
      <div class="field">
        <label>ğŸ“… NgÃ y</label>
        <input class="inp" type="date" id="incDate"/>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addIncome()"><span class="bi">â•</span>ThÃªm khoáº£n thu</button>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ thu â€” <span id="incMonthLabel" style="font-weight:400;font-size:.85rem;color:var(--muted)"></span></div>
    <div id="incTableWrap"></div>
  </div>
</div>

<!-- â•â•â• CHI / KHO â•â•â• -->
<div id="tab-expense" class="section">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('import',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('operational',this)">âš¡ Chi phÃ­ thÃªm</button>
    <button class="sub-tab" onclick="switchSub('inventory',this)">ğŸ—„ï¸ Tá»“n kho</button>
  </div>

  <div id="sub-import">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="card-sub">AI Ä‘á»c áº£nh â†’ báº£ng rÃµ rÃ ng â†’ tá»± Ä‘iá»n form nháº­p hÃ ng</div>
      <div class="upload-area" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div>
        <strong>Báº¥m Ä‘á»ƒ chá»¥p / chá»n áº£nh hÃ³a Ä‘Æ¡n</strong>
        <small>JPG, PNG â€” AI trÃ­ch xuáº¥t thÃ nh báº£ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <img id="invoicePreview" class="preview-img"/>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:10px">
        <span class="bi">ğŸ¤–</span>TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n
      </button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="invoiceTableWrap"></div>
      <div class="inv-actions" id="invActions" style="display:none">
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceText()">ğŸ“‹ Text</button>
        <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Tá»± nháº­p Chi</button>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… AI Ä‘Ã£ tá»± Ä‘iá»n vÃ o form nháº­p hÃ ng bÃªn dÆ°á»›i â€” kiá»ƒm tra vÃ  báº¥m "Nháº­p + cáº­p nháº­t kho"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng thá»§ cÃ´ng</div>
      <div class="field">
        <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
        <div class="cat-wrap">
          <input class="inp" id="impCatInput" placeholder="Nháº­p hoáº·c chá»n..." autocomplete="off"
            oninput="onCatInput('imp')" onfocus="openDrop('impCatDrop','imp')" onblur="setTimeout(()=>closeDrop('impCatDrop'),200)"/>
          <div class="cat-dropdown" id="impCatDrop"></div>
        </div>
      </div>
      <div class="chip-group" id="impChips"></div>
      <div class="field">
        <label>ğŸ“ TÃªn hÃ ng</label>
        <div class="sug-wrap">
          <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
            oninput="onProdInput()" onfocus="onProdInput()" onblur="setTimeout(closeProdSug,200)"/>
          <div class="sug-dropdown" id="prodSugDrop"></div>
        </div>
      </div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° ThÃ nh tiá»n (Tá»•ng tiá»n)</label><input class="inp" type="text" id="impAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="date" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()"><span class="bi">â•</span>Nháº­p + cáº­p nháº­t kho</button>
    </div>
  </div>

  <div id="sub-operational" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ thÃªm</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, váº­n chuyá»ƒn â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field">
        <label>ğŸ“‚ Loáº¡i</label>
        <select class="inp" id="opType" onchange="renderOpChips()">
          <option value="">-- Chá»n --</option>
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="chip-group" id="opChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="opDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="opAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="opDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addOperational()"><span class="bi">â•</span>ThÃªm chi phÃ­ thÃªm</button>
    </div>
  </div>

  <div id="sub-inventory" style="display:none">
    <div class="card"><div class="card-title">ğŸ—„ï¸ Tá»“n kho</div><div id="inventoryList"></div></div>
  </div>
  <div class="card"><div class="card-title">ğŸ“‹ Lá»‹ch sá»­ chi</div><div id="expTableWrap"></div></div>
</div>

<!-- â•â•â• BÃ€I ÄÄ‚NG â•â•â• -->
<div id="tab-facebook" class="section">
  <div class="card">
    <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook tá»« áº£nh</div>
    <div class="card-sub">AI nháº­n diá»‡n â†’ viáº¿t bÃ i â†’ Ä‘á»“ng bá»™ TikTok</div>
    <div class="upload-area" onclick="document.getElementById('fbImgInput').click()">
      <div class="u-icon">ğŸ–¼ï¸</div>
      <strong>Báº¥m Ä‘á»ƒ chá»n áº£nh sáº£n pháº©m</strong>
      <small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i ngay</small>
    </div>
    <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
    <img id="fbPreview" class="preview-img"/>
    <div id="fbDetected" style="display:none;margin-top:9px;padding:9px 12px;background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);font-size:.82rem;color:var(--p700);font-weight:700"></div>
  </div>
  <button class="btn btn-primary" onclick="generateFbPost()" id="fbPostBtn" disabled>
    <span class="bi">ğŸ¤–</span>AI viáº¿t bÃ i + Ä‘á»“ng bá»™
  </button>
  <div class="card" id="fbResultCard" style="display:none">
    <div class="card-title">âœï¸ BÃ i Ä‘Äƒng</div>
    <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t bÃ i...</p></div>
    <div class="result-box" id="fbPost"></div>
    <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p</button>
  </div>
</div>

<!-- â•â•â• TIKTOK â•â•â• -->
<div id="tab-video" class="section">
  <div class="card">
    <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
    <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
    <div class="field">
      <label>ğŸ‘¤ NgÆ°á»i quay</label>
      <select class="inp" id="ttRole">
        <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
        <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
        <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
        <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
      </select>
    </div>
  </div>
  <button class="btn btn-primary" onclick="generateScript()" id="scriptBtn"><span class="bi">ğŸ¥</span>Táº¡o hÆ°á»›ng dáº«n quay</button>
  <div class="card" id="videoResult" style="display:none">
    <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n cá»§a báº¡n</div>
    <div class="loader" id="videoLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
    <div class="result-box" id="scriptBox"></div>
    <button class="copy-btn" id="copyScript" onclick="doCopy('scriptBox','copyScript')">ğŸ“‹ Sao chÃ©p</button>
  </div>
</div>

<!-- â•â•â• BÃO CÃO â•â•â• -->
<div id="tab-charts" class="section">
  <div class="card">
    <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o â€” <span id="chartMonthLabel" style="font-weight:400;font-size:.82rem;color:var(--muted)"></span></div>
    <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u thÃ¡ng nÃ y<br>ThÃªm thu/chi Ä‘á»ƒ xem bÃ¡o cÃ¡o</div>
    <div id="chartContent">
      <div class="charts-grid">
        <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
        <div class="ch-card"><h3>ğŸ“¦ Loáº¡i chi</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
      </div>
      <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n 7 ngÃ y gáº§n nháº¥t</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
    </div>
  </div>
  <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i biá»ƒu Ä‘á»“</button>
</div>

<!-- â•â•â• Lá»ŠCH Sá»¬ â•â•â• -->
<div id="tab-history" class="section">
  <!-- Tá»•ng toÃ n thá»i gian -->
  <div class="history-total-strip" id="histTotalStrip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu (all)</div><div class="s-val" id="histAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi (all)</div><div class="s-val" id="histAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»— (all)</div><div class="s-val" id="histAllProfit">0Ä‘</div></div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­ giao dá»‹ch</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m mÃ´ táº£..." oninput="renderHistory()"/>
      <select id="histTypeFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="thu">ğŸ’° Thu</option>
        <option value="chi">ğŸ’¸ Chi</option>
      </select>
      <select id="histCatFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ thÃ¡ng</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="exportAllCSV()">ğŸ“¥ Xuáº¥t CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>

<!-- â•â•â• AI CHAT â•â•â• -->
<div id="tab-chat" class="section">
  <div class="card" style="padding:0;overflow:hidden">
    <div class="chat-box">
      <div class="chat-head">
        <div class="chat-av">ğŸŒ¿</div>
        <div><div class="chat-title">Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</div><div class="chat-status">â— Há»i gÃ¬ cÅ©ng Ä‘Æ°á»£c</div></div>
      </div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="msg bot">ğŸ‘‹ Xin chÃ o! MÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n vá»:<br>â€¢ ğŸ’° Äá»‹nh giÃ¡ & lá»£i nhuáº­n<br>â€¢ ğŸ“¦ Quáº£n lÃ½ kho<br>â€¢ ğŸ“£ BÃ¡n hÃ ng online<br>â€¢ ğŸ“Š PhÃ¢n tÃ­ch thu chi</div>
        <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
      </div>
      <div class="chat-foot">
        <input class="chat-inp" id="chatInp" placeholder="Nháº­p cÃ¢u há»i..." onkeydown="if(event.key==='Enter')sendChat()"/>
        <button class="chat-send" onclick="sendChat()">â¤</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent";
let API_KEY = localStorage.getItem('tt40_key') || '';
let fbBase64 = '';
let invoiceBase64 = '';
let incInvoiceBase64 = '';   // hÃ³a Ä‘Æ¡n bÃªn má»¥c THU
let invoiceData = [];        // parsed rows cho CSV
let incInvoiceData = [];     // parsed rows bÃªn thu
let aiDetectedProduct = '';
let incQRScanner = null;
const chatHistory = [];
const chartInst = { pie: null, bar: null, line: null };
let toastTimer = null;
// LÆ°u ngÃ y hiá»‡n táº¡i Ä‘á»ƒ reset Ä‘Ãºng sau khi submit
const TODAY = new Date().toISOString().slice(0, 10);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getCurrentMonthKey = () => new Date().toISOString().slice(0, 7);
const getMonthKey = (y, m) => `${y}-${String(m).padStart(2, '0')}`;
const monthToLabel = k => { const [y, m] = k.split('-'); return `ThÃ¡ng ${parseInt(m)}/${y}`; };
const lsKey = k => `data-${k}`;

function emptyMonth() {
  return {
    income: [], expense: [], inventory: {},
    categories: ['MÃ¬ tÃ´m','Trá»©ng gÃ ','NÆ°á»›c máº¯m','Gáº¡o','Bia/NÆ°á»›c ngá»t','BÃ¡nh káº¹o','Thá»§ cÃ´ng','Rau cá»§'],
    products: []
  };
}

function loadMonthData(key) {
  try {
    const raw = localStorage.getItem(lsKey(key));
    if (!raw) return emptyMonth();
    const d = JSON.parse(raw);
    if (!d.categories) d.categories = emptyMonth().categories;
    if (!d.products)   d.products   = [];
    if (!d.inventory)  d.inventory  = {};
    if (!d.income)     d.income     = [];
    if (!d.expense)    d.expense    = [];
    return d;
  } catch { return emptyMonth(); }
}

function saveMonthData(key, data) {
  try { localStorage.setItem(lsKey(key), JSON.stringify(data)); }
  catch (e) { showToast('âŒ Lá»—i lÆ°u: ' + e.message, true); }
}

function getMonthOptions() {
  const keys = new Set();
  for (let i = 0; i < 4; i++) {
    const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
    keys.add(getMonthKey(d.getFullYear(), d.getMonth() + 1));
  }
  for (const k of Object.keys(localStorage)) {
    if (k.startsWith('data-20')) keys.add(k.replace('data-', ''));
  }
  return [...keys].sort().reverse();
}

let currentMonth = getCurrentMonthKey();
let monthData    = loadMonthData(currentMonth);

function buildMonthSelect() {
  const cur  = getCurrentMonthKey();
  const opts = getMonthOptions();
  const sel  = document.getElementById('monthSelect');
  const cmp  = document.getElementById('compareSelect');
  if (!sel || !cmp) return;
  sel.innerHTML = opts.map(k =>
    `<option value="${k}"${k === currentMonth ? ' selected' : ''}>${monthToLabel(k)}${k === cur ? ' â­' : ''}</option>`
  ).join('');
  cmp.innerHTML = opts.filter(k => k !== currentMonth)
    .map(k => `<option value="${k}">${monthToLabel(k)}</option>`).join('');
  const s = id => document.getElementById(id);
  const set = (id, v) => { const e = s(id); if (e) e.textContent = v; };
  set('monthBadge', currentMonth === cur ? 'ğŸ“ ThÃ¡ng hiá»‡n táº¡i' : monthToLabel(currentMonth));
  set('incMonthLabel', monthToLabel(currentMonth));
  set('chartMonthLabel', monthToLabel(currentMonth));
}

function switchMonth(key) {
  currentMonth = key;
  monthData    = loadMonthData(key);
  buildMonthSelect(); renderAll(); hideCompare();
  if (document.getElementById('tab-charts').classList.contains('active')) setTimeout(refreshCharts, 80);
  if (document.getElementById('tab-history').classList.contains('active')) renderHistory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveApiKey() {
  const v = document.getElementById('apiKeyInput').value.trim();
  if (!v) { showSt('âš ï¸ Nháº­p key!', '#c62828'); return; }
  API_KEY = v; localStorage.setItem('tt40_key', v);
  showSt('âœ… ÄÃ£ lÆ°u â€” sáºµn sÃ ng!', '#1B6B3A');
  document.getElementById('apiSetup').style.cssText += ';background:#F1F8E9;border-bottom-color:#6ABF8A';
}
function showSt(m, c) { const e = document.getElementById('apiStatus'); if (e) { e.textContent = m; e.style.color = c; } }
if (API_KEY) {
  document.getElementById('apiKeyInput').value = API_KEY;
  showSt('âœ… Sáºµn sÃ ng!', '#1B6B3A');
  document.getElementById('apiSetup').style.cssText += ';background:#F1F8E9;border-bottom-color:#6ABF8A';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB / SUB-TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const sec = document.getElementById('tab-' + name);
  if (sec) sec.classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'charts') setTimeout(refreshCharts, 80);
  if (name === 'history') renderHistory();
}
function switchSub(name, btn) {
  ['import','operational','inventory'].forEach(n => {
    const el = document.getElementById('sub-' + n);
    if (el) el.style.display = n === name ? 'block' : 'none';
  });
  document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (name === 'inventory') renderInventory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPARE MONTHS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showCompare() {
  const cmpKey = document.getElementById('compareSelect').value;
  if (!cmpKey) { showToast('âš ï¸ Chá»n thÃ¡ng Ä‘á»ƒ so sÃ¡nh!', true); return; }
  const cmpData = loadMonthData(cmpKey);
  const curThu  = sum(monthData.income);
  const curChi  = sum(monthData.expense);
  const prvThu  = sum(cmpData.income);
  const prvChi  = sum(cmpData.expense);
  const curLai  = curThu - curChi;
  const prvLai  = prvThu - prvChi;
  const delta = (cur, prv) => {
    const d = cur - prv, pct = prv > 0 ? Math.round(d/prv*100) : 0;
    return `<div class="cmp-delta ${d >= 0 ? 'delta-up' : 'delta-down'}">${d >= 0 ? 'â–²' : 'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`;
  };
  document.getElementById('compareBox').innerHTML = `
    <h3>ğŸ“Š ${monthToLabel(currentMonth)} vs ${monthToLabel(cmpKey)}</h3>
    <div class="cmp-grid">
      <div class="cmp-item"><div class="cmp-lbl">ğŸ“ˆ Thu</div><div class="cmp-cur">${fmt(curThu)}</div><div class="cmp-prev">TrÆ°á»›c: ${fmt(prvThu)}</div>${delta(curThu,prvThu)}</div>
      <div class="cmp-item"><div class="cmp-lbl">ğŸ“‰ Chi</div><div class="cmp-cur">${fmt(curChi)}</div><div class="cmp-prev">TrÆ°á»›c: ${fmt(prvChi)}</div>${delta(curChi,prvChi)}</div>
      <div class="cmp-item"><div class="cmp-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="cmp-cur" style="color:${curLai>=0?'var(--p600)':'var(--red)'}">${(curLai>=0?'+':'')+fmt(curLai)}</div><div class="cmp-prev">TrÆ°á»›c: ${(prvLai>=0?'+':'')+fmt(prvLai)}</div>${delta(curLai,prvLai)}</div>
    </div>`;
  document.getElementById('compareBox').classList.add('show');
}
function hideCompare() {
  const el = document.getElementById('compareBox');
  if (el) { el.classList.remove('show'); el.innerHTML = ''; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT MONEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleMoney(el) {
  const digits = el.value.replace(/\D/g, '');
  el.dataset.raw = digits;
  el.value = digits ? parseInt(digits, 10).toLocaleString('vi-VN') : '';
}
function blockNonDigit(e) {
  const safe = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
  if (!safe.includes(e.key) && !/^\d$/.test(e.key)) e.preventDefault();
}
function getRaw(id) {
  const el = document.getElementById(id);
  return el ? parseInt(el.dataset.raw || '0', 10) || 0 : 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COPY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doCopy(boxId, btnId) {
  const box = document.getElementById(boxId); if (!box) return;
  const text = box.textContent.trim();
  if (!text) { showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!', true); return; }
  let ok = false;
  try {
    if (window.isSecureContext && navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(text); ok = true;
    } else {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.cssText = 'position:fixed;top:-9999px;opacity:0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      ok = document.execCommand('copy'); document.body.removeChild(ta);
    }
  } catch {}
  if (ok) {
    showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');
    if (btnId) {
      const btn = document.getElementById(btnId);
      if (btn) {
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ… ÄÃ£ sao chÃ©p!'; btn.classList.add('ok'); btn.disabled = true;
        setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('ok'); btn.disabled = false; }, 2000);
      }
    }
  } else { showToast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C', true); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const getCats = () => monthData.categories || [];
function openDrop(dropId, prefix) {
  const inp = document.getElementById(prefix + 'CatInput');
  renderCatDropdown(dropId, prefix, inp ? inp.value.toLowerCase() : '');
}
function closeDrop(dropId) { const el = document.getElementById(dropId); if (el) el.classList.remove('open'); }
function onCatInput(prefix) {
  const inp = document.getElementById(prefix + 'CatInput'); if (!inp) return;
  renderCatDropdown(prefix + 'CatDrop', prefix, inp.value.toLowerCase());
  const exact = getCats().find(c => c.toLowerCase() === inp.value.toLowerCase());
  if (exact) renderChipsFor(prefix, exact);
  else { const chips = document.getElementById(prefix + 'Chips'); if (chips) chips.innerHTML = ''; }
}
function renderCatDropdown(dropId, prefix, val) {
  const drop = document.getElementById(dropId); if (!drop) return;
  drop.innerHTML = '';
  const filtered = val ? getCats().filter(c => c.toLowerCase().includes(val)) : getCats();
  filtered.forEach(c => {
    const d = document.createElement('div'); d.className = 'cat-opt'; d.textContent = c;
    d.onmousedown = () => { document.getElementById(prefix + 'CatInput').value = c; closeDrop(dropId); renderChipsFor(prefix, c); };
    drop.appendChild(d);
  });
  if (val && !getCats().some(c => c.toLowerCase() === val)) {
    const d = document.createElement('div'); d.className = 'cat-opt new-item';
    d.textContent = 'â• ThÃªm "' + val + '"';
    d.onmousedown = () => {
      const proper = val.charAt(0).toUpperCase() + val.slice(1);
      if (!monthData.categories.includes(proper)) { monthData.categories.push(proper); persist(); }
      document.getElementById(prefix + 'CatInput').value = proper;
      closeDrop(dropId); renderChipsFor(prefix, proper);
      showToast('âœ… ÄÃ£ thÃªm danh má»¥c "' + proper + '"');
    };
    drop.appendChild(d);
  }
  drop.classList.toggle('open', drop.children.length > 0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRODUCT SUGGESTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onProdInput() {
  const inp = document.getElementById('impName'), drop = document.getElementById('prodSugDrop');
  if (!inp || !drop) return;
  const val = inp.value.toLowerCase();
  const matches = val ? (monthData.products || []).filter(p => p.toLowerCase().includes(val)) : (monthData.products || []);
  drop.innerHTML = '';
  if (!matches.length) { drop.classList.remove('open'); return; }
  matches.slice(0, 8).forEach(p => {
    const d = document.createElement('div'); d.className = 'sug-opt'; d.textContent = p;
    d.onmousedown = () => { inp.value = p; drop.classList.remove('open'); };
    drop.appendChild(d);
  });
  drop.classList.add('open');
}
function closeProdSug() { const el = document.getElementById('prodSugDrop'); if (el) el.classList.remove('open'); }
function saveProduct(name) {
  if (!name) return;
  if (!monthData.products) monthData.products = [];
  if (!monthData.products.includes(name)) monthData.products.push(name);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SMAP = {
  'MÃ¬ tÃ´m':        { thu:['BÃ¡n láº» mÃ¬','Combo mÃ¬+trá»©ng','BÃ¡n sá»‰ thÃ¹ng'], chi:['Nháº­p mÃ¬ tÃ´m','PhÃ­ váº­n chuyá»ƒn'] },
  'Trá»©ng gÃ ':      { thu:['BÃ¡n trá»©ng láº»','BÃ¡n vá»‰ 10','BÃ¡n sá»‰'],         chi:['Mua cÃ¡m','Hao há»¥t vá»¡'] },
  'NÆ°á»›c máº¯m':      { thu:['BÃ¡n chai láº»','Combo gia vá»‹'],                  chi:['Nháº­p nÆ°á»›c máº¯m','HÃ ng háº¿t háº¡n'] },
  'Gáº¡o':           { thu:['BÃ¡n gáº¡o láº» kg','BÃ¡n bao 25kg'],                chi:['Nháº­p gáº¡o','PhÃ­ Ä‘Ã³ng gÃ³i'] },
  'Bia/NÆ°á»›c ngá»t': { thu:['BÃ¡n bia láº»','KÃ©t bia'],                        chi:['Nháº­p bia','Äiá»‡n tá»§ láº¡nh'] },
  'BÃ¡nh káº¹o':      { thu:['BÃ¡n láº»','TÃºi quÃ  lá»… Táº¿t'],                     chi:['Nháº­p bÃ¡nh','Bao bÃ¬'] },
  'Thá»§ cÃ´ng':      { thu:['BÃ¡n táº¡i chá»£','ÄÆ¡n online'],                    chi:['NguyÃªn váº­t liá»‡u','CÃ´ng thá»£'] },
  'Rau cá»§':        { thu:['BÃ¡n láº»','Combo rau'],                           chi:['Nháº­p tá»« vÆ°á»n','Hao há»¥t Ãºa'] }
};
const OP_SMAP = {
  utility:['Tiá»n Ä‘iá»‡n','Tiá»n nÆ°á»›c','PhÃ­ internet'],
  transport:['Váº­n chuyá»ƒn nháº­p','Ship giao khÃ¡ch'],
  loss:['HÃ ng há»ng','Tráº£ hÃ ng lá»—i'],
  rental:['ThuÃª máº·t báº±ng','ThuÃª kho'],
  labor:['LÆ°Æ¡ng nhÃ¢n viÃªn','Tiá»n cÃ´ng'],
  other:['Chi phÃ­ phÃ¡t sinh','Tiáº¿p khÃ¡ch']
};
function renderChipsFor(prefix, cat) {
  const isInc = prefix === 'inc';
  const el = document.getElementById(prefix + 'Chips'); if (!el) return;
  el.innerHTML = '';
  const map = SMAP[cat]; if (!map) return;
  (isInc ? map.thu : map.chi).forEach(t => {
    const c = document.createElement('button');
    c.className = 'chip' + (isInc ? '' : ' chi-c');
    c.textContent = (isInc ? 'ğŸ’° ' : 'ğŸ’¸ ') + t;
    c.onclick = () => { const d = document.getElementById(isInc ? 'incDesc' : 'impName'); if (d) d.value = t; };
    el.appendChild(c);
  });
}
function renderOpChips() {
  const t = document.getElementById('opType').value;
  const el = document.getElementById('opChips'); if (!el) return;
  el.innerHTML = '';
  (OP_SMAP[t] || []).forEach(item => {
    const c = document.createElement('button'); c.className = 'chip chi-c'; c.textContent = 'ğŸ’¸ ' + item;
    c.onclick = () => { const d = document.getElementById('opDesc'); if (d) d.value = item; };
    el.appendChild(c);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INCOME / EXPENSE CRUD
   BUG FIX: reset ngÃ y vá» TODAY (khÃ´ng xÃ³a ngÃ y)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addIncome() {
  const desc   = (document.getElementById('incDesc') || {value:''}).value.trim();
  const amount = getRaw('incAmount');
  const date   = (document.getElementById('incDate') || {value:''}).value;
  if (!desc)   { showToast('âš ï¸ Nháº­p mÃ´ táº£!', true); return; }
  if (!amount) { showToast('âš ï¸ Nháº­p sá»‘ tiá»n!', true); return; }
  if (!date)   { showToast('âš ï¸ Chá»n ngÃ y!', true); return; }
  monthData.income.push({ id: Date.now(), desc, amount, date, cat: (document.getElementById('incCatInput') || {value:''}).value });
  persist(); renderAll();
  // FIX: chá»‰ xÃ³a mÃ´ táº£ vÃ  sá»‘ tiá»n â€” GIá»® NGUYÃŠN ngÃ y
  resetFieldsKeepDate('incDesc', 'incAmount');
  showToast('âœ… ÄÃ£ thÃªm khoáº£n thu!');
}
function delIncome(id) { monthData.income = monthData.income.filter(x => x.id !== id); persist(); renderAll(); }

function addImport() {
  const name   = (document.getElementById('impName') || {value:''}).value.trim();
  const qty    = getRaw('impQty');
  const amount = getRaw('impAmount');
  const date   = (document.getElementById('impDate') || {value:''}).value;
  if (!name)   { showToast('âš ï¸ Nháº­p tÃªn hÃ ng!', true); return; }
  if (!amount) { showToast('âš ï¸ Nháº­p thÃ nh tiá»n!', true); return; }
  if (!date)   { showToast('âš ï¸ Chá»n ngÃ y!', true); return; }
  const cat = (document.getElementById('impCatInput') || {value:''}).value;
  monthData.expense.push({ id: Date.now(), desc: 'Nháº­p: ' + name, amount, date, expenseType: 'import', name, qty, cat });
  if (!monthData.inventory[name]) monthData.inventory[name] = { qty: 0, lastPrice: 0 };
  monthData.inventory[name].qty += (qty || 1);
  monthData.inventory[name].lastPrice = qty > 0 ? Math.round(amount / qty) : amount;
  saveProduct(name);
  persist(); renderAll(); renderInventory();
  // FIX: giá»¯ ngÃ y, xÃ³a cÃ¡c field khÃ¡c
  resetFieldsKeepDate('impName', 'impQty', 'impAmount');
  const notice = document.getElementById('expAutofillNotice');
  if (notice) notice.classList.remove('show');
  showToast('âœ… Nháº­p hÃ ng + cáº­p nháº­t kho!');
}
function addOperational() {
  const desc   = (document.getElementById('opDesc') || {value:''}).value.trim();
  const amount = getRaw('opAmount');
  const date   = (document.getElementById('opDate') || {value:''}).value;
  if (!desc)   { showToast('âš ï¸ Nháº­p mÃ´ táº£!', true); return; }
  if (!amount) { showToast('âš ï¸ Nháº­p sá»‘ tiá»n!', true); return; }
  if (!date)   { showToast('âš ï¸ Chá»n ngÃ y!', true); return; }
  monthData.expense.push({ id: Date.now(), desc, amount, date, expenseType: 'operational', cat: document.getElementById('opType').value });
  persist(); renderAll();
  resetFieldsKeepDate('opDesc', 'opAmount');
  showToast('âœ… ÄÃ£ thÃªm chi phÃ­ thÃªm!');
}
function delExpense(id) {
  const item = monthData.expense.find(x => x.id === id);
  if (item && item.expenseType === 'import' && item.name && monthData.inventory[item.name]) {
    monthData.inventory[item.name].qty = Math.max(0, monthData.inventory[item.name].qty - (item.qty || 1));
  }
  monthData.expense = monthData.expense.filter(x => x.id !== id);
  persist(); renderAll(); renderInventory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET HELPERS
   BUG FIX: resetFieldsKeepDate â€” chá»‰ clear
   text/sá»‘, KHÃ”NG Ä‘á»¥ng vÃ o input[type=date]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetFieldsKeepDate(...ids) {
  ids.forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    el.value = ''; el.dataset.raw = '';
  });
  // KhÃ´ng reset date â€” user muá»‘n nháº­p nhiá»u giao dá»‹ch cÃ¹ng ngÃ y
}
function setDateToday(id) {
  const el = document.getElementById(id);
  if (el && !el.value) el.value = TODAY;  // chá»‰ set náº¿u trá»‘ng
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmt  = n => (n || 0).toLocaleString('vi-VN') + 'Ä‘';
const fmtD = d => { try { const [y,m,day] = d.split('-'); return `${day}/${m}`; } catch { return d || ''; } };
const sum  = arr => (arr || []).reduce((s, x) => s + (x.amount || 0), 0);

function persist() { saveMonthData(currentMonth, monthData); buildMonthSelect(); }

function renderAll() { renderSummary(); renderIncTable(); renderExpTable(); }

function renderSummary() {
  const thu = sum(monthData.income), chi = sum(monthData.expense), p = thu - chi;
  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  set('totalThu', fmt(thu)); set('totalChi', fmt(chi));
  const el = document.getElementById('totalProfit');
  if (el) { el.textContent = (p >= 0 ? '+' : '') + fmt(p); el.style.color = p >= 0 ? 'var(--p600)' : 'var(--red)'; }
}

function renderIncTable() {
  const w = document.getElementById('incTableWrap'); if (!w) return;
  if (!monthData.income.length) { w.innerHTML = '<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ khoáº£n thu nÃ o thÃ¡ng nÃ y</div>'; return; }
  const rows = monthData.income.slice().reverse().map(t =>
    `<tr><td>${fmtD(t.date)}</td><td>${t.desc}</td><td class="thu-v">+${fmt(t.amount)}</td>
     <td><button class="del-btn" onclick="delIncome(${t.id})">ğŸ—‘ï¸</button></td></tr>`
  ).join('');
  w.innerHTML = `<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderExpTable() {
  const w = document.getElementById('expTableWrap'); if (!w) return;
  if (!monthData.expense.length) { w.innerHTML = '<div class="empty"><div class="ei">ğŸ’¸</div>ChÆ°a cÃ³ khoáº£n chi nÃ o thÃ¡ng nÃ y</div>'; return; }
  const rows = monthData.expense.slice().reverse().map(t =>
    `<tr><td>${fmtD(t.date)}</td><td>${t.desc}</td>
     <td><span class="tag ${t.expenseType === 'import' ? 'tag-imp' : 'tag-op'}">${t.expenseType === 'import' ? 'ğŸ“¦' : 'âš¡'}</span></td>
     <td class="chi-v">-${fmt(t.amount)}</td>
     <td><button class="del-btn" onclick="delExpense(${t.id})">ğŸ—‘ï¸</button></td></tr>`
  ).join('');
  w.innerHTML = `<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>MÃ´ táº£</th><th>Loáº¡i</th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderInventory() {
  const el = document.getElementById('inventoryList'); if (!el) return;
  const keys = Object.keys(monthData.inventory || {}).filter(k => monthData.inventory[k].qty > 0);
  if (!keys.length) { el.innerHTML = '<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng</div>'; return; }
  el.innerHTML = keys.map(k =>
    `<div class="inv-kho-row"><div class="inv-kho-name">ğŸ·ï¸ ${k}</div><div class="inv-qty">${monthData.inventory[k].qty} cÃ¡i</div><div class="inv-price">${fmt(monthData.inventory[k].lastPrice)}/cÃ¡i</div></div>`
  ).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Lá»ŠCH Sá»¬ â€” Ä‘á»c tá»« localStorage, khÃ´ng lÆ°u thÃªm
   Chá»‰ Ä‘á»c â€“ gá»™p táº¡m â€“ hiá»ƒn thá»‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getAllTransactions() {
  // Gom dá»¯ liá»‡u tá»« táº¥t cáº£ thÃ¡ng Ä‘Ã£ lÆ°u â€” khÃ´ng táº¡o key má»›i
  const allKeys = getMonthOptions();
  const all = [];
  allKeys.forEach(monthKey => {
    const d = loadMonthData(monthKey);
    (d.income || []).forEach(x => all.push({ ...x, monthKey, type: 'thu', cat: x.cat || '' }));
    (d.expense || []).forEach(x => all.push({ ...x, monthKey, type: 'chi', cat: x.cat || x.expenseType || '' }));
  });
  // Sort by date desc
  return all.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
}

function renderHistory() {
  const all     = getAllTransactions();
  const search  = (document.getElementById('histSearch') || {value:''}).value.toLowerCase();
  const typeF   = (document.getElementById('histTypeFilter') || {value:''}).value;
  const monthF  = (document.getElementById('histCatFilter') || {value:''}).value;

  // Build month filter options
  const allMonths = [...new Set(all.map(x => x.monthKey))];
  const catSel = document.getElementById('histCatFilter');
  if (catSel) {
    const cur = catSel.value;
    catSel.innerHTML = '<option value="">Táº¥t cáº£ thÃ¡ng</option>' +
      allMonths.map(m => `<option value="${m}"${m === cur ? ' selected' : ''}>${monthToLabel(m)}</option>`).join('');
  }

  // Filter â€” khÃ´ng Ä‘á»¥ng gÃ¬ vÃ o localStorage
  const filtered = all.filter(x => {
    if (search && !(x.desc || '').toLowerCase().includes(search)) return false;
    if (typeF && x.type !== typeF) return false;
    if (monthF && x.monthKey !== monthF) return false;
    return true;
  });

  // Totals tá»« filtered
  const allThu  = filtered.filter(x => x.type === 'thu').reduce((s,x) => s + x.amount, 0);
  const allChi  = filtered.filter(x => x.type === 'chi').reduce((s,x) => s + x.amount, 0);
  const allProfit = allThu - allChi;
  const set = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  set('histAllThu', fmt(allThu));
  set('histAllChi', fmt(allChi));
  const pe = document.getElementById('histAllProfit');
  if (pe) { pe.textContent = (allProfit >= 0 ? '+' : '') + fmt(allProfit); pe.style.color = allProfit >= 0 ? 'var(--p600)' : 'var(--red)'; }

  const w = document.getElementById('histTableWrap'); if (!w) return;
  if (!filtered.length) { w.innerHTML = '<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch nÃ o</div>'; return; }

  const rows = filtered.map(x => {
    const isT = x.type === 'thu';
    const tag = isT ? '<span class="tag tag-thu">ğŸ’° Thu</span>' : `<span class="tag ${x.expenseType==='import'?'tag-imp':'tag-op'}">${x.expenseType==='import'?'ğŸ“¦ Nháº­p':'âš¡ Chi phÃ­'}</span>`;
    // Click row â†’ jump to that month
    return `<tr class="hist-row-clickable" onclick="jumpToMonth('${x.monthKey}')">
      <td>${fmtD(x.date)}</td>
      <td>${tag}</td>
      <td>${x.cat || 'â€”'}</td>
      <td>${x.desc || ''}</td>
      <td class="${isT ? 'thu-v' : 'chi-v'}">${isT ? '+' : '-'}${fmt(x.amount)}</td>
      <td><span class="jump-badge">${monthToLabel(x.monthKey)}</span></td>
    </tr>`;
  }).join('');

  w.innerHTML = `<div class="tbl-wrap"><table>
    <thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>NhÃ³m</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>ThÃ¡ng</th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
}

// Click giao dá»‹ch â†’ nháº£y vá» thÃ¡ng Ä‘Ã³
function jumpToMonth(key) {
  currentMonth = key; monthData = loadMonthData(key);
  buildMonthSelect(); renderAll();
  // Switch to income tab
  const navBtns = document.querySelectorAll('nav button');
  switchTab('income', navBtns[0]);
  showToast(`âœ… ÄÃ£ chuyá»ƒn sang ${monthToLabel(key)}`);
}

// Xuáº¥t toÃ n bá»™ CSV
function exportAllCSV() {
  const all = getAllTransactions();
  if (!all.length) { showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!', true); return; }
  const rows = [
    'NgÃ y,Loáº¡i,NhÃ³m,MÃ´ táº£,Sá»‘ tiá»n,ThÃ¡ng',
    ...all.map(x => `"${x.date}","${x.type}","${x.cat||''}","${(x.desc||'').replace(/"/g,'""')}","${x.amount}","${x.monthKey}"`)
  ].join('\n');
  copyRaw(rows, 'ğŸ“¥ ÄÃ£ sao chÃ©p CSV toÃ n bá»™ lá»‹ch sá»­!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(parts) {
  if (!API_KEY) throw new Error('ChÆ°a cÃ³ API Key â€” vui lÃ²ng nháº­p key á»Ÿ pháº§n Ä‘áº§u.');
  const res = await fetch(`${GEMINI_URL}?key=${API_KEY}`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts }] })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
  const data = await res.json();
  if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
  const content = data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!content) throw new Error('Gemini khÃ´ng tráº£ vá» ná»™i dung. Thá»­ láº¡i sau.');
  return content;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN bÃªn CHI (nháº­p hÃ ng)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleInvoiceImg(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    invoiceBase64 = ev.target.result.split(',')[1];
    const img = document.getElementById('invoicePreview');
    if (img) { img.src = ev.target.result; img.style.display = 'block'; }
    const btn = document.getElementById('scanBtn');
    if (btn) btn.disabled = false;
  };
  r.readAsDataURL(f);
}

const INVOICE_PROMPT = `Báº¡n lÃ  trá»£ lÃ½ quáº£n lÃ½ kho. TrÃ­ch xuáº¥t tá»« áº£nh hÃ³a Ä‘Æ¡n nÃ y.
Tráº£ vá» JSON há»£p lá»‡, khÃ´ng cÃ³ markdown, Ä‘Ãºng format:
{"rows":[{"ten":"tÃªn hÃ ng","soluong":"sá»‘ lÆ°á»£ng","dongia":"Ä‘Æ¡n giÃ¡","thanhtien":"thÃ nh tiá»n"}]}
Chá»‰ JSON, khÃ´ng text khÃ¡c.`;

async function scanInvoice() {
  if (!API_KEY) { showToast('âš ï¸ Nháº­p API Key!', true); return; }
  const loader = document.getElementById('scanLoader');
  const wrap   = document.getElementById('invoiceTableWrap');
  const acts   = document.getElementById('invActions');
  const btn    = document.getElementById('scanBtn');
  if (loader) loader.classList.add('show');
  if (wrap)  { wrap.classList.remove('show'); wrap.innerHTML = ''; }
  if (acts)  acts.style.display = 'none';
  if (btn)   btn.disabled = true;
  invoiceData = [];
  const notice = document.getElementById('expAutofillNotice');
  if (notice) notice.classList.remove('show');
  try {
    const raw = await callGemini([{ inline_data: { mime_type: 'image/jpeg', data: invoiceBase64 } }, { text: INVOICE_PROMPT }]);
    let parsed = null;
    try { parsed = JSON.parse(raw.replace(/```json|```/g, '').trim()); } catch {}
    if (loader) loader.classList.remove('show');
    if (parsed && parsed.rows && parsed.rows.length) {
      invoiceData = parsed.rows;
      renderInvoiceTable('invoiceTableWrap', parsed.rows);
      if (wrap) wrap.classList.add('show');
      if (acts) acts.style.display = 'flex';
    } else {
      if (wrap) { wrap.innerHTML = `<div style="padding:12px;font-size:.84rem;white-space:pre-wrap">${raw}</div>`; wrap.classList.add('show'); }
    }
  } catch (err) { if (loader) loader.classList.remove('show'); showToast('âŒ ' + err.message, true); }
  if (btn) btn.disabled = false;
}

function renderInvoiceTable(wrapId, rows) {
  const w = document.getElementById(wrapId); if (!w) return;
  const rowsHtml = rows.map(r =>
    `<tr><td>${r.ten||''}</td><td style="text-align:center">${r.soluong||''}</td>
     <td style="text-align:right">${r.dongia||''}</td>
     <td style="text-align:right;font-weight:800;color:var(--p700)">${r.thanhtien||''}</td></tr>`
  ).join('');
  w.innerHTML = `<table class="inv-tbl"><thead><tr><th>TÃªn hÃ ng</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
}

// Tá»± nháº­p Chi tá»« hÃ³a Ä‘Æ¡n (láº¥y dÃ²ng Ä‘áº§u tiÃªn)
function autoFillImport() {
  if (!invoiceData.length) { showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!', true); return; }
  const first = invoiceData[0];
  // Fill form nháº­p hÃ ng thá»§ cÃ´ng
  const name = document.getElementById('impName');
  const qty  = document.getElementById('impQty');
  const amt  = document.getElementById('impAmount');
  if (name) name.value = first.ten || '';
  if (qty)  { const q = (first.soluong || '').replace(/\D/g,''); qty.dataset.raw = q; qty.value = q ? parseInt(q).toLocaleString('vi-VN') : ''; }
  // Parse thÃ nh tiá»n
  const rawAmt = (first.thanhtien || '').replace(/\D/g,'');
  if (amt && rawAmt) { amt.dataset.raw = rawAmt; amt.value = parseInt(rawAmt).toLocaleString('vi-VN'); }
  const notice = document.getElementById('expAutofillNotice');
  if (notice) notice.classList.add('show');
  showToast('âœ… ÄÃ£ Ä‘iá»n dÃ²ng Ä‘áº§u tiÃªn vÃ o form â€” kiá»ƒm tra rá»“i báº¥m nháº­p!');
}

async function copyRaw(text, msg) {
  let ok = false;
  try {
    if (window.isSecureContext && navigator.clipboard?.writeText) { await navigator.clipboard.writeText(text); ok = true; }
    else {
      const ta = document.createElement('textarea'); ta.value = text;
      ta.style.cssText = 'position:fixed;top:-9999px;opacity:0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      ok = document.execCommand('copy'); document.body.removeChild(ta);
    }
  } catch {}
  showToast(ok ? msg : 'âŒ KhÃ´ng sao chÃ©p Ä‘Æ°á»£c', !ok);
}
function copyInvoiceCSV() {
  if (!invoiceData.length) { showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!', true); return; }
  const csv = ['TÃªn hÃ ng,Sá»‘ lÆ°á»£ng,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',
    ...invoiceData.map(r => `"${r.ten||''}","${r.soluong||''}","${r.dongia||''}","${r.thanhtien||''}"`)
  ].join('\n');
  copyRaw(csv, 'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');
}
function copyInvoiceText() {
  const text = invoiceData.map(r => `â€¢ ${r.ten} | SL: ${r.soluong} | ${r.thanhtien}`).join('\n');
  copyRaw(text, 'ğŸ“‹ ÄÃ£ sao chÃ©p text!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN bÃªn THU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function incScanMode(mode, btn) {
  document.querySelectorAll('.modal-sub-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const imgEl = document.getElementById('incScanImg');
  const qrEl  = document.getElementById('incScanQR');
  if (imgEl) imgEl.style.display = mode === 'img' ? 'block' : 'none';
  if (qrEl)  qrEl.style.display  = mode === 'qr'  ? 'block' : 'none';
  if (mode === 'qr' && incQRScanner) stopIncQR();
}

function handleIncInvoice(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    incInvoiceBase64 = ev.target.result.split(',')[1];
    const img = document.getElementById('incInvoicePreview');
    if (img) { img.src = ev.target.result; img.style.display = 'block'; }
    const btn = document.getElementById('scanIncBtn');
    if (btn) btn.disabled = false;
  };
  r.readAsDataURL(f);
}

async function scanIncInvoice() {
  if (!API_KEY) { showToast('âš ï¸ Nháº­p API Key!', true); return; }
  const loader = document.getElementById('scanIncLoader');
  const wrap   = document.getElementById('incInvoiceTableWrap');
  const btn    = document.getElementById('scanIncBtn');
  if (loader) loader.classList.add('show');
  if (wrap)  { wrap.classList.remove('show'); wrap.innerHTML = ''; }
  if (btn)   btn.disabled = true;
  incInvoiceData = [];
  const notice = document.getElementById('incAutofillNotice');
  if (notice) notice.classList.remove('show');

  // Prompt cho má»¥c Thu: láº¥y tá»•ng tiá»n vÃ  tÃªn hÃ ng
  const prompt = `Báº¡n lÃ  trá»£ lÃ½ bÃ¡n hÃ ng. ÄÃ¢y lÃ  hÃ³a Ä‘Æ¡n bÃ¡n hÃ ng hoáº·c phiáº¿u thu.
TrÃ­ch xuáº¥t thÃ´ng tin bÃ¡n hÃ ng. Tráº£ vá» JSON há»£p lá»‡ khÃ´ng markdown:
{"items":[{"ten":"tÃªn máº·t hÃ ng","soluong":"sá»‘ lÆ°á»£ng","thanhtien":"thÃ nh tiá»n"}],"tongtien":"tá»•ng tiá»n cáº£ hÃ³a Ä‘Æ¡n","ngay":"ngÃ y ghi trÃªn hÃ³a Ä‘Æ¡n náº¿u cÃ³ (YYYY-MM-DD), náº¿u khÃ´ng cÃ³ Ä‘á»ƒ rá»—ng"}
Chá»‰ JSON.`;

  try {
    const raw = await callGemini([{ inline_data: { mime_type: 'image/jpeg', data: incInvoiceBase64 } }, { text: prompt }]);
    let parsed = null;
    try { parsed = JSON.parse(raw.replace(/```json|```/g, '').trim()); } catch {}
    if (loader) loader.classList.remove('show');
    if (parsed) {
      incInvoiceData = parsed.items || [];
      if (incInvoiceData.length) renderInvoiceTable('incInvoiceTableWrap', incInvoiceData.map(x => ({ ten: x.ten, soluong: x.soluong, dongia: '', thanhtien: x.thanhtien })));
      if (wrap) wrap.classList.add('show');
      // Auto-fill form Thu
      const totalRaw = (parsed.tongtien || '').replace(/\D/g,'');
      const descVal  = incInvoiceData.length ? incInvoiceData.map(x => x.ten).join(', ') : '';
      const descEl   = document.getElementById('incDesc');
      const amtEl    = document.getElementById('incAmount');
      const dateEl   = document.getElementById('incDate');
      if (descEl && descVal) descEl.value = 'BÃ¡n ' + descVal;
      if (amtEl && totalRaw) { amtEl.dataset.raw = totalRaw; amtEl.value = parseInt(totalRaw).toLocaleString('vi-VN'); }
      if (dateEl && parsed.ngay && /^\d{4}-\d{2}-\d{2}$/.test(parsed.ngay)) dateEl.value = parsed.ngay;
      if (notice) notice.classList.add('show');
      showToast('âœ… AI Ä‘Ã£ Ä‘iá»n vÃ o form Thu bÃªn dÆ°á»›i!');
    } else {
      if (wrap) { wrap.innerHTML = `<div style="padding:12px;font-size:.84rem;white-space:pre-wrap">${raw}</div>`; wrap.classList.add('show'); }
    }
  } catch (err) { if (loader) loader.classList.remove('show'); showToast('âŒ ' + err.message, true); }
  if (btn) btn.disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR bÃªn THU (inline, khÃ´ng modal)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startIncQR() {
  const container = document.getElementById('qr-inc-container');
  const startBtn  = document.getElementById('startIncQRBtn');
  const stopBtn   = document.getElementById('stopIncQRBtn');
  if (typeof Html5Qrcode === 'undefined') {
    if (container) container.innerHTML = `<div class="qr-fallback">âš ï¸ ThÆ° viá»‡n QR chÆ°a load.<br>ThÃªm: <code>&lt;script src="https://unpkg.com/html5-qrcode"&gt;&lt;/script&gt;</code><br>vÃ o &lt;head&gt; rá»“i reload.</div>`;
    return;
  }
  if (container) container.innerHTML = '<div id="qr-inc-reader" style="width:100%"></div>';
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn)  stopBtn.style.display  = '';
  try {
    incQRScanner = new Html5Qrcode('qr-inc-reader');
    incQRScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: 200 },
      qrText => {
        let amount = '', name = '';
        try { const p = JSON.parse(qrText); amount = String(p.amount || p.sotien || ''); name = p.name || p.ten || ''; }
        catch { amount = qrText.replace(/\D/g,''); }
        const amtEl  = document.getElementById('incAmount');
        const descEl = document.getElementById('incDesc');
        if (amtEl && amount) { amtEl.dataset.raw = amount; amtEl.value = parseInt(amount).toLocaleString('vi-VN'); }
        if (descEl && name)  descEl.value = name;
        stopIncQR();
        showToast('âœ… QuÃ©t QR thÃ nh cÃ´ng â€” kiá»ƒm tra vÃ  báº¥m ThÃªm khoáº£n thu!');
      },
      () => {}
    ).catch(err => {
      if (container) container.innerHTML = `<div class="qr-fallback">âŒ KhÃ´ng má»Ÿ camera: ${err}</div>`;
      if (startBtn) startBtn.style.display = '';
      if (stopBtn)  stopBtn.style.display  = 'none';
    });
  } catch (err) {
    if (container) container.innerHTML = `<div class="qr-fallback">âŒ ${err}</div>`;
  }
}
function stopIncQR() {
  if (incQRScanner) { incQRScanner.stop().catch(() => {}); incQRScanner = null; }
  const startBtn = document.getElementById('startIncQRBtn');
  const stopBtn  = document.getElementById('stopIncQRBtn');
  if (startBtn) startBtn.style.display = '';
  if (stopBtn)  stopBtn.style.display  = 'none';
  const container = document.getElementById('qr-inc-container');
  if (container) container.innerHTML = '<div class="qr-fallback" id="qrIncFallback"><div style="font-size:1.8rem;margin-bottom:6px">ğŸ“·</div><p>Báº¥m nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ má»Ÿ camera QR</p></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FACEBOOK POST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFbImg(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    fbBase64 = ev.target.result.split(',')[1];
    const img = document.getElementById('fbPreview');
    if (img) { img.src = ev.target.result; img.style.display = 'block'; }
    const btn = document.getElementById('fbPostBtn'); if (btn) btn.disabled = false;
  };
  r.readAsDataURL(f);
}
async function generateFbPost() {
  if (!API_KEY || !fbBase64) { showToast('âš ï¸ Cáº§n API Key vÃ  áº£nh!', true); return; }
  const card = document.getElementById('fbResultCard');
  const loader = document.getElementById('fbLoader');
  const box = document.getElementById('fbPost');
  const btn = document.getElementById('copyFb');
  const postBtn = document.getElementById('fbPostBtn');
  if (card) card.style.display = 'block';
  if (loader) loader.classList.add('show');
  if (box) box.classList.remove('show');
  if (btn) btn.classList.remove('show');
  if (postBtn) postBtn.disabled = true;
  const prompt = `PhÃ¢n tÃ­ch áº£nh sáº£n pháº©m. Tráº£ vá» JSON há»£p lá»‡ (khÃ´ng markdown):
{"productName":"tÃªn ngáº¯n","category":"MÃ¬ tÃ´m|Trá»©ng gÃ |NÆ°á»›c máº¯m|Gáº¡o|Bia/NÆ°á»›c ngá»t|BÃ¡nh káº¹o|Thá»§ cÃ´ng|Rau cá»§|KhÃ¡c","fbPost":"BÃ i Ä‘Äƒng Facebook hoÃ n chá»‰nh vá»›i emoji vÃ  hashtag","tiktokIdea":"Ã tÆ°á»Ÿng TikTok 1 cÃ¢u"}`;
  try {
    const raw = await callGemini([{ inline_data: { mime_type: 'image/jpeg', data: fbBase64 } }, { text: prompt }]);
    let parsed = null; try { parsed = JSON.parse(raw.replace(/```json|```/g, '').trim()); } catch {}
    if (loader) loader.classList.remove('show');
    if (parsed) {
      const ttEl = document.getElementById('ttProduct'); if (ttEl) ttEl.value = parsed.productName || '';
      const incCat = document.getElementById('incCatInput'); if (incCat) incCat.value = parsed.category || '';
      const impCat = document.getElementById('impCatInput'); if (impCat) impCat.value = parsed.category || '';
      const det = document.getElementById('fbDetected');
      if (det) { det.style.display = 'block'; det.innerHTML = `âœ… <strong>${parsed.productName}</strong> Â· ${parsed.category}`; }
      if (box) box.textContent = parsed.fbPost || raw;
    } else { if (box) box.textContent = raw; }
    if (box) box.classList.add('show');
    if (btn) btn.classList.add('show');
  } catch (err) {
    if (loader) loader.classList.remove('show');
    if (box) { box.textContent = 'âŒ ' + err.message; box.classList.add('show'); }
    showToast('âŒ ' + err.message, true);
  }
  if (postBtn) postBtn.disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIKTOK SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generateScript() {
  if (!API_KEY) { showToast('âš ï¸ Nháº­p API Key!', true); return; }
  const ttEl = document.getElementById('ttProduct');
  const product = ttEl ? ttEl.value.trim() : '';
  if (!product) { showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!', true); return; }
  const roleMap = { ba:'bÃ ', chu:'chÃº', me:'máº¹', ban:'báº¡n' };
  const roleEl  = document.getElementById('ttRole');
  const xung    = roleMap[roleEl ? roleEl.value : 'ban'] || 'báº¡n';
  const xungCap = xung.charAt(0).toUpperCase() + xung.slice(1);
  const card = document.getElementById('videoResult'), loader = document.getElementById('videoLoader');
  const box = document.getElementById('scriptBox'), btn = document.getElementById('copyScript');
  const sbtn = document.getElementById('scriptBtn');
  if (card) card.style.display = 'block';
  if (loader) loader.classList.add('show');
  if (box) box.classList.remove('show');
  if (btn) btn.classList.remove('show');
  if (sbtn) sbtn.disabled = true;
  const prompt = `Báº¡n lÃ  ngÆ°á»i chÃ¡u hiáº¿u tháº£o, hÆ°á»›ng dáº«n ${xung} quay TikTok bÃ¡n "${product}".
NgÃ´n ngá»¯ cá»±c Ä‘Æ¡n giáº£n, xÆ°ng hÃ´ "con/chÃ¡u" vÃ  "${xung}". ÄÃºng 3 bÆ°á»›c:
BÆ¯á»šC 1 â€” CHUáº¨N Bá»Š: CÃ¡ch Ä‘áº·t Ä‘iá»‡n thoáº¡i vÃ  Ä‘á»©ng á»Ÿ Ä‘Ã¢u.
BÆ¯á»šC 2 â€” HÃ€NH Äá»˜NG: 1 viá»‡c ${xung} lÃ m vá»›i sáº£n pháº©m.
BÆ¯á»šC 3 â€” Lá»œI NÃ“I: 2-3 cÃ¢u ngáº¯n ${xung} Ä‘á»c theo Ä‘Æ°á»£c.
KHÃ”NG dÃ¹ng: gÃ³c mÃ¡y, medium shot, Ã¡nh sÃ¡ng ká»¹ thuáº­t, dá»±ng video, chuyá»ƒn cáº£nh.
Káº¿t thÃºc: "${xungCap} khÃ´ng cáº§n chá»‰nh sá»­a gÃ¬ cáº£, cá»© quay xong Ä‘Äƒng luÃ´n â€” sá»± chÃ¢n cháº¥t chÃ­nh lÃ  Ä‘iá»ƒm cá»™ng Ä‘Ã³ ${xung} Æ¡i! ğŸ’š"`;
  try {
    const text = await callGemini([{ text: prompt }]);
    if (loader) loader.classList.remove('show');
    if (box) { box.textContent = text; box.classList.add('show'); }
    if (btn) btn.classList.add('show');
  } catch (err) {
    if (loader) loader.classList.remove('show');
    if (box) { box.textContent = 'âŒ ' + err.message; box.classList.add('show'); }
    showToast('âŒ ' + err.message, true);
  }
  if (sbtn) sbtn.disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS â€” destroy trÆ°á»›c khi táº¡o má»›i
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function destroyCharts() {
  Object.keys(chartInst).forEach(k => { if (chartInst[k]) { try { chartInst[k].destroy(); } catch {} chartInst[k] = null; } });
}
function refreshCharts() {
  destroyCharts();
  const thu = sum(monthData.income);
  const imp = monthData.expense.filter(x => x.expenseType === 'import').reduce((s,x) => s + x.amount, 0);
  const op  = monthData.expense.filter(x => x.expenseType === 'operational').reduce((s,x) => s + x.amount, 0);
  const hasData = thu > 0 || imp > 0 || op > 0;
  const noData = document.getElementById('noChartData');
  const content = document.getElementById('chartContent');
  if (noData)  noData.style.display  = hasData ? 'none'  : 'block';
  if (content) content.style.display = hasData ? 'block' : 'none';
  if (!hasData) return;
  const pieCanvas = document.getElementById('pieChart');
  if (pieCanvas) chartInst.pie = new Chart(pieCanvas, {
    type: 'doughnut',
    data: { labels: ['Thu','Nháº­p hÃ ng','Chi phÃ­ thÃªm'], datasets: [{ data: [thu, imp, op], backgroundColor: ['#1B6B3A','#0C5460','#856404'], borderWidth: 0, hoverOffset: 8 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, padding: 7 } } } }
  });
  const expItems = [...new Set(monthData.expense.map(x => x.desc))].slice(0, 5);
  const expVals  = expItems.map(desc => monthData.expense.filter(x => x.desc === desc).reduce((s,x) => s + x.amount, 0));
  const barCanvas = document.getElementById('barChart');
  if (barCanvas) chartInst.bar = new Chart(barCanvas, {
    type: 'bar',
    data: { labels: expItems.length ? expItems : ['ChÆ°a cÃ³'], datasets: [{ label: 'Ä‘', data: expItems.length ? expVals : [0], backgroundColor: 'rgba(27,107,58,.72)', borderRadius: 7, borderSkipped: false }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#eee' } }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } } }
  });
  const days = [], thuLine = [], chiLine = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const isoDate = d.toISOString().slice(0, 10);
    days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);
    thuLine.push(monthData.income .filter(x => x.date === isoDate).reduce((s,x) => s + x.amount, 0));
    chiLine.push(monthData.expense.filter(x => x.date === isoDate).reduce((s,x) => s + x.amount, 0));
  }
  const lineCanvas = document.getElementById('lineChart');
  if (lineCanvas) chartInst.line = new Chart(lineCanvas, {
    type: 'line',
    data: { labels: days, datasets: [
      { label: 'Thu', data: thuLine, borderColor: '#1B6B3A', backgroundColor: 'rgba(27,107,58,.08)', tension: .4, fill: true, pointRadius: 4, pointBackgroundColor: '#1B6B3A' },
      { label: 'Chi', data: chiLine, borderColor: '#D94F3D', backgroundColor: 'rgba(217,79,61,.06)', tension: .4, fill: true, pointRadius: 4, pointBackgroundColor: '#D94F3D' }
    ]},
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
      scales: { y: { beginAtZero: true, grid: { color: '#eee' }, ticks: { callback: v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : (v/1e3)+'K' } }, x: { grid: { display: false } } } }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendChat() {
  const inp = document.getElementById('chatInp');
  const msg = inp ? inp.value.trim() : '';
  if (!msg) return;
  if (!API_KEY) { showToast('âš ï¸ Nháº­p API Key!', true); return; }
  if (inp) inp.value = '';
  addMsg(msg, 'user');
  const typing = document.getElementById('chatTyping'); if (typing) typing.classList.add('show');
  scrollChat();
  try {
    const text = await callGemini([{ text: `Báº¡n lÃ  Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, chuyÃªn tÆ° váº¥n há»™ kinh doanh nhá» táº¡i Viá»‡t Nam. Ngáº¯n gá»n, thá»±c táº¿, dÃ¹ng emoji.\n\nCÃ¢u há»i: ${msg}` }]);
    if (typing) typing.classList.remove('show'); addMsg(text, 'bot');
  } catch (err) { if (typing) typing.classList.remove('show'); addMsg('âŒ ' + err.message, 'bot'); }
}
function addMsg(text, role) {
  const msgs = document.getElementById('chatMsgs'); if (!msgs) return;
  const div = document.createElement('div'); div.className = 'msg ' + role; div.textContent = text;
  msgs.insertBefore(div, document.getElementById('chatTyping')); scrollChat();
}
function scrollChat() { const m = document.getElementById('chatMsgs'); if (m) m.scrollTop = m.scrollHeight; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg, isErr = false) {
  const t = document.getElementById('toast'); if (!t) return;
  t.textContent = msg; t.className = isErr ? 'err' : ''; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 2600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Set ngÃ y máº·c Ä‘á»‹nh = hÃ´m nay cho táº¥t cáº£ form date
['incDate','impDate','opDate'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.value = TODAY;  // dÃ¹ng string trá»±c tiáº¿p, khÃ´ng dÃ¹ng valueAsDate Ä‘á»ƒ trÃ¡nh timezone shift
});

buildMonthSelect();
renderAll();
</script>
</body>
</html>
