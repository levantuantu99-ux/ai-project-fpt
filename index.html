<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--a600:#D4881A;
  --red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#FFFFFF;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.11);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--surface);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}

/* HEADER */
header{background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:16px 20px 13px;text-align:center;position:sticky;top:0;z-index:300;box-shadow:0 2px 12px rgba(0,0,0,.22)}
header h1{font-size:1.45rem;font-weight:800}
header p{font-size:.76rem;opacity:.76;margin-top:2px}
.badge{background:var(--a400);color:#1A2E23;font-size:.6rem;font-weight:900;padding:2px 8px;border-radius:20px;margin-left:6px;vertical-align:middle}

/* API BANNER */
#apiSetup{background:#FFFDE7;border-bottom:2px solid var(--a400);padding:12px 16px;display:flex;align-items:center;flex-wrap:wrap;gap:8px}
#apiSetup label{font-size:.8rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:160px;padding:9px 12px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.88rem}
#apiKeyInput:focus{outline:none;border-color:var(--a600)}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:9px 14px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.84rem;transition:.18s}
#saveKeyBtn:hover{background:var(--a600);color:#fff}
#apiStatus{font-size:.76rem;width:100%;margin-top:-2px}

/* MONTH BAR */
#monthBar{background:var(--card);border-bottom:2px solid var(--border);padding:9px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;position:sticky;top:54px;z-index:290}
#monthBar label{font-size:.78rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:7px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
#monthSelect:focus{outline:none;border-color:var(--p600)}
.month-badge{font-size:.72rem;background:var(--p50);color:var(--p600);padding:4px 11px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto;white-space:nowrap}

/* NAV */
nav{display:flex;background:var(--card);border-bottom:2px solid var(--border);position:sticky;top:98px;z-index:280;overflow-x:auto}
nav button{flex:1;min-width:65px;padding:11px 5px;border:none;background:none;font-size:.7rem;font-weight:800;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;border-bottom:3px solid transparent;transition:.18s;white-space:nowrap}
nav button .ni{font-size:1.3rem}
nav button:hover{background:var(--p50);color:var(--p600)}
nav button.active{color:var(--p600);border-bottom-color:var(--p600);background:var(--p50)}

/* SECTIONS */
.section{display:none;padding:13px;max-width:640px;margin:0 auto}
.section.active{display:block}

/* CARD */
.card{background:var(--card);border-radius:var(--r-md);padding:17px;margin-bottom:13px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}
.card-title{font-size:.97rem;font-weight:800;color:var(--p700);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.card-sub{font-size:.78rem;color:var(--muted);margin-top:-8px;margin-bottom:12px}

/* FORM */
.field{margin-bottom:11px}
.field label{font-size:.76rem;font-weight:800;color:var(--muted);display:block;margin-bottom:4px}
.inp{width:100%;padding:12px 13px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.92rem;font-family:var(--font);background:#fff;color:var(--text);transition:.18s}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.09)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
@media(max-width:380px){.row2{grid-template-columns:1fr}}

/* PRODUCT CATEGORY INPUT */
.cat-wrap{position:relative}
.cat-input-row{display:flex;gap:6px}
.cat-input{flex:1}
.cat-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--border);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:100;max-height:200px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.cat-dropdown.open{display:block}
.cat-opt{padding:11px 14px;cursor:pointer;font-size:.9rem;border-bottom:1px solid var(--border);transition:.15s}
.cat-opt:last-child{border-bottom:none}
.cat-opt:hover{background:var(--p50);color:var(--p600)}
.cat-opt.new-tag{color:var(--p600);font-weight:800;font-style:italic}

/* BUTTONS */
.btn{width:100%;padding:14px;border:none;border-radius:var(--r-md);font-size:.93rem;font-weight:800;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;font-family:var(--font)}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.25)}
.btn-primary:hover:not(:disabled){background:var(--p700);transform:translateY(-1px);box-shadow:0 5px 16px rgba(27,107,58,.3)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn .bi{font-size:1.1rem}

/* UPLOAD */
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:28px 14px;text-align:center;cursor:pointer;transition:.2s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100);transform:translateY(-2px)}
.upload-area .u-icon{font-size:2.6rem;margin-bottom:7px}
.upload-area strong{display:block;font-size:.9rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.74rem}
.preview-img{width:100%;max-height:220px;object-fit:cover;border-radius:var(--r-sm);margin-top:11px;display:none;border:3px solid var(--p300)}

/* COPY BUTTON â€” reusable */
.copy-btn{display:none;align-items:center;gap:7px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:9px 17px;border-radius:var(--r-sm);font-size:.82rem;font-weight:800;cursor:pointer;margin-top:9px;transition:.2s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}

/* RESULT BOX */
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:14px;margin-top:11px;white-space:pre-wrap;font-size:.86rem;line-height:1.72;max-height:300px;overflow-y:auto;display:none}
.result-box.show{display:block}

/* LOADER */
.loader{display:none;text-align:center;padding:20px}
.loader.show{display:block}
.spinner{width:38px;height:38px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 9px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.85rem}

/* SUB TABS */
.sub-tabs{display:flex;gap:7px;margin-bottom:13px;flex-wrap:wrap}
.sub-tab{padding:8px 16px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.8rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* CHIPS */
.chip-group{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:11px;min-height:10px}
.chip{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:5px 12px;border-radius:20px;font-size:.76rem;font-weight:800;cursor:pointer;transition:.18s}
.chip:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.chip.chi-c{border-color:#F5C6C0;color:var(--red)}
.chip.chi-c:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:.83rem}
thead tr{background:var(--p600)}
th{padding:10px 11px;text-align:left;color:#fff;font-size:.76rem;font-weight:800;white-space:nowrap}
th:first-child{border-radius:var(--r-sm) 0 0 0}th:last-child{border-radius:0 var(--r-sm) 0 0}
td{padding:10px 11px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800}
.chi-v{color:var(--red);font-weight:800}
.del-btn{background:none;border:none;cursor:pointer;font-size:.95rem;padding:4px 7px;border-radius:6px;transition:.15s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:3px 8px;border-radius:9px;font-size:.7rem;font-weight:800;white-space:nowrap}
.tag-thu{background:#D4EDDA;color:var(--p700)}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-op{background:#FFF3CD;color:#856404}

/* SUMMARY */
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-bottom:13px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:13px 10px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.7rem;font-weight:800;color:var(--muted);margin-bottom:3px}
.s-val{font-size:1rem;font-weight:900}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:13px}
@media(max-width:480px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:13px;border:1px solid var(--border)}
.ch-card h3{font-size:.8rem;font-weight:800;color:var(--p700);margin-bottom:9px;text-align:center}
.ch-wrap{position:relative;height:165px}
.ch-full{position:relative;height:185px}

/* CHAT */
.chat-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;box-shadow:var(--shadow-md);border:1px solid var(--border)}
.chat-head{background:var(--p600);color:#fff;padding:13px 17px;display:flex;align-items:center;gap:11px}
.chat-av{width:36px;height:36px;border-radius:50%;background:var(--a400);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.chat-title{font-weight:800;font-size:.92rem}
.chat-status{font-size:.68rem;opacity:.75;font-weight:400}
.chat-msgs{padding:13px;max-height:290px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.msg{max-width:85%;padding:10px 13px;border-radius:17px;font-size:.85rem;line-height:1.55}
.msg.bot{background:var(--p50);border:1.5px solid var(--p100);align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:var(--p600);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.typing{display:none;align-self:flex-start}
.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:10px 14px;background:var(--p50);border:1.5px solid var(--p100);border-radius:17px;border-bottom-left-radius:4px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-7px)}}
.chat-foot{display:flex;gap:7px;padding:11px 13px;border-top:2px solid var(--border);background:var(--surface)}
.chat-inp{flex:1;padding:10px 13px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.88rem;font-family:var(--font)}
.chat-inp:focus{outline:none;border-color:var(--p600)}
.chat-send{background:var(--p600);color:#fff;border:none;padding:10px 17px;border-radius:var(--r-sm);font-size:1rem;cursor:pointer;transition:.18s}
.chat-send:hover{background:var(--p700)}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:center;justify-content:center;padding:18px}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg);padding:20px;width:100%;max-width:360px;box-shadow:var(--shadow-md)}
.modal h3{font-size:.97rem;font-weight:800;color:var(--p700);margin-bottom:11px}
.modal-close{width:100%;padding:11px;border:2px solid var(--border);background:#fff;border-radius:var(--r-sm);font-weight:800;cursor:pointer;color:var(--muted);font-size:.86rem;margin-top:10px;transition:.18s}
.modal-close:hover{background:var(--red-bg);color:var(--red)}

/* QR BTN inline */
.qr-inline{display:flex;gap:7px;align-items:flex-end}
.qr-inline .inp{flex:1}
.qr-btn{padding:12px 13px;background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);cursor:pointer;font-size:1.1rem;transition:.18s;white-space:nowrap}
.qr-btn:hover{background:var(--p600);color:#fff}

/* INVENTORY */
.inv-row{display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--border)}
.inv-row:last-child{border-bottom:none}
.inv-name{flex:1;font-size:.88rem;font-weight:700}
.inv-qty{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:3px 11px;border-radius:20px;font-size:.8rem;font-weight:800}
.inv-price{color:var(--muted);font-size:.78rem}

/* EMPTY */
.empty{text-align:center;color:var(--muted);padding:28px 10px;font-size:.86rem}
.empty .ei{font-size:2.3rem;margin-bottom:7px}

/* INFO BOX */
.info-box{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:11px 13px;font-size:.8rem;color:var(--muted);line-height:1.6}
.info-box strong{color:var(--p700)}
code{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:2px 6px;font-size:.76rem;font-family:monospace}

/* TOAST â€” fixed, no reload */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(90px);background:var(--p700);color:#fff;padding:10px 22px;border-radius:30px;font-size:.86rem;font-weight:700;z-index:9999;transition:transform .28s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md)}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.err{background:var(--red)}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Trá»£ lÃ½ kinh doanh thÃ´ng minh cho há»™ kinh doanh Ä‘á»‹a phÆ°Æ¡ng</p>
</header>

<!-- API KEY -->
<div id="apiSetup">
  <label>ğŸ”‘ Gemini API Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <p id="apiStatus"></p>
</div>

<!-- MONTH BAR -->
<div id="monthBar">
  <label>ğŸ“… ThÃ¡ng:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>

<!-- NAV -->
<nav>
  <button class="active" onclick="switchTab('income',this)"><span class="ni">ğŸ’°</span>Thu</button>
  <button onclick="switchTab('expense',this)"><span class="ni">ğŸ’¸</span>Chi/Kho</button>
  <button onclick="switchTab('facebook',this)"><span class="ni">ğŸ“£</span>BÃ i Ä‘Äƒng</button>
  <button onclick="switchTab('video',this)"><span class="ni">ğŸ¬</span>TikTok</button>
  <button onclick="switchTab('charts',this)"><span class="ni">ğŸ“Š</span>BÃ¡o cÃ¡o</button>
  <button onclick="switchTab('chat',this)"><span class="ni">ğŸ¤–</span>AI Chat</button>
</nav>

<!-- â•â•â• TAB: THU â•â•â• -->
<div id="tab-income" class="section active">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="totalThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ Lá»£i nhuáº­n</div><div class="s-val" id="totalProfit">0Ä‘</div></div>
  </div>

  <div class="card">
    <div class="card-title">â• ThÃªm khoáº£n thu</div>
    <div class="field">
      <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
      <!-- ProductCategoryInput component -->
      <div class="cat-wrap" id="incCatWrap">
        <input class="inp cat-input" id="incCatInput" placeholder="Nháº­p hoáº·c chá»n loáº¡i hÃ ng..." autocomplete="off"
          oninput="onCatInput('inc')" onfocus="openCatDrop('inc')" onblur="setTimeout(()=>closeCatDrop('inc'),200)"/>
        <div class="cat-dropdown" id="incCatDrop"></div>
      </div>
    </div>
    <div class="chip-group" id="incChips"></div>
    <div class="field">
      <label>ğŸ“ MÃ´ táº£</label>
      <input class="inp" type="text" id="incDesc" placeholder="VD: BÃ¡n mÃ¬ tÃ´m láº» 20 gÃ³i"/>
    </div>
    <div class="row2">
      <div class="field">
        <label>ğŸ’µ Sá»‘ tiá»n</label>
        <!-- QR scan inline -->
        <div class="qr-inline">
          <input class="inp" type="text" id="incAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/>
          <button class="qr-btn" onclick="openQR()" title="QuÃ©t QR hÃ³a Ä‘Æ¡n">ğŸ“· QR</button>
        </div>
      </div>
      <div class="field">
        <label>ğŸ“… NgÃ y</label>
        <input class="inp" type="date" id="incDate"/>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addIncome()"><span class="bi">â•</span>ThÃªm khoáº£n thu</button>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ thu</div>
    <div id="incTableWrap"></div>
  </div>
</div>

<!-- â•â•â• TAB: CHI / KHO â•â•â• -->
<div id="tab-expense" class="section">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('import',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('operational',this)">âš¡ Chi phÃ­</button>
    <button class="sub-tab" onclick="switchSub('inventory',this)">ğŸ—„ï¸ Tá»“n kho</button>
  </div>

  <!-- NHáº¬P HÃ€NG -->
  <div id="sub-import">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="card-sub">AI tá»± Ä‘á»c tÃªn hÃ ng, sá»‘ lÆ°á»£ng, thÃ nh tiá»n â†’ cáº­p nháº­t tá»“n kho</div>
      <div class="upload-area" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div>
        <strong>Báº¥m Ä‘á»ƒ chá»¥p / chá»n áº£nh hÃ³a Ä‘Æ¡n</strong>
        <small>JPG, PNG â€” AI trÃ­ch xuáº¥t tá»± Ä‘á»™ng</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <img id="invoicePreview" class="preview-img"/>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:11px">
        <span class="bi">ğŸ¤–</span>TrÃ­ch xuáº¥t báº±ng AI
      </button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="result-box" id="invoiceResult"></div>
      <button class="copy-btn" id="copyInvoice" onclick="doCopy('invoiceResult','copyInvoice')">ğŸ“‹ Sao chÃ©p vÃ o sá»•</button>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng thá»§ cÃ´ng</div>
      <div class="field">
        <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
        <div class="cat-wrap">
          <input class="inp cat-input" id="impCatInput" placeholder="Nháº­p hoáº·c chá»n..." autocomplete="off"
            oninput="onCatInput('imp')" onfocus="openCatDrop('imp')" onblur="setTimeout(()=>closeCatDrop('imp'),200)"/>
          <div class="cat-dropdown" id="impCatDrop"></div>
        </div>
      </div>
      <div class="chip-group" id="impChips"></div>
      <div class="row2">
        <div class="field"><label>ğŸ“ TÃªn hÃ ng</label><input class="inp" type="text" id="impName" placeholder="MÃ¬ tÃ´m Háº£o Háº£o"/></div>
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ ThÃ nh tiá»n</label><input class="inp" type="text" id="impAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="impDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addImport()"><span class="bi">â•</span>Nháº­p + cáº­p nháº­t kho</button>
    </div>
  </div>

  <!-- CHI PHÃ -->
  <div id="sub-operational" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ váº­n hÃ nh</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, váº­n chuyá»ƒn, hao há»¥t... â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field">
        <label>ğŸ“‚ Loáº¡i chi phÃ­</label>
        <select class="inp" id="opType" onchange="renderOpChips()">
          <option value="">-- Chá»n --</option>
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="chip-group" id="opChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="opDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng 2"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="opAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="opDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addOperational()"><span class="bi">â•</span>ThÃªm chi phÃ­</button>
    </div>
  </div>

  <!-- Tá»’N KHO -->
  <div id="sub-inventory" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ—„ï¸ Tá»“n kho hiá»‡n táº¡i</div>
      <div id="inventoryList"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ chi</div>
    <div id="expTableWrap"></div>
  </div>
</div>

<!-- â•â•â• TAB: BÃ€I ÄÄ‚NG â•â•â• -->
<div id="tab-facebook" class="section">
  <div class="card">
    <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook tá»« áº£nh</div>
    <div class="card-sub">AI nháº­n diá»‡n sáº£n pháº©m â†’ viáº¿t bÃ i â†’ tá»± Ä‘á»“ng bá»™ sang TikTok & Thu/Chi</div>
    <div class="upload-area" onclick="document.getElementById('fbImgInput').click()">
      <div class="u-icon">ğŸ–¼ï¸</div>
      <strong>Báº¥m Ä‘á»ƒ chá»n áº£nh sáº£n pháº©m</strong>
      <small>AI nháº­n diá»‡n ngay, Ä‘á»“ng bá»™ tÃªn hÃ ng & ká»‹ch báº£n TikTok</small>
    </div>
    <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
    <img id="fbPreview" class="preview-img"/>
    <div id="fbDetected" style="display:none;margin-top:10px;padding:10px 13px;background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);font-size:.84rem;color:var(--p700);font-weight:700"></div>
  </div>
  <button class="btn btn-primary" onclick="generateFbPost()" id="fbPostBtn" disabled>
    <span class="bi">ğŸ¤–</span>AI viáº¿t bÃ i + Ä‘á»“ng bá»™
  </button>
  <div class="card" id="fbResultCard" style="display:none">
    <div class="card-title">âœï¸ BÃ i Ä‘Äƒng Ä‘Ã£ táº¡o</div>
    <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang phÃ¢n tÃ­ch áº£nh & viáº¿t bÃ i...</p></div>
    <div class="result-box" id="fbPost"></div>
    <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p bÃ i Ä‘Äƒng</button>
  </div>
</div>

<!-- â•â•â• TAB: TIKTOK â•â•â• -->
<div id="tab-video" class="section">
  <div class="card">
    <div class="card-title">ğŸ¬ Ká»‹ch báº£n TikTok</div>
    <div class="card-sub">HÆ°á»›ng dáº«n Ä‘Æ¡n giáº£n â€” quay xong Ä‘Äƒng luÃ´n, khÃ´ng cáº§n chá»‰nh sá»­a</div>
    <div class="field">
      <label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label>
      <input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i, BÃ¡nh trÃ¡ng trá»™n..."/>
    </div>
    <div class="field">
      <label>ğŸ‘¤ NgÆ°á»i quay lÃ  ai?</label>
      <select class="inp" id="ttRole">
        <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
        <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§ tiá»‡m</option>
        <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
        <option value="ban">ğŸ§‘ Báº¡n / Chá»§ tráº»</option>
      </select>
    </div>
  </div>
  <button class="btn btn-primary" onclick="generateScript()" id="scriptBtn">
    <span class="bi">ğŸ¥</span>Táº¡o hÆ°á»›ng dáº«n quay TikTok
  </button>
  <div class="card" id="videoResult" style="display:none">
    <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n quay cá»§a báº¡n</div>
    <div class="loader" id="videoLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n hÆ°á»›ng dáº«n...</p></div>
    <div class="result-box" id="scriptBox"></div>
    <button class="copy-btn" id="copyScript" onclick="doCopy('scriptBox','copyScript')">ğŸ“‹ Sao chÃ©p hÆ°á»›ng dáº«n</button>
  </div>
</div>

<!-- â•â•â• TAB: BÃO CÃO â•â•â• -->
<div id="tab-charts" class="section">
  <div class="card">
    <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o thÃ¡ng nÃ y</div>
    <div class="charts-grid">
      <div class="ch-card"><h3>ğŸ¥§ Tá»· lá»‡ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
      <div class="ch-card"><h3>ğŸ“¦ Loáº¡i chi phÃ­</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
    </div>
    <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n 7 ngÃ y</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
  </div>
  <button class="btn btn-secondary" onclick="refreshCharts()" style="margin-top:4px">ğŸ”„ LÃ m má»›i biá»ƒu Ä‘á»“</button>
</div>

<!-- â•â•â• TAB: AI CHAT â•â•â• -->
<div id="tab-chat" class="section">
  <div class="card" style="padding:0;overflow:hidden">
    <div class="chat-box">
      <div class="chat-head">
        <div class="chat-av">ğŸŒ¿</div>
        <div><div class="chat-title">Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</div><div class="chat-status">â— Há»i gÃ¬ cÅ©ng Ä‘Æ°á»£c</div></div>
      </div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="msg bot">ğŸ‘‹ Xin chÃ o! MÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n:<br>â€¢ ğŸ’° Äá»‹nh giÃ¡ & tÃ­nh lá»£i nhuáº­n<br>â€¢ ğŸ“¦ Quáº£n lÃ½ kho, nháº­p hÃ ng<br>â€¢ ğŸ“£ BÃ¡n hÃ ng online, TikTok<br>â€¢ ğŸ“Š PhÃ¢n tÃ­ch thu chi<br><br>Báº¡n muá»‘n há»i gÃ¬? ğŸ˜Š</div>
        <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
      </div>
      <div class="chat-foot">
        <input class="chat-inp" id="chatInp" placeholder="Nháº­p cÃ¢u há»i..." onkeydown="if(event.key==='Enter')sendChat()"/>
        <button class="chat-send" onclick="sendChat()">â¤</button>
      </div>
    </div>
  </div>
  <div class="info-box" style="margin-top:13px">
    ğŸ’¡ <strong>NhÃºng Chatbase miá»…n phÃ­:</strong> ÄÄƒng kÃ½ chatbase.co â†’ táº¡o bot â†’ thÃªm vÃ o trang cá»§a báº¡n:<br>
    <code>&lt;script src="https://www.chatbase.co/embed.min.js" chatbotId="YOUR_ID" defer&gt;&lt;/script&gt;</code>
  </div>
</div>

<!-- QR MODAL (demo, khÃ´ng cáº§n html5-qrcode lib) -->
<div class="overlay" id="qrModal">
  <div class="modal">
    <h3>ğŸ“· QuÃ©t QR hÃ³a Ä‘Æ¡n</h3>
    <div id="qr-reader" style="background:#f0f0f0;border-radius:var(--r-sm);height:200px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px">
      <div style="font-size:2.5rem">ğŸ“·</div>
      <p style="font-size:.82rem;color:var(--muted);text-align:center">Camera QR cáº§n thÆ° viá»‡n<br><strong>html5-qrcode</strong><br><br>Demo: nháº­p thá»§ cÃ´ng bÃªn dÆ°á»›i</p>
    </div>
    <div style="margin-top:12px">
      <div class="field"><label>ğŸ’µ Sá»‘ tiá»n (demo fill)</label><input class="inp" type="text" id="qrAmount" placeholder="150.000"/></div>
      <div class="field"><label>ğŸ“ TÃªn hÃ ng</label><input class="inp" type="text" id="qrName" placeholder="MÃ¬ tÃ´m Háº£o Háº£o"/></div>
    </div>
    <button class="btn btn-primary" onclick="fillFromQR()" style="margin-bottom:0"><span class="bi">âœ…</span>Äiá»n vÃ o form</button>
    <button class="modal-close" onclick="closeQR()">âœ• ÄÃ³ng</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent";
let API_KEY = localStorage.getItem('tt40_key') || '';
let fbBase64 = '', invoiceBase64 = '';
let aiDetectedProduct = ''; // sync across tabs
const chatHistory = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// getMonthKey(year, month) â†’ "2026-02"
function getMonthKey(y, m) { return `${y}-${String(m).padStart(2,'0')}` }
function getCurrentMonthKey() { const d=new Date(); return getMonthKey(d.getFullYear(),d.getMonth()+1) }

// Default data shape for a month
function emptyMonth() { return { income:[], expense:[], inventory:{}, categories:['MÃ¬ tÃ´m','Trá»©ng gÃ ','NÆ°á»›c máº¯m','Gáº¡o','Bia/NÆ°á»›c ngá»t','BÃ¡nh káº¹o','Thá»§ cÃ´ng','Rau cá»§'] } }

// saveMonthData / loadMonthData â€” localStorage keyed by month
function saveMonthData(key, data) { localStorage.setItem('tt40_'+key, JSON.stringify(data)) }
function loadMonthData(key) {
  try { return JSON.parse(localStorage.getItem('tt40_'+key)) || emptyMonth() }
  catch { return emptyMonth() }
}

// Build list of months to show in dropdown (current + 3 prior + any existing)
function getMonthOptions() {
  const cur = new Date(); const keys = new Set();
  for (let i=0;i<4;i++) {
    const d = new Date(cur.getFullYear(), cur.getMonth()-i, 1);
    keys.add(getMonthKey(d.getFullYear(), d.getMonth()+1));
  }
  // Also include any saved months
  for (let k of Object.keys(localStorage)) { if(k.startsWith('tt40_20')) keys.add(k.replace('tt40_','')) }
  return [...keys].sort().reverse();
}
function getMonthLabel(key) { const[y,m]=key.split('-'); return `ThÃ¡ng ${parseInt(m)}/${y}` }

let currentMonth = getCurrentMonthKey();
let monthData = loadMonthData(currentMonth);

function buildMonthSelect() {
  const sel = document.getElementById('monthSelect'); sel.innerHTML='';
  getMonthOptions().forEach(k=>{
    const o=document.createElement('option');
    o.value=k; o.textContent=getMonthLabel(k);
    if(k===currentMonth)o.selected=true;
    sel.appendChild(o);
  });
  const badge=document.getElementById('monthBadge');
  badge.textContent = currentMonth===getCurrentMonthKey() ? 'ğŸ“ ThÃ¡ng hiá»‡n táº¡i' : getMonthLabel(currentMonth);
}
function switchMonth(key) {
  currentMonth=key; monthData=loadMonthData(key);
  buildMonthSelect(); renderAll();
  if(document.getElementById('tab-charts').classList.contains('active')) setTimeout(refreshCharts,80);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveApiKey(){
  const v=document.getElementById('apiKeyInput').value.trim();
  if(!v){showSt('âš ï¸ Nháº­p API Key!','#c62828');return}
  API_KEY=v; localStorage.setItem('tt40_key',v);
  showSt('âœ… ÄÃ£ lÆ°u Key â€” sáºµn sÃ ng!','#1B6B3A');
  document.getElementById('apiSetup').style.cssText+='background:#F1F8E9;border-bottom-color:#6ABF8A';
}
function showSt(msg,color){const e=document.getElementById('apiStatus');e.textContent=msg;e.style.color=color}
if(API_KEY){
  document.getElementById('apiKeyInput').value=API_KEY;
  showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');
  document.getElementById('apiSetup').style.cssText+='background:#F1F8E9;border-bottom-color:#6ABF8A';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active'); btn.classList.add('active');
  if(name==='charts') setTimeout(refreshCharts,80);
}
function switchSub(name,btn){
  ['import','operational','inventory'].forEach(n=>document.getElementById('sub-'+n).style.display=n===name?'block':'none');
  document.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  if(name==='inventory') renderInventory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT MONEY â€” controlled, no crash
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleMoney(el){
  const d=el.value.replace(/\D/g,''); el.dataset.raw=d;
  el.value = d ? parseInt(d,10).toLocaleString('vi-VN') : '';
}
function blockNonDigit(e){
  if(!['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'].includes(e.key)&&!/^\d$/.test(e.key)) e.preventDefault();
}
function getRaw(id){ return parseInt(document.getElementById(id).dataset.raw||'0',10)||0 }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COPY BUTTON â€” useCopy hook logic
   Fix: check isSecureContext before clipboard API
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doCopy(boxId, btnId) {
  const text = document.getElementById(boxId).textContent.trim();
  if (!text) { showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!', true); return; }
  const btn = document.getElementById(btnId);
  let ok = false;
  try {
    // FIX: Only use Clipboard API when in secure context (https / localhost)
    if (window.isSecureContext && navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(text);
      ok = true;
    } else {
      // Fallback: textarea + execCommand (works in iframe/http)
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      ok = document.execCommand('copy');
      document.body.removeChild(ta);
    }
    if (ok) {
      const orig = btn.innerHTML;
      btn.innerHTML = 'âœ… ÄÃ£ sao chÃ©p!'; btn.classList.add('ok'); btn.disabled = true;
      showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');
      setTimeout(()=>{ btn.innerHTML=orig; btn.classList.remove('ok'); btn.disabled=false; }, 2200);
    } else {
      showToast('âŒ TrÃ¬nh duyá»‡t cháº·n sao chÃ©p', true);
    }
  } catch(err) {
    // Never throw to UI â€” silent fail with toast
    showToast('âŒ KhÃ´ng sao chÃ©p Ä‘Æ°á»£c. Thá»­ bÃ´i Ä‘en & Ctrl+C', true);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRODUCT CATEGORY INPUT â€” free input + dropdown
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CAT_PREFIX = { inc:'inc', imp:'imp' };

function getCats() { return monthData.categories || [] }

function onCatInput(prefix) {
  const val = document.getElementById(prefix+'CatInput').value.toLowerCase();
  renderCatDrop(prefix, val);
  // Generate chips from matching category
  const exact = getCats().find(c=>c.toLowerCase()===val);
  if(exact) renderChipsFor(prefix, exact);
}
function openCatDrop(prefix) { renderCatDrop(prefix, document.getElementById(prefix+'CatInput').value.toLowerCase()) }
function closeCatDrop(prefix) { document.getElementById(prefix+'CatDrop').classList.remove('open') }

function renderCatDrop(prefix, val) {
  const drop = document.getElementById(prefix+'CatDrop');
  const cats = getCats();
  const filtered = val ? cats.filter(c=>c.toLowerCase().includes(val)) : cats;
  drop.innerHTML = '';
  filtered.forEach(c => {
    const d = document.createElement('div');
    d.className='cat-opt'; d.textContent=c;
    d.onclick=()=>{ document.getElementById(prefix+'CatInput').value=c; closeCatDrop(prefix); renderChipsFor(prefix,c); };
    drop.appendChild(d);
  });
  // "ThÃªm má»›i" option if no exact match
  if (val && !cats.some(c=>c.toLowerCase()===val)) {
    const d = document.createElement('div');
    d.className='cat-opt new-tag'; d.textContent='â• ThÃªm "'+val+'" vÃ o danh má»¥c';
    d.onclick=()=>{
      // Add to categories and persist
      if(!monthData.categories) monthData.categories=[];
      const proper = val.charAt(0).toUpperCase()+val.slice(1);
      if(!monthData.categories.includes(proper)) monthData.categories.push(proper);
      document.getElementById(prefix+'CatInput').value=proper;
      closeCatDrop(prefix); saveMonthData(currentMonth,monthData);
      showToast('âœ… ÄÃ£ thÃªm danh má»¥c "'+proper+'"');
    };
    drop.appendChild(d);
  }
  if(drop.children.length) drop.classList.add('open'); else drop.classList.remove('open');
}

/* Suggestions per category */
const SMAP = {
  'MÃ¬ tÃ´m':    {thu:['BÃ¡n láº» mÃ¬','Combo mÃ¬ + trá»©ng','BÃ¡n sá»‰ thÃ¹ng'],chi:['Nháº­p mÃ¬ tÃ´m','PhÃ­ váº­n chuyá»ƒn']},
  'Trá»©ng gÃ ':  {thu:['BÃ¡n trá»©ng láº»','BÃ¡n vá»‰ 10','BÃ¡n sá»‰'],chi:['Mua cÃ¡m','Hao há»¥t vá»¡']},
  'NÆ°á»›c máº¯m':  {thu:['BÃ¡n chai láº»','Combo gia vá»‹'],chi:['Nháº­p nÆ°á»›c máº¯m','HÃ ng háº¿t háº¡n']},
  'Gáº¡o':       {thu:['BÃ¡n gáº¡o láº»','BÃ¡n bao 25kg'],chi:['Nháº­p gáº¡o','PhÃ­ Ä‘Ã³ng gÃ³i']},
  'Bia/NÆ°á»›c ngá»t':{thu:['BÃ¡n bia láº»','KÃ©t bia'],chi:['Nháº­p bia','Äiá»‡n tá»§ láº¡nh']},
  'BÃ¡nh káº¹o':  {thu:['BÃ¡n láº»','TÃºi quÃ  lá»… Táº¿t'],chi:['Nháº­p bÃ¡nh','Bao bÃ¬']},
  'Thá»§ cÃ´ng':  {thu:['BÃ¡n táº¡i chá»£','ÄÆ¡n online'],chi:['NguyÃªn váº­t liá»‡u','CÃ´ng thá»£']},
  'Rau cá»§':    {thu:['BÃ¡n láº»','Combo rau'],chi:['Nháº­p tá»« vÆ°á»n','Hao há»¥t Ãºa']}
};
const OP_SMAP = {
  utility:['Tiá»n Ä‘iá»‡n','Tiá»n nÆ°á»›c','PhÃ­ internet'],
  transport:['Váº­n chuyá»ƒn nháº­p','Ship giao khÃ¡ch'],
  loss:['HÃ ng há»ng','Tráº£ hÃ ng lá»—i'],
  rental:['ThuÃª máº·t báº±ng','ThuÃª kho'],
  labor:['LÆ°Æ¡ng nhÃ¢n viÃªn','Tiá»n cÃ´ng'],
  other:['Chi phÃ­ phÃ¡t sinh','Tiáº¿p khÃ¡ch']
};

function renderChipsFor(prefix, cat) {
  const incOrImp = prefix==='inc' ? 'thu' : 'chi';
  const el = document.getElementById(prefix+'Chips'); el.innerHTML='';
  const map = SMAP[cat];
  if(!map) return;
  (map[incOrImp]||[]).forEach(t=>{
    const c=document.createElement('button');
    c.className='chip'+(incOrImp==='chi'?' chi-c':'');
    c.textContent=(incOrImp==='thu'?'ğŸ’° ':'ğŸ’¸ ')+t;
    c.onclick=()=>{
      const id=prefix==='inc'?'incDesc':'impName';
      document.getElementById(id).value=t;
    };
    el.appendChild(c);
  });
}
function renderOpChips(){
  const t=document.getElementById('opType').value;
  const el=document.getElementById('opChips'); el.innerHTML='';
  (OP_SMAP[t]||[]).forEach(item=>{
    const c=document.createElement('button');
    c.className='chip chi-c'; c.textContent='ğŸ’¸ '+item;
    c.onclick=()=>document.getElementById('opDesc').value=item;
    el.appendChild(c);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INCOME CRUD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addIncome(){
  const desc=document.getElementById('incDesc').value.trim();
  const amount=getRaw('incAmount'), date=document.getElementById('incDate').value;
  if(!desc||!amount||!date){showToast('âš ï¸ Vui lÃ²ng Ä‘iá»n Ä‘á»§!',true);return}
  monthData.income.push({id:Date.now(),desc,amount,date});
  persist(); renderAll(); resetFields('incDesc','incAmount','incDate');
  showToast('âœ… ÄÃ£ thÃªm khoáº£n thu!');
}
function delIncome(id){monthData.income=monthData.income.filter(x=>x.id!==id);persist();renderAll()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPENSE CRUD â€” import vs operational
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addImport(){
  const name=document.getElementById('impName').value.trim();
  const qty=getRaw('impQty'), amount=getRaw('impAmount');
  const date=document.getElementById('impDate').value;
  if(!name||!amount||!date){showToast('âš ï¸ Äiá»n Ä‘á»§ thÃ´ng tin!',true);return}
  monthData.expense.push({id:Date.now(),desc:'Nháº­p: '+name,amount,date,expenseType:'import',name,qty});
  // Update inventory
  if(!monthData.inventory[name])monthData.inventory[name]={qty:0,lastPrice:0};
  monthData.inventory[name].qty+=(qty||1);
  monthData.inventory[name].lastPrice=qty>0?Math.round(amount/qty):amount;
  persist(); renderAll(); renderInventory();
  resetFields('impName','impQty','impAmount','impDate');
  showToast('âœ… Nháº­p hÃ ng + cáº­p nháº­t kho!');
}
function addOperational(){
  const desc=document.getElementById('opDesc').value.trim();
  const amount=getRaw('opAmount'), date=document.getElementById('opDate').value;
  if(!desc||!amount||!date){showToast('âš ï¸ Äiá»n Ä‘á»§ thÃ´ng tin!',true);return}
  monthData.expense.push({id:Date.now(),desc,amount,date,expenseType:'operational'});
  persist(); renderAll(); resetFields('opDesc','opAmount','opDate');
  showToast('âœ… ÄÃ£ thÃªm chi phÃ­!');
}
function delExpense(id){
  const item=monthData.expense.find(x=>x.id===id);
  if(item?.expenseType==='import'&&item.name&&monthData.inventory[item.name]){
    monthData.inventory[item.name].qty=Math.max(0,monthData.inventory[item.name].qty-(item.qty||1));
  }
  monthData.expense=monthData.expense.filter(x=>x.id!==id);
  persist(); renderAll(); renderInventory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n){return n.toLocaleString('vi-VN')+'Ä‘'}
function fmtD(d){const[y,m,day]=d.split('-');return`${day}/${m}`}
function persist(){saveMonthData(currentMonth,monthData);buildMonthSelect()}

function renderAll(){renderSummary();renderIncTable();renderExpTable()}

function renderSummary(){
  const thu=monthData.income.reduce((s,x)=>s+x.amount,0);
  const chi=monthData.expense.reduce((s,x)=>s+x.amount,0);
  const p=thu-chi;
  document.getElementById('totalThu').textContent=fmt(thu);
  document.getElementById('totalChi').textContent=fmt(chi);
  const el=document.getElementById('totalProfit');
  el.textContent=(p>=0?'+':'')+fmt(p);
  el.style.color=p>=0?'var(--p600)':'var(--red)';
}
function renderIncTable(){
  const w=document.getElementById('incTableWrap');
  if(!monthData.income.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ khoáº£n thu nÃ o</div>';return}
  const rows=monthData.income.slice().reverse().map(t=>`<tr><td>${fmtD(t.date)}</td><td>${t.desc}</td><td class="thu-v">+${fmt(t.amount)}</td><td><button class="del-btn" onclick="delIncome(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}
function renderExpTable(){
  const w=document.getElementById('expTableWrap');
  if(!monthData.expense.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’¸</div>ChÆ°a cÃ³ khoáº£n chi nÃ o</div>';return}
  const rows=monthData.expense.slice().reverse().map(t=>`<tr><td>${fmtD(t.date)}</td><td>${t.desc}</td><td><span class="tag ${t.expenseType==='import'?'tag-imp':'tag-op'}">${t.expenseType==='import'?'ğŸ“¦ Nháº­p':'âš¡ Váº­n hÃ nh'}</span></td><td class="chi-v">-${fmt(t.amount)}</td><td><button class="del-btn" onclick="delExpense(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>MÃ´ táº£</th><th>Loáº¡i</th><th>Sá»‘ tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}
function renderInventory(){
  const el=document.getElementById('inventoryList');
  const keys=Object.keys(monthData.inventory||{}).filter(k=>monthData.inventory[k].qty>0);
  if(!keys.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng â€” thÃªm nháº­p hÃ ng Ä‘á»ƒ theo dÃµi tá»“n kho</div>';return}
  el.innerHTML=keys.map(k=>`<div class="inv-row"><div class="inv-name">ğŸ·ï¸ ${k}</div><div class="inv-qty">${monthData.inventory[k].qty} cÃ¡i</div><div class="inv-price">${fmt(monthData.inventory[k].lastPrice)}/cÃ¡i</div></div>`).join('');
}

function resetFields(...ids){
  ids.forEach(id=>{const e=document.getElementById(id);if(e){e.value='';e.dataset.raw=''}});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI API â€” shared caller
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(parts){
  if(!API_KEY) throw new Error('ChÆ°a cÃ³ API Key');
  const res=await fetch(`${GEMINI_URL}?key=${API_KEY}`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts}]})
  });
  const data=await res.json();
  if(data.error) throw new Error(data.error.message);
  return data.candidates[0].content.parts[0].text;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE SCAN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleInvoiceImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    invoiceBase64=ev.target.result.split(',')[1];
    const img=document.getElementById('invoicePreview');
    img.src=ev.target.result; img.style.display='block';
    document.getElementById('scanBtn').disabled=false;
  };
  r.readAsDataURL(f);
}
async function scanInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return}
  const loader=document.getElementById('scanLoader');
  const box=document.getElementById('invoiceResult');
  const btn=document.getElementById('copyInvoice');
  loader.classList.add('show'); box.classList.remove('show'); btn.classList.remove('show');
  document.getElementById('scanBtn').disabled=true;
  try{
    // Prompt: quáº£n lÃ½ kho
    const text=await callGemini([
      {inline_data:{mime_type:'image/jpeg',data:invoiceBase64}},
      {text:`Báº¡n lÃ  trá»£ lÃ½ quáº£n lÃ½ kho. HÃ£y trÃ­ch xuáº¥t tá»« áº£nh hÃ³a Ä‘Æ¡n nÃ y cÃ¡c thÃ´ng tin: TÃªn máº·t hÃ ng, Sá»‘ lÆ°á»£ng, ThÃ nh tiá»n. Tráº£ vá» káº¿t quáº£ dÆ°á»›i dáº¡ng báº£ng hoáº·c danh sÃ¡ch gáº¡ch Ä‘áº§u dÃ²ng Ä‘á»ƒ tÃ´i sao chÃ©p vÃ o sá»• quáº£n lÃ½.`}
    ]);
    loader.classList.remove('show'); box.textContent=text; box.classList.add('show'); btn.classList.add('show');
  }catch(err){loader.classList.remove('show');box.textContent='âŒ '+err.message;box.classList.add('show')}
  document.getElementById('scanBtn').disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FACEBOOK POST â€” Vision + sync to other tabs
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFbImg(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    fbBase64=ev.target.result.split(',')[1];
    document.getElementById('fbPreview').src=ev.target.result;
    document.getElementById('fbPreview').style.display='block';
    document.getElementById('fbPostBtn').disabled=false;
    document.getElementById('fbDetected').style.display='none';
  };
  r.readAsDataURL(f);
}

async function generateFbPost(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return}
  if(!fbBase64){showToast('âš ï¸ Chá»n áº£nh trÆ°á»›c!',true);return}
  const card=document.getElementById('fbResultCard');
  const loader=document.getElementById('fbLoader');
  const box=document.getElementById('fbPost');
  const btn=document.getElementById('copyFb');
  card.style.display='block'; loader.classList.add('show');
  box.classList.remove('show'); btn.classList.remove('show');
  document.getElementById('fbPostBtn').disabled=true;

  /* Optimized Gemini Vision prompt â€” returns structured JSON for sync */
  const prompt=`Báº¡n lÃ  chuyÃªn gia content bÃ¡n hÃ ng Viá»‡t Nam. PhÃ¢n tÃ­ch áº£nh vÃ  tráº£ vá» JSON há»£p lá»‡ (khÃ´ng cÃ³ markdown backtick) theo Ä‘Ãºng cáº¥u trÃºc:
{
  "productName": "tÃªn sáº£n pháº©m ngáº¯n gá»n",
  "category": "má»™t trong: MÃ¬ tÃ´m | Trá»©ng gÃ  | NÆ°á»›c máº¯m | Gáº¡o | Bia/NÆ°á»›c ngá»t | BÃ¡nh káº¹o | Thá»§ cÃ´ng | Rau cá»§ | KhÃ¡c",
  "highlights": ["Ä‘áº·c Ä‘iá»ƒm 1", "Ä‘áº·c Ä‘iá»ƒm 2", "Ä‘áº·c Ä‘iá»ƒm 3"],
  "fbPost": "BÃ i Ä‘Äƒng Facebook hoÃ n chá»‰nh vá»›i emoji, mÃ´ táº£ háº¥p dáº«n, kÃªu gá»i mua hÃ ng, hashtag",
  "tiktokIdea": "Ã tÆ°á»Ÿng ngáº¯n 1 cÃ¢u cho video TikTok"
}`;

  try{
    const raw = await callGemini([{inline_data:{mime_type:'image/jpeg',data:fbBase64}},{text:prompt}]);
    // Parse JSON response
    let parsed;
    try { parsed = JSON.parse(raw.replace(/```json|```/g,'').trim()); }
    catch { parsed = null; }

    loader.classList.remove('show');

    if(parsed){
      // â”€â”€ SYNC: set detected product across tabs
      aiDetectedProduct = parsed.productName || '';
      document.getElementById('ttProduct').value = aiDetectedProduct;
      // Auto-fill income category
      document.getElementById('incCatInput').value = parsed.category||'';
      document.getElementById('impCatInput').value = parsed.category||'';
      // Show detected info
      const det=document.getElementById('fbDetected');
      det.style.display='block';
      det.innerHTML=`âœ… Nháº­n diá»‡n: <strong>${parsed.productName}</strong> Â· Danh má»¥c: ${parsed.category}<br>ğŸ’¡ TikTok idea: ${parsed.tiktokIdea||''}`;
      // Show FB post
      box.textContent=parsed.fbPost||raw;
      showToast('âœ… ÄÃ£ Ä‘á»“ng bá»™ tÃªn hÃ ng sang TikTok & Thu/Chi!');
    } else {
      box.textContent=raw; // fallback plain text
    }
    box.classList.add('show'); btn.classList.add('show');
  }catch(err){
    loader.classList.remove('show'); box.textContent='âŒ '+err.message; box.classList.add('show');
  }
  document.getElementById('fbPostBtn').disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIKTOK SCRIPT â€” "BÃ¬nh dÃ¢n hÃ³a" prompt
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generateScript(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return}
  const product=document.getElementById('ttProduct').value.trim();
  if(!product){showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return}
  const role=document.getElementById('ttRole').value;
  const roleMap={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'};
  const xung=roleMap[role]||'báº¡n';
  const card=document.getElementById('videoResult');
  const loader=document.getElementById('videoLoader');
  const box=document.getElementById('scriptBox');
  const btn=document.getElementById('copyScript');
  card.style.display='block'; loader.classList.add('show');
  box.classList.remove('show'); btn.classList.remove('show');
  document.getElementById('scriptBtn').disabled=true;

  /* "BÃ¬nh dÃ¢n hÃ³a" prompt â€” plain language, no tech jargon */
  const prompt=`Báº¡n lÃ  ngÆ°á»i chÃ¡u hiáº¿u tháº£o, Ä‘ang hÆ°á»›ng dáº«n ${xung} quay video TikTok bÃ¡n "${product}".
Viáº¿t hÆ°á»›ng dáº«n cá»±c ká»³ Ä‘Æ¡n giáº£n, ngÃ´n ngá»¯ gáº§n gÅ©i nhÆ° Ä‘ang nÃ³i chuyá»‡n tháº­t, xÆ°ng hÃ´ "con/chÃ¡u" vÃ  "${xung}".

ÄÃšNG 3 BÆ¯á»šC (khÃ´ng thÃªm bá»›t):

BÆ¯á»šC 1 â€” CHUáº¨N Bá»Š:
HÆ°á»›ng dáº«n ${xung} Ä‘áº·t Ä‘iá»‡n thoáº¡i vÃ  Ä‘á»©ng á»Ÿ Ä‘Ã¢u. NÃ³i cá»¥ thá»ƒ, vÃ­ dá»¥: "BÃ  Ä‘áº·t Ä‘iá»‡n thoáº¡i lÃªn cÃ¡i gháº¿, quay máº·t vá» phÃ­a cá»­a sá»• cho sÃ¡ng nhÃ©".

BÆ¯á»šC 2 â€” HÃ€NH Äá»˜NG:
Chá»‰ 1 viá»‡c ${xung} cáº§n lÃ m. VÃ­ dá»¥: "${xung.charAt(0).toUpperCase()+xung.slice(1)} cáº§m sáº£n pháº©m lÃªn, nhÃ¬n vÃ o camera vÃ  cÆ°á»i tá»± nhiÃªn".

BÆ¯á»šC 3 â€” Lá»œI NÃ“I:
Viáº¿t sáºµn 2-3 cÃ¢u ngáº¯n cho ${xung} Ä‘á»c theo. CÃ¢u pháº£i tá»± nhiÃªn nhÆ° Ä‘ang nÃ³i chuyá»‡n, khÃ´ng cáº§n há»c thuá»™c.

TUYá»†T Äá»I KHÃ”NG dÃ¹ng: "gÃ³c mÃ¡y", "medium shot", "Ã¡nh sÃ¡ng tá»± nhiÃªn", "dá»±ng video", "chuyá»ƒn cáº£nh", "content", "hashtag trend".

Káº¿t thÃºc báº±ng ÄÃšNG cÃ¢u nÃ y (khÃ´ng sá»­a):
"${xung.charAt(0).toUpperCase()+xung.slice(1)} khÃ´ng cáº§n chá»‰nh sá»­a gÃ¬ cáº£, cá»© quay xong Ä‘Äƒng luÃ´n â€” sá»± chÃ¢n cháº¥t chÃ­nh lÃ  Ä‘iá»ƒm cá»™ng cá»§a mÃ¬nh Ä‘Ã³ ${xung} Æ¡i! ğŸ’š"`;

  try{
    const text=await callGemini([{text:prompt}]);
    loader.classList.remove('show'); box.textContent=text; box.classList.add('show'); btn.classList.add('show');
  }catch(err){loader.classList.remove('show');box.textContent='âŒ '+err.message;box.classList.add('show')}
  document.getElementById('scriptBtn').disabled=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS â€” destroy before re-render (fix data accumulation)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Store chart instances â€” destroy old ones before creating new
const chartInst = { pie:null, bar:null, line:null };

function destroyAll(){
  // Must destroy each instance before new Chart() on same canvas
  Object.keys(chartInst).forEach(k=>{ if(chartInst[k]){ chartInst[k].destroy(); chartInst[k]=null; } });
}

function refreshCharts(){
  destroyAll(); // â† critical fix: prevents dataset accumulation

  const thu=monthData.income.reduce((s,x)=>s+x.amount,0)||3800000;
  const imp=monthData.expense.filter(x=>x.expenseType==='import').reduce((s,x)=>s+x.amount,0)||1500000;
  const op=monthData.expense.filter(x=>x.expenseType==='operational').reduce((s,x)=>s+x.amount,0)||700000;

  chartInst.pie=new Chart(document.getElementById('pieChart'),{
    type:'doughnut',
    data:{labels:['Thu ğŸ’°','Nháº­p hÃ ng ğŸ“¦','Váº­n hÃ nh âš¡'],datasets:[{data:[thu,imp,op],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:8}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10},padding:7}}}}
  });

  chartInst.bar=new Chart(document.getElementById('barChart'),{
    type:'bar',
    data:{labels:['Nháº­p hÃ ng','Äiá»‡n nÆ°á»›c','Váº­n chuyá»ƒn','Hao há»¥t','KhÃ¡c'],datasets:[{label:'Ä‘',data:[imp,320000,180000,150000,op-650000||50000],backgroundColor:'rgba(27,107,58,.72)',borderRadius:7,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'}},x:{grid:{display:false}}}}
  });

  const days=['T2','T3','T4','T5','T6','T7','CN'];
  chartInst.line=new Chart(document.getElementById('lineChart'),{
    type:'line',
    data:{labels:days,datasets:[
      {label:'Thu',data:[750,1100,900,1300,980,1800,1150].map(v=>v*1000),borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.42,fill:true,pointRadius:4,pointBackgroundColor:'#1B6B3A'},
      {label:'Chi',data:[360,490,400,650,450,820,520].map(v=>v*1000),borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.42,fill:true,pointRadius:4,pointBackgroundColor:'#D94F3D'}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:11}}}},
      scales:{y:{beginAtZero:true,grid:{color:'#eee'},ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'}},x:{grid:{display:false}}}}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR SCAN (demo â€” integrate html5-qrcode for production)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openQR(){ document.getElementById('qrModal').classList.add('show') }
function closeQR(){
  document.getElementById('qrModal').classList.remove('show');
  document.getElementById('qrAmount').value=''; document.getElementById('qrName').value='';
}
function fillFromQR(){
  const amount=document.getElementById('qrAmount').value.replace(/\D/g,'');
  const name=document.getElementById('qrName').value.trim();
  if(amount){
    const el=document.getElementById('incAmount');
    el.dataset.raw=amount; el.value=parseInt(amount,10).toLocaleString('vi-VN');
  }
  if(name) document.getElementById('incDesc').value=name;
  document.getElementById('incDate').valueAsDate=new Date();
  closeQR(); showToast('âœ… ÄÃ£ Ä‘iá»n tá»« QR vÃ o form!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CHATBOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SYS=`Báº¡n lÃ  Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, chuyÃªn tÆ° váº¥n cho chá»§ tiá»‡m táº¡p hÃ³a vÃ  xÆ°á»Ÿng thá»§ cÃ´ng nhá» táº¡i Viá»‡t Nam.
Tráº£ lá»i ngáº¯n gá»n, thá»±c táº¿, thÃ¢n thiá»‡n, dÃ¹ng emoji. KhÃ´ng lan man. KhÃ´ng dÃ¹ng tá»« ká»¹ thuáº­t khÃ³ hiá»ƒu.`;

async function sendChat(){
  const inp=document.getElementById('chatInp');
  const msg=inp.value.trim(); if(!msg)return;
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return}
  inp.value=''; addMsg(msg,'user');
  chatHistory.push({role:'user',parts:[{text:msg}]});
  const typing=document.getElementById('chatTyping');
  typing.classList.add('show'); scrollChat();
  try{
    const text=await callGemini([{text:SYS+'\n\nCÃ¢u há»i: '+msg}]);
    chatHistory.push({role:'model',parts:[{text}]});
    typing.classList.remove('show'); addMsg(text,'bot');
  }catch(err){typing.classList.remove('show');addMsg('âŒ Lá»—i: '+err.message,'bot')}
}
function addMsg(text,role){
  const msgs=document.getElementById('chatMsgs');
  const div=document.createElement('div'); div.className='msg '+role; div.textContent=text;
  msgs.insertBefore(div,document.getElementById('chatTyping')); scrollChat();
}
function scrollChat(){const m=document.getElementById('chatMsgs');m.scrollTop=m.scrollHeight}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST â€” no page reload, error variant
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer=null;
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=isErr?'err':''; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
['incDate','impDate','opDate'].forEach(id=>{
  const el=document.getElementById(id); if(el) el.valueAsDate=new Date();
});
buildMonthSelect();
renderAll();
</script>
</body>
</html>