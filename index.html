<!DOCTYPE html>
<html lang="vi">
<head>
<script src="https://unpkg.com/html5-qrcode"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Tiá»ƒu ThÆ°Æ¡ng 4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --p50:#EDF7F1;--p100:#C8E9D5;--p300:#6ABF8A;
  --p600:#1B6B3A;--p700:#145230;--p800:#0D3A22;
  --a400:#F5A623;--a600:#D4881A;
  --red:#D94F3D;--red-bg:#FDF0EE;
  --surface:#F7FBF8;--card:#fff;
  --border:#DDE8E2;--border-strong:#B8D0C2;
  --text:#1A2E23;--muted:#5A7A66;--subtle:#8FA89A;
  --shadow-sm:0 2px 8px rgba(0,0,0,.09);
  --shadow-md:0 4px 18px rgba(0,0,0,.13);
  --r-sm:10px;--r-md:16px;--r-lg:22px;
  --font:'Segoe UI',system-ui,Arial,sans-serif;
  --nav-h:64px;
  --header-h:52px;
  --month-h:44px;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--surface);color:var(--text);display:flex;flex-direction:column}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:10px}

/* HEADER */
header{background:linear-gradient(135deg,var(--p800),var(--p600));color:#fff;padding:10px 16px 8px;text-align:center;flex-shrink:0;z-index:300;box-shadow:0 2px 12px rgba(0,0,0,.22)}
header h1{font-size:1.25rem;font-weight:800}
header p{font-size:.68rem;opacity:.75;margin-top:1px}
.badge{background:var(--a400);color:#1A2E23;font-size:.58rem;font-weight:900;padding:2px 7px;border-radius:20px;margin-left:5px;vertical-align:middle}

/* API BAR */
#apiSetup{background:#FFFDE7;border-bottom:2px solid var(--a400);padding:7px 12px;display:flex;align-items:center;flex-wrap:wrap;gap:6px;flex-shrink:0}
#apiSetup label{font-size:.74rem;font-weight:800;color:#7A5200;white-space:nowrap}
#apiKeyInput{flex:1;min-width:120px;padding:6px 10px;border:2px solid var(--a400);border-radius:var(--r-sm);font-size:.83rem}
#apiKeyInput:focus{outline:none;border-color:var(--a600)}
#saveKeyBtn{background:var(--a400);color:#1A2E23;border:none;padding:6px 11px;border-radius:var(--r-sm);font-weight:800;cursor:pointer;font-size:.78rem}
#apiStatus{font-size:.7rem;width:100%;margin-top:-2px}

/* MONTH BAR */
#monthBar{background:var(--card);border-bottom:2px solid var(--border);padding:6px 12px;display:flex;align-items:center;gap:7px;flex-wrap:wrap;flex-shrink:0;z-index:290}
#monthBar label{font-size:.72rem;font-weight:800;color:var(--muted);white-space:nowrap}
#monthSelect{padding:5px 9px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.81rem;font-weight:700;color:var(--p600);background:var(--surface);cursor:pointer}
.month-badge{font-size:.66rem;background:var(--p50);color:var(--p600);padding:3px 9px;border-radius:20px;font-weight:800;border:1.5px solid var(--p100);margin-left:auto}

/* MAIN SCROLL AREA */
#mainArea{flex:1;overflow:hidden;position:relative}

/* BOTTOM NAV */
.bottom-nav{flex-shrink:0;height:var(--nav-h);background:var(--card);border-top:2px solid var(--border);display:flex;z-index:400;box-shadow:0 -3px 16px rgba(0,0,0,.10)}
.bn-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;padding:4px 2px;border-top:3px solid transparent;transition:.18s;color:var(--muted);font-family:var(--font)}
.bn-btn .ni{font-size:1.25rem;line-height:1}
.bn-btn .nl{font-size:.55rem;font-weight:800;white-space:nowrap}
.bn-btn.active{color:var(--p600);border-top-color:var(--p600);background:var(--p50)}

/* PAGES â€” each page scrolls independently */
.page{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.page.active{display:block}
.page-inner{padding:11px;max-width:660px;margin:0 auto;padding-bottom:16px}

/* CARDS */
.card{background:var(--card);border-radius:var(--r-md);padding:14px;margin-bottom:11px;box-shadow:var(--shadow-sm);border:1px solid var(--border);width:100%}
.card-title{font-size:.92rem;font-weight:800;color:var(--p700);margin-bottom:9px;display:flex;align-items:center;gap:6px}
.card-sub{font-size:.72rem;color:var(--muted);margin-top:-5px;margin-bottom:9px;line-height:1.6}

/* FIELDS */
.field{margin-bottom:9px}
.field label{font-size:.71rem;font-weight:800;color:var(--muted);display:block;margin-bottom:3px}
.inp{width:100%;padding:10px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.88rem;font-family:var(--font);background:#fff;color:var(--text);transition:.18s}
.inp:focus{outline:none;border-color:var(--p600);box-shadow:0 0 0 3px rgba(27,107,58,.08)}
.inp::placeholder{color:var(--subtle)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:380px){.row2{grid-template-columns:1fr}}

/* DROPDOWNS */
.cat-wrap,.sug-wrap{position:relative}
.cat-dropdown,.sug-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--p100);border-top:none;border-radius:0 0 var(--r-sm) var(--r-sm);z-index:600;max-height:180px;overflow-y:auto;display:none;box-shadow:var(--shadow-md)}
.cat-dropdown.open,.sug-dropdown.open{display:block}
.cat-opt,.sug-opt{padding:9px 12px;cursor:pointer;font-size:.85rem;border-bottom:1px solid var(--border);transition:.15s}
.cat-opt:last-child,.sug-opt:last-child{border-bottom:none}
.cat-opt:hover,.sug-opt:hover{background:var(--p50);color:var(--p600)}
.cat-opt.new-item{color:var(--p600);font-weight:800;font-style:italic}

/* BUTTONS */
.btn{width:100%;padding:12px;border:none;border-radius:var(--r-md);font-size:.87rem;font-weight:800;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:8px;font-family:var(--font)}
.btn-primary{background:var(--p600);color:#fff;box-shadow:0 3px 10px rgba(27,107,58,.22)}
.btn-primary:hover:not(:disabled){background:var(--p700);transform:translateY(-1px)}
.btn-secondary{background:var(--p50);color:var(--p700);border:2px solid var(--p100)}
.btn-secondary:hover:not(:disabled){background:var(--p100)}
.btn-danger{background:var(--red-bg);color:var(--red);border:2px solid #F5C6C0}
.btn-danger:hover:not(:disabled){background:var(--red);color:#fff}
.btn-warning{background:#FFF8E1;color:#7A5200;border:2px solid var(--a400)}
.btn-sm{padding:6px 12px;font-size:.75rem;border-radius:var(--r-sm);width:auto;margin:0;display:inline-flex}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* UPLOAD / IMAGE PREVIEW */
.upload-area{border:3px dashed var(--border-strong);border-radius:var(--r-md);padding:20px 12px;text-align:center;cursor:pointer;transition:.2s;background:var(--p50)}
.upload-area:hover{border-color:var(--p600);background:var(--p100)}
.upload-area .u-icon{font-size:2rem;margin-bottom:4px}
.upload-area strong{display:block;font-size:.84rem;color:var(--p700);margin-bottom:2px}
.upload-area small{color:var(--subtle);font-size:.7rem}
.img-preview-box{position:relative;margin-bottom:8px;display:none}
.img-preview-box img{width:100%;max-height:180px;object-fit:cover;border-radius:var(--r-sm);border:2px solid var(--p300);display:block}
.img-change-btn{position:absolute;top:7px;right:7px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:20px;padding:4px 10px;font-size:.7rem;font-weight:800;cursor:pointer}

/* RESULT / LOADER */
.result-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-sm);padding:12px;margin-top:8px;white-space:pre-wrap;font-size:.82rem;line-height:1.7;max-height:260px;overflow-y:auto;display:none}
.result-box.show{display:block}
.loader{display:none;text-align:center;padding:16px}
.loader.show{display:block}
.spinner{width:32px;height:32px;border:4px solid var(--p100);border-top:4px solid var(--p600);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 7px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{color:var(--p600);font-weight:700;font-size:.8rem}

/* COPY BTN */
.copy-btn{display:none;align-items:center;gap:5px;background:var(--p50);color:var(--p700);border:2px solid var(--p100);padding:7px 13px;border-radius:var(--r-sm);font-size:.78rem;font-weight:800;cursor:pointer;margin-top:7px;transition:.2s;font-family:var(--font)}
.copy-btn:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.copy-btn.show{display:inline-flex}
.copy-btn.ok{background:#27AE60;color:#fff;border-color:#27AE60}

/* AUTOFILL */
.autofill-notice{background:#E8F5E9;border:1.5px solid var(--p300);border-radius:var(--r-sm);padding:9px 12px;font-size:.78rem;color:var(--p700);margin-top:7px;display:none}
.autofill-notice.show{display:block}

/* SUB-TABS */
.sub-tabs{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap}
.sub-tab{padding:6px 13px;border:2px solid var(--border);background:#fff;border-radius:30px;font-size:.75rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s;white-space:nowrap}
.sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.sub-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

.modal-sub-tabs{display:flex;gap:5px;margin-bottom:10px}
.modal-sub-tab{flex:1;padding:7px;border:2px solid var(--border);background:#fff;border-radius:var(--r-sm);font-size:.75rem;font-weight:800;color:var(--muted);cursor:pointer;text-align:center;transition:.18s}
.modal-sub-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}

/* CHIPS */
.chip-group{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;min-height:6px}
.chip{background:var(--p50);border:1.5px solid var(--p100);color:var(--p700);padding:4px 10px;border-radius:20px;font-size:.71rem;font-weight:800;cursor:pointer;transition:.18s}
.chip:hover{background:var(--p600);color:#fff;border-color:var(--p600)}
.chip.chi-c{border-color:#F5C6C0;color:var(--red)}
.chip.chi-c:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* SUMMARY */
.sum-strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:11px}
.s-card{background:var(--card);border-radius:var(--r-sm);padding:10px 7px;text-align:center;border:1px solid var(--border)}
.s-lbl{font-size:.63rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.s-val{font-size:.9rem;font-weight:900}
.s-thu .s-val{color:var(--p600)}.s-chi .s-val{color:var(--red)}.s-profit .s-val{color:var(--p700)}

/* TABLES */
.tbl-wrap{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--border);max-height:360px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.79rem;table-layout:auto}
thead{position:sticky;top:0;z-index:10}
thead tr{background:var(--p600)}
th{padding:8px 9px;text-align:left;color:#fff;font-size:.7rem;font-weight:800;white-space:nowrap}
td{padding:8px 9px;border-bottom:1px solid var(--border);vertical-align:middle;word-break:break-word}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:var(--p50)}
.thu-v{color:var(--p600);font-weight:800}
.chi-v{color:var(--red);font-weight:800}
.del-btn{background:none;border:none;cursor:pointer;font-size:.85rem;padding:3px 5px;border-radius:6px;transition:.15s;color:var(--subtle)}
.del-btn:hover{background:var(--red-bg);color:var(--red)}
.tag{display:inline-block;padding:2px 6px;border-radius:7px;font-size:.65rem;font-weight:800;white-space:nowrap}
.tag-thu{background:#D4EDDA;color:var(--p700)}
.tag-imp{background:#D1ECF1;color:#0C5460}
.tag-op{background:#FFF3CD;color:#856404}

/* BULK */
.bulk-bar{display:flex;align-items:center;gap:8px;margin-bottom:9px;flex-wrap:wrap}
.bulk-bar input[type=checkbox]{width:15px;height:15px;accent-color:var(--p600);cursor:pointer}
.bulk-bar label{font-size:.76rem;font-weight:800;color:var(--muted);cursor:pointer}
.cb-cell input[type=checkbox]{width:14px;height:14px;accent-color:var(--p600);cursor:pointer}

/* â”€â”€ INVENTORY SMART ALERTS â”€â”€ */
.inv-section{margin-bottom:12px}
.inv-section-title{font-size:.8rem;font-weight:900;color:var(--p700);margin-bottom:7px;display:flex;align-items:center;gap:6px}
.inv-alert-card{border-radius:var(--r-sm);padding:11px 13px;margin-bottom:7px;display:flex;align-items:flex-start;gap:10px;border:2px solid}
.inv-alert-low{background:#FFF8E1;border-color:var(--a400)}
.inv-alert-out{background:var(--red-bg);border-color:var(--red)}
.inv-alert-slow{background:#EEF2FF;border-color:#7C83FD}
.inv-alert-ok{background:var(--p50);border-color:var(--p300)}
.inv-alert-icon{font-size:1.4rem;flex-shrink:0;margin-top:1px}
.inv-alert-body{flex:1;min-width:0}
.inv-alert-name{font-size:.88rem;font-weight:800;word-break:break-word}
.inv-alert-meta{font-size:.7rem;color:var(--muted);margin-top:2px;line-height:1.5}
.inv-alert-qty{font-size:.82rem;font-weight:900;white-space:nowrap;padding:3px 9px;border-radius:20px}
.qty-out{background:var(--red-bg);color:var(--red)}
.qty-low{background:#FFF3CD;color:#7A5200}
.qty-ok{background:var(--p50);color:var(--p600)}
.inv-restock-notice{background:var(--a400);color:#1A2E23;border-radius:var(--r-sm);padding:9px 13px;font-size:.78rem;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.inv-ask-btn{width:100%;padding:11px;background:var(--p600);color:#fff;border:none;border-radius:var(--r-md);font-size:.87rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:4px;transition:.2s}
.inv-ask-btn:hover{background:var(--p700)}

/* INVOICE TABLE */
.invoice-table-wrap{margin-top:9px;overflow-x:auto;display:none}
.invoice-table-wrap.show{display:block}
.inv-tbl{width:100%;border-collapse:collapse;font-size:.81rem}
.inv-tbl th{background:var(--p600);color:#fff;padding:8px 9px;text-align:left;font-size:.72rem;font-weight:800}
.inv-tbl td{padding:8px 9px;border-bottom:1px solid var(--border);word-break:break-word}
.inv-tbl tr:last-child td{border-bottom:none}
.inv-tbl tr:nth-child(even) td{background:var(--p50)}

/* PLANS */
.plan-item{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:10px 12px;margin-bottom:7px;display:flex;align-items:center;gap:9px}
.plan-body{flex:1;min-width:0}
.plan-name{font-size:.85rem;font-weight:800;color:var(--p700);word-break:break-word}
.plan-meta{font-size:.71rem;color:var(--muted);margin-top:2px}
.plan-amount{font-size:.9rem;font-weight:900;color:var(--red);white-space:nowrap}
.plan-del{background:none;border:none;cursor:pointer;font-size:.85rem;color:var(--subtle);padding:3px 5px;border-radius:6px;transition:.15s}
.plan-del:hover{background:var(--red-bg);color:var(--red)}

/* COMPARE */
.compare-box{background:var(--p50);border:2px solid var(--p100);border-radius:var(--r-md);padding:13px;margin-bottom:11px;display:none}
.compare-box.show{display:block}
.compare-box h3{font-size:.85rem;font-weight:800;color:var(--p700);margin-bottom:9px}
.cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px}
.cmp-item{text-align:center;background:#fff;border-radius:var(--r-sm);padding:9px 5px;border:1px solid var(--border)}
.cmp-lbl{font-size:.62rem;font-weight:800;color:var(--muted);margin-bottom:2px}
.cmp-cur{font-size:.82rem;font-weight:900;color:var(--p700)}
.cmp-prev{font-size:.68rem;color:var(--muted);margin-top:2px}
.cmp-delta{font-size:.68rem;font-weight:800;margin-top:2px}
.delta-up{color:var(--p600)}.delta-down{color:var(--red)}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
@media(max-width:480px){.charts-grid{grid-template-columns:1fr}}
.ch-card{background:var(--card);border-radius:var(--r-sm);padding:11px;border:1px solid var(--border)}
.ch-card h3{font-size:.75rem;font-weight:800;color:var(--p700);margin-bottom:7px;text-align:center}
.ch-wrap{position:relative;height:150px}
.ch-full{position:relative;height:170px}

/* PERIOD */
.period-tabs{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap}
.period-tab{padding:5px 12px;border:2px solid var(--border);background:#fff;border-radius:20px;font-size:.72rem;font-weight:800;color:var(--muted);cursor:pointer;transition:.18s;white-space:nowrap}
.period-tab.active{background:var(--p600);color:#fff;border-color:var(--p600)}
.period-tab:hover:not(.active){background:var(--p50);color:var(--p600)}

/* HISTORY FILTERS */
.history-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.history-filters input,.history-filters select{padding:7px 10px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.79rem;background:#fff;font-family:var(--font)}
.history-filters input{flex:1;min-width:110px}
.history-filters input:focus,.history-filters select:focus{outline:none;border-color:var(--p600)}
.hist-row-clickable{cursor:pointer;transition:.15s}
.hist-row-clickable:hover td{background:var(--p100)!important}
.jump-badge{display:inline-block;background:var(--p50);color:var(--p600);border:1px solid var(--p100);border-radius:6px;font-size:.62rem;padding:1px 5px;font-weight:800;cursor:pointer}

/* â”€â”€ AI CHAT â”€â”€ */
.chat-box{background:var(--card);border-radius:var(--r-md);overflow:hidden;box-shadow:var(--shadow-md);border:1px solid var(--border);display:flex;flex-direction:column}
.chat-head{background:var(--p600);color:#fff;padding:11px 14px;display:flex;align-items:center;gap:9px;flex-shrink:0}
.chat-av{width:32px;height:32px;border-radius:50%;background:var(--a400);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.chat-title{font-weight:800;font-size:.87rem}
.chat-status{font-size:.63rem;opacity:.74}
.chat-msgs{padding:11px;height:280px;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;gap:7px;-webkit-overflow-scrolling:touch}
.msg{max-width:88%;padding:9px 12px;border-radius:14px;font-size:.83rem;line-height:1.6;word-break:break-word}
.msg.bot{background:var(--p50);border:1.5px solid var(--p100);align-self:flex-start;border-bottom-left-radius:4px}
.msg.user{background:var(--p600);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.msg.system{background:#FFF8E1;border:1.5px solid var(--a400);align-self:center;border-radius:10px;font-size:.78rem;color:#7A5200;max-width:95%;text-align:center}
.typing{display:none;align-self:flex-start}.typing.show{display:flex}
.dots{display:flex;gap:4px;padding:8px 12px;background:var(--p50);border:1.5px solid var(--p100);border-radius:14px;border-bottom-left-radius:4px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--p300);animation:bob 1.1s infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes bob{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
.chat-foot{display:flex;gap:6px;padding:9px 11px;border-top:2px solid var(--border);background:var(--surface);flex-shrink:0}
.chat-inp{flex:1;padding:9px 11px;border:2px solid var(--border);border-radius:var(--r-sm);font-size:.84rem;font-family:var(--font);min-width:0}
.chat-inp:focus{outline:none;border-color:var(--p600)}
.chat-send{background:var(--p600);color:#fff;border:none;padding:9px 14px;border-radius:var(--r-sm);font-size:.9rem;cursor:pointer;transition:.18s;flex-shrink:0}
.chat-send:hover{background:var(--p700)}

/* AI QUICK STATUS */
.ai-status-bar{background:var(--p50);border:1.5px solid var(--p100);border-radius:var(--r-sm);padding:8px 12px;margin-bottom:10px;font-size:.78rem;color:var(--p700);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.ai-status-bar strong{color:var(--p800)}

/* CONFIRM PILL */
.confirm-pill{display:inline-flex;gap:7px;margin-top:7px;flex-wrap:wrap}
.confirm-pill button{padding:7px 14px;border-radius:20px;font-size:.8rem;font-weight:800;cursor:pointer;border:2px solid;transition:.18s;font-family:var(--font)}
.pill-yes{background:var(--p600);color:#fff;border-color:var(--p600)}
.pill-yes:hover{background:var(--p700)}
.pill-no{background:#fff;color:var(--red);border-color:var(--red)}
.pill-no:hover{background:var(--red);color:#fff}

/* TAX BOX */
.tax-box{border-radius:var(--r-md);padding:16px;margin-bottom:12px;border:3px solid}
.tax-safe{background:#E8F5E9;border-color:#4CAF50}
.tax-warn{background:#FFF8E1;border-color:var(--a400)}
.tax-danger{background:var(--red-bg);border-color:var(--red)}
.tax-box .tx-icon{font-size:2rem;margin-bottom:6px;display:block;text-align:center}
.tax-box .tx-msg{font-size:1.2rem;font-weight:800;line-height:1.5;text-align:center;margin-bottom:8px}
.tax-safe .tx-msg{color:#2E7D32}
.tax-warn .tx-msg{color:#7A5200}
.tax-danger .tx-msg{color:var(--red)}
.tax-box .tx-detail{font-size:.82rem;color:var(--muted);line-height:1.8;background:rgba(255,255,255,.6);border-radius:var(--r-sm);padding:9px 11px;margin-top:6px}
.tax-box .tx-detail strong{color:var(--text)}
.tax-amount{font-size:1.5rem;font-weight:900;color:var(--red);text-align:center;display:block;margin:6px 0}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;align-items:flex-end;justify-content:center;padding:0}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r-lg) var(--r-lg) 0 0;padding:18px;width:100%;max-width:500px;box-shadow:var(--shadow-md);max-height:88vh;overflow-y:auto}
.modal h3{font-size:.94rem;font-weight:800;color:var(--p700);margin-bottom:10px}
.modal-btns{display:flex;gap:8px;margin-top:12px}
.modal-btns button{flex:1;padding:11px;border-radius:var(--r-sm);font-weight:800;font-size:.84rem;cursor:pointer;border:none;transition:.18s;font-family:var(--font)}
.modal-cancel{background:var(--surface);color:var(--muted);border:2px solid var(--border)!important}
.modal-confirm{background:var(--red);color:#fff}
.modal-confirm:hover{background:#b03a2e}
.stock-alert-modal{border:3px solid var(--red);border-radius:var(--r-lg) var(--r-lg) 0 0}
.stock-alert-modal h3{color:var(--red);font-size:1.1rem}
.stock-alert-msg{font-size:1.05rem;font-weight:700;color:var(--red);line-height:1.6;padding:10px 0;text-align:center}

/* EMPTY */
.empty{text-align:center;color:var(--muted);padding:22px 10px;font-size:.82rem}
.empty .ei{font-size:2rem;margin-bottom:5px}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--p700);color:#fff;padding:11px 22px;border-radius:30px;font-size:.88rem;font-weight:700;z-index:9999;transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .3s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow-md);opacity:0;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#toast.err{background:var(--red)}
#toast.ok{background:#27AE60}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¿ Tiá»ƒu ThÆ°Æ¡ng 4.0 <span class="badge">AI</span></h1>
  <p>Há»‡ thá»‘ng quáº£n lÃ½ kinh doanh thá»±c táº¿</p>
</header>

<div id="apiSetup">
  <label>ğŸ”‘ Gemini Key:</label>
  <input type="password" id="apiKeyInput" placeholder="DÃ¡n key táº¡i Ä‘Ã¢y..."/>
  <button id="saveKeyBtn" onclick="saveApiKey()">âœ… LÆ°u</button>
  <p id="apiStatus"></p>
</div>

<div id="monthBar">
  <label>ğŸ“… Ká»³:</label>
  <select id="monthSelect" onchange="switchMonth(this.value)"></select>
  <span class="month-badge" id="monthBadge">ğŸ“ ThÃ¡ng hiá»‡n táº¡i</span>
</div>

<div id="mainArea">

<!-- HOME -->
<div id="page-home" class="page active">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="totalThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="totalProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Š DÃ²ng tiá»n 7 ngÃ y gáº§n nháº¥t</div>
    <div class="ch-full"><canvas id="homeLineChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ•’ Giao dá»‹ch gáº§n Ä‘Ã¢y</div>
    <div id="homeRecentWrap"></div>
  </div>
</div>
</div>

<!-- THU / CHI -->
<div id="page-money" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Doanh thu</div><div class="s-val" id="totalThu2">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="totalChi2">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="totalProfit2">0Ä‘</div></div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchSub('inc',this)">ğŸ’° Thu / BÃ¡n</button>
    <button class="sub-tab" onclick="switchSub('imp',this)">ğŸ“¦ Nháº­p hÃ ng</button>
    <button class="sub-tab" onclick="switchSub('op',this)">âš¡ Chi phÃ­</button>
    <button class="sub-tab" onclick="switchSub('inv',this)">ğŸ—„ï¸ Tá»“n kho</button>
    <button class="sub-tab" onclick="switchSub('plan',this)">ğŸ“‹ Káº¿ hoáº¡ch</button>
  </div>

  <!-- THU -->
  <div id="msub-inc">
    <div class="card">
      <div class="card-title">ğŸ“· QuÃ©t Bill / HÃ³a Ä‘Æ¡n thanh toÃ¡n</div>
      <div class="card-sub">âš ï¸ Chá»‰ dÃ¹ng cho <strong>bill chuyá»ƒn khoáº£n hoáº·c hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n</strong>.</div>
      <div class="upload-area" id="incUploadArea" onclick="document.getElementById('incInvoiceFile').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p bill / hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n</strong><small>AI Ä‘á»c vÃ  ghi nháº­n giao dá»‹ch bÃ¡n hÃ ng</small>
      </div>
      <input type="file" id="incInvoiceFile" accept="image/*" style="display:none" onchange="handleIncInvoice(event)">
      <div class="img-preview-box" id="incImgPreviewBox">
        <img id="incInvoicePreview"/>
        <button class="img-change-btn" onclick="changeIncImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <button class="btn btn-primary" onclick="scanIncInvoice()" id="scanIncBtn" disabled style="margin-top:8px">ğŸ¤– AI Ä‘á»c bill â†’ Ghi nháº­n bÃ¡n hÃ ng</button>
      <div class="loader" id="scanIncLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c bill...</p></div>
      <div class="invoice-table-wrap" id="incInvoiceTableWrap"></div>
      <div class="autofill-notice" id="incAutofillNotice">âœ… AI Ä‘Ã£ Ä‘iá»n vÃ o form â€” kiá»ƒm tra rá»“i báº¥m "XÃ¡c nháº­n bÃ¡n hÃ ng"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p tay â€” Ghi nháº­n bÃ¡n hÃ ng</div>
      <div class="row2">
        <div class="field">
          <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
          <div class="cat-wrap">
            <input class="inp" id="incCatInput" placeholder="Nháº­p hoáº·c chá»n..." autocomplete="off"
              oninput="onCatInput('inc')" onfocus="openDrop('incCatDrop','inc')" onblur="setTimeout(()=>closeDrop('incCatDrop'),200)"/>
            <div class="cat-dropdown" id="incCatDrop"></div>
          </div>
        </div>
        <div class="field">
          <label>ğŸ›’ TÃªn hÃ ng bÃ¡n</label>
          <div class="sug-wrap">
            <input class="inp" id="incSellName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onSellInput()" onfocus="onSellInput()" onblur="setTimeout(closeSellSug,200)"/>
            <div class="sug-dropdown" id="sellSugDrop"></div>
          </div>
        </div>
      </div>
      <div class="chip-group" id="incChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£ thÃªm</label><input class="inp" type="text" id="incDesc" placeholder="VD: BÃ¡n cho khÃ¡ch quen..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng bÃ¡n</label><input class="inp" type="text" id="incQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’µ Tá»•ng tiá»n nháº­n</label><input class="inp" type="text" id="incAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y giao dá»‹ch</label><input class="inp" type="date" id="incDate"/></div>
      <button class="btn btn-primary" onclick="addIncome()">âœ… XÃ¡c nháº­n bÃ¡n hÃ ng (trá»« kho)</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ bÃ¡n hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('inc','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('inc','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('inc','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('inc','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="incSelectAll" onchange="toggleSelectAll('inc',this.checked)">
        <label for="incSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('inc')" id="incBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('inc')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="incTableWrap"></div>
    </div>
  </div>

  <!-- NHáº¬P HÃ€NG -->
  <div id="msub-imp" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ§¾ QuÃ©t hÃ³a Ä‘Æ¡n nháº­p hÃ ng</div>
      <div class="upload-area" id="expUploadArea" onclick="document.getElementById('invoiceImg').click()">
        <div class="u-icon">ğŸ§¾</div><strong>Chá»¥p hÃ³a Ä‘Æ¡n nhÃ  cung cáº¥p</strong><small>AI trÃ­ch xuáº¥t â†’ tá»± nháº­p vÃ o kho</small>
      </div>
      <input type="file" id="invoiceImg" accept="image/*" onchange="handleInvoiceImg(event)">
      <div class="img-preview-box" id="expImgPreviewBox">
        <img id="invoicePreview"/>
        <button class="img-change-btn" onclick="changeExpImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
      <button class="btn btn-primary" onclick="scanInvoice()" id="scanBtn" disabled style="margin-top:8px">ğŸ¤– TrÃ­ch xuáº¥t hÃ³a Ä‘Æ¡n</button>
      <div class="loader" id="scanLoader"><div class="spinner"></div><p>AI Ä‘ang Ä‘á»c hÃ³a Ä‘Æ¡n...</p></div>
      <div class="invoice-table-wrap" id="invoiceTableWrap"></div>
      <div id="invActions" style="display:none;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceTable()">ğŸ“‹ Sao chÃ©p báº£ng</button>
        <button class="btn btn-secondary btn-sm" onclick="copyInvoiceCSV()">ğŸ“¥ Xuáº¥t CSV</button>
        <button class="btn btn-primary btn-sm" onclick="autoFillImport()">âš¡ Tá»± nháº­p vÃ o kho</button>
      </div>
      <div class="autofill-notice" id="expAutofillNotice">âœ… ÄÃ£ Ä‘iá»n vÃ o form â€” kiá»ƒm tra rá»“i báº¥m "Nháº­p + cáº­p nháº­t kho"</div>
    </div>
    <div class="card">
      <div class="card-title">âœï¸ Nháº­p hÃ ng thá»§ cÃ´ng</div>
      <div class="row2">
        <div class="field">
          <label>ğŸ·ï¸ Loáº¡i hÃ ng</label>
          <div class="cat-wrap">
            <input class="inp" id="impCatInput" placeholder="Nháº­p hoáº·c chá»n..." autocomplete="off"
              oninput="onCatInput('imp')" onfocus="openDrop('impCatDrop','imp')" onblur="setTimeout(()=>closeDrop('impCatDrop'),200)"/>
            <div class="cat-dropdown" id="impCatDrop"></div>
          </div>
        </div>
        <div class="field">
          <label>ğŸ“ TÃªn hÃ ng</label>
          <div class="sug-wrap">
            <input class="inp" id="impName" placeholder="VD: MÃ¬ tÃ´m Háº£o Háº£o" autocomplete="off"
              oninput="onProdInput()" onfocus="onProdInput()" onblur="setTimeout(closeProdSug,200)"/>
            <div class="sug-dropdown" id="prodSugDrop"></div>
          </div>
        </div>
      </div>
      <div class="chip-group" id="impChips"></div>
      <div class="row2">
        <div class="field"><label>ğŸ“¦ Sá»‘ lÆ°á»£ng</label><input class="inp" type="text" id="impQty" placeholder="0" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ’° ThÃ nh tiá»n</label><input class="inp" type="text" id="impAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… NgÃ y nháº­p</label><input class="inp" type="date" id="impDate"/></div>
      <button class="btn btn-primary" onclick="addImport()">â• Nháº­p + cáº­p nháº­t kho</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Lá»‹ch sá»­ nháº­p hÃ ng</div>
      <div class="period-tabs">
        <button class="period-tab active" onclick="setPeriod('exp','all',this)">Táº¥t cáº£</button>
        <button class="period-tab" onclick="setPeriod('exp','today',this)">HÃ´m nay</button>
        <button class="period-tab" onclick="setPeriod('exp','week',this)">7 ngÃ y</button>
        <button class="period-tab" onclick="setPeriod('exp','month',this)">ThÃ¡ng</button>
      </div>
      <div class="bulk-bar">
        <input type="checkbox" id="expSelectAll" onchange="toggleSelectAll('exp',this.checked)">
        <label for="expSelectAll">Chá»n táº¥t cáº£</label>
        <button class="btn btn-danger btn-sm" onclick="bulkDelete('exp')" id="expBulkDelBtn" style="display:none">ğŸ—‘ï¸ XoÃ¡ Ä‘Ã£ chá»n</button>
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="confirmDeleteAll('exp')">âš ï¸ XoÃ¡ táº¥t cáº£</button>
      </div>
      <div id="expTableWrap"></div>
    </div>
  </div>

  <!-- CHI PHÃ THÃŠM -->
  <div id="msub-op" style="display:none">
    <div class="card">
      <div class="card-title">âš¡ Chi phÃ­ thÃªm</div>
      <div class="card-sub">Äiá»‡n, nÆ°á»›c, váº­n chuyá»ƒn â€” khÃ´ng áº£nh hÆ°á»Ÿng tá»“n kho</div>
      <div class="field">
        <label>ğŸ“‚ Loáº¡i</label>
        <select class="inp" id="opType" onchange="renderOpChips()">
          <option value="">-- Chá»n --</option>
          <option value="utility">ğŸ”Œ Äiá»‡n, nÆ°á»›c, internet</option>
          <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
          <option value="loss">ğŸ“‰ Hao há»¥t, hÃ ng há»ng</option>
          <option value="rental">ğŸª Máº·t báº±ng, kho</option>
          <option value="labor">ğŸ‘· NhÃ¢n cÃ´ng</option>
          <option value="other">ğŸ“Œ KhÃ¡c</option>
        </select>
      </div>
      <div class="chip-group" id="opChips"></div>
      <div class="field"><label>ğŸ“ MÃ´ táº£</label><input class="inp" type="text" id="opDesc" placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng nÃ y"/></div>
      <div class="row2">
        <div class="field"><label>ğŸ’µ Sá»‘ tiá»n</label><input class="inp" type="text" id="opAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
        <div class="field"><label>ğŸ“… NgÃ y</label><input class="inp" type="date" id="opDate"/></div>
      </div>
      <button class="btn btn-primary" onclick="addOperational()">â• ThÃªm chi phÃ­</button>
    </div>
  </div>

  <!-- Tá»’N KHO THÃ”NG MINH -->
  <div id="msub-inv" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ—„ï¸ Cáº£nh bÃ¡o tá»“n kho thÃ´ng minh</div>
      <div class="card-sub">Nháº­p âˆ’ BÃ¡n = Tá»“n. ğŸ”´ Háº¿t Â· ğŸŸ¡ &lt;5 Â· ğŸŸ¢ Äá»§ hÃ ng</div>
      <div id="inventorySmartView"></div>
      <button class="inv-ask-btn" onclick="askAIAboutInventory()">ğŸ¤– Há»i trá»£ lÃ½ vá» tÃ¬nh hÃ¬nh kho</button>
    </div>
  </div>

  <!-- Káº¾ HOáº CH -->
  <div id="msub-plan" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“‹ Káº¿ hoáº¡ch chi / nháº­p hÃ ng</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn káº¿ hoáº¡ch</label><input class="inp" type="text" id="planName" placeholder="VD: Nháº­p 50 thÃ¹ng bia..."/></div>
      <div class="row2">
        <div class="field"><label>ğŸ“‚ Loáº¡i</label>
          <select class="inp" id="planType">
            <option value="import">ğŸ“¦ Nháº­p hÃ ng</option>
            <option value="utility">ğŸ”Œ Äiá»‡n/NÆ°á»›c</option>
            <option value="transport">ğŸšš Váº­n chuyá»ƒn</option>
            <option value="rental">ğŸª Máº·t báº±ng</option>
            <option value="other">ğŸ“Œ KhÃ¡c</option>
          </select>
        </div>
        <div class="field"><label>ğŸ’µ Dá»± kiáº¿n</label><input class="inp" type="text" id="planAmount" placeholder="0 Ä‘" oninput="handleMoney(this)" onkeydown="blockNonDigit(event)"/></div>
      </div>
      <div class="field"><label>ğŸ“… Ãp dá»¥ng thÃ¡ng</label><select class="inp" id="planMonth"></select></div>
      <div class="field"><label>ğŸ“ Ghi chÃº</label><input class="inp" type="text" id="planNote" placeholder="Ghi chÃº thÃªm..."/></div>
      <button class="btn btn-primary" onclick="addPlan()">â• ThÃªm káº¿ hoáº¡ch</button>
    </div>
    <div class="card"><div class="card-title">ğŸ“… Danh sÃ¡ch káº¿ hoáº¡ch</div><div id="planList"></div></div>
  </div>
</div>
</div>

<!-- QUáº¢NG BÃ -->
<div id="page-promo" class="page">
<div class="page-inner">
  <div class="card" style="background:#FFF8E1;border:2px solid var(--a400)">
    <div class="card-title">ğŸ“£ Tab nÃ y chá»‰ dÃ¹ng Ä‘á»ƒ viáº¿t bÃ i Marketing</div>
    <div class="card-sub">áº¢nh sáº£n pháº©m á»Ÿ Ä‘Ã¢y <strong>KHÃ”NG</strong> lÆ°u vÃ o kho. Khi cÃ³ Ä‘Æ¡n hÃ ng tháº­t â†’ vÃ o Tab <strong>Thu/Chi</strong>.</div>
  </div>
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchPromoSub('fb',this)">ğŸ“£ BÃ i Ä‘Äƒng FB</button>
    <button class="sub-tab" onclick="switchPromoSub('tt',this)">ğŸ¬ TikTok</button>
  </div>
  <div id="psub-fb">
    <div class="card">
      <div class="card-title">ğŸ“£ Viáº¿t bÃ i Facebook tá»« áº£nh sáº£n pháº©m</div>
      <div class="upload-area" id="fbUploadArea" onclick="document.getElementById('fbImgInput').click()">
        <div class="u-icon">ğŸ–¼ï¸</div><strong>Chá»n áº£nh sáº£n pháº©m Ä‘á»ƒ viáº¿t bÃ i</strong><small>AI phÃ¢n tÃ­ch vÃ  viáº¿t bÃ i quáº£ng cÃ¡o</small>
      </div>
      <input type="file" id="fbImgInput" accept="image/*" onchange="handleFbImg(event)">
      <div class="img-preview-box" id="fbImgPreviewBox">
        <img id="fbPreview"/><button class="img-change-btn" onclick="changeFbImg()">âœï¸ Äá»•i áº£nh</button>
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateFbPost()" id="fbPostBtn" disabled>ğŸ¤– AI viáº¿t bÃ i Facebook</button>
    <div class="card" id="fbResultCard" style="display:none">
      <div class="card-title">âœï¸ BÃ i Ä‘Äƒng Ä‘Ã£ viáº¿t</div>
      <div class="loader" id="fbLoader"><div class="spinner"></div><p>AI Ä‘ang viáº¿t bÃ i...</p></div>
      <div class="result-box" id="fbPost"></div>
      <button class="copy-btn" id="copyFb" onclick="doCopy('fbPost','copyFb')">ğŸ“‹ Sao chÃ©p bÃ i</button>
    </div>
  </div>
  <div id="psub-tt" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ¬ HÆ°á»›ng dáº«n quay TikTok</div>
      <div class="field"><label>ğŸ·ï¸ TÃªn sáº£n pháº©m</label><input class="inp" type="text" id="ttProduct" placeholder="VD: Háº¡t bÃ­ rang muá»‘i..."/></div>
      <div class="field"><label>ğŸ‘¤ NgÆ°á»i quay</label>
        <select class="inp" id="ttRole">
          <option value="ba">ğŸ‘µ BÃ  / CÃ´ lá»›n tuá»•i</option>
          <option value="chu">ğŸ‘¨ ChÃº / Ã”ng chá»§</option>
          <option value="me">ğŸ‘© Máº¹ / CÃ´ chá»§</option>
          <option value="ban">ğŸ§‘ Báº¡n tráº»</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary" onclick="generateScript()" id="scriptBtn">ğŸ¥ Táº¡o hÆ°á»›ng dáº«n quay</button>
    <div class="card" id="videoResult" style="display:none">
      <div class="card-title">ğŸï¸ HÆ°á»›ng dáº«n cá»§a báº¡n</div>
      <div class="loader" id="videoLoader"><div class="spinner"></div><p>AI Ä‘ang soáº¡n...</p></div>
      <div class="result-box" id="scriptBox"></div>
      <button class="copy-btn" id="copyScript" onclick="doCopy('scriptBox','copyScript')">ğŸ“‹ Sao chÃ©p</button>
    </div>
  </div>
</div>
</div>

<!-- BÃO CÃO -->
<div id="page-reports" class="page">
<div class="page-inner">
  <div class="sub-tabs">
    <button class="sub-tab active" onclick="switchReportSub('chart',this)">ğŸ“Š BÃ¡o cÃ¡o</button>
    <button class="sub-tab" onclick="switchReportSub('compare',this)">ğŸ“ˆ So sÃ¡nh</button>
    <button class="sub-tab" onclick="switchReportSub('tax',this)">ğŸ§¾ Thuáº¿</button>
  </div>
  <div id="rsub-chart">
    <div class="period-tabs">
      <button class="period-tab active" onclick="setChartPeriod('week',this)">7 ngÃ y</button>
      <button class="period-tab" onclick="setChartPeriod('month',this)">ThÃ¡ng</button>
      <button class="period-tab" onclick="setChartPeriod('all',this)">Táº¥t cáº£</button>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š BÃ¡o cÃ¡o â€” <span id="chartMonthLabel" style="font-weight:400;font-size:.79rem;color:var(--muted)"></span></div>
      <div id="noChartData" class="empty" style="display:none"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>
      <div id="chartContent">
        <div class="charts-grid">
          <div class="ch-card"><h3>ğŸ¥§ Thu / Chi</h3><div class="ch-wrap"><canvas id="pieChart"></canvas></div></div>
          <div class="ch-card"><h3>ğŸ“¦ Loáº¡i chi</h3><div class="ch-wrap"><canvas id="barChart"></canvas></div></div>
        </div>
        <div class="ch-card"><h3>ğŸ“ˆ DÃ²ng tiá»n</h3><div class="ch-full"><canvas id="lineChart"></canvas></div></div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="refreshCharts()">ğŸ”„ LÃ m má»›i</button>
  </div>
  <div id="rsub-compare" style="display:none">
    <div class="card">
      <div class="card-title">ğŸ“ˆ So sÃ¡nh cÃ¡c thÃ¡ng</div>
      <div class="row2">
        <div class="field"><label>ThÃ¡ng A</label><select class="inp" id="cmpA"></select></div>
        <div class="field"><label>ThÃ¡ng B</label><select class="inp" id="cmpB"></select></div>
      </div>
      <button class="btn btn-primary" onclick="showCompare()">ğŸ“Š So sÃ¡nh</button>
      <div class="compare-box" id="compareBox"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ—“ï¸ Tá»•ng há»£p táº¥t cáº£ thá»i gian</div>
      <div id="allTimeCompare"></div>
      <button class="btn btn-secondary" style="margin-top:8px" onclick="buildAllTimeCompare()">ğŸ”„ Cáº­p nháº­t</button>
    </div>
  </div>
  <div id="rsub-tax" style="display:none">
    <div id="taxAssistantBox"></div>
    <div class="card">
      <div class="card-sub" style="font-size:.76rem;color:var(--muted);line-height:1.8;margin:0">
        <strong>ğŸ“Œ Quy Ä‘á»‹nh thuáº¿ há»™ kinh doanh 2026:</strong><br>
        â€¢ Doanh thu â‰¤ 500 triá»‡u/nÄƒm â†’ <strong>Miá»…n thuáº¿</strong><br>
        â€¢ Doanh thu > 500 triá»‡u/nÄƒm â†’ Ná»™p thuáº¿ khoÃ¡n <strong>1.5%</strong><br>
        â€¢ NgÆ°á»¡ng trung bÃ¬nh/thÃ¡ng: <strong>41.666.667Ä‘</strong>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="renderTaxAssistant()">ğŸ”„ Cáº­p nháº­t</button>
  </div>
</div>
</div>

<!-- AI CHAT -->
<div id="page-ai" class="page">
<div class="page-inner">
  <div class="ai-status-bar" id="aiStatusBar">
    <span>ğŸ“¦</span>
    <span id="aiInvSummary">Äang táº£i dá»¯ liá»‡u kho...</span>
  </div>
  <div class="card" style="background:var(--p50);border:2px solid var(--p100);margin-bottom:10px">
    <div class="card-title">ğŸ¤– Trá»£ lÃ½ nháº­p liá»‡u báº±ng tin nháº¯n</div>
    <div class="card-sub">Nháº¯n Ä‘á»ƒ ghi giao dá»‹ch:<br>
      â€¢ "<strong>BÃ¡n</strong> 5 gÃ³i háº¡t bÃ­ 25.000Ä‘"&nbsp;&nbsp;â€¢ "<strong>Nháº­p thÃªm</strong> 20 tÃºi háº¡t dÆ°a"<br>
      â€¢ "ThÃ¡ng nÃ y lÃ£i bao nhiÃªu?"&nbsp;&nbsp;â€¢ "HÃ ng nÃ o sáº¯p háº¿t?"
    </div>
  </div>
  <div class="chat-box">
    <div class="chat-head">
      <div class="chat-av">ğŸŒ¿</div>
      <div><div class="chat-title">Trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI</div><div class="chat-status" id="chatStatusDot">â— Sáºµn sÃ ng</div></div>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg bot">ğŸ‘‹ ChÃ o bÃ /cÃ´/chÃº! Nháº¯n gÃ¬ mÃ¬nh giÃºp liá»n:<br>
        â€¢ Ghi <strong>bÃ¡n</strong>: "BÃ¡n 5 gÃ³i mÃ¬ 15k"<br>
        â€¢ Ghi <strong>nháº­p</strong>: "Nháº­p 30 thÃ¹ng bia 180k"<br>
        â€¢ Há»i <strong>kho</strong>: "HÃ ng nÃ o sáº¯p háº¿t?"
      </div>
      <div class="typing" id="chatTyping"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
    </div>
    <div class="chat-foot">
      <input class="chat-inp" id="chatInp" placeholder="Nháº¯n: BÃ¡n 5 gÃ³i mÃ¬... hoáº·c Nháº­p 20 chai..." onkeydown="if(event.key==='Enter')sendChat()"/>
      <button class="chat-send" onclick="sendChat()">â¤</button>
    </div>
  </div>
</div>
</div>

<!-- Lá»ŠCH Sá»¬ -->
<div id="page-history" class="page">
<div class="page-inner">
  <div class="sum-strip">
    <div class="s-card s-thu"><div class="s-lbl">ğŸ“ˆ Tá»•ng Thu</div><div class="s-val" id="histAllThu">0Ä‘</div></div>
    <div class="s-card s-chi"><div class="s-lbl">ğŸ“‰ Tá»•ng Chi</div><div class="s-val" id="histAllChi">0Ä‘</div></div>
    <div class="s-card s-profit"><div class="s-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="s-val" id="histAllProfit">0Ä‘</div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ§¾ ToÃ n bá»™ lá»‹ch sá»­ giao dá»‹ch</div>
    <div class="history-filters">
      <input type="text" id="histSearch" placeholder="ğŸ” TÃ¬m tÃªn hÃ ng, mÃ´ táº£..." oninput="renderHistory()"/>
      <select id="histTypeFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ loáº¡i</option>
        <option value="Xuáº¥t">ğŸ’° BÃ¡n hÃ ng</option>
        <option value="Nháº­p">ğŸ“¦ Nháº­p hÃ ng</option>
        <option value="op">âš¡ Chi phÃ­</option>
      </select>
      <select id="histMonthFilter" onchange="renderHistory()">
        <option value="">Táº¥t cáº£ thÃ¡ng</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="exportFilteredCSV()">ğŸ“¥ CSV</button>
    </div>
    <div id="histTableWrap"></div>
  </div>
</div>
</div>

</div><!-- /mainArea -->

<nav class="bottom-nav">
  <button class="bn-btn active" onclick="switchPage('home',this)"><span class="ni">ğŸ </span><span class="nl">Tá»•ng quan</span></button>
  <button class="bn-btn" onclick="switchPage('money',this)"><span class="ni">ğŸ’°</span><span class="nl">Thu/Chi</span></button>
  <button class="bn-btn" onclick="switchPage('promo',this)"><span class="ni">ğŸ“£</span><span class="nl">Quáº£ng bÃ¡</span></button>
  <button class="bn-btn" onclick="switchPage('reports',this)"><span class="ni">ğŸ“Š</span><span class="nl">BÃ¡o cÃ¡o</span></button>
  <button class="bn-btn" onclick="switchPage('ai',this)"><span class="ni">ğŸ¤–</span><span class="nl">AI</span></button>
  <button class="bn-btn" onclick="switchPage('history',this)"><span class="ni">ğŸ“š</span><span class="nl">Lá»‹ch sá»­</span></button>
</nav>

<!-- CONFIRM MODAL -->
<div class="overlay" id="confirmOverlay">
  <div class="modal">
    <h3 id="confirmTitle">XÃ¡c nháº­n</h3>
    <p id="confirmMsg" style="font-size:.84rem;color:var(--muted);margin-bottom:4px;line-height:1.6"></p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeConfirm()">Huá»·</button>
      <button class="modal-confirm" id="confirmOkBtn">XÃ¡c nháº­n</button>
    </div>
  </div>
</div>

<!-- STOCK ALERT MODAL -->
<div class="overlay" id="stockAlertOverlay">
  <div class="modal stock-alert-modal">
    <h3>âš ï¸ Cáº£nh bÃ¡o tá»“n kho!</h3>
    <div class="stock-alert-msg" id="stockAlertMsg"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeStockAlert()">Huá»· bá» giao dá»‹ch</button>
      <button style="flex:1;padding:11px;border-radius:var(--r-sm);font-weight:800;font-size:.84rem;cursor:pointer;background:var(--a400);color:#1A2E23;border:none" onclick="forceConfirmSale()">Váº«n ghi nháº­n</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* â•â• CONSTANTS â•â• */
const STORAGE_KEY='tt40_tx';
const META_KEY_PFX='tt40_meta_';
const TAX_RATE=0.015;
const TAX_THRESHOLD=500_000_000;
const LOW_STOCK=5;
const GEMINI_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent';
const TODAY=new Date().toISOString().slice(0,10);
let API_KEY=localStorage.getItem('tt40_key')||'';

/* â•â• STORAGE â•â• */
function getAllTx(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{return[];}}
function setAllTx(arr){localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));}
function saveTx(data){
  const arr=getAllTx();
  const entry={id:data.id||Date.now(),name:(data.name||'').trim(),qty:Number(data.qty)||1,price:Number(data.price)||0,type:data.type,date:data.date||TODAY,monthKey:data.monthKey||currentMonth,desc:data.desc||'',cat:data.cat||''};
  arr.push(entry);setAllTx(arr);return entry;
}
function removeTxById(id){setAllTx(getAllTx().filter(x=>x.id!==id));}
function removeTxByIds(ids){const s=new Set(ids);setAllTx(getAllTx().filter(x=>!s.has(x.id)));}
function clearTxByMonthType(mk,type){setAllTx(getAllTx().filter(x=>!(x.monthKey===mk&&x.type===type)));}

/* â•â• INVENTORY â•â• */
function computeInventory(){
  const map={};
  getAllTx().forEach(t=>{
    if(!map[t.name])map[t.name]={name:t.name,totalIn:0,totalOut:0,lastPrice:0,lastInDate:null};
    if(t.type==='Nháº­p'){map[t.name].totalIn+=t.qty;if(t.price>0)map[t.name].lastPrice=t.price;if(!map[t.name].lastInDate||t.date>map[t.name].lastInDate)map[t.name].lastInDate=t.date;}
    else if(t.type==='Xuáº¥t')map[t.name].totalOut+=t.qty;
  });
  return Object.values(map).map(x=>({...x,stock:Math.max(0,x.totalIn-x.totalOut)})).filter(x=>x.totalIn>0);
}

function getInventorySummary(){
  const inv=computeInventory();
  if(!inv.length)return'Kho trá»‘ng chÆ°a cÃ³ hÃ ng.';
  const out=inv.filter(x=>x.stock===0).map(x=>x.name);
  const low=inv.filter(x=>x.stock>0&&x.stock<LOW_STOCK).map(x=>`${x.name}(${x.stock})`);
  const ok=inv.filter(x=>x.stock>=LOW_STOCK);
  let s=`Tá»•ng ${inv.length} máº·t hÃ ng trong kho. `;
  if(out.length)s+=`ÄÃ£ háº¿t: ${out.join(', ')}. `;
  if(low.length)s+=`Sáº¯p háº¿t(dÆ°á»›i 5): ${low.join(', ')}. `;
  s+=`HÃ ng Ä‘á»§: ${ok.map(x=>`${x.name}(${x.stock})`).join(', ')||'khÃ´ng cÃ³'}.`;
  return s;
}

function checkStock(name,qty){
  const inv=computeInventory();
  const item=inv.find(x=>x.name.toLowerCase()===name.toLowerCase());
  const stock=item?item.stock:0;
  return{ok:stock>=qty,stock};
}

/* â•â• META â•â• */
function loadMeta(k){try{const r=localStorage.getItem(META_KEY_PFX+k);if(!r)return emptyMeta();const d=JSON.parse(r);['categories','products','plans','operational'].forEach(key=>{if(!d[key])d[key]=emptyMeta()[key];});return d;}catch{return emptyMeta();}}
function saveMeta(k,d){localStorage.setItem(META_KEY_PFX+k,JSON.stringify(d));}
function emptyMeta(){return{categories:['MÃ¬ tÃ´m','Trá»©ng gÃ ','NÆ°á»›c máº¯m','Gáº¡o','Bia/NÆ°á»›c ngá»t','BÃ¡nh káº¹o','Thá»§ cÃ´ng','Rau cá»§'],products:[],plans:[],operational:[]};}

/* â•â• MONTH â•â• */
const getCurKey=()=>new Date().toISOString().slice(0,7);
const monthLabel=k=>{const[y,m]=k.split('-');return`ThÃ¡ng ${parseInt(m)}/${y}`;};
function getMonthOpts(){
  const k=new Set();
  for(let i=0;i<4;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()-i);k.add(d.toISOString().slice(0,7));}
  getAllTx().forEach(x=>{if(x.monthKey)k.add(x.monthKey);});
  Object.keys(localStorage).forEach(x=>{if(x.startsWith(META_KEY_PFX+'20'))k.add(x.replace(META_KEY_PFX,''));});
  return[...k].sort().reverse();
}
let currentMonth=getCurKey();
let META=loadMeta(currentMonth);
function persist(){saveMeta(currentMonth,META);buildMonthSelect();}

function buildMonthSelect(){
  const cur=getCurKey(),opts=getMonthOpts();
  const sel=document.getElementById('monthSelect');
  if(!sel)return;
  sel.innerHTML=opts.map(k=>`<option value="${k}"${k===currentMonth?' selected':''}>${monthLabel(k)}${k===cur?' â­':''}</option>`).join('');
  ['monthBadge','chartMonthLabel'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=id==='monthBadge'?(currentMonth===cur?'ğŸ“ ThÃ¡ng hiá»‡n táº¡i':monthLabel(currentMonth)):monthLabel(currentMonth);});
  const ca=document.getElementById('cmpA'),cb=document.getElementById('cmpB');
  if(ca)ca.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');
  if(cb){cb.innerHTML=opts.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');if(opts.length>1)cb.value=opts[1];}
  const pm=document.getElementById('planMonth');
  if(pm){const f=[];for(let i=0;i<=3;i++){const d=new Date();d.setDate(1);d.setMonth(d.getMonth()+i);f.push(d.toISOString().slice(0,7));}pm.innerHTML=f.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');}
}

function switchMonth(k){currentMonth=k;META=loadMeta(k);buildMonthSelect();renderAll();
  if(document.getElementById('page-reports').classList.contains('active'))setTimeout(refreshCharts,80);
  if(document.getElementById('page-history').classList.contains('active'))renderHistory();
}

/* â•â• API KEY â•â• */
function saveApiKey(){
  const v=document.getElementById('apiKeyInput').value.trim();
  if(!v){showSt('âš ï¸ Nháº­p key!','#c62828');return;}
  API_KEY=v;localStorage.setItem('tt40_key',v);showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');
  document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';
}
function showSt(m,c){const e=document.getElementById('apiStatus');if(e){e.textContent=m;e.style.color=c;}}
if(API_KEY){document.getElementById('apiKeyInput').value=API_KEY;showSt('âœ… Sáºµn sÃ ng!','#1B6B3A');document.getElementById('apiSetup').style.cssText+=';background:#F1F8E9;border-bottom-color:#6ABF8A';}

/* â•â• PAGE SWITCHING â•â• */
function switchPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='reports')setTimeout(refreshCharts,80);
  if(name==='home'){renderSummary();renderHomeRecent();setTimeout(refreshHomeChart,80);}
  if(name==='history')renderHistory();
  if(name==='ai')updateAIStatusBar();
}
function switchSub(name,btn){
  ['inc','imp','op','inv','plan'].forEach(n=>{const e=document.getElementById('msub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-money .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='inv')renderInventory();
  if(name==='plan')renderPlans();
}
function switchPromoSub(name,btn){
  ['fb','tt'].forEach(n=>{const e=document.getElementById('psub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-promo .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}
function switchReportSub(name,btn){
  ['chart','compare','tax'].forEach(n=>{const e=document.getElementById('rsub-'+n);if(e)e.style.display=n===name?'block':'none';});
  document.querySelectorAll('#page-reports .sub-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(name==='chart')setTimeout(refreshCharts,80);
  if(name==='compare')buildAllTimeCompare();
  if(name==='tax')renderTaxAssistant();
}

/* â•â• PERIOD FILTER â•â• */
let incPeriod='all',expPeriod='all',chartPeriod='week';
function setPeriod(type,p,btn){
  if(type==='inc')incPeriod=p;else expPeriod=p;
  const sel=type==='inc'?'#msub-inc .period-tab':'#msub-imp .period-tab';
  document.querySelectorAll(sel).forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(type==='inc')renderIncTable();else renderExpTable();
}
function filterByPeriod(arr,period){
  if(period==='all')return arr;
  const now=new Date();
  return arr.filter(x=>{
    if(!x.date)return false;
    const d=new Date(x.date+'T00:00:00');
    if(period==='today')return x.date===TODAY;
    if(period==='week'){const w=new Date(now);w.setDate(now.getDate()-6);return d>=w;}
    if(period==='month')return x.date&&x.date.slice(0,7)===currentMonth;
    return true;
  });
}
function setChartPeriod(p,btn){chartPeriod=p;document.querySelectorAll('#rsub-chart .period-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');refreshCharts();}

/* â•â• INPUT HELPERS â•â• */
function handleMoney(el){const d=el.value.replace(/\D/g,'');el.dataset.raw=d;el.value=d?parseInt(d,10).toLocaleString('vi-VN'):'';}
function blockNonDigit(e){const safe=['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];if(!safe.includes(e.key)&&!/^\d$/.test(e.key))e.preventDefault();}
function getRaw(id){const el=document.getElementById(id);return el?parseInt(el.dataset.raw||'0',10)||0:0;}
function clearFields(...ids){ids.forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.dataset.raw='';}});}

/* â•â• COPY â•â• */
async function writeClip(text){
  try{if(window.isSecureContext&&navigator.clipboard?.writeText){await navigator.clipboard.writeText(text);return true;}const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;top:-9999px';document.body.appendChild(ta);ta.focus();ta.select();const ok=document.execCommand('copy');document.body.removeChild(ta);return ok;}catch{return false;}
}
async function doCopy(boxId,btnId){
  const box=document.getElementById(boxId);if(!box)return;const text=box.textContent.trim();
  if(!text){showToast('âš ï¸ KhÃ´ng cÃ³ ná»™i dung!',true);return;}
  const ok=await writeClip(text);
  if(ok){showToast('ğŸ“‹ ÄÃ£ sao chÃ©p!');if(btnId){const b=document.getElementById(btnId);if(b){const o=b.innerHTML;b.innerHTML='âœ… ÄÃ£ sao chÃ©p!';b.classList.add('ok');b.disabled=true;setTimeout(()=>{b.innerHTML=o;b.classList.remove('ok');b.disabled=false;},2000);}}}
  else showToast('âŒ Thá»­ bÃ´i Ä‘en + Ctrl+C',true);
}
async function copyRaw(text,msg){const ok=await writeClip(text);showToast(ok?msg:'âŒ KhÃ´ng sao chÃ©p Ä‘Æ°á»£c',!ok);}

/* â•â• CATEGORY DROPDOWN â•â• */
const getCats=()=>META.categories||[];
function openDrop(dropId,prefix){const inp=document.getElementById(prefix+'CatInput');renderCatDD(dropId,prefix,inp?inp.value.toLowerCase():'');}
function closeDrop(dropId){const el=document.getElementById(dropId);if(el)el.classList.remove('open');}
function onCatInput(prefix){
  const inp=document.getElementById(prefix+'CatInput');if(!inp)return;
  renderCatDD(prefix+'CatDrop',prefix,inp.value.toLowerCase());
  const exact=getCats().find(c=>c.toLowerCase()===inp.value.toLowerCase());
  if(exact)renderChipsFor(prefix,exact);
  else{const chips=document.getElementById(prefix+'Chips');if(chips)chips.innerHTML='';}
}
function renderCatDD(dropId,prefix,val){
  const drop=document.getElementById(dropId);if(!drop)return;drop.innerHTML='';
  const filtered=val?getCats().filter(c=>c.toLowerCase().includes(val)):getCats();
  filtered.forEach(c=>{const d=document.createElement('div');d.className='cat-opt';d.textContent=c;d.onmousedown=()=>{document.getElementById(prefix+'CatInput').value=c;closeDrop(dropId);renderChipsFor(prefix,c);};drop.appendChild(d);});
  if(val){
    const prodMatches=(META.products||[]).filter(p=>p.toLowerCase().includes(val)&&!getCats().some(c=>c.toLowerCase()===p.toLowerCase()));
    prodMatches.slice(0,3).forEach(p=>{const d=document.createElement('div');d.className='cat-opt new-item';d.textContent='ğŸ“¦ DÃ¹ng tÃªn: "'+p+'"';d.onmousedown=()=>{document.getElementById(prefix+'CatInput').value=p;closeDrop(dropId);};drop.appendChild(d);});
  }
  if(val&&!getCats().some(c=>c.toLowerCase()===val)){
    const d=document.createElement('div');d.className='cat-opt new-item';d.textContent='â• Táº¡o loáº¡i má»›i: "'+val+'"';
    d.onmousedown=()=>{const p=val.charAt(0).toUpperCase()+val.slice(1);if(!META.categories.includes(p)){META.categories.push(p);persist();}document.getElementById(prefix+'CatInput').value=p;closeDrop(dropId);renderChipsFor(prefix,p);showToast('âœ… ÄÃ£ táº¡o loáº¡i "'+p+'"');};
    drop.appendChild(d);
  }
  drop.classList.toggle('open',drop.children.length>0);
}
function onProdInput(){
  const inp=document.getElementById('impName'),drop=document.getElementById('prodSugDrop');if(!inp||!drop)return;
  const val=inp.value.toLowerCase();const m=val?(META.products||[]).filter(p=>p.toLowerCase().includes(val)):META.products||[];
  drop.innerHTML='';if(!m.length){drop.classList.remove('open');return;}
  m.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.textContent=p;d.onmousedown=()=>{inp.value=p;drop.classList.remove('open');const cat=document.getElementById('impCatInput');if(cat&&!cat.value){const match=getCats().find(c=>p.toLowerCase().includes(c.toLowerCase()));if(match)cat.value=match;}};drop.appendChild(d);});
  drop.classList.add('open');
}
function closeProdSug(){const el=document.getElementById('prodSugDrop');if(el)el.classList.remove('open');}
function saveProduct(name){if(!name)return;if(!META.products.includes(name)){META.products.push(name);persist();}}
function onSellInput(){
  const inp=document.getElementById('incSellName'),drop=document.getElementById('sellSugDrop');if(!inp||!drop)return;
  const val=inp.value.toLowerCase();
  const pool=[...new Set([...(META.products||[]),...getCats()])];
  const m=val?pool.filter(p=>p.toLowerCase().includes(val)):pool;
  drop.innerHTML='';if(!m.length){drop.classList.remove('open');return;}
  m.slice(0,8).forEach(p=>{const d=document.createElement('div');d.className='sug-opt';d.textContent=p;d.onmousedown=()=>{inp.value=p;drop.classList.remove('open');const cat=document.getElementById('incCatInput');if(cat&&!cat.value){const match=getCats().find(c=>p.toLowerCase().includes(c.toLowerCase()));if(match)cat.value=match;}};drop.appendChild(d);});
  drop.classList.add('open');
}
function closeSellSug(){const el=document.getElementById('sellSugDrop');if(el)el.classList.remove('open');}

/* â•â• CHIPS â•â• */
const SMAP={'MÃ¬ tÃ´m':{thu:['BÃ¡n láº» mÃ¬','Combo mÃ¬+trá»©ng'],chi:['Nháº­p mÃ¬ tÃ´m','PhÃ­ váº­n chuyá»ƒn']},'Trá»©ng gÃ ':{thu:['BÃ¡n trá»©ng láº»','BÃ¡n vá»‰ 10'],chi:['Mua cÃ¡m','Hao há»¥t vá»¡']},'NÆ°á»›c máº¯m':{thu:['BÃ¡n chai láº»'],chi:['Nháº­p nÆ°á»›c máº¯m']},'Gáº¡o':{thu:['BÃ¡n gáº¡o láº» kg'],chi:['Nháº­p gáº¡o']},'Bia/NÆ°á»›c ngá»t':{thu:['BÃ¡n bia láº»'],chi:['Nháº­p bia']},'BÃ¡nh káº¹o':{thu:['BÃ¡n láº»'],chi:['Nháº­p bÃ¡nh']},'Thá»§ cÃ´ng':{thu:['BÃ¡n táº¡i chá»£'],chi:['NguyÃªn váº­t liá»‡u']},'Rau cá»§':{thu:['BÃ¡n láº»'],chi:['Nháº­p tá»« vÆ°á»n']}};
const OP_SMAP={utility:['Tiá»n Ä‘iá»‡n','Tiá»n nÆ°á»›c'],transport:['Váº­n chuyá»ƒn nháº­p','Ship khÃ¡ch'],loss:['HÃ ng há»ng','Tráº£ hÃ ng'],rental:['ThuÃª máº·t báº±ng'],labor:['LÆ°Æ¡ng nhÃ¢n viÃªn'],other:['Chi phÃ­ phÃ¡t sinh']};
function renderChipsFor(prefix,cat){const isInc=prefix==='inc';const el=document.getElementById(prefix+'Chips');if(!el)return;el.innerHTML='';const map=SMAP[cat];if(!map)return;(isInc?map.thu:map.chi).forEach(t=>{const c=document.createElement('button');c.className='chip'+(isInc?'':' chi-c');c.textContent=(isInc?'ğŸ’° ':'ğŸ’¸ ')+t;c.onclick=()=>{const d=document.getElementById(isInc?'incDesc':'impName');if(d)d.value=t;};el.appendChild(c);});}
function renderOpChips(){const t=document.getElementById('opType').value,el=document.getElementById('opChips');if(!el)return;el.innerHTML='';(OP_SMAP[t]||[]).forEach(item=>{const c=document.createElement('button');c.className='chip chi-c';c.textContent='ğŸ’¸ '+item;c.onclick=()=>{const d=document.getElementById('opDesc');if(d)d.value=item;};el.appendChild(c);});}

/* â•â• CONFIRM / STOCK MODALS â•â• */
let pendingSaleFn=null;
function showConfirm(title,msg,fn){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmOverlay').classList.add('show');document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();fn();};}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('show');}
function showStockAlert(msg,forceFn){document.getElementById('stockAlertMsg').innerHTML=msg;document.getElementById('stockAlertOverlay').classList.add('show');pendingSaleFn=forceFn;}
function closeStockAlert(){document.getElementById('stockAlertOverlay').classList.remove('show');pendingSaleFn=null;}
function forceConfirmSale(){closeStockAlert();if(pendingSaleFn)pendingSaleFn();}

/* â•â• ADD INCOME â•â• */
function addIncome(forceSkipCheck=false){
  const sellName=(document.getElementById('incSellName')||{value:''}).value.trim();
  const desc=(document.getElementById('incDesc')||{value:''}).value.trim();
  const amt=getRaw('incAmount'),qty=getRaw('incQty'),date=(document.getElementById('incDate')||{value:''}).value;
  const cat=(document.getElementById('incCatInput')||{value:''}).value.trim();
  const name=sellName||desc;
  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng bÃ¡n!',true);return;}
  if(!amt){showToast('âš ï¸ Nháº­p tá»•ng tiá»n!',true);return;}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  const qtyReal=qty||1;
  if(!forceSkipCheck&&name){
    const{ok,stock}=checkStock(name,qtyReal);
    if(!ok){showStockAlert(`<strong>${name}</strong><br>Kho cÃ²n: <strong>${stock}</strong> cÃ¡i<br>Äá»‹nh bÃ¡n: <strong>${qtyReal}</strong> cÃ¡i<br><br>BÃ  Æ¡i, hÃ ng trong kho khÃ´ng Ä‘á»§!`,()=>doSaveSale({name,qty:qtyReal,amt,date,cat,desc,sellName}));return;}
  }
  doSaveSale({name,qty:qtyReal,amt,date,cat,desc,sellName});
}
function doSaveSale({name,qty,amt,date,cat,desc,sellName}){
  const unitPrice=qty>0?Math.round(amt/qty):amt;
  saveTx({name,qty,price:unitPrice,type:'Xuáº¥t',date,monthKey:currentMonth,desc:desc||('BÃ¡n '+name),cat});
  if(sellName)saveProduct(sellName);
  renderAll();clearFields('incDesc','incAmount','incQty','incSellName');
  showToast(`âœ… ÄÃ£ ghi nháº­n bÃ¡n ${qty} ${name}!`,'',true);
}
function delIncome(id){showConfirm('XoÃ¡ giao dá»‹ch bÃ¡n','XoÃ¡ giao dá»‹ch nÃ y?',()=>{removeTxById(id);renderAll();showToast('âœ… ÄÃ£ xoÃ¡!');});}

/* â•â• ADD IMPORT â•â• */
function addImport(){
  const name=(document.getElementById('impName')||{value:''}).value.trim();
  const qty=getRaw('impQty'),amt=getRaw('impAmount'),date=(document.getElementById('impDate')||{value:''}).value;
  const cat=(document.getElementById('impCatInput')||{value:''}).value.trim();
  if(!name){showToast('âš ï¸ Nháº­p tÃªn hÃ ng!',true);return;}
  if(!amt){showToast('âš ï¸ Nháº­p thÃ nh tiá»n!',true);return;}
  if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  const qtyReal=qty||1;
  saveTx({name,qty:qtyReal,price:Math.round(amt/qtyReal),type:'Nháº­p',date,monthKey:currentMonth,desc:'Nháº­p: '+name,cat});
  saveProduct(name);
  if(!cat){const match=getCats().find(c=>name.toLowerCase().includes(c.toLowerCase()));if(match){const el=document.getElementById('impCatInput');if(el)el.value=match;}}
  renderAll();renderInventory();clearFields('impName','impQty','impAmount');
  const n=document.getElementById('expAutofillNotice');if(n)n.classList.remove('show');
  showToast(`âœ… ÄÃ£ nháº­p ${qtyReal} ${name} vÃ o kho!`);
}
function delExpense(id){showConfirm('XoÃ¡ khoáº£n nháº­p','XoÃ¡ khoáº£n nháº­p hÃ ng nÃ y?',()=>{removeTxById(id);renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');});}

/* â•â• OPERATIONAL â•â• */
function addOperational(){
  const desc=(document.getElementById('opDesc')||{value:''}).value.trim();
  const amt=getRaw('opAmount'),date=(document.getElementById('opDate')||{value:''}).value;
  if(!desc){showToast('âš ï¸ Nháº­p mÃ´ táº£!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}if(!date){showToast('âš ï¸ Chá»n ngÃ y!',true);return;}
  if(!META.operational)META.operational=[];
  META.operational.push({id:Date.now(),desc,amount:amt,date,cat:document.getElementById('opType').value});
  persist();renderAll();clearFields('opDesc','opAmount');showToast('âœ… ÄÃ£ thÃªm chi phÃ­!');
}

/* â•â• BULK DELETE â•â• */
function bulkDelete(type){
  const ids=[];document.querySelectorAll(`.cb-${type}:checked`).forEach(cb=>ids.push(parseInt(cb.value)));
  if(!ids.length){showToast('âš ï¸ ChÆ°a chá»n giao dá»‹ch nÃ o!',true);return;}
  showConfirm(`XoÃ¡ ${ids.length} giao dá»‹ch`,`XoÃ¡ ${ids.length} giao dá»‹ch? KhÃ´ng thá»ƒ hoÃ n tÃ¡c.`,()=>{removeTxByIds(ids);renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡!');});
}
function confirmDeleteAll(type){showConfirm(`XoÃ¡ táº¥t cáº£`,`XoÃ¡ TOÃ€N Bá»˜ khoáº£n ${type==='inc'?'bÃ¡n hÃ ng':'nháº­p hÃ ng'} thÃ¡ng ${monthLabel(currentMonth)}?`,()=>{clearTxByMonthType(currentMonth,type==='inc'?'Xuáº¥t':'Nháº­p');renderAll();renderInventory();showToast('âœ… ÄÃ£ xoÃ¡ táº¥t cáº£!');});}
function toggleSelectAll(type,checked){document.querySelectorAll(`.cb-${type}`).forEach(cb=>cb.checked=checked);updateBulkBtn(type);}
function updateBulkBtn(type){const c=document.querySelectorAll(`.cb-${type}:checked`).length;const b=document.getElementById(type+'BulkDelBtn');if(b)b.style.display=c>0?'inline-flex':'none';}

/* â•â• PLANS â•â• */
function addPlan(){
  const name=(document.getElementById('planName')||{value:''}).value.trim();
  const amt=getRaw('planAmount'),month=(document.getElementById('planMonth')||{value:''}).value;
  const note=(document.getElementById('planNote')||{value:''}).value.trim(),type=(document.getElementById('planType')||{value:'other'}).value;
  if(!name){showToast('âš ï¸ Nháº­p tÃªn káº¿ hoáº¡ch!',true);return;}if(!amt){showToast('âš ï¸ Nháº­p sá»‘ tiá»n!',true);return;}
  const tm=loadMeta(month);if(!tm.plans)tm.plans=[];
  tm.plans.push({id:Date.now(),name,amount:amt,type,note,createdMonth:currentMonth});
  saveMeta(month,tm);if(month===currentMonth)META=tm;
  renderPlans();clearFields('planName','planAmount','planNote');showToast(`âœ… ÄÃ£ thÃªm káº¿ hoáº¡ch vÃ o ${monthLabel(month)}!`);
}
function delPlan(id){showConfirm('XoÃ¡ káº¿ hoáº¡ch','XoÃ¡ káº¿ hoáº¡ch nÃ y?',()=>{META.plans=META.plans.filter(x=>x.id!==id);persist();renderPlans();showToast('âœ… ÄÃ£ xoÃ¡!');});}
function renderPlans(){
  const el=document.getElementById('planList');if(!el)return;
  const plans=META.plans||[];if(!plans.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ káº¿ hoáº¡ch nÃ o</div>';return;}
  const tl={import:'ğŸ“¦ Nháº­p hÃ ng',utility:'ğŸ”Œ Äiá»‡n/NÆ°á»›c',transport:'ğŸšš Váº­n chuyá»ƒn',rental:'ğŸª Máº·t báº±ng',other:'ğŸ“Œ KhÃ¡c'};
  el.innerHTML=plans.map(p=>`<div class="plan-item"><div class="plan-body"><div class="plan-name">${p.name}</div><div class="plan-meta">${tl[p.type]||p.type}${p.note?' Â· '+p.note:''}</div></div><div class="plan-amount">-${fmt(p.amount)}</div><button class="plan-del" onclick="delPlan(${p.id})">ğŸ—‘ï¸</button></div>`).join('');
}

/* â•â• RENDER HELPERS â•â• */
const fmt=n=>(n||0).toLocaleString('vi-VN')+'Ä‘';
const fmtD=d=>{try{const[y,m,day]=d.split('-');return`${day}/${m}`;}catch{return d||'';}};
function getMonthRevenue(k){return getAllTx().filter(x=>x.monthKey===k&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0);}
function getMonthCost(k){const imp=getAllTx().filter(x=>x.monthKey===k&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0);const op=(loadMeta(k).operational||[]).reduce((s,x)=>s+x.amount,0);return imp+op;}
function renderAll(){renderSummary();renderIncTable();renderExpTable();}

function renderSummary(){
  const thu=getMonthRevenue(currentMonth),chi=getMonthCost(currentMonth),p=thu-chi;
  ['totalThu','totalThu2'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=fmt(thu);});
  ['totalChi','totalChi2'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=fmt(chi);});
  ['totalProfit','totalProfit2'].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=(p>=0?'+':'')+fmt(p);el.style.color=p>=0?'var(--p600)':'var(--red)';}});
}

function renderIncTable(){
  const w=document.getElementById('incTableWrap');if(!w)return;
  const all=getAllTx().filter(x=>x.monthKey===currentMonth&&x.type==='Xuáº¥t');
  const filtered=filterByPeriod(all,incPeriod).sort((a,b)=>b.id-a.id);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’°</div>ChÆ°a cÃ³ giao dá»‹ch bÃ¡n hÃ ng nÃ o</div>';return;}
  const rows=filtered.map(t=>`<tr>
    <td class="cb-cell"><input type="checkbox" class="cb-inc" value="${t.id}" onchange="updateBulkBtn('inc')"></td>
    <td>${fmtD(t.date)}</td>
    <td>${t.name?`<span class="tag tag-thu">${t.name}</span> `:''}${t.desc||''}</td>
    <td style="text-align:center">${t.qty}</td>
    <td class="thu-v">+${fmt(t.qty*t.price)}</td>
    <td><button class="del-btn" onclick="delIncome(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>MÃ´ táº£</th><th>SL</th><th>Tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderExpTable(){
  const w=document.getElementById('expTableWrap');if(!w)return;
  const all=getAllTx().filter(x=>x.monthKey===currentMonth&&x.type==='Nháº­p');
  const filtered=filterByPeriod(all,expPeriod).sort((a,b)=>b.id-a.id);
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ’¸</div>ChÆ°a cÃ³ khoáº£n nháº­p hÃ ng nÃ o</div>';return;}
  const rows=filtered.map(t=>`<tr>
    <td class="cb-cell"><input type="checkbox" class="cb-exp" value="${t.id}" onchange="updateBulkBtn('exp')"></td>
    <td>${fmtD(t.date)}</td><td>${t.name||''}</td>
    <td style="text-align:center">${t.qty}</td>
    <td class="chi-v">-${fmt(t.qty*t.price)}</td>
    <td><button class="del-btn" onclick="delExpense(${t.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th></th><th>NgÃ y</th><th>TÃªn hÃ ng</th><th>SL</th><th>Tiá»n</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* â•â• SMART INVENTORY â•â• */
function renderInventory(){
  const el=document.getElementById('inventorySmartView');if(!el)return;
  const inv=computeInventory();
  if(!inv.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“¦</div>Kho trá»‘ng â€” hÃ£y nháº­p hÃ ng trÆ°á»›c</div>';return;}

  const outItems=inv.filter(x=>x.stock===0);
  const lowItems=inv.filter(x=>x.stock>0&&x.stock<LOW_STOCK);
  const now=new Date();
  // HÃ ng bÃ¡n cháº­m: nháº­p > 30 ngÃ y trÆ°á»›c, chÆ°a bÃ¡n Ä‘Æ°á»£c
  const slowItems=inv.filter(x=>{
    if(!x.lastInDate)return false;
    const d=new Date(x.lastInDate+'T00:00:00');
    const daysDiff=Math.floor((now-d)/(1000*60*60*24));
    return daysDiff>=30&&x.totalOut===0&&x.stock>0;
  });
  const okItems=inv.filter(x=>x.stock>=LOW_STOCK&&!slowItems.find(s=>s.name===x.name));

  let html='';

  // Cáº£nh bÃ¡o nháº­p hÃ ng
  if(outItems.length||lowItems.length){
    html+=`<div class="inv-restock-notice">ğŸ”” Nháº¯c nháº­p hÃ ng: ${[...outItems.map(x=>`<strong>${x.name}</strong> (háº¿t rá»“i)`),...lowItems.map(x=>`<strong>${x.name}</strong> (cÃ²n ${x.stock})`)].join(' Â· ')}</div>`;
  }

  // Section: Háº¿t hÃ ng
  if(outItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”´ ÄÃ£ háº¿t hÃ ng (${outItems.length} máº·t hÃ ng)</div>`;
    outItems.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-out"><div class="inv-alert-icon">ğŸ”´</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">ÄÃ£ nháº­p: ${x.totalIn} Â· ÄÃ£ bÃ¡n: ${x.totalOut}</div></div><span class="inv-alert-qty qty-out">Háº¿t hÃ ng</span></div>`;});
    html+=`</div>`;
  }

  // Section: Sáº¯p háº¿t
  if(lowItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¡ Sáº¯p háº¿t hÃ ng (cÃ²n &lt;${LOW_STOCK} cÃ¡i)</div>`;
    lowItems.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-low"><div class="inv-alert-icon">ğŸŸ¡</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">ÄÃ£ nháº­p: ${x.totalIn} Â· ÄÃ£ bÃ¡n: ${x.totalOut}${x.lastPrice?` Â· GiÃ¡ nháº­p: ${fmt(x.lastPrice)}`:''}</div></div><span class="inv-alert-qty qty-low">CÃ²n ${x.stock}</span></div>`;});
    html+=`</div>`;
  }

  // Section: HÃ ng bÃ¡n cháº­m
  if(slowItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸ”µ HÃ ng bÃ¡n cháº­m (nháº­p &gt;30 ngÃ y, chÆ°a bÃ¡n)</div>`;
    slowItems.forEach(x=>{
      const d=new Date(x.lastInDate+'T00:00:00');
      const days=Math.floor((now-d)/(1000*60*60*24));
      html+=`<div class="inv-alert-card" style="background:#EEF2FF;border-color:#7C83FD"><div class="inv-alert-icon">ğŸ”µ</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">Nháº­p ${days} ngÃ y trÆ°á»›c Â· Tá»“n: ${x.stock} Â· ChÆ°a bÃ¡n cÃ¡i nÃ o</div></div><span class="inv-alert-qty" style="background:#EEF2FF;color:#4F46E5">Cháº­m bÃ¡n</span></div>`;
    });
    html+=`</div>`;
  }

  // Section: HÃ ng Ä‘á»§
  if(okItems.length){
    html+=`<div class="inv-section"><div class="inv-section-title">ğŸŸ¢ HÃ ng Ä‘á»§ (${okItems.length} máº·t hÃ ng)</div>`;
    okItems.forEach(x=>{html+=`<div class="inv-alert-card inv-alert-ok"><div class="inv-alert-icon">ğŸŸ¢</div><div class="inv-alert-body"><div class="inv-alert-name">${x.name}</div><div class="inv-alert-meta">ÄÃ£ nháº­p: ${x.totalIn} Â· ÄÃ£ bÃ¡n: ${x.totalOut}</div></div><span class="inv-alert-qty qty-ok">CÃ²n ${x.stock}</span></div>`;});
    html+=`</div>`;
  }

  el.innerHTML=html;
}

// NÃºt há»i trá»£ lÃ½ vá» kho
function askAIAboutInventory(){
  // Chuyá»ƒn sang tab AI
  const aiBtn=document.querySelectorAll('.bn-btn')[4];
  switchPage('ai',aiBtn);
  // Tá»± Ä‘á»™ng Ä‘iá»n cÃ¢u há»i vÃ  gá»­i
  setTimeout(()=>{
    const inp=document.getElementById('chatInp');
    if(inp){inp.value='TÃ¬nh hÃ¬nh hÃ ng hÃ³a trong kho cá»§a tÃ´i tháº¿ nÃ o?';sendChat();}
  },200);
}

function renderHomeRecent(){
  const w=document.getElementById('homeRecentWrap');if(!w)return;
  const all=getAllTx().filter(x=>x.monthKey===currentMonth).sort((a,b)=>b.id-a.id).slice(0,8);
  if(!all.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>ChÆ°a cÃ³ giao dá»‹ch nÃ o</div>';return;}
  const rows=all.map(x=>`<tr><td>${fmtD(x.date)}</td><td>${x.type==='Xuáº¥t'?'<span class="tag tag-thu">ğŸ’° BÃ¡n</span>':'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>'}</td><td>${x.name||x.desc||''}</td><td class="${x.type==='Xuáº¥t'?'thu-v':'chi-v'}">${x.type==='Xuáº¥t'?'+':'-'}${fmt(x.qty*x.price)}</td></tr>`).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn hÃ ng</th><th>Sá»‘ tiá»n</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* â•â• HISTORY â•â• */
let _filteredForCSV=[];
function renderHistory(){
  const all=getAllTx().sort((a,b)=>b.id-a.id);
  const ops=(()=>{const r=[];getMonthOpts().forEach(mk=>{(loadMeta(mk).operational||[]).forEach(x=>r.push({...x,monthKey:mk,type:'op',qty:1,price:x.amount,name:x.desc}));});return r.sort((a,b)=>b.id-a.id);})();
  const combined=[...all,...ops];
  const search=(document.getElementById('histSearch')||{value:''}).value.toLowerCase();
  const typeF=(document.getElementById('histTypeFilter')||{value:''}).value;
  const monthF=(document.getElementById('histMonthFilter')||{value:''}).value;
  const allMonths=[...new Set(combined.map(x=>x.monthKey||''))].filter(Boolean).sort().reverse();
  const mSel=document.getElementById('histMonthFilter');
  if(mSel){const cur=mSel.value;mSel.innerHTML='<option value="">Táº¥t cáº£ thÃ¡ng</option>'+allMonths.map(m=>`<option value="${m}"${m===cur?' selected':''}>${monthLabel(m)}</option>`).join('');}
  const filtered=combined.filter(x=>{
    if(search&&!(x.name||'').toLowerCase().includes(search)&&!(x.desc||'').toLowerCase().includes(search))return false;
    if(typeF&&x.type!==typeF)return false;
    if(monthF&&x.monthKey!==monthF)return false;
    return true;
  });
  _filteredForCSV=filtered;
  const allThu=filtered.filter(x=>x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0);
  const allChi=filtered.filter(x=>x.type==='Nháº­p'||x.type==='op').reduce((s,x)=>s+(x.qty||1)*(x.price||x.amount||0),0);
  const allP=allThu-allChi;
  const set=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  set('histAllThu',fmt(allThu));set('histAllChi',fmt(allChi));
  const pe=document.getElementById('histAllProfit');if(pe){pe.textContent=(allP>=0?'+':'')+fmt(allP);pe.style.color=allP>=0?'var(--p600)':'var(--red)';}
  const w=document.getElementById('histTableWrap');if(!w)return;
  if(!filtered.length){w.innerHTML='<div class="empty"><div class="ei">ğŸ§¾</div>KhÃ´ng cÃ³ giao dá»‹ch nÃ o</div>';return;}
  const rows=filtered.map(x=>{
    const isT=x.type==='Xuáº¥t';const isOp=x.type==='op';
    const tag=isT?'<span class="tag tag-thu">ğŸ’° BÃ¡n</span>':isOp?'<span class="tag tag-op">âš¡ CP</span>':'<span class="tag tag-imp">ğŸ“¦ Nháº­p</span>';
    const amt=x.qty*(x.price||0);
    return`<tr class="hist-row-clickable" onclick="jumpToMonth('${x.monthKey}')"><td>${fmtD(x.date)}</td><td>${tag}</td><td>${x.name||x.desc||'â€”'}</td><td style="text-align:center">${isOp?'â€”':x.qty}</td><td class="${isT?'thu-v':'chi-v'}">${isT?'+':'-'}${fmt(amt)}</td><td><span class="jump-badge">${monthLabel(x.monthKey)}</span></td></tr>`;
  }).join('');
  w.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>NgÃ y</th><th>Loáº¡i</th><th>TÃªn hÃ ng</th><th>SL</th><th>Sá»‘ tiá»n</th><th>ThÃ¡ng</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function jumpToMonth(key){currentMonth=key;META=loadMeta(key);buildMonthSelect();renderAll();switchPage('money',document.querySelectorAll('.bn-btn')[1]);showToast(`âœ… ÄÃ£ chuyá»ƒn sang ${monthLabel(key)}`);}
function exportFilteredCSV(){
  if(!_filteredForCSV.length){showToast('âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!',true);return;}
  const csv=['NgÃ y,Loáº¡i,TÃªn hÃ ng,MÃ´ táº£,Sá»‘ lÆ°á»£ng,ÄÆ¡n giÃ¡,ThÃ nh tiá»n,ThÃ¡ng',..._filteredForCSV.map(x=>{const loai=x.type==='Xuáº¥t'?'BÃ¡n hÃ ng':x.type==='Nháº­p'?'Nháº­p hÃ ng':'Chi phÃ­';const tt=x.qty*(x.price||0);return`"${x.date}","${loai}","${x.name||''}","${(x.desc||'').replace(/"/g,'""')}","${x.qty||''}","${x.price||x.amount||''}","${tt}","${x.monthKey}"`;})].join('\n');
  copyRaw(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');
}

/* â•â• GEMINI API â•â• */
async function callGemini(parts){
  if(!API_KEY)throw new Error('ChÆ°a cÃ³ API Key!');
  const res=await fetch(`${GEMINI_URL}?key=${API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts}],generationConfig:{maxOutputTokens:600,temperature:0.3}})});
  if(!res.ok)throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  if(data.error)throw new Error(data.error.message||'Lá»—i API');
  const txt=data?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!txt)throw new Error('AI khÃ´ng tráº£ vá» ná»™i dung');
  return txt;
}

/* â•â• AI CHAT â€” nÃ¢ng cáº¥p siÃªu tá»‘c + kho thá»±c táº¿ â•â• */
function updateAIStatusBar(){
  const el=document.getElementById('aiInvSummary');if(!el)return;
  const inv=computeInventory();
  if(!inv.length){el.innerHTML='Kho trá»‘ng';return;}
  const out=inv.filter(x=>x.stock===0).length;
  const low=inv.filter(x=>x.stock>0&&x.stock<LOW_STOCK).length;
  const ok=inv.filter(x=>x.stock>=LOW_STOCK).length;
  let parts=[];
  if(out)parts.push(`<strong style="color:var(--red)">${out} máº·t hÃ ng háº¿t</strong>`);
  if(low)parts.push(`<strong style="color:#7A5200">${low} sáº¯p háº¿t</strong>`);
  if(ok)parts.push(`<strong style="color:var(--p600)">${ok} Ä‘á»§ hÃ ng</strong>`);
  el.innerHTML=parts.join(' Â· ')||'Kho á»•n Ä‘á»‹nh';
}

function setChatStatus(text,busy=false){
  const el=document.getElementById('chatStatusDot');
  if(el)el.textContent=busy?'â³ '+text:'â— '+text;
}

async function sendChat(){
  const inp=document.getElementById('chatInp');
  const msg=inp?inp.value.trim():'';
  if(!msg)return;
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key trÆ°á»›c!',true);return;}
  if(inp)inp.value='';
  addMsg(msg,'user');

  // Hiá»‡n tráº¡ng thÃ¡i ngay láº­p tá»©c
  setChatStatus('AI Ä‘ang kiá»ƒm tra kho...',true);
  const typing=document.getElementById('chatTyping');
  if(typing)typing.classList.add('show');
  scrollChat();

  // Láº¥y dá»¯ liá»‡u kho & kinh doanh tá»©c thÃ¬ tá»« localStorage
  const invSummary=getInventorySummary();
  const bizContext=buildBusinessContext();

  const systemPrompt=`Báº¡n lÃ  trá»£ lÃ½ Tiá»ƒu ThÆ°Æ¡ng AI, nÃ³i chuyá»‡n thÃ¢n thiá»‡n vá»›i cÃ´ chÃº bÃ¡n hÃ ng Viá»‡t Nam.

=== KHO HÃ€NG THá»°C Táº¾ NGAY BÃ‚Y GIá»œ ===
${invSummary}

=== Sá» LIá»†U KINH DOANH ===
${bizContext}

QUAN TRá»ŒNG:
- Tráº£ lá»i Tá»I ÄA 2 cÃ¢u ngáº¯n gá»n, dÃ¹ng emoji.
- Náº¿u há»i vá» kho/tá»“n kho: Liá»‡t kÃª sá»‘ liá»‡u cá»¥ thá»ƒ ngay, khÃ´ng chÃ o há»i dÃ i.
- Náº¿u cÃ³ GIAO Dá»ŠCH (bÃ¡n/nháº­p): Tráº£ vá» JSON trong dáº¥u ngoáº·c vuÃ´ng rá»“i xÃ¡c nháº­n ngáº¯n.
  Format: [{"item":"tÃªn","quantity":sá»‘,"price":Ä‘Æ¡n_giÃ¡_hoáº·c_0,"type":"bÃ¡n hoáº·c nháº­p"}]
- KhÃ´ng giáº£i thÃ­ch dÃ i dÃ²ng.

Tin nháº¯n cá»§a khÃ¡ch: ${msg}`;

  try{
    const raw=await callGemini([{text:systemPrompt}]);
    if(typing)typing.classList.remove('show');
    setChatStatus('Sáºµn sÃ ng',false);

    const jsonMatch=raw.match(/\[[\s\S]*?\]/);
    if(jsonMatch){
      try{
        const parsed=JSON.parse(jsonMatch[0]);
        if(parsed.length>0){
          const preview=parsed.map(x=>`${/(nháº­p)/i.test(x.type)?'ğŸ“¦ Nháº­p':'ğŸ’° BÃ¡n'} ${x.quantity} ${x.item}${x.price>0?' @ '+fmt(x.price):''}`).join('\n');
          const textPart=raw.replace(jsonMatch[0],'').trim()||'ÄÃºng khÃ´ng bÃ ?';
          addMsgWithConfirm(textPart+'\n\n'+preview,parsed);
          return;
        }
      }catch{}
    }
    addMsg(raw,'bot');
  }catch(err){
    if(typing)typing.classList.remove('show');
    setChatStatus('Lá»—i káº¿t ná»‘i',false);
    addMsg('âŒ '+err.message,'bot');
  }
}

function addMsgWithConfirm(text,parsedData){
  const msgs=document.getElementById('chatMsgs');if(!msgs)return;
  const div=document.createElement('div');div.className='msg bot';
  div.innerHTML=text.replace(/\n/g,'<br>')+`<div class="confirm-pill"><button class="pill-yes" onclick="confirmAITx(this,true)">âœ… ÄÃºng, lÆ°u vÃ o kho</button><button class="pill-no" onclick="confirmAITx(this,false)">âŒ Sai, bá» qua</button></div>`;
  div._aiData=parsedData;
  msgs.insertBefore(div,document.getElementById('chatTyping'));
  scrollChat();
}

function confirmAITx(btn,yes){
  const msgDiv=btn.closest('.msg');const data=msgDiv._aiData;
  const pill=msgDiv.querySelector('.confirm-pill');if(pill)pill.remove();
  if(yes&&data)processAIResponse(data);
  else addMsg('ğŸ‘ OK, bá» qua nhÃ©!','bot');
  scrollChat();
}

function buildBusinessContext(){
  const now=new Date(),curKey=now.toISOString().slice(0,7);
  const allTx=getAllTx();
  const curRev=allTx.filter(x=>x.monthKey===curKey&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0);
  const curCost=allTx.filter(x=>x.monthKey===curKey&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0);
  const prev=new Date(now);prev.setMonth(prev.getMonth()-1);
  const prevRev=allTx.filter(x=>x.monthKey===prev.toISOString().slice(0,7)&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0);
  const yearRev=allTx.filter(x=>{const y=new Date(x.date).getFullYear();return x.type==='Xuáº¥t'&&y===now.getFullYear();}).reduce((s,x)=>s+x.qty*x.price,0);
  return`ThÃ¡ng nÃ y: Thu=${fmt(curRev)}, Chi=${fmt(curCost)}, LÃ£i=${fmt(curRev-curCost)}
ThÃ¡ng trÆ°á»›c: Thu=${fmt(prevRev)}
Doanh thu nÄƒm ${now.getFullYear()}: ${fmt(yearRev)} / 500tr ngÆ°á»¡ng thuáº¿`;
}

function processAIResponse(jsonResp){
  let items=[];
  if(Array.isArray(jsonResp))items=jsonResp;
  else if(jsonResp.item||jsonResp.name)items=[jsonResp];
  const saved=[];
  items.forEach(it=>{
    const name=(it.item||it.name||'').trim();if(!name)return;
    const qty=parseInt(String(it.quantity||it.qty||'1').replace(/\D/g,''))||1;
    const price=parseInt(String(it.price||'0').replace(/\D/g,''))||0;
    const isIncome=/(thu|bÃ¡n|xuáº¥t|sell)/i.test(it.type||'');
    if(isIncome){
      const{ok,stock}=checkStock(name,qty);
      if(!ok){showStockAlert(`<strong>${name}</strong><br>Kho cÃ²n: <strong>${stock}</strong><br>Äá»‹nh bÃ¡n: <strong>${qty}</strong>`,()=>{saveTx({name,qty,price,type:'Xuáº¥t',date:TODAY,monthKey:currentMonth,desc:'AI: bÃ¡n '+name,cat:''});saveProduct(name);renderAll();showToast(`âœ… ÄÃ£ ghi bÃ¡n ${qty} ${name}!`);});return;}
    }
    const entry=saveTx({name,qty,price,type:isIncome?'Xuáº¥t':'Nháº­p',date:TODAY,monthKey:currentMonth,desc:`AI: ${isIncome?'bÃ¡n':'nháº­p'} ${name}`,cat:''});
    saveProduct(name);saved.push({...entry,txType:isIncome?'Xuáº¥t':'Nháº­p'});
  });
  if(saved.length>0){
    renderAll();renderInventory();updateAIStatusBar();
    showToast(`âœ… ÄÃ£ thÃªm: ${saved.map(x=>`${x.type==='Nháº­p'?'ğŸ“¦':'ğŸ’°'} ${x.qty} ${x.name}`).join(', ')}!`);
  }
  return saved;
}

function addMsg(text,role){
  const msgs=document.getElementById('chatMsgs');if(!msgs)return;
  const div=document.createElement('div');div.className='msg '+role;
  div.innerHTML=text.replace(/\n/g,'<br>');
  msgs.insertBefore(div,document.getElementById('chatTyping'));
  scrollChat();
}
function scrollChat(){const m=document.getElementById('chatMsgs');if(m)m.scrollTop=m.scrollHeight;}

/* â•â• INVOICE SCAN â•â• */
let invoiceBase64='',incInvoiceBase64='';
let invoiceData=[];

function handleInvoiceImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{invoiceBase64=ev.target.result.split(',')[1];show2('expUploadArea','expImgPreviewBox','invoicePreview',ev.target.result);document.getElementById('scanBtn').disabled=false;};r.readAsDataURL(f);}
function changeExpImg(){hide2('expUploadArea','expImgPreviewBox');invoiceBase64='';document.getElementById('scanBtn').disabled=true;document.getElementById('invoiceImg').value='';}
function show2(hId,sId,iId,src){const h=document.getElementById(hId),s=document.getElementById(sId),i=document.getElementById(iId);if(h)h.style.display='none';if(s)s.style.display='block';if(i)i.src=src;}
function hide2(sId,hId){const s=document.getElementById(sId),h=document.getElementById(hId);if(s)s.style.display='block';if(h)h.style.display='none';}

async function scanInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanLoader'),wrap=document.getElementById('invoiceTableWrap'),acts=document.getElementById('invActions'),btn=document.getElementById('scanBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML='';}if(acts)acts.style.display='none';if(btn)btn.disabled=true;
  invoiceData=[];document.getElementById('expAutofillNotice').classList.remove('show');
  const PROMPT=`TrÃ­ch xuáº¥t táº¥t cáº£ máº·t hÃ ng tá»« hÃ³a Ä‘Æ¡n. Tráº£ vá» JSON khÃ´ng markdown:
{"rows":[{"ten":"tÃªn hÃ ng","soluong":"sá»‘ lÆ°á»£ng","dongia":"Ä‘Æ¡n giÃ¡","thanhtien":"thÃ nh tiá»n"}]}`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:invoiceBase64}},{text:PROMPT}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed?.rows?.length){invoiceData=parsed.rows;renderInvoiceTable('invoiceTableWrap',parsed.rows);if(wrap)wrap.classList.add('show');if(acts)acts.style.display='flex';}
    else{if(wrap){wrap.innerHTML=`<pre style="padding:11px;font-size:.82rem;overflow:auto;max-height:200px">${raw}</pre>`;wrap.classList.add('show');}}
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}

function renderInvoiceTable(wrapId,rows){
  const w=document.getElementById(wrapId);if(!w)return;
  const rh=rows.map(r=>`<tr><td>${r.ten||''}</td><td style="text-align:center">${r.soluong||''}</td><td style="text-align:right">${r.dongia||''}</td><td style="text-align:right;font-weight:800;color:var(--p700)">${r.thanhtien||''}</td></tr>`).join('');
  w.innerHTML=`<table class="inv-tbl"><thead><tr><th>TÃªn hÃ ng</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th></tr></thead><tbody>${rh}</tbody></table>`;
}

function autoFillImport(){
  if(!invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const first=invoiceData[0];
  const name=document.getElementById('impName'),qty=document.getElementById('impQty'),amt=document.getElementById('impAmount');
  if(name)name.value=first.ten||'';
  if(qty){const q=(first.soluong||'').replace(/\D/g,'');qty.dataset.raw=q;qty.value=q?parseInt(q).toLocaleString('vi-VN'):'';}
  const rawA=(first.thanhtien||'').replace(/\D/g,'');if(amt&&rawA){amt.dataset.raw=rawA;amt.value=parseInt(rawA).toLocaleString('vi-VN');}
  document.getElementById('expAutofillNotice').classList.add('show');
  showToast('âœ… ÄÃ£ Ä‘iá»n dÃ²ng Ä‘áº§u vÃ o form!');
}

async function copyInvoiceTable(){
  if(!invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const cols=['TÃªn hÃ ng','SL','ÄÆ¡n giÃ¡','ThÃ nh tiá»n'];
  const rows=invoiceData.map(r=>[r.ten||'',r.soluong||'',r.dongia||'',r.thanhtien||'']);
  const widths=cols.map((c,i)=>Math.max(c.length,...rows.map(r=>String(r[i]).length)));
  const pad=(s,w)=>String(s).padEnd(w,' ');
  const sep='+'+(widths.map(w=>'-'.repeat(w+2)).join('+'))+'+';
  const header='| '+cols.map((c,i)=>pad(c,widths[i])).join(' | ')+' |';
  const dataRows=rows.map(r=>'| '+r.map((c,i)=>pad(c,widths[i])).join(' | ')+' |');
  await copyRaw([sep,header,sep,...dataRows,sep].join('\n'),'ğŸ“‹ ÄÃ£ sao chÃ©p báº£ng!');
}

async function copyInvoiceCSV(){
  if(!invoiceData.length){showToast('âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u!',true);return;}
  const csv=['TÃªn hÃ ng,Sá»‘ lÆ°á»£ng,ÄÆ¡n giÃ¡,ThÃ nh tiá»n',...invoiceData.map(r=>`"${r.ten||''}","${r.soluong||''}","${r.dongia||''}","${r.thanhtien||''}"`)].join('\n');
  await copyRaw(csv,'ğŸ“¥ ÄÃ£ sao chÃ©p CSV!');
}

function handleIncInvoice(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{incInvoiceBase64=ev.target.result.split(',')[1];show2('incUploadArea','incImgPreviewBox','incInvoicePreview',ev.target.result);document.getElementById('scanIncBtn').disabled=false;};r.readAsDataURL(f);}
function changeIncImg(){hide2('incUploadArea','incImgPreviewBox');incInvoiceBase64='';document.getElementById('scanIncBtn').disabled=true;document.getElementById('incInvoiceFile').value='';}

async function scanIncInvoice(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const loader=document.getElementById('scanIncLoader'),wrap=document.getElementById('incInvoiceTableWrap'),btn=document.getElementById('scanIncBtn');
  if(loader)loader.classList.add('show');if(wrap){wrap.classList.remove('show');wrap.innerHTML='';}if(btn)btn.disabled=true;
  document.getElementById('incAutofillNotice').classList.remove('show');
  const PROMPT=`ÄÃ¢y lÃ  bill/hÃ³a Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n. TrÃ­ch xuáº¥t thÃ´ng tin bÃ¡n hÃ ng. Tráº£ vá» JSON khÃ´ng markdown:
{"items":[{"item":"tÃªn","quantity":"sá»‘","price":"Ä‘Æ¡n giÃ¡","type":"thu"}],"tongtien":"tá»•ng","ngay":"YYYY-MM-DD"}`;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:incInvoiceBase64}},{text:PROMPT}]);
    let parsed=null;try{parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());}catch{}
    if(loader)loader.classList.remove('show');
    if(parsed){
      if(parsed.items?.length){const rows=parsed.items.map(x=>({ten:x.item,soluong:x.quantity,dongia:x.price,thanhtien:x.price&&x.quantity?(parseInt(x.price)*parseInt(x.quantity)||''):x.price}));renderInvoiceTable('incInvoiceTableWrap',rows);if(wrap)wrap.classList.add('show');}
      const total=(parsed.tongtien||'').replace(/\D/g,'');
      const nameVal=parsed.items?.length?parsed.items.map(x=>x.item).join(', '):'';
      const descEl=document.getElementById('incDesc'),amtEl=document.getElementById('incAmount'),dateEl=document.getElementById('incDate'),nameEl=document.getElementById('incSellName');
      if(nameEl&&nameVal)nameEl.value=nameVal;if(descEl&&nameVal)descEl.value='BÃ¡n '+nameVal;
      if(amtEl&&total){amtEl.dataset.raw=total;amtEl.value=parseInt(total).toLocaleString('vi-VN');}
      if(dateEl&&parsed.ngay&&/^\d{4}-\d{2}-\d{2}$/.test(parsed.ngay))dateEl.value=parsed.ngay;
      document.getElementById('incAutofillNotice').classList.add('show');
      showToast('âœ… AI Ä‘Ã£ Ä‘á»c bill!');
    }else{if(wrap){wrap.innerHTML=`<pre style="padding:11px;font-size:.82rem">${raw}</pre>`;wrap.classList.add('show');}}
  }catch(err){if(loader)loader.classList.remove('show');showToast('âŒ '+err.message,true);}
  if(btn)btn.disabled=false;
}

/* â•â• FACEBOOK / TIKTOK â•â• */
let fbBase64='';
function handleFbImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{fbBase64=ev.target.result.split(',')[1];show2('fbUploadArea','fbImgPreviewBox','fbPreview',ev.target.result);document.getElementById('fbPostBtn').disabled=false;};r.readAsDataURL(f);}
function changeFbImg(){hide2('fbUploadArea','fbImgPreviewBox');fbBase64='';document.getElementById('fbPostBtn').disabled=true;document.getElementById('fbImgInput').value='';}

async function generateFbPost(){
  if(!API_KEY||!fbBase64){showToast('âš ï¸ Cáº§n API Key vÃ  áº£nh!',true);return;}
  const card=document.getElementById('fbResultCard'),loader=document.getElementById('fbLoader'),box=document.getElementById('fbPost'),btn=document.getElementById('copyFb'),postBtn=document.getElementById('fbPostBtn');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');if(postBtn)postBtn.disabled=true;
  try{
    const raw=await callGemini([{inline_data:{mime_type:'image/jpeg',data:fbBase64}},{text:'Viáº¿t bÃ i Ä‘Äƒng Facebook bÃ¡n hÃ ng cho tiá»ƒu thÆ°Æ¡ng Viá»‡t Nam. CÃ³ emoji, call-to-action, hashtag. Chá»‰ tráº£ vá» bÃ i viáº¿t.'}]);
    if(loader)loader.classList.remove('show');if(box){box.textContent=raw;box.classList.add('show');}if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(postBtn)postBtn.disabled=false;
}

async function generateScript(){
  if(!API_KEY){showToast('âš ï¸ Nháº­p API Key!',true);return;}
  const product=document.getElementById('ttProduct').value.trim();if(!product){showToast('âš ï¸ Nháº­p tÃªn sáº£n pháº©m!',true);return;}
  const roleMap={ba:'bÃ ',chu:'chÃº',me:'máº¹',ban:'báº¡n'},xung=roleMap[document.getElementById('ttRole').value]||'báº¡n';
  const card=document.getElementById('videoResult'),loader=document.getElementById('videoLoader'),box=document.getElementById('scriptBox'),btn=document.getElementById('copyScript'),sbtn=document.getElementById('scriptBtn');
  card.style.display='block';if(loader)loader.classList.add('show');if(box)box.classList.remove('show');if(btn)btn.classList.remove('show');if(sbtn)sbtn.disabled=true;
  try{
    const text=await callGemini([{text:`HÆ°á»›ng dáº«n ${xung} quay TikTok bÃ¡n "${product}". NgÃ´n ngá»¯ Ä‘Æ¡n giáº£n, 3 bÆ°á»›c rÃµ. Káº¿t: "${xung.charAt(0).toUpperCase()+xung.slice(1)} cá»© quay xong Ä‘Äƒng luÃ´n ğŸ’š"`}]);
    if(loader)loader.classList.remove('show');if(box){box.textContent=text;box.classList.add('show');}if(btn)btn.classList.add('show');
  }catch(err){if(loader)loader.classList.remove('show');if(box){box.textContent='âŒ '+err.message;box.classList.add('show');}showToast('âŒ '+err.message,true);}
  if(sbtn)sbtn.disabled=false;
}

/* â•â• TAX â•â• */
function getYearRevenue(year){return getAllTx().filter(x=>new Date(x.date).getFullYear()===year&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0);}
function renderTaxAssistant(){
  const el=document.getElementById('taxAssistantBox');if(!el)return;
  const now=new Date(),year=now.getFullYear(),month=now.getMonth()+1;
  const yearRevenue=getYearRevenue(year);
  const monthRevenue=getAllTx().filter(x=>{const d=new Date(x.date);return x.type==='Xuáº¥t'&&d.getFullYear()===year&&d.getMonth()+1===month;}).reduce((s,x)=>s+x.qty*x.price,0);
  const avg=month>0?yearRevenue/month:0,projected=avg*12,remaining=TAX_THRESHOLD-yearRevenue;
  let html='';
  if(yearRevenue>=TAX_THRESHOLD){html=`<div class="tax-box tax-danger"><span class="tx-icon">âš ï¸</span><div class="tx-msg">BÃ  Æ¡i! Doanh thu Ä‘Ã£ vÆ°á»£t 500 triá»‡u â€” cáº§n ná»™p thuáº¿!</div><span class="tax-amount">${fmt(yearRevenue*TAX_RATE)}</span><div class="tx-detail"><strong>Doanh thu nÄƒm ${year}:</strong> ${fmt(yearRevenue)}<br><strong>Thuáº¿ 1.5%:</strong> ${fmt(yearRevenue*TAX_RATE)}<br>ğŸ‘‰ Khai thuáº¿ máº«u 01/CNKD táº¡i Chi cá»¥c Thuáº¿.</div></div>`;}
  else if(projected>=TAX_THRESHOLD){html=`<div class="tax-box tax-warn"><span class="tx-icon">ğŸ””</span><div class="tx-msg">LÆ°u Ã½! Tá»‘c Ä‘á»™ hiá»‡n táº¡i cÃ³ thá»ƒ cháº¡m 500 triá»‡u trong nÄƒm.</div><div class="tx-detail"><strong>ÄÃ£ thu:</strong> ${fmt(yearRevenue)}<br><strong>Dá»± bÃ¡o cáº£ nÄƒm:</strong> ${fmt(projected)}<br><strong>CÃ²n cÃ¡ch ngÆ°á»¡ng:</strong> ${fmt(remaining)}</div></div>`;}
  else{html=`<div class="tax-box tax-safe"><span class="tx-icon">ğŸ˜Š</span><div class="tx-msg">BÃ  Æ¡i, hiá»‡n chÆ°a pháº£i ná»™p thuáº¿. Cá»© yÃªn tÃ¢m bÃ¡n hÃ ng!</div><div class="tx-detail"><strong>ÄÃ£ thu nÄƒm ${year}:</strong> ${fmt(yearRevenue)}<br><strong>CÃ²n cÃ³ thá»ƒ bÃ¡n thÃªm:</strong> ${fmt(remaining)}</div></div>`;}
  el.innerHTML=html;
}

/* â•â• COMPARE â•â• */
function showCompare(){
  const a=document.getElementById('cmpA').value,b=document.getElementById('cmpB').value;
  if(!a||!b||a===b){showToast('âš ï¸ Chá»n 2 thÃ¡ng khÃ¡c nhau!',true);return;}
  const aThu=getMonthRevenue(a),aChi=getMonthCost(a),aLai=aThu-aChi;
  const bThu=getMonthRevenue(b),bChi=getMonthCost(b),bLai=bThu-bChi;
  const delta=(cur,prv)=>{const d=cur-prv,pct=prv>0?Math.round(d/prv*100):0;return`<div class="cmp-delta ${d>=0?'delta-up':'delta-down'}">${d>=0?'â–²':'â–¼'} ${fmt(Math.abs(d))} (${pct}%)</div>`;};
  document.getElementById('compareBox').innerHTML=`<h3>ğŸ“Š ${monthLabel(a)} vs ${monthLabel(b)}</h3><div class="cmp-grid"><div class="cmp-item"><div class="cmp-lbl">ğŸ“ˆ Thu</div><div class="cmp-cur">${fmt(aThu)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bThu)}</div>${delta(aThu,bThu)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ“‰ Chi</div><div class="cmp-cur">${fmt(aChi)}</div><div class="cmp-prev">${monthLabel(b)}: ${fmt(bChi)}</div>${delta(aChi,bChi)}</div><div class="cmp-item"><div class="cmp-lbl">ğŸ’¼ LÃ£i/Lá»—</div><div class="cmp-cur" style="color:${aLai>=0?'var(--p600)':'var(--red)'}">${(aLai>=0?'+':'')+fmt(aLai)}</div><div class="cmp-prev">${(bLai>=0?'+':'')+fmt(bLai)}</div>${delta(aLai,bLai)}</div></div>`;
  document.getElementById('compareBox').classList.add('show');
}
function buildAllTimeCompare(){
  const el=document.getElementById('allTimeCompare');if(!el)return;
  const opts=getMonthOpts();if(!opts.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div>ChÆ°a cÃ³ dá»¯ liá»‡u</div>';return;}
  const rows=opts.map(k=>{const thu=getMonthRevenue(k),chi=getMonthCost(k),lai=thu-chi;return`<tr><td>${monthLabel(k)}</td><td class="thu-v">+${fmt(thu)}</td><td class="chi-v">-${fmt(chi)}</td><td style="font-weight:800;color:${lai>=0?'var(--p600)':'var(--red)'}">${(lai>=0?'+':'')+fmt(lai)}</td></tr>`;}).join('');
  const aT=opts.reduce((s,k)=>s+getMonthRevenue(k),0),aC=opts.reduce((s,k)=>s+getMonthCost(k),0),aL=aT-aC;
  el.innerHTML=`<div class="tbl-wrap"><table><thead><tr><th>ThÃ¡ng</th><th>Thu</th><th>Chi</th><th>LÃ£i/Lá»—</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:var(--p700);color:#fff"><td style="padding:8px 9px;font-weight:800">Tá»•ng</td><td style="padding:8px 9px;font-weight:900">+${fmt(aT)}</td><td style="padding:8px 9px;font-weight:900">-${fmt(aC)}</td><td style="padding:8px 9px;font-weight:900;color:${aL>=0?'#A8E6C1':'#FFB3AA'}">${(aL>=0?'+':'')+fmt(aL)}</td></tr></tfoot></table></div>`;
}

/* â•â• CHARTS â•â• */
const chartInst={pie:null,bar:null,line:null,homeLine:null};
function destroyCharts(){Object.keys(chartInst).forEach(k=>{if(chartInst[k]){try{chartInst[k].destroy();}catch{}chartInst[k]=null;}});}

function getChartData(){
  const allTx=getAllTx();
  if(chartPeriod==='week'){
    const days=[],thu=[],chi=[];
    for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(allTx.filter(x=>x.date===iso&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0));chi.push(allTx.filter(x=>x.date===iso&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0));}
    return{days,thu,chi};
  }else if(chartPeriod==='month'){
    const[y,m]=currentMonth.split('-');const dIM=new Date(y,m,0).getDate();
    const days=[],thu=[],chi=[];
    for(let i=1;i<=dIM;i++){const iso=`${currentMonth}-${String(i).padStart(2,'0')}`;days.push(String(i));thu.push(allTx.filter(x=>x.date===iso&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0));chi.push(allTx.filter(x=>x.date===iso&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0));}
    return{days,thu,chi};
  }else{
    const opts=getMonthOpts().slice().reverse();
    return{days:opts.map(k=>{const[y,m]=k.split('-');return`T${parseInt(m)}/${y.slice(2)}`;}),thu:opts.map(k=>getMonthRevenue(k)),chi:opts.map(k=>getMonthCost(k))};
  }
}

function refreshCharts(){
  destroyCharts();
  const thu=getMonthRevenue(currentMonth);
  const imp=getAllTx().filter(x=>x.monthKey===currentMonth&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0);
  const op=(META.operational||[]).reduce((s,x)=>s+x.amount,0);
  const hasData=thu>0||imp>0||op>0;
  document.getElementById('noChartData').style.display=hasData?'none':'block';
  document.getElementById('chartContent').style.display=hasData?'block':'none';
  if(!hasData)return;
  const pie=document.getElementById('pieChart');
  if(pie)chartInst.pie=new Chart(pie,{type:'doughnut',data:{labels:['Thu','Nháº­p hÃ ng','Chi phÃ­ thÃªm'],datasets:[{data:[thu,imp,op],backgroundColor:['#1B6B3A','#0C5460','#856404'],borderWidth:0,hoverOffset:7}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},padding:6}}}}});
  const allImp=getAllTx().filter(x=>x.monthKey===currentMonth&&x.type==='Nháº­p');
  const expItems=[...new Set(allImp.map(x=>x.name||x.desc))].slice(0,5);
  const expVals=expItems.map(d=>allImp.filter(x=>(x.name||x.desc)===d).reduce((s,x)=>s+x.qty*x.price,0));
  const bar=document.getElementById('barChart');
  if(bar)chartInst.bar=new Chart(bar,{type:'bar',data:{labels:expItems.length?expItems:['ChÆ°a cÃ³'],datasets:[{label:'Ä‘',data:expItems.length?expVals:[0],backgroundColor:'rgba(27,107,58,.72)',borderRadius:6,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:8}}}}}});
  const{days,thu:thuLine,chi:chiLine}=getChartData();
  const line=document.getElementById('lineChart');
  if(line)chartInst.line=new Chart(line,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thuLine,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.08)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chiLine,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.06)',tension:.4,fill:true,pointRadius:3,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'},grid:{color:'#eee'}},x:{grid:{display:false},ticks:{font:{size:9}}}}}});
}

function refreshHomeChart(){
  if(chartInst.homeLine){try{chartInst.homeLine.destroy();}catch{}chartInst.homeLine=null;}
  const allTx=getAllTx();const days=[],thu=[],chi=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const iso=d.toISOString().slice(0,10);days.push(['CN','T2','T3','T4','T5','T6','T7'][d.getDay()]);thu.push(allTx.filter(x=>x.date===iso&&x.type==='Xuáº¥t').reduce((s,x)=>s+x.qty*x.price,0));chi.push(allTx.filter(x=>x.date===iso&&x.type==='Nháº­p').reduce((s,x)=>s+x.qty*x.price,0));}
  const c=document.getElementById('homeLineChart');if(!c)return;
  chartInst.homeLine=new Chart(c,{type:'line',data:{labels:days,datasets:[{label:'Thu',data:thu,borderColor:'#1B6B3A',backgroundColor:'rgba(27,107,58,.10)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#1B6B3A'},{label:'Chi',data:chi,borderColor:'#D94F3D',backgroundColor:'rgba(217,79,61,.07)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#D94F3D'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3)+'K'},grid:{color:'#eee'}},x:{grid:{display:false}}}}});
}

/* â•â• TOAST â•â• */
let toastTimer=null;
function showToast(msg,isErr=false,isOk=false){
  const t=document.getElementById('toast');if(!t)return;
  t.textContent=msg;t.className='';
  if(isErr)t.classList.add('err');if(isOk)t.classList.add('ok');
  t.classList.add('show');clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3500);
}

/* â•â• INIT â•â• */
['incDate','impDate','opDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=TODAY;});
buildMonthSelect();
renderAll();
renderHomeRecent();
updateAIStatusBar();
setTimeout(refreshHomeChart,100);
</script>
</body>
</html>
